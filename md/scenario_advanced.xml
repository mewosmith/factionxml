<?xml version="1.0" encoding="utf-8"?>
<mdscript name="Scenario_advanced" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="md.xsd">
  <cues>

    <cue name="X4ep1_Gamestart_Tutorial2" module="x4ep1_gamestart_tutorial2">
      <conditions>
        <event_cue_signalled cue="md.Setup.GameStart" />
      </conditions>
      <actions>
        <set_value name="$DebugChance" exact="100" />
        <set_value name="md.$TutorialActive" exact="true" />
        <set_value name="md.$SurpressTutorials" exact="true" comment="surpress tutorials"/>
        <set_value name="$cpufaction" exact="faction.argon"/>
        <set_value name="$StationTable" exact="table[]"/>
        <set_faction_relation faction="$cpufaction" otherfaction="faction.player" value="0.5" comment="friendly"/>

        <!-- find all cluster for later reference-->
        <find_sector macro="macro.demo_cluster_13_sector001_macro" name="$cluster_13_sector001" comment="datavault crystal hinting"/>
        <find_sector macro="macro.demo_cluster_40_sector001_macro" name="$cluster_40_sector001" comment="station construction"/>
        <find_sector macro="macro.demo_cluster_41_sector001_macro" name="$cluster_41_sector001" comment="mining"/>

        <!-- create groups for important ships -->
        <create_group groupname="$Miners"/>
        <create_group groupname="$MinersPlayer"/>
        <create_group groupname="$MinersWaitPlayer"/>
        <create_group groupname="$Traders"/>
        <create_group groupname="$TradersPlayer"/>
        <create_group groupname="$Builders"/>

        <!--Demo narrator - Boso Ta-->
        <create_cue_actor name="$Narrator" cue="namespace" macro="character_boron_hq_mentor_macro">
          <page exact="10201"/>
          <owner exact="faction.civilian"/>
          <skills>
            <skill type="management"  exact="9"/>
            <skill type="morale"      exact="15"/>
            <skill type="piloting"    exact="9"/>
            <skill type="engineering" exact="15"/>
            <skill type="boarding"    exact="0"/>
          </skills>
        </create_cue_actor>
        <set_entity_traits entity="$Narrator" missionactor="true"/>
        <set_value name="md.$PersistentCharacters.$BosoTa" exact="$Narrator"/>
      </actions>
      <cues>

        <!-- explain teleportation and how to observe game from the map -->
        <cue name="Scenario2_Setup">
          <actions>
            <!-- unlock teleportation research -->
            <add_research ware="ware.research_teleportation"/>
            <add_research ware="ware.research_teleportation_range_01"/>
            <add_research ware="ware.research_teleportation_range_02"/>
            <add_research ware="ware.research_teleportation_range_03"/>
            <add_inventory ware="ware.inv_timewarp" exact="1" comment="SETA"/>

            <!--set_faction_relation faction="faction.teladi" otherfaction="faction.player" value="faction.teladi.relation.kill.max" comment="TODO: for boarding scenario" /-->

          </actions>
        </cue>

        <cue name="Scenario2_SetupStations">
          <actions>

            <!-- power plant (produces energy) -->
            <create_station name="$station" macro="macro.station_gen_factory_base_01_macro" owner="$cpufaction" sector="$cluster_13_sector001" state="componentstate.operational" constructionplan="'scenario2_spp'">
              <position x="-62494.379" z="55998.789"/>
            </create_station>
            <set_known object="$station" known="true"/>
            <set_object_scanned object="$station"/>
            <get_module_definition macro="$ViableConnectionModules" faction="$cpufaction" tags="[tag.connection, tag.module]" set="'factory'" multiple="true" />
            <create_control_entity object="$station" post="controlpost.manager">
              <select tags="controlpost.manager.tag"/>
              <owner exact="$station.owner"/>
            </create_control_entity>
            <create_control_entity object="$station" post="controlpost.defence">
              <select tags="controlpost.defence.tag"/>
              <owner exact="$station.owner"/>
            </create_control_entity>
            <add_default_production_wares object="$station" lowerlimit="10" upperlimit="10"/>
            <transfer_money to="$station" from="$cpufaction" amount="10000000Cr"/>
            <set_value name="$StationTable.$spp" exact="$station"/>

            <!-- mining station (needs silicon + energy + food + medical, produces silicon wafers) -->
            <find_zone name="$miningzone" macro="macro.demo_zone005_cluster_41_sector001_macro" space="$cluster_41_sector001" />
            <create_station name="$station" macro="macro.station_gen_factory_base_01_macro" owner="faction.player" zone="$miningzone" state="componentstate.operational" constructionplan="'scenario2_silicon_refinery'">
              <!--safepos space="player.zone" object="player.ship"/-->
              <position x="10979.666" z="-3862.096"/>
            </create_station>
            <set_known object="$station" known="true"/>
            <set_object_scanned object="$station"/>
            <create_control_entity object="$station" post="controlpost.manager">
              <select tags="controlpost.manager.tag"/>
              <owner exact="$station.owner"/>
            </create_control_entity>
            <create_control_entity object="$station" post="controlpost.defence">
              <select tags="controlpost.defence.tag"/>
              <owner exact="$station.owner"/>
            </create_control_entity>
            <add_default_production_wares object="$station" lowerlimit="25" upperlimit="25"/>
            <transfer_money to="$station" from="$cpufaction" amount="10000000Cr"/>
            <set_value name="$StationTable.$mining" exact="$station"/>

            <!-- microchip factory  (needs siliconwafers + energy + food + medical, produces microchips ) -->
            <create_station name="$station" macro="macro.station_gen_factory_base_01_macro" owner="$cpufaction" zone="player.zone" state="componentstate.operational" constructionplan="'scenario2_microchip_factory'">
              <safepos space="player.zone" object="player.ship"/>
            </create_station>
            <set_known object="$station" known="true"/>
            <set_object_scanned object="$station"/>
            <create_control_entity object="$station" post="controlpost.manager">
              <select tags="controlpost.manager.tag"/>
              <owner exact="$station.owner"/>
            </create_control_entity>
            <create_control_entity object="$station" post="controlpost.defence">
              <select tags="controlpost.defence.tag"/>
              <owner exact="$station.owner"/>
            </create_control_entity>
            <add_default_production_wares object="$station" lowerlimit="10" upperlimit="10"/>
            <transfer_money to="$station" from="$cpufaction" amount="10000000Cr"/>
            <set_value name="$StationTable.$microchip" exact="$station"/>

            <!-- trading station (buys silicon wafers, offers food + medical) -->
            <create_station name="$station" macro="macro.station_arg_tradestation_base_01_macro" owner="$cpufaction" sector="$cluster_40_sector001" state="componentstate.operational" constructionplan="'arg_tradestation'" rawname="{20102, 1051}" comment="see constructionplans.xml">
              <position x="-40559.344" z="27540.188"/>
            </create_station>
            <set_known object="$station" known="true"/>
            <set_object_scanned object="$station"/>
            <add_tradeware object="$station" ware="ware.foodrations" allowsell="true" allowbuy="false"/>
            <add_tradeware object="$station" ware="ware.medicalsupplies" allowsell="true" allowbuy="false"/>
            <add_tradeware object="$station" ware="ware.microchips" allowsell="false" allowbuy="true"/>
            <create_control_entity object="$station" post="controlpost.manager">
              <select tags="controlpost.manager.tag"/>
              <owner exact="$station.owner"/>
            </create_control_entity>
            <create_control_entity object="$station" post="controlpost.defence">
              <select tags="controlpost.defence.tag"/>
              <owner exact="$station.owner"/>
            </create_control_entity>
            <add_cargo object="$station" ware="ware.foodrations" exact="100000"/>
            <add_cargo object="$station" ware="ware.medicalsupplies" exact="100000"/>
            <add_units object="$station" category="unitcategory.transport" mk="2" exact="50" />
            <transfer_money to="$station" from="$cpufaction" amount="10000000Cr"/>
            <set_value name="$StationTable.$trading" exact="$station"/>
            <set_value name="$StationData" exact="table[]" comment="needed by drainscript"/>

            <!-- player station (extended in the tutorial) -->
            <create_station name="$playerstation" macro="macro.station_gen_factory_base_01_macro" owner="faction.player" sector="$cluster_40_sector001" rawname="{20102, 2011}" state="componentstate.operational" constructionplan="'scenario2_player_station'">
              <position x="156899.359" z="-49899.777"/>
            </create_station>
            <set_value name="$StationTable.$playerhq" exact="$playerstation"/>

          </actions>
          <cues>
            <cue name="Scenario2_DrainTradeStation" checkinterval="120s" instantiate="true" comment="avoid tradestation from 'overflowing'">
              <actions>
                <set_value name="$Debugchance" exact="0" comment="needed by drainscript"/>
                <set_value name="$Station" exact="$StationTable.$trading" comment="needed by drainscript"/>
                <include_actions ref="md.Drain_Stations.DrainStation"/>
              </actions>
            </cue>
          </cues>
        </cue>

        <cue name="Scenario2_TradingShips">
          <delay exact="1s" comment="needs $StationTable from Scenario2_SetupStations-cue"/>
          <actions>
            <find_sector macro="macro.demo_cluster_41_sector001_macro" name="$cluster_41_sector001" />


            <!-- trade ships [macro, faction, spawn-near-object, ware-basket] -->
            <set_value name="$TradersSetup"   exact="[
                   [ macro.ship_arg_l_trans_container_04_a_macro, faction.player, $StationTable.$trading,   [20204, 501], [ware.foodrations, ware.energycells, ware.microchips, ware.siliconwafers, ware.medicalsupplies]],
                   [ macro.ship_arg_l_trans_container_04_a_macro, $cpufaction,    $StationTable.$trading,   [20204, 501], [ware.foodrations, ware.energycells, ware.microchips, ware.siliconwafers, ware.medicalsupplies]],
                   [ macro.ship_arg_l_trans_container_04_a_macro, $cpufaction,    $StationTable.$trading,   [20204, 1701], [ware.foodrations, ware.medicalsupplies]],
                   [ macro.ship_arg_l_trans_container_04_a_macro, $cpufaction,    $StationTable.$microchip, [20204, 401], [ware.microchips, ware.siliconwafers]],
                   [ macro.ship_arg_l_trans_container_04_a_macro, $cpufaction,    $StationTable.$spp,       [20204, 101], [ware.energycells]],
                   [ macro.ship_arg_l_trans_container_04_a_macro, $cpufaction,    $StationTable.$spp,       [20204, 101], [ware.energycells]],
                   ]" />

            <do_all exact="$TradersSetup.count" counter="$k">
              <!--debug_text text="'spawn ' + $TradersSetup.{$k}.{1} + ' in ' + $TradersSetup.{$k}.{3}.sector + ' near ' + $TradersSetup.{$k}.{3}.knownname"/-->
              <create_ship name="$ship" macro="$TradersSetup.{$k}.{1}" sector="$TradersSetup.{$k}.{3}.sector">
                <owner exact="$TradersSetup.{$k}.{2}" overridenpc="true" />
                <pilot>
                  <select faction="$cpufaction" tags="tag.traderpilot"/>
                </pilot>
                <loadout>
                  <level exact="1"/>
                </loadout>
                <people ref="argon_freighter_crew"/>
                <safepos object="$TradersSetup.{$k}.{3}" min="2km"  max="8km"/>
              </create_ship>
              <set_object_name object="$ship" page="$TradersSetup.{$k}.{4}.{1}" line="$TradersSetup.{$k}.{4}.{2}"/>
              <create_order object="$ship" id="'TradeRoutine'" default="true">
                <param name="maxbuy" value="3"/>
                <param name="maxsell" value="3"/>
                <param name="warebasket" value="$TradersSetup.{$k}.{5}"/>
              </create_order>
              <set_known object="$ship" known="true"/>
              <set_object_scanned object="$ship"/>
              <add_to_group groupname="$Traders" object="$ship"/>
              <do_if value="$ship.owner == faction.player">
                <add_to_group groupname="$TradersPlayer" object="$ship"/>
              </do_if>
            </do_all>

            <!-- mining ships ('mining' and 'solid' in macroname) -->
            <set_value name="$MinersSetup"   exact="[
                   [ macro.ship_arg_l_miner_solid_01_a_macro, faction.player, $StationTable.$mining,  [20204,5801], [ware.silicon], true],
                   [ macro.ship_arg_l_miner_solid_01_a_macro, faction.player, null,                   [20204,5801], [ware.silicon], false],
                   [ macro.ship_arg_l_miner_solid_01_a_macro, $cpufaction,    $StationTable.$mining,  [20204,5801], [ware.silicon], true],
                   ]" />

            <do_all exact="$MinersSetup.count" counter="$k">
              <do_if value="$MinersSetup.{$k}.{3} == null">
                <!-- the non-ai mining ship is hand-placed -->
                <create_ship name="$ship" macro="$MinersSetup.{$k}.{1}" sector="$cluster_41_sector001">
                  <owner exact="$MinersSetup.{$k}.{2}" overridenpc="true" />
                  <pilot>
                    <select faction="$cpufaction" tags="tag.traderpilot"/>
                  </pilot>
                  <loadout>
                    <level exact="1"/>
                  </loadout>
                  <people ref="argon_freighter_crew"/>
                  <position x="17858.027" y="-45.981" z="-34905.781"/>
                  <rotation yaw="-33.06321deg" pitch="-2.2732deg" roll="-0.04361deg"/>
                </create_ship>
                <!--create_position name="$Temppos" object="$ship" space="$cluster_41_sector001"/>
                <debug_text text="$Temppos"/-->
              </do_if>
              <do_else>
                <!-- spawn near specified station -->
                <create_ship name="$ship" macro="$MinersSetup.{$k}.{1}" sector="$MinersSetup.{$k}.{3}.sector">
                  <owner exact="$MinersSetup.{$k}.{2}" overridenpc="true" />
                  <pilot>
                    <select faction="$cpufaction" tags="tag.traderpilot"/>
                  </pilot>
                  <loadout>
                    <level exact="1"/>
                  </loadout>
                  <people ref="argon_freighter_crew"/>
                  <safepos object="$MinersSetup.{$k}.{3}" min="2km"  max="8km"/>
                </create_ship>
              </do_else>
              <set_object_name object="$ship" page="$MinersSetup.{$k}.{4}.{1}" line="$MinersSetup.{$k}.{4}.{2}"/>
              
              <add_ammo object="$ship" macro="macro.eq_arg_resourceprobe_01_macro" amount="10" comment="player.ship.ammostorage.{deployablecategory.resourceprobe}.count"/>
              
              <do_if value="$MinersSetup.{$k}.{6}" comment="not all ships have active ai-orders">
                <create_order object="$ship" id="'MiningRoutine'" default="true">
                  <param name="maxbuy" value="0" comment="keep in starting sector"/>
                  <param name="maxsell" value="0"/>
                  <param name="warebasket" value="$MinersSetup.{$k}.{5}"/>
                </create_order>
              </do_if>

              <set_known object="$ship" known="true"/>
              <set_object_scanned object="$ship"/>
              <add_to_group groupname="$Miners" object="$ship"/>

              <do_if value="$ship.owner == faction.player">
                <add_to_group groupname="$MinersPlayer" object="$ship"/>
                <do_if value="not $MinersSetup.{$k}.{6}">
                  <add_to_group groupname="$MinersWaitPlayer" object="$ship"/>
                  <!--include_actions ref="md.LIB_Generic.Setup_Ship_Turrets_HoldFire" comment="input: $ship"/-->
                  <include_actions ref="md.LIB_Generic.Setup_Ship_Turrets_Defend" comment="input: $ship, non-aggresive behaviour"/>
                  <set_drone_mode object="$ship" category="unitcategory.orecollector" mode="dronemode.collectanymineable"/>
                  <set_drone_armed object="$ship" category="unitcategory.orecollector"  armed="false"/>
                  <set_drone_armed object="$ship" category="unitcategory.transport" armed="false"/>
                </do_if>
              </do_if>

            </do_all>

            <!-- Builder Ships -->
            <set_value name="$BuildersSetup"   exact="[
                   [ macro.ship_arg_xl_builder_01_a_macro, $cpufaction, $StationTable.$playerhq,  [30179,130], [ware.silicon], true],
                   ]" />

            <do_all exact="$BuildersSetup.count" counter="$k">
              <create_ship name="$BuilderShip" macro="$BuildersSetup.{$k}.{1}" sector="$BuildersSetup.{$k}.{3}.sector">
                <owner exact="$BuildersSetup.{$k}.{2}" overridenpc="true" />
                <loadout>
                  <level exact="0.5"/>
                </loadout>
                <pilot>
                  <select race="[race.argon, race.paranid, race.teladi]" tags="tag.aipilot"/>
                </pilot>
                <drop ref="ship_large_civilian" />
                <safepos object="$BuildersSetup.{$k}.{3}" min="2km"  max="8km"/>
              </create_ship>
              <!--create_order object="$BuilderShip" id="'FindBuildTasks'" default="true">
                <param name="maxjumps" value="0"/>
              </create_order-->
              <create_order object="$BuilderShip" id="'DeployToStation'" default="true">
                <param name="station" value="$BuildersSetup.{$k}.{3}"/>
                <param name="waitduration" value="99h"/>
              </create_order>
              <add_to_group groupname="$Builders" object="$ship"/>
            </do_all>
          </actions>
        </cue>

        <cue name="Tutorial2_SetupBoarding" onfail="cancel">
          <conditions>
            <check_value value="false"/>
          </conditions>
          <delay exact="1s"/>
          <actions>
            <set_value name="$BoardingSetup"   exact="[
                   [ macro.ship_arg_l_destroyer_01_b_macro, faction.player, [$cluster_41_sector001, position.[260137, 1040,  -338481],   rotation.[ 67.57deg, -28.2deg,   0.11deg]], [20204,5801], [], false, race.argon],
                   [ macro.ship_tel_m_frigate_01_b_macro,   $cpufaction,    [$cluster_41_sector001, position.[261993.734, 0, -337453.5], rotation.[108.8deg,      0deg, -0.395deg]], [20204,5801], [], false, race.teladi],
                   ]" />

            <do_all exact="$BoardingSetup.count" counter="$k">
              <create_ship name="$BoardingShipTmp" macro="$BoardingSetup.{$k}.{1}" sector="$BoardingSetup.{$k}.{3}.{1}">
                <owner exact="$BoardingSetup.{$k}.{2}" overridenpc="true" />
                <loadout>
                  <level exact="0.5"/>
                </loadout>
                <pilot>
                  <select race="[$BoardingSetup.{$k}.{7}]" tags="tag.aipilot"/>
                </pilot>
                <drop ref="ship_large_civilian" />
                <position x="$BoardingSetup.{$k}.{3}.{2}.x" y="$BoardingSetup.{$k}.{3}.{2}.y" z="$BoardingSetup.{$k}.{3}.{2}.z"/>
                <rotation yaw="$BoardingSetup.{$k}.{3}.{3}.yaw" pitch="$BoardingSetup.{$k}.{3}.{3}.pitch" roll="$BoardingSetup.{$k}.{3}.{3}.roll"/>
              </create_ship>
              <do_if value="$BoardingSetup.{$k}.{2} == faction.player">
                <set_value name="$BoardingShip" exact="$BoardingShipTmp"/>
              </do_if>
              <do_else>
                <set_value name="$BoardedShip" exact="$BoardingShipTmp"/>
              </do_else>
            </do_all>
          </actions>
        </cue>

        <cue name="Scenario2_Map_OnOpen" instantiate="true">
          <conditions>
            <event_ui_triggered screen="'MapMenu'" control="''"/>
          </conditions>
          <actions>
            <!-- re-add object texts, each time the map is opened -->
            <!--do_if value="@$playerstation">
              <add_holomap_text object="$playerstation" text="{1012,24001}" comment="Station Tutorial"/> 
            </do_if-->

            <center_holomap_view zoomtofit="true"/>

            <do_if value="@$ConstructionShip">
              <add_holomap_text object="$ConstructionShip" text="{30179,204}" comment="Station Construction Tutorial"/>
            </do_if>

            <do_if value="@$VaultShip">
              <add_holomap_text object="$VaultShip" text="{30179,201}" comment="Data Vault Tutorial"/>
            </do_if>

            <do_if value="@$CrystalShip">
              <add_holomap_text object="$CrystalShip" text="{30179,202}" comment="Crystal Tutorial"/>
            </do_if>

            <!--Was commented out from below loop
            <add_holomap_text object="$MinersPlayer.{$k}" text="{30179,120}" comment="Ore Miner"/>-->
            <!--<do_all exact="$MinersPlayer.count" counter="$k" comment="all ships in this group get the 'Mining Tutorial' text">
              <add_holomap_text object="$MinersPlayer.{$k}" text="{20204,5801}" comment="Ore Miner (voiced)"/>
            </do_all>-->

            <do_all exact="$MinersWaitPlayer.count" counter="$k" comment="overwrite name of order-less mining ships to 'Ore Miner'">
              <add_holomap_text object="$MinersWaitPlayer.{$k}" text="{30179,203}" comment="Mining Tutorial"/>
            </do_all>

            <do_all exact="$TradersPlayer.count" counter="$k">
              <!--add_holomap_text object="$TradersPlayer.{$k}" text="{30179,205}" comment="Trading Tutorial"/-->
              <!--add_holomap_text object="$TradersPlayer.{$k}" text="{20204,601}" comment="Intermediates Trader (voiced)"/-->
            </do_all>

            <!--add_holomap_text object="$BoardingShip" text="{30179,206}" comment="TODO: Boarding Tutorial"/-->

            <!-- disable all filters (too much overlapping info for new players), see config.mapfilterversion -->
            <raise_lua_event name="'mapfilter'" param="'layer_trade;false'"/>
            <raise_lua_event name="'mapfilter'" param="'layer_think;false'"/>
            <raise_lua_event name="'mapfilter'" param="'layer_mining;false'"/>
            <raise_lua_event name="'mapfilter'" param="'layer_other;false'"/>

          </actions>
        </cue>

        <cue name="Scenario2_Map_OnSelect" instantiate="true">
          <conditions>
            <check_any>
              <event_ui_triggered screen="'MapMenu'" control="'selection_ship'"/>
              <event_ui_triggered screen="'MapMenu'" control="'selection_station'"/>
            </check_any>
          </conditions>
          <actions>
            <set_value name="$Selected" exact="component.{event.param3} "/>
            <do_if value="$Selected">
              <!--set_holomap_target object="$SelectedShip" pantime="3s" comment="pantime-overiding is ignored"/-->
            </do_if>
          </actions>
        </cue>

        <cue name="Scenario2_Map_ResetSelection">
          <conditions>
            <check_any>
              <event_ui_triggered screen="'MapMenu'" control="'selection_reset'"/>
              <check_all>
                <event_ui_triggered screen="'MapMenu'" control="'selection_ship'"/>
                <check_value value="not component.{event.param3}.isplayerowned "/>
              </check_all>
              <check_all>
                <event_ui_triggered screen="'MapMenu'" control="'selection_station'"/>
                <check_value value="not component.{event.param3}.isplayerowned "/>
              </check_all>
            </check_any>
          </conditions>
          <actions>
            <set_value name="$Selected" exact="null"/>
          </actions>
        </cue>
  
        <cue name="Scenario2_Intro_AutoStart">
          <delay exact="5s"/>
          <actions>
            <start_conversation actor="$Narrator" conversation="introduction" priority="100"/>
          </actions>
          <cues>

            <cue name="Scenario2_Intro_ConvStarted">
              <conditions>
                <event_conversation_started actor="$Narrator" conversation="introduction"/>
              </conditions>
              <actions>
                <allow_conversation_escape enabled="false"/>
                <add_npc_line speaker="$Narrator">
                  <text line="30402002" comment="Hello there. As requested, I have set up a number of scenarios ..."/>
                  <text line="30402003" comment="I will be guiding you from a safe distance." delay="1s"/>
                  <text line="30402004" comment="To begin, open the map." delay="1s"/>
                </add_npc_line>
              </actions>
            </cue>
      
            <cue name="Scenario2_Intro_SpeakMapEnded">
              <conditions>
                <event_speak_finished actor="$Narrator" line="30402002" />
              </conditions>
              <actions>
                <signal_cue cue="Scenario2_Intro_Map"/>
              </actions>
            </cue>

            <cue name="Scenario2_Intro_ConvEnded">
              <conditions>
                <event_conversation_finished actor="$Narrator"/>
              </conditions>
              <actions>
                <!--signal_cue cue="Scenario2_Intro_Map"/-->
              </actions>
            </cue>

            <!-- If player was lightning fast and already teleported, skip the teleportation tutorial -->
            <cue name="Scenario2_Intro_Teleported">
              <conditions>
                <event_ui_triggered screen="'InteractMenu'" control="'teleport'"/>
                <cue_is_waiting cue="Scenario2_Intro_ConvEnded"/>
              </conditions>
              <actions>
                <debug_text text="'Cancelling teleportation tutorial'"/>
                <cancel_cue cue="Scenario2_Intro_Map"/>
              </actions>
            </cue>

          </cues>
        </cue>

        <cue name="Scenario2_Intro_Map">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <set_value name="$TeleportCompleted" exact="false"/>
          </actions>
          <cues>
            
            <cue name="Scenario2_Intro_MapOpenHint">
              <delay exact="2s"/>
              <actions>
                <do_if value="player.input.controller">
                  <show_help line="934" log="true" position="1" force="true" width="150" comment="Press X to open menus" allowclose="false" timeout="false"/>
                </do_if>
                <do_else>
                  <show_help line="5001" log="true" position="1" force="true" width="126" comment="Press $INPUT_ACTION_OPEN_MAP$ to open the MAP menu" allowclose="false" timeout="false"/>
                </do_else>
              </actions>
            </cue>

            <cue name="Scenario2_Intro_DockedOpen" instantiate="true" comment="gamepad opens this menu, instead of the map tab">
              <conditions>
                <check_any>
                  <event_ui_triggered screen="'DockedMenu'" control="''" />
                </check_any>
                <check_value value="not $TeleportCompleted"/>
              </conditions>
              <actions>
                <remove_help all="true"/>
                <do_if value="player.input.controller" comment="gamepad needs an additional hint">
                  <show_help line="943" position="15" timeout="false" log="false" width="140" force="true" comment="Select the MAP tab using $INPUT_ACTION_WIDGET_TABSCROLL_LEFT$,$INPUT_ACTION_WIDGET_TABSCROLL_RIGHT$."/>
                  <!--show_help_overlay id="'toplevel_map'" /-->
                </do_if>
              </actions>
            </cue>

            <cue name="Scenario2_Intro_MenuClose" instantiate="true">
              <conditions>
                <event_ui_triggered screen="'MapMenu'" control="'menu_close'"/>
              </conditions>
              <actions>
                <!--remove_help_overlay id="'toplevel_map'"/-->

                <!-- remove specifically the map-hints (do not use 'all'!) -->
                <remove_help line="943"/>
                <remove_help line="990"/>
                <remove_help line="5145"/>
                <remove_help line="5220"/>
                <remove_help line="5221"/>
                <remove_help line="20005"/>
                <remove_help line="20006"/>
                <remove_help line="20007"/>
                <remove_help line="20114"/>
                <remove_help line="20116"/>
                <remove_help line="20130"/>
              </actions>
            </cue>

            <cue name="Scenario2_Intro_Teleportation">
              <conditions>
                <event_ui_triggered screen="'MapMenu'" control="''"/>
              </conditions>
              <actions>
                <cancel_cue cue="Scenario2_Intro_MapOpenHint" comment="If player was quick and already opened the map, cancel the (delayed) hint"/>
                <debug_text text="'Scenario2_Intro_MenuOpen'"/>
                <remove_help all="true"/>
                <!--remove_help_overlay id="'toplevel_map'"-->
                <center_holomap_view zoomtofit="true"/>
              </actions>
              <cues>

                <cue name="Scenario2_Intro_Hints">
                  <delay exact="1s"/>
                  <actions>
                    <do_if value="player.input.controller">
                      <show_help_multi log="false" force="false" halign="'center'" position="17" allowclose="false" width="250">
                        <text line="20105" comment="Map Info...\nClick next to proceed"/>
                        <text line="5135" comment="$INPUT_STATE_MAP_PAN_LEFT$, ... for PANNING, ... (gamepad variation)"/>
                      </show_help_multi>
                    </do_if>
                    <do_else>
                      <show_help_multi log="false" force="false" halign="'center'" position="17" allowclose="false" width="180">
                        <text line="20105" comment="Map Info...\nClick next to proceed"/>
                        <text line="5145" comment="$INPUT_STATE_MAP_PAN_LEFT$, ... for PANNING, ... (keyboard variation)"/>
                        <text line="5125" comment="$INPUT_STATE_MAP_PAN_LEFT$, ... for PANNING, ... (mouse variation)"/>
                      </show_help_multi>
                    </do_else>
                  </actions>
                  <cues>

                    <cue name="Scenario2_Intro_HelpHint">
                      <conditions>
                        <event_ui_triggered screen="'hintclosed'" control="'20105'"/>
                      </conditions>
                      <delay exact="0.5s"/>
                      <actions>
                        <show_help_overlay id="'map_standardbutton_help'" highlightonly="true" />
                        <show_help_multi log="false" force="false" halign="'center'" position="17" allowclose="false" width="180">
                          <text line="991" comment="You can click the xxx to get help on all controls."/>
                        </show_help_multi>
                      </actions>
                    </cue>
                    
                    <cue name="Scenario2_Intro_HintsDone">
                      <conditions>
                        <event_ui_triggered screen="'hintclosed'" control="'991'"/>
                      </conditions>
                      <actions>
                        <remove_help_overlay id="'map_standardbutton_help'" />
                        <signal_cue cue="Scenario2_Intro_SpeakMap"/>
                      </actions>
                    </cue>
                  </cues>
                </cue>

                <cue name="Scenario2_Intro_SpeakMap">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <delay exact="1s"/>
                  <actions>
                    <!-- mentor speaking about 'overview of galaxy map' -->
                    <speak actor="$Narrator" line="30402005" comment="Here you see a number of sectors. Your ships and stations are shown in green."/>
                  </actions>
                  <cues>
                    <cue name="Scenario2_Intro_SpeakMap2">
                      <conditions>
                        <event_speak_finished actor="$Narrator" line="30402005" />
                      </conditions>
                      <delay exact="1ms"/>
                      <actions>
                        <speak actor="$Narrator" line="30402006" comment="Select one of them and let's see what it's doing."/>
                      </actions>
                      <cues>

                        <cue name="Scenario2_Intro_ClearMapHint">
                          <conditions>
                            <event_speak_finished actor="$Narrator" line="30402006"/>
                          </conditions>
                          <actions>
                            <remove_help line="5146"/>
                          </actions>
                        </cue>

                        <cue name="Scenario2_Intro_SelectionHint" comment="once">
                          <conditions>
                            <event_speak_finished actor="$Narrator" line="30402006"/>
                          </conditions>
                          <delay exact="1s"/>
                          <actions>
                            <do_if value="player.isinfullscreenmenu">
                              <do_if value="player.input.controller">
                                <show_help line="20007" log="true" halign="'center'" position="17" force="true" timeout="false" width="250" comment="Objects can be selected with $INPUT_STATE_WIDGET_SELECT$ on the gamepad.\nSelect a ..."/>
                              </do_if>
                              <do_else>
                                <show_help line="20006" log="true" halign="'center'" position="17" force="true" timeout="false" width="210" comment="Objects can be selected by left clicking with the mouse.\nSelect a ..."/>
                              </do_else>
                            </do_if>
                          </actions>
                        </cue>


                        <cue name="Scenario2_Intro_ContextMenuWithSelection" instantiate="true">
                          <conditions>
                            <event_ui_triggered screen="'InteractMenu'" control="'id'" comment="event.param3 is id (as string)"/>          
                          </conditions>
                          <actions>
                            <do_if value="$Selected != component.{event.param3}">
                              <remove_help line="20116"/>
                              <show_help line="20200" position="17" force="true" duration="20s" width="210" comment="You opened a context menu on a different ship as selected which lets ships interact.\nFor TELEPORT TO either don't select a ship, or open the context menu on the selected ship."/>
                            </do_if>
                            <do_else>
                              <remove_help line="20200"/>
                            </do_else>
                          </actions>
                        </cue>
                        
                        <cue name="Scenario2_Intro_ContextMenu" instantiate="true">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <actions>
                            <remove_help line="5221"/>
                            <remove_help line="5220"/>
                            <remove_help line="20006"/>
                            <remove_help line="20007"/>
                            <do_if value="player.input.controller">
                              <show_help line="20116" log="false" position="17" force="true" timeout="false" width="210" comment="Use $x$ and $y$ to hover over one of your objects, open the context menu with X and select TELEPORT TO."/>
                            </do_if>
                            <do_else>
                              <show_help line="20114" log="false" position="17" force="true" timeout="false" width="210" comment="Right-click and select TELEPORT TO from the context menu."/>
                            </do_else>
                          </actions>
                          <cues>
                            <cue name="Scenario2_Teleportation_ResetSelection">
                              <conditions>
                                <check_any>
                                  <event_ui_triggered screen="'MapMenu'" control="'selection_reset'"/>
                                  <check_all>
                                    <event_ui_triggered screen="'MapMenu'" control="'selection_ship'"/>
                                    <check_value value="not component.{event.param3}.isplayerowned "/>
                                  </check_all>
                                  <check_all>
                                    <event_ui_triggered screen="'MapMenu'" control="'selection_station'"/>
                                    <check_value value="not component.{event.param3}.isplayerowned "/>
                                  </check_all>
                                </check_any>
                              </conditions>
                              <actions>
                                <debug_text text="'reset-selection'"/>
                                <remove_help all="true"/>
                                <reset_cue cue="Scenario2_Intro_ContextMenu"/>
                              </actions>
                            </cue>

                          </cues>
                        </cue>
                      </cues>
                    </cue>
                  </cues>
                </cue>

                <cue name="Scenario2_Teleportation_Triggered" comment="for both gamepad and key/mouse">
                  <conditions>
                    <event_ui_triggered screen="'InteractMenu'" control="'teleport'" comment="once you teleported, disable this tutorial"/>
                    <set_value name="$TeleportCompleted" exact="true"/>
                  </conditions>
                  <delay exact="4s"/>
                  <actions>
                    <remove_help all="true"/>
                    <do_if value="player.isinfullscreenmenu">
                      <show_help line="20130" log="false" position="1" force="true" duration="7s" comment="You can now close the map and check out your new location."/>
                    </do_if>
                  </actions>
                </cue>

              </cues>
            </cue>
          </cues>
        </cue>

        <cue name="Scenario2_Mining">
          <conditions>
            <event_cue_completed cue="Scenario2_TradingShips"/>
          </conditions>
          <cues>

            <cue name="Scenario2_Mining_CheckMission" comment="missions active while on the mining-ship">
              <actions>
                <set_value name="$MiningMissionActive" exact="false"/>
              </actions>
              <cues>
                <cue name="Scenario2_Mining_OnLocation" checkinterval="3s" instantiate="true">
                  <conditions>
                    <cue_is_waiting cue="Scenario2_Mining_Start"/>
                  </conditions>
                  <actions>
                    <set_value name="$OnMiningShip" exact="false"/>
                    <do_all exact="$MinersWaitPlayer.count" counter="$k">
                      <do_if value="player.entity.hascontext.{$MinersWaitPlayer.{$k}}">
                        <set_value name="$OnMiningShip" exact="true"/>
                        <break/>
                      </do_if>
                    </do_all>

                    <!--debug_text text="'OnMining: ' + $OnMiningShip + ' active: ' + $MiningMissionActive"/-->
                    <do_if value="$OnMiningShip and not $MiningMissionActive">
                      <set_value name="$MiningMissionActive" exact="true"/>
                      <reset_cue cue="Scenario2_Mining_Start"/>
                      <reset_cue cue="Scenario2_Mining_Cleanup"/>
                      <signal_cue cue="Scenario2_Mining_Start"/>
                    </do_if>
                    <do_elseif value="not $OnMiningShip and $MiningMissionActive">
                      <set_value name="$MiningMissionActive" exact="false"/>
                      <remove_help all="true"/>
                      <show_notification text="{1015,401}" sound="notification_warning"/>
                      <!--remove_mission cue="Start" type="aborted" /-->
                      <signal_cue cue="Scenario2_Mining_Cleanup" />
                    </do_elseif>
                  </actions>
                </cue>
              </cues>
            </cue>

            <cue name="Scenario2_Mining_Selected" instantiate="true">
              <conditions>
                <event_ui_triggered screen="'MapMenu'" control="'selection_ship'"/>
              </conditions>
              <actions>
                <set_value name="$SelectedShip" exact="component.{event.param3} "/>
                <do_all exact="$MinersWaitPlayer.count" counter="$k">
                  <do_if value="$MinersWaitPlayer.{$k} == $SelectedShip">
                    <debug_text text="'Selected mining-ship on map'"/>
                    <speak actor="$Narrator"  line="30402007" comment="This ship is mining in an asteroid field"/>
                    <signal_cue cue="Scenario2_Intro_ContextMenu"/>
                    <break/>
                  </do_if>
                </do_all>
              </actions>
            </cue>

            <cue name="Scenario2_Mining_Start">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <reset_cue cue="Scenario2_Crystal_Start"/>
                <reset_cue cue="Scenario2_DataVault_Start"/>
                <reset_cue cue="Scenario2_DataVault_StagingArea"/>
                <reset_cue cue="Scenario2_Station_Start"/>
                <reset_cue cue="Scenario2_Trading_Start"/>
                <reset_cue cue="Scenario2_Boarding_Start"/>

                <set_value name="$MiningIntroSpeechDone" exact="false"/>
                <remove_help all="true"/>
              </actions>
              <cues>

                <cue name="Scenario2_Mining_IntroStart" checkinterval="2s">
                  <conditions>
                    <check_value value="not player.isinfullscreenmenu" comment="wait for closing map"/>
                  </conditions>
                  <delay exact="3s"/>
                  <actions>
                    <play_cutscene key="'ShowCharacterBoron'" targetmonitor="true" caption="{10002,23}" result="this.$CutsceneID">
                      <param name="npcref" object="$Narrator" />
                    </play_cutscene>
                  </actions>
                  <cues>
                    <cue name="Scenario2_Mining_Intro_Speak">
                      <conditions>
                        <event_cue_completed cue="parent"/>
                      </conditions>
                      <delay exact="1s"/>
                      <actions>
                        <speak actor="$Narrator" priority="100">
                          <text line="30402081" comment="This ship is equipped for mineral mining."/>
                          <text line="30402082" comment="There is an asteroid field in close proximity."/>
                        </speak>
                      </actions>
                    </cue>
                    <cue name="Scenario2_Mining_Intro_SpeakEnd">
                      <conditions>
                        <event_speak_finished actor="$Narrator" line="30402081"/>
                      </conditions>
                      <delay exact="1s"/>
                      <actions>
                        <stop_cutscene cutscene="parent.$CutsceneID"/>
                        <create_mission cue="Scenario2_Mining_Start" type="missiontype.tutorial" name="{30179,6001}" description="{30179,6002}" difficulty="level.easy" faction="faction.argon" abortable="false">
                          <briefing>
                            <objective step="1" action="objective.custom"       customaction="{30179,6020}"  comment="take control"/>
                            <objective step="2" action="objective.flyto"        text="{30179,6021}"          comment="fly to asteroid field"/>
                            <objective step="3" action="objective.deploy"       text="{30179,6022}"          comment="deploy probe"/>
                            <objective step="4" action="objective.investigate"  text="{30179,6022}"          comment="select probe"/>
                            <objective step="5" action="objective.investigate"  text="{30179,6023}"          comment="investigate asteroids"/>
                            <objective step="6" action="objective.activate"     text="{30179,6024}"          comment="Activate mining equipment"/>
                            <objective step="7" action="objective.wait"         text="{30179,6025}"          comment="Observe mining operation"/>
                          </briefing>
                        </create_mission>
                        <set_value name="$MiningIntroSpeechDone" exact="true"/>
                      </actions>
                    </cue>
                  </cues>
                </cue>

                <cue name="Scenario2_Mining_Standing" checkinterval="1s">
                  <conditions>
                    <check_value value="(player.ship) and not (player.occupiedship)"/>
                    <check_value value="(not player.isinfullscreenmenu) and ($MiningIntroSpeechDone)" comment="not while map is open or speech is running"/>
                  </conditions>
                  <actions>
                    <reset_cue cue="Scenario2_Mining_Sitting"/>
                    <remove_help line="24010"/>
                    <show_help line="1041" position="15" timeout="false" log="true" width="256" force="true" comment="To take control click on the ships control terminal or press $INPUT_STATE_INTERACTION_MENU$ to interact."/>
                    <do_if value="Scenario2_Mining_Approach_Start.state != cuestate.complete">
                      <set_objective cue="Scenario2_Mining_Start" step="1" action="objective.custom" customaction="{30179,6020}" comment="take control"/>
                    </do_if>
                  </actions>
                </cue>

                <cue name="Scenario2_Mining_Sitting" checkinterval="1s">
                  <conditions>
                    <check_value value="(player.ship) and (player.occupiedship)"/>
                    <check_value value="(not player.isinfullscreenmenu) and ($MiningIntroSpeechDone)" comment="not while map is open or speech is running"/>
                  </conditions>
                  <actions>
                    <remove_help all="true"/>
                    <reset_cue cue="Scenario2_Mining_Standing"/>
                    <remove_help line="1041"/>

                    <find_closest_resource refobject="player.ship" sector="$ResourceSector" ware="[ware.ore, ware.silicon]" position="$ResourcePos" distance="$ResourceDist">
                      <refposition object="player.ship"/>
                    </find_closest_resource>
                    <do_if value="Scenario2_Mining_Approach_Start.state != cuestate.complete">
                      <set_objective cue="Scenario2_Mining_Start" step="2" action="objective.flyto" object="$ResourceSector" offset="$ResourcePos" radius="5000m" text="{30179,6021}"/>
                      <signal_cue cue="Scenario2_Mining_Approach"/>
                    </do_if>
                  </actions>
                </cue>

                <cue name="Scenario2_Mining_Approach">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <debug_text text="'Resources sector=' + $ResourceSector.knownname + ' position=' + $ResourcePos + ' Dist=' + $ResourceDist"/>
                  </actions>
                  <cues>

                    <cue name="Scenario2_Mining_Approach_Start" checkinterval="5s">
                      <conditions>
                        <check_any>
                          <check_value value="player.entity.distanceto.[$ResourceSector, $ResourcePos] le 5000m"/>
                          <count_objects class="class.asteroid" space="player.sector" min="1">
                            <match_distance object="player.entity" max="5km"/>
                          </count_objects>
                        </check_any>
                      </conditions>
                      <delay exact="1s"/>
                      <actions>
                        <play_cutscene key="'ShowCharacterBoron'" targetmonitor="true" caption="{10002,23}" result="this.$CutsceneID">
                          <param name="npcref" object="$Narrator" />
                        </play_cutscene>
                      </actions>
                      <cues>
                        <cue name="Scenario2_Mining_Approach_Speak">
                          <conditions>
                            <event_cue_completed cue="parent"/>
                          </conditions>
                          <delay exact="1s"/>
                          <actions>
                            <speak actor="$Narrator" priority="100">
                              <text line="30402083" comment="You can learn more about the asteroids in this area by dropping a resource probe."/>
                              <text line="30402084" comment="Resource probes will also detail any trace gasses worth collecting."/>
                            </speak>
                          </actions>
                        </cue>
                        <cue name="Scenario2_Mining_Approach_SpeakEnd">
                          <conditions>
                            <event_speak_finished actor="$Narrator" line="30402083"/>
                          </conditions>
                          <delay exact="1s"/>
                          <actions>
                            <stop_cutscene cutscene="parent.$CutsceneID"/>
                            <signal_cue cue="Scenario2_Mining_Probe"/>
                          </actions>
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Scenario2_Mining_Probe">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <debug_text text="'Probe part'"/>
                        <show_help line="14030" position="1" timeout="false" force="true" comment="Press $INPUT_ACTION_OPEN_COCKPIT_MENU$ to open SHIP MENU." />
                        <set_objective cue="Scenario2_Mining_Start" step="3" action="objective.deploy" object="$ResourceSector" offset="$ResourcePos" radius="5000m" text="{30179,6022}" comment="deploy probe"/>
                      </actions>
                      <cues>

                        <cue name="Scenario2_Mining_Probe_OpenShipMenu">
                          <conditions>
                            <event_ui_triggered screen="'DockedMenu'"/>
                          </conditions>
                          <actions>
                            <remove_help line="14030"/>
                            <show_help line="14040" position="14" timeout="false" force="true" comment="Select RESOURCE PROBE from DEPLOY CIVILIAN.." />
                            <show_help_overlay id="'docked_deploy_civ'" highlightonly="true" />
                          </actions>
                          <cues>
                          </cues>
                        </cue>

                        <cue name="Scenario2_Mineral_DeployedProbe">
                          <conditions>
                            <event_resourceprobe_launched space="player.sector"/>
                            <check_value value="event.param2.isplayerowned"/>
                          </conditions>
                          <actions>
                            <remove_help_overlay id="'docked_deploy_civ'" />
                            <remove_help line="14040"/>
                            <set_value name="$DeployedProbe" exact="event.param2"/>
                          </actions>
                          <delay exact="0.5s"/>
                          <actions>
                            <show_help line="1010" position="1" timeout="false" width="256" force="true" comment="Close the menu by pressing $INPUT_ACTION_WIDGET_QUIT$." />
                          </actions>
                          <cues>

                            <cue name="Scenario2_Mineral_CloseShipMenu">
                              <conditions>
                                <event_ui_triggered screen="'DockedMenu'" control="'menu_close'"/>
                              </conditions>
                              <actions>
                                <remove_help line="1010"/>
                              </actions>
                              <delay exact="0.5s"/>
                              <actions>
                                <show_help line="14055" position="1" timeout="false" width="256" force="true" comment="Select the RESOURCE PROBE which was deployed near your ship." />
                                <set_objective step="4" cue="Scenario2_Mining_Start" action="objective.investigate" text="{30179,6022}" object="$DeployedProbe" comment="Select the probe"/>
                              </actions>
                            </cue>

                            <cue name="Scenario2_Mining_SelectProbe">
                              <conditions>
                                <event_player_changed_target/>
                                <check_value value="event.param == $DeployedProbe"/>
                              </conditions>
                              <delay exact="8s" comment="give betty time to finish saying 'resource probe'"/>
                              <actions>
                                <remove_help line="14055"/>
                                <speak actor="$Narrator" priority="100">
                                  <text line="30402085" comment="The probe is online and sending data packets."/>
                                </speak>
                              </actions>
                            </cue>

                            <cue name="Scenario2_Mining_Probe_Speak">
                              <conditions>
                                <event_speak_finished actor="$Narrator" line="30402085"/>
                              </conditions>
                              <delay exact="1s"/>
                              <actions>
                                <speak actor="$Narrator" priority="100">
                                  <text line="30402086" comment="You will find that your navigational charts have been updated."/>
                                </speak>
                              </actions>
                            </cue>

                            <cue name="Scenario2_Mining_Probe_Done">
                              <conditions>
                                <event_speak_finished actor="$Narrator" line="30402086"/>
                              </conditions>
                              <actions>
                                <remove_help line="14053"/>
                                <signal_cue cue="Scenario2_Mining_Asteroids"/>
                              </actions>
                            </cue>

                          </cues>
                        </cue>

                      </cues>
                    </cue>

                    <cue name="Scenario2_Mining_Asteroids">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <delay exact="1s"/>
                      <actions>
                        <show_help line="14061" position="1" timeout="false" width="256" force="true" comment="Search for an asteroid with a high yield of any of the three types."/>

                        <create_group groupname="$asteroids"/>
                        <set_value name="$AsteroidNear" exact="false"/>
                        <set_value name="$ScanDone" exact="false"/>
                      </actions>
                      <cues>

                        <cue name="Scenario2_Mining_Asteroids_Start">
                          <delay exact="1s"/>
                          <actions>
                            <play_cutscene key="'ShowCharacterBoron'" targetmonitor="true" caption="{10002,23}" result="this.$CutsceneID">
                              <param name="npcref" object="$Narrator" />
                            </play_cutscene>
                          </actions>
                          <cues>
                            <cue name="Scenario2_Mining_Asteroids_Speak">
                              <conditions>
                                <event_cue_completed cue="parent" comment="req. parent-cue delay"/>
                              </conditions>
                              <delay exact="1s"/>
                              <actions>
                                <speak actor="$Narrator" priority="100">
                                  <text line="30402087" comment="Ships of this size serve as a base for mining operations."/>
                                </speak>
                              </actions>
                            </cue>
                            <cue name="Scenario2_Mining_Asteroids_SpeakEnd">
                              <conditions>
                                <event_speak_finished actor="$Narrator" line="30402087"/>
                              </conditions>
                              <delay exact="1s"/>
                              <actions>
                                <stop_cutscene cutscene="parent.$CutsceneID"/>
                              </actions>
                            </cue>
                          </cues>
                        </cue>

                        <cue name="Scenario2_Mining_Asteroids_Do">
                          <conditions>
                            <event_cue_completed cue="Scenario2_Mining_Asteroids" comment="wait for parents actions to complete"/>
                          </conditions>
                          <cues>
                            <cue name="Scenario2_Mining_RefreshAsteroids" checkinterval="5s" instantiate="true">
                              <conditions>
                                <check_value value="not $ScanDone"/>
                                <check_value value="@$asteroids.count == 0"/>
                              </conditions>
                              <actions>
                                <find_object groupname="$asteroids" class="[class.asteroid]" space="$ResourceSector" multiple="true">
                                  <match_distance min="3km" max="8km" space="$ResourceSector" object="player.entity"/>
                                </find_object>
                                <do_if value="$asteroids.count == 0">
                                  <find_object groupname="$asteroids" class="[class.asteroid]" space="$ResourceSector" multiple="true">
                                    <match_distance min="8km" max="20km" space="$ResourceSector" object="player.entity"/>
                                  </find_object>
                                </do_if>

                                <set_value name="$NearAsteroid" exact="null"/>
                                <do_all exact="$asteroids.count" counter="$i" reverse="true">
                                  <do_if value="$asteroids.{$i}.wares.list.count == 0">
                                    <remove_from_group group="$asteroids" object="$asteroids.{$i}"/>
                                  </do_if>
                                  <do_else>
                                    <do_all exact="$asteroids.{$i}.wares.list.count" counter="$wi">
                                      <do_if value="not [ware.ice,ware.ore,ware.silicon].indexof.{$asteroids.{$i}.wares.list.{$wi}}">
                                        <remove_from_group group="$asteroids" object="$asteroids.{$i}"/>
                                        <break/>
                                      </do_if>
                                    </do_all>
                                  </do_else>
                                </do_all>
                                <do_all exact="$asteroids.count" counter="$i" reverse="true">
                                  <do_if value="$asteroids.count gt 8">
                                    <remove_from_group group="$asteroids" object="$asteroids.{$i}"/>
                                  </do_if>
                                  <do_else>
                                    <break/>
                                  </do_else>
                                </do_all>
                                <set_objective step="5" cue="Scenario2_Mining_Start" action="objective.investigate" text="{30179,6023}" group="$asteroids"/>
                              </actions>
                            </cue>
                            
                            <cue name="Scenario2_Mining_AsteroidDestroyed" instantiate="true" comment="asteroid was destroyed, show other asteroids in objective">
                              <conditions>
                                <event_object_destroyed group="$asteroids"/>
                                <check_value value="not $ScanDone"/>
                              </conditions>
                              <actions>
                                <!-- some hint about not flying into asteroids -->
                                <set_objective step="5" cue="Scenario2_Mining_Start" action="objective.investigate" text="{30179,6023}" group="$asteroids"/>
                              </actions>
                            </cue>

                            <!-- As long as not scan-enabled, hint to fly close to selected asteroid, and when close hint to enable scan-mode -->
                            <cue name="Scenario2_Mining_ExamineAsteroid" checkinterval="5s" instantiate="true">
                              <conditions>
                                <check_value value="not $ScanDone"/>
                              </conditions>
                              <actions>

                                <set_value name="$NearAsteroid" exact="null"/>
                                <do_all exact="$asteroids.count" counter="$a">
                                  <do_if value="$asteroids.{$a}.distanceto.{player.entity} lt 3000m">
                                    <set_value name="$NearAsteroid" exact="$asteroids.{$a}"/>
                                    <break/>
                                  </do_if>
                                </do_all>

                                <do_if value="$NearAsteroid != null">
                                  <do_if value=" player.activity != activity.scan">
                                    <remove_help all="true"/>
                                    <do_if value="player.input.controller">
                                      <show_help line="14106" duration="7s" position="13" width="256" force="true" comment="Activate SCAN MODE from the SHIP MENU \($INPUT_ACTION_OPEN_COCKPIT_MENU$\)."/>
                                    </do_if>
                                    <do_else>
                                      <show_help line="14101" duration="7s" position="13" width="256" force="true" comment="Press $INPUT_ACTION_TOGGLE_SCAN_MODE$ to activate SCAN MODE."/>
                                    </do_else>
                                  </do_if>
                                  <do_else>
                                    <signal_cue cue="Scenario2_Mining_ScanDone_Conv"/>
                                    <cancel_cue cue="Scenario2_Mining_ExamineAsteroid.static"/>
                                  </do_else>
                                </do_if>
                                <do_elseif value="not $asteroids.indexof.{player.target}">
                                  <remove_help all="true"/>
                                  <show_help line="14063" duration="7s" position="1" width="180" force="true" comment="Select different asteroids as targets and compare their yields on the TARGET MONITOR."/>
                                </do_elseif>
                                <do_else>
                                  <remove_help all="true"/>
                                  <show_help line="14100" duration="7s" position="1" force="true" comment="Fly close to the selected asteroid."/>
                                </do_else>
                              </actions>
                            </cue>
                          </cues>
                        </cue>


                        <cue name="Scenario2_Mining_ScanDone_Conv">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <actions>
                            <play_cutscene key="'ShowCharacterBoron'" targetmonitor="true" caption="{10002,23}" result="this.$CutsceneID">
                              <param name="npcref" object="$Narrator" />
                            </play_cutscene>
                          </actions>
                          <cues>
                            <cue name="Scenario2_Mining_ScanDone_ConvStarted">
                              <delay exact="1s"/>
                              <actions>
                                <speak actor="$Narrator" priority="100" >
                                  <text line="30402101" comment="In this mode you can identify the different resources by the colour of the asteroids."/>
                                </speak>
                              </actions>
                            </cue>

                            <cue name="Scenario2_Mining_ScanDone_ConvEnded">
                              <conditions>
                                <event_speak_finished actor="$Narrator" line="30402101"/>
                              </conditions>
                              <delay exact="3s"/>
                              <actions>
                                <stop_cutscene cutscene="parent.$CutsceneID"/>
                                <signal_cue cue="Scenario2_Mining_ConfigureEquipment"/>
                              </actions>
                            </cue>
                          </cues>
                        </cue>


                        <!-- returns $AnyTurretMining -->

                        <library name="CapitalShip_AnyTurretMining">
                          <actions>
                            <!-- gather modes of all turrets-->

                            <set_value name="$weapons_all" exact="player.ship.turrets.operational.list"/>
                            <create_list name="$turretmodes"/>
                            <do_all exact="$weapons_all.count" counter="$i">
                              <do_if value="not $turretmodes.indexof.{$weapons_all.{$i}.mode}">
                                <append_to_list name="$turretmodes" exact="$weapons_all.{$i}.mode"/>
                              </do_if>
                            </do_all>
                            <set_value name="$AnyTurretMining" exact="@$turretmodes.indexof.{weaponmode.mining}"/>
                            <remove_value name="$weapons_all"/>
                            <clear_list list="$turretmodes"/>
                          </actions>
                        </library>

                        <cue name="Scenario2_Mining_ConfigureEquipment">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <delay exact="1s"/>
                          <actions>
                            <set_value name="$ScanDone" exact="true"/>
                            <set_objective cue="Scenario2_Mining_Start" step="6" action="objective.activate" object="$ResourceSector" text="{30179,6024}" comment="Activate Mining Equipment"/>
                            <!-- check if anything needs to be configured (mining-turretmode, drone-mode, drone-status) -->
                          </actions>
                          <cues>

                            <cue name="Scenario2_Mining_ConfigureEquipment_SelectTransmission">
                              <actions>
                                <include_actions ref="CapitalShip_AnyTurretMining" comment="returns $AnyTurretMining"/>
                                <do_if value="not $AnyTurretMining">
                                  <debug_text text="'Configure Lasers'"/>
                                  <signal_cue cue="Scenario2_Mining_ConfigureMiningLaser_Transmission"/>
                                </do_if>
                                <do_elseif value="not (player.ship.hasarmedminingdrones)">
                                  <debug_text text="'Configure Drones'"/>
                                  <signal_cue cue="Scenario2_Mining_ConfigureDrones_Transmission"/>
                                </do_elseif>
                                <do_else>
                                  <!-- all in correct mode, skip forward to mining -->
                                  <debug_text text="'Start mining'"/>
                                  <signal_cue cue="Scenario2_Mining_Asteroids_Gather"/>
                                </do_else>
                              </actions>
                            </cue>


                            <cue name="Scenario2_Mining_ConfigureMiningLaser_Transmission" instantiate="true">
                              <conditions>
                                <event_cue_signalled/>
                              </conditions>
                              <delay exact="2s"/>
                              <actions>
                                <play_cutscene key="'ShowCharacterBoron'" targetmonitor="true" caption="{10002,23}" result="this.$CutsceneID">
                                  <param name="npcref" object="$Narrator" />
                                </play_cutscene>
                              </actions>
                              <cues>
                                <cue name="Scenario2_Mining_ConfigureMiningLaser_Speak">
                                  <conditions>
                                    <event_cue_completed cue="parent" comment="req. parent-cue delay"/>
                                  </conditions>
                                  <delay exact="1s"/>
                                  <actions>
                                    <speak actor="$Narrator" priority="100">
                                      <text line="30402088" comment="To begin, activate the ship's mining turrets."/>
                                    </speak>
                                  </actions>
                                </cue>
                                <cue name="Scenario2_Mining_ConfigureMiningLaser_SpeakEnd">
                                  <conditions>
                                    <event_speak_finished actor="$Narrator" line="30402088"/>
                                  </conditions>
                                  <delay exact="1s"/>
                                  <actions>
                                    <stop_cutscene cutscene="parent.$CutsceneID"/>
                                    <signal_cue cue="Scenario2_Mining_ConfigureMiningLaser"/>
                                  </actions>
                                </cue>
                              </cues>
                            </cue>

                            <cue name="Scenario2_Mining_ConfigureMiningLaser" comment="capship-case (switch weaponmode to fire mining laser)">
                              <conditions>
                                <event_cue_signalled/>
                              </conditions>
                              <actions>
                                <set_value name="$ShipMenuWasOpen" exact="false"/>
                                <show_help line="14030" position="1" timeout="false" width="256" force="true" comment="Press $INPUT_ACTION_OPEN_COCKPIT_MENU$ to open SHIP MENU." />
                              </actions>
                              <cues>

                                <cue name="Scenario2_Mining_OpenShipMenu">
                                  <conditions>
                                    <event_ui_triggered screen="'DockedMenu'"/>
                                  </conditions>
                                  <actions>
                                    <remove_help line="14030"/>
                                    <set_value name="$ShipMenuWasOpen" exact="true"/>
                                    <show_help line="14110" position="15" timeout="false" width="256" force="true" comment="Change turret behaviour to 'Mining'.(for M/L/XL ships)" />
                                    <show_help_overlay id="'docked_turretconfig_modes'" highlightonly="true" />
                                  </actions>
                                  <cues>

                                    <cue name="Scenario2_Mining_ChangedWeaponMode">
                                      <conditions>
                                        <event_object_weaponmode_changed object="player.ship" weaponmode="weaponmode.mining" />
                                      </conditions>
                                      <actions>
                                        <remove_help line="14110"/>
                                        <remove_help_overlay id="'docked_turretconfig_modes'"/>
                                        <set_value name="$TurretsAreMining" exact="true"/>
                                      </actions>
                                      <delay exact="1s"/>
                                      <actions>
                                        <speak actor="$Narrator" priority="100">
                                          <text line="30402089" comment="Very good. The turrets will automatically acquire targets."/>
                                        </speak>
                                      </actions>
                                      <delay exact="6s"/>
                                      <actions>
                                        <show_help line="14111" duration="7s" position="15" force="true" comment="MINING LASERS will mine more efficiently than other types of turrets."/>
                                      </actions>
                                      <cues>
                                        <cue name="Scenario2_Mining_ChangedWeaponMode_Delayed">
                                          <conditions>
                                            <event_ui_triggered screen="'hintclosed'" control="'14111'"/>
                                          </conditions>
                                          <actions>
                                            <do_if value="not player.ship.hasarmedminingdrones">
                                              <signal_cue cue="Scenario2_Mining_ConfigureDrones_Transmission"/>
                                            </do_if>
                                            <do_else>
                                              <signal_cue cue="Scenario2_Mining_ConfigureDone"/>
                                            </do_else>
                                          </actions>
                                        </cue>
                                      </cues>
                                    </cue>
                                  </cues>
                                </cue>
                              </cues>
                            </cue>

                            <cue name="Scenario2_Mining_ConfigureDrones_Transmission">
                              <conditions>
                                <event_cue_signalled/>
                              </conditions>
                              <delay exact="1s"/>
                              <actions>
                                <play_cutscene key="'ShowCharacterBoron'" targetmonitor="true" caption="{10002,23}" result="this.$CutsceneID">
                                  <param name="npcref" object="$Narrator" />
                                </play_cutscene>
                              </actions>
                              <cues>
                                <cue name="Scenario2_Mining_ConfigureDrones_Speak">
                                  <delay exact="2s"/>
                                  <actions>
                                    <speak actor="$Narrator" priority="100">
                                      <text line="30402090" comment="This ship contains a number of drones to collect the minerals."/>
                                      <text line="30402092" comment="The drones are currently inactive."/>
                                      <text line="30402091" comment="Arm the ore collector drones."/>
                                    </speak>
                                  </actions>
                                </cue>
                                <cue name="Scenario2_Mining_ConfigureDrones_SpeakEnd">
                                  <conditions>
                                    <event_speak_finished actor="$Narrator" line="30402090"/>
                                  </conditions>
                                  <delay exact="1s"/>
                                  <actions>
                                    <stop_cutscene cutscene="parent.$CutsceneID"/>
                                    <signal_cue cue="Scenario2_Mining_DroneMode"/>
                                  </actions>
                                </cue>
                              </cues>
                            </cue>

                            <cue name="Scenario2_Mining_DroneMode">
                              <conditions>
                                <event_cue_signalled/>
                              </conditions>
                              <actions>
                                <show_help_overlay id="'docked_drones_orecollector'" highlightonly="true" />
                                <show_help line="14150" position="5" timeout="false" width="256" force="true" comment="Change the drone status to armed." />
                              </actions>
                              <cues>
                                <cue name="Scenario2_Mining_DroneModeChanged">
                                  <conditions>
                                    <event_object_miningdrones_armed object="player.ship"/>
                                  </conditions>
                                  <actions>
                                    <remove_help_overlay id="'docked_drones_orecollector'"/>
                                    <remove_help line="14150"/>
                                  </actions>
                                  <delay exact="0.5s"/>
                                  <actions>
                                    <signal_cue cue="Scenario2_Mining_ConfigureDone"/>
                                  </actions>
                                </cue>
                              </cues>
                            </cue>

                            <cue name="Scenario2_Mining_ConfigureDone">
                              <conditions>
                                <event_cue_signalled/>
                              </conditions>
                              <actions>
                                <show_help line="1010" duration="7s" position="1" force="true" comment="Close the menu by ..."/>
                              </actions>
                              <cues>
                                <cue name="Scenario2_Mining_ClosedShipMenu">
                                  <conditions>
                                    <event_ui_triggered screen="'DockedMenu'" control="'menu_close'"/>
                                  </conditions>
                                  <actions>
                                    <remove_help line="1010"/>
                                  </actions>
                                  <delay exact="1s"/>
                                  <actions>
                                    <signal_cue cue="Scenario2_Mining_Asteroids_Gather"/>
                                  </actions>
                                </cue>
                              </cues>
                            </cue>

                          </cues>
                        </cue>

                        <cue name="Scenario2_Mining_Asteroids_Gather">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <actions>
                            <set_value name="$MinedAsteroid" exact="false"/>
                            <create_group groupname="$miningdrones"/>
                            <set_objective cue="Scenario2_Mining_Start" step="7" action="objective.wait" text="{30179,6025}" comment="Observe mining operation"/>
                          </actions>
                          <cues>

                            <cue name="Scenario2_Mining_DroneLaunched" instantiate="true" comment="manage all drones launched">
                              <conditions>
                                <event_object_undocked_from container="player.ship"/>
                                <check_value value="event.param.isclass.ship_s"/>
                              </conditions>
                              <actions>
                                <add_to_group groupname="$miningdrones" object="event.param"/>
                              </actions>
                            </cue>

                            <cue name="Scenario2_Mining_DroneLaunched_Monitor">
                              <conditions>
                                <event_object_undocked_from container="player.ship"/>
                              </conditions>
                              <actions>
                                <play_cutscene key="'ShowCharacterBoron'" targetmonitor="true" caption="{10002,23}" result="this.$CutsceneID">
                                  <param name="npcref" object="$Narrator" />
                                </play_cutscene>
                              </actions>
                              <cues>
                                <cue name="Scenario2_Mining_DroneLaunched_Speak">
                                  <delay exact="1s"/>
                                  <actions>
                                    <speak actor="$Narrator" priority="100">
                                      <text line="30402093" comment="The first drones have taken flight."/>
                                      <text line="30402094" comment="Be careful not to leave your drones behind."/>
                                    </speak>
                                  </actions>
                                </cue>
                                <cue name="Scenario2_Mining_DroneLaunched_SpeakEnd">
                                  <conditions>
                                    <event_speak_finished actor="$Narrator" line="30402093"/>
                                  </conditions>
                                  <delay exact="1s"/>
                                  <actions>
                                    <stop_cutscene cutscene="parent.$CutsceneID"/>
                                  </actions>
                                </cue>
                              </cues>
                            </cue>

                            <cue name="Scenario2_Mining_DroneReturned">
                              <conditions>
                                <event_object_docked group="$miningdrones"/>
                              </conditions>
                              <actions>
                                <remove_from_group group="$miningdrones" object="event.object"/>
                                <play_cutscene key="'ShowCharacterBoron'" targetmonitor="true" caption="{10002,23}" result="this.$CutsceneID">
                                  <param name="npcref" object="$Narrator" />
                                </play_cutscene>
                              </actions>
                              <cues>
                                <cue name="Scenario2_Mining_DroneReturned_Speak">
                                  <delay exact="1s"/>
                                  <actions>
                                    <speak actor="$Narrator" priority="100">
                                      <text line="30402095" comment="The first drones have returned."/>
                                    </speak>
                                  </actions>
                                </cue>
                                <cue name="Scenario2_Mining_DroneReturned_SpeakEnd">
                                  <conditions>
                                    <event_speak_finished actor="$Narrator" line="30402095"/>
                                  </conditions>
                                  <delay exact="1s"/>
                                  <actions>
                                    <stop_cutscene cutscene="parent.$CutsceneID"/>
                                    <signal_cue cue="Scenario2_Mining_Done"/>
                                  </actions>
                                </cue>
                              </cues>
                            </cue>

                            <cue name="Scenario2_Asteroids_Drop">
                              <conditions>
                                <event_object_killed_object object="player.ship"/>
                                <check_value value="event.param.isclass.[class.asteroid]"/>
                                <check_value value="not player.ship.isclass.[class.ship_s]"/>
                              </conditions>
                              <actions>
                                <find_object groupname="$asteroidshards" class="[class.collectablewares]" space="$ResourceSector" multiple="true" append="true">
                                  <match_distance object="player.entity" max="5km"/>
                                </find_object>

                                <do_all exact="$asteroidshards.count" counter="$i" reverse="true">
                                  <do_if value="not $asteroidshards.{$i}.isclass.collectable">
                                    <remove_from_group group="$asteroidshards" object="$asteroidshards.{$i}"/>
                                  </do_if>
                                </do_all>

                                <debug_text text="'Asteroidshards: ' + $asteroidshards.count" chance="$DebugChance"/>
                                <do_if value="$asteroidshards.count">
                                  <show_help line="14200" duration="15s" position="13" width="256" force="true" comment="There are now mineral drops nearby in space."/>
                                </do_if>
                              </actions>
                            </cue>
                          </cues>
                        </cue>

                        <cue name="Scenario2_Mining_Done">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <actions>
                            <play_cutscene key="'ShowCharacterBoron'" targetmonitor="true" caption="{10002,23}" result="this.$CutsceneID">
                              <param name="npcref" object="$Narrator" />
                            </play_cutscene>
                          </actions>
                          <cues>
                            <cue name="Scenario2_Mining_Done_Speak">
                              <delay exact="1s"/>
                              <actions>
                                <speak actor="$Narrator" priority="100">
                                  <text line="30402100" comment="You can order the ship to continue the operation if you wish."/>
                                  <text line="30402026" comment="Do you wish to visit another location?"/>
                                </speak>
                              </actions>
                            </cue>

                            <cue name="Scenario2_Mining_Done_SpeakEnd">
                              <conditions>
                                <event_speak_finished actor="$Narrator" line="30402100"/>
                              </conditions>
                              <delay exact="1s"/>
                              <actions>
                                <stop_cutscene cutscene="parent.$CutsceneID"/>
                                <remove_mission cue="Scenario2_Mining_Start" type="completed" />
                              </actions>
                              <cues>
                                <cue name="Scenario2_Mining_Done_MapHint">
                                  <delay exact="2s"/>
                                  <actions>
                                    <do_if value="player.input.controller">
                                      <show_help line="950"  position="15" duration="10s" width="256" force="true" comment="Press $INPUT_ACTION_OPTIONSMENU$ and select the map using $INPUT_ACTION_WIDGET_TABSCROLL_LEFT$,$INPUT_ACTION_WIDGET_TABSCROLL_RIGHT$." />
                                    </do_if>
                                    <do_else>
                                      <show_help line="20140" position="15" duration="10s" width="256" force="true" comment="Press $INPUT_ACTION_OPEN_MAP$ to open the MAP menu and try other scenarios."/>
                                    </do_else>
                                  </actions>
                                </cue>
                              </cues>
                            </cue>

                          </cues>
                        </cue>

                      </cues>
                    </cue>

                  </cues>
                </cue>
              </cues>

            </cue>

            <cue name="Scenario2_Mining_Cleanup">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <debug_text text="'Cleaning up'" chance="$DebugChance"/>
                <remove_help all="true"/>
              </actions>
            </cue>

          </cues>
        </cue>

        <cue name="Scenario2_Trading">
          <conditions>
            <event_cue_completed cue="Scenario2_TradingShips"/>
          </conditions>
          <cues>

            <cue name="Scenario2_Trading_CheckMission" comment="missions active while on the mining-ship">
              <actions>
                <set_value name="$TradeMissionActive" exact="false"/>
              </actions>
              <cues>
                <cue name="Scenario2_Trading_OnLocation" checkinterval="3s" instantiate="true">
                  <conditions>
                    <cue_is_waiting cue="Scenario2_Trading_Start"/>
                  </conditions>
                  <actions>
                    <set_value name="$OnTradingShip" exact="false"/>
                    <do_all exact="$TradersPlayer.count" counter="$k">
                      <do_if value="player.entity.hascontext.{$TradersPlayer.{$k}}">
                        <set_value name="$OnTradingShip" exact="true"/>
                      </do_if>
                    </do_all>

                    <!--debug_text text="'OnLocation: ' + $OnTradingShip + ' missionactive: ' + $TradeMissionActive"/-->

                    <do_if value="$OnTradingShip and not $TradeMissionActive">
                      <set_value name="$TradeMissionActive" exact="true"/>
                      <reset_cue cue="Scenario2_Trading_Start"/>
                      <reset_cue cue="Scenario2_Trading_Cleanup"/>
                      <signal_cue cue="Scenario2_Trading_Start"/>
                    </do_if>
                    <do_elseif value="not $OnTradingShip and $TradeMissionActive">
                      <set_value name="$TradeMissionActive" exact="false"/>
                      <remove_help all="true"/>
                      <show_notification text="{1015,401}" sound="notification_warning"/>
                      <!--remove_mission cue="Start" type="aborted" /-->
                      <signal_cue cue="Scenario2_Trading_Cleanup" />
                    </do_elseif>
                  </actions>
                </cue>
              </cues>
            </cue>

            <cue name="Scenario2_Trading_Selected" instantiate="true">
              <conditions>
                <event_ui_triggered screen="'MapMenu'" control="'selection_ship'"/>
              </conditions>
              <actions>
                <set_value name="$SelectedShip" exact="component.{event.param3} "/>
                <do_all exact="$TradersPlayer.count" counter="$k">
                  <do_if value="$TradersPlayer.{$k} == $SelectedShip">
                    <debug_text text="'Selected trader-ship on map'"/>
                    <speak actor="$Narrator"  line="30402011" comment="This freighter is looking for some lucrative trade runs."/>
                    <signal_cue cue="Scenario2_Intro_ContextMenu"/>
                    <break/>
                  </do_if>
                </do_all>
              </actions>
            </cue>

            <cue name="Scenario2_Trading_Start">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <reset_cue cue="Scenario2_Crystal_Start"/>
                <reset_cue cue="Scenario2_DataVault_Start"/>
                <reset_cue cue="Scenario2_DataVault_StagingArea"/>
                <reset_cue cue="Scenario2_Station_Start"/>
                <reset_cue cue="Scenario2_Mining_Start"/>
                <reset_cue cue="Scenario2_Boarding_Start"/>
                <!--show_help line="25001" position="15" duration="10s" log="true" width="256" force="true" comment="Welcome to the ..."/-->
              </actions>
              <cues>

                <cue name="Scenario2_Trading_ConvStart">
                  <delay exact="4s"/>
                  <actions>
                    <play_cutscene key="'ShowCharacterBoron'" targetmonitor="true" caption="{10002,23}" result="this.$CutsceneID">
                      <param name="npcref" object="$Narrator" />
                    </play_cutscene>
                  </actions>
                  <cues>
                    <cue name="Scenario2_Trading_Speak">
                      <delay exact="5s"/>
                      <actions>
                        <set_value name="this.$isselloffer" exact="$TradersPlayer.indexof.{player.ship} and @player.ship.tradeorders.{1}.trade.seller"/>
                        <speak actor="$Narrator" priority="100">
                          <text line="if this.$isselloffer then 30402102 else 30402103" comment="This ship is currently on the way to buy/sell some wares."/>
                          <!--text line="30402103" comment="This ship is currently on the way to sell wares in it's cargo bay."/-->
                          <text line="30402104" comment="Even in dangerous areas of space, you will likely find freighters attempting to turn a profit."/>
                          <text line="30402105" comment="We should allow this ship to continue it's trade run."/>
                        </speak>
                      </actions>
                    </cue>

                    <cue name="Scenario2_Trading_SpeakEnd">
                      <conditions>
                        <check_any>
                          <event_speak_finished actor="$Narrator" line="30402102"/>
                          <event_speak_finished actor="$Narrator" line="30402103"/>
                        </check_any>
                      </conditions>
                      <delay exact="1s"/>
                      <actions>
                        <stop_cutscene cutscene="parent.$CutsceneID"/>
                      </actions>
                      <cues>
                        <cue name="Scenario2_Trading_Done_MapHint">
                          <delay exact="2s"/>
                          <actions>
                            <do_if value="player.input.controller">
                              <show_help line="950"  position="15" duration="10s" width="256" force="true" comment="Press $INPUT_ACTION_OPTIONSMENU$ and select the map using $INPUT_ACTION_WIDGET_TABSCROLL_LEFT$,$INPUT_ACTION_WIDGET_TABSCROLL_RIGHT$." />
                            </do_if>
                            <do_else>
                              <show_help line="20140" position="15" duration="10s" width="256" force="true" comment="Press $INPUT_ACTION_OPEN_MAP$ to open the MAP menu and try other scenarios."/>
                            </do_else>
                          </actions>
                        </cue>
                      </cues>
                    </cue>
                  </cues>
                </cue>

              </cues>
            </cue>

            <cue name="Scenario2_Trading_Cleanup">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <debug_text text="'Cleaning up'" chance="$DebugChance"/>
                <remove_help all="true"/>
              </actions>
            </cue>

          </cues>
        </cue>

        <cue name="Scenario2_Crystal">
          <actions>
            <find_sector name="$CrystalSector" macro="macro.demo_cluster_13_sector001_macro"/>
            <create_position name="$CrystalPosition" x="186380" y="0m" z="60506"/>
            <create_ship name="$CrystalShip" macro="ship_arg_s_fighter_02_a_macro" sector="$CrystalSector">
              <owner exact="faction.player" overridenpc="true" />
              <loadout ref="scenario_basic_fighter"/>
              <position x="$CrystalPosition.x" y="$CrystalPosition.y" z="$CrystalPosition.z" />
              <rotation yaw="168.15657deg" pitch="12.01036deg" roll="33.6884deg"/>
            </create_ship>

            <set_object_min_hull object="$CrystalShip" min="75" comment="invulnerable"/>

          </actions>
          <cues>

            <cue name="Scenario2_Crystal_Selected" instantiate="true">
              <conditions>
                <event_ui_triggered screen="'MapMenu'" control="'selection_ship'"/>
                <check_value value="component.{event.param3} == $CrystalShip"/>
              </conditions>
              <actions>
                <debug_text text="'Selected crystal-ship on map'"/>
                <speak actor="$Narrator"  line="30402009" comment="This scout has detected some rather interesting crystal formations on asteroids."/>
                <signal_cue cue="Scenario2_Intro_ContextMenu"/>
              </actions>
            </cue>

            <cue name="Scenario2_Crystal_Teleport" instantiate="true">
              <conditions>
                <event_player_teleport_successful/>
                <check_value value="player.entity.hascontext.{$CrystalShip}"/>
                <cue_is_waiting cue="Scenario2_Crystal_Start"/>
              </conditions>
              <actions>
                <!--debug_text text="'Player arrived at Crystal-Ship'" comment=" (which by default is near enough to trigger the mission)"/-->
              </actions>
            </cue>

            <cue name="Scenario2_Crystal_CheckMission" comment="missions active while on the crystalhunter-ship">
              <actions>
                <set_value name="$CrystalMissionActive" exact="false"/>
              </actions>
              <cues>
                <cue name="Scenario2_Crystal_StagingAreaOk" checkinterval="3s" instantiate="true">
                  <actions>
                    <!--debug_text text="'context=' + player.entity.hascontext.{$CrystalShip} + ' active: ' + $CrystalMissionActive"/-->
                    <do_if value="player.entity.hascontext.{$CrystalShip} and (not $CrystalMissionActive)">
                      <set_value name="$CrystalMissionActive" exact="true"/>
                      <reset_cue cue="Scenario2_Crystal_Start"/>
                      <reset_cue cue="Scenario2_Crystal_Cleanup"/>
                      <signal_cue cue="Scenario2_Crystal_Start"/>
                    </do_if>
                    <do_elseif value="(not player.entity.hascontext.{$CrystalShip}) and $CrystalMissionActive">
                      <set_value name="$CrystalMissionActive" exact="false"/>
                      <remove_help all="true"/>
                      <show_notification text="{1015,401}" sound="notification_warning"/>
                      <!--remove_mission cue="Start" type="aborted" /-->
                      <signal_cue cue="Scenario2_Crystal_Cleanup" />
                    </do_elseif>
                  </actions>
                </cue>
              </cues>
            </cue>

            <cue name="Scenario2_Crystal_Start">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <reset_cue cue="Scenario2_Station_Start"/>
                <reset_cue cue="Scenario2_DataVault_Start"/>
                <reset_cue cue="Scenario2_DataVault_StagingArea"/>
                <reset_cue cue="Scenario2_Trading_Start"/>
                <reset_cue cue="Scenario2_Mining_Start"/>
                <reset_cue cue="Scenario2_Boarding_Start"/>

                <create_group groupname="$crystalasteroids"/>
                <create_group groupname="$crystalcluster"/>
                <create_group groupname="$crystaldrops"/>

              </actions>
              <cues>

                <cue name="Scenario2_Crystal_IntroStart" checkinterval="2s">
                  <conditions>
                    <check_value value="not player.isinfullscreenmenu" comment="wait for closing map"/>
                  </conditions>
                  <actions>
                    <create_mission cue="Scenario2_Crystal_Start" type="missiontype.tutorial" name="{30179,5001}" description="{30179,5002}" difficulty="level.easy" faction="faction.argon" abortable="false">
                      <briefing>
                        <objective step="1" action="objective.custom"     customaction="{30179,5020}" comment="sit down"/>
                        <objective step="2" action="objective.flyto"      text="{30179,5021}"         comment="fly to: asteroids"/>
                        <objective step="3" action="objective.collect"    text="{30179,5022}"         comment="collect: crystals"/>
                      </briefing>
                    </create_mission>
                  </actions>
                </cue>

                <cue name="Scenario2_Crystal_Standing" checkinterval="1s">
                  <conditions>
                    <check_value value="(player.ship) and not (player.occupiedship)"/>
                    <check_value value="(not player.isinfullscreenmenu)" comment="not while map is open"/>
                    <cue_is_complete cue="Scenario2_Crystal_IntroStart"/>
                  </conditions>
                  <actions>
                    <reset_cue cue="Scenario2_Crystal_Sitting"/>
                    <remove_help line="24010"/>
                    <show_help line="1040" position="15" timeout="false" log="true" width="256" force="true" comment="To sit down in your chair click on it or press $INPUT_STATE_INTERACTION_MENU$ to interact."/>
                    <set_objective cue="Scenario2_Crystal_Start" step="1" action="objective.custom" customaction="{30179,5020}" comment=""/>
                  </actions>
                </cue>

                <cue name="Scenario2_Crystal_Sitting" checkinterval="1s">
                  <conditions>
                    <check_value value="(player.ship) and (player.occupiedship)"/>
                    <check_value value="(not player.isinfullscreenmenu)" comment="not while map is open"/>
                  </conditions>
                  <actions>
                    <remove_help all="true"/>
                    <reset_cue cue="Scenario2_Crystal_Standing"/>
                    <signal_cue cue="Scenario2_Crystal_MarkTargets"/>
                    <remove_help line="1040"/>
                  </actions>
                </cue>

                <cue name="Scenario2_Crystal_MarkTargets">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <delay exact="2s"/>
                  <actions>
                    <play_cutscene key="'ShowCharacterBoron'" targetmonitor="true" caption="{10002,23}" result="$CutsceneID2">
                      <param name="npcref" object="$Narrator" />
                    </play_cutscene>
                  </actions>
                  <cues>
                    <cue name="Scenario2_Crystal_MarktTargetsSpeak">
                      <delay exact="3s"/>
                      <actions>
                        <speak actor="$Narrator" priority="100">
                          <text line="30402041" comment="Now that you're aboard the scout ship, let's see if you can find those elusive crystals."/>
                          <text line="30402043" comment="Reports say that you can spot their glisten at a distance."/>
                          <text line="30402042" comment="I'll mark the most likely candidates"/>
                        </speak>
                      </actions>
                      <cues>
                        <cue name="Scenario2_Crystal_MarkTargetsEnded">
                          <conditions>
                            <event_speak_finished actor="$Narrator" line="30402041"/>
                          </conditions>
                          <actions>
                            <stop_cutscene cutscene="$CutsceneID2"/>
                          </actions>
                          <cues>
                            <cue name="Scenario2_Crystal_MarkTargets_UpdateObjective">
                              <delay exact="1s"/>
                              <actions>
                                <signal_cue cue="Scenario2_Crystal_Refresh"/>
                              </actions>
                            </cue>
                          </cues>
                        </cue>

                        <cue name="Scenario2_Crystal_Refresh" instantiate="true" comment="find new crystals">
                          <conditions>
                            <check_any>
                              <event_cue_signalled/>
                              <event_object_destroyed group="$crystalcluster"/>
                            </check_any>
                            <check_value value="$crystalcluster.count == 0"/>
                          </conditions>
                          <actions>
                            <include_actions ref="md.LIB_Generic.FindCrystalsNearPlayer"/>
                            <clear_group group="$crystalasteroids"/>
                            <do_all exact="$crystalcluster.count" counter="$i">
                              <add_to_group groupname="$crystalasteroids" object="$crystalcluster.{$i}.parent"/>
                            </do_all>
                            <set_objective cue="Scenario2_Crystal_Start" step="2" action="objective.flyto" text="{30179,5021}" group="$crystalasteroids" comment="fly to: crystals"/>
                          </actions>
                        </cue>

                        <cue name="Scenario2_Crystal_Approach" checkinterval="2s">
                          <conditions>
                            <check_value value="$crystalcluster.count"/>
                            <check_any exact="$crystalcluster.count" counter="$c">
                              <check_value value="$crystalcluster.{$c}.distanceto.{player.entity} lt 500m"/>
                            </check_any>
                          </conditions>
                          <actions>

                            <!-- filter to nearby crystal clusters -->
                            <create_group groupname="$crystalclusternear"/>
                            <do_all exact="$crystalcluster.count" counter="$c">
                              <do_if value="$crystalcluster.{$c}.distanceto.{player.entity} lt 700m">
                                <add_to_group groupname="$crystalclusternear" object="$crystalcluster.{$c}"/>
                              </do_if>
                            </do_all>

                            <set_objective cue="Scenario2_Crystal_Start" step="3" action="objective.collect" text="{30179,5022}" group="if $crystalclusternear.count then $crystalclusternear else $crystalcluster" comment="collect crystals"/>
                            <play_cutscene key="'ShowCharacterBoron'" targetmonitor="true" caption="{10002,23}" result="$CutsceneID3">
                              <param name="npcref" object="$Narrator" />
                            </play_cutscene>
                          </actions>
                          <cues>
                            <cue name="Scenario2_Crystal_Approach_Speak">
                              <delay exact="1s"/>
                              <actions>
                                <speak actor="$Narrator" priority="100" >
                                  <text line="30402044" comment="It appears that you've found a cluster of crystals."/>
                                  <text line="30402045" comment="I expect a few shots from your weapons will help dislodge them."/>
                                </speak>
                              </actions>
                            </cue>

                            <cue name="Scenario2_Crystal_Approach_ConvEnded">
                              <conditions>
                                <event_speak_finished actor="$Narrator" line="30402044"/>
                              </conditions>
                              <actions>
                                <stop_cutscene cutscene="$CutsceneID3"/>
                              </actions>
                            </cue>

                          </cues>
                        </cue>


                        <cue name="Scenario2_Crystals_Do" instantiate="true">
                          <conditions>
                            <event_object_dropped_objects group="$crystalcluster"/>
                          </conditions>
                          <actions>

                            <do_all exact="event.param.count" counter="$cdi">
                              <do_if value="event.param.{$cdi}.isclass.[class.collectablewares]">
                                <add_to_group groupname="$crystaldrops" object="event.param.{$cdi}"/>
                              </do_if>
                            </do_all>
                            <debug_text text="'crystaldrops: ' + $crystaldrops.count" chance="$DebugChance"/>

                            <do_if value="$crystaldrops.count" comment="gather crystaldrops them">
                              <set_objective cue="Scenario2_Crystal_Start" step="3" action="objective.collect" customaction="{30179,5022}"  group="$crystalcluster" comment="collect: crystals" />
                              <remove_help all="true"/>
                              <!--show_help line="14320" timeout="false" position="13" force="true" comment="Pick up the crystal which just dropped."/-->
                              <show_help line="14321" timeout="false" width="256" position="13" force="true" comment="Fly over an item or hold $INPUT_STATE_LOOTMAGNET$ to use the CONTAINER MAGNET to pick it up."/>
                            </do_if>
                            <do_else comment="no dropped crystals, shoot crystals on asteroids">
                              <signal_cue cue="Scenario2_Crystal_Refresh"/>
                            </do_else>
                          </actions>
                        </cue>

                        <cue name="Scenario2_Crystals_Destroyed">
                          <conditions>
                            <event_object_destroyed group="$crystaldrops"/>
                            <check_value value="event.param2 != killmethod.collected"/>
                          </conditions>
                          <actions>
                            <remove_help line="14321"/>
                            <play_cutscene key="'ShowCharacterBoron'" targetmonitor="true" caption="{10002,23}" result="$CutsceneID4">
                              <param name="npcref" object="$Narrator" />
                            </play_cutscene>
                          </actions>
                          <cues>
                            <cue name="Scenario2_Crystals_Destroyed_Speak">
                              <delay exact="2s"/>
                              <actions>
                                <speak actor="$Narrator" priority="100">
                                  <text line="30402046" comment="No matter. I expect you can find many more."/>
                                </speak>
                              </actions>
                            </cue>
                            <cue name="Scenario2_Crystal_Destroyed_ConvEnded">
                              <conditions>
                                <event_speak_finished actor="$Narrator" line="30402046"/>
                              </conditions>
                              <actions>
                                <stop_cutscene cutscene="$CutsceneID4"/>
                              </actions>
                            </cue>
                          </cues>
                        </cue>

                        <cue name="Scenario2_Crystals_Pickup">
                          <conditions>
                            <event_inventory_added object="player.entity"/>
                          </conditions>
                          <actions>
                            <remove_help line="14321"/>
                            <remove_help line="14320"/>
                            <clear_group group="$crystalcluster"/>

                            <play_cutscene key="'ShowCharacterBoron'" targetmonitor="true" caption="{10002,23}" result="$CutsceneID5">
                              <param name="npcref" object="$Narrator" />
                            </play_cutscene>
                          </actions>
                          <cues>
                            <cue name="Scenario2_Crystals_Pickup_Speak">
                              <delay exact="2s"/>
                              <actions>
                                <speak actor="$Narrator" priority="100">
                                  <text line="30402047" comment="I'll have your sensors begin analysis."/>
                                  <text line="30402048" comment="While the computer is working, perhaps you can go to another location."/>
                                </speak>
                              </actions>
                            </cue>
                            <cue name="Scenario2_Crystal_Pickup_ConvEnded">
                              <conditions>
                                <event_speak_finished actor="$Narrator" line="30402047"/>
                              </conditions>
                              <actions>
                                <stop_cutscene cutscene="$CutsceneID5"/>
                                <signal_cue cue="Scenario2_Crystals_Done"/>
                              </actions>
                            </cue>
                          </cues>
                        </cue>

                        <cue name="Scenario2_Crystals_Done">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <actions>
                            <remove_mission cue="Scenario2_Crystal_Start" type="completed" />
                          </actions>
                          <cues>
                            <cue name="Scenario2_Crystals_Done_MapHint">
                              <delay exact="2s"/>
                              <actions>
                                <do_if value="player.input.controller">
                                  <show_help line="950"  position="15" duration="10s" width="256" force="true" comment="Press $INPUT_ACTION_OPTIONSMENU$ and select the map using $INPUT_ACTION_WIDGET_TABSCROLL_LEFT$,$INPUT_ACTION_WIDGET_TABSCROLL_RIGHT$." />
                                </do_if>
                                <do_else>
                                  <show_help line="20140" position="15" duration="10s" width="256" force="true" comment="Press $INPUT_ACTION_OPEN_MAP$ to open the MAP menu and try other scenarios."/>
                                </do_else>
                              </actions>
                            </cue>
                          </cues>
                        </cue>


                      </cues>
                    </cue>
                  </cues>
                </cue>

              </cues>

            </cue>

            <cue name="Scenario2_Crystal_Cleanup">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <debug_text text="'Cleanup'" chance="$DebugChance"/>
                <remove_help all="true"/>
              </actions>
            </cue>



          </cues>
        </cue>

        <!-- Assumes datavault placed in PlacedObjects.xml -->
        <cue name="Scenario2_DataVault" onfail="complete">
          <conditions>
            <check_value value="md.PlacedObjects.Place_DataVaults_Scenario2.$DemoVaultsGroup.count?"/>
          </conditions>
          <actions>
            <set_value name="$TheVault" exact="md.PlacedObjects.Place_DataVaults_Scenario2.$DemoVaultsGroup.{1}"/>
            <set_value name="$VaultRepaired" exact="false"/>
            <set_value name="$VaultUnlocked" exact="false"/>

            <!-- adding from gamestarts.xml is apparently broken -->
            <add_inventory entity="player.entity" ware="ware.weapon_gen_spacesuit_repairlaser_01_mk1"/>

            <find_sector name="$VaultSector" macro="macro.demo_cluster_13_sector001_macro"/>
            <create_ship name="$VaultShip" macro="ship_arg_s_fighter_02_a_macro" sector="$VaultSector">
              <owner exact="faction.player" overridenpc="true" />
              <loadout ref="scenario_basic_fighter"/>
              <orientation orientation="look_at" refobject="$TheVault"/>
              <position object="$TheVault" z="250m" y="100m"/>
              <!--rotation yaw="-165.66963" pitch="-38.28658" roll="14.8682"/-->
            </create_ship>
            <set_object_min_hull object="$VaultShip" min="75" comment="invulnerable"/>
          </actions>
          <cues>

            <cue name="Scenario2_Datavault_Selected" instantiate="true">
              <conditions>
                <event_ui_triggered screen="'MapMenu'" control="'selection_ship'"/>
                <check_value value="component.{event.param3} == $VaultShip"/>
              </conditions>
              <actions>
                <debug_text text="'Selected datavault on map'"/>
                <speak actor="$Narrator"  line="30402008" comment="Ah, this ship has found something quite interesting."/>
                <signal_cue cue="Scenario2_Intro_ContextMenu"/>
              </actions>
            </cue>

            <cue name="Scenario2_DataVault_Teleport" instantiate="true">
              <conditions>
                <event_player_teleport_successful/>
                <check_value value="player.entity.hascontext.{$VaultShip}"/>
                <cue_is_waiting cue="Scenario2_DataVault_Start"/>
              </conditions>
              <actions>
              </actions>
            </cue>

            <cue name="Scenario2_DataVault_StagingArea" comment="trigger of scenario is 'near datavault' (in *any* ship)">
              <actions>
                <set_value name="$ShowWarning" exact="false" comment="no warnings until we reached the area"/>
                <set_value name="$ShowAbort" exact="false" comment="no abort until we reached the area"/>
              </actions>
              <cues>
                <cue name="Scenario2_DataVault_StagingAreaOk" checkinterval="3s">
                  <conditions>
                    <check_value value="not $ShowWarning"/>
                    <check_value value="player.sector == $TheVault.sector and player.entity.distanceto.{$TheVault} le 10km"/>
                  </conditions>
                  <actions>
                    <set_value name="$ShowWarning" exact="true" comment="re-enable leave-warning"/>
                    <set_value name="$ShowAbort" exact="true" comment="re-enable abort"/>
                    <reset_cue cue="Scenario2_DataVault_Start"/>
                    <reset_cue cue="Scenario2_DataVault_Cleanup"/>
                    <signal_cue cue="Scenario2_DataVault_Start"/>
                  </actions>
                </cue>
                <cue name="Scenario2_DataVault_StagingAreaWarning" checkinterval="3s">
                  <conditions>
                    <check_value value="$ShowWarning"/>
                    <check_value value="player.sector == $TheVault.sector  and player.entity.distanceto.{$TheVault} gt 12km"/>
                  </conditions>
                  <actions>
                    <show_notification text="{1015,500}" sound="notification_warning" />
                    <set_value name="$ShowWarning" exact="false" comment="don't keep retriggering"/>
                  </actions>
                </cue>
                <cue name="Scenario2_DataVault_StagingAreaAbort" checkinterval="3s">
                  <conditions>
                    <check_value value="$ShowAbort"/>
                    <check_value value="player.sector != $TheVault.sector or player.entity.distanceto.{$TheVault} gt 20km"/>
                  </conditions>
                  <actions>
                    <remove_help all="true"/>
                    <show_notification text="{1015,401}" sound="notification_warning" comment="Tutorial aborted: player left staging area" />
                    <!--remove_mission cue="Start" type="aborted" /-->
                    <signal_cue cue="Scenario2_DataVault_Cleanup" />
                  </actions>
                </cue>
              </cues>
            </cue>

            <cue name="Scenario2_DataVault_Start">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <delay exact="5s"/>
              <actions>
                <reset_cue cue="Scenario2_Station_Start"/>
                <reset_cue cue="Scenario2_Crystal_Start"/>
                <reset_cue cue="Scenario2_Trading_Start"/>
                <reset_cue cue="Scenario2_Mining_Start"/>
                <reset_cue cue="Scenario2_Boarding_Start"/>

                <play_cutscene key="'ShowCharacterBoron'" targetmonitor="true" caption="{10002,23}" result="this.$CutsceneID">
                  <param name="npcref" object="$Narrator" />
                </play_cutscene>

              </actions>
              <cues>

                <cue name="Scenario2_DataVault_Speak">
                  <delay exact="6s"/>
                  <actions>
                    <speak actor="$Narrator" priority="100" >
                      <text line="30402014" comment="This may well be an abandoned listening post."/>
                      <text line="30402015" comment="There seem to be malfunctioning components. Perhaps we can bring it back online."/>
                    </speak>
                  </actions>
                </cue>

                <cue name="Scenario2_DataVault_ConvEnded">
                  <conditions>
                    <event_speak_finished actor="$Narrator" line="30402014"/>
                  </conditions>
                  <actions>
                    <stop_cutscene cutscene="parent.$CutsceneID"/>
                  </actions>
                  <cues>

                    <cue name="Scenario2_DataVault_StartMission">
                      <actions>
                        <find_player_transporter_slot name="$TransporterSlot" object="player.ship.controlroom"/>
                        <create_mission cue="Scenario2_DataVault_Start" type="missiontype.tutorial" name="{30179,3001}" description="{30179,3002}" difficulty="level.easy" faction="faction.argon" abortable="false">
                          <briefing>
                            <objective step="1" action="objective.usespacesuit" slot="$TransporterSlot"   comment="Use spacesuit"/>
                            <objective step="2" action="objective.custom"     customaction="{30179,3011}" comment="Adapt to spacesuit'"/>
                            <objective step="3" action="objective.flyto"      text="{30179,3012}"         comment="Approach Datavault" slot="$TheVault"/>
                            <objective step="4" action="objective.repair"     text="{30179,3013}"         comment="Repair Pressure leaks"/>
                            <objective step="5" action="objective.repair"     text="{30179,3014}"         comment="Repair Data Leak"/>
                            <objective step="6" action="objective.custom"     customaction="{30179,3015}" comment="Return to Ship"/>
                          </briefing>
                        </create_mission>
                      </actions>
                      <cues>

                        <cue name="Scenario2_DataVault_LeaveShipDelayed">
                          <delay exact="1s"/>
                          <actions>
                            <do_if value="@player.controlled.isclass.spacesuit" comment="already in spacesuit">
                              <signal_cue cue="Scenario2_Spacesuit"/>
                            </do_if>
                            <do_else>
                              <signal_cue cue="Scenario2_DataVault_LeaveShip" comment="leave ship in spacesuit"/>
                            </do_else>
                          </actions>
                        </cue>

                        <cue name="Scenario2_DataVault_LeaveShip">
                          <conditions>
                            <event_cue_signalled/>
                            <check_value value="(not $VaultUnlocked)"/>
                          </conditions>
                          <actions>
                            <find_player_transporter_slot name="$TransporterSlot" object="player.ship.controlroom"/>
                            <set_objective cue="Scenario2_DataVault_Start" step="1" action="objective.usespacesuit" slot="$TransporterSlot"/>
                            <set_value name="$InteractingWithPanel" exact="false"/>
                          </actions>
                          <cues>

                            <cue name="Scenario2_DataVault_StandUp" checkinterval="2s">
                              <conditions>
                                <check_value value="(player.ship) and (player.occupiedship) and (not $InteractingWithPanel)"/>
                              </conditions>
                              <actions>
                                <reset_cue cue="Scenario2_DataVault_WaitStand"/>
                                <reset_cue cue="Scenario2_DataVault_InteractPanel_Open"/>
                                <remove_help all="true" />
                                <show_help line="7010" position="4" timeout="false" force="true" comment="...select 'Get Up'..."/>
                                <show_help_overlay id="'docked_getup'" highlightonly="true"/>
                              </actions>
                            </cue>

                            <cue name="Scenario2_DataVault_WaitStand" checkinterval="2s">
                              <conditions>
                                <check_value value="(player.ship) and not (player.occupiedship) and (not $InteractingWithPanel)"/>
                              </conditions>
                              <actions>
                                <remove_help_overlay id="'docked_getup'"/>
                                <reset_cue cue="Scenario2_DataVault_StandUp"/>
                                <reset_cue cue="Scenario2_DataVault_InteractPanel_Open"/>
                                <remove_help all="true" />
                                <do_if value="player.ship.isclass.ship_s">
                                  <show_help line="7020" position="14" timeout="false" force="true" comment="walk to the exit and interact with the panel."/>
                                </do_if>
                                <do_else>
                                  <show_help line="7021" position="14" timeout="false" force="true" comment="Walk to the elevator and interact with the panel."/>
                                </do_else>
                              </actions>
                            </cue>

                            <cue name="Scenario2_DataVault_InteractPanel_Open">
                              <conditions>
                                <event_ui_triggered screen="'TransporterMenu'" control="''"/>
                                <check_value value="not $VaultUnlocked"/>
                              </conditions>
                              <actions>
                                <reset_cue cue="Scenario2_DataVault_StandUp"/>
                                <reset_cue cue="Scenario2_DataVault_WaitStand"/>
                                <set_value name="$InteractingWithPanel" exact="true"/>
                                <remove_help all="true" />
                                <show_help line="7030" position="14" timeout="false" force="true" comment="This menu shows all possible destinations, including an option to leave your ship using a spacesuit."/>
                              </actions>
                              <cues>
                                <cue name="Scenario2_LeaveShip_InteractPanel_Close">
                                  <conditions>
                                    <event_ui_triggered screen="'TransporterMenu'" control="'menu_close'"/>
                                    <check_value value="not $VaultUnlocked"/>
                                  </conditions>
                                  <actions>
                                    <remove_help line="7030"/>
                                    <set_value name="$InteractingWithPanel" exact="false" comment="this re-enables the 'interact with the panel' hint"/>
                                    <reset_cue cue="Scenario2_DataVault_InteractPanel_Open"/>
                                  </actions>
                                </cue>
                              </cues>
                            </cue>
                            
                            <cue name="Scenario2_DataVault_InteractPanel_UserQuestion_Open">
                              <conditions>
                                <event_ui_triggered screen="'UserQuestionMenu'" control="''"/>
                              </conditions>
                              <actions>
                                <set_value name="$InteractingWithPanel" exact="true"/>
                                <remove_help all="true" />
                                <show_help line="7031" position="18" timeout="false" force="true" comment="Leave your ship in the spacesuit now!"/>
                                <show_help_overlay id="'custom_transporter_confirm'" highlightonly="true"/>
                              </actions>
                              <cues>
                                <cue name="Scenario2_DataVault_InteractPanel_UserQuestion_Close">
                                  <conditions>
                                    <event_ui_triggered screen="'UserQuestionMenu'" control="'menu_close'"/>
                                  </conditions>
                                  <actions>
                                    <set_value name="$InteractingWithPanel" exact="false"/>
                                    <remove_help_overlay id="'custom_transporter_confirm'"/>
                                    <remove_help all="true" />
                                    <reset_cue cue="Scenario2_DataVault_InteractPanel_UserQuestion_Open"/>
                                  </actions>
                                </cue>
                              </cues>
                            </cue>
                          
                          </cues>
                        </cue>

                        <cue name="Scenario2_Spacesuit">
                          <conditions>
                            <check_any>
                              <event_player_teleport_successful/>
                              <event_cue_signalled/>
                            </check_any>
                            <check_value value="@player.controlled.isclass.spacesuit"/>
                          </conditions>
                          <actions>
                            <remove_help all="true" />
                            <cancel_cue cue="Scenario2_DataVault_LeaveShip"/>
                            <update_mission cue="Scenario2_DataVault_Start" endtime="player.age + 30min" comment="spacesuit out-of-air"/>
                          </actions>
                          <cues>

                            <cue name="Scenario2_ReturnToShip" comment="got out from the spacesuit">
                              <conditions>
                                <event_player_teleport_successful/>
                              </conditions>
                              <actions>
                                <do_if value="$VaultUnlocked == true">
                                  <remove_help all="true"/>
                                  <remove_mission cue="Scenario2_DataVault_Start" type="completed"/>
                                  <signal_cue cue="Scenario2_DataVault_Returned_Mentor"/>
                                </do_if>
                                <do_else>
                                  <reset_cue cue="Scenario2_DataVault_LeaveShip"/>
                                  <signal_cue cue="Scenario2_DataVault_LeaveShip"/>
                                  <reset_cue cue="Scenario2_DataVault_Explore"/>
                                  <reset_cue cue="Scenario2_Spacesuit" comment="aborts current instance and allows to be triggered again"/>
                                </do_else>
                              </actions>
                              <cues>
                                <cue name="Scenario2_DataVault_Done_MapHint">
                                  <delay exact="2s"/>
                                  <actions>
                                    <do_if value="player.input.controller">
                                      <show_help line="950"  position="15" duration="10s" width="256" force="true" comment="Press $INPUT_ACTION_OPTIONSMENU$ and select the map using $INPUT_ACTION_WIDGET_TABSCROLL_LEFT$,$INPUT_ACTION_WIDGET_TABSCROLL_RIGHT$." />
                                    </do_if>
                                    <do_else>
                                      <show_help line="20140" position="15" duration="10s" width="256" force="true" comment="Press $INPUT_ACTION_OPEN_MAP$ to open the MAP menu and try other scenarios."/>
                                    </do_else>
                                  </actions>
                                </cue>
                              </cues>
                            </cue>

                            <cue name="Scenario2_DataVault_Returned_Mentor">
                              <conditions>
                                <event_cue_signalled/>
                              </conditions>
                              <delay exact="3s"/>
                              <actions>
                                <play_cutscene key="'ShowCharacterBoron'" targetmonitor="true" caption="{10002,23}" result="this.$CutsceneID">
                                  <param name="npcref" object="$Narrator" />
                                </play_cutscene>
                              </actions>
                              <cues>
                                <cue name="Scenario2_DataVault_Returned_Mentor_ConvStarted">
                                  <delay exact="4s"/>
                                  <actions>
                                    <speak actor="$Narrator" priority="100" >
                                      <text line="30402026" comment="Do you wish to visit another location?"/>
                                    </speak>
                                  </actions>
                                </cue>
                                <cue name="Scenario2_DataVault_Returned_Mentor_ConvEnded">
                                  <conditions>
                                    <event_speak_finished actor="$Narrator" line="30402026"/>
                                  </conditions>
                                  <actions>
                                    <stop_cutscene cutscene="parent.$CutsceneID"/>
                                  </actions>
                                </cue>
                              </cues>
                            </cue>


                            <cue name="Scenario2_Spacesuit_Controls" onfail="cancel">
                              <conditions>
                                <check_value value="(not $VaultUnlocked)"/>
                              </conditions>
                              <delay exact="3s"/>
                              <actions>
                                <set_objective cue="Scenario2_DataVault_Start" step="2" action="objective.custom" customaction="{30179,3011}" object="$TheVault"/>
                                <show_help_multi log="false" force="true" position="1" allowclose="false" width="180">
                                  <text line="7102" comment="Your suit can be steered similarly like a ship. Try steering and strafing at low speeds."/>
                                  <text line="7110" comment="Your spacesuit has a limited oxygen supply."/>
                                </show_help_multi>
                              </actions>
                              <cues>
                                <cue name="Scenario2_SpaceSuit_Controls_Delayed">
                                  <conditions>
                                    <event_ui_triggered screen="'hintclosed'" control="'7102'"/>
                                  </conditions>
                                  <actions>
                                    <do_if value="(not $VaultUnlocked) and player.entity.distanceto.{$TheVault} gt 200m">
                                      <set_objective cue="Scenario2_DataVault_Start" step="3" action="objective.flyto" text="{30179,3012}" object="$TheVault"/>
                                    </do_if>
                                  </actions>
                                  <cues>

                                    <cue name="Scenario2_SpaceSuit_BoostHint" onfail="cancel">
                                      <delay exact="5s" comment="delays actions"/>
                                      <actions>
                                        <set_value name="$BoostHintActive" exact="false"/>
                                      </actions>
                                      <cues>

                                        <cue name="Scenario2_SpaceSuit_BoostHint_Periodic" checkinterval="1s" instantiate="true">
                                          <conditions>
                                            <cue_is_complete cue="Scenario2_SpaceSuit_BoostHint"/>
                                            <check_value value="@player.controlled.isclass.spacesuit"/>
                                          </conditions>
                                          <actions>
                                            <do_if value="player.entity.distanceto.{$TheVault} gt 205 and not $BoostHintActive">
                                              <set_value name="$BoostHintActive" exact="true"/>
                                              <do_if value="player.input.boosttoggle">
                                                <show_help line="2035" position="15" timeout="false" width="256" halign="'center'" force="true" comment="press - Boosting hint"/>
                                              </do_if>
                                              <do_else>
                                                <show_help line="2034" position="15" timeout="false" width="256" halign="'center'" force="true" comment="hold - Boosting hint"/>
                                              </do_else>

                                            </do_if>
                                            <do_elseif value="$BoostHintActive and player.entity.distanceto.{$TheVault} lt 170m " comment="remove if player ignored hint, but still got closeby">
                                              <set_value name="$BoostHintActive" exact="false"/>
                                              <remove_help line="2034"/>
                                              <remove_help line="2035"/>
                                              <cancel_cue cue="Scenario2_SpaceSuit_BoostHint"/>
                                            </do_elseif>
                                          </actions>
                                        </cue>

                                        <cue name="Scenario2_SpaceSuit_BoostHint_Remove">
                                          <conditions>
                                            <check_any>
                                              <event_player_boost_started/>
                                              <event_player_boost_stopped/>
                                            </check_any>
                                            <check_value value="$BoostHintActive"/>
                                          </conditions>
                                          <delay exact="2s"/>
                                          <actions>
                                            <remove_help line="2034"/>
                                            <remove_help line="2035"/>
                                            <cancel_cue cue="Scenario2_SpaceSuit_BoostHint"/>
                                          </actions>
                                        </cue>
                                      </cues>
                                    </cue>

                                  </cues>
                                </cue>
                              </cues>
                            </cue>

                            <cue name="Scenario2_Spacesuit_NearVault" checkinterval="2s">
                              <conditions>
                                <check_value value="(not $VaultUnlocked) and player.entity.distanceto.{$TheVault} lt 150m"/>
                                <cue_is_complete cue="Scenario2_SpaceSuit_Controls_Delayed"/>
                              </conditions>
                              <actions>
                                <signal_cue cue="Scenario2_DataVault_Explore"/>
                              </actions>
                            </cue>

                          </cues>
                        </cue>

                        <cue name="Scenario2_DataVault_Explore">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <actions>
                            <find_object_component name="$VaultDataLeak" object="$TheVault" macro="macro.dataleak_xs_vault_01_macro"/>
                            <find_object_component name="$PressureLeaksList" object="$TheVault" macro="macro.interactive_repairpanel_01_macro" multiple="true" comment="returns a list"/>
                            <!-- convert list to group, which can be used by set_objective /-->
                            <create_group groupname="$PressureLeaksGroup"/>
                            <do_all exact="$PressureLeaksList.count" counter="$l">
                              <add_to_group groupname="$PressureLeaksGroup" object="$PressureLeaksList.{$l}"/>
                            </do_all>
                            <set_value name="$PressureLeaksInitialCount" exact="$PressureLeaksGroup.count"/>

                            <do_if value="not $PressureLeaksGroup.count">
                              <signal_cue cue="Scenario2_DataVault_PressureLeaks_Repaired" comment="leaks already repaired (in earlier attempt)"/>
                            </do_if>
                          </actions>
                          <cues>

                            <cue name="Scenario2_DataVault_PressureLeaks_Conv" onfail="cancel">
                              <conditions>
                                <check_value value="$PressureLeaksGroup.count"/>
                              </conditions>
                              <delay exact="2s"/>
                              <actions>
                                <set_objective cue="Scenario2_DataVault_Start" step="4" action="objective.repair" text="{30179,3013}" group="$PressureLeaksGroup"/>

                                <play_cutscene key="'ShowCharacterBoron'" targetmonitor="true" caption="{10002,23}" result="this.$CutsceneID">
                                  <param name="npcref" object="$Narrator" />
                                </play_cutscene>

                              </actions>
                              <cues>

                                <cue name="Scenario2_DataVault_PressureLeaks_ConvStarted">
                                  <delay exact="3s"/>
                                  <actions>
                                    <speak actor="$Narrator" priority="100" >
                                      <text line="30402016" comment="Several of the damaged elements have been marked on your HUD."/>
                                      <text line="30402017" comment="I believe a pulse from your repair laser will do it!"/>
                                    </speak>
                                  </actions>
                                </cue>

                                <cue name="Scenario2_DataVault_PressureLeaks_ConvEnded">
                                  <conditions>
                                    <event_speak_finished actor="$Narrator" line="30402016"/>
                                  </conditions>
                                  <delay exact="1s"/>
                                  <actions>
                                    <stop_cutscene cutscene="parent.$CutsceneID"/>
                                    <do_if value="player.input.controller">
                                      <show_help line="2043" position="15" timeout="20s" force="true" comment="Press $INPUT_STATE_FIRE_PRIMARY_WEAPON$ to fire your primary weapons."/>
                                    </do_if>
                                    <do_else>
                                      <show_help line="2041" position="15" timeout="20s" force="true" comment="Press $INPUT_STATE_FIRE_PRIMARY_WEAPON_AT_CURSOR$ to fire your weapon towards your mouse cursor."/>
                                    </do_else>
                                  </actions>
                                </cue>
                              </cues>
                            </cue>

                            <cue name="Scenario2_DataVault_PressureLeaks_Repair" instantiate="true">
                              <conditions>
                                <event_object_hull_repaired group="$PressureLeaksGroup"/>
                              </conditions>
                              <delay exact="1ms" comment="Otherwise other cue waiting for event_object_hull_repaired doesn't get triggered (due to remove_from_group in this cue)"/>
                              <actions>
                                <remove_help line="2041"/>
                                <remove_from_group group="$PressureLeaksGroup" object="event.param"/>
                                <set_objective cue="Scenario2_DataVault_Start" step="4" action="objective.repair" text="{30179,3013}" group="$PressureLeaksGroup"/>
                                <do_if value="$PressureLeaksGroup.count == 0" comment="all leaks repaired?">
                                  <signal_cue cue="Scenario2_DataVault_PressureLeaks_Repaired"/>
                                </do_if>
                              </actions>
                            </cue>

                            <cue name="Scenario2_DataVault_PressureLeaksRepair_Conv" instantiate="true">
                              <conditions>
                                <event_object_hull_repaired group="$PressureLeaksGroup" comment="not instantiated, 1 time dialog"/>
                                <check_value value="$PressureLeaksGroup.count gt 0" />
                              </conditions>
                              <delay exact="5s"/>
                              <actions>

                                <set_value name="this.$TextLine" exact="0"/>

                                <do_if value="$PressureLeaksGroup.count == $PressureLeaksInitialCount - 1">
                                  <set_value name="this.$TextLine" exact="30402018" comment="Yes, I'm starting to see activity."/>
                                </do_if>
                                <do_elseif value="$PressureLeaksGroup.count == 1">
                                  <set_value name="this.$TextLine" exact="30402028" comment="I believe you're almost done."/>
                                </do_elseif>
                                <do_elseif value="$PressureLeaksGroup.count == 3">
                                  <set_value name="this.$TextLine" exact="30402027" comment="Just a few more."/>
                                </do_elseif>
                                <do_else>
                                  <cancel_cue cue="this" comment="stop this instance"/>
                                </do_else>

                                <do_if value="this.$TextLine != 0">
                                  <play_cutscene key="'ShowCharacterBoron'" targetmonitor="true" caption="{10002,23}" result="this.$CutsceneID">
                                    <param name="npcref" object="$Narrator" />
                                  </play_cutscene>
                                </do_if>

                              </actions>
                              <cues>

                                <cue name="Scenario2_DataVault_PressureLeaksRepair_ConvStarted">
                                  <delay exact="6s"/>
                                  <actions>
                                    <speak actor="$Narrator" priority="100" >
                                      <text line="parent.$TextLine"/>
                                    </speak>
                                  </actions>
                                </cue>

                                <cue name="Scenario2_DataVault_PressureLeaksRepair_ConvEnded">
                                  <conditions>
                                    <event_speak_finished actor="$Narrator"/>
                                    <check_value value="event.param2 == @parent.$TextLine"/>
                                  </conditions>
                                  <actions>
                                    <stop_cutscene cutscene="parent.$CutsceneID"/>
                                  </actions>
                                </cue>
                              </cues>
                            </cue>

                            <cue name="Scenario2_DataVault_PressureLeaks_Repaired">
                              <conditions>
                                <event_cue_signalled/>
                              </conditions>
                              <actions>
                                <set_value name="$VaultRepaired" exact="true"/>
                                <set_objective cue="Scenario2_DataVault_Start" step="5" action="objective.repair" text="{30179,3014}" object="$VaultDataLeak"/>
                              </actions>
                              <cues>

                                <cue name="Scenario2_DataVault_PressureLeaksRepaired_Conv">
                                  <delay exact="1s"/>
                                  <actions>
                                    <play_cutscene key="'ShowCharacterBoron'" targetmonitor="true" caption="{10002,23}" result="this.$CutsceneID">
                                      <param name="npcref" object="$Narrator" />
                                    </play_cutscene>
                                  </actions>
                                  <cues>

                                    <cue name="Scenario2_DataVault_PressureLeaksRepaired_ConvStarted">
                                      <delay exact="1s"/>
                                      <actions>
                                        <speak actor="$Narrator" priority="100" >
                                          <text line="30402019" comment="Ah, you appear to have uncovered some sort of data leak."/>
                                          <text line="30402020" comment="Could you take a closer look?"/>
                                        </speak>
                                      </actions>
                                    </cue>

                                    <cue name="Scenario2_DataVault_PressureLeaksRepaired_ConvEnded">
                                      <conditions>
                                        <event_speak_finished actor="$Narrator" line="30402019"/>
                                      </conditions>
                                      <actions>
                                        <stop_cutscene cutscene="parent.$CutsceneID"/>
                                      </actions>
                                    </cue>
                                  </cues>
                                </cue>

                              </cues>
                            </cue>

                            <cue name="Scenario2_DataVault_DataLeakSelected_Conv">
                              <conditions>
                                <event_player_changed_target target="$VaultDataLeak"/>
                              </conditions>
                              <actions>
                                <play_cutscene key="'ShowCharacterBoron'" targetmonitor="true" caption="{10002,23}" result="this.$CutsceneID">
                                  <param name="npcref" object="$Narrator" />
                                </play_cutscene>
                              </actions>
                              <cues>
                                <cue name="Scenario2_DataVault_DataLeakSelected_ConvStarted">
                                  <delay exact="1s"/>
                                  <actions>
                                    <speak actor="$Narrator" priority="100" >
                                      <text line="30402022" comment="Maybe try using the repair laser."/>
                                    </speak>
                                  </actions>
                                </cue>

                                <cue name="Scenario2_DataVault_DataLeakSelected_ConvEnded">
                                  <conditions>
                                    <event_speak_finished actor="$Narrator" line="30402022"/>
                                  </conditions>
                                  <actions>
                                    <stop_cutscene cutscene="parent.$CutsceneID"/>
                                  </actions>
                                </cue>
                              </cues>
                            </cue>

                            <cue name="Scenario2_DataVault_DataLeak_Repair">
                              <conditions>
                                <check_any>
                                  <event_player_signal_unlock_finished signal="$VaultDataLeak"/>
                                  <event_player_repaired_signal_leak signal="$VaultDataLeak"/>
                                </check_any>
                              </conditions>
                              <actions>
                                <set_value name="$VaultUnlocked" exact="true"/>
                              </actions>
                              <cues>

                                <cue name="Scenario2_DataVault_Mentor">
                                  <delay exact="2s"/>
                                  <actions>
                                    <play_cutscene key="'ShowCharacterBoron'" targetmonitor="true" caption="{10002,23}" result="this.$CutsceneID">
                                      <param name="npcref" object="$Narrator" />
                                    </play_cutscene>
                                  </actions>
                                  <cues>
                                    <cue name="Scenario2_DataVault_Mentor_ConvStarted">
                                      <delay exact="3s"/>
                                      <actions>
                                        <speak actor="$Narrator" priority="100" >
                                          <text line="30402023" comment="You seem to have recovered some long-lost file."/>
                                          <text line="30402024" comment="Ah, a historical article, how fascinating." delay="2s"/>
                                        </speak>
                                      </actions>
                                    </cue>

                                    <cue name="Scenario2_DataVault_Mentor_ConvEnded">
                                      <conditions>
                                        <event_speak_finished actor="$Narrator" line="30402023"/>
                                      </conditions>
                                      <delay exact="1s"/>
                                      <actions>
                                        <update_mission cue="Scenario2_DataVault_Start">
                                          <briefing>
                                            <objective step="6" action="objective.investigate"  text="{30179,3016}" comment="Historic article"/>
                                            <objective step="7" action="objective.custom"       customaction="{30179,3015}" comment="Return to Ship"/>
                                          </briefing>
                                        </update_mission>
                                        <set_objective cue="Scenario2_DataVault_Start" step="6" action="objective.investigate" text="{30179,3016}" comment="Historic article"/>
                                        <stop_cutscene cutscene="parent.$CutsceneID"/>
                                        <signal_cue cue="Scenario2_DataVault_Timeline"/>
                                      </actions>
                                    </cue>

                                    <cue name="Scenario2_DataVault_Timeline">
                                      <conditions>
                                        <event_cue_signalled/>
                                      </conditions>
                                      <actions>
                                        <do_if value="player.input.controller">
                                          <show_help line="934" log="true" position="1" force="true" width="150" comment="Press X to open menus" allowclose="false" timeout="false"/>
                                        </do_if>
                                        <do_else>
                                          <show_help line="5001" log="true" position="1" force="true" width="150" comment="Press $INPUT_ACTION_OPEN_MAP$ to open the MAP menu" allowclose="false" timeout="false"/>
                                        </do_else>
                                        <set_value name="$CutsceneWatched" exact="false"/>
                                      </actions>
                                      <cues>

                                        <cue name="Scenario2_DataVault_MenuOpen">
                                          <conditions>
                                            <check_any>
                                              <event_ui_triggered screen="'DockedMenu'" control="''" comment="gamepad 'X'"/>
                                              <event_ui_triggered screen="'MapMenu'" control="''" comment="keyboard 'M'"/>
                                            </check_any>
                                          </conditions>
                                          <actions>
                                            <remove_help all="934"/>
                                            <remove_help all="5001"/>
                                            <!--show_help_overlay id="'toplevel_encyclopedia'" /-->
                                            <do_if value="player.input.controller">
                                              <show_help line="944" position="15" timeout="false" log="false" width="240" force="true" comment="Select the ENCYCLOPEDIA tab using $INPUT_ACTION_WIDGET_TABSCROLL_LEFT$,$INPUT_ACTION_WIDGET_TABSCROLL_RIGHT$."/>
                                            </do_if>
                                            <do_else>
                                              <show_help line="964" position="15" timeout="false" log="false" width="240" force="true" comment="Select the ENCYCLOPEDIA tab."/>
                                            </do_else>
                                            <show_help_overlay id="'toplevel_encyclopedia'" highlightonly="true" />
                                          </actions>
                                        </cue>

                                        <cue name="Scenario2_DataVault_EncyclopediaOpen">
                                          <conditions>
                                            <event_ui_triggered screen="'EncyclopediaMenu'" control="''" />
                                          </conditions>
                                          <actions>
                                            <remove_help_overlay id="'toplevel_encyclopedia'"/>
                                            <remove_help line="944"/>
                                            <remove_help line="964"/>
                                            <!--show_help_overlay id="'encyclopedia_sidebar_timeline_01'" /-->
                                          </actions>
                                          <delay exact="0.5s"/>
                                          <actions>
                                            <do_if value="player.input.controller">
                                              <show_help line="946" position="15" timeout="false" log="false" width="240" force="true" comment="(gamepad)Select the TIMELINE tab using $INPUT_ACTION_WIDGET_TABSCROLL_UP$,$INPUT_ACTION_WIDGET_TABSCROLL_DOWN$."/>
                                            </do_if>
                                            <do_else>
                                              <show_help line="966" position="15" timeout="false" log="false" width="240" force="true" comment="Select the TIMELINE tab."/>
                                            </do_else>
                                            <show_help_overlay id="'encyclopedia_sidebar_timeline_01'" highlightonly="true" />
                                          </actions>
                                        </cue>

                                        <cue name="Scenario2_DataVault_TimelineOpen">
                                          <conditions>
                                            <event_ui_triggered screen="'TimelineMenu'" control="'timeline'"/>
                                            <check_value value="(event.param3 == null) or (event.param3 and event.param3 == 'on')"/>
                                          </conditions>
                                          <actions>
                                            <remove_help_overlay id="'encyclopedia_sidebar_timeline_01'"/>
                                            <remove_help line="946"/>
                                            <remove_help line="966"/>
                                            <set_value name="$CutsceneWatched" exact="true"/>
                                          </actions>
                                        </cue>

                                        <cue name="Scenario2_DataVault_CutsceneStarted">
                                          <conditions>
                                            <event_cutscene_started key="'timeline_earth_jumpgates'" comment="autostarts when opening timeline"/>
                                          </conditions>
                                          <cues>
                                            <cue name="Scenario2_DataVault_CutsceneStopped">
                                              <conditions>
                                                <event_cutscene_stopped key="'timeline_earth_jumpgates'"/>
                                                <cue_is_waiting cue="Scenario2_DataVault_ReturnToShip"/>
                                              </conditions>
                                              <actions>
                                                <remove_help line="946"/>
                                                <remove_help line="966"/>
                                                <signal_cue cue="Scenario2_DataVault_ReturnToShip"/>
                                              </actions>
                                            </cue>
                                          </cues>
                                        </cue>
                                        
                                        <cue name="Scenario2_DataVault_EncyclopediaClosed">
                                          <conditions>
                                            <check_any>
                                              <event_ui_triggered screen="'EncyclopediaMenu'" control="'menu_close'" />
                                            </check_any>
                                            <cue_is_waiting cue="Scenario2_DataVault_ReturnToShip"/>
                                            <check_value value="$CutsceneWatched == true"/>
                                          </conditions>
                                          <actions>
                                            <signal_cue cue="Scenario2_DataVault_ReturnToShip"/>
                                            <remove_help line="946"/>
                                            <remove_help line="966"/>
                                          </actions>
                                        </cue>
                                       
                                      </cues>
                                    </cue>

                                  </cues>

                                </cue>

                              </cues>
                            </cue>

                            <cue name="Scenario2_DataVault_ReturnToShip">
                              <conditions>
                                <event_cue_signalled comment="Only signalled when $VaultUnlocked = true"/>
                              </conditions>
                              <delay exact="2s"/>
                              <actions>
                                <!--show_help custom="You unlocked a timeline entry"  position="1" force="true" comment=""/-->
                                <set_objective cue="Scenario2_DataVault_Start" step="6" action="objective.custom" customaction="{30179,3015}" object="$VaultShip"/>
                                <set_value name="$RequestedDockingPermission" exact="false"/>
                              </actions>
                              <cues>
                                
                                <cue name="Scenario2_Spacesuit_FarShip" checkinterval="2s">
                                  <conditions>
                                    <check_value value="player.entity.distanceto.{$VaultShip} ge 100m"/>
                                  </conditions>
                                  <actions>
                                    <show_help line="21002" position="1" timeout="false" force="true" comment="Return to your ship"/>
                                    <reset_cue cue="Scenario2_Spacesuit_NearShip"/>
                                  </actions>
                                </cue>

                                <cue name="Scenario2_Spacesuit_NearShip" checkinterval="2s">
                                  <conditions>
                                    <check_value value="player.entity.distanceto.{$VaultShip} lt 100m"/>
                                    <check_value value="not $RequestedDockingPermission"/>
                                  </conditions>
                                  <actions>
                                    <remove_help all="true"/>
                                    <show_help line="7500" position="1" force="true" timeout="false" comment="Target your own ship and request docking permission"/>
                                    <reset_cue cue="Scenario2_Spacesuit_FarShip"/>
                                  </actions>
                                  <cues>

                                    <cue name="Scenario2_DataVault_TargetedShip">
                                      <conditions>
                                        <event_player_changed_target/>
                                        <check_value value="@player.controlled.isclass.spacesuit"/>
                                      </conditions>
                                      <actions>
                                        <do_if  value="event.param and (event.param.isplayerowned)">
                                          <remove_help all="true"/>
                                          <show_help line="7510" position="1" force="true" width="300" timeout="false" comment="Press ... to request docking permission."/>
                                        </do_if>
                                        <reset_cue cue="this"/>
                                      </actions>
                                    </cue>

                                    <cue name="Scenario2_DataVault_DockRequest">
                                      <conditions>
                                        <check_any>
                                          <event_ui_triggered screen="'InteractMenu'" control="'dockrequest'"/>
                                          <event_ui_triggered screen="'DockedMenu'" control="'menu_close'"/>
                                        </check_any>
                                      </conditions>
                                      <actions>
                                        <set_value name="$RequestedDockingPermission" exact="true"/>
                                        <reset_cue cue="this"/>
                                        <remove_help all="true"/>
                                        <show_help line="7520" position="1" force="true" comment="Carefully steer into the XS dock of your ship."/>
                                      </actions>
                                    </cue>

                                  </cues>
                                </cue>

                              </cues>
                            </cue>
          
                          </cues>
                        </cue>

                      </cues>
                    </cue>

                  </cues>
                </cue>
              </cues>
            </cue>



            <cue name="Scenario2_DataVault_Cleanup">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <debug_text text="'Cleanup'" chance="$DebugChance"/>
                <remove_help all="true"/>
                <reset_cue cue="Scenario2_DataVault_StagingArea"/>
              </actions>
            </cue>


          </cues>
        </cue>

        <cue name="Scenario2_Station">
          <actions>
            <create_construction_sequence macros="[macro.prod_gen_smartchips_macro, macro.prod_gen_refinedmetals_macro]" station="$playerstation" base="$playerstation.plannedconstruction.sequence" comment="async calculation"/>
            <!--create_construction_sequence macros="[macro.prod_gen_smartchips_macro, macro.prod_gen_refinedmetals_macro]" station="$playerstation" comment="async calculation"/-->

            <create_position name="$ConstructionPosition" x="159552.266m" y="921.6m" z="-47913.938m"/>


            <create_ship name="$ConstructionShip" macro="ship_arg_s_fighter_02_a_macro" sector="$cluster_40_sector001">
              <owner exact="faction.player" overridenpc="true" />
              <loadout ref="scenario_basic_fighter"/>
              <position x="$ConstructionPosition.x" y="$ConstructionPosition.y" z="$ConstructionPosition.z" />
              <rotation yaw="-144.12456deg" pitch="-23.41868deg" roll="2.75883deg"/>
            </create_ship>

            <!--?xml version="1.0" encoding="utf-8"?><teleport sector="demo_cluster_40_sector001_macro">
              <offset>
                <position x="161162.266" y="2445.6" z="-46767.938"/>
                <rotation yaw="-138.25439" pitch="-12.12172" roll="2.74633"/>
              </offset>
            </teleport-->

          </actions>
          <cues>
            <cue name="Scenario2_Station_Construction">
              <conditions>
                <event_object_construction_sequence_created object="$playerstation" />
              </conditions>
              <actions>
                <set_value name="$ConstructionSequence" exact="event.param" />
                <do_if value="$ConstructionSequence">
                  <set_value name="$BuildTask" exact="null"/>
                  <add_build_to_expand_station object="$playerstation.buildstorage" buildobject="$playerstation" constructionplan="$ConstructionSequence" result="$BuildTask" />
                </do_if>
              </actions>
              <!--cues>
                <cue name="Scenario2_Station_FillStorage">
                  <conditions>
                    <event_cue_completed cue="parent"/>
                  </conditions>
                  <actions>
                    <set_value name="$BuildProcessor" exact="$playerstation.buildstorage.buildprocessor"/>
                    <set_value name="$BuildWares" exact="$BuildProcessor.neededsequenceresources.list"/>
                    <do_all exact="$BuildWares.count" counter="$k">
                      <add_cargo object="$playerstation.buildstorage" ware="$BuildWares.{$k}" exact="$BuildProcessor.neededsequenceresources.{$BuildWares.{$k}}.count"/>
                    </do_all>
                  </actions>
                </cue>
              </cues-->
            </cue>

            <cue name="Scenario2_Station_Selected" instantiate="true">
              <conditions>
                <check_any>
                  <check_all>
                    <event_ui_triggered screen="'MapMenu'" control="'selection_station'"/>
                    <check_value value="component.{event.param3} == $playerstation"/>
                  </check_all>
                  <check_all>
                    <event_ui_triggered screen="'MapMenu'" control="'selection_ship'"/>
                    <check_value value="component.{event.param3} == $ConstructionShip"/>
                  </check_all>
                </check_any>
              </conditions>
              <actions>
                <set_holomap_target object="component.{event.param3}"/>
                <set_holomap_zoom value="20000"/>

                <do_if value="component.{event.param3} == $ConstructionShip">
                  <debug_text text="'Selected construction-station on map'"/>
                  <speak actor="$Narrator"  line="30402010" comment="Your station is part way through expanding."/>
                  <signal_cue cue="Scenario2_Intro_ContextMenu"/>
                </do_if>

              </actions>
              <cues>
                <cue name="Scenario2_Station_Deselected">
                  <conditions>
                    <check_any>
                      <event_ui_triggered screen="'MapMenu'" control="'selection_reset'"/>
                      <check_all>
                        <event_ui_triggered screen="'MapMenu'" control="'selection_station'"/>
                        <check_value value="component.{event.param3} != $playerstation"/>
                      </check_all>
                      <check_all>
                        <event_ui_triggered screen="'MapMenu'" control="'selection_ship'"/>
                        <check_value value="component.{event.param3} != $ConstructionShip"/>
                      </check_all>
                    </check_any>
                  </conditions>
                  <actions>
                    <center_holomap_view zoomtofit="true"/>
                  </actions>
                </cue>
              </cues>
            </cue>

            <cue name="Scenario2_Station_Teleport" instantiate="true">
              <conditions>
                <!--event_object_changed_object object="player.entity" newobject="$playerstation"/-->
                <event_object_changed_object object="player.entity" newobject="$ConstructionShip"/>
                <cue_is_waiting cue="Scenario2_Station_Start"/>
              </conditions>
              <actions>
                <signal_cue cue="Scenario2_Station_Start"/>
              </actions>
            </cue>

            <cue name="Scenario2_Station_Start">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <reset_cue cue="Scenario2_Crystal_Start"/>
                <reset_cue cue="Scenario2_DataVault_Start"/>
                <reset_cue cue="Scenario2_DataVault_StagingArea"/>
                <reset_cue cue="Scenario2_Trading_Start"/>
                <reset_cue cue="Scenario2_Mining_Start"/>
                <reset_cue cue="Scenario2_Boarding_Start"/>
              </actions>
              <cues>

                <cue name="Scenario2_Station_StartMission">
                  <actions>
                    <create_mission cue="Scenario2_Station_Start" type="missiontype.tutorial" name="{30179,4001}" description="{30179,4002}" difficulty="level.easy" faction="faction.argon" abortable="false">
                      <briefing>
                        <objective step="1" action="objective.custom"        customaction="{30179,4020}"  comment="Sit down"/>
                        <objective step="2" action="objective.build_station"  text="{30179,4021}"         comment="Plan Build"/>
                        <objective step="3" action="objective.wait"           text="{30179,4022}"         comment="Observe Construction"/>
                      </briefing>
                    </create_mission>
                    <set_objective cue="Scenario2_Station_Start" step="1" action="objective.custom" customaction="{30179,4020}"/>
                  </actions>
                </cue>

                <cue name="Scenario2_Station_FillStorage">
                  <actions>
                    <!-- fill buildstorage with needed wares -->
                    <debug_text text="'filling storage'"/>
                    <set_value name="$BuildProcessor" exact="$playerstation.buildstorage.buildprocessor"/>
                    <set_value name="$BuildWares" exact="$BuildProcessor.neededsequenceresources.list"/>
                    <do_all exact="$BuildWares.count" counter="$k">
                      <debug_text text="'- ' + $BuildWares.{$k}.name + ' amount=' + $BuildProcessor.neededsequenceresources.{$BuildWares.{$k}}.count"/>
                      <add_cargo object="$playerstation.buildstorage" ware="$BuildWares.{$k}" exact="$BuildProcessor.neededsequenceresources.{$BuildWares.{$k}}.count"/>
                    </do_all>
                  </actions>
                </cue>

                <cue name="Scenario2_Station_Standing" checkinterval="2s">
                  <conditions>
                    <check_value value="(player.ship) and not (player.occupiedship)"/>
                    <check_value value="not player.isinfullscreenmenu" comment="not while map is open"/>
                  </conditions>
                  <actions>
                    <reset_cue cue="Scenario2_Station_Sitting"/>
                    <remove_help line="24010"/>
                    <show_help line="1040" position="15" timeout="false" log="true" width="256" force="true" comment="To sit down in your chair click on it or press $INPUT_STATE_INTERACTION_MENU$ to interact."/>
                  </actions>
                </cue>

                <cue name="Scenario2_Station_Sitting" checkinterval="2s">
                  <conditions>
                    <check_value value="(player.ship) and (player.occupiedship)"/>
                    <check_value value="not player.isinfullscreenmenu" comment="not while map is open"/>
                  </conditions>
                  <actions>
                    <remove_help all="true"/>
                    <reset_cue cue="Scenario2_Station_Standing"/>
                    <signal_cue cue="Scenario2_Station_ApproachConv"/>
                    <remove_help line="1040"/>
                  </actions>
                </cue>

                <cue name="Scenario2_Station_ApproachConv">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <delay exact="2s"/>
                  <actions>
                    <play_cutscene key="'ShowCharacterBoron'" targetmonitor="true" caption="{10002,23}" result="this.$CutsceneID">
                      <param name="npcref" object="$Narrator" />
                    </play_cutscene>
                  </actions>
                  <cues>
                    <cue name="Scenario2_Station_Approach_Speak">
                      <delay exact="3s"/>
                      <actions>

                        <find_object_component name="$Module" object="$playerstation" class="class.module" state="componentstate.construction" multiple="false"/>
                        <do_if value="$Module.macro == macro.prod_gen_smartchips_macro">
                          <speak actor="$Narrator" priority="100" >
                            <text line="30402061" comment="Your station is making good progress in constructing the new Smart Chips production."/>
                            <text line="30402063" comment="Here you can see the many building drones at work."/>
                            <text line="30402064" comment="You are able to view and edit the station design at any time."/>
                          </speak>
                        </do_if>
                        <do_elseif value="$Module.macro == macro.prod_gen_refinedmetals_macro">
                          <speak actor="$Narrator" priority="100" >
                            <text line="30402062" comment="Your station is making good progress in constructing the new Refined Metal production."/>
                            <text line="30402063" comment="Here you can see the many building drones at work."/>
                            <text line="30402064" comment="You are able to view and edit the station design at any time."/>
                          </speak>
                        </do_elseif>

                      </actions>
                    </cue>

                    <cue name="Scenario2_Station_Approach_ConvEnded">
                      <conditions>
                        <check_any>
                          <event_speak_finished actor="$Narrator" line="30402061"/>
                          <event_speak_finished actor="$Narrator" line="30402062"/>
                        </check_any>
                      </conditions>
                      <actions>
                        <stop_cutscene cutscene="parent.$CutsceneID"/>
                        <show_help line="24021" position="15" timeout="false" log="false" width="180" force="true" comment="Select the station with left click, then ... "/>

                        <find_object_component name="$Module" object="$playerstation" class="class.module" state="componentstate.construction"/>
                        <create_position name="$ModuleOffset" space="$playerstation" object="$Module"/>
                        <set_objective cue="Scenario2_Station_Start" step="2" action="objective.build_station" text="{30179,4021}" comment="Plan Build" object="$playerstation" offset="$ModuleOffset" />
                        <!--set_objective cue="Scenario2_Station_Start" step="2" action="objective.build_station" text="{30179,4021}" comment="Plan Build" object="$playerstation" offset="position.[1000,1,1]" /-->
                        <show_help_overlay id="'interactmenu_configurestation'" highlightonly="true"/>
                      </actions>
                      <cues>
                          
                        <cue name="Scenario2_Station_Approach_Done">
                          <conditions>
                            <event_ui_triggered screen="'StationConfigurationMenu'" control="''"/>
                          </conditions>
                          <actions>
                            <remove_help_overlay id="'interactmenu_configurestation'"/>
                            <remove_help line="24021"/>
                          </actions>
                        </cue>
                      </cues>
                    </cue>

                  </cues>
                </cue>

                <cue name="Scenario2_Station_PlanBuild">
                  <conditions>
                    <event_ui_triggered screen="'StationConfigurationMenu'" control="''"/>
                  </conditions>
                  <delay exact="2s"/>
                  <actions>
                    <remove_help line="24021"/>
                    <play_cutscene key="'ShowCharacterBoron'" targetmonitor="true" caption="{10002,23}" result="this.$CutsceneID">
                      <param name="npcref" object="$Narrator" />
                    </play_cutscene>

                    <show_help line="5145" position="1" duration="10s" log="false" width="256" force="true" comment="$INPUT_STATE_MAP_PAN_LEFT$, ... for PANNING, ..."/>

                  </actions>
                  <cues>
                    <cue name="Scenario2_Station_PlanBuild_Speak">
                      <delay exact="1s"/>
                      <actions>
                        <speak actor="$Narrator" priority="100" >
                          <text line="30402065" comment="Over time, you can acquire new blueprints for station modules."/>
                          <text line="30402066" comment="If you have the resources, you can design and construct vast production complexes or deadly defence stations."/>
                        </speak>
                      </actions>
                    </cue>

                    <cue name="Scenario2_Station_PlanBuild_ConvEnded">
                      <conditions>
                        <event_speak_finished actor="$Narrator" line="30402065"/>
                      </conditions>
                      <actions>
                        <stop_cutscene cutscene="parent.$CutsceneID"/>
                        </actions>
                      <delay exact="0.5s"/>
                      <actions>
                        <show_help line="24030" position="15" timeout="false"  log="false" width="256" force="true" comment="Leave the plan build menu by clicking 'CANCEL MODULE CHANGES'."/>
                        <show_help_overlay id="'cancel_modulechanges'" highlightonly="true"/>
                        <find_object_component name="$Module" object="$playerstation" class="class.module" state="componentstate.construction"/>
                        <create_position name="$ModuleOffset" space="$playerstation" object="$Module"/>
                        <set_objective cue="Scenario2_Station_Start" step="2" action="objective.build_station" text="{30179,4021}" comment="Plan Build" object="$playerstation" offset="$ModuleOffset" />
                        <!--set_objective cue="Scenario2_Station_Start" step="2" action="objective.build_station" text="{30179,4021}" comment="Plan Build" object="$playerstation" offset="position.[1000,1,1]" /-->
                      </actions>
                    </cue>

                  </cues>
                </cue>

                <cue name="Scenario2_Station_PlanBuild_Done">
                  <conditions>
                    <event_ui_triggered screen="'StationConfigurationMenu'" control="'menu_close'"/>
                  </conditions>
                  <actions>
                    <remove_help line="24030"/>
                    <remove_help_overlay id="'cancel_modulechanges'"/>
                  </actions>
                  <cues>

                    <cue name="Scenario2_Station_SETA_Conv">
                      <delay exact="2s"/>
                      <actions>
                        <play_cutscene key="'ShowCharacterBoron'" targetmonitor="true" caption="{10002,23}" result="this.$CutsceneID">
                          <param name="npcref" object="$Narrator" />
                        </play_cutscene>
                      </actions>
                      <cues>

                        <cue name="Scenario2_Station_SETA_Speak">
                          <delay exact="4s"/>
                          <actions>
                            <speak actor="$Narrator" priority="100" >
                              <text line="30402067" comment="Expanding a station can take a while, but you are equipped with a Singularity Engine Time Accelerator."/>
                              <text line="30402068" comment="SETA is a device which compresses your own bubble of space time; allowing you to watch the universe speed by."/>
                            </speak>
                          </actions>
                        </cue>

                        <cue name="Scenario2_Station_SETA_ConvEnded">
                          <conditions>
                            <event_speak_finished actor="$Narrator" line="30402067"/>
                          </conditions>
                          <actions>
                            <stop_cutscene cutscene="parent.$CutsceneID"/>
                            <show_help line="24010" position="15" timeout="false" log="true" width="256" force="true" comment="Press $INPUT_ACTION_TOGGLE_SETA_MODE$ to activate SETA."/>
                          </actions>
                        </cue>

                      </cues>
                    </cue>

                  </cues>
                </cue>

                <cue name="Scenario2_Station_SETA_enabled" instantiate="true">
                  <conditions>
                    <event_player_changed_activity />
                    <check_value value="event.param == activity.seta"/>
                  </conditions>
                  <actions>
                    <set_objective cue="Scenario2_Station_Start" step="2" action="objective.wait" text="{30179,4022}" comment="Observe Construction" object="$playerstation" />
                    <remove_help line="24010"/>
                    <signal_cue cue="Scenario2_Station_Done"/>
                  </actions>
                </cue>

                <cue name="Scenario2_Station_Done">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                  </actions>
                  <cues>

                    <cue name="Scenario2_Station_SETA_hint" onfail="cancel">
                      <delay exact="120s"/>
                      <actions>
                        <show_help line="24011" position="15" timeout="false" log="false" width="256" force="true" comment="Press $INPUT_ACTION_TOGGLE_SETA_MODE$ to deactivate SETA."/>
                      </actions>
                    </cue>

                    <cue name="Scenario2_Station_SETA_disabled">
                      <conditions>
                        <event_player_changed_activity/>
                        <check_value value="event.param2 == activity.seta" comment="previous activity was seta"/>
                      </conditions>
                      <actions>
                        <remove_help line="24011"/>
                      </actions>
                      <cues>

                        <cue name="Scenario2_Station_ExternalView">
                          <delay exact="1s"/>
                          <actions>
                            <show_help line="24050" position="15" duration="10s" width="256" force="true" comment="You can select the station and observe it with $INPUT_ACTION_EXTERNAL_VIEW$."/>
                          </actions>
                        </cue>

                        <cue name="Scenario2_Station_Done_Conv">
                          <delay exact="15s"/>
                          <actions>
                            <play_cutscene key="'ShowCharacterBoron'" targetmonitor="true" caption="{10002,23}" result="this.$CutsceneID">
                              <param name="npcref" object="$Narrator" />
                            </play_cutscene>
                          </actions>
                          <cues>
                            <cue name="Scenario2_Station_Done_Speak">
                              <delay exact="16s"/>
                              <actions>
                                <speak actor="$Narrator" priority="100" >
                                  <text line="30402069" comment="Let us leave the construction vessel to continue it's task."/>
                                  <text line="30402026" comment="Do you wish to visit another location?"/>
                                </speak>
                              </actions>
                            </cue>

                            <cue name="Scenario2_Station_Done_ConvEnded">
                              <conditions>
                                <event_speak_finished actor="$Narrator" line="30402069"/>
                              </conditions>
                              <actions>
                                <stop_cutscene cutscene="parent.$CutsceneID"/>
                              </actions>
                              <cues>
                                <cue name="Scenario2_Station_Done_MapHint">
                                  <delay exact="2s"/>
                                  <actions>
                                    <do_if value="player.input.controller">
                                      <show_help line="950"  position="15" duration="10s" width="256" force="true" comment="Press $INPUT_ACTION_OPTIONSMENU$ and select the map using $INPUT_ACTION_WIDGET_TABSCROLL_LEFT$,$INPUT_ACTION_WIDGET_TABSCROLL_RIGHT$." />
                                    </do_if>
                                    <do_else>
                                      <show_help line="20140" position="15" duration="10s" width="256" force="true" comment="Press $INPUT_ACTION_OPEN_MAP$ to open the MAP menu and try other scenarios."/>
                                    </do_else>
                                  </actions>
                                </cue>
                              </cues>
                            </cue>
                          </cues>
                        </cue>

                        <cue name="Scenario2_Station_Mission_Done">
                          <delay exact="20s"/>
                          <actions>
                            <remove_help all="true"/>
                            <remove_mission cue="Scenario2_Station_Start" type="completed" />
                          </actions>
                        </cue>

                      </cues>
                    </cue>

                  </cues>
                </cue>

                <cue name="Scenario2_Station_ComponentComplete" instantiate="true">
                  <conditions>
                    <event_player_build_finished_components/>
                    <check_value value="event.param.buildanchor == $playerstation"/>
                  </conditions>
                  <actions>
                    <debug_text text="'stationcomponent complete: module=' + event.param.name + ' Station=' + $Station.name" chance="$DebugChance"/>
                    <do_all exact="event.param2.count" counter="$i">
                      <do_if value="event.param2.{$i}.macro == macro.prod_gen_smartchips_macro">
                        <signal_cue cue="Scenario2_Station_ComponentComplete_SmartChips_Speak"/>
                        <break/>
                      </do_if>
                      <do_elseif value="event.param2.{$i}.macro == macro.prod_gen_refinedmetals_macro">
                        <signal_cue cue="Scenario2_Station_ComponentComplete_RefinedMetals_Speak"/>
                        <break/>
                      </do_elseif>
                      <do_else>
                        <debug_text text="'Unhandled: ' + event.param2.{$i}.macro"/>
                      </do_else>
                    </do_all>
                  </actions>
                  <cues>
                    <cue name="Scenario2_Station_ComponentComplete_SmartChips_Speak">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <speak actor="$Narrator" priority="100" >
                          <text line="30402071" comment="The construction vessel has completed work on the module."/>
                          <text line="30402072" comment="Your station can now produce Smart Chips."/>
                        </speak>
                      </actions>
                      <cues>
                        <cue name="Scenario2_Station_ComponentComplete_SmartChips_ConvEnded">
                          <conditions>
                            <event_speak_finished actor="$Narrator" line="30402071"/>
                          </conditions>
                          <actions>
                            <stop_cutscene cutscene="$CutsceneID"/>
                          </actions>
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Scenario2_Station_ComponentComplete_RefinedMetals_Speak">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <speak actor="$Narrator" priority="100" >
                          <text line="30402071" comment="The construction vessel has completed work on the module."/>
                          <text line="30402073" comment="Your station can now produce Refined Metals."/>
                        </speak>
                      </actions>
                      <cues>
                        <cue name="Scenario2_Station_ComponentComplete_RefinedMetal_ConvEnded">
                          <conditions>
                            <event_speak_finished actor="$Narrator" line="30402071"/>
                          </conditions>
                          <actions>
                            <stop_cutscene cutscene="$CutsceneID"/>
                          </actions>
                        </cue>
                      </cues>
                    </cue>


                  </cues>
                </cue>

                <cue name="Scenario2_Station_ConstructionComplete">
                  <conditions>
                    <event_player_build_finished />
                    <check_value value="event.param.buildanchor == $playerstation"/>
                  </conditions>
                  <actions>
                    <debug_text text="'construction complete'"/>
                  </actions>
                </cue>

              </cues>
            </cue>

          </cues>
        </cue>


        <cue name="Scenario2_CapShip">
          <actions>
          </actions>
          <cues>
            <cue name="Scenario3_CapShip_Setup">
              <actions>
              </actions>
            </cue>
          </cues>
        </cue>
        
        <cue name="Scenario2_Boarding" onfail="cancel">
          <conditions>
            <check_value value="false" comment="TODO: Boarding"/>
          </conditions>
          <actions>
          </actions>
          <cues>
            <cue name="Scenario2_Boarding_Selected" instantiate="true">
              <conditions>
                <event_ui_triggered screen="'MapMenu'" control="'selection_ship'"/>
              </conditions>
              <actions>
                <set_value name="$SelectedShip" exact="component.{event.param3} "/>
                <do_if value="$BoardingShip == $SelectedShip">
                  <debug_text text="'Selected boarding-ship on map'"/>
                  <speak actor="$Narrator"  line="30402007" comment="This ship is mining in an asteroid field"/>
                  <signal_cue cue="Scenario2_Boarding_Start"/>
                  <break/>
                </do_if>
              </actions>
            </cue>

            <cue name="Scenario2_Boarding_Start">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <delay exact="5s"/>
              <actions>
                <reset_cue cue="Scenario2_Station_Start"/>
                <reset_cue cue="Scenario2_Crystal_Start"/>
                <reset_cue cue="Scenario2_Trading_Start"/>
                <reset_cue cue="Scenario2_Mining_Start"/>

                <play_cutscene key="'ShowCharacterBoron'" targetmonitor="true" caption="{10002,23}" result="this.$CutsceneID">
                  <param name="npcref" object="$Narrator" />
                </play_cutscene>

              </actions>
              <cues>

                <cue name="Scenario2_Boarding_Speak">
                  <delay exact="6s"/>
                  <actions>
                    <speak actor="$Narrator" priority="100" >
                      <text line="30402014" comment="This may well be an abandoned listening post."/>
                    </speak>
                  </actions>
                </cue>

                <cue name="Scenario2_Boarding_ConvEnded">
                  <conditions>
                    <event_speak_finished actor="$Narrator" line="30402014"/>
                    <!-- 
                    <t id="15001">Boarding is the method of taking over control of massive capital ships.</t>
                    <t id="15002">While smaller ships can be CAPTURED.</t>
                    <t id="15003">To board a target, you need MARINES.</t>
                    <t id="15034">Marines with high skills are very effective in boarding.</t>
                    -->
                  </conditions>
                  <actions>
                    <stop_cutscene cutscene="parent.$CutsceneID"/>
                  </actions>
                  <cues>
                    <cue name="Scenario2_Boarding_StartMission">
                      <actions>
                        <create_mission cue="Scenario2_Boarding_Start" type="missiontype.tutorial" name="{30179,7001}" description="{30179,7002}" difficulty="level.easy" faction="faction.argon" abortable="false">
                          <briefing>
                            <objective step="1" action="objective.flyto" text="{30179,7020}" object="$BoardedShip" comment="..."/>
                            <objective step="2" action="objective.scan" text="{30179,7020}" object="$BoardedShip" comment="..."/>
                          </briefing>
                        </create_mission>
                      </actions>
                      <cues>

                        <cue name="Scenario2_Boarding_Failed">
                          <conditions>
                            <event_object_destroyed object="$BoardedShip"/>
                          </conditions>
                          <actions>
                            <!-- TODO: Mission failed!-->
                          </actions>
                        </cue>
                        
                        <cue name="Scenario2_Boarding_Approach" checkinterval="2s" instantiate="true">
                          <actions>
                            <set_value name="$BoardingDistanceOld" exact="if $BoardingDistance? then $BoardingDistance else null"/>
                            <set_value name="$BoardingDistance" exact="player.entity.distanceto.{$BoardedShip}"/>
                            <!--debug_text text="'olddist=' + $BoardingDistanceOld + ' dist=' + $BoardingDistance"/-->
                            <do_if value="($BoardingDistanceOld == null or $BoardingDistanceOld gt 1000) and  $BoardingDistance le 1000">
                              <debug_text text="'GO SCAN'"/>
                              <signal_cue cue="Scenario2_Boarding_Scan"/>
                            </do_if>
                            <do_elseif value="($BoardingDistanceOld == null or $BoardingDistanceOld le 1000) and $BoardingDistance ge 1000">
                              <set_objective cue="Scenario2_Boarding_Start" step="1" action="objective.flyto" text="{30179,7020}" object="$BoardedShip" />
                              <remove_help all="true"/>
                              <debug_text text="'RESET SCAN'"/>
                              <reset_cue cue="Scenario2_Boarding_Scan"/>
                            </do_elseif>
                          </actions>
                        </cue>
                        
                        <cue name="Scenario2_Boarding_Scan">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <cues>
                            <cue name="Scenario2_Boarding_AutoRefresh">
                              <actions>
                                <signal_cue cue="Scenario2_Boarding_PrepareScan"/>
                              </actions>
                            </cue>
                              
                            <cue name="Scenario2_Boarding_ChangedTarget" instantiate="true">
                              <conditions>
                                <event_player_changed_target/>
                              </conditions>
                              <actions>
                                <signal_cue cue="Scenario2_Boarding_PrepareScan"/>
                              </actions>
                            </cue>
                        
                            <cue name="Scenario2_Boarding_ScanActivated" instantiate="true">
                              <conditions>
                                <check_any>
                                  <event_player_changed_activity activity="activity.scan" />
                                  <event_player_changed_activity oldactivity="activity.scan" />
                                </check_any>
                              </conditions>
                              <actions>
                                <signal_cue cue="Scenario2_Boarding_PrepareScan"/>
                              </actions>
                            </cue>                        
                        
                            <cue name="Scenario2_Boarding_PrepareScan" instantiate="true">
                              <conditions>
                                <event_cue_signalled/>
                              </conditions>
                              <actions>
                                
                                <!--do_if value="$PrepareScanMode != $PrepareScanModeOld"-->
                                <do_if value="not $PrepareScanMode?">
                                  <set_objective cue="Scenario2_Boarding_Start" step="2" action="objective.scan" text="{30179,7020}" object="$BoardedShip" />
                                </do_if>
                                
                                <debug_text text="'oldscan=' + $PrepareScanModeOld + ' scan=' + (if $PrepareScanMode? then $PrepareScanMode else 0) + ' player.activity=' + player.activity + ' player.target=' + player.target"/>
                                
                                <!-- $PrepareScanModeOld is basically for checking if it's already in that state (and if so, ignore it) -->
                                <set_value name="$PrepareScanModeOld" exact="if $PrepareScanMode? then $PrepareScanMode else 0"/>
                            
                                <do_if value="player.activity != activity.scan">
                                  <debug_text text="'Not scanning'"/>
                                </do_if>
                                <do_if value="$PrepareScanModeOld != 1">
                                  <debug_text text="'Not 1'"/>
                                </do_if>
                                <do_if value="player.activity != activity.scan and $PrepareScanModeOld != 1">
                                  <debug_text text="'@1'"/>
                                  <remove_help all="true"/>
                                  <do_if value="player.input.controller">
                                    <show_help line="14106" position="13" width="256" force="true" timeout="false" comment="Activate SCAN MODE from the SHIP MENU \($INPUT_ACTION_OPEN_COCKPIT_MENU$\)."/>
                                  </do_if>
                                  <do_else>
                                    <show_help line="14101" position="13" width="256" force="true" timeout="false" comment="Press $INPUT_ACTION_TOGGLE_SCAN_MODE$ to activate SCAN MODE."/>
                                  </do_else>
                                  <set_value name="$PrepareScanMode" exact="1"/>
                                </do_if>
                                <do_elseif value="player.target != $BoardedShip  and $PrepareScanModeOld != 2">
                                  <debug_text text="'@2'"/>
                                  <remove_help all="true"/>
                                  <do_if value="player.input.controller">
                                    <show_help line="15521" position="13" force="true" width="300" timeout="false" comment="Select the ship by using $INPUT_STATE_WIDGET_SELECT$."/>
                                  </do_if>
                                  <do_else>
                                    <show_help line="15520" position="13" force="true" width="300" timeout="false" comment="Select the ship by left clicking with the mouse."/>
                                  </do_else>
                                  <set_value name="$BoardingState" exact="2"/>
                                  <set_value name="$PrepareScanMode" exact="2"/>
                                </do_elseif>
                                <do_elseif value="(player.activity == activity.scan) and (player.target == $BoardedShip) and $PrepareScanModeOld != 3">
                                  <debug_text text="'@3'"/>
                                  <remove_help all="true"/>
                                  <do_if value="player.input.controller">
                                    <show_help line="15531" position="13" force="true" width="300" timeout="false" comment="Press $INPUT_ACTION_OPEN_COCKPIT_MENU$ and select SCAN from the context menu."/>
                                  </do_if>
                                  <do_else>
                                    <show_help line="15530" position="13" force="true" width="300" timeout="false" comment="Right-click and select SCAN from the context menu."/>
                                  </do_else>
                                  <set_value name="$PrepareScanMode" exact="3"/>
                                </do_elseif>
                       
                              </actions>
                            </cue>

                            <cue name="Scenario2_Boarding_Scan_Aborted" instantiate="true">
                              <conditions>
                                <event_scan_aborted scanned="$BoardedShip"/>
                              </conditions>
                              <actions>
                                <remove_help all="true"/>
                                <debug_text text="''"/>
                                <show_help line="15150" position="13" force="true" width="300" duration="7s" comment=""/>
                              </actions>
                            </cue>                            
                            
                            <cue name="Scenario2_Boarding_Scan_Finished">
                              <conditions>
                                <event_scan_finished scanned="$BoardedShip"/>
                              </conditions>
                              <actions>
                                <remove_help all="true"/>
                                <debug_text text="'Scan Finished'"/>
                                <signal_cue cue="Scenario2_Boarding_Marines"/>
                                <cancel_cue cue="Scenario2_Boarding_Approach"/>
                                <cancel_cue cue="Scenario2_Boarding_Scan"/>
                              </actions>
                            </cue>

                          </cues>
                        </cue>
                        
                        <cue name="Scenario2_Boarding_Marines">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <actions>
                            <debug_text text="'bla'"/>
                          </actions>
                        </cue>
                
                      </cues>
                    </cue>
                  </cues>
                </cue>
              </cues>
            </cue>
          </cues>
        </cue>

      </cues>
    </cue>

    <cue name="Scenario2_Demo_Timeouts" onfail="cancel">
      <conditions>
        <check_value value="@userdata.demo2_timeout"/>
      </conditions>
      <cues>

        <cue name="Scenario2_Timer_1_minute_warning">
          <delay exact="@userdata.demo2_timeout * 1min - 1min"/>
          <actions>
            <show_notification text="'1 minute remaining'" timeout="3s" />
            <speak actor="player.computer" line="707" comment="This demo will time out in T minus one minute"/>
          </actions>
        </cue>

        <cue name="Scenario2_Timer_gameover">
          <delay exact="@userdata.demo2_timeout * 1min"/>
          <actions>
            <quit_gameover/>
          </actions>
        </cue>
      </cues>
    </cue>

  </cues>

</mdscript>