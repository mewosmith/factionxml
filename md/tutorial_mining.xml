<?xml version="1.0" encoding="utf-8"?>
<mdscript name="Tutorial_mining" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="md.xsd">
  <cues>
    <cue name="Start" namespace="this">
      <conditions>
        <event_cue_signalled cue="md.Setup.Start" />
      </conditions>
      <actions>
        <do_if value="not md.$TutorialRegister?">
          <set_value name="md.$TutorialRegister" exact="[]" />
        </do_if>
        <append_to_list name="md.$TutorialRegister" exact="Start" />
      </actions>
      <cues>
        <cue name="PlayerDied">
          <conditions>
            <event_object_destroyed object="player.entity" />
          </conditions>
          <actions>
            <cancel_cue cue="Start" />
          </actions>
        </cue>

        <cue name="Trigger" checkinterval="5s" version="2">
          <conditions>
            <check_value value="not md.$SurpressTutorials?" />
            <check_value value="player.computer" />
          </conditions>
          <actions>
            <set_value name="$DebugChance" exact="0"/>
            <set_value name="$MissionName" exact="'16) ' + readtext.{30184}.{1}" />
            <set_value name="$Guide" exact="player.computer" />
            <create_offer cue="Start" actor="$Guide" name="$MissionName" description="readtext.{30184}.{2}" difficulty="level.trivial" faction="faction.player" type="missiontype.tutorial">
              <briefing>
                <objective step="1" action="objective.custom" customaction="{30184,20}"/>
                <objective step="2" action="objective.custom" customaction="{30184,21}"/>
                <objective step="3" action="objective.custom" customaction="{30184,22}"/>
              </briefing>
            </create_offer>
          </actions>
          <patch sinceversion="2">
            <do_if value="Start.hasmissionoffer">
              <set_value name="$MissionName" exact="'16) ' + readtext.{30184}.{1}" />
              <update_offer cue="Start" name="$MissionName"/>
            </do_if>
          </patch>
          <cues>
            <cue name="Offer">
              <cues>
                <cue name="ConversationStarted" instantiate="true">
                  <conditions>
                    <event_conversation_started actor="$Guide" conversation="mission" convparam="Start" />
                  </conditions>
                  <actions>
                    <remove_help all="true" />
                    <open_conversation_menu menu="MissionBriefingMenu" param="[0, 0, Start, true]" />
                  </actions>
                  <cues>
                    <cue name="ConversationNextSection" instantiate="true">
                      <conditions>
                        <event_conversation_next_section actor="$Guide" choiceparam="Start" />
                      </conditions>
                      <actions>
                        <!-- Accept case -->
                        <do_if value="event.param == 'c_mission_accept'">
                          <signal_cue cue="Tutorial" />
                        </do_if>
                      </actions>
                    </cue>

                    <cue name="ConversationFinished">
                      <conditions>
                        <event_conversation_finished actor="$Guide" />
                      </conditions>
                      <actions>
                        <cancel_cue cue="ConversationStarted" />
                      </actions>
                    </cue>

                    <cue name="AcceptMission">
                      <conditions>
                        <event_object_signalled object="$Guide" param="'accept'" />
                      </conditions>
                      <actions>
                        <signal_cue cue="Tutorial" />
                      </actions>
                    </cue>
                  </cues>
                </cue>
              </cues>
            </cue>

            <cue name="Tutorial_DebugSolidShip" instantiate="true">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <!-- create mining ship -->
                <create_ship name="$object" macro="ship_arg_l_miner_solid_01_b_macro" zone="player.zone" comment="max loadout for mining-laser">
                  <pilot>
                    <select faction="faction.argon" tags="[tag.commander]"/>
                  </pilot>
                  <loadout>
                    <level exact="1.0"/>
                  </loadout>
                  <owner exact="faction.player" />
                  <units>
                    <unit category="unitcategory.repair" exact="5"/>
                  </units>
                  <safepos object="player.occupiedship" min="1250m"/>
                </create_ship>

                <add_ammo object="$object" macro="macro.eq_arg_resourceprobe_01_macro" amount="10"/>

                <!-- add to player squad / subordinates -->
                <do_if value="player.ship and $object">
                  <set_object_commander object="$object" commander="player.ship"/>
                </do_if>

              </actions>
            </cue>

            <cue name="Tutorial">
              <conditions>
                <check_any>
                  <event_cue_signalled />
                  <event_object_signalled object="player.entity" param="'start'" param2="Start" />
                </check_any>
              </conditions>
              <actions>
                <debug_text text="'Tutorial can begin'" chance="$DebugChance" />
                <cancel_cue cue="Offer" />
                <signal_cue_instantly cue="md.Tutorials.NewTutorialTriggered" param="Start" />
                <set_value name="$TutorialStartTime" exact="player.age" />
                <create_mission cue="Start" offercue="Start" />
                <cancel_conversation actor="$Guide" />
                <remove_offer cue="Start" />
                <remove_help all="true" />
                <set_value name="$StartDelay" exact="2s"/>

                <!-- setup for this tutorial -->

                <!--find_ship name="$TargetShips" class="class.ship_l" space="player.cluster" owner="faction.player" multiple="true">
                    </find_ship>
                    <do_all exact="$TargetShips" comment="$i">
                      <do_if value="$TargetShips.{$i}.commander == player.ship" />
                    </do_all-->

                <find_closest_resource refobject="player.ship" sector="$ResourceSector" ware="[ware.ore, ware.silicon]" position="$ResourcePos" distance="$ResourceDist">
                  <refposition object="player.ship"/>
                </find_closest_resource>

                <set_value name="$HasMiningWeapons" exact="false"/>
                <set_value name="$HasSolidCapacity" exact="false"/>
                <set_value name="$HasResourceProbe" exact="player.ship.ammostorage.{deployablecategory.resourceprobe}.count"/>

                <do_if value="player.ship">
                  <!-- check if playership has solid-capacity and/or mining-lasers -->
                  <do_if value="player.ship.waretransport.indexof.{waretransport.solid}">
                    <set_value name="$HasSolidCapacity" exact="true"/>
                  </do_if>

                  <!-- check if playership has solid-capacity and/or mining-lasers -->
                  <find_object_component groupname="$MiningWeapons" object="player.ship" weapontype="mining"/>
                  <do_if value="$MiningWeapons.count">
                    <set_value name="$HasMiningWeapons" exact="true"/>
                  </do_if>
                  <!-- check if one of the subordinates has solid-capacity and/or mining-lasers -->
                  <!--do_if value="player.ship.subordinates and player.ship.subordinates.count gt 0">
                    <do_all exact="player.ship.subordinates.count" counter="$subi">
                      <set_value name="$subord" exact="player.ship.subordinates.{$subi}"/>
                      <do_if value="not $HasMiningWeapons">
                        <find_object_component groupname="$MiningWeapons" object="$subord" weapontype="mining"/>
                        <do_if value="$MiningWeapons.count">
                          <set_value name="$HasMiningWeapons" exact="true"/>
                        </do_if>
                      </do_if>                    
                      <do_if value="not $HasSolidCapacity">
                        <do_if value="$subord.waretransport.indexof.{waretransport.solid}">
                          <set_value name="$HasSolidCapacity" exact="true"/>
                        </do_if>
                      </do_if>                  
                    </do_all>
                  </do_if-->
                </do_if>

                <!--debug_text text="'$ResourceDist' + $ResourceDist"/-->

                <do_if value="false and not $HasSolidCapacity">
                  <!--show_help line="1024" duration="10s" position="1" force="true" comment="For this tutorial your own ship or one ship in your squad must have SOLID STORAGE." /-->
                  <show_help line="14004" position="1" duration="10s" force="true" comment="To continue this tutorial your ship must have SOLID STORAGE."/>
                  <show_notification text="{1015,400}" sound="notification_warning" comment="Tutorial aborted"/>
                  <remove_mission cue="Start" type="aborted" />
                  <signal_cue cue="Cleanup" />
                </do_if>
                <do_elseif value="not $HasMiningWeapons and not $HasResourceProbe">
                  <show_help line="14005" duration="10s" position="1" force="true" comment="This tutorial requires a MINING LASER and a RESOURCE PROBE." />
                  <show_notification text="{1015,400}" sound="notification_warning" comment="Tutorial aborted"/>
                  <remove_mission cue="Start" type="aborted" />
                  <signal_cue cue="Cleanup" />
                </do_elseif>
                <do_elseif value="not $HasMiningWeapons">
                  <show_help line="14005" duration="10s" position="1" force="true" comment="This tutorial requires a MINING LASER." />
                  <show_notification text="{1015,400}" sound="notification_warning" comment="Tutorial aborted"/>
                  <remove_mission cue="Start" type="aborted" />
                  <signal_cue cue="Cleanup" />
                </do_elseif>
                <do_elseif value="not $HasResourceProbe">
                  <show_help line="14007" duration="10s" position="1" force="true" comment="This tutorial requires a RESOURCE PROBE." />
                  <show_notification text="{1015,400}" sound="notification_warning" comment="Tutorial aborted"/>
                  <remove_mission cue="Start" type="aborted" />
                  <signal_cue cue="Cleanup" />
                </do_elseif>
                <do_elseif value="$ResourceDist and $ResourceDist gt 100km">
                  <show_help line="1025" duration="10s" position="1" force="true" comment="This tutorial requires you to be near an asteroid field." />
                  <show_notification text="{1015,400}" sound="notification_warning" comment="Tutorial aborted"/>
                  <remove_mission cue="Start" type="aborted" />
                  <signal_cue cue="Cleanup" />
                </do_elseif>
                <do_else>
                  <show_help line="1001" duration="7s" position="1" force="true" width="140" comment="You can abort this tutorial in the Active Missions menu " />
                </do_else>
              </actions>
              <cues>

                <cue name="Abort">
                  <conditions>
                    <event_mission_aborted cue="Start" />
                  </conditions>
                  <actions>
                    <remove_help all="true"/>
                    <remove_mission cue="Start" type="aborted" />
                    <signal_cue cue="Cleanup" />
                  </actions>
                </cue>

                <cue name="Abort_OtherTutorialStarted">
                  <conditions>
                    <event_cue_signalled cue="md.Tutorials.NewTutorialTriggered" />
                    <check_value value="event.param != Start" />
                  </conditions>
                  <actions>
                    <remove_help all="true"/>
                    <show_notification text="{1015,400}" sound="notification_warning" comment="Tutorial aborted" />
                    <remove_mission cue="Start" type="aborted"/>
                    <signal_cue cue="Cleanup" />
                  </actions>
                </cue>

                <cue name="Tutorial_Init">
                  <delay exact="$StartDelay"/>
                  <actions>
                    <!--Create a list of tutorial cues to trigger in what order, and what briefing step they point to-->
                    <set_value name="$SignalList" exact="[
                                [Tutorial_Mineral, 1],
                                [Tutorial_Asteroids, 2],
                                [Tutorial_Crystals, 3],
                    ]"/>

                    <set_value name="$Index" exact="0"/>
                    <signal_cue cue="Tutorial_TriggerNext"/>

                  </actions>
                </cue>

                <cue name="Tutorial_TriggerNext" instantiate="true">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <set_value name="$Index" operation="add"/>
                    <do_if value="$Index gt $SignalList.count">
                      <remove_help all="true"/>
                      <debug_text text="'Mining tutorial has been completed'" chance="$DebugChance" />
                      <show_help line="1002" position="1" force="true" comment="Tutorial Completed!"/>
                      <show_help line="1003" position="1" force="true" comment="Press $INPUT_ACTION_HELP$ to try other tutorials."/>
                      <remove_mission cue="Start" type="tutorialcompleted" />
                      <signal_cue cue="Cleanup" />
                    </do_if>
                    <do_else>
                      <signal_cue cue="$SignalList.{$Index}.{1}"/>
                      <set_value name="$CurrentStep" exact="$SignalList.{$Index}.{2}"/>
                      <set_objective_from_briefing cue="Start" step="$CurrentStep"/>
                    </do_else>
                  </actions>
                </cue>

                <cue name="Tutorial_Mineral_DebugObjective" instantiate="true">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <set_objective step="1" cue="Start" action="objective.custom" customaction="{30184,20}" object="$ResourceSector"  offset="$ResourcePos" radius="5000m"/>
                  </actions>
                </cue>

                <cue name="Tutorial_Mineral">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <set_value name="$NearAsteroid" exact="false"/>
                    <set_value name="$ShipMenuWasOpen" exact="false"/>
                    <set_value name="$DeployedProbe" exact="false"/>
                    <set_value name="$MapOpened" exact="false"/>
                    <set_value name="$MapClosed" exact="false"/>
                    <show_help_multi log="false" position="1" allowclose="false">
                      <text line="14001" comment="While most ships have CONTAINER STORAGE, mining ships have SOLID STORAGE."/>
                      <text line="14002" comment="To pick up ORE, SILICON or ICE your ship needs SOLID STORAGE."/>
                    </show_help_multi>
                  </actions>
                  <cues>

                    <cue name="Tutorial_Mineral_HintClosed">
                      <conditions>
                        <event_ui_triggered screen="'hintclosed'" control="'14001'"/>
                      </conditions>
                      <actions>
                        <set_objective step="1" cue="Start" action="objective.custom" customaction="{30184,20}" object="$ResourceSector"  offset="$ResourcePos" radius="5000m"/>

                      </actions>
                    </cue>

                    <cue name="Tutorial_Mineral_ReHint" checkinterval="20s" instantiate="true">
                      <conditions>
                        <check_value value="player.entity.distanceto.[$ResourceSector, $ResourcePos] gt 5000m"/>
                      </conditions>
                      <actions>
                        <set_value name="$NearAsteroid" exact="false"/>
                        <show_help line="14020" duration="20s" position="1" force="true" comment="Fly towards an asteroid."/>
                      </actions>
                    </cue>

                    <cue name="Tutorial_Mineral_Selection" checkinterval="5s">
                      <conditions>
                        <check_value value="(not $NearAsteroid) and player.entity.distanceto.[$ResourceSector, $ResourcePos] le 5000m"/>
                      </conditions>
                      <actions>
                        <remove_help all="true"/>
                      </actions>
                      <delay exact="1s"/>
                      <actions>
                        <set_value name="$NearAsteroid" exact="true"/>
                        <show_help line="14021" duration="7s" position="1" force="true" comment="To judge your chances for mining you can deploy a RESOURCE PROBE."/>
                      </actions>
                      <cues>
                        <cue name="Tutorial_Mineral_Selection_Delay">
                          <delay exact="8s"/>
                          <actions>
                            <signal_cue cue="Tutorial_Mineral_Probe"/>
                            <cancel_cue cue="Tutorial_Mineral_ReHint"/>
                          </actions>
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Tutorial_Mineral_Probe" instantiate="true">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <cues>

                        <cue name="Tutorial_Mineral_HasProbe" onfail="cancel">
                          <conditions>
                            <check_value value="player.ship.ammostorage.{deployablecategory.resourceprobe}.count"/>
                          </conditions>
                          <actions>
                            <show_help line="14030" position="1" force="true" comment="Press $INPUT_ACTION_OPEN_COCKPIT_MENU$ to open SHIP MENU." allowclose="false" timeout="false"/>
                          </actions>
                          <cues>

                            <cue name="Tutorial_Mineral_OpenShipMenu">
                              <conditions>
                                <event_ui_triggered screen="'DockedMenu'"/>
                              </conditions>
                              <actions>
                                <remove_help all="true"/>
                                <set_value name="$ShipMenuWasOpen" exact="true"/>
                              </actions>
                              <delay exact="0.5s"/>
                              <actions>
                                <show_help_overlay id="'docked_deploy_civ'" highlightonly="true"/>
                                <show_help line="14040" position="14" force="true" comment="Select RESOURCE PROBE from DEPLOY (CIVILIAN).." allowclose="false" timeout="false"/>
                              </actions>
                              <cues>

                                <cue name="Tutorial_Mineral_DeployedProbe">
                                  <conditions>
                                    <event_resourceprobe_launched space="player.sector"/>
                                    <check_value value="event.param2.isplayerowned"/>
                                  </conditions>
                                  <actions>
                                    <remove_help_overlay id="'docked_deploy_civ'"/>
                                    <remove_help all="true"/>
                                    <set_value name="$DeployedProbe" exact="true"/>
                                  </actions>
                                  <delay exact="0.5s"/>
                                  <actions>
                                    <show_help line="5001" position="14" force="true" comment="Open the MAP" allowclose="false" timeout="false"/>
                                  </actions>
                                  <cues>

                                    <cue name="Tutorial_Mineral_MapOpened" instantiate="true">
                                      <conditions>
                                        <event_ui_triggered screen="'MapMenu'" control="''"/>
                                        <check_value value="event.param2 == ''"/>
                                      </conditions>
                                      <actions>
                                        <set_value name="$MapOpened" exact="true"/>
                                        <remove_help all="true" />
                                        <!--set_holomap_target object="probe" comment="center on probe"/-->
                                      </actions>
                                      <delay exact="0.5s"/>
                                      <actions>
                                        <show_help line="14052" position="1" duration="10s" force="true" comment="The RESOURCE PROBE shows the local RESOURCE YIELDS" />
                                      </actions>
                                      <delay exact="1.5s"/>
                                      <actions>
                                        <show_help line="14053" position="1" force="true" comment="Close the MAP" allowclose="false" timeout="false"/>
                                      </actions>
                                      <cues>
                                        <cue name="Tutorial_Mineral_MapClosed" instantiate="true">
                                          <conditions>
                                            <event_ui_triggered screen="'MapMenu'" control="'menu_close'"/>
                                          </conditions>
                                          <actions>
                                            <remove_help all="true"/>
                                          </actions>
                                          <delay exact="1s"/>
                                          <actions>
                                            <signal_cue cue="Tutorial_TriggerNext"/>
                                            <cancel_cue cue="Tutorial_Mineral"/>
                                          </actions>
                                        </cue>

                                      </cues>
                                    </cue>
                                  </cues>
                                </cue>
                              </cues>
                            </cue>
                          </cues>
                        </cue>

                        <!-- For now, skip the Probe-part if player didn't have probes -->
                        <cue name="Tutorial_Mineral_NoProbe" onfail="cancel">
                          <conditions>
                            <check_value value="player.ship.ammostorage.{deployablecategory.resourceprobe}.count == 0"/>
                          </conditions>
                          <actions>
                            <signal_cue cue="Tutorial_TriggerNext"/>
                            <cancel_cue cue="Tutorial_Mineral"/>
                          </actions>
                        </cue>

                      </cues>
                    </cue>

                  </cues>
                </cue>

                <cue name="Tutorial_Asteroids">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <remove_help all="true" />
                    <set_value name="$FindYield" exact="false"/>
                    <set_value name="$ScanEnabled" exact="false"/>
                    <set_value name="$CollectedResource" exact="false"/>
                    <set_value name="$TurretsAreMining" exact="false"/>
                    <create_position name="$ResourcePosition" space="$ResourceSector" value="$ResourcePos"/>
                    <create_group groupname="$asteroids"/>
                    <set_value name="$AsteroidNear" exact="false"/>
                  </actions>
                  <delay exact="0.5s"/>
                  <actions>
                    <show_help line="14060" duration="7s" position="18" force="true" comment="Select different asteroids as targets and check your TARGET MONITOR."/>
                    <show_help line="14061" position="18" force="true" comment="Search for an asteroid with a high yield of any of the three types." allowclose="false" timeout="false"/>
                    <!--show_help line="14062" duration="7s" position="2" force="true" comment="You can use PREV/NEXT target buttons to select nearby asteroids."/-->
                  </actions>
                  <cues>

                    <cue name="Tutorial_Asteroids_Objective" checkinterval="16s" instantiate="true">
                      <conditions>
                        <check_value value="not $asteroids.count and not $FindYield"/>
                      </conditions>
                      <actions>
                        <find_object groupname="$asteroids" class="[class.asteroid]" space="$ResourceSector" multiple="true">
                          <match_distance max="50km" space="$ResourceSector" value="$ResourcePosition"/>
                        </find_object>

                        <!-- remove empty asteroids or asteroids with non-fitting wares -->
                        <do_all exact="$asteroids.count" counter="$i" reverse="true">
                          <do_if value="$asteroids.{$i}.wares.list.count == 0">
                            <remove_from_group group="$asteroids" object="$asteroids.{$i}"/>
                          </do_if>
                          <do_else>
                            <do_all exact="$asteroids.{$i}.wares.list.count" counter="$wi">
                              <do_if value="not [ware.ice,ware.ore,ware.silicon].indexof.{$asteroids.{$i}.wares.list.{$wi}}">
                                <remove_from_group group="$asteroids" object="$asteroids.{$i}"/>
                                <break/>
                              </do_if>
                            </do_all>
                          </do_else>
                        </do_all>

                        <!-- remove down to a more reasonable number -->
                        <do_all exact="$asteroids.count" counter="$i" reverse="true">
                          <do_if value="$asteroids.count gt 8">
                            <remove_from_group group="$asteroids" object="$asteroids.{$i}"/>
                          </do_if>
                          <do_else>
                            <break/>
                          </do_else>
                        </do_all>

                        <set_objective step="2" cue="Start" action="objective.custom" customaction="{30184,21}" group="$asteroids"/>
                      </actions>
                    </cue>

                    <cue name="Tutorial_Asteroids_FindYield" instantiate="true">
                      <conditions>
                        <event_player_changed_target/>
                        <check_any exact="event.param and event.param.wares.count" counter="$i">
                          <check_value value="[ware.ice,ware.ore,ware.silicon].indexof.{event.param.wares.list.{$i}}" comment=".list returns wares with non-zero amounts"/>
                        </check_any>
                        <check_value value="not $FindYield"/>
                      </conditions>
                      <actions>
                        <set_value name="$FindYield" exact="true"/>
                        <!--debug_text text="'Target: ' + event.param"/>
                        <set_value name="$SelectedTarget" exact="event.param"/>
                        <set_value name="$SelectedWares" exact="$SelectedTarget.wares.list"/>
                        <do_all exact="$SelectedWares.count" counter="$i">
                          <debug_text text="'[%s] ware `%s` amount %s'.[$i, $SelectedWares.{$i}, $SelectedTarget.wares.{$SelectedWares.{$i}}.count]"/>
                        </do_all-->
                      </actions>
                    </cue>

                    <!-- As long as not scan-enabled, hint to fly close to selected asteroid, and when close hint to enable scan-mode -->
                    <cue name="Tutorial_Asteroids_Rehint" checkinterval="15s" instantiate="true">
                      <conditions>
                        <check_value value="$FindYield and not $ScanEnabled"/>
                      </conditions>
                      <actions>
                        <remove_help all="true"/>
                        <do_if value="player.target == 0">
                          <show_help line="14060" duration="15s" position="18" force="true" comment="Select different asteroids as targets and check your TARGET MONITOR."/>
                        </do_if>
                        <do_elseif value="not $ScanEnabled and player.target and $asteroids.indexof.{player.target} and player.target.distanceto.{player.entity} lt 2500m">
                          <show_help line="14101" duration="15s" position="18" force="true" comment="Press $INPUT_ACTION_TOGGLE_SCAN_MODE$ to activate SCAN MODE."/>
                        </do_elseif>
                        <do_else>
                          <show_help line="14100" duration="15s" position="18" force="true" comment="Fly close to the selected asteroid."/>
                        </do_else>
                      </actions>
                    </cue>

                    <!-- check for enabling of scan-mode, when nearby asteroid -->
                    <cue name="Tutorial_Asteroids_NearScan" instantiate="true">
                      <conditions>
                        <event_player_changed_activity activity="activity.scan" />
                      </conditions>
                      <actions>
                        <set_value name="$ScanEnabled" exact="true"/>
                        <remove_help all="true" />
                      </actions>
                      <delay exact="0.5s"/>
                      <actions>
                        <show_help line="14102" duration="7s" position="1" force="true" comment="Flying around the asteroid you can now see traces of minerals"/>
                        <signal_cue cue="Tutorial_Asteroids_UseMiningLaser"/>
                      </actions>
                    </cue>

                    <cue name="Tutorial_Asteroids_UseMiningLaser">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <!-- any turret set to mining? -->
                        <!--set_value name="this.$TurretsAreMining" exact="false"/>
                        <do_all exact="player.ship.turrets.all.list.count" comment="$ti">
                          <do_if value="player.ship.turrets.all.list.{$ti}.mode == weaponmode.mining">
                            <set_value name="this.$TurretsAreMining" exact="true"/>
                            <break/>
                          </do_if>
                        </do_all>
                        <set_value name="$TurretsAreMining" exact="this.$TurretsAreMining"/-->
                      </actions>
                      <cues>
                        <cue name="Tutorial_Asteroids_WeaponMode3" comment="capship-case (switch weaponmode to fire mining laser)" onfail="cancel">
                          <conditions>
                            <check_value value="player.ship and player.ship.isclass.[class.ship_m, class.ship_l, class.ship_xl]"/>
                          </conditions>
                          <actions>
                            <show_help line="14030" position="1" force="true" comment="Press $INPUT_ACTION_OPEN_COCKPIT_MENU$ to open SHIP MENU." allowclose="false" timeout="false"/>
                            <set_value name="$ShipMenuWasOpen" exact="false"/>
                          </actions>

                          <cues>
                            <cue name="Tutorial_Asteroids_OpenShipMenu">
                              <conditions>
                                <event_ui_triggered screen="'DockedMenu'"/>
                              </conditions>
                              <actions>
                                <remove_help all="true"/>
                              </actions>
                              <delay exact="0.5s"/>
                              <actions>
                                <set_value name="$ShipMenuWasOpen" exact="true"/>
                                <show_help line="14110" position="15" force="true" comment="Change turret behaviour to 'Mining'.(for M/L/XL ships)" allowclose="false" timeout="false"/>
                              </actions>
                              <cues>

                                <cue name="Tutorial_Asteroids_WeaponModeMining" instantiate="true">
                                  <conditions>
                                    <event_object_weaponmode_changed object="player.ship" weaponmode="weaponmode.mining" />
                                    <check_value value="$TurretsAreMining == false"/>
                                  </conditions>
                                  <actions>
                                    <remove_help all="true"/>
                                    <set_value name="$TurretsAreMining" exact="true"/>
                                  </actions>
                                  <delay exact="0.5s"/>
                                  <actions>
                                    <show_help line="14111" duration="7s" position="15" force="true" comment="MINING LASERS will mine more efficiently than other types of turrets."/>
                                    <show_help line="1010" position="15" force="true" comment="Close the menu by ..." allowclose="false" timeout="false"/>
                                  </actions>
                                  <cues>
                                    <cue name="Tutorial_Asteroids_ClosedShipMenu">
                                      <conditions>
                                        <event_ui_triggered screen="'DockedMenu'" control="'menu_close'"/>
                                      </conditions>
                                      <actions>
                                        <remove_help all="true"/>
                                      </actions>
                                      <delay exact="2s"/>
                                      <actions>
                                        <signal_cue cue="Tutorial_Asteroids_Mining"/>
                                        <cancel_cue cue="Tutorial_Asteroids_UseMiningLaser"/>
                                      </actions>
                                    </cue>
                                  </cues>
                                </cue>
                              </cues>
                            </cue>
                          </cues>
                        </cue>

                        <cue name="Tutorial_Asteroids_FireLaser" comment="s-ship-case (directly fire mining laser)" onfail="cancel">
                          <conditions>
                            <check_value value="player.ship and player.ship.isclass.[class.ship_s]"/>
                          </conditions>
                          <actions>
                            <signal_cue cue="Tutorial_Asteroids_Mining"/>
                            <cancel_cue cue="Tutorial_Asteroids_UseMiningLaser"/>
                          </actions>
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Tutorial_Asteroids_Mining" instantiate="true">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <set_value name="$MinedAsteroid" exact="false"/>
                        <do_if value="player.ship and player.ship.isclass.[class.ship_m, class.ship_l, class.ship_xl]">
                          <show_help line="14122" duration="7s" position="1" force="true" comment="With mining-behaviour enabled, fly close past nearby asteroids" allowclose="false" timeout="false"/>
                        </do_if>
                        <do_elseif value="player.ship and player.ship.isclass.[class.ship_s]">
                          <show_help line="14105" duration="7s" position="1" force="true" comment="While other weapons also work the mining laser is the most efficient."/>
                          <show_help line="14103" duration="7s" position="1" force="true" comment="Fire a MINING LASER at nearby asteroids.(for S ships)" allowclose="false" timeout="false"/>
                        </do_elseif>
                      </actions>
                      <cues>

                        <cue name="Tutorial_Asteroids_Drop_S" instantiate="true">
                          <conditions>
                            <event_object_killed_object object="player.ship"/>
                            <check_value value="event.param.isclass.[class.asteroid]"/>
                            <check_value value="player.ship.isclass.[class.ship_s]"/>
                          </conditions>
                          <actions>
                            <remove_help all="true"/>
                            <show_help_multi log="false" position="13" allowclose="false" force="true">
                              <text line="14207" comment="When an asteroid is mined minerals can drop in nearby space."/>
                              <text line="14208" comment="You can pick up these with a ship with SOLID STORAGE"/>
                            </show_help_multi>
                          </actions>
                          <cues>
                            <cue name="Tutorial_Asteroids_Drop_S_HintClosed">
                              <conditions>
                                <event_ui_triggered screen="'hintclosed'" control="'14207'"/>
                              </conditions>
                              <actions>
                                <signal_cue cue="Tutorial_Asteroids_DoneDelayed" comment="skip the collection of the asteroid-shards part"/>
                                <cancel_cue cue="Tutorial_Asteroids_Drop_S"/>
                              </actions>
                            </cue>
                          </cues>
                        </cue>

                        <cue name="Tutorial_Asteroids_Drop_notS" instantiate="true" version="2">
                          <conditions>
                            <event_object_killed_object object="player.ship"/>
                            <check_value value="event.param.isclass.[class.asteroid]"/>
                            <check_value value="not player.ship.isclass.[class.ship_s]"/>
                          </conditions>
                          <actions>
                            <remove_help all="true"/>
                            <create_group groupname="$miningdrones"/>
                            <find_object groupname="$asteroidshards" class="[class.collectablewares]" space="$ResourceSector" multiple="true" append="true">
                              <match_distance object="player.entity" max="8km"/>
                            </find_object>

                            <do_all exact="$asteroidshards.count" counter="$i" reverse="true">
                              <do_if value="not $asteroidshards.{$i}.isclass.collectable">
                                <remove_from_group group="$asteroidshards" object="$asteroidshards.{$i}"/>
                              </do_if>
                            </do_all>

                            <debug_text text="'Asteroidshards: ' + $asteroidshards.count" chance="$DebugChance"/>
                            <do_if value="$asteroidshards.count">
                              <show_help_multi log="false" position="13" allowclose="false" force="true">
                                <text line="14200" comment="There are now mineral drops nearby in space."/>
                                <text line="14201" comment="Pick them up with a ship with SOLID STORAGE."/>
                                <text line="14202" comment="Fly over the minerals to pick them up."/>
                                <text line="14210" comment="Or press $INPUT_STATE_LOOTMAGNET$ to use the CONTAINER MAGNET to attract the minerals."/>
                                <text line="14203" comment="Some fragements don't contain anything worthwhile."/>
                              </show_help_multi>
                            </do_if>
                          </actions>
                          <patch sinceversion="2">
                            <create_group groupname="$miningdrones"/>
                          </patch>
                          <cues>

                            <cue name="Tutorial_Asteroids_HintClosed">
                              <conditions>
                                <event_ui_triggered screen="'hintclosed'" control="'14200'"/>
                              </conditions>
                              <actions>
                                <set_value name="$AstroidHintClosed" exact="true"/>
                              </actions>
                              <cues>

                                <cue name="Tutorial_Asteroids_Collected_v2">
                                  <conditions>
                                    <check_any>
                                      <event_player_collected_ware/>
                                    </check_any>
                                  </conditions>
                                  <actions>
                                    <remove_help all="true"/>
                                  </actions>
                                  <delay exact="3s"/>
                                  <actions>
                                    <show_help line="14211" duration="7s" position="13" force="true" comment="You can also order subordinate ships to pick up anything using the map."/>
                                    <signal_cue cue="Tutorial_Asteroids_DoneDelayed"/>
                                    <cancel_cue cue="Tutorial_Asteroids_Drop_notS"/>
                                    <cancel_cue cue="Tutorial_Asteroids_DroneReturned"/>
                                  </actions>
                                </cue>

                              </cues>
                            </cue>

                            <cue name="Tutorial_Asteroids_DroneLaunched" instantiate="true" comment="manage all drones launched">
                              <conditions>
                                <event_object_undocked_from container="player.ship"/>
                                <check_value value="event.param.isclass.ship_s"/>
                              </conditions>
                              <actions>
                                <debug_text text="'drone launched'"/>
                                <add_to_group groupname="$miningdrones" object="event.param"/>
                              </actions>
                            </cue>

                            <cue name="Tutorial_Asteroids_DroneReturned">
                              <conditions>
                                <event_object_docked group="$miningdrones"/>
                              </conditions>
                              <actions>
                                <debug_text text="'drone docked'"/>
                                <remove_from_group group="$miningdrones" object="event.object"/>
                                <do_if value="@$AstroidHintClosed">
                                  <cancel_cue cue="Tutorial_Asteroids_Drop_notS"/>
                                  <cancel_cue cue="Tutorial_Asteroids_Collected"/>
                                  <signal_cue cue="Tutorial_Asteroids_DoneDelayed"/>
                                </do_if>
                              </actions>
                            </cue>

                          </cues>
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Tutorial_Asteroids_DoneDelayed">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <delay exact="9s"/>
                      <actions>
                        <signal_cue cue="Tutorial_TriggerNext"/>
                        <cancel_cue cue="Tutorial_Asteroids"/>
                      </actions>
                    </cue>
                  </cues>
                </cue>

                <cue name="Tutorial_Crystals">
                  <!-- 
                   <t id="14212">While in Asteroid fields, look out for blinking CRYSTALS.</t>
                   <t id="14213">CRYSTALS are small and can be collected with all ships.</t>
                   <t id="14214">They go in your INVENTORY and can be sold on most stations.</t>
                   <t id="14215">You can also order ships to MINE remotely for you.</t>
                   <t id="14220">ORE, SILICON and ICE are sold to refineries.</t>
                  -->
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <create_group groupname="$crystalcluster"/>
                    <create_group groupname="$crystaldrops"/>
                    <set_value name="$crystalscollected" exact="false"/>
                    <include_actions ref="md.LIB_Generic.FindCrystalsNearPlayer"/>
                  </actions>
                  <cues>

                    <cue name="Tutorial_Crystal_Skip" onfail="cancel">
                      <conditions>
                        <check_any>
                          <check_value value="player.ship.dps.primary == 0"/>
                          <check_value value="$crystalcluster.count == 0"/>
                        </check_any>
                      </conditions>
                      <actions>
                        <show_help_multi position="13" force="true" allowclose="false" width="220">
                          <text line="14300" comment="While in Asteroid fields, look out for blinking CRYSTALS on asteroids."/>
                          <text line="14305" log="true" comment="You can mine crystals by accurately targeting them with the primary weapons of an S-class ship."/>
                          <text line="14330" log="true" comment="CRYSTALS are small and can be collected with all ships."/>
                          <text line="14331"            comment="They go in your INVENTORY and can be sold on most stations."/>
                        </show_help_multi>
                      </actions>
                      <cues>
                        <cue name="Tutorial_Crystal_HintClosed_v2">
                          <conditions>
                            <event_ui_triggered screen="'hintclosed'" control="'14300'"/>
                          </conditions>
                          <actions>
                            <signal_cue cue="Tutorial_TriggerNext"/>
                            <cancel_cue cue="Tutorial_Crystals"/>
                          </actions>
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Tutorial_Crystal_Start" onfail="cancel">
                      <conditions>
                        <check_value value="player.ship.dps.primary != 0"/>
                      </conditions>
                      <actions>
                        <show_help line="14300" position="14" force="true" comment="While in Asteroid fields, look out for blinking CRYSTALS on asteroids." allowclose="false" timeout="false"/>
                        <set_objective cue="Start" step="3" action="objective.custom" customaction="{30184,22}" group="$crystalcluster"/>
                      </actions>
                      <cues>

                        <cue name="Tutorial_Crystal_Refresh_v2" instantiate="true" comment="find new crystals">
                          <conditions>
                            <check_any>
                              <event_cue_signalled/>
                              <event_object_destroyed group="$crystalcluster"/>
                            </check_any>
                            <check_value value="$crystalcluster.count == 0"/>
                          </conditions>
                          <actions>
                            <remove_help all="true"/>
                            <include_actions ref="md.LIB_Generic.FindCrystalsNearPlayer"/>
                            <set_objective cue="Start" action="objective.custom" customaction="{30184,22}"  group="$crystalcluster"/>
                            <do_if value="$crystaldrops.count">
                              <show_help line="14320" duration="7s" position="13" force="true" comment="Pick up the crystal which just dropped." allowclose="false" timeout="false"/>
                            </do_if>
                            <do_else>
                              <show_help line="14310" duration="7s" position="13" force="true" comment="Shoot the crystals with your primary weapon." allowclose="false" timeout="false"/>
                              <do_if value="not $crystalcluster.count">
                                <signal_cue cue="Tutorial_Crystal_Refresh_v2"/>
                              </do_if>
                            </do_else>
                          </actions>
                        </cue>

                        <cue name="Tutorial_Crystals_Do_v2" instantiate="true">
                          <conditions>
                            <event_object_dropped_objects group="$crystalcluster"/>
                          </conditions>
                          <actions>

                            <do_all exact="event.param.count" counter="$cdi">
                              <do_if value="event.param.{$cdi}.isclass.[class.collectablewares]">
                                <add_to_group groupname="$crystaldrops" object="event.param.{$cdi}"/>
                              </do_if>
                            </do_all>
                            <debug_text text="'crystaldrops: ' + $crystaldrops.count" chance="$DebugChance"/>

                            <do_if value="$crystaldrops.count" comment="gather crystaldrops them">
                              <set_objective cue="Start" step="3" action="objective.custom" customaction="{30184,22}" group="$crystaldrops"/>
                            </do_if>
                            <do_else comment="no dropped crystals, shoot crystals on asteroids">
                              <signal_cue cue="Tutorial_Crystal_Refresh_v2"/>
                            </do_else>
                          </actions>
                          <cues>
                            <cue name="Tutorial_Crystals_Pickup_v2">
                              <conditions>
                                <event_inventory_added object="player.entity"/>
                              </conditions>
                              <actions>
                                <set_value name="$crystalscollected" exact="true"/>
                                <show_help line="14330" duration="6s" position="13" force="true" log="true" comment="CRYSTALS are small and can be collected with all ships."/>
                                <show_help line="14331" duration="6s" position="13" force="true" log="true" comment="They go in your INVENTORY and can be sold on most stations."/>
                                <signal_cue cue="Tutorial_Crystals_Done_v2"/>
                              </actions>
                            </cue>

                            <cue name="Tutorial_Crystals_Done_v2">
                              <conditions>
                                <event_cue_signalled/>
                              </conditions>
                              <delay exact="15s"/>
                              <actions>
                                <signal_cue cue="Tutorial_TriggerNext"/>
                                <cancel_cue cue="Tutorial_Crystals"/>
                              </actions>
                            </cue>
                          </cues>
                        </cue>

                      </cues>
                    </cue>
                  </cues>
                </cue>
              </cues>
            </cue>

            <cue name="Cleanup">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <remove_help_overlay all="true"/>
                <debug_text text="'cleanup'" chance="$DebugChance"/>
                <do_if value="$BriefingCutsceneStarted?">
                  <stop_cutscene key="$CutsceneKey"/>
                </do_if>
                <do_if value="$Beacons?">
                  <destroy_group group="$Beacons"/>
                </do_if>
                <remove_offer cue="Start"/>
                <remove_mission cue="Start" />
                <reset_cue cue="Trigger"/>
              </actions>
            </cue>

          </cues>
        </cue>

      </cues>
    </cue>
  </cues>
</mdscript>