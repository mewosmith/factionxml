<?xml version="1.0" encoding="utf-8"?>
<mdscript name="Story_Paranid" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="md.xsd">
  <cues>

    <cue name="Force_HQ_Debug">
      <force name="Plot_Paranid_Activate_Setup">
        <signal_cue cue="Start"/>
      </force>
    </cue>

    <cue name="Start" namespace="this" version="4">
      <conditions>
        <!--<event_cue_signalled/>-->
        <event_cue_signalled cue="md.Setup.Start"/>
        <check_value value="player.galaxy.macro == macro.xu_ep2_universe_macro" comment="only in main-galaxy"/>
      </conditions>

      <actions>
        <set_value name="$DebugChance"    exact="0"/>
        <set_value name="$DeepDebugChance" exact="0"/>
        <set_value name="$MissionCue"     exact="this"/>

        <set_value name="$Page"           exact="30220" comment="Paranid Story page"/>

        <!-- *** PARANID STORY CHARACTERS ***-->

        <!-- Gride Orrian: Informant and Buccaneer lieutenant -->
        <create_cue_actor name="$GrideActor" cue="namespace" macro="character_argon_female_plot_buccaneer_macro">
          <page exact="10151"/>
          <owner exact="faction.buccaneers"/>
          <skills>
            <skill type="management"  exact="7"/>
            <skill type="morale"      exact="15"/>
            <skill type="piloting"    exact="13"/>
            <skill type="engineering" exact="5"/>
            <skill type="boarding"    exact="9"/>
          </skills>
        </create_cue_actor>
        <set_entity_traits entity="$GrideActor" missionactor="true" customhandler="true" subtitlename="true"/>
        <!-- 'Drone Specialist' -->
        <set_entity_overrides entity="$GrideActor" title="'{30220,124}'" icon="'captain'"/>
        <set_value name="md.$PersistentCharacters.$GrideActor" exact="$GrideActor"/>

        <!-- Kromancketslat: Paranid diplomat and Buccaneer Pirate Duke -->
        <create_cue_actor name="$Duke" cue="namespace" macro="character_paranid_plot_pirate_duke_macro">
          <page exact="10351"/>
          <owner exact="faction.civilian"/>
          <skills>
            <skill type="management"  exact="15"/>
            <skill type="morale"      exact="15"/>
            <skill type="piloting"    exact="12"/>
            <skill type="engineering" exact="3"/>
            <skill type="boarding"    exact="12"/>
          </skills>
        </create_cue_actor>
        <set_entity_traits entity="$Duke" missionactor="true" customhandler="true" subtitlename="false"/>
        <set_entity_overrides entity="$Duke" title="'{30220,111}'" icon="'architect'"/>
        <set_value name="md.$PersistentCharacters.$Duke" exact="$Duke"/>

        <!-- Paranid - Legate (Xatenmanckett) -->
        <create_cue_actor name="$XatActor" cue="namespace" macro="character_paranid_plot_legate_macro">
          <page exact="10352"/>
          <owner exact="faction.paranid"/>
          <skills>
            <skill type="management"  exact="15"/>
            <skill type="morale"      exact="15"/>
            <skill type="piloting"    exact="15"/>
            <skill type="engineering" exact="6"/>
            <skill type="boarding"    exact="3"/>
          </skills>
        </create_cue_actor>
        <set_entity_traits entity="$XatActor" missionactor="true" customhandler="true" subtitlename="true"/>
        <set_value name="md.$PersistentCharacters.$XatActor" exact="$XatActor"/>

        <!-- Paranid - Honor Guard (Rikmanckassor) -->
        <create_cue_actor name="$RikActor" cue="namespace" macro="character_paranid_plot_honor_guard_macro">
          <page exact="10304"/>
          <owner exact="faction.holyorder"/>
          <skills>
            <skill type="management"  exact="6"/>
            <skill type="morale"      exact="15"/>
            <skill type="piloting"    exact="15"/>
            <skill type="engineering" exact="9"/>
            <skill type="boarding"    exact="15"/>
          </skills>
        </create_cue_actor>
        <set_entity_traits entity="$RikActor" missionactor="true" customhandler="true" subtitlename="true"/>
        <set_value name="md.$PersistentCharacters.$RikActor" exact="$RikActor"/>

        <set_value name="$GrideCutsceneKey"   exact="table[ $key = 'ShowCharacter']"/>
        <set_value name="$DalCutsceneKey"     exact="table[ $key = 'ShowCharacterDal', $room = true]"/>
        <set_value name="$BosoCutsceneKey"    exact="table[ $key = 'ShowCharacterBoron']"/>
        <set_value name="$RikCutsceneKey"     exact="table[ $key = 'ShowPilot']"/>
        <set_value name="$XatCutsceneKey"     exact="table[ $key = 'ShowCharacter']"/>
        <set_value name="$DukeCutsceneKey"    exact="table[ $key = 'ShowCharacter']"/>
        <set_value name="$ShowPilotCutsceneKey" exact="table[ $key = 'ShowPilot']"/>

        <!-- *** PARANID STORY LOCATIONS *** -->

        <find_sector name="$DerelictSector" macro="macro.cluster_35_sector001_macro" comment="Lasting Vengeance"/>
        <find_object name="$DerelictStation" space="$DerelictSector" macro="macro.landmarks_gen_old_ringstation_macro" required="true"/>
        <find_sector name="$CardinalSector" macro="macro.cluster_36_sector001_macro" comment="Cardinal's Redress"/>
        <find_sector name="$ParanidMonumentSector" macro="macro.cluster_11_sector001_macro" comment=""/>
        <find_object name="$ParanidMonument" space="$ParanidMonumentSector" macro="macro.landmarks_par_monument_01_macro" required="true"/>
        <create_position name="$ParanidMonumentPosition" object="$ParanidMonument" space="$ParanidMonumentSector"/>
        <set_value name="$ParanidMonumentZone" exact="$ParanidMonument.zone"/>

        <!-- *** PARANID STORY: OTHER VARIABLES *** -->

        <set_value name="$BuccaneerFlagshipMacro" exact="macro.ship_arg_l_destroyer_01_b_macro"/>
        <set_value name="$BuccaneerPaint" exact="ware.paintmod_0103"/>
        <set_value name="$TempestPaint" exact="ware.paintmod_0104"/>
        <set_value name="$TrinityPaint" exact="ware.paintmod_0102"/>
      </actions>
      <patch sinceversion="3">
        <!-- Can only happen in internal savegames, temporary measure to avoid having to create many new savegames-->
        <set_value name="$GrideCutsceneKey"   exact="table[ $key = 'ShowCharacter']"/>
        <set_value name="$DalCutsceneKey"     exact="table[ $key = 'ShowCharacterDal', $room = true]"/>
        <set_value name="$BosoCutsceneKey"    exact="table[ $key = 'ShowCharacterBoron']"/>
        <set_value name="$RikCutsceneKey"     exact="table[ $key = 'ShowPilot']"/>
        <set_value name="$DukeCutsceneKey"    exact="table[ $key = 'ShowCharacter']"/>
        <set_value name="$ShowPilotCutsceneKey" exact="table[ $key = 'ShowPilot']"/>
      </patch>
      <patch sinceversion="4">
        <add_licence type="generaluseequipment" licencefaction="faction.paranid" faction="faction.holyorderfanatic"/>
        <add_licence type="capitalequipment" licencefaction="faction.paranid" faction="faction.holyorderfanatic"/>
        <add_licence type="militaryequipment" licencefaction="faction.paranid" faction="faction.holyorderfanatic"/>
        <add_licence type="generaluseequipment" licencefaction="faction.holyorder" faction="faction.holyorderfanatic"/>
        <add_licence type="generaluseship" licencefaction="faction.holyorder" faction="faction.holyorderfanatic"/>
        <add_licence type="capitalequipment" licencefaction="faction.holyorder" faction="faction.holyorderfanatic"/>
        <add_licence type="capitalship" licencefaction="faction.holyorder" faction="faction.holyorderfanatic"/>
        <add_licence type="militaryequipment" licencefaction="faction.holyorder" faction="faction.holyorderfanatic"/>
        <add_licence type="militaryship" licencefaction="faction.holyorder" faction="faction.holyorderfanatic"/>
      </patch>
      <cues>

        <!-- *** DEBUG AND SETUP CUES *** -->

        <cue name="Debug_Setup_Paranid_Story" comment="Signal this when testing the Paranid Story on its own.">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <set_value name="$DebugChance" exact="100"/>
            <cancel_cue cue="Paranid_Story_Activation_Manager"/>
            <signal_cue cue="Debug_Spawn_HQ"/>
          </actions>
          <delay exact="5s"/>
          <actions>
            <signal_cue cue="Set_Persistent_Characters"/>
            <signal_cue cue="Debug_Spawn_Dal"/>
          </actions>
        </cue>

        <cue name="Setup_Create_Buccaneer_Flagship" instantiate="true">
          <conditions>
            <!-- spawn the ship if it doesn't exist, set some values even if it already does -->
            <!-- params: param = [ $sector = the sector to spawn the ship in, $position = the sector offset to spawn the ship at, $invulnerable = whether the ship should be invulnerable at this point, $radarvisible = whether the ship should be visible on the radar at this point ] -->
            <event_cue_signalled/>
          </conditions>
          <actions>
            <do_if value="not @$BuccaneerFlagship.exists">
              <create_ship name="$BuccaneerFlagship" macro="$BuccaneerFlagshipMacro" commandeerable="false" capturable="false" mission="true" sector="event.param.$sector">
                <owner exact="faction.buccaneers" overridenpc="true"/>
                <pilot>
                  <select faction="faction.buccaneers" tags="tag.elitepilot"/>
                </pilot>
                <loadout ref="story_paranid_buccaneer_flagship_destroyer"/>
                <people ref="paranid_elite_military_crew"/>
                <equipmentmods>
                  <engine ware="ware.mod_engine_boostthrust_01_mk3"/>
                  <shield ware="ware.mod_shield_capacity_02_mk3"/>
                  <ship ware="ware.mod_ship_mass_01_mk3"/>
                </equipmentmods>
                <safepos value="event.param.$position"/>
              </create_ship>
              <set_object_name object="$BuccaneerFlagship" page="20101" line="120901" comment="Helianthus"/>
            </do_if>
            <do_if value="event.param.$invulnerable">
              <set_object_min_hull object="$BuccaneerFlagship" exact="100"/>
              <set_object_min_shield object="$BuccaneerFlagship" exact="100"/>
            </do_if>
            <do_else>
              <set_object_min_hull object="$BuccaneerFlagship" exact="0"/>
              <set_object_min_shield object="$BuccaneerFlagship" exact="0"/>
            </do_else>
            <set_object_radar_visible object="$BuccaneerFlagship" visible="event.param.$radarvisible"/>
            <set_object_relation_behaviour object="$BuccaneerFlagship" disable="true"/>
          </actions>
        </cue>

        <cue name="Setup_Dal_Desk_Clean">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <signal_cue cue="md.Story_Diplomacy_Intro.Dal_DeskClean"/>
          </actions>
        </cue>

        <cue name="Setup_Dal_Desk_Busy">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <signal_cue cue="md.Story_Diplomacy_Intro.Dal_DeskBusy"/>
          </actions>
        </cue>

        <cue name="Debug_Spawn_HQ">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <signal_cue cue="md.X4Ep1_Mentor_Subscriptions.Debug_Create_HQ_With_Mentors"/>
            <debug_text text="'Debug HQ Spawn'" chance="$DebugChance"/>
          </actions>
          <delay exact="3s"/>
          <actions>
            <signal_cue cue="Remember_HQ"/>
          </actions>
        </cue>

        <cue name="Remember_HQ">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <set_value name="$HQ" exact="md.X4Ep1_Mentor_Subscriptions.Start.$HQ"/>
          </actions>
        </cue>

        <cue name="Set_Persistent_Characters">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <set_value name="$DalBusta" exact="md.$PersistentCharacters.$DalBusta"/>
            <set_value name="$BosoTa" exact="md.$PersistentCharacters.$BosoTa"/>
            <assert value="$DalBusta != null" text="'DalBusta is null'"/>
            <assert value="$BosoTa != null" text="'BosoTa is null'"/>
          </actions>
        </cue>

        <cue name="Debug_Spawn_Dal">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $DalBusta,
                                                                                                  table[
                                                                                                  $requestercue = namespace,
                                                                                                  $location = $BosoTa.room,
                                                                                                  $position = position.[-3.17m, 0.05m, -5.0m],
                                                                                                  $rotation = rotation.[90deg, 0deg, 0deg],
                                                                                                  $priority = 100,
                                                                                                  $debugchance = $DeepDebugChance,
                                                                                                  $debugcaller = if $DeepDebugChance == 100 then this else null]
                                                                                                  ]"/>

            <set_entity_traits entity="$DalBusta" missionactor="true" customhandler="true" subtitlename="true"/>
            <do_if value="not md.Story_Diplomacy_Intro.Start.$HQ?">
              <set_value name="md.Story_Diplomacy_Intro.Start.$HQ" exact="$HQ"/>
            </do_if>
            <signal_cue cue="Setup_Dal_Desk_Clean"/>
          </actions>
        </cue>

        <cue name="Debug_Add_Prerequisites_Partial" comment="Signal this to fulfil the requirements for starting chapter 0.">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <set_faction_relation faction="faction.paranid" otherfaction="faction.player" value="0.01f" reason="relationchangereason.missioncompleted"/>
          </actions>
        </cue>

        <cue name="Debug_Add_Prerequisites" comment="Signal this to immediately fulfil the requirements for completing chapter 0.">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <set_faction_relation faction="faction.paranid" otherfaction="faction.player" value="0.032f" reason="relationchangereason.missioncompleted"/>
            <set_faction_relation faction="faction.holyorder" otherfaction="faction.player" value="0.032f" reason="relationchangereason.missioncompleted"/>
          </actions>
        </cue>

        <cue name="Debug_Skipper">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <set_value name="$CurrentCheatChapter" exact="null"/>
            <create_cue_actor name="$SkipperActor" cue="$MissionCue" macro="character_argon_male_dyn_jacket_fighterpilot_01_macro">
              <owner exact="faction.civilian"/>
              <name name="'Skipper'"/>
            </create_cue_actor>
            <set_entity_type entity="$SkipperActor" type="entitytype.crowd"/>
            <set_entity_traits entity="$SkipperActor" missionactor="true" customhandler="true"/>
          </actions>
          <delay exact="1s"/>
          <actions>
            <signal_cue cue="Debug_Skipper_Spawn"/>
          </actions>
          <cues>

            <cue name="Debug_Skipper_Spawn" instantiate="true">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $SkipperActor, table[
                                                                                                                                      $requestercue = $MissionCue,
                                                                                                                                      $priority = 100,
                                                                                                                                      $location = $BosoTa.room,
                                                                                                                                      $position = position.[3.31m, 0.00m, -4.00m],
                                                                                                                                      $rotation = rotation.[225deg, 0deg, 0deg],
                                                                                                                                      $debugchance = $DeepDebugChance,
                                                                                                                                      $debugcaller = if $DebugChance == 100 then this else null]
                                                                                                                                      ]"/>
              </actions>
            </cue>

            <cue name="Debug_Skipper_Disconnect" instantiate="true">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $SkipperActor, table[
                                                                                                                                      $requestercue = $MissionCue,
                                                                                                                                      $priority = 100,
                                                                                                                                      $location = 'disconnect',
                                                                                                                                      $debugchance = $DeepDebugChance,
                                                                                                                                      $debugcaller = if $DebugChance == 100 then this else null]
                                                                                                                                      ]"/>
              </actions>
            </cue>

            <cue name="Debug_Skipper_Conversation" instantiate="true">
              <conditions>
                <event_conversation_started actor="$SkipperActor"/>
              </conditions>
              <actions>
                <add_player_choice highlighted="true" section="skipper_main" text="'PLEASE SAVE YOUR GAME'"/>
              </actions>
            </cue>

            <cue name="Debug_Skipper_Conversation_Main" instantiate="true">
              <conditions>
                <check_any>
                  <event_conversation_next_section actor="$SkipperActor" section="skipper_main"/>
                  <event_conversation_returned_to_section actor="$SkipperActor" section="skipper_main"/>
                </check_any>
              </conditions>
              <actions>
                <do_if value="Paranid_Story_Activation_Manager.state == cuestate.cancelled">
                  <add_player_choice_sub section="skipper_chapter_paranid" text="'Skip to Paranid chapter'"/>
                  <add_player_choice_sub section="skipper_reputation_paranid" text="'Cheat Paranid reputation'"/>
                </do_if>

                <add_player_choice_sub section="skipper_credits" text="'Cheat 500 mio credits'"/>
              </actions>
            </cue>

            <!-- *** PARANID SKIPPER *** -->
            <cue name="Debug_Skipper_Conversation_Chapter" instantiate="true">
              <conditions>
                <event_conversation_next_section actor="$SkipperActor" section="skipper_chapter_paranid"/>
              </conditions>
              <actions>
                <!-- Allow skip to monument if the player hasn't reached that point. -->
                <do_if value="Ch6_Standoff.state == cuestate.waiting">
                  <add_player_choice section="skipper_chapter_paranid_selected" choiceparam="'ch_6'" text="'Paranid: Skip to Monument'"/>
                </do_if>

                <do_if value="Sinks_Unification_Stage_1.state == cuestate.waiting">
                  <add_player_choice section="skipper_chapter_paranid_selected" choiceparam="'uni_1'" text="'Paranid: Skip to Unification 1'"/>
                </do_if>

                <do_if value="Sinks_Escalation_Stage_1.state == cuestate.waiting">
                  <add_player_choice section="skipper_chapter_paranid_selected" choiceparam="'esc_1'" text="'Paranid: Skip to Buccaneers 1'"/>
                </do_if>

                <add_player_choice_return text="'Back'"/>
              </actions>
            </cue>

            <cue name="Debug_Skipper_Conversation_Chapter_Selected" instantiate="true">
              <conditions>
                <event_conversation_next_section actor="$SkipperActor" section="skipper_chapter_paranid_selected"/>
              </conditions>
              <actions>
                <!-- Always reset the currently running chapter first. We want to leave the child cues of previously completed chapters running, so we don't reset them. -->
                <do_for_each in="$ChapterCues" name="$Chapter">
                  <do_if value="$Chapter.state == cuestate.complete">
                    <set_value name="$RunningChapter" exact="$Chapter"/>
                  </do_if>
                  <do_elseif value="$Chapter.state == cuestate.waiting">
                    <do_if value="$RunningChapter?">
                      <reset_cue cue="$RunningChapter"/>
                    </do_if>
                    <break/>
                  </do_elseif>
                </do_for_each>

                <do_if value="event.param2 == 'ch_6'">
                  <signal_cue cue="Ch6_Force"/>
                </do_if>

                <do_else>
                  <cancel_cue cue="Ch6_Standoff"/>

                  <do_if value="event.param2 == 'uni_1'">
                    <set_value name="$CurrentCheatChapter" exact="Sinks_Unification_Stage_1"/>
                    <signal_cue cue="Sinks_Unification_Stage_1"/>
                  </do_if>

                  <do_elseif value="event.param2 == 'esc_1'">
                    <set_value name="$CurrentCheatChapter" exact="Sinks_Escalation_Stage_1"/>
                    <signal_cue cue="Sinks_Escalation_Stage_1"/>
                  </do_elseif>
                </do_else>

              </actions>
            </cue>

            <cue name="Debug_Skipper_Conversation_Reputation" instantiate="true">
              <conditions>
                <check_any>
                  <event_conversation_next_section actor="$SkipperActor" section="skipper_reputation_paranid"/>
                  <event_conversation_returned_to_section actor="$SkipperActor" section="skipper_reputation_paranid"/>
                </check_any>
              </conditions>
              <actions>
                <add_player_choice_sub section="skipper_reputation_paranid_selected" choiceparam="'10'" text="'Paranid rep 10'"/>
                <add_player_choice_sub section="skipper_reputation_paranid_selected" choiceparam="'15'" text="'Paranid rep 15'"/>
                <add_player_choice_sub section="skipper_reputation_paranid_selected" choiceparam="'20'" text="'Paranid rep 20'"/>
                <add_player_choice_return text="'Back'"/>
              </actions>
            </cue>

            <cue name="Debug_Skipper_Conversation_Reputation_Selected" instantiate="true">
              <conditions>
                <event_conversation_next_section actor="$SkipperActor" section="skipper_reputation_paranid_selected"/>
              </conditions>
              <actions>
                <do_if value="event.param2 == '10'">
                  <set_faction_relation faction="faction.holyorder" otherfaction="faction.player" value="0.01"/>
                  <set_faction_relation faction="faction.paranid" otherfaction="faction.player" value="0.01"/>
                </do_if>
                <do_elseif value="event.param2 == '15'">
                  <set_faction_relation faction="faction.holyorder" otherfaction="faction.player" value="0.032"/>
                  <set_faction_relation faction="faction.paranid" otherfaction="faction.player" value="0.032"/>
                </do_elseif>
                <do_elseif value="event.param2 == '20'">
                  <set_faction_relation faction="faction.holyorder" otherfaction="faction.player" value="0.1"/>
                  <set_faction_relation faction="faction.paranid" otherfaction="faction.player" value="0.1"/>
                </do_elseif>
                <add_player_choice_return text="'Back'"/>
              </actions>
            </cue>

            <cue name="Debug_Skipper_Conversation_Credits" instantiate="true">
              <conditions>
                <event_conversation_next_section actor="$SkipperActor" section="skipper_credits"/>
              </conditions>
              <actions>
                <reward_player money="500000000Cr"/>
                <add_player_choice_return text="'Back'"/>
              </actions>
            </cue>

          </cues>
        </cue>

        <!-- *** STORY REMINDERS *** -->

        <library name="Story_Reminder">
          <params>
            <param name="Actor"/>
            <param name="CutsceneKey"/>
            <param name="Lines"/>
            <param name="CancelCue"                comment="If this cue gets activated, the reminder gets cancelled."/>
            <param name="Delay"    default="15min" comment="The inital delay for the first reminder."/>
            <param name="Interval" default="30min" comment="The time that's added to the interval between reminders each time."/>
            <param name="Limit"    default="2h"    comment="If the interval between reminders gets this long, we take it as a hint to cancel the reminder altogether."/>
          </params>
          <cues>

            <cue name="Story_Reminder_Delay">
              <delay exact="$Delay"/>
              <actions>
                <signal_cue cue="Story_Reminder_Speak_Actor_v2"/>
              </actions>
            </cue>

            <cue name="Story_Reminder_Speak_Actor_v2">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <cues>

                <cue name="Story_Reminder_Speak_Actor_Ref_v2" ref="md.LIB_Dialog.Speak_Actor">
                  <param name="Actor"             value="$Actor"/>
                  <param name="CutsceneKey"       value="$CutsceneKey"/>
                  <param name="Lines"             value="$Lines"/>
                  <param name="EndSignalCue"      value="Story_Reminder_Speak_Actor_Finished_v2"/>
                </cue>

                <cue name="Story_Reminder_Speak_Actor_Finished_v2">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <do_if value="$Delay ge $Limit">
                      <signal_cue cue="Story_Reminder_Cancel"/>
                    </do_if>
                    <do_else>
                      <set_value name="$Delay" exact="$Interval" operation="add"/>
                      <reset_cue cue="Story_Reminder_Delay"/>
                      <reset_cue cue="Story_Reminder_Speak_Actor_v2"/>
                    </do_else>
                  </actions>
                </cue>

              </cues>
            </cue>

            <cue name="Story_Reminder_Cancel">
              <conditions>
                <check_any>
                  <event_cue_signalled/>
                  <event_cue_activated cue="$CancelCue"/>
                </check_any>
              </conditions>
              <actions>
                <cancel_cue cue="parent"/>
              </actions>
            </cue>

          </cues>
        </library>

        <!-- *** OWEN'S FRAMEWORK CUES *** -->

        <cue name="Initialise">
          <actions>
            <set_value name="$CurrentChapterCue" exact="null"/>

            <!--Append chapter cues to a list so they can be reset when forcing another chapter - keep in order-->
            <set_value name="$ChapterCues" exact="[]"/>
            <append_to_list name="$ChapterCues" exact="Ch0_Prerequisites"/>
            <append_to_list name="$ChapterCues" exact="Ch1_Intro"/>
            <append_to_list name="$ChapterCues" exact="Ch2_Informant"/>
            <append_to_list name="$ChapterCues" exact="Ch3_Cipher"/>
            <append_to_list name="$ChapterCues" exact="Ch4_Duke"/>
            <append_to_list name="$ChapterCues" exact="Ch5_Campaign"/>
            <append_to_list name="$ChapterCues" exact="Ch6_Standoff"/>
            <append_to_list name="$ChapterCues" exact="Ch7_1_Unification"/>
            <append_to_list name="$ChapterCues" exact="Ch7_2_Escalation"/>

            <!--Trigger the first Chapter-->
            <!--<signal_cue cue="$ChapterCues.{1}"/>-->

            <signal_cue cue="Paranid_Story_Activation_Manager"/>
          </actions>
        </cue>

        <!--event.param = Forced Chapter cue-->
        <cue name="Force_Chapter" instantiate="true">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <set_value name="$ForcedCue" exact="event.param"/>
            <assert value="not $CurrentChapterCue or $ChapterCues.indexof.{$CurrentChapterCue} le $ChapterCues.indexof.{$ForcedCue}" text="'Forced Chapter ' + $ForcedCue + ' takes place before the current Chapter ' + $CurrentChapterCue + ' - may result in odd behaviour [Owen]'"/>
            <do_if value="$ChapterCues.indexof.{$ForcedCue}">
              <do_if value="$CurrentChapterCue">
                <!--You can clean up things from a running Chapter here-->
                <!--<do_if value="$CurrentChapterCue == $ForcedCue">
                 <remove_offer cue="Start"/>
                </do_if> -->
              </do_if>

              <!--Reset all Chapter cues-->
              <do_all exact="$ChapterCues.count" counter="$i">
                <reset_cue cue="$ChapterCues.{$i}"/>
              </do_all>
            </do_if>
          </actions>
          <cues>
            <cue name="Force_Chapter_Signal">
              <actions>
                <debug_text text="'Forcing ' + $ForcedCue + ' to be the active Chapter. Currently running Chapter: ' + $CurrentChapterCue"/>
                <signal_cue cue="$ForcedCue"/>
              </actions>
            </cue>
          </cues>
        </cue>

        <!-- *** STORY MANAGER INTERACTION *** -->

        <cue name="Paranid_Story_Activation_Manager">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <cues>

            <cue name="Activate_Immediately" onfail="cancel">
              <conditions>
                <check_value value="md.X4Ep1_Mentor_Subscriptions.Phase_Research.state == cuestate.complete and md.Story_Diplomacy_Intro.Pt11_End.state == cuestate.complete"/>
              </conditions>
              <actions>
                <signal_cue cue="Activate_Story"/>
              </actions>
            </cue>

            <cue name="Check_For_Scientific_Mentor_Ending" version="2">
              <conditions>
                <event_cue_completed cue="md.X4Ep1_Mentor_Subscriptions.Phase_Research"/>
                <check_value value="md.Story_Diplomacy_Intro.Pt11_End.state == cuestate.complete"/>
              </conditions>
              <actions>
                <signal_cue cue="Activate_Story"/>
              </actions>
              <patch sinceversion="2">
                <do_if value="(md.Story_Diplomacy_Intro.Pt11_End.state == cuestate.complete) and (md.X4Ep1_Mentor_Subscriptions.Phase_Research.state == cuestate.complete)">
                  <signal_cue cue="Activate_Story"/>
                </do_if>
              </patch>
            </cue>

            <cue name="Check_For_Diplomatic_Mentor_Ending">
              <conditions>
                <event_cue_completed cue="md.Story_Diplomacy_Intro.Pt11_End"/>
                <check_value value="md.X4Ep1_Mentor_Subscriptions.Phase_Research.state == cuestate.complete"/>
              </conditions>
              <actions>
                <signal_cue cue="Activate_Story"/>
              </actions>
            </cue>

            <cue name="Activate_Story">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <signal_cue cue="Remember_HQ"/>
                <signal_cue cue="Set_Persistent_Characters"/>

                <signal_cue cue="Ch0_Prerequisites"/>
                <cancel_cue cue="Paranid_Story_Activation_Manager"/>
              </actions>
            </cue>

          </cues>
        </cue>

        <!-- *** MONUMENT GUARD, INDEPENDENT OF STORY *** -->

        <cue name="Paranid_Monument_Generic_Guard_Response" version="2">
          <actions>
            <debug_text text="'Preparing Paranid Monument Generic Guard Response.'" chance="$DebugChance"/>
            <find_object name="$ParanidMonument" macro="macro.landmarks_par_monument_01_macro" space="player.galaxy"/>
            <set_value name="$TrespassingRadius" exact="8km"/>
            <set_value name="$ComplyRadius" exact="10km"/>
            <set_value name="$FleeRadius" exact="15km"/>
            <create_group groupname="$HonourGuardSquad"/>
          </actions>
          <patch sinceversion="2">
            <do_if value="not $HonourGuardSquad?">
              <create_group groupname="$HonourGuardSquad"/>
            </do_if>
          </patch>
          <cues>
            <cue name="Generic_Guard_Response_Ship_Captured" instantiate="true">
              <conditions>
                <event_object_changed_true_owner group="$HonourGuardSquad"/>
                <check_value value="$HonourGuardSquad.count ge 2"/>
              </conditions>
              <actions>
                <remove_from_group group="$HonourGuardSquad" object="event.object"/>
              </actions>
            </cue>
            <cue name="Generic_Guard_Response_Deactivate" comment="Deactivate the guard response once the Holy Order trusts the player.">
              <conditions>
                <event_player_relation_changed faction="faction.holyorder"/>
                <check_value value="not event.object" comment="only permanent changes are relevant"/>
                <check_value value="event.param2.{1} ge 0.032"/>
              </conditions>
              <actions>
                <cancel_cue cue="Generic_Guard_Response_Activate"/>
              </actions>
              <cues>
                <cue name="Generic_Guard_Response_Deactivate_Reset" comment="Reactivate the guard response once the Holy Order doesn't trust the player anymore.">
                  <conditions>
                    <event_player_relation_changed faction="faction.holyorder"/>
                    <check_value value="not event.object" comment="only permanent changes are relevant"/>
                    <check_value value="event.param2.{1} lt 0.032"/>
                  </conditions>
                  <actions>
                    <reset_cue cue="Generic_Guard_Response_Activate"/>
                    <reset_cue cue="Generic_Guard_Response_Deactivate"/>
                  </actions>
                </cue>
              </cues>
            </cue>
            <cue name="Generic_Guard_Response_Activate">
              <cues>
                <cue name="Generic_Guard_Response_Delay_Before_Activation">
                  <actions>
                    <debug_text text="'(Re-)Activating Paranid Monument Generic Guard Response in 30 seconds.'" chance="$DebugChance"/>
                  </actions>
                  <delay exact="30s"/>
                  <actions>
                    <debug_text text="'Paranid Monument Generic Guard Response (re-)activated.'" chance="$DebugChance"/>
                    <signal_cue cue="Generic_Guard_Response_Monument_Approach"/>
                  </actions>
                </cue>
                <cue name="Generic_Guard_Response_Monument_Approach">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <cues>
                    <cue name="Approach_Monument_Generic_Ref" ref="md.LIB_Generic.ApproachObject_Handler">
                      <param name="ApproachTarget"    value="$ParanidMonument"/>
                      <param name="ApproachDistance"  value="$TrespassingRadius"/>
                      <param name="SuccessSignalCue"  value="Generic_Guard_Response_Warning"/>
                    </cue>
                  </cues>
                </cue>
                <cue name="Generic_Guard_Response_Warning">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <debug_text text="'Paranid Monument Generic Guard Response: Warning and follow player'" chance="$DebugChance"/>
                    <set_value name="$TrespassingShip" exact="player.entity.ship"/>
                    <find_ship name="$HonourGuardLeader" job="'holyorder_corvette_elite_m'" space="player.galaxy"/>
                    <do_if value="$HonourGuardLeader.exists and $HonourGuardLeader.isoperational and ($HonourGuardLeader.distanceto.{$ParanidMonument} le 50km)" comment="If it's being constructed, pretend that there's no ship left.">
                      <find_ship groupname="$HonourGuardSquad" multiple="true" job="'holyorder_corvette_escort_elite_m'" space="player.galaxy"/>
                      <add_to_group groupname="$HonourGuardSquad" object="$HonourGuardLeader"/>
                      <create_order id="'Follow'" object="$HonourGuardLeader" immediate="true">
                        <param name="target" value="$TrespassingShip"/>
                      </create_order>
                    </do_if>
                    <do_else>
                      <debug_text text="'Honour Guard either does not exist or is too far away. Resetting guard response.'"/>
                      <reset_cue cue="Generic_Guard_Response_Activate"/>
                    </do_else>
                  </actions>
                  <cues>
                    <cue name="Generic_Speak_Rik_311_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$RikActor"/>
                      <param name="CutsceneKey"       value="$RikCutsceneKey"/>
                      <param name="Lines"             value="[[30220311], [if player.entity.isfemale then 30220313 else 30220312]]"/>
                      <param name="EndSignalCue"      value="Generic_Guard_Response_Activate_Timer"/>
                      <!--
                      Approaching vessel.
                      You will remove yourself from these premises or be obliterated.
                      (spoken to female player){10304,30220312}
                      -->
                    </cue>
                  </cues>
                </cue>
                <cue name="Generic_Guard_Response_Activate_Timer">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <debug_text text="'Paranid Monument Generic Guard Response: Starting timer, giving player the chance to escape before the attack.'" chance="$DebugChance"/>
                  </actions>
                  <cues>
                    <cue name="Generic_Guard_Response_Comply" checkinterval="1s">
                      <conditions>
                        <check_value value="$TrespassingShip.distanceto.{$ParanidMonument} ge $ComplyRadius"/>
                      </conditions>
                      <actions>
                        <debug_text text="'Paranid Monument Generic Guard Response: Player complied and flew away.'" chance="$DebugChance"/>
                        <cancel_all_orders object="$HonourGuardLeader"/>
                        <reset_cue cue="Generic_Guard_Response_Activate"/>
                      </actions>
                    </cue>
                    <cue name="Generic_Guard_Response_Ignore">
                      <delay exact="45s"/>
                      <actions>
                        <debug_text text="'Paranid Monument Generic Guard Response: Player stayed close to the monument.'" chance="$DebugChance"/>
                        <signal_cue cue="Generic_Guard_Response_Attack"/>
                        <cancel_cue cue="Generic_Guard_Response_Activate_Timer"/>
                      </actions>
                    </cue>
                    <cue name="Generic_Guard_Response_Sneaky_Player" checkinterval="2s">
                      <conditions>
                        <check_value value="player.ship.isclass.spacesuit"/>
                      </conditions>
                      <actions>
                        <signal_cue cue="Generic_Guard_Response_Attack"/>
                        <cancel_cue cue="Generic_Guard_Response_Activate_Timer"/>
                      </actions>
                    </cue>
                  </cues>
                </cue>
                <cue name="Generic_Guard_Response_Attack">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <debug_text text="'Paranid Monument Generic Guard Response: Rikmanckassor announces the attack.'" chance="$DebugChance"/>
                  </actions>
                  <cues>
                    <cue name="Generic_Speak_Rik_307_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$RikActor"/>
                      <param name="CutsceneKey"       value="$RikCutsceneKey"/>
                      <param name="Lines"             value="[[if player.entity.isfemale then 30220308 else 30220307], [if player.entity.isfemale then 30220310 else 30220309]]"/>
                      <param name="EndSignalCue"      value="Generic_Guard_Response_Attack_Order"/>
                      <!--
                          Your vessel will now be destroyed and your remains disposed of.
                          (spoken to female player 'your'){10304,30220307}
                          Do not resist.
                          (spoken to female player){10304,30220309}
                          -->
                    </cue>
                    <cue name="Generic_Guard_Response_Attack_Order">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <debug_text text="'Paranid Monument Generic Guard Response: Setting Honour Guard to enemy and telling them to attack the player.'" chance="$DebugChance"/>
                        <do_if value="$HonourGuardSquad.count">
                          <do_for_each in="$HonourGuardSquad" name="$CurrentNemesis">
                            <set_relation_boost object="$CurrentNemesis" value="-1" faction="faction.player" silent="true" decay="0" comment="relentless"/>
                            <create_order object="$CurrentNemesis" id="'Attack'" immediate="true">
                              <param name="primarytarget" value="if $TrespassingShip.exists then $TrespassingShip else player.entity.ship"/>
                              <param name="pursuetargets" value="true"/>
                            </create_order>
                          </do_for_each>
                        </do_if>
                        <do_else>
                          <reset_cue cue="Generic_Guard_Response_Activate"/>
                        </do_else>
                      </actions>
                      <cues>
                        <cue name="Generic_Guard_Response_TrespassingShip_Gained_Distance" checkinterval="1s">
                          <conditions>
                            <check_value value="$TrespassingShip.distanceto.{$ParanidMonument} ge $FleeRadius"/>
                          </conditions>
                          <actions>
                            <signal_cue cue="Generic_Guard_Response_Player_Fled"/>
                          </actions>
                        </cue>
                        <cue name="Generic_Guard_Response_TrespassingShip_Destroyed">
                          <conditions>
                            <event_object_destroyed object="$TrespassingShip"/>
                          </conditions>
                          <actions>
                            <do_if value="player.entity.distanceto.{$ParanidMonument} le $TrespassingRadius">
                              <set_value name="$TrespassingShip" exact="player.entity.ship"/>
                              <do_for_each in="$HonourGuardSquad" name="$CurrentNemesis">
                                <create_order object="$CurrentNemesis" id="'Attack'" immediate="true">
                                  <param name="primarytarget" value="$TrespassingShip"/>
                                  <param name="pursuetargets" value="true"/>
                                </create_order>
                              </do_for_each>
                            </do_if>
                            <do_else>
                              <signal_cue cue="Generic_Guard_Response_Player_Fled"/>
                            </do_else>
                          </actions>
                        </cue>
                        <cue name="Generic_Guard_Response_Player_Fled">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <actions>
                            <debug_text text="'Paranid Monument Generic Guard Response: Trespassing ship gained distance or got destroyed while at least one of the Honour Guard was still alive.'" chance="$DebugChance"/>
                            <do_for_each in="$HonourGuardSquad" name="$CurrentNemesis">
                              <cancel_all_orders object="$CurrentNemesis"/>
                              <reset_relation_boost object="$CurrentNemesis" faction="faction.player" otherobject="if $TrespassingShip.exists then $TrespassingShip else player.entity.ship"/>
                            </do_for_each>
                            <set_value name="$MissionCue.$MonumentGuardPlayerFled" comment="Have the story mission remember that the player fled from the guard previously."/>
                            <reset_cue cue="Generic_Guard_Response_Activate" comment="Would be weird if the guard never showed up again after the player fled once."/>
                          </actions>
                        </cue>
                        <cue name="Generic_Guard_Response_Ships_Destroyed">
                          <conditions>
                            <check_any>
                              <event_object_changed_true_owner group="$HonourGuardSquad"/>
                              <event_object_destroyed group="$HonourGuardSquad"/>
                            </check_any>
                            <check_value value="$HonourGuardSquad.count == 1" comment="Last squad member is destroyed."/>
                          </conditions>
                          <actions>
                            <do_if value="event.name == 'event_object_changed_true_owner'">
                              <remove_from_group group="$HonourGuardSquad" object="event.object"/>
                            </do_if>
                            <do_if value="$MissionCue.$MonumentGuardPlayerFled?">
                              <debug_text text="'Paranid Monument Generic Guard Response: Player previously fled, but returned and defeated the Honour Guard.'" chance="$DebugChance"/>
                              <remove_value name="$MissionCue.$MonumentGuardPlayerFled" comment="If the player fled previously, have the story mission now remember that they defeated the guard instead."/>
                            </do_if>
                            <debug_text text="'Paranid Monument Generic Guard Response: Paranid Story will remember that the player defeated the Honour Guard.'" chance="$DebugChance"/>
                            <set_value name="$MissionCue.$MonumentGuardKilledPrematurely"/>
                            <cancel_cue cue="Paranid_Monument_Generic_Guard_Response"/>
                          </actions>
                        </cue>
                      </cues>
                    </cue>
                  </cues>
                </cue>
              </cues>
            </cue>
          </cues>
        </cue>

        <!-- *** STORY CHAPTERS *** -->

        <!-- Chapter 0: Prerequisites for starting the story -->

        <cue name="Ch0_Force">
          <force name="Plot_Paranid_Ch0">
            <signal_cue_instantly cue="Force_Chapter" param="Ch0_Prerequisites"/>
          </force>
        </cue>

        <cue name="Ch0_Prerequisites" version="2">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <debug_text text="'Starting Chapter ' + this" chance="$DebugChance"/>
            <set_value name="$CurrentChapterCue" exact="this"/>

            <set_value name="$EntryRelation" exact="faction.paranid.relation.friend.min" comment="0.01 (UI value 10) = friendly"/>
            <set_value name="$TargetRelation" exact="-0.0099" comment="-0.0099 (UI value -9) = allowed to dock"/>

            <set_value name="$PrerequisitesMissionRunning" exact="false" comment="Used to toggle availability of Dal HQ conversation."/>
            <set_value name="$PrerequisitesIntroConversationFinished" exact="false" comment="Used to make Dal HQ conversation available the first time."/>
          </actions>
          <patch sinceversion="2">
            <set_value name="$TargetRelation" exact="-0.0099" comment="For private beta testers."/>
          </patch>
          <cues>

            <cue name="Prerequisites_Hint_Conversation_Tooltip" instantiate="true">
              <conditions>
                <event_conversation_started actor="$DalBusta"/>
                <check_value value="not $PrerequisitesIntroConversationFinished"/>
                <check_value value="Prerequisites_Trigger_Availability.state == cuestate.waiting" comment="This conversation option should only appear before Dal tries calling the player."/>
                <check_value value="$HQ? and $DalBusta.hascontext.{$HQ} and player.entity.hascontext.{$HQ}"/>
              </conditions>
              <actions>
                <add_player_choice text="{30220,205}" selectable="false" tooltip="{30220,207}" section="dal_unreachable" comment="Paranid Civil War (Tooltip: Improve your reputation with the Paranid.)"/>
              </actions>
            </cue>

            <cue name="Prerequisites_Hint_Conversation_Failsafe">
              <conditions>
                <event_conversation_next_section actor="$DalBusta" section="dal_unreachable"/>
              </conditions>
              <actions>
                <debug_text text="'Selected unselectable conversation option. This conversation section is supposed to be unreachable.'" chance="$DebugChance"/>
                <cancel_cue cue="Prerequisites_Hint_Conversation_Tooltip"/>
              </actions>
            </cue>

            <cue name="Prerequisites_Trigger_Availability_Immediately" onfail="cancel">
              <conditions>
                <check_value value="Prerequisites_Trigger_Availability.state == cuestate.waiting"/>
              </conditions>
              <actions>
                <do_if value="(faction.paranid.relationto.{faction.player} ge $EntryRelation) or (faction.holyorder.relationto.{faction.player} ge $EntryRelation)">
                  <cancel_cue cue="Prerequisites_Trigger_Availability"/>
                  <signal_cue cue="Prerequisites_Trigger_Dal_Call_Parent"/>
                </do_if>
              </actions>
            </cue>

            <cue name="Prerequisites_Trigger_Availability">
              <conditions>
                <check_any>
                  <event_player_relation_changed faction="faction.holyorder"/>
                  <event_player_relation_changed faction="faction.paranid"/>
                </check_any>
                <check_value value="not event.object" comment="only permanent changes are relevant"/>
                <check_value value="event.param2.{1} ge $EntryRelation"/>
              </conditions>
              <actions>
                <debug_text text="'Paranid Story reputation prerequisites met, Dal Busta call now available.'" chance="$DebugChance"/>
                <signal_cue cue="Prerequisites_Trigger_Dal_Call_Parent"/>
              </actions>
            </cue>

            <cue name="Prerequisites_Trigger_Dal_Call_Parent">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <cancel_cue cue="Prerequisites_Hint_Conversation_Tooltip"/>
              </actions>
              <cues>

                <cue name="Prerequisites_Trigger_Dal_Call_HQ_Skip_Header" instantiate="true" comment="Special case.">
                  <conditions>
                    <event_conversation_started actor="$DalBusta"/>
                    <check_value value="$HQ? and $DalBusta.hascontext.{$HQ} and player.entity.hascontext.{$HQ}"/>
                  </conditions>
                  <actions>
                    <!-- If the player already has improved relations with both Paranid factions and talks to Dal at the HQ while he tries to call them, have Dal give them the intro directly instead of taking the roundabout way with the call. -->
                    <do_if value="(faction.paranid.relationto.{faction.player} ge $TargetRelation) and (faction.holyorder.relationto.{faction.player} ge $TargetRelation)">
                      <add_player_choice text="{30220,205}" section="dal_prerequisites_hq_skip" choiceparam="'skip_to_ch1'" comment="Paranid Civil War"/>
                    </do_if>
                    <do_else>
                      <signal_cue cue="Prerequisites_Trigger_Dal_Conversation"/>
                      <add_player_choice text="{30220,205}" section="dal_paranid_prerequisites_handover" comment="Paranid Civil War"/>
                    </do_else>
                  </actions>
                </cue>

                <cue name="Prerequisites_Trigger_Dal_Call_HQ_Skip_Conversation">
                  <conditions>
                    <event_conversation_next_section actor="$DalBusta" section="dal_prerequisites_hq_skip"/>
                  </conditions>
                  <actions>
                    <cancel_cue cue="Prerequisites_Trigger_Dal_Call_HQ_Skip_Header"/>

                    <allow_conversation_escape enabled="false"/>

                    <signal_cue_instantly cue="Ch1_Intro" comment="Needs to set all child cues to waiting before Intro_Conversation_Start gets triggered."/>

                    <!-- Setup variables to mimick regular conversation in Chapter 1 -->
                    <do_if value="not $DalIntroSection?">
                      <set_value name="$DalIntroSection" exact="1"/>
                    </do_if>

                    <cancel_cue cue="Intro_Conversation_Header" comment="To prevent the header 'Paranid Civil War' from showing up in the conversation."/>

                    <add_npc_line speaker="$DalBusta" hidechoices="true" line="if player.entity.isfemale then 30200004 else 30200003" comment="Your recent exploits might have opened up a new opportunity for us."/>
                    <add_npc_line speaker="$DalBusta" hidechoices="true" line="if (player.entity.race == race.paranid) then 30220006 else if player.entity.isfemale then 30220005 else 30220004" delay="0.5s" comment="You know, I've always been interested in this seemingly eternal Civil War between the Godrealm and the Holy Order / between your people."/>
                    <add_npc_line speaker="$DalBusta" hidechoices="true" line="if player.entity.isfemale then 30220019 else 30220018" comment="It appears that both of the warring Paranid factions trust you... somewhat."/>

                    <add_player_choice text="readtext.{$Page}.{1101}" position="top_left" section="paranid_intro_main" choiceparam="'smalltalk'" selectable="not $DalSmalltalk_Asked?" comment="What have you been up to?"/>
                    <add_player_choice text="readtext.{$Page}.{1102}" position="right" section="paranid_intro_main" choiceparam="'continue_1'" highlighted="true" comment="You mentioned the Paranid?"/>
                  </actions>
                </cue>

                <cue name="Prerequisites_Trigger_Dal_Call">
                  <delay exact="3min"/>
                  <actions>
                    <do_if value="$HQ? and $DalBusta.hascontext.{$HQ} and (not player.entity.hascontext.{$HQ})">
                      <debug_text text="'Starting Paranid Prerequisites Dal Busta call.'" chance="$DebugChance"/>
                      <play_cutscene key="$DalCutsceneKey.$key" result="this.$CutsceneID" targetmonitor="true">
                        <interaction text="{30220,1004}" param="$DalBusta" param2="'accept_interaction'"/>
                        <param name="npcref" object="$DalBusta" />
                        <param name="room"   object="$DalBusta.room" />
                      </play_cutscene>
                    </do_if>
                    <do_else>
                      <debug_text text="'Dal Busta is not currently at the HQ, or he is and the player is also there. Resetting Paranid Prerequisites Dal Busta call.'" chance="$DebugChance"/>
                      <reset_cue cue="Prerequisites_Trigger_Dal_Call"/>
                    </do_else>
                  </actions>
                  <cues>

                    <cue name="Dal_Call_Speak">
                      <conditions>
                        <event_cutscene_started key="$DalCutsceneKey.$key"/>
                      </conditions>
                      <actions>
                        <signal_cue cue="Dal_Call_No_Interact"/>
                        <speak actor="$DalBusta" priority="100">
                          <text line="if $DalCalled? then (if player.entity.isfemale then 30220017 else 30220016) else (if player.entity.isfemale then 30200002 else 30200001)" delay="0.6s" comment="Hey there partner. / Come on, answer!"/>
                        </speak>
                        <set_value name="$DalCalled"/>
                      </actions>
                    </cue>

                    <!--Accept the call-->
                    <cue name="Dal_Call_Interact">
                      <conditions>
                        <event_player_interaction param="$DalBusta" param2="'accept_interaction'"/>
                      </conditions>
                      <actions>
                        <stop_cutscene cutscene="parent.$CutsceneID"/>
                        <cancel_cue cue="Dal_Call_No_Interact"/>

                        <!-- If the player already has the target relation with both Paranid factions, have Dal invite them directly instead of going through a conversation. -->
                        <do_if value="(faction.paranid.relationto.{faction.player} ge $TargetRelation) and (faction.holyorder.relationto.{faction.player} ge $TargetRelation)">
                          <signal_cue cue="Prerequisites_Trigger_Shortcut_Dal_Speak"/>
                        </do_if>
                        <do_else>
                          <signal_cue cue="Prerequisites_Trigger_Dal_Conversation"/>
                        </do_else>
                      </actions>
                    </cue>

                    <!--Fail to accept the call-->
                    <cue name="Dal_Call_No_Interact">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <delay exact="10s" comment="cutscene timeout"/>
                      <actions>
                        <stop_cutscene cutscene="parent.$CutsceneID"/>
                        <reset_cue cue="parent"/>
                      </actions>
                    </cue>

                  </cues>
                </cue>

              </cues>
            </cue>

            <cue name="Prerequisites_Trigger_Shortcut_Dal_Speak">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <cues>
                <cue name="Ch0_Speak_Dal_004_Ref" ref="md.LIB_Dialog.Speak_Actor">
                  <param name="Actor"             value="$DalBusta"/>
                  <param name="CutsceneKey"       value="$DalCutsceneKey"/>
                  <param name="Lines"             value="[[if player.entity.isfemale then 30200004 else 30200003],[if (player.entity.race == race.paranid) then 30220006 else if player.entity.isfemale then 30220005 else 30220004],[if player.entity.isfemale then 30220019 else 30220018, 0.5s],[if player.entity.isfemale then 30200011 else 30200010]]"/>
                  <param name="EndSignalCue"      value="Prerequisites_Trigger_Shortcut_Dal_Speak_Finished"/>
                  <!--
                          Your recent exploits might have opened up a new opportunity for us.
                          You know, I've always been interested in this seemingly eternal Civil War between the Godrealm and the Holy Order / between your people.
                          It appears that both of the warring Paranid factions trust you... somewhat.
                          If you want to help me dig deeper, come and find me at our Headquarters.
                            -->
                </cue>
                <cue name="Prerequisites_Trigger_Shortcut_Dal_Speak_Finished">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <signal_cue cue="Ch1_Intro"/>
                  </actions>
                </cue>
              </cues>
            </cue>

            <cue name="Prerequisites_Trigger_Dal_Conversation">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <do_if value="not player.isinconversation">
                  <start_conversation actor="$DalBusta" conversation="dal_paranid_prerequisites" priority="100"/>
                </do_if>
              </actions>
              <cues>

                <cue name="Prerequisites_Dal_Conversation_Start">
                  <conditions>
                    <check_any>
                      <event_conversation_next_section actor="$DalBusta" section="dal_paranid_prerequisites_handover"/>
                      <event_conversation_started actor="$DalBusta" conversation="dal_paranid_prerequisites"/>
                    </check_any>
                  </conditions>
                  <actions>
                    <do_if value="Prerequisites_Trigger_Dal_Call_HQ_Skip_Header.state == cuestate.waiting">
                      <cancel_cue cue="Prerequisites_Trigger_Dal_Call_HQ_Skip_Header"/>
                    </do_if>

                    <add_npc_line line="if player.entity.isfemale then 30200004 else 30200003" hidechoices="true" delay="0.5s" comment="Your recent exploits might have opened up a new opportunity for us."/>

                    <add_player_choice position="top_right" text="{30220,201}" section="paranid_prerequisites_followup" choiceparam="'continue'" highlighted="true" comment="And what might that be?"/>
                    <add_player_choice position="bottom_right" text="{30220,202}" section="paranid_prerequisites_abort" highlighted="true" comment="I'm not interested."/>
                  </actions>
                </cue>

                <cue name="Prerequisites_Dal_Conversation_Section_Followup">
                  <conditions>
                    <event_conversation_next_section actor="$DalBusta" section="paranid_prerequisites_followup"/>
                  </conditions>
                  <actions>
                    <debug_text text="'Dal conversation choice made.'" chance="$DebugChance"/>

                    <allow_conversation_escape enabled="false"/>

                    <do_if value="event.param2 == 'continue'">
                      <add_npc_line line="if player.entity.isfemale then 30220002 else 30220001" delay=" 0.5s" hidechoices="true" comment="It seems that you're on awfully friendly terms with one of the Paranid factions."/>

                      <do_if value="player.entity.race == race.paranid">
                        <debug_text text="'Playing Paranid optional line 1.'" chance="$DebugChance"/>
                        <add_npc_line line="30220003" delay="0.5s" hidechoices="true" comment="Granted, that's not so surprising given that you're a Paranid yourself." />
                        <debug_text text="'Playing Paranid optional line 2.'" chance="$DebugChance"/>
                        <add_npc_line line="30220006" delay="1s" hidechoices="true" comment="You know, I've always been interested in this seemingly eternal Civil War between your people."/>
                      </do_if>

                      <do_else>
                        <debug_text text="'Playing non-Paranid line.'" chance="$DebugChance"/>
                        <add_npc_line line="if player.entity.isfemale then 30220005 else 30220004" hidechoices="true" comment="You know, I've always been interested in this seemingly eternal Civil War between the Godrealm and the Holy Order." delay="1s"/>
                      </do_else>

                      <add_npc_line line="if player.entity.isfemale then 30220008 else 30220007" hidechoices="true" comment="If you want to help me dig deeper, you'll have to improve your relations with both warring parties."/>

                      <add_player_choice position="top_right" section="paranid_prerequisites_accept" text="{30220,203}" highlighted="true" comment="Consider it done."/>
                      <add_player_choice position="bottom_right" section="paranid_prerequisites_abort" text="{30220,202}" highlighted="true" comment="I'm not interested."/>
                    </do_if>

                    <do_elseif value="event.param2 == 'abort'">
                      <signal_cue_instantly cue="Prerequisites_Mission_Aborted"/>
                    </do_elseif>
                  </actions>
                </cue>

                <cue name="Prerequisites_Dal_Conversation_Section_Abort">
                  <conditions>
                    <event_conversation_next_section actor="$DalBusta" section="paranid_prerequisites_abort"/>
                  </conditions>
                  <actions>
                    <add_npc_line line="30200005" hidechoices="true" delay="0.5s" comment="That's too bad."/>
                    <add_npc_line line="if player.entity.isfemale then 30200007 else 30200006" hidechoices="true" comment="You can always come and find me if you change your mind."/>
                    <set_value name="$PrerequisitesIntroConversationFinished" exact="true"/>
                  </actions>
                </cue>

                <cue name="Prerequisites_Dal_Conversation_Escape">
                  <conditions>
                    <event_conversation_finished actor="$DalBusta" outcome="g_cancel"/>
                  </conditions>
                  <cues>
                    <cue name="Prerequisites_Dal_Conversation_Escape_Cutscene_Speak" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$DalBusta"/>
                      <param name="CutsceneKey"       value="$DalCutsceneKey"/>
                      <!--
                      That's too bad.
                      You can always come and find me if you change your mind.-->
                      <param name="Lines"             value="[[30200005, 0.5s], [if player.entity.isfemale then 30200007 else 30200006]]"/>
                      <param name="EndSignalCue"      value="Prerequisites_Dal_Conversation_Escape_Cutscene_Speak_Finished"/>
                    </cue>
                    <cue name="Prerequisites_Dal_Conversation_Escape_Cutscene_Speak_Finished">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <set_value name="$PrerequisitesIntroConversationFinished" exact="true"/>
                      </actions>
                    </cue>
                  </cues>
                </cue>

                <cue name="Prerequisites_Dal_Conversation_Section_Accept">
                  <conditions>
                    <event_conversation_next_section actor="$DalBusta" section="paranid_prerequisites_accept"/>
                  </conditions>
                  <actions>
                    <add_npc_line line="30220359" hidechoices="true" delay="0.5s" comment="Nice!"/>
                    <set_value name="$PrerequisitesIntroConversationFinished" exact="true"/>
                    <signal_cue cue="Prerequisites_Mission_Accepted"/>
                  </actions>
                </cue>

              </cues>
            </cue>

            <cue name="Prerequisites_Dal_HQ_Conversation_Main_Menu">
              <conditions>
                <event_conversation_started actor="$DalBusta"/>
                <check_value value="$HQ? and $DalBusta.hascontext.{$HQ} and player.entity.hascontext.{$HQ}"/>
                <check_value value="$PrerequisitesMissionRunning == false"/>
                <check_value value="$PrerequisitesIntroConversationFinished == true"/>
              </conditions>
              <actions>
                <add_player_choice text="{30220,205}" section="paranid_story_menu" comment="(Dal Busta HQ Conversation Paranid Story Menu)Paranid Civil War"/>
              </actions>
              <cues>

                <cue name="Dal_HQ_Conversation_Mission_Offer">
                  <conditions>
                    <event_conversation_next_section actor="$DalBusta" section="paranid_story_menu"/>
                    <check_value value="$HQ? and $DalBusta.hascontext.{$HQ} and player.entity.hascontext.{$HQ}"/>
                  </conditions>
                  <actions>
                    <allow_conversation_escape enabled="false"/>

                    <add_npc_line speaker="$DalBusta" line="if player.entity.isfemale then 30200009 else 30200008" hidechoices="true" comment="Did curiosity get the better of you?"/>

                    <add_player_choice position="left"         section="paranid_story_explanation"                                      text="{30220,206}"  comment="What is this about?"/>
                    <add_player_choice position="top_right"    section="paranid_HQ_offer_end" highlighted="true" choiceparam="'accept'" text="{30220,2105}" comment="Just tell me what to do."/>

                    <add_player_choice position="bottom_right" section="paranid_HQ_offer_end" highlighted="true" choiceparam="'abort'"  text="{30220,204}"  comment="Not really."/>
                  </actions>
                </cue>

                <cue name="Dal_HQ_Conversation_Explanation">
                  <conditions>
                    <event_conversation_next_section actor="$DalBusta" section="paranid_story_explanation"/>
                    <check_value value="$HQ? and $DalBusta.hascontext.{$HQ} and player.entity.hascontext.{$HQ}"/>
                  </conditions>
                  <actions>
                    <allow_conversation_escape enabled="false"/>

                    <add_npc_line line="if player.entity.isfemale then 30220002 else 30220001" delay=" 0.5s" hidechoices="true" comment="It seems that you're on awfully friendly terms with one of the Paranid factions."/>

                    <do_if value="player.entity.race == race.paranid">
                      <debug_text text="'Playing Paranid optional line 1.'" chance="$DebugChance"/>
                      <add_npc_line line="30220003" delay="0.5s" hidechoices="true" comment="Granted, that's not so surprising given that you're a Paranid yourself." />
                      <debug_text text="'Playing Paranid optional line 2.'" chance="$DebugChance"/>
                      <add_npc_line line="30220006" delay="1s" hidechoices="true" comment="You know, I've always been interested in this seemingly eternal Civil War between your people."/>
                    </do_if>
                    <do_else>
                      <debug_text text="'Playing non-Paranid line.'" chance="$DebugChance"/>
                      <add_npc_line line="if player.entity.isfemale then 30220005 else 30220004" hidechoices="true" comment="You know, I've always been interested in this seemingly eternal Civil War between the Godrealm and the Holy Order." delay="1s"/>
                    </do_else>

                    <add_npc_line line="if player.entity.isfemale then 30220008 else 30220007" hidechoices="true" comment="If you want to help me dig deeper, you'll have to improve your relations with both warring parties."/>

                    <add_player_choice position="top_right"    section="paranid_HQ_offer_end" highlighted="true" choiceparam="'accept'" text="{30220,203}"  comment="Consider it done."/>
                    <add_player_choice position="bottom_right" section="paranid_HQ_offer_end" highlighted="true" choiceparam="'abort'"  text="{30220,202}"  comment="I'm not interested."/>
                  </actions>
                </cue>

                <cue name="Dal_HQ_Conversation_Mission_Offer_Display_Briefing">
                  <conditions>
                    <event_conversation_next_section section="paranid_HQ_offer_end"/>
                  </conditions>
                  <actions>
                    <do_if value="event.param2 == 'accept'">
                      <debug_text text="'Player accepted prerequisite mission from Dal at HQ.'" chance="$DebugChance"/>
                      <add_npc_line line="30220359" hidechoices="true" comment="Nice!"/>
                      <signal_cue cue="Prerequisites_Mission_Accepted"/>
                    </do_if>
                    <do_elseif value="event.param2 == 'abort'">
                      <debug_text text="'Player declined prerequisite mission from Dal at HQ.'" chance="$DebugChance"/>
                      <do_if value="not $PrerequisitesAbortedAlready?">
                        <add_npc_line line="30200005" hidechoices="true" comment="That's too bad."/>
                        <set_value name="$PrerequisitesAbortedAlready"/>
                      </do_if>
                      <do_elseif value="$PrerequisitesAbortedAlready == 2">
                        <debug_text text="'Player aborted the prerequisites mission twice already, so Dal just mumbles.'" chance="$DebugChance"/>
                        <add_npc_line line="1001" hidechoices="true" comment="*** Muttering ***"/>
                      </do_elseif>
                      <do_else>
                        <debug_text text="'Player aborted the prerequisites mission once already.'" chance="$DebugChance"/>
                        <add_npc_line line="if player.entity.isfemale then 30220015 else 30220014" hidechoices="true" comment="Now you're just being silly."/>
                        <set_value name="$PrerequisitesAbortedAlready" operation="add"/>
                      </do_else>
                    </do_elseif>
                  </actions>
                </cue>

                <cue name="Dal_HQ_Conversation_Finished">
                  <conditions>
                    <event_conversation_finished actor="$DalBusta"/>
                  </conditions>
                  <actions>
                    <reset_cue cue="Prerequisites_Dal_HQ_Conversation_Main_Menu"/>
                  </actions>
                </cue>

              </cues>
            </cue>

            <cue name="Prerequisites_Mission_Accepted" instantiate="true">
              <conditions>
                <event_cue_signalled/>
                <check_value value="$PrerequisitesMissionRunning == false"/>
              </conditions>
              <actions>
                <set_value name="$PrerequisitesMissionRunning" exact="true"/>

                <!-- If the target reputation changes, reference a different number here -->
                <substitute_text text="$Prerequisites_Description_Detail_1" source="readtext.{30220}.{305}">
                  <replace string="'$FACTION$'" with="readtext.{20203}.{401}" comment="Godrealm of the Paranid"/>
                  <replace string="'$REPUTATION$'" with="faction.paranid.relation.{$TargetRelation}.uivalue"/>
                </substitute_text>
                <substitute_text text="$Prerequisites_Description_Detail_2" source="readtext.{30220}.{305}">
                  <replace string="'$FACTION$'" with="readtext.{20203}.{501}" comment="Holy Order of the Pontifex"/>
                  <replace string="'$REPUTATION$'" with="faction.holyorder.relation.{$TargetRelation}.uivalue"/>
                </substitute_text>

                <set_value name="$Prerequisites_Description" exact="(if player.entity.isfemale then readtext.{$Page}.{306} else readtext.{$Page}.{302}) + '\n\n' + readtext.{$Page}.{304} + '\n' + $Prerequisites_Description_Detail_1 + '\n' + $Prerequisites_Description_Detail_2"/>

                <create_mission cue="$MissionCue" name="{30220,301}" description="$Prerequisites_Description" rewardtext="{30220,303}" type="missiontype.plot" faction="faction.player" difficulty="level.medium" abortable="true" icon="'briefing_dal_busta_01'" iconcaption="$DalBusta.name">
                  <briefing>
                    <objective step="1" action="objective.gain_reputation" text="{20203,401}" comment="Gain Reputation: Godrealm of the Paranid"/>
                    <objective step="2" action="objective.gain_reputation" text="{20203,501}" comment="Gain Reputation: Holy Order of the Pontifex"/>
                  </briefing>
                </create_mission>

                <do_if value="faction.paranid.relationto.{player.entity} lt $TargetRelation">
                  <set_objective_from_briefing cue="$MissionCue" step="1"/>
                </do_if>
                <do_elseif value="faction.holyorder.relationto.{player.entity} lt $TargetRelation">
                  <set_objective_from_briefing cue="$MissionCue" step="2"/>
                </do_elseif>
                <do_else>
                  <signal_cue cue="Prerequisites_Mission_Debriefing"/>
                </do_else>
              </actions>
              <cues>

                <!-- Once the relation objective with one faction is completed, switch objective to the other faction, unless both are already completed -->
                <cue name="Prerequisites_Mission_Check_Relation" instantiate="true">
                  <conditions>
                    <check_any>
                      <event_player_relation_changed faction="faction.paranid"/>
                      <event_player_relation_changed faction="faction.holyorder"/>
                    </check_any>
                    <check_value value="not event.object" comment="only permanent changes are relevant"/>
                    <check_value value="(event.param2.{1} ge $TargetRelation) and (event.param2.{2} lt $TargetRelation)"/>
                  </conditions>
                  <actions>
                    <do_if value="(event.param == faction.paranid) and (faction.holyorder.relationto.{player.entity} lt $TargetRelation)">
                      <set_objective_from_briefing cue="$MissionCue" step="2"/>
                    </do_if>
                    <do_elseif value="(event.param == faction.holyorder) and (faction.paranid.relationto.{player.entity} lt $TargetRelation)">
                      <set_objective_from_briefing cue="$MissionCue" step="1"/>
                    </do_elseif>
                    <do_else>
                      <signal_cue cue="Prerequisites_Mission_Debriefing"/>
                    </do_else>
                  </actions>
                </cue>

                <cue name="Prerequisites_Mission_Aborted">
                  <conditions>
                    <event_mission_aborted cue="$MissionCue"/>
                  </conditions>
                  <actions>
                    <debug_text text="'Player aborted Paranid Story Prerequisites Mission.'"/>
                    <set_value name="$PrerequisitesMissionRunning" exact="false"/>
                    <remove_mission cue="$MissionCue"/>
                  </actions>
                  <delay exact="0.5s" comment="Required to signal a child cue."/>
                  <actions>
                    <signal_cue cue="Prerequisites_Mission_Aborted_Dal_Cutscene_Start"/>
                  </actions>
                  <cues>

                    <cue name="Prerequisites_Mission_Aborted_Dal_Cutscene_Start">
                      <conditions>
                        <event_cue_signalled/>
                        <check_value value="$HQ? and $DalBusta.hascontext.{$HQ} and not player.entity.hascontext.{$HQ}"/>
                      </conditions>
                      <actions>
                        <play_cutscene key="$DalCutsceneKey.$key" targetmonitor="true" caption="{10002,23}" result="this.$CutsceneID">
                          <param name="npcref" object="$DalBusta" />
                          <param name="room"   object="$DalBusta.room"/>
                        </play_cutscene>
                      </actions>
                      <cues>
                        <cue name="Prerequisites_Mission_Aborted_Dal_Cutscene_Speak">
                          <delay exact="1s"/>
                          <actions>
                            <speak actor="$DalBusta" priority="100">
                              <text line="30200005" comment="That's too bad."/>
                              <text line="if player.entity.isfemale then 30200007 else 30200006" comment="You can always come and find me if you change your mind."/>
                            </speak>
                          </actions>
                        </cue>
                        <cue name="Prerequisites_Mission_Aborted_Dal_Cutscene_Stop">
                          <conditions>
                            <event_speak_finished actor="$DalBusta" line="30200005"/>
                          </conditions>
                          <delay exact="1s"/>
                          <actions>
                            <stop_cutscene cutscene="parent.$CutsceneID"/>
                          </actions>
                        </cue>
                      </cues>
                    </cue>

                  </cues>
                </cue>

              </cues>
            </cue>

            <cue name="Prerequisites_Mission_Debriefing">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <cues>

                <!--Call from Dal Busta-->
                <cue name="Prerequisites_Mission_Debriefing_Call">
                  <cues>

                    <cue name="Prerequisites_Mission_Debriefing_Call_Interact">
                      <delay exact="10s"/>
                      <actions>
                        <signal_cue cue="Prerequisites_Mission_Debriefing_Call_Interact_Dal_Speak"/>
                      </actions>
                    </cue>

                    <cue name="Prerequisites_Mission_Debriefing_Call_Interact_Dal_Speak">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <cues>
                        <cue name="Ch0_Speak_Dal_988_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$DalBusta"/>
                          <param name="CutsceneKey"       value="$DalCutsceneKey"/>
                          <param name="Lines"             value="[[if player.entity.isfemale then 30220019 else 30220018],[if player.entity.isfemale then 30200011 else 30200010, 0.5s]]"/>
                          <param name="EndSignalCue"      value="Prerequisites_Mission_Debriefing_Handover"/>
                          <!--
                              It appears that both of the warring Paranid factions trust you... somewhat.
                              If you want to help me dig deeper, come and find me at our Headquarters.
                            -->
                        </cue>
                      </cues>
                    </cue>

                  </cues>
                </cue>

                <cue name="Prerequisites_Mission_Debriefing_Handover">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <remove_mission cue="$MissionCue" type="completed"/>
                    <write_to_logbook category="missions" faction="faction.player" title="{30220,301}" text="if player.entity.isfemale then {30220,308} else {30220,307}"/>
                    <signal_cue cue="Ch1_Intro"/>
                  </actions>
                </cue>

              </cues>
            </cue>

          </cues>
        </cue>

        <!-- Chapter 1: Get an intro to the Paranid story from Dal Busta -->

        <cue name="Ch1_Force">
          <force name="Plot_Paranid_Ch1">
            <signal_cue_instantly cue="Debug_Add_Prerequisites"/>
            <signal_cue_instantly cue="Force_Chapter" param="Ch1_Intro"/>
          </force>
        </cue>

        <cue name="Ch1_Intro">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <debug_text text="'Starting Chapter ' + this" chance="$DebugChance"/>
            <set_value name="$CurrentChapterCue" exact="this"/>
          </actions>
          <cues>

            <!--Trigger mission by reaching relation threshold-->
            <cue name="Intro_Initiate">
              <actions>
                <cancel_cue cue="Ch0_Prerequisites" comment="Cancel all cutscene, conversation and relation change listeners."/>

                <create_mission cue="$MissionCue" name="{30220,1001}" description="if player.entity.isfemale then {30220,1005} else {30220,1002}" rewardtext="{30220,1006}" type="missiontype.plot" faction="faction.player" difficulty="level.medium" abortable="false" icon="'briefing_dal_busta_01'" iconcaption="$DalBusta.name">
                  <briefing>
                    <objective step="1" action="objective.talkto" object="$DalBusta" text="{30220,1003}" comment="Your trusted friend, Dal Busta"/>
                  </briefing>
                </create_mission>
              </actions>
              <cues>

                <cue name="Intro_Update_Mission">
                  <actions>
                    <!--TEMP: Connect mission target to the universe and set objective-->
                    <signal_cue_instantly cue="md.GenericMissions.DisconnectedActorObjectiveLibrary" param="table[
                                              $actor = $DalBusta,
                                              $object = $HQ,
                                              $missioncue = $MissionCue,
                                              $cancelcue = Ch2_Informant,
                                              $libfailedcue = null,
                                              $objective = objective.talkto,
                                              $debugchance = $DebugChance]"/>

                    <signal_cue_instantly cue="Intro_Conversation"/>
                  </actions>
                </cue>

                <!--Unlocks the conversation-->
                <cue name="Intro_Conversation">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <debug_text text="'Intro conversation with Dal Busta now available'" chance="$DebugChance"/>
                  </actions>
                  <cues>

                    <cue name="Intro_Conversation_Header" instantiate="true">
                      <conditions>
                        <event_conversation_started actor="$DalBusta"/>
                        <check_value value="$HQ? and $DalBusta.hascontext.{$HQ} and player.entity.hascontext.{$HQ}"/>
                        <check_value value="Ch2_Informant.state == cuestate.waiting"/>
                      </conditions>
                      <actions>
                        <!--Only greet the first time-->
                        <do_if value="not $DalGreeted?">
                          <add_npc_line speaker="$DalBusta" line="if player.entity.isfemale then 30220104 else 30220103" hidechoices="true" comment="You made it!"/>
                          <set_value name="$DalGreeted" exact="true"/>
                        </do_if>

                        <add_player_choice text="{30220,205}" section="paranid_intro_main" comment="Paranid Civil War"/>
                      </actions>
                    </cue>

                    <cue name="Intro_Conversation_Start" instantiate="true">
                      <conditions>
                        <check_any>
                          <event_conversation_next_section actor="$DalBusta" section="paranid_intro_main"/>
                        </check_any>
                        <check_value value="$HQ? and $DalBusta.hascontext.{$HQ} and player.entity.hascontext.{$HQ}"/>
                      </conditions>
                      <actions>
                        <cancel_cue cue="Intro_Conversation_Header"/>

                        <allow_conversation_escape enabled="false"/>

                        <do_if value="not $DalIntroSection?">
                          <set_value name="$DalIntroSection" exact="1"/>
                        </do_if>

                        <!-- Initial options at part 1 -->
                        <do_if value="event.param2 == 'smalltalk'">
                          <set_value name="$DalSmalltalk_Asked" exact="true"/>
                          <add_npc_line speaker="$DalBusta" line="30220105" hidechoices="true" comment="Listening to broadcasts and spending quality time with my charts, for the most part."/>
                          <add_npc_line speaker="$DalBusta" line="30220106" hidechoices="true" comment="And, of course, watching Boso Ta bathe in that overgrown fish-tank."/>
                          <add_npc_line speaker="$DalBusta" line="if player.entity.isfemale then 30220108 else 30220107" hidechoices="true" comment="Did you know that senior Boron scientists can still order their personal assistants around while half their brain is asleep?"/>
                          <add_npc_line speaker="$BosoTa" line="30220101" hidechoices="true" comment="(annoyed)It feels as if my hospitality is not being reciprocated to an adequate degree."/>
                          <add_npc_line speaker="$BosoTa" line="30220102" hidechoices="true" comment="(annoyed, addressing male NPC)And I must say, your pseudo-scientific blustering is starting to get on my..."/>
                          <add_npc_line speaker="$DalBusta" line="30220109" hidechoices="true" comment="Nature truly is fascinating."/>
                        </do_if>
                        <do_elseif value="event.param2 == 'continue_1'">
                          <set_value name="$DalIntroSection" exact="2"/>
                          <add_npc_line speaker="$DalBusta" line="if player.entity.isfemale then 30220111 else 30220110" hidechoices="true" comment="(emphasis on 'they' and 'you')Actually, they mentioned you."/>
                          <add_npc_line speaker="$DalBusta" line="30220112" hidechoices="true" comment="We're only a few jumps away from Paranid space, and this station's comms module is unlike anything I've come across."/>
                          <add_npc_line speaker="$BosoTa" line="30220103" hidechoices="true" comment="(warningly)I believe I already mentioned several times that this outpost was abandoned by the Terrans, a civilisation so unfathomably advanced and ingenious that they managed to nearly wipe themselves out on multiple occasions."/>
                          <add_npc_line speaker="$BosoTa" line="30220104" hidechoices="true" comment="(warningly)It is paramount that we explore its integrated functions carefully, delicately, and, most of all, cautiously."/>
                          <add_npc_line speaker="$DalBusta" line="30220113" hidechoices="true" comment="Naturally I had to put its capabilities to the test."/>
                          <add_npc_line speaker="$DalBusta" line="30220114" hidechoices="true" comment="As it turns out, the Godrealm and the Holy Order frequently, and openly, accuse one another of corrupting each other's citizens."/>
                          <!--<add_npc_line speaker="$DalBusta" line="30220115" hidechoices="true" comment="They would never allow a foreign government to accept the other faction as legitimate."/>-->
                          <add_npc_line speaker="$DalBusta" line="30220116" hidechoices="true" comment="However, they're surprisingly reluctant to condemn independent individuals, much less those who simply want the best of both worlds."/>
                          <add_npc_line speaker="$DalBusta" line="if player.entity.isfemale then 30220118 else 30220117" hidechoices="true" comment="If you know what I'm saying."/>
                        </do_elseif>

                        <!-- New highlighted option at part 2 -->
                        <do_elseif value="event.param2 == 'continue_2'">
                          <set_value name="$DalIntroSection" exact="3"/>
                          <add_npc_line speaker="$DalBusta" line="30220119" hidechoices="true" comment="What I'm getting at is this: there's more to this whole civil war thing than meets the eye."/>
                          <add_npc_line speaker="$DalBusta" line="if player.entity.isfemale then 30220121 else 30220120" hidechoices="true" comment="For whatever reason, those Paranid don't seem to view you as an intruder, and that, my friend, is an opportunity if I've ever seen one!"/>
                          <add_npc_line speaker="$DalBusta" line="if player.entity.isfemale then 30220123 else 30220122" hidechoices="true" comment="Of course, those uptight zealots might change their minds once you start snooping around."/>
                          <add_npc_line speaker="$DalBusta" line="30220124" hidechoices="true" comment="Hopefully we can mitigate that risk by knowing where to stick our noses, and where (emphasize 'not')not to stick them, from the start."/>
                          <add_npc_line speaker="$DalBusta" line="30220125" hidechoices="true" comment="Luckily I have an informant who might be able to point us in the right direction."/>
                        </do_elseif>

                        <!-- Optional lines unlocked at part 3 -->
                        <do_elseif value="event.param2 == 'informant'">
                          <set_value name="$DalInformant_Asked" exact="true"/>
                          <add_npc_line speaker="$DalBusta" line="30220126" hidechoices="true" comment="An old, and I do mean old, acquaintance of mine."/>
                          <add_npc_line speaker="$DalBusta" line="30220127" hidechoices="true" comment="Knowing her, she's probably been enjoying a grandstand view of the war since it started."/>
                          <add_npc_line speaker="$DalBusta" line="if player.entity.isfemale then 30220129 else 30220128" hidechoices="true" comment="You'll be hard-pressed to find anyone who knows quite as much as she does about that unpleasant situation."/>
                        </do_elseif>

                        <!-- Highlighted options let the conversation progress -->
                        <do_if value="$DalIntroSection == 1">
                          <add_player_choice text="readtext.{$Page}.{1101}" position="top_left" section="paranid_intro_main" choiceparam="'smalltalk'" selectable="not $DalSmalltalk_Asked?" comment="What have you been up to?"/>
                          <add_player_choice text="readtext.{$Page}.{1102}" position="right" section="paranid_intro_main" choiceparam="'continue_1'" highlighted="true" comment="You mentioned the Paranid?"/>
                        </do_if>
                        <do_elseif value="$DalIntroSection == 2">
                          <add_player_choice text="readtext.{$Page}.{1101}" position="top_left" section="paranid_intro_main" choiceparam="'smalltalk'" selectable="not $DalSmalltalk_Asked?" comment="What have you been up to?"/>
                          <add_player_choice text="readtext.{$Page}.{1103}" position="right" section="paranid_intro_main" choiceparam="'continue_2'" highlighted="true"  comment="Get to the point."/>
                        </do_elseif>
                        <do_elseif value="$DalIntroSection == 3">
                          <add_player_choice text="readtext.{$Page}.{1101}" position="top_left" section="paranid_intro_main" choiceparam="'smalltalk'" selectable="not $DalSmalltalk_Asked?" comment="What have you been up to?"/>
                          <add_player_choice text="readtext.{$Page}.{1104}" position="bottom_left" section="paranid_intro_main" choiceparam="'informant'" selectable="not $DalInformant_Asked?" comment="Who is this informant?"/>
                          <add_player_choice text="readtext.{$Page}.{1105}" position="right" section="paranid_intro_accept" highlighted="true" comment="What do I need to do?"/>
                        </do_elseif>
                      </actions>
                    </cue>

                    <cue name="Intro_Conversation_Accept_Mission">
                      <conditions>
                        <event_conversation_next_section actor="$DalBusta" section="paranid_intro_accept"/>
                      </conditions>
                      <actions>
                        <cancel_cue cue="Intro_Conversation"/>
                        <signal_cue cue="Intro_Outro_Speaks"/>
                        <remove_mission cue="$MissionCue" type="completed"/>
                        <write_to_logbook category="missions" faction="faction.player" title="{30220,1001}" text="if player.entity.isfemale then {30220,1008} else {30220,1007}"/>
                        <signal_cue cue="Ch2_Informant"/>
                      </actions>
                    </cue>

                  </cues>
                </cue>

                <cue name="Intro_Outro_Speaks">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <speak actor="$DalBusta" priority="100">
                      <text line="if player.entity.isfemale then 30220131 else 30220130" comment="Head over to Nopileos' Fortune; it's only one system away."/>
                      <text line="30220132"                                              comment="There's an old meeting-point under the highway where we used to trade gossip about the local syndicates."/>
                      <text line="if player.entity.isfemale then 30220134 else 30220133" comment="Don't be put off by her... (slight pause before 'unconventional')unconventional demeanor."/>
                      <text line="if player.entity.isfemale then 30220136 else 30220135" comment="She's not exactly quick to trust people, but once you've passed muster she'll be your most dependable ally."/>
                    </speak>

                  </actions>
                </cue>

                <cue name="Intro_Outro_Speaks_2">
                  <conditions>
                    <check_any>
                      <event_speak_finished actor="$DalBusta" line="30220130"/>
                      <event_speak_finished actor="$DalBusta" line="30220131"/>
                    </check_any>
                  </conditions>
                  <actions>
                    <speak actor="$BosoTa" priority="100">
                      <text line="30220105" comment="Other than..."/>
                    </speak>
                  </actions>
                </cue>

                <cue name="Intro_Outro_Speaks_3">
                  <conditions>
                    <event_speak_finished actor="$BosoTa" line="30220105"/>
                  </conditions>
                  <actions>
                    <speak actor="$DalBusta" priority="100">
                      <text line="30220137" comment="Other than me, of course."/>
                    </speak>
                  </actions>
                </cue>

              </cues>
            </cue>

          </cues>
        </cue>

        <!-- Chapter 2: Contact the Informant -->

        <cue name="Ch2_Force">
          <force name="Plot_Paranid_Ch2">
            <signal_cue_instantly cue="Force_Chapter" param="Ch2_Informant"/>
          </force>
        </cue>

        <cue name="Ch2_Informant">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <debug_text text="'Starting Chapter ' + this" chance="$DebugChance"/>
            <set_value name="$CurrentChapterCue" exact="this"/>

            <find_sector name="$Chapter2_Sector" macro="macro.cluster_04_sector001_macro" comment="Nopileos' Fortune II"/>

            <!--Mission guidance target area, needs to be centered under the highway-->
            <set_value name="$TargetRadius" exact="60km"/>
            <create_position name="$TargetOffset" x="257392.906" y="-5684.676" z="138867.469"/>

            <!--Actual ship position, offset randomly-->
            <set_value name="$DecoyX" min="$TargetOffset.x - 10km" max="$TargetOffset.x + 10km"/>
            <set_value name="$DecoyY" min="$TargetOffset.y - 2km"  max="$TargetOffset.y + 4km"/>
            <set_value name="$DecoyZ" min="$TargetOffset.z - 10km" max="$TargetOffset.z + 10km"/>

            <!--Pilotless Buccaneer Decoy Ship-->
            <create_ship name="$BuccaneerDecoyShip" macro="ship_arg_s_fighter_01_b_macro" capturable="true" mission="true" sector="$Chapter2_Sector">
              <owner exact="faction.ownerless"/>
              <loadout>
                <level exact="0.7"/>
              </loadout>
              <paint ware="ware.paintmod_0103"/>
              <!--somewhat close to highway-->
              <position x="$DecoyX" y="$DecoyY" z="$DecoyZ"/>
              <rotation yaw="-163.54324deg" pitch="-26.09368deg"/>
            </create_ship>

            <signal_objects object="player.galaxy" param="'Cover'" param2="[$BuccaneerDecoyShip, faction.buccaneers, true, true]"/>

            <set_object_radar_visible object="$BuccaneerDecoyShip" visible="false"/>

            <set_object_min_hull object="$BuccaneerDecoyShip" exact="20"/>

            <!--Buccaneer Flagship-->
            <create_position name="$Buccaneer_Flagship_Position" x="$TargetOffset.x" y="$TargetOffset.y - 20km" z="$TargetOffset.z + 20km"/>
            <signal_cue_instantly cue="Setup_Create_Buccaneer_Flagship" param="table[ $sector = $Chapter2_Sector, $position = $Buccaneer_Flagship_Position, $invulnerable = true, $radarvisible = false ]"/>

            <create_order id="'Wait'" object="$BuccaneerFlagship" default="true"/>

            <create_mission cue="$MissionCue" name="{30220,2001}" description="if player.entity.isfemale then {30220,2012} else {30220,2002}" rewardtext="{30220,2013}" type="missiontype.plot" faction="faction.player" difficulty="level.medium" abortable="false" icon="'briefing_dal_busta_01'" iconcaption="$DalBusta.name">
              <briefing>
                <objective step="1" action="objective.find"     text="{30220,2003}" comment="Find: Dal Busta's informant"/>
                <objective step="2" action="objective.collect"  text="{30220,2004}" comment="Collect: Information on the Paranid"/>
              </briefing>
            </create_mission>
          </actions>
          <cues>

            <cue name="Informant_Find">
              <actions>
                <debug_text text="'Starting Chapter 2, part 1: Find the informant.'" chance="$DebugChance"/>
                <set_value name="$CurrentStep" exact="1"/>
                <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.flyto" object="$Chapter2_Sector" radius="$TargetRadius" offset="$TargetOffset" text="{30220,2005}" updatebriefing="true" comment="Fly to: Rendezvous Point"/>
              </actions>
              <cues>

                <cue name="Ch2_Story_Reminder">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <cues>
                    <cue name="Ch2_Story_Reminder_Ref" ref="Story_Reminder">
                      <param name="Actor"       value="$DalBusta"/>
                      <param name="CutsceneKey" value="$DalCutsceneKey"/>
                      <param name="Lines"       value="[[if player.entity.isfemale then 30200002 else 30200001],[if player.entity.isfemale then 30200106 else 30200105]]"/>
                      <param name="CancelCue"   value="Find_Approach_Search_Area_Dal_Speak"/>
                      <param name="Delay"       value="25min"/>
                      <!--  <t id="30200001">Hey there partner.</t>
                            <t id="30200002">(spoken to female player){10111,30200001}</t>
                            <t id="30200105">Don't keep our contact waiting for too long.</t>
                            <t id="30200106">(spoken to female player){,30200105}</t>  -->
                    </cue>
                  </cues>
                </cue>

                <cue name="Find_Approach_Search_Area">
                  <actions>
                    <signal_cue cue="Ch2_Story_Reminder"/>
                  </actions>
                  <cues>
                    <cue name="Find_Approach_Search_Area_Ref" ref="md.LIB_Generic.ApproachLocation_Handler">
                      <param name="ApproachSector"    value="$Chapter2_Sector"/>
                      <param name="ApproachOffset"    value="$TargetOffset"/>
                      <param name="ApproachDistance"  value="$TargetRadius + 100km"/>
                      <param name="SuccessSignalCue"  value="Find_Approach_Search_Area_Dal_Speak"/>
                    </cue>
                    <cue name="Find_Approach_Search_Area_Dal_Speak">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <set_object_radar_visible object="$BuccaneerDecoyShip" visible="true"/>
                      </actions>
                      <cues>
                        <cue name="Ch2_Speak_Dal_301_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$DalBusta"/>
                          <param name="CutsceneKey"       value="$DalCutsceneKey"/>
                          <param name="Lines"             value="[[if player.entity.isfemale then 30220202 else 30220201],[30220203, 0.6s]]"/>
                          <param name="EndSignalCue"      value="Find_Approach"/>
                          <!--
                          You're nearing the meeting-point; remember, it's right below the highway.
                          Now, where's that informant got to?
                            -->
                        </cue>
                      </cues>
                    </cue>
                  </cues>
                </cue>

                <!--Start checking for distance etc. once player has reached the search area.
                Automatically reactivate the checks once the player returns to the sector-->
                <cue name="Find_Approach">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <debug_text text="'Activating more precise proximity checks, calling flagship'" chance="$DebugChance"/>
                  </actions>
                  <cues>

                    <cue name="Approach_Decoy_Ship">
                      <cues>
                        <!--Found ship by randomly flying close to it-->
                        <cue name="Approach_Decoy_Ship_Ref" ref="md.LIB_Generic.ApproachObject_Handler">
                          <param name="ApproachTarget"    value="$BuccaneerDecoyShip"/>
                          <param name="ApproachDistance"  value="5km"/>
                          <param name="SuccessSignalCue"  value="Approach_Update_Objective"/>
                        </cue>
                      </cues>
                    </cue>

                    <!--Signal this when the player has found the ship, either via long range scan or by randomly flying close to it -->
                    <cue name="Approach_Update_Objective">
                      <conditions>
                        <check_any>
                          <event_cue_signalled/>
                          <event_long_range_scan_ping object="$BuccaneerDecoyShip"/>
                        </check_any>
                      </conditions>
                      <actions>
                        <!-- If the decoy ship was found via long range scan, stop checks for randomly flying close to it -->
                        <do_if value="event.name == 'event_long_range_scan_ping'">
                          <cancel_cue cue="Approach_Decoy_Ship"/>
                        </do_if>
                        <set_value name="$CurrentStep" exact="1" operation="add"/>
                        <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.approach" text="{30220,2003}" object="$BuccaneerDecoyShip" updatebriefing="true" insert="true" comment="Approach: Dal Busta's Informant"/>
                        <debug_text text="'Cue signalled, objective updated'" chance="$DebugChance"/>
                        <signal_cue cue="Approach_Dal_Speak"/>
                      </actions>
                    </cue>

                    <cue name="Approach_Dal_Speak">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <!-- Make Flagship move closer, so the drones get to the player a bit quicker -->
                        <create_position name="$BuccaneerDecoyShipPosition" object="$BuccaneerDecoyShip" space="$Chapter2_Sector"/>
                        <create_position name="$FlagshipApproachPosition" x="$BuccaneerDecoyShipPosition.x" y="$BuccaneerDecoyShip.position.y - 5km" z="$BuccaneerDecoyShipPosition.z + 10km"/>
                        <signal_cue_instantly cue="Setup_Create_Buccaneer_Flagship" param="table[ $sector = $Chapter2_Sector, $position = $Buccaneer_Flagship_Position, $invulnerable = true, $radarvisible = true ]"/>
                        <cancel_all_orders object="$BuccaneerFlagship"/>
                        <create_order id="'MoveWait'" object="$BuccaneerFlagship" immediate="true">
                          <param name="destination" value="[$Chapter2_Sector, $FlagshipApproachPosition]"/>
                        </create_order>
                      </actions>
                      <cues>
                        <cue name="Ch2_Speak_Dal_204_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$DalBusta"/>
                          <param name="CutsceneKey"       value="$DalCutsceneKey"/>
                          <param name="Lines"             value="[[if player.entity.isfemale then 30220205 else 30220204],[30220206, 2s]]"/>
                          <param name="EndSignalCue"      value="Approach_Dal_Speak_Finished"/>
                          <!--
                                  You seem to have found something.
                                  Hm, the ship ID checks out, but something seems to be.... (short pause before 'off')off.
                                    -->
                        </cue>
                        <cue name="Approach_Dal_Speak_Finished">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <delay exact="2s"/>
                          <actions>
                            <signal_cue cue="Approach_Gride_Speak"/>
                          </actions>
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Approach_Gride_Speak">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <!-- Gride doesn't show herself yet, no target monitor cutscene.-->
                        <speak actor="$GrideActor" priority="100">
                          <text line="30220201" comment="Well, well, how droll."/>
                          <text line="30220202" comment="He's sent me one of his lackeys."/>
                          <text line="if player.entity.isfemale then 30220204 else 30220203" comment="Come a little closer, (emphasize 'lackey')lackey, and we'll have a chat."/>
                        </speak>
                      </actions>
                      <!--<cues>
                        <cue name="Ch2_Speak_Gride_201_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$GrideActor"/>
                          <param name="CutsceneKey"       value="$GrideCutsceneKey"/>
                          <param name="Lines"             value="[[30220201],[30220202],[if player.entity.isfemale then 30220204 else 30220203]]"/>
                          <param name="EndSignalCue"      value="Approach_Activate_Closer_Check"/>
                        </cue>
                      </cues>-->
                    </cue>

                    <cue name="Approach_Activate_Closer_Check">
                      <conditions>
                        <event_speak_finished actor="$GrideActor" line="30220201"/>
                      </conditions>
                      <actions>
                        <debug_text text="'Gride beckoning speak complete, activating closer proximity check'"/>
                      </actions>
                      <cues>

                        <!--Trigger the next scene once player has approached the ship-->
                        <cue name="Approach_Success" checkinterval="1s">
                          <conditions>
                            <check_value value="(player.entity.sector == $Chapter2_Sector) and (player.entity.distanceto.{$BuccaneerDecoyShip} lt 300m)"/>
                          </conditions>
                          <actions>
                            <set_value name="$MainPlayerShip" exact="player.ship"/>
                            <set_value name="$DebugDistance" exact="player.entity.distanceto.{$BuccaneerDecoyShip}"/>
                            <debug_text text="'Distance player to decoy ship: ' + $DebugDistance + '. Starting timer'" chance="$DebugChance"/>
                          </actions>
                          <cues>

                            <!--Start checking for approach again if player leaves close range-->
                            <cue name="Approach_Success_Reset" checkinterval="1s">
                              <conditions>
                                <check_value value="player.entity.distanceto.{$BuccaneerDecoyShip} gt 500m"/>
                              </conditions>
                              <actions>
                                <debug_text text="'Player left vicinity of decoy ship, reactivating approach check'" chance="$DebugChance"/>
                                <reset_cue cue="Approach_Success"/>
                              </actions>
                            </cue>

                            <!--Signal the next cue if player stays in range for a few seconds-->
                            <cue name="Approach_Success_Confirm">
                              <delay exact="3s"/>
                              <actions>
                                <debug_text text="'Player spent enough time close to the decoy ship, has probably stopped'" chance="$DebugChance"/>
                                <!--Cancel distance check-->
                                <do_if value="Approach_Success_Reset.state == cuestate.active">
                                  <cancel_cue cue="Approach_Success_Reset"/>
                                </do_if>

                                <!-- Make Flagship move to the drone drop position -->
                                <create_position name="$DroneDropOffset" x="$BuccaneerDecoyShipPosition.x" y="$BuccaneerDecoyShip.position.y - 5km" z="$BuccaneerDecoyShipPosition.z"/>

                                <signal_cue_instantly cue="Setup_Create_Buccaneer_Flagship" param="table[ $sector = $Chapter2_Sector, $position = $FlagshipApproachPosition, $invulnerable = true, $radarvisible = true ]"/>

                                <cancel_all_orders object="$BuccaneerFlagship"/>

                                <create_order id="'MoveWait'" object="$BuccaneerFlagship" immediate="true">
                                  <param name="destination" value="[$Chapter2_Sector, $DroneDropOffset]"/>
                                </create_order>

                                <!-- Dal is not talking to the player here -->
                                <speak actor="$DalBusta" priority="100">
                                  <text line="30220207" comment="Hey there Gride. Why do you always choose such creepy places to meet?"/>
                                </speak>
                              </actions>
                              <cues>

                                <cue name="Approach_Success_Confirm_Buccaneer_Speak">
                                  <conditions>
                                    <event_speak_finished actor="$DalBusta" line="30220207"/>
                                  </conditions>
                                  <delay exact="1s"/>
                                  <actions>
                                    <!-- Gride is not talking to the player here -->
                                    <speak actor="$GrideActor" priority="100">
                                      <text line="30220205" comment="Let me answer your question with another question, my dear."/>
                                      <text line="30220206" comment="How far would you be willing to go to be sure that your allies were up to scratch?"/>
                                    </speak>
                                  </actions>
                                  <cues>

                                    <cue name="Approach_Success_Confirm_End">
                                      <conditions>
                                        <event_speak_finished actor="$GrideActor" line="30220205"/>
                                      </conditions>
                                      <delay exact="1s"/>
                                      <actions>
                                        <signal_cue cue="Informant_Fight"/>
                                        <cancel_cue cue="Informant_Find"/>
                                      </actions>
                                    </cue>

                                  </cues>
                                </cue>

                              </cues>
                            </cue>

                          </cues>
                        </cue>

                      </cues>
                    </cue>

                  </cues>
                </cue>

              </cues>
            </cue>

            <cue name="Informant_Fight">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <create_group groupname="$BuccaneerDefenceDroneGroup"/>
                <set_value name="$DefenceDroneMacro" exact="macro.ship_gen_s_fightingdrone_01_a_macro"/>

                <play_music music="'music_story_paranid_drone_fight'" comment="128s"/>

                <set_object_min_hull object="$BuccaneerDecoyShip" exact="0"/>
              </actions>
              <cues>

                <cue name="Fight_Music_Handler">
                  <actions>
                  </actions>
                </cue>

                <cue name="Fight_Defuse_Dal_Speak">
                  <cues>
                    <cue name="Fight_Defuse_Dal_Speak_CheckSpeakInProgress" checkinterval="1s">
                      <conditions>
                        <check_value value="not $SpeakInProgress?"/>
                      </conditions>
                      <actions>
                        <set_value name="$SpeakInProgress"/>
                      </actions>
                      <cues>
                        <cue name="Ch2_Speak_Dal_208_Ref" ref="md.LIB_Dialog.Speak_Actor" >
                          <param name="Actor"             value="$DalBusta"/>
                          <param name="CutsceneKey"       value="$DalCutsceneKey"/>
                          <param name="Lines"             value="[[30220208],[30220209]]"/>
                          <param name="EndSignalCue"      value="Fight_Defuse_Dal_Speak_Finished"/>
                          <!--
                                  What the...? She's started a self-destruct sequence!
                                  You'll have to abort the sequence manually, or get out of there quickly!
                                    -->
                        </cue>
                        <cue name="Fight_Defuse_Dal_Speak_Finished">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <actions>
                            <remove_value name="$SpeakInProgress"/>
                          </actions>
                        </cue>
                      </cues>
                    </cue>
                  </cues>
                </cue>

                <!--Adjust this to balance the amount of drones the player has to fight-->
                <library name="Fight_Balance_Drone_Amount">
                  <actions>
                    <!--Set defaults-->
                    <set_value name="$PlayerShipType" exact="player.ship.type"/>
                    <set_value name="$BalancedDroneAmount" exact="2"/>
                    <!--Failsafe if player is in spacesuit and we don't know their actual shiptype-->
                    <do_if value="player.ship.isclass.spacesuit">
                      <debug_text text="'Player is in spacesuit, trying to set drone amount according to his previous ship'" chance="$DebugChance"/>
                      <do_if value="$MainPlayerShip?">
                        <debug_text text="'Previous player ship type is: ' + $MainPlayerShip.type" chance="$DebugChance"/>
                        <set_value name="$PlayerShipType" exact="$MainPlayerShip.type"/>
                      </do_if>
                      <do_else>
                        <debug_text text="'Could not find previous player ship. Drone amount set to default'" chance="$DebugChance"/>
                      </do_else>
                    </do_if>

                    <do_if value="[shiptype.scout, shiptype.fighter, shiptype.interceptor].indexof.{$PlayerShipType}">
                      <set_value name="$BalancedDroneAmount" exact="3"/>
                    </do_if>
                    <do_elseif value="[shiptype.heavyfighter].indexof.{$PlayerShipType}">
                      <set_value name="$BalancedDroneAmount" exact="4"/>
                    </do_elseif>
                    <do_elseif value="[shiptype.frigate, shiptype.gunboat, shiptype.corvette].indexof.{$PlayerShipType}">
                      <set_value name="$BalancedDroneAmount" exact="6"/>
                    </do_elseif>
                    <do_elseif value="[shiptype.destroyer, shiptype.carrier, shiptype.battleship].indexof.{$PlayerShipType}">
                      <set_value name="$BalancedDroneAmount" exact="30"/>
                    </do_elseif>
                    <do_else>
                      <debug_text text="'Player shiptype does not fit fighter definitions: ' + player.ship.type + '. Drone amount set to default: ' + $BalancedDroneAmount" chance="$DebugChance"/>
                    </do_else>
                  </actions>
                </library>


                <cue name="Informant_Fight_Dal_212">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <set_value name="$SpeakInProgress"/>
                  </actions>
                  <cues>
                    <cue name="Ch2_Speak_Dal_212_Ref_v2" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$DalBusta"/>
                      <param name="CutsceneKey"       value="$DalCutsceneKey"/>
                      <param name="Lines"             value="[[if player.entity.isfemale then 30220213 else 30220212],[30220214]]"/>
                      <param name="EndSignalCue"      value="Escape_Comment_Dal_Speak_Finished_v2"/>
                      <!--
                                  Whatever it is that you're doing, get on with it!
                                  It's going to blow!
                                    -->
                    </cue>
                    <cue name="Escape_Comment_Dal_Speak_Finished_v2">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <remove_value name="$SpeakInProgress"/>
                      </actions>
                    </cue>
                  </cues>
                </cue>

                <cue name="Informant_Fight_Dal_211">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <set_value name="$SpeakInProgress"/>
                  </actions>
                  <cues>
                    <cue name="Ch2_Speak_Dal_211_Ref_v2" ref="md.LIB_Dialog.Speak_Actor" >
                      <param name="Actor"             value="$DalBusta"/>
                      <param name="CutsceneKey"       value="$DalCutsceneKey"/>
                      <param name="Lines"             value="[[30220211]]"/>
                      <param name="EndSignalCue"      value="Escape_Player_Destroys_Ship_Dal_Speak_Finished_v2"/>
                      <!--
                                  Well, that's one way to solve the problem I suppose.
                                    -->
                    </cue>
                    <cue name="Escape_Player_Destroys_Ship_Dal_Speak_Finished_v2">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <remove_value name="$SpeakInProgress"/>
                        <signal_cue cue="Fight_First_Wave"/>
                      </actions>
                    </cue>
                  </cues>
                </cue>


                <!--Remember to cancel if signalling Fight_First_Wave before the timers below run out-->
                <cue name="Fight_Escape" version="2">
                  <actions>
                    <set_value name="$TimerEnd" exact="player.age + 40s"/>
                    <set_value name="$TimeRemaining" exact="$TimerEnd - player.age"/>
                    <debug_text text="'Player Age: ' + player.age + '. Timer End: ' + $TimerEnd + '. Time remaining: ' + $TimeRemaining" chance="$DebugChance"/>

                    <play_sound sound="'lennart_mine_sequence'" object="$BuccaneerDecoyShip"/>

                    <set_value name="$CurrentStep" exact="1" operation="add"/>
                    <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.retreat" text="{30220,3012}" object="$BuccaneerDecoyShip" endtime="$TimerEnd" updatebriefing="true" insert="true" comment="Retreat: To a Safe Distance"/>
                  </actions>
                  <patch sinceversion="2" state="cancelled">
                    <remove_value name="$SpeakInProgress"/>
                  </patch>
                  <cues>

                    <cue name="Escape_Comment_Dal_Speak">
                      <cues>
                        <cue name="Escape_Comment_Dal_Speak_Delay">
                          <delay exact="$TimeRemaining - 20s"/>
                          <actions>
                            <signal_cue cue="Escape_Comment_Dal_Speak_Enable"/>
                          </actions>
                        </cue>
                        <cue name="Escape_Comment_Dal_Speak_Enable">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <cues>
                            <cue name="Escape_Comment_Dal_Speak_CheckSpeakInProgress" checkinterval="1s">
                              <conditions>
                                <check_value value="not $SpeakInProgress?"/>
                              </conditions>
                              <actions>
                                <signal_cue cue="Informant_Fight_Dal_212"/>
                              </actions>
                            </cue>
                          </cues>
                        </cue>
                      </cues>
                    </cue>

                    <!--This is the longest timer-->
                    <cue name="Escape_Failure_Timer">
                      <delay exact="$TimeRemaining"/>
                      <actions>
                        <debug_text text="'Time ran out, destroying decoy ship and signalling Fight_First_Wave'" chance="$DebugChance"/>
                        <set_value name="$KilledBySelfDestruct"/>

                        <create_object name="$DecoyShipMine" macro="macro.weapon_gen_mine_01_a_macro" owner="faction.buccaneers" sector="$BuccaneerDecoyShip.sector">
                          <position object="$BuccaneerDecoyShip"/>
                        </create_object>
                        <destroy_object object="$BuccaneerDecoyShip" explosion="true"/>

                        <signal_cue cue="Fight_First_Wave"/>
                      </actions>
                    </cue>

                    <cue name="Escape_Player_Destroys_Ship_Dal_Speak">
                      <conditions>
                        <event_object_destroyed object="$BuccaneerDecoyShip"/>
                        <check_value value="not $KilledBySelfDestruct?"/>
                      </conditions>
                      <actions>
                        <cancel_cue cue="Escape_Failure_Timer"/>
                      </actions>
                      <cues>
                        <cue name="Escape_Player_Destroys_Ship_Dal_Speak_CheckSpeakInProgress" checkinterval="1s">
                          <conditions>
                            <check_value value="not $SpeakInProgress?"/>
                          </conditions>
                          <actions>
                            <signal_cue cue="Informant_Fight_Dal_211"/>
                          </actions>
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Escape_Success" checkinterval="1s">
                      <conditions>
                        <check_value value="player.entity.distanceto.{$BuccaneerDecoyShip} gt 700m"/>
                      </conditions>
                      <actions>
                        <debug_text text="'Player escaped the explosion, destroying decoy ship and signalling Fight_First_Wave'" chance="$DebugChance"/>
                        <destroy_object object="$BuccaneerDecoyShip" explosion="true"/>
                        <signal_cue cue="Fight_First_Wave"/>
                      </actions>
                    </cue>

                    <cue name="Escape_Defuse_Start" checkinterval="1s">
                      <conditions>
                        <check_value value="player.controlled.isclass.spacesuit"/>
                      </conditions>
                      <actions>
                        <!-- Optional objective, so don't increase CurrentStep, otherwise the steps don't add up anymore -->
                        <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.claim" object="$BuccaneerDecoyShip" endtime="$TimerEnd" updatebriefing="true" comment="Claim: Pegasus"/>
                      </actions>
                      <cues>

                        <cue name="Defuse_Success">
                          <conditions>
                            <!--Decoy ship appears as faction.buccaneers, but is faction.ownerless to be capturable-->
                            <event_object_changed_true_owner object="$BuccaneerDecoyShip" previous="faction.ownerless" owner="faction.player"/>
                          </conditions>
                          <actions>
                            <debug_text text="'Player captured decoy ship, signalling Fight_First_Wave'" chance="$DebugChance"/>
                            <signal_cue cue="Fight_First_Wave"/>
                          </actions>
                        </cue>

                      </cues>
                    </cue>

                  </cues>
                </cue>

                <cue name="Fight_Launch_Drones" comment="signal instantly with event.param = droneamount">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <set_value name="$DroneAmount" exact="if event.param != null then event.param else 4"/>

                    <debug_text text="'Fight_Launch_Drones signalled with param=' + event.param + ' resulting in DroneAmount=' + $DroneAmount" chance="$DebugChance"/>

                    <!--Find player-owned ships for attack-->
                    <find_ship groupname="$ClosePlayerShips" multiple="true" owner="faction.player" space="player.cluster"/>

                    <signal_cue_instantly cue="Setup_Create_Buccaneer_Flagship" param="table[ $sector = $Chapter2_Sector, $position = $DroneDropOffset, $invulnerable = true, $radarvisible = true ]"/>

                    <debug_text text="'$BuccaneerFlagship can carry up to ' + $BuccaneerFlagship.units.maxcount + ' units'" chance="$DebugChance"/>

                    <do_all exact="$DroneAmount" counter="$i">
                      <!-- If there aren't enough drones in storage, fill to maximum -->
                      <do_if value="$BuccaneerFlagship.units.{unitcategory.defence}.count lt ($DroneAmount - $i + 1)">
                        <add_units object="$BuccaneerFlagship" category="unitcategory.defence" mk="1" exact="$BuccaneerFlagship.units.maxcount - $BuccaneerFlagship.units.count"/>
                        <debug_text text="'$BuccaneerFlagship now has ' + $BuccaneerFlagship.units.{unitcategory.defence}.count + ' defense drones'" chance="$DebugChance"/>
                      </do_if>

                      <launch_drone name="$LaunchedDrone" object="$BuccaneerFlagship" category="unitcategory.defence" exact="1"/>

                      <do_if value="$LaunchedDrone != null">
                        <debug_text text="'Drone launched: ' + $LaunchedDrone" chance="$DebugChance"/>
                        <!--First move close to player, because attack-script will abort for friendly-->
                        <cancel_all_orders object="$LaunchedDrone"/>
                        <create_order object="$LaunchedDrone" id="'MoveToObject'" immediate="true">
                          <param name="destination" value="if $MainPlayerShip? then $MainPlayerShip else player.ship"/>
                        </create_order>
                        <set_object_relation_behaviour object="$LaunchedDrone" disable="true"/>
                        <add_to_group groupname="$BuccaneerDefenceDroneGroup" object="$LaunchedDrone"/>
                        <do_if value="$BuccaneerDefenceDroneGroup.count == $DroneAmount">
                          <set_value name="$LastDrone" exact="$LaunchedDrone"/>
                        </do_if>
                      </do_if>

                      <do_else>
                        <debug_text text="'Drone launch failed. Signalling Flagship_Flee anyway, so the mission continues as normal.'"/>
                        <signal_cue cue="Fight_Flagship_Flee"/>
                      </do_else>
                    </do_all>
                  </actions>
                </cue>

                <cue name="Fight_Flagship_Flee">
                  <conditions>
                    <check_any>
                      <event_cue_signalled/>
                      <check_all>
                        <event_object_undocked_from container="$BuccaneerFlagship"/>
                        <check_value value="$LastDrone? and event.param == $LastDrone"/>
                      </check_all>
                    </check_any>
                  </conditions>
                  <actions>
                    <debug_text text="'Buccaneer flagship gains distance'"/>
                    <cancel_all_orders object="$BuccaneerFlagship"/>
                    <create_order id="'MoveDie'" name="$FlagshipFlee" object="$BuccaneerFlagship" immediate="true"/>
                  </actions>
                </cue>

                <cue name="Fight_First_Wave">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <debug_text text="'Cancelling Fight_Escape timers'" chance="$DebugChance"/>
                    <cancel_cue cue="Fight_Escape"/>
                    <debug_text text="'First_Wave_Update_Objective starts checking for distance'"/>
                    <debug_text text="'First_Wave_Trashtalk starts checking for drones destroyed'"/>

                    <signal_cue_instantly cue="Setup_Create_Buccaneer_Flagship" param="table[ $sector = $Chapter2_Sector, $position = $DroneDropOffset, $invulnerable = true, $radarvisible = true ]"/>

                    <do_if value="$BuccaneerFlagship.distanceto.{$DroneDropOffset} gt 10km">
                      <debug_text text="'Buccaneer drone carrier was too far away, warping'" chance="$DebugChance"/>
                      <warp object="$BuccaneerFlagship" sector="$Chapter2_Sector">
                        <safepos value="$DroneDropOffset"/>
                      </warp>
                    </do_if>

                    <set_value name="$CurrentStep" exact="1" operation="add"/>
                    <!-- Flavour Objective -->
                    <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.wait" text="{30220,2008}" updatebriefing="true" insert="true" comment="Wait: Remain Vigilant"/>
                    <!-- Buccaneer flagship will now launch drones. They'll turn enemy once they're close enough -->
                    <include_actions ref="Fight_Balance_Drone_Amount"/>
                    <signal_cue_instantly cue="Fight_Launch_Drones" param="$BalancedDroneAmount" />
                  </actions>
                  <cues>

                    <!--Turn drones hostile one by one when they come close enough-->
                    <cue name="First_Wave_DroneProximityUpdate">
                      <cues>
                        <cue name="First_Wave_DroneProximityUpdate_Instance" checkinterval="1s" instantiate="true">
                          <conditions>
                            <check_value value="$BuccaneerDefenceDroneGroup.count"/>
                          </conditions>
                          <actions>
                            <set_value name="this.$AllDronesEnemy" exact="true"/>
                            <do_all exact="$BuccaneerDefenceDroneGroup.count" counter="$i">
                              <do_if value="$BuccaneerDefenceDroneGroup.{$i}.distanceto.{player.entity} lt 4km">
                                <set_value name="$Drone" exact="$BuccaneerDefenceDroneGroup.{$i}"/>
                                <!--first change relation to enemy-->
                                <set_relation_boost object="$Drone" value="-1" faction="faction.player" silent="true" decay="0"/>
                                <set_object_relation_behaviour object="$Drone" disable="true"/>
                                <!--and now switch AI to attack-->
                                <create_order object="$Drone" id="'Attack'" immediate="true">
                                  <param name="primarytarget" value="if $MainPlayerShip? then $MainPlayerShip else player.ship"/>
                                  <param name="secondarytargets" value="$ClosePlayerShips"/>
                                  <param name="pursuetargets" value="true"/>
                                </create_order>
                              </do_if>
                              <do_if value="$BuccaneerDefenceDroneGroup.{$i}.relationto.{faction.player} gt -1.0">
                                <set_value name="this.$AllDronesEnemy" exact="false"/>
                              </do_if>
                            </do_all>

                            <do_if value="this.$AllDronesEnemy">
                              <debug_text text="'All drones enemy, cancelling cue that turns them into enemies.'" chance="$DebugChance"/>
                              <cancel_cue cue="First_Wave_DroneProximityUpdate"/>
                            </do_if>
                          </actions>
                        </cue>
                      </cues>
                    </cue>

                    <cue name="First_Wave_DroneDestroyed" instantiate="true">
                      <conditions>
                        <event_object_destroyed group="$BuccaneerDefenceDroneGroup"/>
                      </conditions>
                      <actions>
                        <debug_text text="'$BuccaneerDefenceDroneGroup.count=' + $BuccaneerDefenceDroneGroup.count"/>
                      </actions>
                    </cue>

                    <!--Update the objective and trigger voice lines once the first drone is close enough and turns hostile-->
                    <cue name="First_Wave_Update_Objective" checkinterval="1s">
                      <conditions>
                        <check_any exact="$BuccaneerDefenceDroneGroup.count" counter="$i">
                          <check_value value="$BuccaneerDefenceDroneGroup.{$i}.distanceto.{player.ship} lt 4km"/>
                        </check_any>
                      </conditions>
                      <actions>
                        <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.destroy" group="$BuccaneerDefenceDroneGroup" text="{30220,2009}" updatebriefing="true" comment="Destroy: Defence drones"/>
                      </actions>
                      <cues>

                        <cue name="First_Wave_Update_Objective_Dal_Speak">
                          <cues>
                            <cue name="First_Wave_Update_Objective_Dal_Speak_CheckSpeakInProgress" checkinterval="1s">
                              <conditions>
                                <check_value value="not $SpeakInProgress?"/>
                              </conditions>
                              <actions>
                                <set_value name="$SpeakInProgress"/>
                              </actions>
                              <cues>
                                <cue name="Ch2_Speak_Dal_215_Ref" ref="md.LIB_Dialog.Speak_Actor" >
                                  <param name="Actor"             value="$DalBusta"/>
                                  <param name="CutsceneKey"       value="$DalCutsceneKey"/>
                                  <param name="Lines"             value="[[30220215],[30220216]]"/>
                                  <param name="EndSignalCue"      value="First_Wave_Update_Objective_Dal_Speak_Finished"/>
                                  <!--
                                  Argh! The self-destruct sequence was just a diversion.
                                  Hostile drones approaching, fast!
                                    -->
                                </cue>
                                <cue name="First_Wave_Update_Objective_Dal_Speak_Finished">
                                  <conditions>
                                    <event_cue_signalled/>
                                  </conditions>
                                  <actions>
                                    <remove_value name="$SpeakInProgress"/>
                                    <signal_cue cue="First_Wave_Update_Objective_Gride_Speak"/>
                                  </actions>
                                </cue>
                              </cues>
                            </cue>
                          </cues>
                        </cue>

                        <cue name="First_Wave_Update_Objective_Gride_Speak">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <cues>
                            <cue name="First_Wave_Update_Objective_Gride_Speak_CheckSpeakInProgress" checkinterval="1s">
                              <conditions>
                                <check_value value="not $SpeakInProgress?"/>
                              </conditions>
                              <actions>
                                <set_value name="$SpeakInProgress"/>
                                <speak actor="$GrideActor" priority="100">
                                  <text line="30220207" comment="And since we're having such a nice, confidential chat..."/>
                                  <text line="30220208" comment="How much would you be willing to sacrifice in order to defeat your worst enemies, and understand your true purpose."/>
                                </speak>
                              </actions>
                              <cues>
                                <cue name="First_Wave_Update_Objective_Gride_Speak_Finished">
                                  <conditions>
                                    <event_speak_finished actor="$GrideActor" line="30220207"/>
                                  </conditions>
                                  <actions>
                                    <remove_value name="$SpeakInProgress"/>
                                  </actions>
                                </cue>
                              </cues>
                            </cue>
                          </cues>
                        </cue>

                        <cue name="First_Wave_Trashtalk">
                          <conditions>
                            <event_object_destroyed group="$BuccaneerDefenceDroneGroup"/>
                            <check_value value="$BuccaneerDefenceDroneGroup.count le 2"/>
                          </conditions>
                          <cues>
                            <cue name="First_Wave_Trashtalk_CheckSpeakInProgress" checkinterval="1s">
                              <conditions>
                                <check_value value="not $SpeakInProgress?"/>
                              </conditions>
                              <actions>
                                <set_value name="$SpeakInProgress"/>
                                <speak actor="$DalBusta" priority="100">
                                  <text line="30220217" comment="Automated piles of junk!"/>
                                  <text line="30220218" comment="Stop playing games, Gride!"/>
                                </speak>
                              </actions>
                              <cues>
                                <cue name="First_Wave_Trashtalk_Finished">
                                  <conditions>
                                    <event_speak_finished actor="$DalBusta" line="30220217"/>
                                  </conditions>
                                  <actions>
                                    <remove_value name="$SpeakInProgress"/>
                                  </actions>
                                </cue>
                              </cues>
                            </cue>
                          </cues>
                        </cue>

                        <cue name="First_Wave_Complete" instantiate="true">
                          <conditions>
                            <event_object_destroyed group="$BuccaneerDefenceDroneGroup"/>
                            <check_value value="$BuccaneerDefenceDroneGroup.count == 1" comment="Last one in group is about to be destroyed"/>
                          </conditions>
                          <actions>
                            <signal_cue cue="Fight_Second_Wave"/>
                          </actions>
                        </cue>
                      </cues>
                    </cue>

                  </cues>
                </cue>

                <cue name="Fight_Launch_Drones_2" comment="event.param = droneamount">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <set_value name="$DroneAmount" exact="event.param"/>
                    <debug_text text="'Fight_Launch_Drones_2 signalled with DroneAmount ' + $DroneAmount"/>

                    <!--Drones which explode with splash damage when destroyed-->
                    <set_value name="$ExplosiveDroneMacro" exact="macro.ship_gen_s_fightingdrone_explosive_01_a_macro"/>

                    <!--Find player-owned ships for attack-->
                    <find_ship groupname="$ClosePlayerShips" multiple="true" owner="faction.player" space="player.cluster"/>

                    <create_position name="$ExplosiveDroneSpawnPosition" space="$Chapter2_Sector" object="player.entity.ship" x="3km" y="-3km" z="-2km"/>

                    <signal_cue_instantly cue="Setup_Create_Buccaneer_Flagship" param="table[ $sector = $Chapter2_Sector, $position = $DroneDropOffset, $invulnerable = true, $radarvisible = true ]"/>

                    <!--Spawn explosive drones-->
                    <do_all exact="$DroneAmount" counter="$i">
                      <debug_text text="'Creating enemy explosive drones to attack player: ' + $i"/>
                      <create_ship name="$BuccaneerExplosiveDrone" macro="$ExplosiveDroneMacro" sector="$Chapter2_Sector" capturable="false">
                        <owner exact="$BuccaneerFlagship.owner" overridenpc="true" />
                        <pilot>
                          <select race="race.drone" tags="tag.aipilot"/>
                        </pilot>
                        <safepos value="$ExplosiveDroneSpawnPosition" min="0km" max="200m"/>
                      </create_ship>
                      <set_relation_boost object="$BuccaneerExplosiveDrone" value="-1" faction="faction.player" silent="true"/>
                      <set_object_relation_behaviour object="$BuccaneerExplosiveDrone" disable="true"/>
                      <create_order object="$BuccaneerExplosiveDrone" id="'MoveToObject'" immediate="true">
                        <param name="destination" value="player.entity.ship"/>
                      </create_order>
                      <add_to_group groupname="$BuccaneerExplosiveDroneGroup" object="$BuccaneerExplosiveDrone"/>
                    </do_all>
                  </actions>
                </cue>

                <!--Second drone wave ambushes the player once they beat the first wave-->
                <cue name="Fight_Second_Wave">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <debug_text text="'Fight_Second_Wave'"/>
                    <signal_cue_instantly cue="Fight_Launch_Drones_2" param="$BalancedDroneAmount"/>
                  </actions>
                  <cues>

                    <cue name="Second_Wave_Gride_Speak">
                      <cues>
                        <cue name="Second_Wave_Gride_Speak_CheckSpeakInProgress" checkinterval="1s">
                          <conditions>
                            <check_value value="not $SpeakInProgress?"/>
                          </conditions>
                          <actions>
                            <set_value name="$SpeakInProgress"/>
                            <speak actor="$GrideActor" priority="100">
                              <text line="30220209" comment="If you had riches, power, respect, what would it take for you to give them all up?"/>
                            </speak>
                            <remove_value name="$SpeakInProgress"/>
                          </actions>
                        </cue>
                      </cues>
                    </cue>

                    <!--Update closest defence drone and turn drones hostile one by one when they come close enough-->
                    <cue name="Second_Wave_DroneProximityUpdate">
                      <cues>
                        <cue name="Second_Wave_DroneProximityUpdate_Instance" checkinterval="1s" instantiate="true">
                          <conditions>
                            <check_value value="$BuccaneerExplosiveDroneGroup.count"/>
                          </conditions>
                          <actions>
                            <set_value name="this.$AllDronesEnemy" exact="true"/>
                            <do_all exact="$BuccaneerExplosiveDroneGroup.count" counter="$i">
                              <do_if value="$BuccaneerExplosiveDroneGroup.{$i}.distanceto.{player.entity} lt 4km">
                                <set_value name="$Drone" exact="$BuccaneerExplosiveDroneGroup.{$i}"/>
                                <!--first change relation to enemy-->
                                <set_relation_boost object="$Drone" value="-1" faction="faction.player" silent="true" decay="0"/>
                                <set_object_relation_behaviour object="$Drone" disable="true"/>
                                <!--and now switch AI to attack-->
                                <create_order object="$Drone" id="'Attack'" immediate="true">
                                  <param name="primarytarget" value="if $MainPlayerShip? then $MainPlayerShip else player.ship"/>
                                  <param name="secondarytargets" value="$ClosePlayerShips"/>
                                  <param name="pursuetargets" value="true"/>
                                </create_order>
                              </do_if>
                              <do_if value="$BuccaneerExplosiveDroneGroup.{$i}.relationto.{faction.player} le -1.0">
                                <set_value name="this.$AllDronesEnemy" exact="false"/>
                              </do_if>
                            </do_all>

                            <do_if value="this.$AllDronesEnemy">
                              <debug_text text="'All drones enemy, cancelling cue that turns them into enemies.'" chance="$DebugChance"/>
                              <cancel_cue cue="Second_Wave_DroneProximityUpdate"/>
                            </do_if>

                          </actions>
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Second_Wave_DroneDestroyed" instantiate="true">
                      <conditions>
                        <event_object_destroyed group="$BuccaneerExplosiveDroneGroup"/>
                      </conditions>
                      <actions>
                        <debug_text text="'$BuccaneerExplosiveDroneGroup.count=' + $BuccaneerExplosiveDroneGroup.count"/>
                      </actions>
                    </cue>

                    <cue name="Second_Wave_Update_Objective" checkinterval="1s">
                      <conditions>
                        <check_value value="player.entity.distanceto.{$BuccaneerExplosiveDrone} lt 4km"/>
                      </conditions>
                      <actions>
                        <set_value name="$CurrentStep" exact="1" operation="add"/>
                        <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.destroy" group="$BuccaneerExplosiveDroneGroup" text="{30220,2010}" updatebriefing="true" insert="true" comment="Destroy: Rigged drones"/>
                      </actions>
                      <cues>

                        <cue name="Second_Wave_Update_Objective_Dal_Boso_Speak">
                          <cues>
                            <cue name="Second_Wave_Update_Objective_Dal_Boso_Speak_CheckSpeakInProgress" checkinterval="1s">
                              <conditions>
                                <check_value value="not $SpeakInProgress?"/>
                              </conditions>
                              <actions>
                                <set_value name="$SpeakInProgress"/>
                              </actions>
                              <cues>
                                <cue name="Ch2_Dal_Boso_Speak_219_Ref" ref="md.LIB_Dialog.Speak_Actors">
                                  <param name="Actor"             value="[$DalBusta, $BosoTa]"/>
                                  <param name="CutsceneKey"       value="[$DalCutsceneKey, $BosoCutsceneKey]"/>
                                  <param name="Lines"             value="[[[if player.entity.isfemale then 30220220 else 30220219]],
                                                                          [[30220201]]]"/>
                                  <param name="EndSignalCue"      value="[null, Second_Wave_Update_Objective_Dal_Boso_Speak_Finished]"/>
                                  <!--           
                                   Watch out, there are more of them!
                                   How curious. It appears that these drones have been tinkered with.
                                  -->
                                </cue>
                                <cue name="Second_Wave_Update_Objective_Dal_Boso_Speak_Finished">
                                  <conditions>
                                    <event_cue_signalled/>
                                  </conditions>
                                  <actions>
                                    <remove_value name="$SpeakInProgress"/>
                                  </actions>
                                </cue>
                              </cues>
                            </cue>
                          </cues>
                        </cue>

                        <cue name="Second_Wave_Trashtalk_Dal_Speak">
                          <conditions>
                            <event_object_destroyed group="$BuccaneerExplosiveDroneGroup"/>
                          </conditions>
                          <cues>
                            <cue name="Second_Wave_Trashtalk_Dal_Speak_CheckSpeakInProgress" checkinterval="1s">
                              <conditions>
                                <check_value value="not $SpeakInProgress?"/>
                              </conditions>
                              <actions>
                                <set_value name="$SpeakInProgress"/>
                              </actions>
                              <cues>
                                <cue name="Ch2_Speak_Dal_221_Ref" ref="md.LIB_Dialog.Speak_Actor" >
                                  <param name="Actor"             value="$DalBusta"/>
                                  <param name="CutsceneKey"       value="$DalCutsceneKey"/>
                                  <param name="Lines"             value="[[30220221],[if player.entity.isfemale then 30220223 else 30220222]]"/>
                                  <param name="EndSignalCue"      value="Second_Wave_Trashtalk_Dal_Speak_Finished"/>
                                  <!--
                                    Someone really likes their explosives.
                                    Better keep your distance.
                                    -->
                                </cue>
                                <cue name="Second_Wave_Trashtalk_Dal_Speak_Finished">
                                  <conditions>
                                    <event_cue_signalled/>
                                  </conditions>
                                  <actions>
                                    <remove_value name="$SpeakInProgress"/>
                                    <!-- If at this point the player has somehow already destroyed all enemy drones, signal ending lines immediately. -->
                                    <do_if value="$BuccaneerExplosiveDroneGroup.count">
                                      <signal_cue cue="Second_Wave_Enable_Ending"/>
                                    </do_if>
                                    <do_else>
                                      <signal_cue cue="Second_Wave_Ending_Dal_Speak"/>
                                    </do_else>
                                  </actions>
                                </cue>
                              </cues>
                            </cue>
                          </cues>
                        </cue>

                        <cue name="Second_Wave_Enable_Ending">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <cues>
                            <cue name="Second_Wave_Destroyed">
                              <conditions>
                                <event_object_destroyed group="$BuccaneerExplosiveDroneGroup"/>
                                <check_value value="$BuccaneerExplosiveDroneGroup.count == 1"/>
                              </conditions>
                              <actions>
                                <signal_cue cue="Second_Wave_Ending_Dal_Speak"/>
                              </actions>
                            </cue>
                          </cues>
                        </cue>

                        <cue name="Second_Wave_Ending_Dal_Speak">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <actions>
                            <speak actor="$DalBusta" priority="100">
                              <text line="30220224" comment="Oh come on! That's enough!"/>
                              <text line="if player.entity.isfemale then 30220226 else 30220225" comment="My friend here doesn't deserve this kind of treatment."/>
                            </speak>
                          </actions>
                        </cue>

                      </cues>
                    </cue>

                  </cues>
                </cue>

              </cues>
            </cue>

            <cue name="Informant_Conversation">
              <conditions>
                <event_speak_finished actor="$DalBusta" line="30220224"/>
              </conditions>
              <delay exact="1s"/>
              <actions>
                <set_value name="$CurrentStep" exact="1" operation="add"/>
                <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.collect" text="{30220,2004}" updatebriefing="true" comment="Collect: Informantion on the Paranid"/>

                <set_value name="$Answers" exact="0"/>

                <speak actor="$GrideActor">
                  <text line="if player.entity.isfemale then 30220211 else 30220210" comment="Well, at least your... (slight pause before 'friend')friend does seem reasonably competent."/>
                </speak>
              </actions>
              <cues>

                <cue name="Informant_Conversation_Start">
                  <conditions>
                    <check_any>
                      <event_speak_finished actor="$GrideActor" line="30220210"/>
                      <event_speak_finished actor="$GrideActor" line="30220211"/>
                    </check_any>
                  </conditions>
                  <actions>
                    <start_conversation actor="$GrideActor" conversation="gride_paranid_intro" priority="100"/>
                  </actions>
                </cue>

                <cue name="Informant_Conversation_Section_Main" instantiate="true">
                  <conditions>
                    <check_any>
                      <event_conversation_started actor="$GrideActor" conversation="gride_paranid_intro"/>
                      <event_conversation_next_section actor="$GrideActor" section="section_main"/>
                    </check_any>
                  </conditions>
                  <actions>
                    <debug_text text="'Conversation gride_paranid_intro now in main section'" chance="$DebugChance"/>

                    <allow_conversation_escape enabled="false"/>

                    <do_if value="event.name == 'event_conversation_next_section'">
                      <debug_text text="'Conversation section triggered by event_conversation_next_section'" chance="$DebugChance"/>

                      <do_if value="event.param2 == 'question1'">
                        <debug_text text="'Giving answer 1, personal'" chance="$DebugChance"/>
                        <add_npc_line speaker="$GrideActor" line="if player.entity.isfemale then 30220239 else 30220238" hidechoices="true" comment="Oh, how nice of you to ask." delay="0.7s"/>
                        <add_npc_line speaker="$GrideActor" line="30220240"                                              hidechoices="true" comment="I was a pilot myself, you know, back in the days before the gate shutdown."/>
                        <add_npc_line speaker="$GrideActor" line="30220241"                                              hidechoices="true" comment="I served one of the greatest minds who ever lived."/>
                        <add_npc_line speaker="$GrideActor" line="30220242"                                              hidechoices="true" comment="What I wouldn't do to bring them back."/>
                        <set_value name="$Gride_Paranid_Question_1_Asked" exact="true"/>
                        <set_value name="$Answers" exact="1" operation="add"/>
                      </do_if>

                      <do_elseif value="event.param2 == 'question2'">
                        <debug_text text="'Giving answer 2, ambush'" chance="$DebugChance"/>
                        <add_npc_line speaker="$GrideActor" line="if player.entity.isfemale then 30220244 else 30220243" hidechoices="true" comment="Ah yes, sorry about that dear." delay="0.7s"/>
                        <add_npc_line speaker="$GrideActor" line="30220245"                                              hidechoices="true" comment="In my line of work, you can never be too careful about who you... (slight pause before 'associate')associate with."/>
                        <add_npc_line speaker="$GrideActor" line="if player.entity.isfemale then 30220247 else 30220246" hidechoices="true" comment="If you ever find yourself facing the kind of impossible odds I'm up against, you might look back fondly at our little encounter."/>
                        <set_value name="$Gride_Paranid_Question_2_Asked" exact="true"/>
                        <set_value name="$Answers" exact="1" operation="add"/>
                      </do_elseif>

                      <do_elseif value="event.param2 == 'question3'">
                        <debug_text text="'Giving answer 3, war'" chance="$DebugChance"/>
                        <add_npc_line speaker="$GrideActor" line="30220221" delay="0.7s"                                 hidechoices="true" comment="To an outsider, it might seem as though this war has just been going back and forth, with no prospect of a resolution."/>
                        <add_npc_line speaker="$GrideActor" line="30220222"                                              hidechoices="true" comment="That's not an entirely inaccurate assessment, but it's not the whole picture."/>
                        <add_npc_line speaker="$GrideActor" line="30220223"                                              hidechoices="true" comment="It's no accident that military supplies for this conflict have become one of the safest investments at this end of the gate network."/>
                        <add_npc_line speaker="$GrideActor" line="if player.entity.isfemale then 30220225 else 30220224" hidechoices="true" comment="You see, the two factions aren't (emphasize 'really')really fighting over territory or resources."/>
                        <add_npc_line speaker="$GrideActor" line="30220226"                                              hidechoices="true" comment="In the minds of their leaders, elimination of their opponents would actually be a tragic outcome."/>
                        <add_npc_line speaker="$GrideActor" line="30220227"                                              hidechoices="true" comment="That's because they're fighting for the hearts and minds of their people."/>
                        <add_npc_line speaker="$GrideActor" line="30220228"                                              hidechoices="true" comment="If one Pontifex backed down, even just a little, he'd be sacrificing his legitimacy."/>
                        <add_npc_line speaker="$GrideActor" line="30220229"                                              hidechoices="true" comment="I imagine they must be quite desperate for an outside solution by now."/>
                        <set_value name="$Gride_Paranid_Question_3_Asked" exact="true"/>
                        <set_value name="$Answers" exact="1" operation="add"/>
                      </do_elseif>

                      <do_elseif value="event.param2 == 'question4'">
                        <debug_text text="'Giving answer 4, paranid'" chance="$DebugChance"/>
                        <do_if value="player.entity.race == race.paranid">
                          <add_npc_line speaker="$GrideActor" line="30220230" delay="0.7s"                               hidechoices="true" comment="(if Paranid)That's a rather curious question, coming from you."/>
                          <add_npc_line speaker="$GrideActor" line="30220231"                                            hidechoices="true" comment="(if Paranid)You must have spent far too long away from your kin."/>
                        </do_if>
                        <add_npc_line speaker="$GrideActor" line="30220232" delay="0.7s"                                 hidechoices="true" comment="Someone looking at it from the outside could easily come to the conclusion that civil war was a natural state for Paranid society."/>
                        <add_npc_line speaker="$GrideActor" line="30220233"                                              hidechoices="true" comment="It seems almost like some sort of expression of their psyche; always questioning and challenging one another's beliefs."/>
                        <add_npc_line speaker="$GrideActor" line="30220234"                                              hidechoices="true" comment="Nothing could be further from the truth, however."/>
                        <add_npc_line speaker="$GrideActor" line="30220235"                                              hidechoices="true" comment="What they so desperately want to resolve is what to them is an almost tangible geometric impossibility, namely there being two Pontifices."/>
                        <add_npc_line speaker="$GrideActor" line="30220236"                                              hidechoices="true" comment="The current situation is utter sacrilege, tearing at their stoic demeanour and rending their perception of their own culture."/>
                        <add_npc_line speaker="$GrideActor" line="30220237"                                              hidechoices="true" comment="It's an aberration in history that needs to be erased at all cost."/>
                        <set_value name="$Gride_Paranid_Question_4_Asked" exact="true"/>
                        <set_value name="$Answers" exact="1" operation="add"/>
                      </do_elseif>
                    </do_if>

                    <!--First line of the conversation-->
                    <do_else>
                      <debug_text text="'Introductory voice lines'" chance="$DebugChance"/>
                      <add_npc_line line="if player.entity.isfemale then 30220213 else 30220212" hidechoices="true" comment="Competent enough to run a small errand for me." delay="1s"/>
                      <add_npc_line line="if player.entity.isfemale then 30220215 else 30220214" hidechoices="true" comment="I seem to remember that you came here to ask questions about the Paranid."/>
                      <add_npc_line line="if player.entity.isfemale then 30220217 else 30220216" hidechoices="true" comment="I'll answer... (slight pause before 'two')two questions of yours."/>
                      <add_npc_line line="30220218"                                              hidechoices="true" comment="We'll call it an advance payment."/>
                      <add_npc_line line="30220219"                                              hidechoices="true" comment="Choose your questions wisely."/>
                    </do_else>

                    <debug_text text="$Answers + ' questions asked'" chance="$DebugChance"/>

                    <!--The player will be allowed to ask the rest of the questions after another 2 missions-->
                    <do_if value="$Answers == 2">
                      <debug_text text="'Maximum amount of questions asked, triggering ending lines.'" chance="$DebugChance"/>
                      <signal_cue_instantly cue="Informant_Conversation_Enough_Answers"/>
                    </do_if>

                    <do_else>
                      <add_player_choice text="{30220,2101}" section="section_main"     position="top_left"     choiceparam="'question1'" selectable="not $Gride_Paranid_Question_1_Asked?" comment="What's your story?"/>
                      <add_player_choice text="{30220,2102}" section="section_main"     position="left"         choiceparam="'question2'" selectable="not $Gride_Paranid_Question_2_Asked?" comment="Why the ambush?"/>
                      <add_player_choice text="{30220,2103}" section="section_main"     position="top_right"    choiceparam="'question3'" selectable="not $Gride_Paranid_Question_3_Asked?" comment="What will this war achieve?"/>
                      <add_player_choice text="{30220,2104}" section="section_main"     position="right"        choiceparam="'question4'" selectable="not $Gride_Paranid_Question_4_Asked?" comment="What drives the Paranid?"/>
                      <add_player_choice text="{30220,2105}" section="section_shortcut" position="bottom_right" highlighted="true"                                            comment="Just tell me what to do."/>
                    </do_else>
                  </actions>
                </cue>

                <cue name="Informant_Conversation_Section_Shortcut">
                  <conditions>
                    <event_conversation_next_section actor="$GrideActor" section="section_shortcut"/>
                  </conditions>
                  <actions>
                    <debug_text text="'Buccaneer conversation outro via shortcut by player choice.'"/>
                    <allow_conversation_escape enabled="false"/>
                    <add_npc_line speaker="$GrideActor" line="if player.entity.isfemale then 30220253 else 30220252" hidechoices="true" comment="Nice to see you're so eager." delay="0.7s"/>
                    <add_npc_line speaker="$GrideActor" line="30220254"                                              hidechoices="true" comment="Very well then."/>
                    <add_npc_line speaker="$GrideActor" line="if player.entity.isfemale then 30220256 else 30220255" hidechoices="true" comment="You should receive your instructions right about(stretch word 'abooout')... now."/>
                  </actions>
                </cue>

                <cue name="Informant_Conversation_Enough_Answers">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <debug_text text="'Buccaneer conversation outro via maximum questions asked.'"/>
                    <allow_conversation_escape enabled="false"/>
                    <add_npc_line speaker="$GrideActor" line="30220248" delay="1s"                                   hidechoices="true" comment="All this interrogation is making me dreadfully tired."/>
                    <add_npc_line speaker="$GrideActor" line="if player.entity.isfemale then 30220250 else 30220249" hidechoices="true" comment="You'll get your answers eventually, though. Don't you worry."/>
                    <add_npc_line speaker="$GrideActor" line="30220251" delay="0.5s"                                 hidechoices="true" comment="Now, about that little errand I mentioned."/>
                    <add_npc_line speaker="$GrideActor" line="if player.entity.isfemale then 30220256 else 30220255" hidechoices="true" comment="You should receive your instructions right about(stretch word 'abooout')... now."/>
                  </actions>
                </cue>

                <cue name="Informant_Conversation_End">
                  <conditions>
                    <event_conversation_finished actor="$GrideActor"/>
                  </conditions>
                  <actions>
                    <debug_text text="'Buccaneer conversation ending.'" chance="$DebugChance"/>
                    <remove_mission cue="$MissionCue" type="completed"/>
                    <write_to_logbook category="missions" faction="faction.player" title="{30220,2001}" text="if player.entity.isfemale then {30220,2015} else {30220,2014}"/>
                    <signal_cue cue="Ch3_Cipher"/>
                    <cancel_cue cue="Informant_Conversation"/>
                  </actions>
                </cue>

              </cues>
            </cue>

          </cues>
        </cue>

        <!-- Chapter 3: Monument and Cipher -->

        <cue name="Ch3_Force">
          <force name="Plot_Paranid_Ch3">
            <signal_cue_instantly cue="Force_Chapter" param="Ch3_Cipher"/>
          </force>
        </cue>

        <cue name="Ch3_Cipher">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <debug_text text="'Starting part ' + this" chance="$DebugChance"/>
            <set_value name="$CurrentPartCue" exact="this"/>

            <!-- GENERAL CHAPTER SETUP -->
            <find_sector name="$Chapter3_Sector" macro="macro.Cluster_11_Sector001_macro" comment="Pontifex's Claim"/>
            <debug_text text="'Sector found: ' + $Chapter3_Sector" chance="$DebugChance"/>
            <find_object name="$ParanidMonument" macro="macro.landmarks_par_monument_01_macro" space="$Chapter3_Sector"/>
            <debug_text text="'Paranid Monument found: ' + $ParanidMonument" chance="$DebugChance"/>
            <create_position name="$ParanidMonumentOffset" object="$ParanidMonument" space="$Chapter3_Sector"/>

            <!-- LOCKBOX MISSION SETUP -->
            <!--Randomly varying offset for lockbox placement, east of Paranid Monument-->
            <set_value name="$LockboxX" min="$ParanidMonumentOffset.x + 30km" max="$ParanidMonumentOffset.x + 40km"/>
            <set_value name="$LockboxY" min="$ParanidMonumentOffset.y - 5km"  max="$ParanidMonumentOffset.y + 5km"/>
            <set_value name="$LockboxZ" min="$ParanidMonumentOffset.z - 20km" max="$ParanidMonumentOffset.z + 20km"/>
            <create_position name="$TargetOffset" object="$Chapter3_Sector" x="$LockboxX" y="$LockboxY" z="$LockboxZ" comment="Setup_SpawnCrates wants a variable called $TargetOffset"/>

            <!--Required variables for library-->
            <set_value name="$CrateContent" exact="[
                        [[ware.bomb_player_limpet_emp_01_mk1, 2], [ware.inv_crystal_03, 6]],
                        [[ware.bomb_player_limpet_emp_01_mk1, 2], [ware.inv_crystal_04, 3]],
                        [[ware.bomb_player_limpet_emp_01_mk1, 2], [ware.inv_securitybypasssystem, 1]]
                        ]" comment="Lockbox group -> Lockbox' crate group -> Crate"/>

            <set_value name="$LockboxMacro" exact="macro.sm_gen_lockbox_explosive_01_macro"/>
            <set_value name="$TargetSector" exact="$Chapter3_Sector"/>

            <!--This $TargetRadius is only used for Setup_SpawnCrates, not for mission guidance-->
            <set_value name="$TargetRadius" exact="50m" comment="To make the explosive lockboxes spawn really close to each other! Setup_SpawnCrates wants a variable called $TargetRadius"/>

            <!--Use GM library to spawn crates. Output: $TargetObjects-->
            <include_actions ref="md.GM_FindObject.Setup_SpawnCrates"/>

            <!--Randomly varying offset for mission target radius display, east of Paranid Monument-->
            <set_value name="$GuidanceX" min="$TargetOffset.x - 10km" max="$TargetOffset.x + 10km"/>
            <set_value name="$GuidanceY" min="$TargetOffset.y - 10km" max="$TargetOffset.y + 10km"/>
            <set_value name="$GuidanceZ" min="$TargetOffset.z - 10km" max="$TargetOffset.z + 10km"/>
            <create_position name="$GuidanceOffset" object="$Chapter3_Sector" x="$GuidanceX" y="$GuidanceY" z="$GuidanceZ"/>
            <set_value name="$GuidanceRadius" exact="20km"/>

            <!--Create a group for dropped objects for the case where the RML is reset due to the player flying away. We don't want to lose track of them.-->
            <create_group groupname="$DroppedObjects"/>

            <create_mission cue="$MissionCue" name="{30220,3001}" description="if player.entity.isfemale then {30220,3015} else {30220,3002}" rewardtext="{30220,3016}" type="missiontype.plot" faction="faction.player" difficulty="level.medium" abortable="false" icon="'briefing_gride_orrian_01'" iconcaption="$GrideActor.name">
              <briefing>
                <objective step="1" action="objective.collect" text="{30220,3003}" object="$Chapter3_Sector" offset="$GuidanceOffset" radius="$GuidanceRadius" comment="Collect: Old Stash of Explosives"/>
                <objective step="2" action="objective.collect" text="{30220,3004}" comment="Collect: Holy Order Cipher"/>
              </briefing>
            </create_mission>

            <set_value name="$CurrentStep" exact="1"/>
            <set_objective_from_briefing cue="$MissionCue" step="$CurrentStep" comment="Collect: Old Stash of Explosives"/>
          </actions>
          <cues>

            <cue name="Cipher_Player_Already_In_Sector">
              <actions>
                <do_if value="player.entity.sector == $Chapter3_Sector">
                  <signal_cue cue="Cipher_Lockbox"/>
                </do_if>
              </actions>
            </cue>

            <cue name="Cipher_Lockbox">
              <conditions>
                <check_any>
                  <event_cue_signalled/>
                  <event_object_changed_sector object="player.entity" sector="$Chapter3_Sector"/>
                </check_any>
              </conditions>
              <actions>
                <debug_text text="'Starting lockbox search.'" chance="$DebugChance"/>
              </actions>
              <cues>

                <cue name="Lockbox_Sector_Reached_Dal_Speak_Delay">
                  <delay exact="3s"/>
                  <actions>
                    <signal_cue cue="Lockbox_Sector_Reached_Dal_Speak"/>
                  </actions>
                </cue>

                <cue name="Lockbox_Sector_Reached_Dal_Speak">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <cues>
                    <cue name="Ch3_Speak_Dal_301_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$DalBusta"/>
                      <param name="CutsceneKey"       value="$DalCutsceneKey"/>
                      <param name="Lines"             value="[[if player.entity.isfemale then 30220302 else 30220301, 1s],[1004, 0.6s],[30220303, 1s]]"/>
                      <param name="EndSignalCue"      value="Lockbox_FindObject"/>
                      <!--
                          You may be wondering why you're running errands for a maniac on the off change that they might tell you something useful.
                          (spoken to female player 'you'){10111,30220301}
                          *Coughing*
                          (Stretch word 'Aaaaanyway')Anyway, the first item on this list is finding an old stash of explosives.
                            -->
                    </cue>
                  </cues>
                </cue>

                <cue name="Lockbox_FindObject">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <delay exact="1s" comment="To make sure that FindObject_Ref is running and has created $TargetObjects before the Approach Handler starts looking for them."/>
                  <actions>
                    <signal_cue cue="Lockbox_Approach_Handler"/>
                    <signal_cue cue="Ch3_Story_Reminder" comment="Can be signalled here thanks to delay."/>
                  </actions>
                  <cues>
                    <cue name="FindObject_Ref" ref="md.RML_FindObject.FindObject">
                      <!--always pass these-->
                      <param name="EndSignalCue"      value="FindObject_End"/>
                      <param name="MissionCue"        value="$MissionCue"/>
                      <param name="StartStep"         value="1" comment="Briefing step to start the mission on"/>
                      <param name="UpdateBriefing"    value="true" comment="Update the briefing objective step when the objective is updated"/>
                      <param name="DebugChance"       value="$DebugChance"/>
                      <param name="Text_Objective_Find"   value="readtext.{30220}.{3003}" comment="Old Stash of Explosives"/>
                      <param name="Text_Objective_Pickup" value="readtext.{30220}.{3003}" comment="Old Stash of Explosives"/>
                      <!--mission-related parameters-->
                      <param name="TargetSector"      value="$Chapter3_Sector"/>
                      <param name="TargetOffset"      value="$GuidanceOffset"/>
                      <param name="TargetRadius"      value="$GuidanceRadius"/>
                      <param name="TargetObjects"     value="$TargetObjects"/>
                      <param name="DroppedObjects"    value="$DroppedObjects"/>
                      <param name="SignalCue_ObjectsDropped" value="Lockbox_Bombs_Dropped"/>
                      <param name="SignalCue_ObjectCollected" value="Lockbox_Bombs_Collected"/>
                    </cue>

                    <cue name="FindObject_End">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <debug_text text="'FindObject_Ref ended'" chance="$DebugChance"/>
                      </actions>
                    </cue>

                    <cue name="Ch3_Story_Reminder">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <cues>
                        <cue name="Ch3_Story_Reminder_Sector_Change">
                          <conditions>
                            <event_object_changed_sector object="player.entity" previous="$Chapter3_Sector"/>
                          </conditions>
                          <cues>
                            <cue name="Ch3_Story_Reminder_Dal_Speak_Ref" ref="md.LIB_Dialog.Speak_Actor">
                              <param name="Actor"             value="$DalBusta"/>
                              <param name="CutsceneKey"       value="$DalCutsceneKey"/>
                              <param name="Lines"             value="[[if player.entity.isfemale then 30200102 else 30200101]]"/>
                              <!--  <t id="30200101">Hey, you've not forgotten about the task at hand, have you?</t>
                                    <t id="30200102">(spoken to female player 'you'){,30200101}</t>  -->
                            </cue>
                          </cues>
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Lockbox_Approach_Handler">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <cues>
                        <cue name="Lockbox_Approach_Ref" ref="md.LIB_Generic.ApproachObject_Handler">
                          <param name="ApproachObject"    value="player.entity"/>
                          <param name="ApproachTarget"    value="$TargetObjects.{1}"/>
                          <param name="ApproachDistance"  value="500m"/>
                          <param name="SuccessSignalCue"  value="Lockbox_Approach_Dal_Speak"/>
                        </cue>
                        <cue name="Lockbox_Approach_Dal_Speak">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <actions>
                            <!--Deactivate generic monument guard response, reactivate later-->
                            <cancel_cue cue="Paranid_Monument_Generic_Guard_Response"/>
                            <set_value name="$SpeakInProgress" comment="To stop Dal from immediately screaming 'That was close!' if the player destroys the lockbox during this dialogue."/>
                          </actions>
                          <cues>
                            <cue name="Ch3_Speak_Dal_304_Ref" ref="md.LIB_Dialog.Speak_Actor">
                              <param name="Actor"             value="$DalBusta"/>
                              <param name="CutsceneKey"       value="$DalCutsceneKey"/>
                              <param name="Lines"             value="[[if player.entity.isfemale then 30220305 else 30220304],[30220306]]"/>
                              <param name="EndSignalCue"      value="Lockbox_Approach_Dal_Speak_Finished"/>
                              <!--
                              Let me get this straight. The stash of explosives is hidden inside containers that are.... explosive?
                              (spoken to female player){10111,30220304}
                              Why am I not surprised?
                                -->
                            </cue>
                            <cue name="Lockbox_Approach_Dal_Speak_Finished">
                              <conditions>
                                <event_cue_signalled/>
                              </conditions>
                              <actions>
                                <remove_value name="$SpeakInProgress"/>
                              </actions>
                            </cue>
                          </cues>
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Lockbox_Make_Player_Invincible">
                      <conditions>
                        <event_object_attacked attacker="player.entity.ship" group="@$TargetObjects"/>
                      </conditions>
                      <actions>
                        <set_value name="$InvinciblePlayerShip" exact="player.entity.ship"/>
                        <set_object_min_hull object="$InvinciblePlayerShip" exact="20" comment="We don't want the player to have to reload. Almost destroying his ship is enough."/>
                      </actions>
                      <cues>
                        <cue name="Lockbox_Make_Player_Vulnerable">
                          <delay exact="60s"/>
                          <actions>
                            <set_object_min_hull object="@$InvinciblePlayerShip" exact="0" comment="One of multiple failsafes to make the player vulnerable again."/>
                          </actions>
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Lockbox_Destroyed">
                      <conditions>
                        <event_object_destroyed group="@$TargetObjects"/>
                      </conditions>
                      <actions>
                        <!-- Filler objective to get rid of the escape objective. -->
                        <set_value name="$CurrentStep" exact="1" operation="add"/>
                        <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.await" text="{30220,3014}" updatebriefing="true" silent="true" insert="true" comment="Await: Further Instructions"/>
                        <!--Hopefully this destroys the dropped wares. Would be weird if they kept floating around after the explosion-->
                        <do_if value="$DroppedObjects.count">
                          <destroy_group group="$DroppedObjects" explosion="true"/>
                        </do_if>
                        <create_group groupname="$DroppedObjects"/>
                        <debug_text text="'Lockbox destroyed.'" chance="$DebugChance"/>
                        <cancel_cue cue="Lockbox_Timer_Start"/>
                        <signal_cue cue="Lockbox_Destroyed_Dal_Speak"/>
                      </actions>
                    </cue>

                    <cue name="Lockbox_Destroyed_Dal_Speak">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <delay exact="1s"/>
                      <actions>
                        <!--Revert invincibility-->
                        <set_object_min_hull object="@$InvinciblePlayerShip" exact="0"/>
                        <set_object_min_hull object="player.entity.ship" exact="0"/>
                      </actions>
                      <cues>
                        <cue name="Lockbox_Destroyed_Dal_Speak_Check_Ongoing" checkinterval="1s">
                          <conditions>
                            <check_value value="not $SpeakInProgress?" comment="Dal will say 'That was close!' once he's done with the previous dialogue."/>
                          </conditions>
                          <cues>
                            <cue name="Ch3_Speak_Dal_313_Ref" ref="md.LIB_Dialog.Speak_Actor">
                              <param name="Actor"             value="$DalBusta"/>
                              <param name="CutsceneKey"       value="$DalCutsceneKey"/>
                              <param name="Lines"             value="[[30220313]]"/>
                              <param name="EndSignalCue"      value="Lockbox_Destroyed_Dal_Speak_Finished"/>
                              <!--
                                  That was close!
                                    -->
                            </cue>
                            <cue name="Lockbox_Destroyed_Dal_Speak_Finished">
                              <conditions>
                                <event_cue_signalled/>
                              </conditions>
                              <delay exact="2s"/>
                              <actions>
                                <!--If the player has failed to collect the bombs before the explosion, Dal Busta finds a different, easier lockbox with less loot-->
                                <do_if value="$BombsCollected?">
                                  <signal_cue cue="Lockbox_Destroyed_Bombs_Dropped_Dal_Speak"/>
                                </do_if>
                                <do_else>
                                  <signal_cue cue="Lockbox_Destroyed_Bombs_Lost_Dal_Speak"/>
                                </do_else>
                              </actions>
                            </cue>
                          </cues>
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Lockbox_Destroyed_Bombs_Dropped_Dal_Speak">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <cues>
                        <cue name="Ch3_Speak_Dal_318_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$DalBusta"/>
                          <param name="CutsceneKey"       value="$DalCutsceneKey"/>
                          <param name="Lines"             value="[[30220318], [30220319], [30220320]]"/>
                          <param name="EndSignalCue"      value="Cipher_Monument"/>
                          <!--
                              Huh, these are EMP(pronounced E.M.P.) devices, not explosives.
                              Gride must have misremembered.
                              It's almost as if she planned some kind of heist, and then forgot all about it.
                                -->
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Lockbox_Destroyed_Bombs_Lost_Dal_Speak">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <cues>
                        <cue name="Ch3_Speak_Dal_314_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$DalBusta"/>
                          <param name="CutsceneKey"       value="$DalCutsceneKey"/>
                          <param name="Lines"             value="[[30220314], [if player.entity.isfemale then 30220316 else 30220315]]"/>
                          <param name="EndSignalCue"      value="Lockbox_Failsafe_Dal_Speak"/>
                          <!--
                              Damn! Gride's not going to be happy when she hears about this.
                              Let me check the radar. Maybe we can find a replacement.
                              (spoken to female player){10111,30220315}
                                -->
                        </cue>
                      </cues>
                    </cue>

                    <!--Officially end the mission step once the lockboxes have dropped one package of bombs. They can still continue, if they want...-->
                    <cue name="Lockbox_Bombs_Dropped">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <debug_text text="'Lockbox dropped a package of bombs. Making Dal warn the player that a timer is about to start.'"/>
                        <signal_cue cue="Lockbox_Timer_Dal_Speak"/>
                      </actions>
                    </cue>

                    <cue name="Lockbox_Bombs_Collected">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <!-- Remember that the player has collected at least one package of bombs. The mission is now considered a success and we don't need to trigger the second lockbox mission. -->
                        <set_value name="$BombsCollected" exact="true"/>
                        <!--End the RML, the player has the item he needs -->
                        <cancel_cue cue="FindObject_Ref"/>
                        <signal_cue cue="Lockbox_Add_Bomb_Launcher"/>
                      </actions>
                    </cue>

                    <cue name="Lockbox_Add_Bomb_Launcher">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <!-- If the player doesn't have the bomb launcher at this point in the game, they get it for free. -->
                        <do_if value="not player.entity.inventory.{ware.weapon_gen_spacesuit_demolition_01_mk1}.count">
                          <add_inventory ware="ware.weapon_gen_spacesuit_demolition_01_mk1" entity="player.entity" exact="1"/>
                        </do_if>
                      </actions>
                    </cue>

                    <!--If we want more tension while opening the boxes, this would be it-->
                    <cue name="Lockbox_Timer_Start">
                      <conditions>
                        <event_cue_signalled/>
                        <check_value value="$TargetObjects.count" comment="Just in case."/>
                      </conditions>
                      <actions>
                        <set_value name="$LockboxTimer" exact="40s"/>

                        <play_sound sound="'lennart_mine_sequence'" object="$TargetObjects.{1}"/>

                        <set_value name="$CurrentStep" exact="1" operation="add"/>
                        <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.survive" endtime="player.age + $LockboxTimer" text="{30220,2007}" updatebriefing="true" insert="true" comment="Survive: Imminent Detonation"/>
                      </actions>
                      <delay exact="$LockboxTimer"/>
                      <actions>
                        <signal_cue cue="Lockbox_Timer_End"/>
                      </actions>
                      <cues>
                        <cue name="Lockbox_Timer_Escape" checkinterval="1s">
                          <conditions>
                            <check_value value="$TargetObjects.count and player.entity.distanceto.{$TargetObjects.{1}} gt 800m" comment="Explosive lockbox damage radius is 500m, but the player ship might be too big and still get hit."/>
                          </conditions>
                          <actions>
                            <signal_cue cue="Lockbox_Timer_End"/>
                          </actions>
                        </cue>
                        <cue name="Lockbox_Timer_End">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <actions>
                            <do_if value="$TargetObjects.count">
                              <destroy_group group="$TargetObjects" explosion="true"/>
                            </do_if>
                            <cancel_cue cue="Lockbox_Timer_Start" comment="Countdown and distance check cancel each other."/>
                          </actions>
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Lockbox_Timer_Dal_Speak">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <set_value name="$SpeakInProgress" comment="To stop Dal from immediately screaming 'That was close!' if the player destroys the lockbox during this dialogue."/>
                      </actions>
                      <cues>
                        <cue name="Ch3_Speak_Dal_307_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$DalBusta"/>
                          <param name="CutsceneKey"       value="$DalCutsceneKey"/>
                          <param name="Lines"             value="[[30220307], [if player.entity.isfemale then 30220309 else 30220308]]"/>
                          <param name="EndSignalCue"      value="Lockbox_Timer_Dal_Speak_Finished"/>
                          <!--
                              Not another detonation timer!
                              Put some distance between you and the device.
                              (spoken to female player){10111,30220308}
                                -->
                        </cue>
                        <cue name="Lockbox_Timer_Dal_Speak_Finished">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <actions>
                            <remove_value name="$SpeakInProgress"/>
                            <set_value name="$PlayerWarnedAboutLockboxTimer"/>
                            <signal_cue cue="Lockbox_Timer_Start"/>
                          </actions>
                        </cue>
                      </cues>
                    </cue>

                    <!-- Can fire once Dal has warned the player about the timer -->
                    <cue name="Lockbox_Timer_Player_Continues_After_Warning">
                      <conditions>
                        <event_object_attacked attacker="player.entity.ship" group="$TargetObjects"/>
                        <check_value value="$PlayerWarnedAboutLockboxTimer?"/>
                      </conditions>
                      <actions>
                        <signal_cue cue="Lockbox_Exasperated_Dal_Speak"/>
                      </actions>
                    </cue>

                    <cue name="Lockbox_Exasperated_Dal_Speak">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <set_value name="$SpeakInProgress" comment="To stop Dal from immediately screaming 'That was close!' if the player destroys the lockbox during this dialogue."/>
                      </actions>
                      <cues>
                        <cue name="Ch3_Speak_Dal_310_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$DalBusta"/>
                          <param name="CutsceneKey"       value="$DalCutsceneKey"/>
                          <param name="Lines"             value="[[if player.entity.isfemale then 30220311 else 30220310]]"/>
                          <param name="EndSignalCue"      value="Lockbox_Exasperated_Boso_Speak"/>
                          <!--
                              Dal:  (irate)Or you could go right ahead and risk your life opening another lock during the countdown! Sheesh!
                              Dal:  (spoken to female player 'you'){10111,30220310}
                                -->
                        </cue>
                        <cue name="Lockbox_Exasperated_Boso_Speak">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <actions>
                            <speak actor="$BosoTa" priority="100">
                              <text line="30220301" comment="(worried)This is all getting a bit much for me."/>
                              <text line="if player.entity.isfemale then 30220303 else 30220302" comment="(worried)I would really rather not lose my assistant on some suicidal adventure."/>
                            </speak>
                          </actions>
                        </cue>
                        <cue name="Lockbox_Exasperated_Dal_Speak_2">
                          <conditions>
                            <event_speak_finished actor="$BosoTa" line="30220301"/>
                          </conditions>
                          <actions>
                            <speak actor="$DalBusta" priority="100">
                              <text line="30220312" comment="(sarcastic)So glad you're enjoying this as much as I am."/>
                            </speak>
                          </actions>
                        </cue>
                        <cue name="Lockbox_Exasperated_Speak_Finished">
                          <conditions>
                            <event_speak_finished actor="$DalBusta" line="30220312"/>
                          </conditions>
                          <actions>
                            <remove_value name="$SpeakInProgress"/>
                          </actions>
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Lockbox_Failsafe_Dal_Speak">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <delay exact="2s"/>
                      <cues>
                        <cue name="Ch3_Speak_Dal_315_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$DalBusta"/>
                          <param name="CutsceneKey"       value="$DalCutsceneKey"/>
                          <param name="Lines"             value="[[30220317]]"/>
                          <param name="EndSignalCue"      value="Lockbox_Failsafe"/>
                          <!--
                              There! That looks promising.
                                -->
                        </cue>
                      </cues>
                    </cue>

                  </cues>
                </cue>

                <cue name="Lockbox_Failsafe">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <cancel_cue cue="Lockbox_FindObject" comment="Stop all the collection and destruction checks from the first Find_Object."/>
                    <update_mission cue="$MissionCue">
                      <briefing>
                        <objective step="1" action="objective.collect" text="{30220,3003}" failed="true" comment="Collect: Old Stash of Explosives"/>
                        <objective step="2" action="objective.collect" text="{30220,3004}" comment="Collect: Holy Order Cipher"/>
                      </briefing>
                    </update_mission>
                    <!-- Since updating a mission interferes with our $CurrentStep counting, set it to the correct number manually here. -->
                    <set_value name="$CurrentStep" exact="2"/>
                    <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.find" text="{30220,3006}" updatebriefing="true" comment="Find: Second-Grade Explosives"/>
                    <!--Prepare failsafe RML, overwrite old RML setup variables-->
                    <!--Randomly varying offset for lockbox placement, southwest of Paranid Monument-->
                    <set_value name="$LockboxX" min="$ParanidMonumentOffset.x - 10km" max="$ParanidMonumentOffset.x - 30km"/>
                    <set_value name="$LockboxY" min="$ParanidMonumentOffset.y - 5km"  max="$ParanidMonumentOffset.y + 5km"/>
                    <set_value name="$LockboxZ" min="$ParanidMonumentOffset.z - 30km" max="$ParanidMonumentOffset.z - 50km"/>
                    <create_position name="$TargetOffset" object="$Chapter3_Sector" x="$LockboxX" y="$LockboxY" z="$LockboxZ"/>
                    <set_value name="$TargetRadius" exact="15km"/>
                    <set_value name="$CrateContent" exact="[[[ware.bomb_player_limpet_emp_01_mk1, 2], [ware.inv_rarespices, 3]]]" comment="Lockbox group -> Lockbox' crate group -> Crate"/>
                    <set_value name="$LockboxMacro" exact="macro.sm_gen_lockbox_common_01_macro"/>
                    <!--Use GM library to spawn crates. Output: $TargetObjects-->
                    <include_actions ref="md.GM_FindObject.Setup_SpawnCrates"/>
                  </actions>
                  <cues>
                    <cue name="FindObject_Ref_2" ref="md.RML_FindObject.FindObject">
                      <!--always pass these-->
                      <param name="EndSignalCue"      value="Lockbox_Failsafe_Bombs_Collected"/>
                      <param name="MissionCue"        value="$MissionCue"/>
                      <param name="StartStep"         value="$CurrentStep" comment="Briefing step to start the mission on"/>
                      <param name="UpdateBriefing"    value="true" comment="Update the briefing objective step when the objective is updated"/>
                      <param name="DebugChance"       value="$DebugChance"/>
                      <param name="Text_Objective_Find"   value="readtext.{30220}.{3005}" comment="Lockbox"/>
                      <param name="Text_Objective_Pickup" value="readtext.{30220}.{3006}" comment="Second-Grade Explosives"/>
                      <!--mission-related parameters-->
                      <param name="TargetSector"      value="$Chapter3_Sector"/>
                      <param name="TargetOffset"      value="$TargetOffset"/>
                      <param name="TargetRadius"      value="$TargetRadius"/>
                      <param name="TargetObjects"     value="$TargetObjects"/>
                      <param name="DroppedObjects"    value="$DroppedObjects"/>
                      <param name="SignalCue_ObjectsDropped" value="Lockbox_Failsafe_Bombs_Dropped"/>
                      <param name="SignalCue_ObjectCollected" value="null"/>
                    </cue>

                    <cue name="Lockbox_Failsafe_Make_Invincible">
                      <delay exact="2s"/>
                      <actions>
                        <set_object_min_hull object="$TargetObjects.{1}" exact="20" comment="We don't want to deal with this one getting destroyed as well."/>
                      </actions>
                    </cue>

                    <cue name="Lockbox_Failsafe_Bombs_Dropped">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <delay exact="0.5s"/>
                      <actions>
                        <debug_text text="'Dropped objects: ' + $DroppedObjects" chance="$DebugChance"/>
                        <do_for_each in="$DroppedObjects" name="$CurrentCrate">
                          <debug_text text="'Dropped crate: ' + $CurrentCrate + ' made invincible.'" chance="$DebugChance"/>
                          <set_object_min_hull object="$CurrentCrate" exact="100" comment="Players could theoretically destroy the dropped crates and get stuck."/>
                        </do_for_each>
                      </actions>
                      <cues>
                        <cue name="Lockbox_Failsafe_Bombs_Dropped_Failsafe">
                          <conditions>
                            <event_object_destroyed group="$DroppedObjects" comment="Ideally the drop is killed by being collected by the player, but we can't be sure."/>
                            <check_value value="$DroppedObjects.count == 1" comment="The last drop is being destroyed."/>
                          </conditions>
                          <actions>
                            <do_if value="(event.param2 == killmethod.collected) and (event.param.owner == faction.player)">
                              <debug_text text="'Player or one of their ships collected the dropped bombs. Everything is fine.'" chance="$DebugChance"/>
                            </do_if>
                            <do_else>
                              <debug_text text="'Bomb drop was destroyed or collected by a non-player owned ship. Sneakily add the items to the player inventory.'" chance="$DebugChance"/>
                              <add_inventory entity="player.entity" ware="ware.bomb_player_limpet_emp_01_mk1" exact="2"/>
                              <add_inventory entity="player.entity" ware="ware.inv_rarespices" exact="3"/>
                            </do_else>
                          </actions>
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Lockbox_Failsafe_Bombs_Collected">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <!-- Add a step here, after the objective is completed, so that the monument objective can overwrite this Await: Further Instructions objective. -->
                        <set_value name="$CurrentStep" exact="1" operation="add"/>
                        <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.await" text="{30220,3014}" updatebriefing="true" silent="true" insert="true" comment="Await: Further Instructions"/>
                        <!-- If the player doesn't have the bomb launcher at this point in the game, they get it for free. -->
                        <do_if value="not player.entity.inventory.{ware.weapon_gen_spacesuit_demolition_01_mk1}.count">
                          <add_inventory ware="ware.weapon_gen_spacesuit_demolition_01_mk1" entity="player.entity" exact="1"/>
                        </do_if>
                        <signal_cue cue="Lockbox_Failsafe_Bombs_Collected_Dal_Speak"/>
                      </actions>
                    </cue>

                    <cue name="Lockbox_Failsafe_Bombs_Collected_Dal_Speak">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <delay exact="2s"/>
                      <cues>
                        <cue name="Ch3_Speak_Dal_321_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$DalBusta"/>
                          <param name="CutsceneKey"       value="$DalCutsceneKey"/>
                          <param name="Lines"             value="[[30220321],]"/>
                          <param name="EndSignalCue"      value="Cipher_Monument"/>
                          <!--
                              There are no explosives here, just an EMP(pronounced E.M.P.) device. What a let-down.
                                -->
                        </cue>
                      </cues>
                    </cue>

                  </cues>
                </cue>

              </cues>
            </cue>

            <cue name="Cipher_Monument">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <!--$DalBusta mentions the Monument and wants to take a look-->
                <debug_text text="'Starting monument sightseeing'" chance="$DebugChance"/>

                <!--Failsafe: Revert invincibility again, just in case something went wrong-->
                <set_object_min_hull object="player.ship" exact="0"/>
              </actions>
              <cues>

                <cue name="Monument_Approach">
                  <cues>

                    <cue name="Ch3_Speak_Dal_322_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$DalBusta"/>
                      <param name="CutsceneKey"       value="$DalCutsceneKey"/>
                      <param name="Lines"             value="[[30220322],[30220323],[30220324]]"/>
                      <param name="EndSignalCue"      value="null"/>
                      <!--
                          Hm, that reminds me of something.
                          I know Gride wants us to follow her instructions to the letter, but while we're here let's take a closer look at that monument the Paranid are so secretive about.
                          I've always been curious.
                            -->
                    </cue>

                    <cue name="Monument_Approach_Update_Objective">
                      <conditions>
                        <event_speak_line_finished actor="$DalBusta" line="30220323"/>
                      </conditions>
                      <actions>
                        <!-- The last step was Await: Further Instructions and should be overwritten, so don't add 1 to the step count here. -->
                        <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.explore" object="$ParanidMonument" updatebriefing="true" comment="Explore: Paranid Monument"/>
                      </actions>
                      <cues>
                        <cue name="Monument_Approach_Dal_Speak" checkinterval="1s">
                          <conditions>
                            <check_value value="player.entity.distanceto.{$ParanidMonument} lt 20km"/>
                            <check_value value="player.entity.sector == $ParanidMonumentSector"/>
                          </conditions>
                          <cues>
                            <cue name="Ch3_Speak_Dal_325_Ref" ref="md.LIB_Dialog.Speak_Actor">
                              <param name="Actor"             value="$DalBusta"/>
                              <param name="CutsceneKey"       value="$DalCutsceneKey"/>
                              <param name="Lines"             value="[[30220325]]"/>
                              <param name="EndSignalCue"      value="Monument_Approach_Dal_Speak_Finished"/>
                              <!--
                                  I think it would be best to approach it from straight above or below, where the security looks to be weakest.
                                    -->
                            </cue>
                          </cues>
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Monument_Approach_Dal_Speak_Finished">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <!-- Create guidance markers on plane surfaces relatively close to the monument window. -->
                        <create_position name="$SurfaceAimPosition_1" space="$ParanidMonumentSector" x="92361.883" y="495.866" z="13910.521"/>
                        <create_position name="$SurfaceAimPosition_2" space="$ParanidMonumentSector" x="91952.031" y="-2269.752" z="13909.124"/>
                      </actions>
                      <cues>
                        <cue name="Monument_Reached_Switch_Guidance_Parent">
                          <cues>
                            <cue name="Monument_Reached_Switch_Guidance" checkinterval="2s" instantiate="true" comment="Switch guidance between two points on the monument surface.">
                              <conditions>
                                <check_value value="true"/>
                              </conditions>
                              <actions>
                                <do_if value="player.entity.sector == $ParanidMonumentSector">
                                  <create_position name="$PlayerPositionInSector" object="player.entity" space="$ParanidMonumentSector"/>
                                  <do_if value="($PlayerPositionInSector.distanceto.{$SurfaceAimPosition_1} lt 700m) or ($PlayerPositionInSector.distanceto.{$SurfaceAimPosition_2} lt 700m)">
                                    <signal_cue cue="Monument_Reached_Dal_Speak"/>
                                  </do_if>
                                  <do_else>
                                    <do_if value="$PlayerPositionInSector.distanceto.{$SurfaceAimPosition_1} lt $PlayerPositionInSector.distanceto.{$SurfaceAimPosition_2}">
                                      <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.explore" text="{20103,1201}" object="$ParanidMonumentSector" offset="$SurfaceAimPosition_1" updatebriefing="true" silent="true" comment="Explore: Apotheosis"/>
                                    </do_if>
                                    <do_else>
                                      <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.explore" text="{20103,1201}" object="$ParanidMonumentSector" offset="$SurfaceAimPosition_2" updatebriefing="true" silent="true" comment="Explore: Apotheosis"/>
                                    </do_else>
                                  </do_else>
                                </do_if>
                              </actions>
                            </cue>
                          </cues>
                        </cue>
                        <cue name="Monument_Reached_Dal_Speak">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <actions>
                            <cancel_cue cue="Monument_Reached_Switch_Guidance_Parent"/>
                            <set_value name="$MonumentPlayerShip" exact="player.entity.ship"/>
                          </actions>
                          <cues>
                            <cue name="Ch3_Speak_Dal_326_Ref" ref="md.LIB_Dialog.Speak_Actor">
                              <param name="Actor"             value="$DalBusta"/>
                              <param name="CutsceneKey"       value="$DalCutsceneKey"/>
                              <param name="Lines"             value="[[if player.entity.isfemale then 30220327 else 30220326]]"/>
                              <param name="EndSignalCue"      value="Monument_Surveillance"/>
                              <!--
                                  If you can manage to disable their surveillance systems, we should have a chance to snoop around a bit more.
                                  (spoken to female player 'you'){10111,30220326}
                                    -->
                            </cue>
                          </cues>
                        </cue>
                      </cues>
                    </cue>

                  </cues>
                </cue>

                <cue name="Monument_Surveillance">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <cues>

                    <cue name="Monument_Surveillance_Spacesuit">
                      <cues>

                        <cue name="Monument_Surveillance_Spacesuit_Dal_Speak">
                          <cues>
                            <cue name="Ch3_Speak_Dal_328_Ref" ref="md.LIB_Dialog.Speak_Actor">
                              <param name="Actor"             value="$DalBusta"/>
                              <param name="CutsceneKey"       value="$DalCutsceneKey"/>
                              <param name="Lines"             value="[[if player.entity.isfemale then 30220329 else 30220328]]"/>
                              <param name="EndSignalCue"      value="Monument_Surveillance_Spacesuit_Update_Objective"/>
                              <!--
                                  Get into your space suit.
                                  (spoken to female player 'your'){10111,30220328}
                                    -->
                            </cue>
                          </cues>
                        </cue>

                        <cue name="Monument_Surveillance_Spacesuit_Update_Objective">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <actions>
                            <do_if value="player.ship.isclass.spacesuit">
                              <signal_cue cue="Monument_Surveillance_EMP"/>
                            </do_if>
                            <do_else>
                              <find_player_transporter_slot name="$TransporterSlot" object="player.entity.ship.controlroom"/>
                              <set_value name="$CurrentStep" exact="1" operation="add"/>
                              <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.usespacesuit" slot="$TransporterSlot" updatebriefing="true" insert="true" comment="Use Spacesuit"/>
                              <signal_cue cue="Monument_Surveillance_Activate_Spacesuit_Check"/>
                            </do_else>
                          </actions>
                        </cue>

                        <cue name="Monument_Surveillance_Activate_Spacesuit_Check">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <cues>
                            <cue name="Monument_Surveillance_Spacesuit_Check">
                              <conditions>
                                <event_object_changed_room object="player.entity"/>
                                <check_value value="player.ship.isclass.spacesuit"/>
                              </conditions>
                              <actions>
                                <signal_cue cue="Monument_Surveillance_EMP"/>
                              </actions>
                            </cue>
                          </cues>
                        </cue>

                      </cues>
                    </cue>

                    <cue name="Monument_Surveillance_EMP">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <create_group groupname="$MonumentSignalLeaks"/>
                      </actions>
                      <cues>
                        <cue name="Monument_Surveillance_EMP_Dal_Speak">
                          <actions>
                            <set_value name="$SpeakInProgress"/>
                          </actions>
                          <cues>
                            <cue name="Ch3_Speak_Dal_330_Ref" ref="md.LIB_Dialog.Speak_Actor">
                              <param name="Actor"             value="$DalBusta"/>
                              <param name="CutsceneKey"       value="$DalCutsceneKey"/>
                              <param name="Lines"             value="[[if player.entity.isfemale then 30220331 else 30220330]]"/>
                              <param name="EndSignalCue"      value="null"/>
                              <!--
                                  Now, use an EMP(pronounced E.M.P.) to create a breach, and then scan it.
                                  (spoken to female player){10111,30220330}
                                    -->
                            </cue>
                            <cue name="Monument_Surveillance_EMP_Dal_Speak_Finished">
                              <actions>
                                <remove_value name="$SpeakInProgress"/>
                                <signal_cue cue="Monument_Surveillance_EMP_Update_Objective"/>
                              </actions>
                            </cue>
                          </cues>
                        </cue>

                        <cue name="Monument_Surveillance_EMP_Update_Objective">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <actions>
                            <set_value name="$CurrentStep" exact="1" operation="add"/>
                            <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.launch" object="$ParanidMonument" text="{30220,3007}" updatebriefing="true" insert="true" comment="Launch: EMP to Create Signal Leak"/>
                            <add_to_group groupname="$PlayerWeaponsGroup" list="player.ship.weapons.operational.list"/>
                          </actions>
                          <cues>

                            <cue name="Monument_Surveillance_Wrong_Ammo">
                              <conditions>
                                <event_player_bomb_attached/>
                                <check_value value="event.param.macro != macro.bomb_player_limpet_emp_01_mk1_macro"/>
                                <check_value value="event.param.hascontext.{$ParanidMonument}"/>
                              </conditions>
                              <cues>
                                <cue name="Ch3_Speak_Boso_002_Ref" ref="md.LIB_Dialog.Speak_Actor">
                                  <param name="Actor" value="$BosoTa"/>
                                  <param name="CutsceneKey" value="$BosoCutsceneKey"/>
                                  <param name="Lines" value="[[if player.entity.isfemale then 30200003 else 30200002], [if player.entity.isfemale then 30200005 else 30200004], [30200006]]"/>
                                  <param name="EndSignalCue"      value="Monument_Surveillance_Wrong_Ammo_Delay"/>

                                  <!--
                                        I am terribly sorry to disrupt your magnificent focus.
                                        The ordnance you are using does not appear to be particularly suitable for the job.
                                        I recommend switching to EMPs.(pronounced Ee-Em-Pees)
                                  -->
                                </cue>
                                <cue name="Monument_Surveillance_Wrong_Ammo_Delay">
                                  <conditions>
                                    <event_cue_signalled/>
                                  </conditions>
                                  <delay exact="20s"/>
                                  <actions>
                                    <reset_cue cue="Monument_Surveillance_Wrong_Ammo"/>
                                  </actions>
                                </cue>
                              </cues>
                            </cue>

                            <cue name="Monument_Surveillance_EMP_Launched">
                              <conditions>
                                <event_weapon_fired group="$PlayerWeaponsGroup"/>
                                <check_value value="event.param.macro == macro.bomb_player_limpet_emp_01_mk1_macro"/>
                                <check_value value="$BombsCollected?" comment="This tells us if the player has Gride's original EMPs."/>
                              </conditions>
                              <cues>
                                <cue name="Monument_Surveillance_EMP_Launched_Dal_Speak">
                                  <cues>
                                    <cue name="Ch3_Speak_Dal_332_Ref" ref="md.LIB_Dialog.Speak_Actor">
                                      <param name="Actor"             value="$DalBusta"/>
                                      <param name="CutsceneKey"       value="$DalCutsceneKey"/>
                                      <param name="Lines"             value="[[30220332]]"/>
                                      <param name="EndSignalCue"      value="Monument_Surveillance_EMP_Launched_Dal_Speak_Finished"/>
                                      <!--
                                          I'm sure Gride won't mind if we appropriate one of them for our own purposes.
                                            -->
                                    </cue>
                                    <cue name="Monument_Surveillance_EMP_Launched_Dal_Speak_Finished">
                                      <conditions>
                                        <event_cue_signalled/>
                                      </conditions>
                                      <actions>
                                        <set_value name="$MentionedUsingGridesEMPs"/>
                                      </actions>
                                    </cue>
                                  </cues>
                                </cue>
                                <cue name="Monument_Surveillance_EMP_2_Launched">
                                  <conditions>
                                    <event_weapon_fired group="$PlayerWeaponsGroup"/>
                                    <check_value value="event.param.macro == macro.bomb_player_limpet_emp_01_mk1_macro"/>
                                  </conditions>
                                  <cues>
                                    <cue name="Monument_Surveillance_EMP_2_Launched_Dal_Speak" checkinterval="1s">
                                      <conditions>
                                        <check_value value="$MentionedUsingGridesEMPs?" comment="Only say this once the first mention of Gride's EMPs is finished."/>
                                      </conditions>
                                      <cues>
                                        <cue name="Ch3_Speak_Dal_333_Ref" ref="md.LIB_Dialog.Speak_Actor">
                                          <param name="Actor"             value="$DalBusta"/>
                                          <param name="CutsceneKey"       value="$DalCutsceneKey"/>
                                          <param name="Lines"             value="[[30220333]]"/>
                                          <param name="EndSignalCue"      value="Monument_Surveillance_EMP_2_Launched_Dal_Speak_Finished"/>
                                          <!--
                                              (sigh)Or indeed a few of them.
                                                -->
                                        </cue>
                                      </cues>
                                    </cue>
                                    <cue name="Monument_Surveillance_EMP_2_Launched_Dal_Speak_Finished">
                                      <conditions>
                                        <event_cue_signalled/>
                                      </conditions>
                                      <actions>
                                        <remove_value name="$MentionedUsingGridesEMPs"/>
                                      </actions>
                                    </cue>
                                  </cues>
                                </cue>
                              </cues>
                            </cue>

                          </cues>
                        </cue>

                        <cue name="Monument_Surveillance_EMP_Check_For_Breach">
                          <conditions>
                            <event_player_created_signal_leaks/>
                            <check_value value="event.param.{1}.parent == $ParanidMonument"/>
                          </conditions>
                          <actions>
                            <cancel_cue cue="Monument_Surveillance_Wrong_Ammo"/>
                            <do_for_each in="event.param" name="$CurrentElement">
                              <add_to_group groupname="$MonumentSignalLeaks" object="$CurrentElement"/>
                            </do_for_each>
                            <set_value name="$CurrentStep" exact="1" operation="add"/>
                            <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.scan" group="$MonumentSignalLeaks" text="{30220,3008}" insert="true" updatebriefing="true" comment="Scan: Signal Leak"/>
                          </actions>
                          <cues>
                            <cue name="Monument_Surveillance_EMP_Check_For_Further_Breaches" instantiate="true">
                              <conditions>
                                <event_player_created_signal_leaks/>
                                <check_value value="event.param.{1}.parent == $ParanidMonument"/>
                              </conditions>
                              <actions>
                                <do_for_each in="event.param" name="$CurrentElement">
                                  <add_to_group groupname="$MonumentSignalLeaks" object="$CurrentElement"/>
                                </do_for_each>
                                <set_value name="$CurrentStep" exact="1" operation="add"/>
                                <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.scan" group="$MonumentSignalLeaks" text="{30220,3008}" silent="true" updatebriefing="true" comment="Scan: Signal Leak"/>
                              </actions>
                            </cue>
                            <cue name="Monument_Surveillance_EMP_Leaks_Destroyed">
                              <conditions>
                                <event_object_destroyed group="$MonumentSignalLeaks"/>
                                <check_value value="$MonumentSignalLeaks.count == 1"/>
                              </conditions>
                              <actions>
                                <set_value name="$CurrentStep" exact="1" operation="add"/>
                                <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.launch" object="$ParanidMonument" text="{30220,3007}" updatebriefing="true" comment="Launch: EMP to Create Signal Leak"/>
                                <reset_cue cue="Monument_Surveillance_EMP_Check_For_Breach"/>
                              </actions>
                            </cue>
                          </cues>
                        </cue>

                        <cue name="Monument_Surveillance_EMP_Check_For_Scan">
                          <conditions>
                            <check_any>
                              <event_player_repaired_signal_leak/>
                              <event_player_signal_unlock_impossible/>
                              <event_player_signal_unlock_finished/>
                            </check_any>
                            <check_value value="$MonumentSignalLeaks.indexof.{event.param}"/>
                          </conditions>
                          <actions>
                            <signal_cue cue="Monument_Snoop"/>
                          </actions>
                        </cue>
                      </cues>

                    </cue>

                  </cues>
                </cue>

                <cue name="Monument_Snoop">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <cancel_cue cue="Monument_Surveillance_EMP_Check_For_Breach" comment="If we don't cancel the check for the leaks to be destroyed, that check will trigger when they despawn later."/>
                    <cancel_cue cue="Monument_Surveillance_Wrong_Ammo"/>
                    <find_object_component name="$ParanidMonumentEntranceWindow" object="$ParanidMonument" macro="macro.positiondummy4_macro" multiple="false" required="true"/>
                    <find_object_component name="$ParanidMonumentCenter" object="$ParanidMonument" macro="macro.landmarks_par_monument_center_01_macro" required="true"/>
                  </actions>
                  <cues>

                    <cue name="Monument_Snoop_Search_Dal_Speak">
                      <cues>
                        <cue name="Ch3_Speak_Dal_334_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$DalBusta"/>
                          <param name="CutsceneKey"       value="$DalCutsceneKey"/>
                          <param name="Lines"             value="[[30220334],[30220335],[if player.entity.isfemale then 30220337 else 30220336]]"/>
                          <param name="EndSignalCue"      value="Monument_Snoop_Find_Hatch"/>
                          <!--
                              There!
                              Something on the surface just moved.
                              See if you can find the spot.
                              (spoken to female player 'you'){10111,30220336}
                                -->
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Monument_Snoop_Find_Hatch">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <set_value name="$CurrentStep" exact="1" operation="add"/>
                        <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.investigate" object="$ParanidMonumentEntranceWindow" text="{30220,3009}" updatebriefing="true" insert="true" comment="Find: Suspicious Movement"/>
                      </actions>
                      <cues>
                        <cue name="Approach_Monument_Hatch_Ref" ref="md.LIB_Generic.ApproachObject_Handler">
                          <param name="ApproachTarget"    value="$ParanidMonumentEntranceWindow"/>
                          <param name="ApproachDistance"  value="40m"/>
                          <param name="SuccessSignalCue"  value="Monument_Snoop_Hatch_Found_Update_Objective"/>
                        </cue>
                        <cue name="Monument_Snoop_Hatch_Found_Update_Objective">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <actions>
                            <trigger_animation object="$ParanidMonumentCenter" trigger="open_doors2"/>
                            <set_value name="$CurrentStep" exact="1" operation="add"/>
                            <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.observe" object="$ParanidMonumentEntranceWindow" text="if (player.entity.race == race.paranid) then {30220,3010} else {30220,3011}" updatebriefing="true" insert="true" comment="Observe: Strangely Familiar Shapes / Unfamiliar Shapes"/>
                            <signal_cue cue="Monument_Snoop_Hatch_Dal_Boso_Speak"/>
                          </actions>
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Monument_Snoop_Hatch_Dal_Boso_Speak">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <cues>
                        <cue name="Ch3_Speak_Dal_Boso_338_Ref" ref="md.LIB_Dialog.Speak_Actors">
                          <param name="Actor"             value="[$DalBusta, $BosoTa, $DalBusta]"/>
                          <param name="CutsceneKey"       value="[$DalCutsceneKey, $BosoCutsceneKey, $DalCutsceneKey]"/>
                          <param name="Lines"             value="[  [[30220338]],
                                                                    [[30220304, 1s], [30220305, 1s], [30220306]],
                                                                    [[30220339],[30220340],[30220341]]
                                                                ]"/>
                          <param name="EndSignalCue"      value="[null, null, Monument_Guard_Response]"/>
                          <!--Dal:
                              Boso, can you make any sense of this?
                              Boso:
                              Those shapes do seem to align with my research into Paranid cocoons.
                              Interesting. The crystalline formations surfaces suggest some form of preservation technology.
                              It would appear that these lucky fellows are being securely stored for some special occasion.
                              Dal:
                              You've done research on... (pause before 'never mind')never mind.
                              Judging by the thickness of the armoured security hatch, these Paranid must be rather important.
                              There are a lot of empty berths here, though. I wonder why.
                              -->
                        </cue>
                      </cues>
                    </cue>
                  </cues>
                </cue>

                <cue name="Monument_Guard_Response">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <debug_text text="'Monument guard triggered, warning and following player.'"/>
                    <set_value name="$StoryFleeRadius" exact="12km"/>
                    <set_value name="$StoryComplyRadius" exact="6km"/>
                  </actions>
                  <cues>

                    <cue name="Monument_Guard_Warning">
                      <actions>
                        <find_ship name="$HonourGuardLeader" job="'holyorder_corvette_elite_m'" space="player.galaxy"/>
                        <do_if value="$HonourGuardLeader.exists and $HonourGuardLeader.isoperational and ($HonourGuardLeader.distanceto.{$ParanidMonument} le 50km)" comment="If it's being constructed, pretend that there's no ship left.">
                          <find_ship groupname="$HonourGuardSquad" multiple="true" job="'holyorder_corvette_escort_elite_m'" space="player.galaxy"/>
                          <add_to_group groupname="$HonourGuardSquad" object="$HonourGuardLeader"/>
                          <create_order id="'Follow'" object="$HonourGuardLeader" immediate="true">
                            <param name="target" value="if $MonumentPlayerShip.exists then $MonumentPlayerShip else player.entity.ship" comment="$MonumentPlayerShip was set in the last mission"/>
                          </create_order>
                          <signal_cue cue="Monument_Guard_Warning_Alive"/>
                        </do_if>
                        <do_else>
                          <signal_cue cue="Monument_Guard_Warning_Dead"/>
                        </do_else>
                      </actions>
                    </cue>

                    <cue name="Monument_Guard_Warning_Alive">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <do_if value="player.entity.race == race.paranid">
                          <set_value name="$RikMonumentWarning" exact="[[if player.entity.isfemale then 30220302 else 30220301, 1s], [30220303, 1s], [if player.entity.isfemale then 30220305 else 30220304],[30220306, 0.5s]]"/>
                        </do_if>
                        <do_else>
                          <set_value name="$RikMonumentWarning" exact="[[if player.entity.isfemale then 30220302 else 30220301, 1s], [if player.entity.isfemale then 30220305 else 30220304],[30220306, 0.5s]]"/>
                        </do_else>
                      </actions>
                      <cues>
                        <cue name="Ch3_Speak_Rik_Dal_301_Ref" ref="md.LIB_Dialog.Speak_Actors">
                          <param name="Actor"             value="[$RikActor, $DalBusta]"/>
                          <param name="CutsceneKey"       value="[$RikCutsceneKey, $DalCutsceneKey]"/>
                          <param name="Lines"             value="[  $RikMonumentWarning,
                                                                    [[if player.entity.isfemale then 30220343 else 30220342],[if player.entity.isfemale then 30220345 else 30220344, 0.5s],[30220346]]
                                                                ]"/>
                          <param name="EndSignalCue"      value="[null, Monument_Guard_Timer]"/>
                          <!--Rik:
                              You are in the presence of Rikmanckassor, Honor Guard of the True Pontifex and anointed Priest Guardian of His righteous claim.
                              (spoken to female player 'you'){10304,30220301}
                              (if Paranid)Paranid or not...
                              You are hereby commanded to remove yourself from these premises, or be struck down by the wrath of the Prophets.
                              (spoken to female player 'you'){10304,30220304}
                              In the name of His Holiness, may He be forever bathed in the light of the Sacred Three-Dimensionality...
                              Dal:
                              At least he won't attack you while he's talking, right?
                              (spoken to female player 'you'){10111,30220342}
                              I think you'd better comply.
                              (spoken to female player 'you'){10111,30220344}
                              We can always return later.
                              -->
                        </cue>
                      </cues>
                    </cue>

                    <!-- Obscure event that only happens if the player went and killed the guards before the mission.-->
                    <cue name="Monument_Guard_Warning_Dead">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <cues>
                        <cue name="Ch3_Speak_Dal_349_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$DalBusta"/>
                          <param name="CutsceneKey"       value="$DalCutsceneKey"/>
                          <param name="Lines"             value="[[30220349],[30220350]]"/>
                          <param name="EndSignalCue"      value="Monument_Guard_Response_Cleanup"/>
                          <!--
                              This is a bit strange. I have expected station security to be on our tail by now.
                              Something must have kept them busy.
                                -->
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Monument_Guard_Timer">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <set_value name="$EndTime" exact="player.age + 2min"/>
                        <set_value name="$CurrentStep" exact="1" operation="add"/>
                        <create_position name="$FleePosition" space="$ParanidMonumentSector" x="$ParanidMonumentPosition.x" z="$ParanidMonumentPosition.z + $StoryComplyRadius + 5km"/>
                        <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.retreat" text="{30220,3012}" object="$ParanidMonumentSector" offset="$FleePosition" endtime="$EndTime" updatebriefing="true" insert="true" comment="Retreat: To Safe Distance"/>
                      </actions>
                      <cues>

                        <cue name="Monument_Guard_Comply" checkinterval="1s">
                          <conditions>
                            <check_value value="player.entity.distanceto.{$ParanidMonument} ge $StoryComplyRadius"/>
                          </conditions>
                          <actions>
                            <signal_cue cue="Monument_Guard_Response_Cleanup"/>
                          </actions>
                        </cue>

                        <cue name="Monument_Guard_Ignore">
                          <delay exact="2min"/>
                          <actions>
                            <cancel_cue cue="Monument_Guard_Comply"/>
                            <set_value name="$CurrentStep" exact="1" operation="add"/>
                            <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.defeat" text="{20204,3901}" group="$HonourGuardSquad" updatebriefing="true" insert="true" comment="Defeat: Rising Solitude"/>
                            <signal_cue cue="Monument_Guard_Attack"/>
                          </actions>
                        </cue>

                      </cues>
                    </cue>

                    <cue name="Monument_Guard_Attack">
                      <conditions>
                        <check_any>
                          <event_cue_signalled/>
                          <check_all>
                            <event_object_attacked group="$HonourGuardSquad"/>
                            <check_value value="event.param.owner == faction.player"/>
                          </check_all>
                        </check_any>
                      </conditions>
                      <actions>
                        <cancel_cue cue="Monument_Guard_Timer"/>
                        <do_if value="not $HonourGuardSquad.count">
                          <signal_cue cue="Monument_Guard_Response_Cleanup"/>
                        </do_if>
                      </actions>
                      <cues>

                        <cue name="Ch3_Speak_Rik_307_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$RikActor"/>
                          <param name="CutsceneKey"       value="$RikCutsceneKey"/>
                          <param name="Lines"             value="[[if player.entity.isfemale then 30220308 else 30220307], [if player.entity.isfemale then 30220310 else 30220309]]"/>
                          <param name="EndSignalCue"      value="Monument_Guard_Attack_Order"/>
                          <!--
                          Your vessel will now be destroyed and your remains disposed of.
                          (spoken to female player 'your'){10304,30220307}
                          Do not resist.
                          (spoken to female player){10304,30220309}
                          -->
                        </cue>

                        <cue name="Monument_Guard_Attack_Order">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <actions>
                            <do_if value="$HonourGuardSquad.count">
                              <do_for_each in="$HonourGuardSquad" name="$CurrentNemesis">
                                <set_relation_boost object="$CurrentNemesis" value="-1" faction="faction.player" silent="true" decay="0" comment="relentless"/>
                                <create_order object="$CurrentNemesis" id="'Attack'" immediate="true">
                                  <param name="primarytarget" value="if $MonumentPlayerShip.exists then $MonumentPlayerShip else player.entity.ship"/>
                                  <param name="pursuetargets" value="true"/>
                                </create_order>
                                <set_object_relation_behaviour object="$CurrentNemesis" disable="true"/>
                              </do_for_each>
                            </do_if>
                            <do_else>
                              <signal_cue cue="Monument_Guard_Response_Cleanup"/>
                            </do_else>
                          </actions>
                        </cue>

                        <cue name="Monument_Guard_Player_Gained_Distance" checkinterval="1s">
                          <conditions>
                            <check_value value="$MonumentPlayerShip.distanceto.{$ParanidMonument} ge $StoryFleeRadius"/>
                          </conditions>
                          <actions>
                            <signal_cue cue="Monument_Guard_Player_Fled"/>
                          </actions>
                        </cue>

                        <cue name="Monument_Guard_Player_Ship_Destroyed">
                          <conditions>
                            <event_object_destroyed object="$MonumentPlayerShip"/>
                            <check_value value="Monument_Guard_Response_Cleanup.state == cuestate.waiting" comment="To prevent this from firing in a later chapter."/>
                          </conditions>
                          <actions>
                            <do_if value="player.entity.distanceto.{$ParanidMonument} le $StoryComplyRadius">
                              <set_value name="$MonumentPlayerShip" exact="player.entity.ship"/>
                              <do_for_each in="$HonourGuardSquad" name="$CurrentNemesis">
                                <create_order object="$CurrentNemesis" id="'Attack'" immediate="true">
                                  <param name="primarytarget" value="$MonumentPlayerShip"/>
                                  <param name="pursuetargets" value="true"/>
                                </create_order>
                              </do_for_each>
                            </do_if>
                            <do_else>
                              <signal_cue cue="Monument_Guard_Player_Fled"/>
                            </do_else>
                          </actions>
                        </cue>

                        <cue name="Monument_Guard_Player_Fled">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <actions>
                            <debug_text text="'Paranid Story Monument Guard Response: Trespassing ship gained distance or got destroyed while at least one of the Honour Guard was still alive.'" chance="$DebugChance"/>
                            <set_value name="$MissionCue.$MonumentGuardPlayerFled" comment="Have the story mission remember that the player fled from the guard previously."/>
                            <signal_cue cue="Monument_Guard_Response_Cleanup"/>
                          </actions>
                        </cue>

                        <cue name="Monument_Guard_Ship_Captured" instantiate="true">
                          <conditions>
                            <event_object_changed_true_owner group="$HonourGuardSquad"/>
                            <check_value value="$HonourGuardSquad.count ge 2"/>
                          </conditions>
                          <actions>
                            <remove_from_group group="$HonourGuardSquad" object="event.object"/>
                          </actions>
                        </cue>

                        <cue name="Monument_Guard_Ships_Destroyed">
                          <conditions>
                            <check_any>
                              <event_object_changed_true_owner group="$HonourGuardSquad"/>
                              <event_object_destroyed group="$HonourGuardSquad"/>
                            </check_any>
                            <check_value value="$HonourGuardSquad.count == 1" comment="Last squad member is destroyed."/>
                          </conditions>
                          <actions>
                            <do_if value="event.name == 'event_object_changed_true_owner'">
                              <remove_from_group group="$HonourGuardSquad" object="event.object"/>
                            </do_if>
                            <do_if value="$MissionCue.$MonumentGuardPlayerFled?">
                              <debug_text text="'Paranid Story Monument Guard Response: Player previously fled, but returned and defeated the Honour Guard.'" chance="$DebugChance"/>
                              <remove_value name="$MissionCue.$MonumentGuardPlayerFled" comment="If the player fled previously, have the story mission now remember that they defeated the guard instead."/>
                            </do_if>
                            <debug_text text="'Paranid Story Monument Guard Response: Paranid Story will remember that the player defeated the Honour Guard.'" chance="$DebugChance"/>
                            <set_value name="$MissionCue.$MonumentGuardKilledPrematurely"/>
                            <signal_cue cue="Monument_Guard_Victory_Dal_Speak"/>
                          </actions>
                        </cue>

                        <cue name="Monument_Guard_Victory_Dal_Speak">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <cues>
                            <cue name="Ch3_Speak_Dal_347_Ref" ref="md.LIB_Dialog.Speak_Actor">
                              <param name="Actor"             value="$DalBusta"/>
                              <param name="CutsceneKey"       value="$DalCutsceneKey"/>
                              <param name="Lines"             value="[[30220347],[30220348]]"/>
                              <param name="EndSignalCue"      value="Monument_Guard_Response_Cleanup"/>
                              <!--
                              Ha!
                              We won't be seeing him(emphasis on 'him') again.
                                -->
                            </cue>
                          </cues>
                        </cue>

                      </cues>
                    </cue>

                    <cue name="Monument_Guard_Response_Cleanup">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <trigger_animation object="$ParanidMonumentCenter" trigger="close_doors2"/>
                        <do_if value="$HonourGuardSquad.count">
                          <do_for_each in="$HonourGuardSquad" name="$CurrentNemesis">
                            <cancel_all_orders object="$CurrentNemesis"/>
                            <reset_relation_boost object="$CurrentNemesis" faction="faction.player" otherobject="if $MonumentPlayerShip.exists then $MonumentPlayerShip else player.entity.ship"/>
                          </do_for_each>
                        </do_if>
                        <cancel_cue cue="Ch3_Story_Reminder"/>
                        <signal_cue cue="Cipher_Warzone"/>
                        <cancel_cue cue="Monument_Guard_Response"/>
                      </actions>
                    </cue>

                  </cues>
                </cue>

              </cues>
            </cue>

            <cue name="Cipher_Warzone">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <debug_text text="'Starting chapter 3, part 3 (warzone)'" chance="$DebugChance"/>

                <!-- Find alternative spot for the cipher ship if the Xenon sector is not okay. Step 1: Set a temporary ideal dropoff station
                <find_sector name="$DropOffSector" macro="Cluster_24_Sector001_macro"/>
                <set_value name="$DropOffStation" exact="null"/>
                <find_station_by_true_owner name="$DropOffStation" faction="faction.holyorder" sortbydistanceto="$DropOffSector" space="player.galaxy" checkoperational="true" tradestation="true"/>
                <do_if value="not $DropOffStation">
                  <find_station_by_true_owner name="$DropOffStation" faction="faction.holyorder" sortbydistanceto="$DropOffSector" space="player.galaxy" checkoperational="true"/>
                </do_if>
                <create_list name="$MutualEnemies" comment="Find all mutual enemy factions of the player and the Holy Order"/>
                <get_factions_by_relation result="$HOPEnemies" relation="enemy" faction="faction.holyorder"/>
                <get_factions_by_relation result="$PlayerEnemies" relation="enemy" faction="faction.player"/>
                <do_for_each in="$HOPEnemies" valuename="$CurrentFaction">
                  <do_if value="$PlayerEnemies.indexof.{$CurrentFaction}">
                    <append_to_list name="$MutualEnemies" exact="$CurrentFaction"/>
                  </do_if>
                </do_for_each>
                <do_if value="$MutualEnemies.count" comment="Select the closest mutual enemy sector as mission location">
                  <find_sector_in_range distances="$MutualEnemySectorDistances" object="$DropOffStation" owner="$MutualEnemies" maxdistance="4" multiple="true"/>
                  <set_value name="$MutualEnemySectors" exact="$MutualEnemySectorDistances.keys.sorted"/>
                  <set_value name="$CipherSector" exact="$MutualEnemySectors.{1}"/>
                </do_if>
                <do_if value="not $CipherSector" comment=" If nothing is found, use library">
                  <set_value name="$Faction" exact="faction.holyorder"/>
                  <include_actions ref="md.LIB_Generic.FindNearestEnemySectorForFaction" comment="input: $Faction, output: $NearestEnemySector"/>
                  <set_value name="$CipherSector" exact="$NearestEnemySector"/>
                </do_if>-->

                <!-- Version with specific sector and enemy -->
                <find_sector name="$CipherSector" macro="macro.cluster_25_sector002_macro"/>
                <find_zone name="$CipherZone" macro="macro.zone001_cluster_25_sector002_macro"/>
                <set_value name="$HostileFaction" exact="faction.xenon"/>

                <!--<create_position name="$CipherShipPosition" space="$CipherSector" x="5636.945" y="7000" z="16061.906"/>-->

                <!-- Spawn Cipher Ship -->
                <create_ship name="$CipherShip" macro="ship_par_l_destroyer_01_b_macro" commandeerable="false" capturable="false" mission="true" sector="$CipherSector" zone="$CipherZone">
                  <owner exact="faction.holyorder" overridenpc="true"/>
                  <pilot>
                    <select faction="faction.holyorder" tags="tag.elitepilot"/>
                  </pilot>
                  <loadout ref="story_paranid_stranded_odysseus"/>
                  <people ref="paranid_elite_military_crew"/>
                  <!-- Right in front of the sector entrance, in a tracker mine field, facing the sector exit -->
                  <position x="5636.945" y="7000" z="16061.906"/>
                  <rotation yaw="44.59791deg" pitch="-0.695219deg"/>
                </create_ship>

                <set_object_name object="$CipherShip" page="30220" line="131" comment="{20204,3901} {20101,30703}(Rising Solitude Odysseus Sentinel)"/>

                <!-- Create crate with cipher. First: Find docking bays -->
                <set_value name="$CipherWare" exact="ware.inv_artificial_paranid_eye"/>
                <find_dockingbay name="$DockingBays" object="$CipherShip" checkoperational="true" multiple="true">
                  <match_any>
                    <match_dock size="tag.dock_m"/>
                    <match_dock size="tag.dock_s"/>
                  </match_any>
                </find_dockingbay>
                <!-- Find $CrateSlots in all $DockingBays-->
                <create_list name="$CrateSlots"/>
                <set_value name="$SelectedDockingBay" exact="$DockingBays.random"/>
                <find_crate_slot name="$CrateSlots" object="$SelectedDockingBay" tags="tag.crate_s" multiple="true" />
                <debug_text text="'Found #crateslots:' + $CrateSlots.count" chance="$DebugChance"/>
                <!-- Spawn crate on crateslot -->
                <do_if value="$CrateSlots.count">
                  <create_crate name="$CipherCrate" macro="macro.crate_gen_s_01_macro" slot="$CrateSlots.random" />
                  <add_cargo object="$CipherCrate" ware="$CipherWare" exact="1"/>
                </do_if>
                <!-- Set drop in case ship gets destroyed before player can collect crate -->
                <set_drop_object object="$CipherShip" drop="'drops_paranidstory_cipher'"/>

                <!-- Stop cipher ship from starting a war -->
                <create_order object="$CipherShip" id="'Wait'" name="$order" immediate="true">
                  <param name="timeout" value="0s"/>
                  <param name="holdfire" value="true"/>
                  <param name="noattackresponse" value="true"/>
                </create_order>

                <signal_objects object="player.galaxy" param="'Cover'" param2="[$CipherShip, $CipherShip.sector.owner, true, true]"/>

                <!-- Make cipher ship invisible on map for player -->
                <set_object_radar_visible object="$CipherShip" visible="false"/>

                <set_object_hull min="100" object="$CipherShip"/>
                <set_object_shield min="60" object="$CipherShip"/>
              </actions>
              <cues>

                <cue name="Reactivate_Generic_Monument_Guard">
                  <delay exact="30s"/>
                  <actions>
                    <reset_cue cue="Paranid_Monument_Generic_Guard_Response" comment="Reactivates the generic monument guard response."/>
                  </actions>
                </cue>

                <cue name="Warzone_Collect">
                  <actions>
                    <create_mission cue="$MissionCue" name="{30220,3001}" description="if player.entity.isfemale then {30220,3015} else {30220,3002}" type="missiontype.plot" faction="faction.player" difficulty="level.medium" abortable="false" icon="'briefing_gride_orrian_01'" iconcaption="$GrideActor.name">
                      <briefing>
                        <objective step="1" action="objective.collect" text="{30220,3003}" comment="Collect: Old Stash of Explosives"/>
                        <objective step="2" action="objective.investigate" text="{20103,1201}" comment="Investigate: Apotheosis"/>
                        <objective step="3" action="objective.collect" text="{30220,3004}" comment="Collect: Holy Order Cipher"/>
                      </briefing>
                    </create_mission>
                    <set_value name="$CurrentStep" exact="2"/>
                  </actions>
                  <cues>

                    <cue name="Warzone_Collect_Intro_Dal_Speak">
                      <cues>
                        <cue name="Ch3_Speak_Dal_351_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$DalBusta"/>
                          <param name="CutsceneKey"       value="$DalCutsceneKey"/>
                          <param name="Lines"             value="[[30220351],[30220352]]"/>
                          <param name="EndSignalCue"      value="Warzone_Collect_Intro_Dal_Speak_Finished"/>
                          <!--
                                Well then.
                                The next item on our list is a simple delivery.
                                                    -->
                        </cue>
                        <cue name="Warzone_Collect_Intro_Dal_Speak_Finished">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <delay exact="1s"/>
                          <actions>
                            <signal_cue cue="Warzone_Collect_Set_Path_Objective_Trigger" comment="Activates automatic objective update on sector change and updates the objective once."/>
                          </actions>
                          <delay exact="1s"/>
                          <actions>
                            <signal_cue cue="Warzone_Collect_Intro_Dal_Speak_2" comment="Dal gives some additional info."/>
                          </actions>
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Warzone_Collect_Set_Path_Objective_Trigger">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <debug_text text="'Guidance to stranded ship is now available.'" chance="$DebugChance"/>
                      </actions>
                      <delay exact="1s"/>
                      <actions>
                        <signal_cue cue="Warzone_Collect_Set_Path_Objective"/>
                      </actions>
                      <cues>
                        <cue name="Warzone_Collect_Set_Path_Objective" instantiate="true">
                          <conditions>
                            <check_any>
                              <check_all>
                                <event_object_changed_sector object="player.entity"/>
                                <check_value value="event.param != $CipherShip.sector"/>
                              </check_all>
                              <event_cue_signalled/>
                            </check_any>
                          </conditions>
                          <delay exact="0.1s"/>
                          <actions>
                            <set_value name="$PathComponents" exact="[]"/>
                            <do_if value="event.name == 'event_cue_signalled'">
                              <debug_text text="'Guidance to stranded ship was triggered manually.'" chance="$DebugChance"/>
                            </do_if>
                            <do_else>
                              <debug_text text="'Guidance to stranded ship was triggered by player sector change.'" chance="$DebugChance"/>
                            </do_else>
                            <do_if value="player.zone.isclass.highway" comment="Player in highway PathComponent workaround">
                              <get_global_path multiple="true" component="$PathComponents" uselocalhighways="false">
                                <start object="player.sector"/>
                                <end object="$CipherShip"/>
                              </get_global_path>
                            </do_if>
                            <do_else>
                              <get_global_path multiple="true" component="$PathComponents" uselocalhighways="false">
                                <start object="player.entity"/>
                                <end object="$CipherShip"/>
                              </get_global_path>
                            </do_else>
                            <do_for_each in="$PathComponents" name="$CurrentComponent">
                              <do_if value="$CurrentComponent.isclass.{class.gate} or $CurrentComponent.isclass.{class.highwayentrygate}">
                                <do_if value="$FirstPathObjectiveSet?">
                                  <!-- Simple guidance update, don't increase $CurrentStep -->
                                  <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.follow" text="{30220,3013}" object="$CurrentComponent" updatebriefing="true" silent="true" comment="Follow: Dead Drop Signal"/>
                                </do_if>
                                <do_else>
                                  <!-- First time this guidance appears, increase $CurrentStep -->
                                  <set_value name="$CurrentStep" exact="1" operation="add"/>
                                  <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.follow" text="{30220,3013}" object="$CurrentComponent" updatebriefing="true" insert="true" comment="Follow: Dead Drop Signal"/>
                                  <set_value name="$FirstPathObjectiveSet"/>
                                </do_else>
                                <do_if value="not $BosoAlreadyWarned? and ($CurrentComponent.destination.parent.owner == $HostileFaction)">
                                  <set_value name="$BosoAlreadyWarned"/>
                                  <signal_cue cue="Warzone_Collect_Hostile_Sector_Close_Boso_Speak_Delay"/>
                                </do_if>
                                <break/>
                              </do_if>
                            </do_for_each>
                          </actions>
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Warzone_Collect_Intro_Dal_Speak_2">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <set_value name="$DalSpeakInProgress"/>
                      </actions>
                      <cues>
                        <cue name="Ch3_Speak_Dal_353_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$DalBusta"/>
                          <param name="CutsceneKey"       value="$DalCutsceneKey"/>
                          <param name="Lines"             value="[[30220353],[if player.entity.isfemale then 30220355 else 30220354],[30220356]]"/>
                          <param name="EndSignalCue"      value="Warzone_Collect_Intro_Dal_Speak_2_Finished"/>
                          <!--
                                I have the ID of the ship we're supposed to find.
                                If you want to, you could land on the ship in your space suit, but it would be easier to dock in an S- or M-sized ship.
                                (spoken to female player 'you'){10111,30220354}
                                Either way, this should be simple enough.
                                                    -->
                        </cue>
                        <cue name="Warzone_Collect_Intro_Dal_Speak_2_Finished">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <actions>
                            <remove_value name="$DalSpeakInProgress"/>
                          </actions>
                        </cue>
                      </cues>
                    </cue>

                    <!-- Short delay to prevent target monitor cutscene from breaking because of sector change -->
                    <cue name="Warzone_Collect_Hostile_Sector_Close_Boso_Speak_Delay">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <delay exact="3s"/>
                      <actions>
                        <signal_cue cue="Warzone_Collect_Hostile_Sector_Close_Boso_Speak"/>
                      </actions>
                    </cue>

                    <cue name="Warzone_Collect_Hostile_Sector_Close_Boso_Speak">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <cues>
                        <cue name="Warzone_Collect_Hostile_Sector_Close_Boso_Speak_Wait_For_Opportunity" checkinterval="1s">
                          <conditions>
                            <check_value value="not $DalSpeakInProgress?"/>
                          </conditions>
                          <cues>
                            <cue name="Ch3_Speak_Boso_307_Ref" ref="md.LIB_Dialog.Speak_Actor">
                              <param name="Actor"             value="$BosoTa"/>
                              <param name="CutsceneKey"       value="$BosoCutsceneKey"/>
                              <param name="Lines"             value="[[30220307], [if player.entity.isfemale then 30220309 else 30220308, 0.6s]]"/>
                              <param name="EndSignalCue"      value="null"/>
                              <!--
                              I fear this might not be quite as simple as you seem to think.
                              Do be careful.
                              (spoken to female player){10201,30220308}
                                                    -->
                            </cue>
                          </cues>
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Warzone_Collect_Check_For_Hostile_Sector_Entry">
                      <conditions>
                        <event_object_changed_sector object="player.entity"/>
                        <!-- Add checks here if we want another version of this mission in case the sector isn't owned by Xenon anymore -->
                        <check_value value="@event.param.owner == $HostileFaction" comment="event.param is null if player is in super highway"/>
                      </conditions>
                      <cues>
                        <cue name="Warzone_Collect_Hostile_Sector_Reached">
                          <delay exact="3s"/>
                          <actions>
                            <debug_text text="'Player reached the first hostile sector. Triggering helpful Dal advice.'" chance="$DebugChance"/>
                            <signal_cue cue="Warzone_Collect_Hostile_Sector_Reached_Dal_Speak_Trigger"/>
                          </actions>
                        </cue>
                        <cue name="Warzone_Collect_Hostile_Sector_Reached_Dal_Speak_Trigger">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <cues>
                            <cue name="Warzone_Collect_Hostile_Sector_Reached_Dal_Speak" checkinterval="1s">
                              <conditions>
                                <check_value value="not $DalSpeakInProgress?"/>
                              </conditions>
                              <actions>
                                <set_value name="$DalSpeakInProgress"/>
                              </actions>
                              <cues>
                                <cue name="Ch3_Speak_Dal_358_Ref" ref="md.LIB_Dialog.Speak_Actor">
                                  <param name="Actor"             value="$DalBusta"/>
                                  <param name="CutsceneKey"       value="$DalCutsceneKey"/>
                                  <param name="Lines"             value="[[if player.entity.isfemale then 30220358 else 30220357]]"/>
                                  <param name="EndSignalCue"      value="Warzone_Collect_Hostile_Sector_Reached_Dal_Speak_Finished"/>
                                  <!--
                                   You know how to do this, just... (slight pause before 'try')try not to get hit.
                                   (spoken to female player 'you'){10111,30220357}
                                                         -->
                                </cue>
                                <cue name="Warzone_Collect_Hostile_Sector_Reached_Dal_Speak_Finished">
                                  <conditions>
                                    <event_cue_signalled/>
                                  </conditions>
                                  <delay exact="2s"/>
                                  <actions>
                                    <!-- Delay exists to keep Dal from screaming THERE right after this speak finishes -->
                                    <remove_value name="$DalSpeakInProgress"/>
                                  </actions>
                                </cue>
                              </cues>
                            </cue>
                          </cues>
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Warzone_Collect_Activate_Cipher_Ship">
                      <conditions>
                        <event_object_changed_sector object="player.entity" sector="$CipherShip.sector"/>
                      </conditions>
                      <actions>
                        <set_object_hull min="0" object="$CipherShip"/>
                        <set_object_shield min="0" object="$CipherShip"/>
                        <!-- Activate Cipher Ship and make it flee towards allied territory -->
                        <signal_objects object="$CipherShip" param="'LoseCover'"/>
                        <set_object_radar_visible object="$CipherShip" visible="true"/>
                        <!--<do_if value="$CipherShip.sector.trueowner != faction.holyorder">-->
                        <find_sector name="$EscapeSector" trueowner="faction.holyorder" multiple="false" sortbygatedistanceto="$CipherShip"/>

                        <do_if value="$EscapeSector?">
                          <cancel_all_orders object="$CipherShip" comment="Cancels wait order."/>
                          <!-- Set a temporary move order that forbids the ship to boost, so that players can land on it more easily. -->
                          <create_order id="'MoveGeneric'" object="$CipherShip" immediate="true">
                            <param name="destination" value="$EscapeSector"/>
                            <param name="position" value="position.[0m,0m,0m]"/>
                            <param name="noboost" value="true"/>
                          </create_order>
                          <signal_cue cue="Cipher_Ship_Escape"/>
                        </do_if>

                        <!--</do_if>-->
                        <do_else>
                          <!-- TODO: What if the universe state has changed and this isn't a Xenon sector anymore? -->
                        </do_else>
                      </actions>
                    </cue>

                    <cue name="Warzone_Collect_Minefield_Approach">
                      <cues>
                        <cue name="Minefield_Approach_Ref" ref="md.LIB_Generic.ApproachObject_Handler">
                          <param name="ApproachTarget"    value="$CipherShip"/>
                          <param name="ApproachDistance"  value="25km"/>
                          <param name="SuccessSignalCue"  value="Warzone_Collect_Minefield_Reached"/>
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Warzone_Collect_Minefield_Reached">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <!-- TODO: Check if this step correctly overrides the original step 2 of the mission briefing, which kept getting pushed until now -->
                        <set_value name="$CurrentStep" exact="1" operation="add"/>
                        <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.collect" text="{30220,3004}" object="if $CipherShip.exists then $CipherCrate else $CipherDrop" updatebriefing="true" comment="Collect: Holy Order Cipher"/>
                        <cancel_cue cue="Warzone_Collect_Set_Path_Objective_Trigger" comment="Stop automatic objective update."/>

                        <play_music music="'music_story_paranid_stranded_ship'" comment="02:22"/>
                      </actions>
                      <cues>

                        <cue name="Minefield_Reached_Music_Handler">
                          <actions>
                          </actions>
                        </cue>

                        <cue name="Warzone_Collect_Minefield_Reached_Dal_Speak" checkinterval="1s">
                          <conditions>
                            <check_value value="not $DalSpeakInProgress?"/>
                          </conditions>
                          <cues>
                            <cue name="Ch3_Speak_Dal_334_2_Ref" ref="md.LIB_Dialog.Speak_Actor">
                              <param name="Actor"             value="$DalBusta"/>
                              <param name="CutsceneKey"       value="$DalCutsceneKey"/>
                              <param name="Lines"             value="[[30220334],[if player.entity.isfemale then 30220372 else 30220371],[30220369, 0.5s]]"/>
                              <param name="EndSignalCue"      value="Warzone_Collect_Cipher_Ship_Lines"/>
                              <!--
                                    There!
                                    Touch down and make a run for it!
                                    How did those maniacs even get here?!
                                                     -->
                            </cue>
                          </cues>
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Warzone_Collect_Cipher_Ship_Lines">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <!-- TODO: Trigger a few voice lines for flavour, but not directed at the player so they don't think that it's their objective to help the ship -->
                        <!-- 10301, 10302, 10303, 10304, 10305, 10306, 10307-->
                        <!--  <t id="5015">(suggestion for dealing with bad situation)Get us out of here!</t> -->
                      </actions>
                    </cue>

                    <cue name="Warzone_Collect_Player_Docked_At_Cipher_Ship_Dal_Speak">
                      <conditions>
                        <event_object_docked_at container="$CipherShip"/>
                        <check_value value="event.param == player.entity.ship"/>
                      </conditions>
                      <delay exact="3s"/>
                      <actions>
                        <set_object_min_hull object="$CipherShip" exact="50" comment="Period of invulnerability, so the player doesn't get blown up with the stranded ship."/>
                        <signal_cue cue="Warzone_Collect_Player_Docked_At_Cipher_Ship_Dal_Speak_Delay"/>
                        <!-- Allow cipher ship to use travel drive and boost. -->
                        <cancel_all_orders object="$CipherShip" comment="Cancels move generic."/>
                        <create_order id="'MoveWait'" object="$CipherShip" immediate="true">
                          <param name="destination" value="[$EscapeSector,position.[0m,0m,0m]]"/>
                          <param name="withdraw" value="true"/>
                        </create_order>
                      </actions>
                      <cues>
                        <cue name="Cipher_Ship_Player_Undocked">
                          <conditions>
                            <event_object_undocked_from container="$CipherShip"/>
                            <check_value value="event.param == player.entity.ship"/>
                          </conditions>
                          <actions>
                            <!-- Make cipher ship vulnerable again. -->
                            <cancel_cue cue="Cipher_Ship_Revoke_Invulnerability"/>
                            <set_object_min_hull object="$CipherShip" exact="0"/>
                            <!-- Short grace period for the player after undocking. -->
                            <set_value name="$CurrentPlayerShip" exact="event.param" comment="We want to set and later remove invulnerability for the same ship. If we didn't set this variable, the player could quickly switch to space suit and leave his main ship invulnerable."/>
                            <set_object_min_hull object="$CurrentPlayerShip" exact="20"/>
                          </actions>
                          <delay exact="5s"/>
                          <actions>
                            <set_object_min_hull object="$CurrentPlayerShip" exact="0"/>
                          </actions>
                        </cue>
                        <cue name="Cipher_Ship_Revoke_Invulnerability">
                          <delay exact="60s"/>
                          <actions>
                            <set_object_min_hull object="$CipherShip" exact="0"/>
                          </actions>
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Warzone_Collect_Player_Docked_At_Cipher_Ship_Dal_Speak_Delay">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <cues>
                        <cue name="Ch3_Speak_Dal_360_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$DalBusta"/>
                          <param name="CutsceneKey"       value="$DalCutsceneKey"/>
                          <param name="Lines"             value="[[if player.entity.isfemale then 30220361 else 30220360]]"/>
                          <param name="EndSignalCue"      value="null"/>
                          <!--
                                And there's the package, waiting for you on the dock, just as Gride said it would be.
                                (spoken to female player 'you'){10111,30220360}
                                                 -->
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Warzone_Collect_Cipher_Ship_Destroyed">
                      <conditions>
                        <event_object_dropped_objects object="$CipherShip"/>
                      </conditions>
                      <actions>
                        <set_value name="$CipherDrop" exact="event.param.{1}"/>
                        <do_if value="player.entity.sector == event.object.sector">
                          <!-- Cipher simply changes position, objective stays the same, don't increase $CurrentStep -->
                          <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.collect" text="{30220,3004}" object="$CipherDrop" updatebriefing="true" comment="Collect: Holy Order Cipher"/>
                        </do_if>
                      </actions>
                      <cues>
                        <cue name="Warzone_Collect_Drop_Collected">
                          <conditions>
                            <event_object_destroyed object="$CipherDrop" comment="Ideally the drop is killed by being collected by the player, but we can't be sure."/>
                          </conditions>
                          <actions>
                            <do_if value="(event.param2 == killmethod.collected) and (event.param.owner == faction.player)">
                              <debug_text text="'Player or one of their ships collected the dropped Cipher. Gride will want to have it.'" chance="$DebugChance"/>
                              <set_value name="$CipherCollectedByPlayerOwned"/>
                            </do_if>
                            <do_else>
                              <debug_text text="'Cipher drop was destroyed or collected by a non-player owned ship. Gride will still pretend that the player gave it to her.'" chance="$DebugChance"/>
                            </do_else>
                            <signal_cue cue="Warzone_Collect_Wrap_Up_Dal_Speak"/>
                          </actions>
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Warzone_Collect_Crate_Collected">
                      <conditions>
                        <event_player_opened_crate/>
                        <check_value value="$CipherCrate? and $CipherCrate.exists and (event.param == $CipherCrate)"/>
                      </conditions>
                      <actions>
                        <debug_text text="'Cipher was collected from crate'" chance="$DebugChance"/>
                        <set_value name="$CipherCollectedByPlayerOwned"/>
                        <do_if value="$CipherShip.exists">
                          <set_drop_object object="$CipherShip" comment="Remove drop."/>
                        </do_if>
                        <signal_cue cue="Warzone_Collect_Wrap_Up_Dal_Speak"/>
                      </actions>
                    </cue>

                    <cue name="Warzone_Collect_Wrap_Up_Dal_Speak">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <cues>
                        <cue name="Ch3_Speak_Dal_359_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$DalBusta"/>
                          <param name="CutsceneKey"       value="$DalCutsceneKey"/>
                          <param name="Lines"             value="[[30220359]]"/>
                          <param name="EndSignalCue"      value="Warzone_Collect_Wrap_Up_Dal_Speak_Finished"/>
                          <!--
                                    Nice!
                                                     -->
                        </cue>
                        <cue name="Warzone_Collect_Wrap_Up_Dal_Speak_Finished">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <actions>
                            <signal_cue cue="Warzone_Deliver"/>
                            <cancel_cue cue="Warzone_Collect" comment="In case someone finds a way to collect the crate while other checks are still running."/>
                          </actions>
                        </cue>
                      </cues>
                    </cue>

                  </cues>
                </cue>

                <cue name="Warzone_Deliver">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <debug_text text="'Starting cipher delivery mission.'" chance="$DebugChance"/>

                    <!-- Improve relations to show trust. Should be locked on game start and stay locked here. -->
                    <set_faction_relation_locked faction="faction.buccaneers" locked="false"/>
                    <set_faction_relation faction="faction.buccaneers" otherfaction="faction.player" value="0.0032"/>
                    <set_faction_relation_locked faction="faction.buccaneers" locked="true"/>
                  </actions>
                  <cues>

                    <cue name="Warzone_Deliver_Prepare_Station_On_Chapter_Start">
                      <actions>
                        <signal_cue cue="Warzone_Deliver_Prepare_Station"/>
                      </actions>
                    </cue>

                    <cue name="Warzone_Deliver_Prepare_Station" instantiate="true">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <debug_text text="'Searching for suitable station to deliver the cipher to.'" chance="$DebugChance"/>
                        <set_value name="$GrideDeliveryStation" exact="null"/>
                        <find_sector name="$IdealGrideDeliverySector" macro="macro.Cluster_24_Sector001_macro" comment="Holy Vision"/>
                        <find_station_by_true_owner name="$GrideDeliveryStation" faction="faction.holyorder" sortbydistanceto="$IdealGrideDeliverySector" space="player.galaxy" tradestation="true">
                          <match_content walkable="true" checkoperational="true"/>
                        </find_station_by_true_owner>
                        <do_if value="not $GrideDeliveryStation">
                          <debug_text text="'No trading station available, searching for any station.'" chance="$DebugChance"/>
                          <!-- If there's no Trading Station available, choose a different station type at random. -->
                          <find_station_by_true_owner name="$GrideDeliveryStation" faction="faction.holyorder" sortbydistanceto="$IdealGrideDeliverySector" space="player.galaxy">
                            <match_content walkable="true" checkoperational="true"/>
                          </find_station_by_true_owner>
                        </do_if>

                        <debug_text text="'Station found: ' + $GrideDeliveryStation" chance="$DebugChance"/>

                        <!-- Determine interior macros and names -->
                        <get_room_definition macro="$GrideDeliveryCorridorMacro" doors="$GrideDeliveryDoors" race="$GrideDeliveryStation.owner.primaryrace" tags="tag.corridor" />
                        <get_room_definition macro="$GrideDeliveryRoomMacro" tags="tag.bar" />
                        <set_value name="$GrideDeliveryInteriorName" exact="readtext.{20007}.{1031}" />

                        <!-- Create persistent interior -->
                        <create_dynamic_interior roomname="$GrideBar" object="$GrideDeliveryStation" name="$GrideDeliveryInteriorName" corridor="$GrideDeliveryCorridorMacro" room="$GrideDeliveryRoomMacro" corridorname="$GrideDeliveryCorridor" interiorname="$GrideDeliveryInterior" persistent="true"/>

                        <!-- Place Gride on delivery station. Make sure that she's been disconnected before. -->
                        <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $GrideActor, table[
                                                                                                                                      $requestercue = $MissionCue,
                                                                                                                                      $priority = 100,
                                                                                                                                      $location = $GrideBar,
                                                                                                                                      $slottags = [tag.stand],
                                                                                                                                      $debugchance = $DeepDebugChance,
                                                                                                                                      $debugcaller = if $DebugChance == 100 then this else null]
                                                                                                                                      ]"/>

                        <do_if value="not $Chapter3DeliveryStepAdded?">
                          <set_value name="$CurrentStep" exact="1" operation="add"/>
                          <set_value name="$Chapter3DeliveryStepAdded" exact="true"/>
                        </do_if>
                      </actions>
                      <!-- Short delay so that Gride exists and we can set the objective -->
                      <delay exact="2s"/>
                      <actions>
                        <!-- Objective stays the same until the player starts talking to Gride -->
                        <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.deliver" text="{30220,3004}" object="$GrideActor" updatebriefing="true" comment="Deliver: Holy Order Cipher"/>
                      </actions>
                      <cues>
                        <cue name="Warzone_Deliver_Prepare_Station_Failsafe">
                          <conditions>
                            <event_object_destroyed object="$GrideDeliveryStation"/>
                          </conditions>
                          <actions>
                            <signal_cue cue="Ch4_Duke"/>
                            <cancel_cue cue="Ch3_Cipher"/>
                          </actions>
                        </cue>
                        <!--<cue name="Warzone_Deliver_Dock_Destroyed" checkinterval="30s" instantiate="true">
                          <conditions>
                            <check_value value="true"/>
                          </conditions>
                          <delay exact="3s"/>
                          <actions>
                            <debug_text text="'Checking whether delivery station still has docks.'" chance="$DebugChance"/>
                            -->
                        <!-- Regularly check whether the station still has docks -->
                        <!--
                            <do_if value="$GrideDeliveryStationDocks?">
                              <remove_value name="$GrideDeliveryStationDocks"/>
                            </do_if>
                            <find_dockingbay groupname="$GrideDeliveryStationDocks" object="$GrideDeliveryStation" multiple="true">
                              <match_content walkable="true" checkoperational="true"/>
                            </find_dockingbay>
                            -->
                        <!--<find_object_component groupname="$GrideDeliveryStationDocks" object="$GrideDeliveryStation" multiple="true">
                              <match_content walkable="true" checkoperational="true"/>
                            </find_object_component>-->
                        <!--
                            <debug_text text="'Docks available: ' + $GrideDeliveryStationDocks" chance="$DebugChance"/>
                            -->
                        <!-- If the station doesn't have docks any more, -->
                        <!--
                            <do_if value="not $GrideDeliveryStationDocks.count">
                              <debug_text text="'No docks left on delivery station.'" chance="$DebugChance"/>
                              -->
                        <!-- Only remove Gride and her bar and choose a new station if the player isn't already in the bar or its corridor. If they are, Gride gets removed after the conversation, see Warzone_Deliver_Wrap_Up -->
                        <!--
                              <do_if value="not player.entity.hascontext.{$GrideDeliveryInterior}">
                                <debug_text text="'Player is not in the delivery interior, removing delivery NPC and interior.'" chance="$DebugChance"/>
                                <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $GrideActor, table[
                                                                                                                                  $requestercue = $MissionCue,
                                                                                                                                  $priority = 100,
                                                                                                                                  $location = 'disconnect',
                                                                                                                                  $slottags = [tag.stand],
                                                                                                                                  $debugchance = $DeepDebugChance,
                                                                                                                                  $debugcaller = if $DebugChance == 100 then this else null]
                                                                                                                                  ]"/>
                                <remove_dynamic_interior interior="$GrideDeliveryInterior" object="$GrideDeliveryStation"/>
                                <signal_cue cue="Warzone_Deliver_Prepare_Station"/>
                                <cancel_cue cue="this"/>
                              </do_if>
                              -->
                        <!-- If the player is already in the bar when the dock gets destroyed, wait with removing the bar until they leave -->
                        <!--
                              <do_else>
                                <debug_text text="'Player is in the delivery interior, waiting for them to leave before removing NPC and interior.'" chance="$DebugChance"/>
                                <signal_cue_instantly cue="Warzone_Deliver_Cleanup_After_Player_Leaves"/>
                                <cancel_cue cue="this"/>
                              </do_else>
                            </do_if>
                          </actions>
                        </cue>-->
                      </cues>
                    </cue>

                    <!-- This gets signalled if the delivery station's dock is destroyed, and if the player finishes the mission -->
                    <cue name="Warzone_Deliver_Cleanup_After_Player_Leaves" instantiate="true">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <!-- Save station and interior info, in case this cue was signalled because the station dock was destroyed, so it can remember what it needs to remove -->
                        <set_value name="$PreviousGrideDeliveryInterior" exact="$GrideDeliveryInterior"/>
                        <set_value name="$PreviousGrideDeliveryStation" exact="$GrideDeliveryStation"/>
                      </actions>
                      <cues>
                        <cue name="Warzone_Deliver_Cleanup_After_Player_Leaves_Event">
                          <conditions>
                            <check_any>
                              <event_object_changed_room object="player.entity"/>
                              <event_object_changed_sector object="player.entity"/>
                            </check_any>
                            <check_value value="not player.entity.hascontext.{$PreviousGrideDeliveryInterior}"/>
                          </conditions>
                          <actions>
                            <!-- We don't have to disconnect Gride here, because that already happens once the player has finished their conversation with her. -->
                            <remove_dynamic_interior interior="$PreviousGrideDeliveryInterior" object="$PreviousGrideDeliveryStation"/>
                            <!-- Choose a new delivery station in the very specific case that the dock was destroyed while the player was already in the bar, but then they teleported away instead of talking to Gride. -->
                            <do_if value="not $WarzoneDeliverConversationHad?">
                              <signal_cue cue="Warzone_Deliver_Prepare_Station"/>
                            </do_if>
                          </actions>
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Warzone_Deliver_Approach">
                      <cues>

                        <cue name="Warzone_Deliver_Approach_Intro_Dal_Speak">
                          <cues>
                            <cue name="Ch3_Speak_Dal_362_Ref" ref="md.LIB_Dialog.Speak_Actor">
                              <param name="Actor"             value="$DalBusta"/>
                              <param name="CutsceneKey"       value="$DalCutsceneKey"/>
                              <param name="Lines"             value="[[30220362],[30220363, 0.6s]]"/>
                              <param name="EndSignalCue"      value="null"/>
                              <!--
                                    Now, we'd better get on and deliver it.
                                    Let's hope the reward Gride promised was worth all the trouble.
                                                     -->
                            </cue>
                          </cues>
                        </cue>

                        <!--<cue name="Warzone_Deliver_Approach_Docked_Dal_Speak">
                          <conditions>
                            <check_any>
                              <check_all>
                                <event_object_docked_at container="$GrideDeliveryStation"/>
                                <check_value value="event.param == player.entity.ship"/>
                              </check_all>
                              <check_all>
                                <event_player_teleport_successful/>
                                <check_value value="event.param.parent == $GrideDeliveryStation"/>
                              </check_all>
                            </check_any>
                          </conditions>
                          <cues>
                            <cue name="Ch3_Speak_Dal_364_Ref" ref="md.LIB_Dialog.Speak_Actor">
                              <param name="Actor"             value="$DalBusta"/>
                              <param name="CutsceneKey"       value="$DalCutsceneKey"/>
                              <param name="Lines"             value="[[30220364]]"/>
                              <param name="EndSignalCue"      value="null"/>
                              -->
                        <!--
                                    You need to go and meet the mystery client now.
                                                     -->
                        <!--
                            </cue>
                          </cues>
                        </cue>-->

                      </cues>
                    </cue>

                    <cue name="Warzone_Deliver_Conversation">
                      <conditions>
                        <event_conversation_started actor="$GrideActor"/>
                      </conditions>
                      <actions>
                        <!-- Remember that the player has had the conversation. This is important in case the station's dock gets destroyed while the player is already in the bar, but then decides to teleport away instead of talking to Gride. -->
                        <set_value name="$WarzoneDeliverConversationHad" exact="true"/>

                        <allow_conversation_escape enabled="false"/>

                        <add_npc_line speaker="$GrideActor" line="if player.entity.isfemale then 30220302 else 30220301" hidechoices="true" comment="I see you're still alive." delay="0.7s"/>
                        <add_npc_line speaker="$GrideActor" line="30220303" hidechoices="true" comment="What a pleasant surprise."/>

                        <add_player_choice text="{30220,3101}" section="section_main" choiceparam="'delivery'" position="right" comment="Here's the item you asked for."/>
                      </actions>
                      <cues>

                        <cue name="Warzone_Deliver_Conversation_Section_Main" instantiate="true">
                          <conditions>
                            <event_conversation_next_section actor="$GrideActor" section="section_main"/>
                          </conditions>
                          <actions>
                            <allow_conversation_escape enabled="false"/>

                            <do_if value="event.param2 == 'delivery'">
                              <debug_text text="'Player handed over cipher, giving introductory voice lines'" chance="$DebugChance"/>
                              <do_if value="player.entity.inventory.{$CipherWare}.count" comment="If the item was destroyed for some reason, the mission still progresses.">
                                <add_inventory entity="player.entity" ware="$CipherWare" exact="-1"/>
                              </do_if>
                              <set_value name="$CurrentStep" exact="1" operation="add"/>
                              <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.collect" text="{30220,2004}" updatebriefing="true" comment="Collect: Informantion on the Paranid"/>
                              <add_npc_line speaker="$GrideActor" line="if player.entity.isfemale then 30220305 else 30220304" hidechoices="true" comment="So, that concludes your side of the bargain." delay="0.7s"/>
                              <add_npc_line speaker="$GrideActor" line="if player.entity.isfemale then 30220307 else 30220306" hidechoices="true" comment="If I remember rightly, that means I owe you a few more answers."/>
                            </do_if>

                            <do_elseif value="event.param2 == 'question1'">
                              <debug_text text="'Giving answer 1, personal'" chance="$DebugChance"/>
                              <add_npc_line speaker="$GrideActor" line="if player.entity.isfemale then 30220239 else 30220238" hidechoices="true" comment="Oh, how nice of you to ask." delay="0.7s"/>
                              <add_npc_line speaker="$GrideActor" line="30220240"                                              hidechoices="true" comment="I was a pilot myself, you know, back in the days before the gate shutdown."/>
                              <add_npc_line speaker="$GrideActor" line="30220241"                                              hidechoices="true" comment="I served one of the greatest minds who ever lived."/>
                              <add_npc_line speaker="$GrideActor" line="30220242"                                              hidechoices="true" comment="What I wouldn't do to bring them back."/>
                              <set_value name="$Gride_Paranid_Question_1_Asked" exact="true"/>
                            </do_elseif>

                            <do_elseif value="event.param2 == 'question2'">
                              <debug_text text="'Giving answer 2, ambush'" chance="$DebugChance"/>
                              <add_npc_line speaker="$GrideActor" line="if player.entity.isfemale then 30220244 else 30220243" hidechoices="true" comment="Ah yes, sorry about that dear." delay="0.7s"/>
                              <add_npc_line speaker="$GrideActor" line="30220245"                                              hidechoices="true" comment="In my line of work, you can never be too careful about who you... (slight pause before 'associate')associate with."/>
                              <add_npc_line speaker="$GrideActor" line="if player.entity.isfemale then 30220247 else 30220246" hidechoices="true" comment="If you ever find yourself facing the kind of impossible odds I'm up against, you might look back fondly at our little encounter."/>
                              <set_value name="$Gride_Paranid_Question_2_Asked" exact="true"/>
                            </do_elseif>

                            <do_elseif value="event.param2 == 'question3'">
                              <debug_text text="'Giving answer 3, war'" chance="$DebugChance"/>
                              <add_npc_line speaker="$GrideActor" line="30220221" delay="0.7s"                                 hidechoices="true" comment="To an outsider, it might seem as though this war has just been going back and forth, with no prospect of a resolution."/>
                              <add_npc_line speaker="$GrideActor" line="30220222"                                              hidechoices="true" comment="That's not an entirely inaccurate assessment, but it's not the whole picture."/>
                              <add_npc_line speaker="$GrideActor" line="30220223"                                              hidechoices="true" comment="It's no accident that military supplies for this conflict have become one of the safest investments at this end of the gate network."/>
                              <add_npc_line speaker="$GrideActor" line="if player.entity.isfemale then 30220225 else 30220224" hidechoices="true" comment="You see, the two factions aren't (emphasize 'really')really fighting over territory or resources."/>
                              <add_npc_line speaker="$GrideActor" line="30220226"                                              hidechoices="true" comment="In the minds of their leaders, elimination of their opponents would actually be a tragic outcome."/>
                              <add_npc_line speaker="$GrideActor" line="30220227"                                              hidechoices="true" comment="That's because they're fighting for the hearts and minds of their people."/>
                              <add_npc_line speaker="$GrideActor" line="30220228"                                              hidechoices="true" comment="If one Pontifex backed down, even just a little, he'd be sacrificing his legitimacy."/>
                              <add_npc_line speaker="$GrideActor" line="30220229"                                              hidechoices="true" comment="I imagine they must be quite desperate for an outside solution by now."/>
                              <set_value name="$Gride_Paranid_Question_3_Asked" exact="true"/>
                            </do_elseif>

                            <do_elseif value="event.param2 == 'question4'">
                              <debug_text text="'Giving answer 4, paranid'" chance="$DebugChance"/>
                              <do_if value="player.entity.race == race.paranid">
                                <add_npc_line speaker="$GrideActor" line="30220230" delay="0.7s"                               hidechoices="true" comment="(if Paranid)That's a rather curious question, coming from you."/>
                                <add_npc_line speaker="$GrideActor" line="30220231"                                            hidechoices="true" comment="(if Paranid)You must have spent far too long away from your kin."/>
                              </do_if>
                              <add_npc_line speaker="$GrideActor" line="30220232" delay="0.7s"                                 hidechoices="true" comment="Someone looking at it from the outside could easily come to the conclusion that civil war was a natural state for Paranid society."/>
                              <add_npc_line speaker="$GrideActor" line="30220233"                                              hidechoices="true" comment="It seems almost like some sort of expression of their psyche; always questioning and challenging one another's beliefs."/>
                              <add_npc_line speaker="$GrideActor" line="30220234"                                              hidechoices="true" comment="Nothing could be further from the truth, however."/>
                              <add_npc_line speaker="$GrideActor" line="30220235"                                              hidechoices="true" comment="What they so desperately want to resolve is what to them is an almost tangible geometric impossibility, namely there being two Pontifices."/>
                              <add_npc_line speaker="$GrideActor" line="30220236"                                              hidechoices="true" comment="The current situation is utter sacrilege, tearing at their stoic demeanour and rending their perception of their own culture."/>
                              <add_npc_line speaker="$GrideActor" line="30220237"                                              hidechoices="true" comment="It's an aberration in history that needs to be erased at all cost."/>
                              <set_value name="$Gride_Paranid_Question_4_Asked" exact="true"/>
                            </do_elseif>

                            <add_player_choice text="{30220,2101}" section="section_main"     position="top_left"     choiceparam="'question1'" selectable="not $Gride_Paranid_Question_1_Asked?" comment="What's your story?"/>
                            <add_player_choice text="{30220,2102}" section="section_main"     position="left"         choiceparam="'question2'" selectable="not $Gride_Paranid_Question_2_Asked?" comment="Why the ambush?"/>
                            <add_player_choice text="{30220,2103}" section="section_main"     position="top_right"    choiceparam="'question3'" selectable="not $Gride_Paranid_Question_3_Asked?" comment="What will this war achieve?"/>
                            <add_player_choice text="{30220,2104}" section="section_main"     position="right"        choiceparam="'question4'" selectable="not $Gride_Paranid_Question_4_Asked?" comment="What drives the Paranid?"/>
                            <add_player_choice text="{30220,3102}" section="section_outro"    position="bottom_left"  choiceparam="'question5'" highlighted="true" comment="Why this job?"/>
                            <add_player_choice text="{30220,3103}" section="section_outro"    position="bottom_right" choiceparam="'skip'"      highlighted="true" comment="That's all I need to know."/>
                          </actions>
                        </cue>

                        <cue name="Warzone_Deliver_Conversation_Section_Outro">
                          <conditions>
                            <event_conversation_next_section actor="$GrideActor" section="section_outro"/>
                          </conditions>
                          <actions>
                            <debug_text text="'Gride delivery conversation outro.'"/>

                            <allow_conversation_escape enabled="false"/>

                            <do_if value="event.param2 == 'question5'">
                              <debug_text text="'Giving extra information because the player asked about the job.'" chance="$DebugChance"/>
                              <set_value name="$Gride_Paranid_Question_5_Asked" exact="true"/>
                              <add_npc_line speaker="$GrideActor" line="if player.entity.isfemale then 30220309 else 30220308" hidechoices="true" comment="An excellent question, my dear." delay="0.7s"/>
                              <add_npc_line speaker="$GrideActor" line="if player.entity.isfemale then 30220311 else 30220310" hidechoices="true" comment="The item you brought me has some... (slight pause before 'sentimental')sentimental value."/>
                              <add_npc_line speaker="$GrideActor" line="30220312"                                              hidechoices="true" comment="There is someone I'm yearning to see for one last time."/>
                            </do_if>

                            <add_npc_line speaker="$GrideActor" line="if player.entity.isfemale then 30220314 else 30220313" hidechoices="true" comment="You've proven yourself to be pretty dependable, so let me add another piece of the map to your little scavenger hunt."/>

                            <do_if value="event.param2 == 'question5'">
                              <add_npc_line speaker="$GrideActor" line="if player.entity.isfemale then 30220316 else 30220315" hidechoices="true" comment="I you do indeed find what you seek out there, at the end of the galaxy, then I might just let you meet that person too."/>
                            </do_if>
                          </actions>
                        </cue>

                        <cue name="Warzone_Deliver_Conversation_End">
                          <conditions>
                            <event_conversation_finished actor="$GrideActor"/>
                          </conditions>
                          <actions>
                            <debug_text text="'Gride delivery conversation ending. Signalling Chapter 3 wrap-up cues.'" chance="$DebugChance"/>
                            <signal_cue cue="Warzone_Deliver_Wrap_Up"/>
                          </actions>
                        </cue>

                      </cues>
                    </cue>

                    <cue name="Warzone_Deliver_Wrap_Up">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <delay exact="5s"/>
                      <actions>
                        <signal_cue cue="Warzone_Deliver_Wrap_Up_Dal_Speak"/>
                      </actions>
                      <delay exact="7s"/>
                      <actions>
                        <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $GrideActor, table[
                                                                                                                                  $requestercue = $MissionCue,
                                                                                                                                  $priority = 100,
                                                                                                                                  $location = 'disconnect',
                                                                                                                                  $slottags = [tag.stand],
                                                                                                                                  $debugchance = $DeepDebugChance,
                                                                                                                                  $debugcaller = if $DebugChance == 100 then this else null]
                                                                                                                                  ]"/>
                        <!-- Wait with destroying the room until the player has left -->
                        <signal_cue cue="Warzone_Deliver_Cleanup_After_Player_Leaves"/>
                      </actions>
                    </cue>

                    <cue name="Warzone_Deliver_Wrap_Up_Dal_Speak">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <cues>
                        <cue name="Ch3_Speak_Dal_365_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$DalBusta"/>
                          <param name="CutsceneKey"       value="$DalCutsceneKey"/>
                          <param name="Lines"             value="[[30220365],[30220366, 0.6s],[if player.entity.isfemale then 30220368 else 30220367, 0.6s]]"/>
                          <param name="EndSignalCue"      value="Warzone_Deliver_Handover"/>
                          <!--
                                Huh, about that errand...
                                ...did we actually need the EMP(pronounced E.M.P.) for anything but our little snooping operation?
                                Anyway, I'll add Gride's data to your navigation system.
                                (spoken to female player 'your'){10111,30220367}
                                                 -->
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Warzone_Deliver_Handover">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <remove_mission cue="$MissionCue" type="completed"/>
                        <write_to_logbook category="missions" faction="faction.player" title="{30220,3001}" text="if player.entity.isfemale then {30220,3018} else {30220,3017}"/>
                        <signal_cue cue="Ch4_Duke"/>
                      </actions>
                    </cue>

                  </cues>
                </cue>

              </cues>
            </cue>
          </cues>
        </cue>

        <cue name="Cipher_Ship_Escape">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <cues>
            <cue name="Cipher_Ship_Escape_Failure">
              <conditions>
                <event_object_destroyed object="$CipherShip"/>
              </conditions>
              <actions>
                <debug_text text="'Cipher ship got destroyed while fleeing.'" chance="$DebugChance"/>
                <cancel_cue cue="Cipher_Ship_Escape"/>
              </actions>
            </cue>
            <cue name="Cipher_Ship_Escape_Success">
              <conditions>
                <event_object_changed_sector object="$CipherShip"/>
              </conditions>
              <actions>
                <do_if value="event.param.owner == faction.holyorder">
                  <debug_text text="'Cipher ship reached a friendly sector.'" chance="$DebugChance"/>
                  <set_value name="$CipherShipEscaped" exact="true"/>
                  <cancel_all_orders object="$CipherShip"/>
                  <create_order id="'MoveDie'" object="$CipherShip" immediate="true"/>
                </do_if>
              </actions>
            </cue>
          </cues>
        </cue>

        <!-- Chapter 4: Meet the Duke -->

        <cue name="Ch4_Force">
          <force name="Plot_Paranid_Ch4">
            <signal_cue_instantly cue="Force_Chapter" param="Ch4_Duke"/>
          </force>
        </cue>

        <cue name="Ch4_Duke">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <debug_text text="'Starting part ' + this" chance="$DebugChance"/>
            <set_value name="$CurrentPartCue" exact="this"/>
            <set_value name="$ObjectiveStep" exact="1"/>
            <set_value name="$ObjectiveRadius" exact="100km"/>
            <set_value name="$ObjectiveObject" exact="$DerelictStation"/>
            <create_group groupname="$DerelictBeaconGroup"/>
            <create_group groupname="$DerelictAllBeaconGroup"/>
            <set_value name="$DerelictBeaconDefenseTable" exact="table[]"/>
            <set_value name="$BeaconTimer" exact="0"/>
            <set_value name="$BeaconNear" exact="null"/>
            <create_group groupname="$DerelictBeaconMines"/>
          </actions>
          <cues>

            <cue name="Ch4_DukeShip_Setup">
              <actions>
                <create_ship name="$KroShip" macro="ship_par_s_scout_01_b_macro" capturable="false" commandeerable="false" mission="true" sector="$DerelictSector">
                  <pilot actor="$Duke"/>
                  <owner exact="faction.civilian" comment="not buccaneers!"/>
                  <loadout>
                    <level exact="1.0"/>
                  </loadout>
                  <paint ware="ware.paintmod_0112"/>
                  <position x="-262368.813" y="-10178.953" z="210738.094"/>
                  <rotation yaw="-42.7266deg" pitch="-21.15169deg" roll="2.79834deg"/>
                </create_ship>
                <set_object_min_hull object="$KroShip" min="80"/>
                <set_object_radar_visible object="$KroShip" visible="false"/>
                <set_relation_boost object="$KroShip" value="0.01" faction="faction.player" silent="true" decay="0"/>
                <set_object_relation_behaviour object="$KroShip" disable="true"/>
                <set_object_name object="$KroShip" page="30220" line="143" comment="Indomitable Spirit"/>
                <create_order id="'Wait'" object="$KroShip" default="true" comment="stay put"/>
              </actions>
              <cues>
                <cue name="Ch4_DukeShip_Find_DEBUG">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <set_objective cue="$MissionCue" action="objective.investigate" text="{30220,4010}" object="$KroShip" comment="Set guidance to easily find Kro"/>
                  </actions>
                </cue>
              </cues>
            </cue>

            <cue name="Ch4_NavBeacons_Setup">
              <actions>
                <set_value name="$BeaconSetup"   exact="[
                   [ macro.env_deco_nav_beacon_t1_mission_macro, faction.buccaneers, $DerelictSector, position.[   770m,  8406m,    30m], rotation.[0deg, 0deg, 0deg]],
                   [ macro.env_deco_nav_beacon_t2_mission_macro, faction.buccaneers, $DerelictSector, position.[-11930m,  1930m, 19600m], rotation.[0deg, 0deg, 0deg]],
                   [ macro.env_deco_nav_beacon_t3_mission_macro, faction.buccaneers, $DerelictSector, position.[ -2110m,  1240m, -1070m], rotation.[0deg, 0deg, 0deg]],
                   [ macro.env_deco_nav_beacon_t4_mission_macro, faction.buccaneers, $DerelictSector, position.[  4860m,  5170m, -7250m], rotation.[0deg, 0deg, 0deg]],
                   [ macro.env_deco_nav_beacon_t5_mission_macro, faction.buccaneers, $DerelictSector, position.[  -960m, -11580m,   25m], rotation.[0deg, 0deg, 0deg]],
                   ]" />
                <do_all exact="$BeaconSetup.count" counter="$i">
                  <create_object name="$DerelictBeacon" macro="$BeaconSetup.{$i}.{1}" owner="$BeaconSetup.{$i}.{2}" sector="$BeaconSetup.{$i}.{3}">
                    <position object="$DerelictStation" value="$BeaconSetup.{$i}.{4}"/>
                  </create_object>
                  <!-- reserve a table (with a group of mines and lasers) for each beacon. Additionally contains a bool to see if 'player nearby' was triggered-->
                  <set_value name="$DerelictBeaconDefenseTable.{$DerelictBeacon}" exact="table[$lasers = [], $mines = [], $wasnearby = false, $wasnearby2 = false]"/>

                  <set_object_radar_visible object="$DerelictBeacon" visible="false"/>
                  <add_to_group groupname="$DerelictBeaconGroup" object="$DerelictBeacon"/>
                  <add_to_group groupname="$DerelictAllBeaconGroup" object="$DerelictBeacon"/>
                  <set_object_min_hull object="$DerelictBeacon" exact="100" comment="indestructible (destroy them after talking to the duke)"/>

                  <!-- lasertowers -->
                  <do_all exact="[2,3,4].random">
                    <create_ship name="$LasersBeacon" macro="[macro.ship_gen_s_lasertower_01_a_macro, macro.ship_gen_xs_lasertower_01_a_macro].random" zone="$DerelictBeacon.zone">
                      <pilot>
                        <select race="race.drone"/>
                      </pilot>
                      <owner exact="faction.buccaneers"/>
                      <safepos object="$DerelictBeacon" min="100m" max="500m"/>
                    </create_ship>
                    <add_to_group groupname="$DerelictBeaconDefenseTable.{$DerelictBeacon}.$lasers" object="$LasersBeacon"/>
                    <add_to_group groupname="$BeaconLasertowerMines" object="$LasersBeacon"/>
                    <set_object_radar_visible object="$LasersBeacon" visible="false"/>
                  </do_all>
                  <!-- mines -->
                  <do_all exact="[2,4,6].random">
                    <create_object name="$MinesBeacon" macro="[macro.weapon_gen_mine_01_a_macro].random" owner="faction.buccaneers" zone="$DerelictBeacon.zone">
                      <safepos object="$DerelictBeacon" min="250m" max="750m"/>
                    </create_object>
                    <add_to_group groupname="$DerelictBeaconDefenseTable.{$DerelictBeacon}.$mines" object="$MinesBeacon"/>
                    <add_to_group groupname="$DerelictBeaconMines" object="$MinesBeacon"/>
                    <set_object_radar_visible object="$MinesBeacon" visible="false"/>
                  </do_all>
                </do_all>
              </actions>
              <cues>
                <cue name="Ch4_NavBeacons_Find_DEBUG" instantiate="true">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <set_objective cue="$MissionCue" action="objective.investigate" text="'NavBeacon-group'" group="$DerelictBeaconGroup"/>
                  </actions>
                </cue>
                <cue name="Ch4_Mines_Find_DEBUG" instantiate="true">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <set_objective cue="$MissionCue" action="objective.investigate" text="'Mines-group'" group="$DerelictBeaconMines"/>
                  </actions>
                </cue>
              </cues>
            </cue>

            <cue name="Ch4_Duke_Create_Mission">
              <actions>
                <create_mission cue="$MissionCue" name="{30220,4001}" description="if player.entity.isfemale then {30220,4014} else {30220,4002}" rewardtext="{30220,4015}" type="missiontype.plot" faction="faction.player" difficulty="level.medium" abortable="false" icon="'briefing_gride_orrian_01'" iconcaption="$GrideActor.name">
                  <briefing>
                    <objective step="$ObjectiveStep" action="objective.investigate" text="{30220,4010}" object="$DerelictStation" radius="$ObjectiveRadius"/>
                  </briefing>
                </create_mission>

                <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.investigate" text="{30220,4010}" object="$ObjectiveObject" radius="$ObjectiveRadius"/>
                <signal_cue cue="Ch4_Duke_Find"/>
              </actions>
            </cue>

            <cue name="Ch4_Duke_Find">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <delay exact="1s"/>
              <actions>
                <signal_cue cue="Ch4_Story_Reminder"/>
              </actions>
              <cues>

                <cue name="Ch4_Story_Reminder">
                  <conditions>
                    <check_all>
                      <event_cue_signalled/>
                      <check_value value="Ch4_Duke_PlayerReachedSector_Dialog.state == cuestate.waiting" comment="We have to check this, because the player might already be in the target sector."/>
                    </check_all>
                  </conditions>
                  <cues>
                    <cue name="Ch4_Story_Reminder_Ref" ref="Story_Reminder">
                      <param name="Actor"       value="$DalBusta"/>
                      <param name="CutsceneKey" value="$DalCutsceneKey"/>
                      <param name="Lines"       value="[[if player.entity.isfemale then 30200002 else 30200001],[if player.entity.isfemale then 30200108 else 30200107]]"/>
                      <param name="CancelCue"   value="Ch4_Duke_PlayerReachedSector_Dialog"/>
                      <param name="Delay"       value="35min"/>
                      <!--  <t id="30200001">Hey there partner.</t>
                            <t id="30200002">(spoken to female player){10111,30200001}</t>
                            <t id="30200107">Where have you wandered off to?</t>
                            <t id="30200108">(spoken to female player 'you'){,30200107}</t>  -->
                    </cue>
                  </cues>
                </cue>

                <cue name="Ch4_Duke_PlayerReachedSector_Ref" ref="md.LIB_Generic.ReachedSector">
                  <param name="TargetSector"      value="$DerelictSector"/>
                  <param name="SuccessSignalCue"  value="Ch4_Duke_PlayerReachedSector_Dialog"/>
                </cue>

                <cue name="Ch4_Duke_PlayerReachedSector_Dialog">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <play_music music="'music_story_paranid_lasting_vengeance'" comment="224s"/>
                  </actions>
                  <cues>
                    <cue name="PlayerReachedSector_Music_Handler">
                      <actions>
                      </actions>
                    </cue>

                    <cue name="Ch4_Duke_DalComments_Dialog_Ref" ref="md.LIB_Dialog.Speak_Actors">
                      <param name="Actor"             value="[$DalBusta, $BosoTa, $DalBusta]"/>
                      <param name="CutsceneKey"       value="[$DalCutsceneKey, $BosoCutsceneKey, $DalCutsceneKey]"/>
                      <param name="Lines"             value="[[[30220401], [30220402]],
                                                              [[30220401], [30220402], [30220403], [30220404]],
                                                              [[30220403]]]"/>
                      <!--           
                       <t id="30220401">Lasting Vengeance, huh?</t>
                       <t id="30220402">This really is the end of the galaxy.</t>
                       <t id="30220401">A galaxy does not have an end, you know.</t>
                       <t id="30220402">But by stretching the definition somewhat, I suppose you might find an "end" of sorts, either at the very core or somewhere along the outer rim.</t>
                       <t id="30220403">None of those criteria apply in this case, however.</t>
                       <t id="30220404">I do believe that the impressively long-lived Argon female employed an idiom.</t>
                       <t id="30220403">I'm so glad to be working with someone so knowledgeable.</t>
                      -->
                    </cue>
                  </cues>
                </cue>

                <cue name="Ch4_Duke_PlayerReachedLocation_Far1_Ref" ref="md.LIB_Generic.ApproachObject_Handler">
                  <param name="ApproachObject"    value="player.entity"/>
                  <param name="ApproachTarget"    value="$DerelictStation"/>
                  <param name="ApproachDistance"  value="100km"/>
                  <param name="SuccessSignalCue"  value="Ch4_Duke_PlayerReachedLocation_Far1_Dialog"/>
                </cue>

                <cue name="Ch4_Duke_PlayerReachedLocation_Far1_Dialog">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <cues>
                    <cue name="Ch4_Duke_PlayerReachedLocation_Far1_Dialog_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$BosoTa"/>
                      <param name="CutsceneKey"       value="$BosoCutsceneKey"/>
                      <param name="Lines"             value="[
                             [30220405, 1s], [if player.entity.isfemale then 30220407 else 30220406], [if player.entity.isfemale then 30220409 else 30220408]
                             ]"/>
                      <!--              
                         <t id="30220405">Whatever we're supposed to find would appear be hidden inside that rather ominous-looking haze.</t>
                         <t id="30220406">I advise you to be cautious.</t>
                         <t id="30220407">(spoken to female player 'you'){10201,30220406}</t>
                         <t id="30220408">There are field discharges in this area that will quickly deplete your shields.</t>
                         <t id="30220409">(spoken to female player 'your'){10201,30220408}</t>
                      -->
                    </cue>
                  </cues>
                </cue>

                <cue name="Ch4_Duke_PlayerReachedLocation_Far2m_Ref" ref="md.LIB_Generic.ApproachObject_Handler">
                  <param name="ApproachObject"    value="player.entity"/>
                  <param name="ApproachTarget"    value="$DerelictStation"/>
                  <param name="ApproachDistance"  value="60km"/>
                  <param name="SuccessSignalCue"  value="Ch4_Duke_PlayerReachedLocation_Far2_Dialog"/>
                </cue>

                <cue name="Ch4_Duke_PlayerReachedLocation_Far2_Dialog">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <cues>
                    <cue name="Ch4_Duke_PlayerReachedLocation_Far2_Dialog_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$DalBusta"/>
                      <param name="CutsceneKey"       value="$DalCutsceneKey"/>
                      <param name="Lines"             value="[
                             [30220407, 1s], [30220408], [30220433], [30220410]
                             ]"/>
                      <param name="EndSignalCue"      value="Ch4_Duke_Further_Instructions"/>
                      <!--              
                       <t id="30220407">That looks like some kind of military station, hopefully an abandoned one.</t>
                       <t id="30220408">And judging by all that weaponry, it is, or was, a fairly major installation.</t>
                       <t id="30220433">Let's hope those laser towers stay firmly shut down.</t>
                       <t id="30220410">It's dangerous enough out here, with all those mines floating around.</t>
                      -->
                    </cue>
                    <cue name="Ch4_Duke_UpdateObjective" comment="initial update on approach">
                      <actions>
                        <signal_cue cue="Ch4_Duke_UpdateBeaconObjective"/>
                      </actions>
                    </cue>
                  </cues>
                </cue>

                <cue name="Ch4_Duke_Further_Instructions">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <cues>
                    <cue name="Ch4_Duke_Further_Instructions_Approach_Ref" ref="md.LIB_Generic.ApproachObject_Handler">
                      <param name="ApproachObject"    value="player.entity"/>
                      <param name="ApproachTarget"    value="$DerelictStation"/>
                      <param name="ApproachDistance"  value="30km"/>
                      <param name="SuccessSignalCue"  value="Ch4_Duke_Further_Instructions_Boso_Dialog"/>
                    </cue>
                    <cue name="Ch4_Duke_Further_Instructions_Boso_Dialog">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <cues>
                        <cue name="Ch4_Duke_Further_Instructions_Boso_Dialog_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$BosoTa"/>
                          <param name="CutsceneKey"       value="$BosoCutsceneKey"/>
                          <param name="Lines"             value="[[if player.entity.isfemale then 30220411 else 30220410],[30220412],[30220413]]"/>
                          <param name="EndSignalCue"      value="null"/>
                          <!--
                            I am detecting a small number of scattered navigational devices in your general vicinity.
                            Scanning them might lead us to valuable information, hidden treasure, ancient artifacts!
                            I can barely contain my excitement!
                          -->
                        </cue>
                      </cues>
                    </cue>
                  </cues>
                </cue>

                <cue name="Ch4_Duke_UpdateBeaconObjective" instantiate="true">
                  <conditions>
                    <event_cue_signalled/>
                    <check_value value="not $DukeFound?" comment="don't overwrite objective, if we already found the duke"/>
                  </conditions>
                  <actions>
                    <do_if value="$ObjectiveObject == $KroShip" comment="all beacons investigated">
                      <set_objective cue="$MissionCue" action="objective.flyto" text="{30220,4010}" object="$ObjectiveObject"/>
                      <signal_cue cue="Ch4_Duke_AllBeaconsFound_Dialog"/>
                    </do_if>
                    <do_else comment="more beacons remaining">
                      <set_objective cue="$MissionCue" action="objective.investigate" text="{30220,4010}" object="$ObjectiveObject" radius="$ObjectiveRadius" silent="true">
                        <progress progress="$BeaconSetup.count - $DerelictBeaconGroup.count" max="$BeaconSetup.count"/>
                      </set_objective>
                    </do_else>
                  </actions>
                </cue>

                <cue name="Ch4_Duke_AllBeaconsFound_Dialog">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <cues>
                    <cue name="Ch4_Duke_AllBeaconsFound_Dialog_Ref" ref="md.LIB_Dialog.Speak_Actors">
                      <param name="Actor"             value="[$BosoTa, $DalBusta]"/>
                      <param name="CutsceneKey"       value="[$BosoCutsceneKey, $DalCutsceneKey]"/>
                      <param name="Lines"             value="[[[if player.entity.isfemale then 30220815 else 30220814], [if player.entity.isfemale then 30220422 else 30220421]],
                                                                          [[30220434, 1s], [if player.entity.isfemale then 30200016 else 30200015]]]"/>
                      <!--           
                                    <t id="30220814">Great work, assistant!</t>
                                    Please investigate the indicated location.
                                    
                                    Why would anyone hide something valuable out here, and then leave such an obvious trail of breadcrumbs?
                                    Be on your guard.
                                  -->
                    </cue>
                  </cues>
                </cue>

                <cue name="Ch4_Duke_PlayerNearDefenses2" checkinterval="5s" instantiate="true">
                  <actions>
                    <!-- loop over all beacons and check if we are within x km range -->
                    <do_all exact="$DerelictBeaconGroup.count" counter="$bi">

                      <set_value name="this.$BeaconNear" exact="$DerelictBeaconGroup.{$bi}"/>
                      <do_if value="(this.$BeaconNear != null) and (not $DerelictBeaconDefenseTable.{this.$BeaconNear}.$wasnearby2) and (player.entity.distanceto.{this.$BeaconNear} lt 7km)">
                        <!-- make the entire beacongroup (beacon+lasertowers+mines) radar-visible, so they are targetable -->
                        <set_object_radar_visible object="this.$BeaconNear" visible="true"/>
                        <set_value name="this.$lasers" exact="$DerelictBeaconDefenseTable.{this.$BeaconNear}.$lasers"/>
                        <do_all exact="this.$lasers.count" counter="$i">
                          <set_object_radar_visible object="this.$lasers.{$i}" visible="true"/>
                        </do_all>
                        <set_value name="this.$mines" exact="$DerelictBeaconDefenseTable.{this.$BeaconNear}.$mines"/>
                        <do_all exact="this.$mines.count" counter="$i">
                          <set_object_radar_visible object="this.$mines.{$i}" visible="true"/>
                        </do_all>
                        <set_value name="$DerelictBeaconDefenseTable.{this.$BeaconNear}.$wasnearby2" exact="true" comment="optimization: only once per beacongroup"/>
                      </do_if>
                    </do_all>
                  </actions>
                </cue>

                <cue name="Ch4_Duke_PlayerNearDefenses" checkinterval="2s" instantiate="true">
                  <actions>
                    <!-- any beacons nearby? -->
                    <set_value name="this.$BeaconNear" exact="null"/>
                    <do_all exact="$DerelictBeaconGroup.count" counter="$bi">
                      <do_if value="player.entity.distanceto.{$DerelictBeaconGroup.{$bi}} lt 1km">
                        <set_value name="this.$BeaconNear" exact="$DerelictBeaconGroup.{$bi}"/>
                        <break/>
                      </do_if>
                    </do_all>

                    <!-- beacon nearby: one-time chance to get a relation-drop (lasertower becomes enemy) -->
                    <do_if value="(this.$BeaconNear != null) and (not $DerelictBeaconDefenseTable.{this.$BeaconNear}.$wasnearby)">
                      <set_value name="$DerelictBeaconDefenseTable.{this.$BeaconNear}.$wasnearby" exact="true"/>
                      <set_value name="this.$lasers" exact="$DerelictBeaconDefenseTable.{this.$BeaconNear}.$lasers"/>
                      <do_all exact="this.$lasers.count" counter="$i">

                        <do_if value="true" chance="50">
                          <set_relation_boost object="this.$lasers.{$i}" value="-1" faction="faction.player" silent="true" decay="0"/>
                          <!--set_relation_boost object="this.$lasers.{$i}" value="-1" faction="faction.player" silent="true" decay="0" chance="50" comment="50% chance for lasertowers to activate"/-->
                          <do_if value="not $TurretActivated?">
                            <set_value name="$TurretActivated" exact="true"/>
                            <signal_cue cue="Ch4_Duke_PlayerNearDefenses_Dal_Dialog"/>
                          </do_if>
                        </do_if>
                      </do_all>
                    </do_if>
                  </actions>
                </cue>

                <cue name="Ch4_Duke_PlayerNearDefenses_Dal_Dialog">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <cues>
                    <cue name="Ch4_Duke_PlayerNearBeacon_Defenses_Dal_Dialog_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$DalBusta"/>
                      <param name="CutsceneKey"       value="$DalCutsceneKey"/>
                      <param name="Lines"             value="[[30220411]]"/>
                      <!--
                       <t id="30220411">Shimatta! One of the turrets has reactivated!</t>
                      -->
                    </cue>
                  </cues>
                </cue>

                <cue name="Ch4_Duke_PlayerNearBeacon" checkinterval="0.5s" instantiate="true">
                  <actions>
                    <set_value name="this.$BeaconNearOld" exact="$BeaconNear"/>
                    <set_value name="$BeaconNear" exact="null"/>
                    <do_all exact="$DerelictBeaconGroup.count" counter="$bi">
                      <do_if value="player.entity.distanceto.{$DerelictBeaconGroup.{$bi}} lt 750m">
                        <set_value name="$BeaconNear" exact="$DerelictBeaconGroup.{$bi}"/>
                        <break/>
                      </do_if>
                    </do_all>

                    <do_if value="(this.$BeaconNearOld == null) and ($BeaconNear != null)" comment="new beacon in rage">
                      <set_value name="$BeaconTimer" exact="player.age"/>
                    </do_if>
                    <do_elseif value="(this.$BeaconNearOld == $BeaconNear) and ($BeaconNear != null)" comment="beacon remains in range">
                      <!--debug_text text="'Update' + (player.age - $BeaconTimer) + ' progress=' + (player.age - $BeaconTimer)i"/-->
                      <set_objective cue="$MissionCue" action="objective.wait" text="{30220,4012}" object="$ObjectiveObject" radius="$ObjectiveRadius" silent="true">
                        <progress progress="(player.age - $BeaconTimer)i" max="(10s)i"/>
                      </set_objective>
                      <do_if value="(player.age - $BeaconTimer) gt 10s">

                        <do_if value="not $BeaconScanned?">
                          <set_value name="$BeaconScanned" exact="true"/>
                          <signal_cue cue="Ch4_Duke_PlayerNearBeacon_Boso_Dialog"/>
                        </do_if>

                        <remove_from_group group="$DerelictBeaconGroup" object="$BeaconNear"/>
                        <set_object_min_hull object="$BeaconNear" exact="0" comment="destructible"/>

                        <signal_cue cue="Ch4_Duke_UpdateBeaconObjective"/>
                        <set_value name="$NearBeacon" exact="null"/>
                        <do_if value="$DerelictBeaconGroup.count == 0" comment="point to exact location">
                          <set_value name="$ObjectiveRadius" exact="0"/>
                          <set_value name="$ObjectiveObject" exact="$KroShip"/>
                        </do_if>
                        <do_else>
                          <set_value name="$ObjectiveRadius" exact="$ObjectiveRadius / $BeaconSetup.count" operation="subtract" comment="home in a bit (not really accurate, since we are pointing at the station instead of Kro)"/>
                        </do_else>
                      </do_if>
                    </do_elseif>
                    <do_elseif value="(this.$BeaconNearOld != null) and ($BeaconNear == null)" comment="beacon left range (or was scanned)">
                      <set_value name="$BeaconTimer" exact="0"/>
                      <signal_cue cue="Ch4_Duke_UpdateBeaconObjective"/>
                    </do_elseif>
                  </actions>
                </cue>

                <cue name="Ch4_Duke_PlayerNearBeacon_Boso_Dialog">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <cues>
                    <cue name="Ch4_Duke_PlayerNearBeacon_Boso_Dialog_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$BosoTa"/>
                      <param name="CutsceneKey"       value="$BosoCutsceneKey"/>
                      <param name="Lines"             value="[[30220414],[if player.entity.isfemale then 30220416 else 30220415],[if player.entity.isfemale then 30220418 else 30220417],[if player.entity.isfemale then 30220420 else 30220419]]"/>
                      <param name="EndSignalCue"      value="null"/>
                      <!--
                            My analysis suggests that these beacons were placed to indicate a safe route for someone in possession of the correct credentials.
                            Do not worry about your deficiencies in advanced cryptography, assistant.
                            I shall be your master password.
                            If you can find more of them, I might be able to more accurately triangulate the intended guidance direction.
                          -->
                    </cue>
                  </cues>
                </cue>

                <cue name="Ch4_Duke_PlayerNearBeacon_Dal_Dialog" comment="Currently not signalled. Boso's remarks are used instead.">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <cues>
                    <cue name="Ch4_Duke_PlayerNearBeacon_Dal_Dialog_Ref" ref="md.LIB_Dialog.Speak_Actor" comment="talking to player">
                      <param name="Actor"             value="$DalBusta"/>
                      <param name="CutsceneKey"       value="$DalCutsceneKey"/>
                      <param name="Lines"             value="[[30220404], [if player.entity.isfemale then 30220406 else 30220405]]"/>
                      <!--
                       <t id="30220404">Interesting. Someone seems to have already come this way.</t>
                       <t id="30220405">If you can find some more of these nav beacons, they might point you in the right direction.</t>
                      -->
                    </cue>
                  </cues>
                </cue>

                <cue name="Ch4_Duke_PlayerReachedKro_Ref" ref="md.LIB_Generic.ApproachObject_Handler">
                  <param name="ApproachObject"    value="player.entity"/>
                  <param name="ApproachTarget"    value="$KroShip"/>
                  <param name="ApproachDistance"  value="5km"/>
                  <param name="SuccessSignalCue"  value="Ch4_Duke_PlayerReachedKro"/>
                </cue>

                <cue name="Ch4_Duke_PlayerReachedKro">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <set_object_radar_visible object="$KroShip" visible="true"/>
                  </actions>
                  <cues>
                    <cue name="Ch4_Duke_PlayerReachedKro_Dialog_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$DalBusta"/>
                      <param name="CutsceneKey"       value="$DalCutsceneKey"/>
                      <param name="Lines"             value="[
                             [30220412, 1s], [30220413], [30220414]
                             ]"/>
                      <param name="EndSignalCue"     value="Ch4_Duke_Found"/>
                      <!--              
                       <t id="30220412">There's a Paranid ship!</t>
                       <t id="30220413">It's hailing us.</t>
                       <t id="30220414">Let's go see what this is all about.</t>
                      -->
                    </cue>
                  </cues>
                </cue>
              </cues>
            </cue>

            <cue name="Ch4_Duke_Found">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <set_value name="$DukeFound" exact="true"/>
                <set_value name="$ObjectiveStep" operation="add"/>
                <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.talkto" object="$KroShip" text="{30220,4011}" updatebriefing="true" comment="Mysterious stranger"/>
                <set_entity_traits entity="$Duke" missionactor="true" customhandler="true"/>
              </actions>
            </cue>

            <cue name="Ch4_Duke_Conversation">
              <conditions>
                <event_conversation_started actor="$Duke"/>
                <check_value value="Ch4_Duke_Conversation_DalKro.state == cuestate.waiting" comment="To fix the conversation repeating itself for players who are already past this point."/>
              </conditions>
              <actions>
                <!--do_if value="not $DukeIntroductionName?"-->
                <allow_conversation_escape enabled="false"/>
                <do_if value="true">
                  <set_value name="$DukeIntroductionName" exact="true"/>
                  <add_npc_line speaker="$Duke" line="30220401" hidechoices="true" comment="Has the time come, then?"/>
                  <add_npc_line speaker="$Duke" line="30220402" hidechoices="true" comment="Has the last remaining pretender finally acknowledged my presence?"/>
                  <add_npc_line speaker="$Duke" line="if player.entity.isfemale then 30220404 else 30220403" hidechoices="true" comment="No. It cannot be the Holy Order who sent you."/>
                  <add_npc_line speaker="$Duke" line="30220405" hidechoices="true" comment="Decades have passed and barely a soul has strayed into this wasteland."/>
                  <add_player_choice position="right" highlighted="true" text="{30220,4050}" section="g_duke_mainstory" choiceparam="'longintro'" comment="Who are you?"/>
                </do_if>
                <do_else>
                  <!-- TODO: Some default handling -->
                </do_else>

                <!--signal_cue cue="Ch5_Campaign" comment="next chapter"/-->
              </actions>
            </cue>

            <cue name="Ch4_Duke_Conversation_LongIntro" instantiate="true">
              <conditions>
                <event_conversation_next_section actor="$Duke" section="g_duke_mainstory" />
              </conditions>
              <actions>
                <allow_conversation_escape enabled="false"/>
                <do_if value="event.param2 == 'longintro'">
                  <!-- ConversationManager::ShouldUseMonitor, maybe create a clone of dal, to avoid him from appearing on the eventmonitor -->
                  <add_npc_line speaker="$Duke" line="if player.entity.isfemale then 30220407 else 30220406" hidechoices="true" comment="So the musings of the Holy Three-Dimensionality have guided your steps toward this most remote of places?"/>
                  <add_npc_line speaker="$Duke" line="30220408" hidechoices="true" comment="Very well then."/>
                  <add_npc_line speaker="$Duke" line="30220409" hidechoices="true" comment="I go by the name Kromancketslat."/>
                  <add_npc_line speaker="$Duke" line="30220410" hidechoices="true" comment="I have witnessed the holy gates close and open again..."/>
                  <add_npc_line speaker="$Duke" line="30220411" hidechoices="true" comment="...and I have reaped a bountiful harvest from the void in between."/>
                  <add_npc_line speaker="$Duke" line="30220412" hidechoices="true" comment="But somewhere along that path, the purpose that once drove my kin was torn asunder."/>
                  <add_npc_line speaker="$DalBusta" line="30220415" delay="1s" hidechoices="true" comment="Did Gride seriously send us all this way to find this philosophising waste of carbon?"/>
                  <add_npc_line speaker="$Duke" line="30220413" delay="1s" hidechoices="true" comment="When the Pontifex' thralls arrived to claim new territory..."/>
                  <add_npc_line speaker="$Duke" line="30220414" hidechoices="true" comment="...only a shadow remained of the once daring, free people that called this place their home."/>
                  <add_npc_line speaker="$DalBusta" line="if player.entity.isfemale then 30220417 else 30220416" hidechoices="true" comment="Ohhh, hang on a minute."/>
                  <add_npc_line speaker="$DalBusta" line="30220418" delay="1s" hidechoices="true" comment="I think I just worked this out."/>
                  <add_npc_line speaker="$DalBusta" line="if player.entity.isfemale then 30220420 else 30220419" hidechoices="true" comment="Ask him his opinion about the war."/>
                  <add_npc_line speaker="$DalBusta" line="30220421" hidechoices="true" comment="Just trust me on this one."/>
                  <add_npc_line speaker="$Duke" line="if player.entity.isfemale then 30220415 else 30220415" hidechoices="true" comment="Witness this sea of ruin, this irredeemable haven of hubris."/>
                  <add_npc_line speaker="$Duke" line="30220417" hidechoices="true" comment="May it be a lesson to those who put ambition before unity."/>
                </do_if>
                <do_elseif value="event.param2 == 'ask_war'">
                  <set_value name="$DukeIntroductionWar" exact="true"/>
                  <add_npc_line speaker="$Duke" line="30220422" hidechoices="true" comment="This civil war is a travesty; a mark of shame for all Paranid."/>
                  <add_npc_line speaker="$Duke" line="30220423" hidechoices="true" comment="Invoked by desire, sparked by obtuse geometry, and fuelled by blind dogma and zealotry."/>
                  <add_npc_line speaker="$Duke" line="30220424" hidechoices="true" comment="The Pontifices, both pretenders in their own way, may attempt to reach out and guide us into their light."/>
                  <add_npc_line speaker="$Duke" line="30220425" hidechoices="true" comment="But this conflict has defined us for too long and the promise of personal gain weighs too heavy for some."/>
                  <add_npc_line speaker="$Duke" line="30220426" hidechoices="true" comment="No physical wall has been planted between my brethren..."/>
                  <add_npc_line speaker="$Duke" line="30220427" hidechoices="true" comment="...and yet, despite our three eyes, we have lost sight of each other... (slight pause before 'and thus')and thus of ourselves."/>
                </do_elseif>
                <do_elseif value="event.param2 == 'ask_realignment'">
                  <set_value name="$DukeIntroductionRealignment" exact="true"/>
                  <add_npc_line speaker="$Duke" line="30220418" hidechoices="true" comment="The realignment, as glorious as it might seem in the grand scheme of history, planted the seed of the conflict we witness today."/>
                  <add_npc_line speaker="$Duke" line="30220419" hidechoices="true" comment="Their desire to be whole again had already driven the many isolated parishes to appoint grand leaders from among their own congregations."/>
                  <add_npc_line speaker="$Duke" line="30220420" hidechoices="true" comment="When the Holy Three-Dimensionality finally reached out and tied together the lost gates ..."/>
                  <add_npc_line speaker="$Duke" line="30220421" hidechoices="true" comment="...every Pontifex, whatever their character, saw their claim challenged by a horde of pretenders."/>
                </do_elseif>
                <add_player_choice position="top_right" highlighted="true" text="{30220,4051}" section="g_duke_mainstory" choiceparam="'ask_war'" selectable="not $DukeIntroductionWar?" comment="Ask about war"/>
                <add_player_choice position="top_left" text="{30220,4052}" section="g_duke_mainstory" choiceparam="'ask_realignment'" selectable="not $DukeIntroductionRealignment?" comment="Ask about Realignment"/>
                <add_player_choice position="bottom_right" highlighted="true" text="{30220,4053}" section="g_end" comment="Fascinating" selectable="$DukeIntroductionWar?"/>
              </actions>
            </cue>

            <cue name="Ch4_Duke_Conversation_SubtitleName">
              <conditions>
                <event_speak_finished actor="$Duke" line="30220409"/>
              </conditions>
              <actions>
                <set_entity_traits entity="$Duke" subtitlename="true" comment="enable subtitlename (at the point Kro introduced himself)"/>
              </actions>
            </cue>

            <cue name="Ch4_Duke_Conversation_DalPlayer">
              <conditions>
                <event_conversation_finished actor="$Duke"/>
                <check_value value="Ch4_Duke_Conversation_DalKro.state == cuestate.waiting" comment="To fix the lines repeating themselves for players who are already past this point, the first time they finish a conversation with Kromancketslat."/>
              </conditions>
              <cues>
                <cue name="Duke_Conversation_DalIdea_Dialog_Ref" ref="md.LIB_Dialog.Speak_Actor" comment="talking to player">
                  <param name="Actor"             value="$DalBusta"/>
                  <param name="CutsceneKey"       value="$DalCutsceneKey"/>
                  <param name="Lines"             value="[[30220423], [if player.entity.isfemale then 30220425 else 30220424, 0.6s],[if player.entity.isfemale then 30220427 else 30220426]]"/>
                  <param name="EndSignalCue"      value="Ch4_Duke_Conversation_DalKro"/>
                  <!--
                   <t id="30220423">(whispering to player)Bingo!</t>
                   <t id="30220424">I think I'm starting to understand why Gride sent you here.</t>
                   <t id="30220425">(spoken to female player 'you'){10111,30220424}</t>
                   <t id="30220426">Let me talk to him in private for a moment.</t>
                   <t id="30220427">(spoken to female player){10111,30220426}</t>
                  -->
                </cue>
              </cues>
            </cue>

            <cue name="Ch4_Duke_Conversation_DalKro">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <set_objective cue="$MissionCue" action="objective.await" text="{30220,4013}" updatebriefing="false" comment="End of Discussion"/>
              </actions>
              <delay exact="10s" comment="Dal is speaking to Kro in private"/>
              <actions>
                <signal_cue cue="Ch4_Duke_Conversation_DalKro_Delayed"/>
              </actions>
              <cues>
                <cue name="Ch4_Duke_Conversation_DalKro_Delayed">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <cues>
                    <cue name="Duke_Conversation_DalKro_Dialog_Ref" ref="md.LIB_Dialog.Speak_Actors">
                      <param name="Actor"             value="[$DalBusta, $Duke, $DalBusta]"/>
                      <param name="CutsceneKey"       value="[$DalCutsceneKey, $ShowPilotCutsceneKey, $DalCutsceneKey]"/>
                      <param name="Lines"             value="[[[if player.entity.isfemale then 30220429 else 30220428],[30220430]],
                                                              [[if player.entity.race == race.paranid then 30220430 else if player.entity.isfemale then 30220429 else 30220428, 1s], [30220431], [if player.entity.isfemale then 30220433 else 30220432], [if player.entity.isfemale then 30220435 else 30220434]],
                                                              [[if player.entity.isfemale then 30220432 else 30220431]]
                                                             ]"/>
                      <param name="EndSignalCue"      value="[null, null, Ch4_Duke_Conversation_Escort]"/>
                      <!--
                        <t id="30220428">Thanks for waiting, my friend!</t>
                        <t id="30220429">(spoken to female player){10111,30220428}</t>
                        <t id="30220430">I just got us a backstage pass to the peace negotiations.</t>
                    
                        <t id="30220428">Outsider!</t>
                        <t id="30220429">(spoken to female player){10351,30220428}</t>
                        <t id="30220430">(if Paranid)Brother!</t>
                        <t id="30220431">I have decided to conclude my contemplative isolation.</t>
                        <t id="30220432">You are among the chosen few who will help pave the way for my grand return...</t>
                        <t id="30220433">(spoken to female player 'you'){10351,30220432}</t>
                        <t id="30220434">...or for the ultimate defeat of my cause.</t>
                        <t id="30220435">(spoken to female player){10351,30220434}</t>
                      
                        <t id="30220431">I think he just wants you to keep an eye out for potential hazards while he works.</t>
                        <t id="30220432">(spoken to female player 'you'){10111,30220431}</t>
                      -->
                    </cue>
                  </cues>
                </cue>
              </cues>
            </cue>

            <cue name="Ch4_Duke_Conversation_Escort">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <remove_mission cue="$MissionCue" type="completed"/>
                <write_to_logbook category="missions" faction="faction.player" title="{30220,4001}" text="if player.entity.isfemale then {30220,4017} else {30220,4016}"/>
                <signal_cue cue="Ch5_Campaign"/>
              </actions>
            </cue>

          </cues>
        </cue>

        <!-- Chapter 5: Duke's campaign in HOP territory -->

        <cue name="Ch5_Force">
          <force name="Plot_Paranid_Ch5">

            <set_entity_traits entity="$Duke" subtitlename="true" comment="enable subtitlename (we were introduced)"/>
            <!-- ship originally spawned in previous chapter (see Ch4_DukeShip_Setup), but if we force we need to create it ourselves -->
            <do_if value="not $KroShip? or not $KroShip.exists">
              <create_ship name="$KroShip" macro="ship_par_s_scout_01_b_macro" capturable="false" commandeerable="false" mission="true" sector="$DerelictSector">
                <pilot actor="$Duke"/>
                <owner exact="faction.civilian" overridenpc="true"/>
                <loadout>
                  <level exact="0.8"/>
                </loadout>
                <safepos object="$DerelictStation"/>
              </create_ship>
              <set_object_min_hull object="$KroShip" min="80"/>
              <set_known object="$KroShip" known="true"/>
            </do_if>
            <do_else>
              <debug_text text="'Kroship already exists'" chance="$DebugChance"/>
            </do_else>

            <signal_cue_instantly cue="Force_Chapter" param="Ch5_Campaign"/>
          </force>
        </cue>

        <cue name="Ch5_Campaign">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <debug_text text="'Starting part ' + this" chance="$DebugChance"/>
            <set_value name="$CurrentPartCue" exact="this"/>
            <set_value name="$ObjectiveStep" exact="1"/>

            <play_music music="'music_story_paranid_entourage'" comment="120s"/>

            <create_mission cue="$MissionCue" name="{30220,5001}" description="if player.entity.isfemale then {30220,5007} else {30220,5002}" rewardtext="{30220,5008}" type="missiontype.plot" faction="faction.player" difficulty="level.medium" abortable="false" icon="'briefing_kromancketslat_01'" iconcaption="$Duke.name">
              <briefing>
                <objective step="$ObjectiveStep" action="objective.custom" customaction="{30220,5003}" text="{30220,102}" comment="Accompany: Kromancketslat"/>
              </briefing>
            </create_mission>

            <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.custom" customaction="{30220,5003}" object="$KroShip" text="{30220,102}"/>

            <find_station name="$DefenseStation" space="$CardinalSector" defencestation="true" required="true"/>
            <create_position name="$DefenseStationPosition" object="$DefenseStation" space="$DefenseStation.sector"/>

            <!-- Kromancketslat becomes an Ambassador -->
            <set_entity_overrides entity="$Duke" title="'{30220,112}'"/>
          </actions>
          <cues>
            <cue name="Ch5_Campaign_Music_Handler">
              <actions>
              </actions>
            </cue>

            <cue name="Ch5_Kro_Orders">
              <actions>
                <!--<create_cue_actor name="$KroReliefPilot" cue="$MissionCue">
                  <select race="race.paranid" tags="tag.elitepilot"/>
                  <owner exact="faction.civilian"/>
                </create_cue_actor>
                <debug_text text="'Created actor as relief pilot: ' + $KroReliefPilot" chance="$DebugChance"/>
                <dismiss_control_entity object="$KroShip" actor="$Duke" comment="Kromancketslat stops being the pilot"/>
              </actions>
              <delay exact="1s"/>
              <actions>-->
                <!-- Kro moves to stand behind the pilot seat, just like players often do -->
                <!--<create_position name="$KroPosition" x="0.0" y="-0.5" z="-0.6"/>
                <create_rotation name="$KroRotation" yaw="-0.780898deg" />
                <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $Duke, table[
                                                                                                                                      $requestercue = $MissionCue,
                                                                                                                                      $priority = 100,
                                                                                                                                      $location = $KroShip.controlroom,
                                                                                                                                      $rotation = $KroRotation,
                                                                                                                                      $position = $KroPosition,
                                                                                                                                      $debugchance = $DeepDebugChance,
                                                                                                                                      $debugcaller = if $DebugChance == 100 then this else null]
                                                                                                                                      ]"/>

              </actions>
              <delay exact="5s"/>
              <actions>
                <assign_control_entity object="$KroShip" post="controlpost.aipilot" actor="$KroReliefPilot" transfer="true" comment="Relief pilot takes his place"/>-->
                <!-- Ship moves to the defense station -->
                <create_order object="$KroShip" id="'MoveWait'" name="$order" immediate="true">
                  <param name="destination" value="[$DefenseStation.sector, $DefenseStationPosition]"/>
                  <param name="precise" value="true"/>
                </create_order>
              </actions>
            </cue>

            <cue name="Ch5_Kro_SectorChange">
              <conditions>
                <event_object_changed_sector object="$KroShip"/>
                <check_value value="(event.param == $CardinalSector) and (event.param2 == $DerelictSector)"/>
              </conditions>
              <cues>

                <cue name="Ch5_Player_InSector" checkinterval="2s">
                  <conditions>
                    <check_value value="player.entity.sector == $CardinalSector"/>
                  </conditions>
                  <delay exact="7s"/>
                  <actions>
                    <signal_cue cue="Ch5_SectorChange_Dialog"/>
                  </actions>
                </cue>

                <!-- dialog in background, while flying -->
                <cue name="Ch5_SectorChange_Dialog">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <cues>

                    <cue name="Ch5_SectorChange_Dal_Speak">
                      <actions>
                        <speak actor="$DalBusta" comment="Talking to Kro, so intentionally NOT on eventmonitor" priority="100">
                          <text line="30220501" comment="Honourable Kromancketslat."/>
                          <text line="30220502" comment="Please allow this humble outsider to attempt to gain some insight into the nature of your glorious people."/>
                          <text line="30220503" delay="1s" comment="How do you choose your future leaders?"/>
                        </speak>
                        <!-- To be used later in the mission, for balancing enemy amount -->
                        <set_value name="$MainPlayerShip" exact="player.ship"/>
                      </actions>
                    </cue>

                    <cue name="Ch5_SectorChange_Kro_Speak">
                      <conditions>
                        <event_speak_finished actor="$DalBusta" line="30220501"/>
                      </conditions>
                      <delay exact="1s"/>
                      <actions>
                        <speak actor="$Duke" comment="Reply to Dal - so intentionally NOT on eventmonitor" priority="100">
                          <text line="30220501" comment="There is no need for such formalities." delay="1s"/>
                          <text line="30220502" comment="I am painfully aware of the ignorance of unholy creatures like you."/>
                          <text line="30220503" delay="1s" comment="A Paranid is not simply chosen, he is created; destined to serve the Realm to the best of his abilities."/>
                          <text line="30220504" comment="The high priests, created in the most intricate rituals of holy procreation, are indeed a marvel to behold."/>
                          <text line="30220505" delay="0.5s" comment="But as many priest-scholars have done before, so did I dare to pose this question, half a century ago:"/>
                          <text line="30220506" comment="What if there has been a mistake?"/>
                          <text line="30220507" comment="What is the fate of those, whose potential surmounts their assigned purpose?"/>
                          <text line="30220508" comment="I have found my answer."/>
                          <text line="30220509" comment="And I pray that none of my brethren will have to walk this path."/>
                        </speak>
                      </actions>
                    </cue>

                    <cue name="Ch5_SectorChange_Dal_ReplySpeak">
                      <conditions>
                        <event_speak_finished actor="$Duke" line="30220501"/>
                      </conditions>
                      <actions>
                        <speak actor="$DalBusta" line="30220526" comment="Thank you for your insights, enlightened one." delay="2s" priority="100">
                        </speak>
                      </actions>
                    </cue>

                    <cue name="Ch5_SectorChange_Dal_Cutscene">
                      <conditions>
                        <event_speak_finished actor="$DalBusta" line="30220526"/>
                      </conditions>
                      <delay exact="3s" comment="Dal take a second to ponder Kro's words"/>
                      <cues>
                        <cue name="Ch5_SectorChange_Dal_Cutscene_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$DalBusta"/>
                          <param name="Room"              value="$DalBusta.room"/>
                          <param name="CutsceneKey"       value="$DalCutsceneKey"/>
                          <param name="Lines"             value="[[30220504], [30220505], [30220506], [30220507]]"/>
                          <param name="EndSignalCue"      value="null"/>
                          <!--
                            <text line="30220504" comment="(quietly)Destiny, huh?" delay="1s"/>
                            <text line="30220505" comment="(thoughtfully)I wonder who decides which side those fresh Paranid are on."/>
                            <text line="30220506" comment="(thoughtfully)What might happen if someone suddenly had the support of a bunch of fresh, highly skilled, highly intelligent super-priests?"/>
                            <text line="30220507" comment="(thoughtfully)Wouldn't that create an imbalance great enough to, let's say... (slight pause before 'win')win a war?"/>
                          -->
                        </cue>
                      </cues>
                    </cue>


                  </cues>
                </cue>
              </cues>
            </cue>

            <cue name="Ch5_DebugArrival">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <!-- warp Kro and player to 'near defense station', so below arrival cues trigger -->
                <warp object="$KroShip" sector="$DefenseStation.sector">
                  <safepos value="$DefenseStationPosition"/>
                </warp>

                <do_if value="player.ship">
                  <create_position name="$DefenseStationPosition" object="$DefenseStation" space="$DefenseStation.sector"/>
                  <warp object="player.ship" sector="$DefenseStation.sector">
                    <safepos value="$DefenseStationPosition"/>
                  </warp>
                </do_if>
              </actions>
            </cue>

            <cue name="Ch5_Kro_Approach">
              <cues>
                <cue name="Ch5_Kro_Approach_Ref" ref="md.LIB_Generic.ApproachObject_Handler">
                  <param name="ApproachObject"    value="$KroShip"/>
                  <param name="ApproachTarget"    value="$DefenseStation"/>
                  <param name="ApproachDistance"  value="10km"/>
                  <param name="SuccessSignalCue"  value="Ch5_Kro_Arrived"/>
                </cue>

                <cue name="Ch5_Kro_Arrived">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <debug_text text="'Kro arrived'" chance="$DebugChance"/>
                  </actions>
                  <delay exact="1s"/>
                  <actions>
                    <signal_cue cue="Ch5_Story_Reminder"/>
                  </actions>
                  <cues>
                    <cue name="Ch5_Player_Approach_Ref" ref="md.LIB_Generic.ApproachObject_Handler">
                      <param name="ApproachObject"    value="player.entity"/>
                      <param name="ApproachTarget"    value="$KroShip"/>
                      <param name="ApproachDistance"  value="5km"/>
                      <param name="SuccessSignalCue"  value="Ch5_Player_Arrived"/>
                    </cue>

                    <cue name="Ch5_Story_Reminder">
                      <conditions>
                        <check_all>
                          <event_cue_signalled/>
                          <check_value value="Ch5_Player_Arrived.state == cuestate.waiting" comment="We have to check this, because the player might already be close to Kromancketslat."/>
                        </check_all>
                      </conditions>
                      <cues>
                        <cue name="Ch5_Story_Reminder_Ref" ref="Story_Reminder">
                          <param name="Actor"       value="$DalBusta"/>
                          <param name="CutsceneKey" value="$DalCutsceneKey"/>
                          <param name="Lines"       value="[[if player.entity.isfemale then 30200002 else 30200001],[if player.entity.isfemale then 30220530 else 30220529]]"/>
                          <param name="CancelCue"   value="Ch5_Player_Arrived"/>
                          <!--  <t id="30200001">Hey there partner.</t>
                                <t id="30200002">(spoken to female player){10111,30200001}</t>
                                <t id="30220529">I think our Paranid friend still expects you to accompany him during his negotiations.</t>
                                <t id="30220530">(spoken to female player 'you'){,30220529}</t>  -->
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Ch5_Player_Arrived">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <debug_text text="'Player near to Kro (both near defensestation)'" chance="$DebugChance"/>
                        <signal_cue cue="Ch5_Arrival"/>
                      </actions>
                    </cue>
                  </cues>
                </cue>
              </cues>
            </cue>

            <cue name="Ch5_Arrival">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <cues>

                <cue name="Ch5_Arrival_Kro_Cutscene">
                  <actions>
                  </actions>
                  <cues>
                    <cue name="Ch5_Arrival_Kro_Cutscene_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$Duke"/>
                      <param name="CutsceneKey"       value="$DukeCutsceneKey"/>
                      <param name="Lines"             value="[ [30220510], [30220511], [30220513, 2s], [30220514, 1s] ]"/>
                      <param name="EndSignalCue"      value="Ch5_Arrival_Dock"/>
                      <!--
                        <text line="30220510" comment="We approach the site of our first confrontation."/>
                        <text line="30220511" comment="The time has come to once again wear that dreaded face."/>
                        Commented out for now. <text line="30220512" comment="(steeling himself)*** sigh ***"/>
                        <text line="30220513" comment="(solemnly)May the negotiations commence."/>
                        <text line="30220514" comment="I will require my entourage to ensure that I remain undisturbed."/>
                      -->
                    </cue>
                  </cues>
                </cue>

                <cue name="Ch5_Arrival_Dock">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <!-- Kro moves to dock -->
                    <cancel_all_orders object="$KroShip"/>
                    <create_order id="'DockAndWait'" object="$KroShip">
                      <param name="destination" value="$DefenseStation" comment="stay docked"/>
                    </create_order>
                  </actions>
                  <delay exact="3s"/>
                  <actions>
                    <signal_cue cue="Ch5_Arrival_Dal_Cutscene"/>
                  </actions>
                  <cues>
                    <cue name="Ch5_Arrival_Dal_Cutscene">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <cues>
                        <cue name="Ch5_Arrival_Dal_Cutscene_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$DalBusta"/>
                          <param name="CutsceneKey"       value="$DalCutsceneKey"/>
                          <param name="Lines"             value="[[30220508]]"/>
                          <param name="EndSignalCue"      value="Ch5_Arrival_Objective"/>
                          <!--
                            <text line="30220508" comment="There he goes."/>
                          -->
                        </cue>
                        <cue name="Ch5_Arrival_Objective">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <actions>
                            <!-- set objective.wait early, if we wait till the duke is docked then autoguidance tell the player to also dock -->
                            <set_objective cue="$MissionCue" action="objective.await" text="{30220,5004}" comment="Negotiations"/>
                          </actions>
                        </cue>
                      </cues>
                    </cue>
                  </cues>
                </cue>
              </cues>
            </cue>

            <cue name="Ch5_Negotiations">
              <conditions>
                <event_object_docked object="$KroShip"/>
              </conditions>
              <actions>
                <debug_text text="'Negotiations'" chance="$DebugChance"/>
              </actions>
              <cues>

                <cue name="Ch5_Distraction">
                  <actions>
                    <!-- create ship for distraction, docked on station -->
                    <find_object_component name="$DefenseStationInternalDock" object="$DefenseStation" checkoperational="true" multiple="false">
                      <match_dock storage="true" size="macro.ship_arg_s_fighter_04_a_macro.docksize"/>
                      <!--match_dock size="macro.ship_arg_s_fighter_04_a_macro.docksize" comment="could be a launchtube"/-->
                    </find_object_component>

                    <do_if value="$DefenseStationInternalDock.exists">
                      <debug_text text="'Distration-ship in internal dock'" chance="$DebugChance"/>
                      <!-- needs to be friendly to station, otherwise can't put in internal dock buccaneer -->
                      <create_loadout result="$DistractionLoadout">
                        <macros>
                          <engine macro="engine_arg_s_travel_01_mk3_macro" path="../con_engine_01" optional="0" />
                          <engine macro="engine_arg_s_travel_01_mk3_macro" path="../con_engine_02" optional="0"/>
                          <weapon macro="weapon_gen_s_guided_01_mk1_macro" path="../con_weapon_006" optional="1" />
                          <weapon macro="weapon_gen_s_gatling_01_mk1_macro" path="../con_weapon_01" optional="0" />
                          <shield macro="shield_arg_s_standard_01_mk3_macro" path="../con_shield_01" optional="0" />
                        </macros>
                        <virtualmacros>
                          <thruster macro="thruster_gen_s_allround_01_mk1_macro" />
                        </virtualmacros>
                      </create_loadout>

                      <create_ship name="$DistractionShip" macro="ship_arg_s_fighter_04_a_macro" dock="$DefenseStationInternalDock" mission="true" capturable="false">
                        <owner exact="faction.civilian" overridenpc="true" />
                        <pilot macro="character_argon_male_plot_spy_macro">
                          <skills>
                            <skill type="management"  exact="2"/>
                            <skill type="morale"      exact="15"/>
                            <skill type="piloting"    exact="13"/>
                            <skill type="engineering" exact="5"/>
                            <skill type="boarding"    exact="1"/>
                          </skills>
                        </pilot>
                        <loadout loadout="$DistractionLoadout"/>
                      </create_ship>
                    </do_if>
                    <do_else>
                      <debug_text text="'All internal dock full, spawn ship for distraction near station'" chance="$DebugChance"/>
                      <create_ship name="$DistractionShip" macro="ship_arg_s_fighter_04_a_macro" sector="$DefenseStation.sector" mission="true" capturable="false">
                        <owner exact="faction.civilian" overridenpc="true" />
                        <pilot>
                          <select faction="faction.buccaneers" tags="tag.elitepilot"/>
                        </pilot>
                        <loadout>
                          <level exact="1.0"/>
                        </loadout>
                        <safepos object="$DefenseStation"/>
                      </create_ship>
                    </do_else>
                    <set_object_min_hull object="$DistractionShip" min="100" comment="invulnerable until away from station"/>
                    <set_object_min_shield object="$DistractionShip" min="100" comment="full shields (for boosting)"/>

                    <set_object_name object="$DistractionShip" page="30220" line="132" comment="Nothing To See Here"/>
                  </actions>
                  <cues>
                    <cue name="Ch5_Distraction_escape">
                      <delay exact="10s"/>
                      <actions>
                        <debug_text text="'Escape!'" chance="$DebugChance"/>
                        <create_order id="'Flee'" object="$DistractionShip" immediate="true">
                          <param name="method" value="'boost'"/>
                          <param name="attacker" value="$DefenseStation"/>
                          <param name="donotdrop" value="true"/>
                          <param name="deploydistraction" value="false"/>
                          <param name="log" value="false"/>
                          <param name="debugchance" value="0"/>
                        </create_order>
                      </actions>
                      <cues>

                        <cue name="Ch5_Distraction_Noticed">
                          <delay exact="5s" comment="wait a bit, before Boso notices"/>
                          <actions>
                            <signal_cue cue="Ch5_Distraction_Noticed_Speak"/>
                          </actions>
                          <cues>
                            <cue name="Ch5_Distraction_Noticed_Speak">
                              <conditions>
                                <event_cue_signalled/>
                              </conditions>
                              <cues>
                                <cue name="Ch5_Distraction_Boso_Noticed_Speak_Ref" ref="md.LIB_Dialog.Speak_Actors">
                                  <param name="Actor"             value="[$BosoTa, $DalBusta]"/>
                                  <param name="CutsceneKey"       value="[$BosoCutsceneKey, $DalCutsceneKey]"/>
                                  <param name="Lines"             value="[[[if player.entity.isfemale then 30220502 else 30220501], [30220503]],
                                                                          [[30220509], [30220510]]]"/>
                                  <param name="EndSignalCue"      value="[null, Ch5_Distraction_TrackWait]"/>
                                  <!--           
                                    <text line="if player.entity.isfemale then 30220502 else 30220501" comment="I don't mean to interrupt... (short pause before 'whatever')whatever it is that you are doing."/>
                                    <text line="30220503" comment="I am detecting a ship with an obfuscated signature, lifting off from that station."/>
                                    <text line="30220509" comment="Just as Kromancketslat started his negotiations."/>
                                    <text line="30220510" comment="That can't be a coincidence." delay="1s"/>
                                  -->
                                </cue>
                              </cues>
                            </cue>
                          </cues>
                        </cue>

                        <cue name="Ch5_Distraction_TrackWait">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <actions>
                            <set_value name="$ObjectiveStep" operation="add"/>
                            <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.track" text="{30220,5005}" object="$DistractionShip" endtime="player.age + 60s" updatebriefing="true" />
                          </actions>
                          <cues>
                            <cue name="Ch5_Distraction_Timeout">
                              <delay exact="60s"/>
                              <actions>
                                <debug_text text="'spyship escaped'" chance="$DebugChance"/>
                                <cancel_cue cue="Ch5_Distraction_Track"/>
                              </actions>
                              <cues>

                                <cue name="Ch5_Distraction_Dal_Cutscene">
                                  <conditions>
                                    <event_cue_completed cue="Ch5_Distraction_Timeout"/>
                                  </conditions>
                                  <cues>
                                    <cue name="Ch5_Distraction_Dal_Cutscene_Ref" ref="md.LIB_Dialog.Speak_Actors">
                                      <param name="Actor"             value="[$DalBusta, $BosoTa, $DalBusta]"/>
                                      <param name="CutsceneKey"       value="[$DalCutsceneKey, $BosoCutsceneKey, $DalCutsceneKey]"/>
                                      <param name="Lines"             value="[[[30220519]],
                                                                              [[30220504], [30220505]], 
                                                                              [[30220520]],
                                                                             ]"/>
                                      <param name="EndSignalCue"      value="[null, null, Ch5_Attack_Delayed]"/>
                                      <!--           
                                        <text line="30220519" comment="That's unfortunate. It seems to have got away!"/>
                                        <text line="30220504" comment="Do not be downhearted, my sensitive assistants."/>
                                        <text line="30220505" comment="We have gained the valuable insight that dark and mysterious forces are watching our every move."/>
                                        <text line="30220520" comment="How is that supposed to be valuable? No wait, don't answer that."/>
                                      -->
                                    </cue>
                                  </cues>
                                </cue>
                              </cues>
                            </cue>

                            <cue name="Ch5_Distraction_Track" checkinterval="1s" comment="make sure distraction is a bit away from station, before we check if player is nearby (forces player away from station)">
                              <conditions>
                                <check_value value="$DefenseStation.distanceto.{$DistractionShip} gt 10km"/>
                              </conditions>
                              <actions>
                                <!--<set_object_min_hull object="$DistractionShip" min="0" comment="not invulnerable anymore"/>
                                <set_object_min_shield object="$DistractionShip" min="0" comment="not invulnerable anymore"/>-->
                              </actions>
                              <cues>

                                <!-- check if player gets near to escaping spy-ship -->
                                <cue name="Ch5_Distraction_Approach_Ref" ref="md.LIB_Generic.ApproachObject_Handler">
                                  <param name="ApproachObject"    value="player.entity"/>
                                  <param name="ApproachTarget"    value="$DistractionShip"/>
                                  <param name="ApproachDistance"  value="5km"/>
                                  <param name="SuccessSignalCue"  value="Ch5_Distraction_Approached"/>
                                </cue>

                                <cue name="Ch5_Distraction_Approached">
                                  <conditions>
                                    <event_cue_signalled/>
                                  </conditions>
                                  <actions>
                                    <debug_text text="'Player approached spyship'" chance="$DebugChance"/>
                                    <cancel_cue cue="Ch5_Distraction_Timeout"/>
                                    <!-- blow up spy-ship and remember position -->
                                    <set_value name="$DistractionSector" exact="$DistractionShip.sector"/>
                                    <create_position name="$DistractionLocation" object="$DistractionShip" space="$DistractionSector"/>
                                    <destroy_object object="$DistractionShip" explosion="true"/>
                                  </actions>
                                  <cues>
                                    <cue name="Ch5_Investigate">
                                      <delay exact="1s"/>
                                      <actions>
                                        <set_value name="$ObjectiveStep" operation="add"/>
                                        <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.investigate" text="{30220,5005}" object="$DistractionSector" offset="$DistractionLocation" radius="2500m" updatebriefing="true"/>
                                      </actions>
                                      <cues>

                                        <!-- check if player is near wreck of spy-ship -->
                                        <cue name="Ch5_Investigate_Approach_Ref" ref="md.LIB_Generic.ApproachLocation_Handler">
                                          <param name="ApproachObject"    value="player.entity"/>
                                          <param name="ApproachSector"    value="$DistractionSector"/>
                                          <param name="ApproachOffset"    value="$DistractionLocation"/>
                                          <param name="ApproachDistance"  value="3km"/>
                                          <param name="SuccessSignalCue"  value="Ch5_Investigate_Approached"/>
                                        </cue>

                                        <cue name="Ch5_Investigate_Approached">
                                          <conditions>
                                            <event_cue_signalled/>
                                          </conditions>
                                          <actions>
                                          </actions>
                                          <cues>
                                            <cue name="Ch5_Investigate_Approached_Ref" ref="md.LIB_Dialog.Speak_Actor">
                                              <param name="Actor"             value="$DalBusta"/>
                                              <param name="CutsceneKey"       value="$DalCutsceneKey"/>
                                              <param name="Lines"             value="[[30220513], [30220514], [30220515, 2s], [if player.entity.isfemale then 30220517 else 30220516, 1s], [30220518, 1s]]"/>
                                              <param name="EndSignalCue"      value="Ch5_Attack_Delayed"/>
                                              <!--
                                                  <text line="30220513" comment="That must be the mystery ship, or what remains of it."/>
                                                  <text line="30220514" comment="Why does everyone we encounter keep blowing themselves up?"/>
                                                  <text line="30220515" comment="Well, at least we've gained some valuable information by coming out here."/>
                                                  <text line="if player.entity.isfemale then 30220517 else 30220516" comment="How? Well, because that, my friend, was an Argon-made ship with Paranid weaponry."/>
                                                  <text line="30220518" comment="There are more parties involved in this than I anticipated."/>
                                              -->
                                            </cue>
                                          </cues>
                                        </cue>
                                      </cues>
                                    </cue>
                                  </cues>
                                </cue>
                              </cues>
                            </cue>
                          </cues>
                        </cue>

                      </cues>
                    </cue>
                  </cues>
                </cue>
              </cues>
            </cue>

            <cue name="Ch5_Attack_Delayed">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <delay exact="3s"/>
              <actions>
                <signal_cue cue="Ch5_Attack"/>
              </actions>
            </cue>

            <cue name="Ch5_Attack">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <debug_text text="'Ch5_Attack!'" chance="$DebugChance"/>
                <create_group groupname="$Ch5AttackWave"/>
                <set_value name="$ObjectiveStep" operation="add"/>
                <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.flyto" object="$KroShip" text="{30220,5006}" updatebriefing="true"/>
              </actions>
              <cues>

                <!--Adjust this to balance the amount of Holy Order Fanatic ships the player has to fight-->
                <library name="Ch5_Attack_Balance">
                  <actions>
                    <!--Set defaults-->
                    <set_value name="$PlayerShipType" exact="player.ship.type"/>
                    <set_value name="$BalancedFanaticAmount" exact="3" comment="fallback"/>
                    <!--Failsafe if player is in spacesuit and we don't know their actual shiptype-->
                    <do_if value="player.ship.isclass.spacesuit">
                      <debug_text text="'Player is in spacesuit, trying to set enemy ship amount according to his previous ship'" chance="$DebugChance"/>
                      <do_if value="$MainPlayerShip? and $MainPlayerShip != null">
                        <debug_text text="'Previous player ship type is: ' + $MainPlayerShip.type" chance="$DebugChance"/>
                        <set_value name="$PlayerShipType" exact="$MainPlayerShip.type"/>
                      </do_if>
                      <do_else>
                        <debug_text text="'Could not find previous player ship. Enemy ship amount set to default'" chance="$DebugChance"/>
                      </do_else>
                    </do_if>

                    <do_if value="[shiptype.scout, shiptype.fighter, shiptype.interceptor].indexof.{$PlayerShipType}">
                      <set_value name="$BalancedFanaticAmount" exact="3"/>
                    </do_if>
                    <do_elseif value="[shiptype.heavyfighter].indexof.{$PlayerShipType}">
                      <set_value name="$BalancedFanaticAmount" exact="4"/>
                    </do_elseif>
                    <do_elseif value="[shiptype.frigate, shiptype.gunboat, shiptype.corvette].indexof.{$PlayerShipType}">
                      <set_value name="$BalancedFanaticAmount" exact="6"/>
                    </do_elseif>
                    <do_elseif value="[shiptype.destroyer, shiptype.carrier, shiptype.battleship].indexof.{$PlayerShipType}">
                      <set_value name="$BalancedFanaticAmount" exact="20"/>
                    </do_elseif>
                    <do_else>
                      <debug_text text="'Player shiptype does not fit fighter definitions: ' + player.ship.type + '. Enemy ship amount set to default: ' + $BalancedFanaticAmount" chance="$DebugChance"/>
                    </do_else>
                  </actions>
                </library>

                <cue name="Ch5_Attack_FighterWave">
                  <actions>
                    <include_actions ref="Ch5_Attack_Balance"/>
                    <!-- enemies spawn -->
                    <set_value name="$AttackSetup"   exact="[
                        [ macro.ship_par_s_fighter_02_b_macro, faction.holyorderfanatic, $DefenseStation],
                        [ macro.ship_par_s_fighter_01_b_macro, faction.holyorderfanatic, $DefenseStation],
                        [ macro.ship_par_s_fighter_01_b_macro, faction.holyorderfanatic, $DefenseStation],
                        
                        [ macro.ship_par_s_fighter_02_b_macro, faction.holyorderfanatic, $DefenseStation],
                        
                        [ macro.ship_par_s_fighter_01_b_macro, faction.holyorderfanatic, $DefenseStation],
                        [ macro.ship_par_s_fighter_02_b_macro, faction.holyorderfanatic, $DefenseStation],
                        
                        [ macro.ship_par_s_fighter_01_b_macro, faction.holyorderfanatic, $DefenseStation],
                        [ macro.ship_par_s_fighter_01_b_macro, faction.holyorderfanatic, $DefenseStation],
                        [ macro.ship_par_m_frigate_01_b_macro, faction.holyorderfanatic, $DefenseStation],
                        [ macro.ship_par_m_frigate_01_b_macro, faction.holyorderfanatic, $DefenseStation],
                        [ macro.ship_par_m_frigate_01_b_macro, faction.holyorderfanatic, $DefenseStation],
                        [ macro.ship_par_m_frigate_01_b_macro, faction.holyorderfanatic, $DefenseStation],
                        [ macro.ship_par_s_fighter_02_b_macro, faction.holyorderfanatic, $DefenseStation],
                        [ macro.ship_par_s_fighter_02_b_macro, faction.holyorderfanatic, $DefenseStation],
                        [ macro.ship_par_s_fighter_02_b_macro, faction.holyorderfanatic, $DefenseStation],
                        [ macro.ship_par_s_fighter_02_b_macro, faction.holyorderfanatic, $DefenseStation],
                        [ macro.ship_par_s_fighter_01_b_macro, faction.holyorderfanatic, $DefenseStation],
                        [ macro.ship_par_s_fighter_01_b_macro, faction.holyorderfanatic, $DefenseStation],
                        [ macro.ship_par_s_fighter_01_b_macro, faction.holyorderfanatic, $DefenseStation],
                        [ macro.ship_par_s_fighter_01_b_macro, faction.holyorderfanatic, $DefenseStation]
                      ]" />

                    <do_all exact="$BalancedFanaticAmount" counter="$k">
                      <create_ship name="$fighter" macro="$AttackSetup.{$k}.{1}" sector="$AttackSetup.{$k}.{3}.sector" mission="true" capturable="false">
                        <owner exact="$AttackSetup.{$k}.{2}" overridenpc="true" />
                        <pilot>
                          <select faction="$AttackSetup.{$k}.{2}" tags="tag.fighterpilot"/>
                        </pilot>
                        <loadout>
                          <level exact="0.8"/>
                        </loadout>
                        <safepos object="$AttackSetup.{$k}.{3}" min="2km"  max="8km"/>
                      </create_ship>

                      <signal_objects object="player.galaxy" param="'Cover'" param2="[$fighter, faction.holyorder, true, true]"/>

                      <set_relation_boost object="$fighter" value="-1" faction="faction.player" silent="true" decay="0"/>
                      <set_relation_boost object="$fighter" value="-1" faction="faction.buccaneers" silent="true" decay="0"/>
                      <set_relation_boost object="$fighter" value="-1" faction="faction.holyorder" silent="true" decay="0"/>

                      <do_if value="@$DefenseStation">
                        <set_relation_boost object="$fighter" value="1" otherobject="$DefenseStation"/>
                      </do_if>

                      <set_object_relation_behaviour object="$fighter" disable="true"/>

                      <create_order id="'Attack'" name="$attackOrder" object="$fighter">
                        <param name="primarytarget" value="$KroShip"/>
                        <param name="pursuetargets" value="true"/>
                        <param name="checkrelation" value="false"/>
                      </create_order>
                      <add_to_group groupname="$Ch5AttackWave" object="$fighter"/>
                    </do_all>
                  </actions>
                </cue>

                <cue name="Ch5_Attack_RikJoins">
                  <actions>
                    <!-- find the gate from 'Cardinal's redress' to 'lasting vengeance' -->
                    <find_object name="$ExitGates" class="[class.gate]" space="$CardinalSector" multiple="true"/>
                    <do_all exact="$ExitGates.count" counter="$g">
                      <do_if value="$ExitGates.{$g}.exit.sector == $DerelictSector" >
                        <set_value name="$CardinalVengeanceGate" exact="$ExitGates.{$g}"/>
                        <break/>
                      </do_if>
                    </do_all>
                    <assert value="($CardinalVengeanceGate.exists) and ($CardinalVengeanceGate.sector == $DefenseStation.sector)"/>
                    <!-- find Rik's ships -->
                    <!-- TODO: Rik's HopCorvettes should probably be a global -->
                    <find_ship groupname="$HopCorvettes" multiple="true" owner="faction.holyorder" space="player.galaxy" jobtags="[tag.monument]"/>
                    <debug_text text="'HopCorvettes found: ' + $HopCorvettes.count" chance="$DebugChance"/>

                    <!-- If one ship remains, set it as leader for the following spawns. -->
                    <do_if value="$HopCorvettes.count">
                      <set_value name="$HopCorvettesLeader" exact="$HopCorvettes.random"/>
                      <set_object_capturable object="$HopCorvettesLeader" capturable="false"/>
                    </do_if>

                    <!-- If the Honour Guard squad is destroyed or incomplete, spawn the missing ships. They are unperishable.-->
                    <do_if value="$HopCorvettes.count le 1">
                      <create_ship ref="holyorder_corvette_m_elite" name="$NewNemesis" commandeerable="false" capturable="false" mission="true" sector="$CardinalSector">
                        <owner exact="faction.holyorder" overridenpc="true"/>
                        <pilot actor="$RikActor"/>
                        <people ref="paranid_elite_military_crew"/>
                      </create_ship>
                      <!-- In case the sector got taken over by the Godrealm. -->
                      <set_relation_boost object="$NewNemesis" faction="faction.paranid" value="1.0" decay="0"/>
                      <add_to_group groupname="$HopCorvettes" object="$NewNemesis"/>
                      <do_if value="$HopCorvettesLeader?">
                        <create_order id="'AssignCommander'" object="$NewNemesis" immediate="true">
                          <param name="commander" value="$HopCorvettesLeader"/>
                          <param name="assignment" value="assignment.defence"/>
                          <param name="cancelorders" value="true"/>
                        </create_order>
                      </do_if>
                      <do_else>
                        <set_value name="$HopCorvettesLeader" exact="$NewNemesis"/>
                      </do_else>
                    </do_if>

                    <!-- Make Honour Guard leader invincible for this mission. Wouldn't make sense for Rikmanckassor to talk after the fight if he's dead. -->
                    <set_object_min_hull object="$HopCorvettesLeader" exact="20"/>

                    <!-- Deactivating Monument jobs and guard response cue -->
                    <cancel_cue cue="Paranid_Monument_Generic_Guard_Response"/>
                    <set_job_active job="'holyorder_corvette_elite_m'" activate="false"/>
                    <set_job_active job="'holyorder_corvette_escort_elite_m'" activate="false"/>
                  </actions>
                  <cues>

                    <cue name="Ch5_Attack_Debug_RikShips">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <set_objective cue="$MissionCue" action="objective.protect" group="$HopCorvettes" text="{30220,5006}"/>
                      </actions>
                    </cue>

                    <cue name="Ch5_Attack_prepare">
                      <delay exact="1s"/>
                      <cues>
                        <!-- help Rik a bit by warping him closer -->
                        <cue name="Ch5_Attack_Location_Ref" ref="md.LIB_Generic.WarpBetweenObjects">
                          <param name="FromObject" value="$CardinalVengeanceGate" />
                          <param name="ToObject" value="$DefenseStation" />
                          <param name="Distance01" value="0.75" />
                          <param name="WarpGroup" value="$HopCorvettes"/>
                        </cue>

                        <cue name="Ch5_Attack_RikShips">
                          <delay exact="1s"/>
                          <actions>
                            <do_all exact="$HopCorvettes.count" counter="$c">
                              <!-- TODO: @Nick, this doesn't seem to work... they just fly away... ? -->
                              <create_order id="'Attack'" name="$attackOrder" object="$HopCorvettes.{$c}" immediate="true">
                                <param name="primarytarget" value="$Ch5AttackWave.random"/>
                                <param name="secondarytargets" value="$Ch5AttackWave"/>
                                <param name="pursuetargets" value="true"/>
                                <param name="checkrelation" value="false"/>
                              </create_order>
                            </do_all>
                          </actions>
                        </cue>
                      </cues>
                    </cue>
                  </cues>
                </cue>

                <cue name="Ch5_Rik_Approach" onfail="cancel">
                  <conditions>
                    <check_value value="$HopCorvettes.count"/>
                  </conditions>
                  <cues>
                    <cue name="Battle_Rik_Approach_Ref" ref="md.LIB_Generic.ApproachObject_Handler">
                      <param name="ApproachObject"    value="$HopCorvettes.{1}"/>
                      <param name="ApproachTarget"    value="$KroShip"/>
                      <param name="ApproachDistance"  value="10km"/>
                      <param name="SuccessSignalCue"  value="Ch5_Rik_Arrived"/>
                    </cue>

                    <cue name="Ch5_Rik_Arrived">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <cues>
                        <cue name="Ch5_Rik_Arrived_Cutscene_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$RikActor"/>
                          <param name="CutsceneKey"       value="$RikCutsceneKey"/>
                          <param name="Lines"             value="[[30220501], [30220502], [30220503]]"/>
                          <param name="EndSignalCue"      value="null"/>
                          <!--
                            <text page="10304" line="30220501" comment="Prophet!"/>
                            <text page="10304" line="30220502" comment="You have wisely chosen to promptly divest yourself of the most obstinate non-believers, on this occasion."/>
                            <text page="10304" line="30220503" comment="Though it appears that you are in need of assistance."/>
                          -->
                        </cue>
                      </cues>
                    </cue>
                  </cues>
                </cue>

                <cue name="Ch5_Attack_Kro_Undock">
                  <actions>
                    <!-- Duke undocks and flies toward player -->
                    <cancel_all_orders object="$KroShip"/>
                    <create_order object="$KroShip" id="'MoveGeneric'" default="true">
                      <param name="destination" value="player.entity" />
                    </create_order>
                    <do_all exact="$Ch5AttackWave.count" counter="$f">
                      <signal_objects object="$Ch5AttackWave.{$f}" param="'LoseCover'"/>
                    </do_all>
                  </actions>
                  <delay exact="5s"/>
                  <actions>
                    <signal_cue cue="Ch5_Attack_Support_Kro_Cutscene_Delay"/>
                  </actions>
                  <cues>
                    <cue name="Ch5_Attack_Support_Kro_Cutscene_Delay">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <cues>
                        <cue name="Ch5_Attack_Support_Kro_Cutscene">
                          <cues>
                            <cue name="Ch5_Attack_Support_Kro_Cutscene_Ref" ref="md.LIB_Dialog.Speak_Actor">
                              <param name="Actor"             value="$Duke"/>
                              <param name="CutsceneKey"       value="$DukeCutsceneKey"/>
                              <param name="Lines"             value="[[30220515], [30220516]]"/>
                              <param name="EndSignalCue"      value="Ch5_Attack_Kro_Undock_Done"/>
                              <!--
                                <text line="30220515" comment="Our negotiations with the Holy Order leadership were brief and inconclusive, as we expected."/>
                                <text line="30220516" comment="However, it appears that our endeavours have not gone unnoticed by more sceptical elements of the Holy Order."/>
                              -->
                            </cue>
                          </cues>
                        </cue>
                      </cues>
                    </cue>
                  </cues>
                </cue>

                <cue name="Ch5_Attack_Kro_PreemptiveAttack" comment="In case the player attacks the $Ch5AttackWave, while staying away from Kro">
                  <conditions>
                    <event_object_destroyed group="$Ch5AttackWave"/>
                    <cue_is_waiting cue="Ch5_Attack_Approached"/>
                  </conditions>
                  <actions>
                    <signal_cue cue="Ch5_Attack_Approached"/>
                    <cancel_cue cue="Ch5_Attack_Kro_Undock_Done"/>
                  </actions>
                </cue>

                <cue name="Ch5_Attack_Kro_Undock_Done" comment="In case the player flies to Kro, like instructed">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <cues>
                    <cue name="Ch5_Attack_Approach_Ref" ref="md.LIB_Generic.ApproachObject_Handler">
                      <param name="ApproachObject"    value="player.entity"/>
                      <param name="ApproachTarget"    value="$KroShip"/>
                      <param name="ApproachDistance"  value="3km"/>
                      <param name="SuccessSignalCue"  value="Ch5_Attack_Approach_Handler"/>
                    </cue>

                    <cue name="Ch5_Attack_Approach_Handler">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <signal_cue cue="Ch5_Attack_Approached"/>
                        <cancel_cue cue="Ch5_Attack_Kro_PreemptiveAttack"/>
                      </actions>
                    </cue>
                  </cues>
                </cue>

                <cue name="Ch5_Attack_Approached">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <play_music music="'music_story_paranid_fanatic_fight'" comment="153s"/>

                    <set_value name="$AttackedPlayerShip" exact="player.ship"/>

                    <do_all exact="$Ch5AttackWave.count" counter="$i">
                      <do_if value="$i gt 3" chance="75">
                        <create_order id="'Attack'" object="$Ch5AttackWave.{$i}" immediate="true">
                          <param name="primarytarget" value="$AttackedPlayerShip"/>
                          <param name="pursuetargets" value="true"/>
                          <param name="checkrelation" value="false"/>
                        </create_order>
                      </do_if>
                    </do_all>
                  </actions>
                  <cues>
                    <cue name="Ch5_Attack_Approached_Music_Handler">
                      <actions>
                      </actions>
                    </cue>

                    <cue name="Ch5_Attack_Kro_Cutscene">
                      <cues>
                        <cue name="Ch5_Attack_Kro_Cutscene_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$Duke"/>
                          <param name="CutsceneKey"       value="$DukeCutsceneKey"/>
                          <param name="Lines"             value="[[30220518]]"/>
                          <param name="EndSignalCue"      value="Ch5_Attack_Dal_Cutscene"/>
                          <!--
                            <text line="30220518" comment="These heretics need to be removed from our presence."/>
                          -->
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Ch5_Attack_Dal_Cutscene">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <set_value name="$ObjectiveStep" operation="add"/>
                        <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.protect" group="$Ch5AttackWave" text="{30220,5006}" updatebriefing="true"/>
                      </actions>
                      <cues>
                        <cue name="Ch5_Attack_Dal_Cutscene_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$DalBusta"/>
                          <param name="CutsceneKey"       value="$DalCutsceneKey"/>
                          <param name="Lines"             value="[[30220521], [30220522]]"/>
                          <param name="EndSignalCue"      value="null"/>
                          <!--
                            <text line="30220521" comment="Those attackers are Holy Order!"/>
                            <text line="30220522" comment="Hatikvah's mercy! How did this happen?!"/>
                          -->
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Ch5_Attack_Kro_Attack">
                      <actions>
                        <cancel_all_orders object="$KroShip"/>
                        <create_order object="$KroShip" id="'Attack'" immediate="true">
                          <param name="primarytarget" value="$Ch5AttackWave.random"/>
                          <param name="secondarytargets" value="$Ch5AttackWave"/>
                          <param name="pursuetargets" value="false"/>
                          <param name="checkrelation" value="false"/>
                        </create_order>
                      </actions>
                    </cue>

                    <cue name="Ch5_Attack_DebugVictory">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <do_all exact="$Ch5AttackWave.count" counter="$i">
                          <destroy_object object="$Ch5AttackWave.{$i}" explosion="true"/>
                        </do_all>
                      </actions>
                    </cue>

                    <cue name="Ch5_Attack_Progress" instantiate="true">
                      <conditions>
                        <event_object_destroyed group="$Ch5AttackWave"/>
                        <check_value value="$Ch5AttackWave.count gt 1" comment="destroyed group-member"/>
                      </conditions>
                      <actions>
                        <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.protect" group="$Ch5AttackWave" text="{30220,5006}"/>
                      </actions>
                    </cue>

                    <cue name="Ch5_Attack_Almost_Won">
                      <conditions>
                        <event_object_destroyed group="$Ch5AttackWave"/>
                        <check_value value="$Ch5AttackWave.count == 2"/>
                      </conditions>
                      <cues>
                        <cue name="Ch5_Attack_Almost_Won_Kro_Cutscene_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$Duke"/>
                          <param name="CutsceneKey"       value="$DukeCutsceneKey"/>
                          <param name="Lines"             value="[[30220519]]"/>
                          <param name="EndSignalCue"      value="null"/>
                          <!--
                            (in combat, grandiosely)The tides of battle are turning!
                          -->
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Ch5_Attack_Victory">
                      <conditions>
                        <event_object_destroyed group="$Ch5AttackWave"/>
                        <check_value value="$Ch5AttackWave.count == 1" comment="about to destroy last object"/>
                      </conditions>
                      <actions>
                        <stop_music comment="Stops 'music_story_paranid_fanatic_fight'"/>
                        <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.protect" object="$KroShip" text="{30220,5006}" updatebriefing="true"/>
                      </actions>
                      <cues>

                        <cue name="Ch5_Attack_Victory_Cutscene1">
                          <actions>
                            <speak actor="$Duke">
                              <text line="30220520"/>
                              <text line="30220521"/>
                            </speak>
                          </actions>
                        </cue>

                        <cue name="Ch5_Attack_Victory_Cutscene2">
                          <conditions>
                            <event_speak_finished actor="$Duke" line="30220520"/>
                          </conditions>
                          <actions>
                            <speak actor="$RikActor">
                              <text line="30220504"/>
                            </speak>
                          </actions>
                        </cue>

                        <cue name="Ch5_Attack_Victory_Cutscene3">
                          <conditions>
                            <event_speak_finished actor="$RikActor" line="30220504"/>
                          </conditions>
                          <cues>
                            <cue name="Ch5_Attack_Victory_Cutscene3_Ref" ref="md.LIB_Dialog.Speak_Actors">
                              <param name="Actor"             value="[$RikActor, $DalBusta]"/>
                              <param name="CutsceneKey"       value="[$RikCutsceneKey, $DalCutsceneKey]"/>
                              <param name="Lines"             value="[
                                                                  [[if player.entity.race == race.paranid then 30220507 else if player.entity.isfemale then 30220506 else 30220505], [if $MissionCue.$MonumentGuardKilledPrematurely? then if player.entity.isfemale then 30220512 else 30220511 else if player.entity.isfemale then 30220509 else 30220508], [if $MissionCue.$MonumentGuardKilledPrematurely? then if player.entity.isfemale then 30220514 else 30220513 else 30220510] ],
                                                                  [[30220527],[30220528],[if player.entity.race == race.paranid then 30220524 else 30220523, 0.5s], [30220525]]
                                                                  ]"/>
                              <param name="EndSignalCue"      value="[null,  Ch5_Attack_Done]"/>
                              <!--           
                                <text line="30220520" comment="(after combat, politely)Priest Guardian Rikmanckassor."/>
                                <text line="30220521" comment="(after combat, politely)We should have expected your intervention."/>
                                <text page="10304" line="30220504" comment="The Pontifex observes your endeavours with great interest, Tarnished Prophet."/>
                                <text page="10304" line="if player.entity.race == race.paranid then 30220507 else if player.entity.isfemale then 30220506 else 30220505" comment="And you, unholy creature..."/>
                                ... rik was not defeated
                                  <text page="10304" line="if player.entity.isfemale then 30220509 else 30220508" comment="We see that you have pledged yourself to a most powerful being for protection."/>
                                  <text page="10304" line="30220510" comment="Pathetic, but wise nonetheless."/>
                                ... rik was defeated earlier
                                  <text page="10304" line="if player.entity.isfemale then 30220512 else 30220511" comment="...have proven yourself in battle once again."/>
                                  <text page="10304" line="if player.entity.isfemale then 30220514 else 30220513" comment="It has been an honour for you to fight at our side."/>
                                  Tarnished Prophet'? Seriously?
                                  That sounds as if this wasn't Kromancketslat's first attempt to get involved.
                                <text line="if player.entity.race == race.paranid then 30220524 else 30220523" comment="It never ceases to amaze me how calm they stay in a combat situation."/>
                                <text line="30220525" comment="But in this case, it's almost as if they expected the attack."/>
                            -->
                            </cue>
                          </cues>
                        </cue>


                        <cue name="Ch5_Attack_Done">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <actions>
                            <!-- Revert Honour Guard leader invincibility. He'll respawn for the next fight if he's killed during the next chapter. -->
                            <set_object_min_hull object="$HopCorvettesLeader" exact="0"/>

                            <remove_mission cue="$MissionCue" type="completed"/>
                            <write_to_logbook category="missions" faction="faction.player" title="{30220,5001}" text="if player.entity.isfemale then {30220,5010} else {30220,5009}"/>
                            <signal_cue cue="Ch6_Standoff"/>
                          </actions>
                        </cue>

                      </cues>
                    </cue>
                  </cues>
                </cue>
              </cues>
            </cue>

          </cues>
        </cue>

        <!-- Chapter 6: Standoff at the Monument -->

        <cue name="Ch6_Force">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <cancel_cue cue="Paranid_Monument_Generic_Guard_Response"/>
            <set_job_active job="'holyorder_corvette_elite_m'" activate="false"/>
            <set_job_active job="'holyorder_corvette_escort_elite_m'" activate="false"/>

            <!-- Pretend that the player did not save the cipher ship, which is highly probable -->
            <set_value name="$CipherShipEscaped" exact="false"/>

            <set_value name="$ObjectiveStep" exact="1"/>

            <find_station name="$DefenseStation" space="$CardinalSector" defencestation="true" required="true"/>
            <create_position name="$DefenseStationPosition" object="$DefenseStation" space="$DefenseStation.sector"/>

            <!-- ship originally spawned in previous chapter, but if we force we need to create it ourselves -->
            <do_if value="not $KroShip? or not $KroShip.exists">
              <create_ship name="$KroShip" macro="ship_par_s_scout_01_b_macro" capturable="false" commandeerable="false" mission="true" sector="$CardinalSector">
                <pilot>
                  <select race="race.paranid" tags="tag.elitepilot"/>
                </pilot>
                <owner exact="faction.civilian" overridenpc="true"/>
                <paint ware="ware.paintmod_0112"/>
                <loadout>
                  <level exact="1.0"/>
                </loadout>
                <safepos object="$DefenseStation"/>
              </create_ship>
              <set_object_min_hull object="$KroShip" min="80"/>
              <set_known object="$KroShip" known="true"/>
              <set_relation_boost object="$KroShip" value="0.01" faction="faction.player" silent="true" decay="0"/>
              <set_object_name object="$KroShip" page="30220" line="143" comment="Indomitable Spirit"/>
            </do_if>
            <do_else>
              <debug_text text="'Kroship already exists'" chance="$DebugChance"/>
            </do_else>

            <set_entity_traits entity="$Duke" missionactor="true" customhandler="true" subtitlename="true"/>
            <set_entity_overrides entity="$Duke" title="'{30220,112}'"/>

            <!-- Warp Rik to Defence Station in Cardinal's Redress -->
            <find_ship groupname="$HopCorvettes" multiple="true" owner="faction.holyorder" space="player.galaxy" jobtags="[tag.monument]"/>
            <do_all exact="$HopCorvettes.count" counter="$i">
              <warp object="$HopCorvettes.{$i}" sector="$DefenseStation.sector">
                <safepos value="$DefenseStationPosition"/>
              </warp>
            </do_all>

            <signal_cue_instantly cue="Force_Chapter" param="Ch6_Standoff"/>
          </actions>
        </cue>

        <cue name="Ch6_Standoff">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <debug_text text="'Starting part ' + this" chance="$DebugChance"/>
            <set_value name="$CurrentPartCue" exact="this"/>
            <set_value name="$ObjectiveStep" exact="1"/>

            <!-- Improve relations to show trust. Should be locked on game start and stay locked here. -->
            <set_faction_relation_locked faction="faction.buccaneers" locked="false"/>
            <set_faction_relation faction="faction.buccaneers" otherfaction="faction.player" value="0.011"/>
            <set_faction_relation_locked faction="faction.buccaneers" locked="true"/>

            <!-- mission for chapter 6 -->
            <create_mission cue="$MissionCue" name="{30220,6001}" description="if player.entity.isfemale then {30220,6020} else {30220,6002}" rewardtext="{30220,6029}" type="missiontype.plot" faction="faction.player" difficulty="level.medium" abortable="false" icon="'briefing_kromancketslat_01'" iconcaption="$Duke.name" >
              <briefing>
                <objective step="$ObjectiveStep" action="objective.custom" customaction="{30220,5003}" object="$KroShip" text="$Duke.name" comment="Accompany: Kromancketslat"/>
              </briefing>
            </create_mission>
            <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.custom" customaction="{30220,5003}" object="$KroShip" text="$Duke.name"/>
          </actions>
          <cues>


            <cue name="Ch6_Gride_AtMonument">
              <actions>
                <!-- Create Gride's ship, waiting at the entrance into the monument -->
                <create_ship name="$GrideShip" macro="ship_par_m_frigate_01_b_macro" capturable="false" commandeerable="false" mission="true" sector="$ParanidMonumentSector">
                  <owner exact="faction.buccaneers" overridenpc="true"/>
                  <pilot comment="pilot REQUIRED, otherwise you can't dock!" ref="fighter_paranid_random_elite"/>
                  <loadout ref="story_paranid_gride_gorgon"/>
                  <position x="92225.117" y="-985.016" z="14315.398"/>
                  <rotation yaw="-179.62668deg" pitch="0.509635deg" roll="0.562685deg"/>
                </create_ship>

                <set_object_name object="$GrideShip" page="30220" line="133" comment="Howling Petal"/>

                <create_order id="'Wait'" object="$GrideShip" default="true" comment="stay put">
                  <param name="noattackresponse" value="true"/>
                </create_order>

                <set_relation_boost object="$GrideShip" faction="faction.paranid" value="1.0" decay="0"/>
                <set_relation_boost object="$GrideShip" faction="faction.holyorder" value="1.0" decay="0"/>

                <signal_objects object="player.galaxy" param="'Cover'" param2="[$GrideShip, if $GrideShip.sector.owner then $GrideShip.sector.owner else faction.civilian, true, true]"/>
                <set_value name="$GrideShip.pilot.$donotscan" comment="Prevents police from uncovering the ship."/>

                <set_object_min_hull object="$GrideShip" exact="100" comment="invulnerable"/>
                <set_object_min_shield object="$GrideShip" exact="7"/>
                <set_object_relation_behaviour object="$GrideShip" disable="true"/>
                <!-- And put Gride on it, with her back to the transporter room. Apparently the y plane is roughly at head level. -->
                <create_position name="$GridePosition" x="0.0" y="-1.20" z="-1.4"/>
                <create_rotation name="$GrideRotation" yaw="-180deg" />
                <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $GrideActor, table[
                                                                                                                                      $requestercue = $MissionCue,
                                                                                                                                      $priority = 100,
                                                                                                                                      $location = $GrideShip.controlroom,
                                                                                                                                      $rotation = $GrideRotation,
                                                                                                                                      $position = $GridePosition,
                                                                                                                                      $debugchance = $DeepDebugChance,
                                                                                                                                      $debugcaller = if $DebugChance == 100 then this else null]
                                                                                                                                      ]"/>

                <!-- Drone Specialist -> Raider Lieutenant -->
                <set_entity_overrides entity="$GrideActor" title="'{30220,121}'"/>
              </actions>
              <cues>

                <cue name="Ch6_Gride_AtMonument_Uncovered" instantiate="true">
                  <conditions>
                    <event_object_changed_owner object="$GrideShip"/>
                    <check_value value="event.param == event.object.trueowner"/>
                    <check_value value="event.param2 != event.object.trueowner"/>
                  </conditions>
                  <delay exact="7s"/>
                  <actions>
                    <signal_objects object="player.galaxy" param="'Cover'" param2="[$GrideShip, if $GrideShip.sector.owner then $GrideShip.sector.owner else faction.civilian, true, true]"/>
                  </actions>
                </cue>

                <cue name="Ch6_Gride_AtMonument_Scanned">
                  <conditions>
                    <event_scan_finished scanned="$GrideShip" scanner="player.ship"/>
                  </conditions>
                  <delay exact="1s"/>
                  <actions>
                    <do_any>
                      <speak actor="$GrideShip.pilot" line="2009" comment="Begone!"/>
                      <speak actor="$GrideShip.pilot" line="5033" comment="We'll remember that."/>
                      <speak actor="$GrideShip.pilot" line="5034" comment="You better watch your back."/>
                      <speak actor="$GrideShip.pilot" line="9004" comment="Fool!"/>
                    </do_any>
                  </actions>
                  <delay exact="30s"/>
                  <actions>
                    <reset_cue cue="Ch6_Gride_AtMonument_Scanned"/>
                  </actions>
                </cue>

              </cues>
            </cue>

            <cue name="Ch6_ToMonument_Orders">
              <delay exact="1s"/>
              <actions>
                <!-- Create staging points, similar to chapter 7 setup. -->
                <create_position name="$ParanidMonumentPosition" object="$ParanidMonument" space="$ParanidMonumentSector"/>
                <create_position name="$MonumentBattlefield"   x="$ParanidMonumentPosition.x + 25km" y="$ParanidMonumentPosition.y" z="$ParanidMonumentPosition.z - 25km" comment="South-east of Paranid monument."/>
                <create_position name="$HolyOrderStagingPoint" x="$MonumentBattlefield.x - 10km"     y="$MonumentBattlefield.y"     z="$MonumentBattlefield.z"            comment="West of battlefield centre."/>

                <!-- Kro moves to the monument, close to where Gride is parked. -->
                <create_order object="$KroShip" id="'MoveGeneric'" name="$order" immediate="true">
                  <!--param name="destination" value="[$ParanidMonumentSector, $ParanidMonumentPosition]"/-->
                  <param name="destination" value="$ParanidMonumentSector"/>
                  <param name="position" value="position.[92180, -1079, 10363]" comment="opposite of spacesuit entrance"/>
                  <param name="rotation" value="rotation.[1.98, -8.43, -0.47]" comment="opposite of spacesuit entrance"/>
                  <param name="precise" value="true"/>
                </create_order>
                <create_order id="'Wait'" object="$KroShip" default="true" comment="stay put"/>

                <!-- Rik's fleet move to defense station -->
                <!-- TODO: Escort Kro, instead of standalone move -->
                <do_all exact="$HopCorvettes.count" counter="$i">
                  <create_order object="$HopCorvettes.{$i}" id="'MoveWait'" name="$order" immediate="true">
                    <param name="destination" value="[$ParanidMonumentSector, $HolyOrderStagingPoint]"/>
                  </create_order>
                </do_all>
              </actions>
            </cue>

            <cue name="Ch6_Kro_ToMonument">
              <delay exact="30s" comment="Duke is flying for a bit, before he speaks to player)"/>
              <actions>
                <signal_cue cue="Ch6_Kro_ToMonument_Delay"/>
              </actions>
              <cues>
                <cue name="Ch6_Kro_ToMonument_Delay">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <cues>
                    <cue name="Ch6_Kro_ToMonument_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$Duke"/>
                      <param name="CutsceneKey"       value="$DukeCutsceneKey"/>
                      <param name="Lines"             value="[[30220601], [30220602], [30220603]]"/>
                      <param name="EndSignalCue"      value="null"/>
                      <!--
                            <text line="30220601" comment="The zenith of our efforts is nearly upon us."/>
                            <text line="30220602" comment="Rikmanckassor's cooperation certainly arrived at an opportune moment."/>
                            <text line="30220603" comment="But now we shall meet the legate of Priest Emperor Xaar in person."/>
                          -->
                    </cue>
                  </cues>
                </cue>
              </cues>
            </cue>

            <cue name="Ch6_Kro_Approach_Monument">
              <cues>
                <cue name="Ch6_Kro_Approach_Ref" ref="md.LIB_Generic.ApproachObject_Handler">
                  <param name="ApproachObject"    value="$KroShip"/>
                  <param name="ApproachTarget"    value="$ParanidMonument"/>
                  <param name="ApproachDistance"  value="10km"/>
                  <param name="SuccessSignalCue"  value="Ch6_Kro_Arrived"/>
                </cue>

                <cue name="Ch6_Kro_Arrived">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <debug_text text="'Kro arrived at monument'" chance="$DebugChance"/>
                  </actions>
                  <delay exact="1s" comment="Required to signal a child cue."/>
                  <actions>
                    <signal_cue cue="Ch6_Story_Reminder"/>
                  </actions>
                  <cues>
                    <cue name="Ch6_Story_Reminder">
                      <conditions>
                        <check_all>
                          <event_cue_signalled/>
                          <check_value value="Ch6_Player_Arrived.state == cuestate.waiting" comment="We have to check this, because the player might already be close to the Monument."/>
                        </check_all>
                      </conditions>
                      <cues>
                        <cue name="Ch6_Story_Reminder_Ref" ref="Story_Reminder">
                          <param name="Actor"       value="$DalBusta"/>
                          <param name="CutsceneKey" value="$DalCutsceneKey"/>
                          <param name="Lines"       value="[[if player.entity.isfemale then 30200002 else 30200001],[if player.entity.isfemale then 30220530 else 30220529]]"/>
                          <param name="CancelCue"   value="Ch6_Player_Arrived"/>
                          <param name="Delay"       value="20min"/>
                          <!--  <t id="30200001">Hey there partner.</t>
                                <t id="30200002">(spoken to female player){10111,30200001}</t>
                                <t id="30220529">I think our Paranid friend still expects you to accompany him during his negotiations.</t>
                                <t id="30220530">(spoken to female player 'you'){,30220529}</t>  -->
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Ch6_Player_Approach_Ref" ref="md.LIB_Generic.ApproachObject_Handler">
                      <param name="ApproachObject"    value="player.entity"/>
                      <param name="ApproachTarget"    value="$ParanidMonument"/>
                      <param name="ApproachDistance"  value="10km"/>
                      <param name="SuccessSignalCue"  value="Ch6_Player_Arrived"/>
                    </cue>

                    <cue name="Ch6_Player_Arrived">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <debug_text text="'Player near to Kro (both near paranid monument)'" chance="$DebugChance"/>
                        <signal_cue cue="Ch6_Kro_Monument_Cutscene"/>
                      </actions>
                    </cue>
                  </cues>
                </cue>
              </cues>
            </cue>

            <cue name="Ch6_Kro_Monument_Cutscene" comment="Duke arrives at monument">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <cues>
                <cue name="Ch6_Kro_Monument_Cutscene_Ref" ref="md.LIB_Dialog.Speak_Actor">
                  <param name="Actor"             value="$Duke"/>
                  <param name="CutsceneKey"       value="$DukeCutsceneKey"/>
                  <param name="Lines"             value="[[30220604], [if player.entity.isfemale then 30220606 else 30220605], [if player.entity.isfemale then 30220608 else 30220607], [30220609]]"/>
                  <param name="EndSignalCue"      value="Ch6_Kro_Monument_Find_Objective"/>
                  <!--
                    <text line="30220604" comment="We have decided to face these impossible odds alone."/>
                    <text line="if player.entity.isfemale then 30220606 else 30220605" comment="You shall act as an observer only, but be ready to intervene should we fail once again."/>
                    <text line="if player.entity.isfemale then 30220608 else 30220607" comment="Seek out our lieutenant."/>
                    <text line="30220609" comment="She will provide the necessary details."/>
                  -->
                </cue>

                <cue name="Ch6_Kro_Monument_Find_Objective">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <update_mission cue="$MissionCue" description="if player.entity.isfemale then {30220,6022} else {30220,6021}" comment="Explanation for current objective."/>
                    <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.talkto" object="$GrideActor" text="{30220,6010}" updatebriefing="true" comment="setting both Text AND object intentional!"/>

                    <signal_cue cue="Ch6_Kro_Monument_Final_Position"/>
                  </actions>
                </cue>

                <cue name="Ch6_Kro_Monument_Final_Position">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <!-- Move Kromancketslat and Rikmanckassor to their respective negotiations positions -->
                    <cancel_all_orders object="$KroShip"/>
                    <create_order object="$KroShip" id="'MoveWait'" default="true">
                      <param name="destination" value="[$ParanidMonumentSector, $MonumentBattlefield]"/>
                    </create_order>

                    <do_for_each in="$HopCorvettes" name="$CurrentShip">
                      <cancel_all_orders object="$CurrentShip"/>
                      <create_order object="$CurrentShip" id="'MoveWait'" default="true">
                        <param name="destination" value="[$ParanidMonumentSector, $HolyOrderStagingPoint]"/>
                      </create_order>
                    </do_for_each>
                  </actions>
                </cue>

              </cues>
            </cue>

            <cue name="Ch6_Monument_Gride" checkinterval="3s">
              <conditions>
                <check_value value="player.entity.distanceto.{$GrideShip} lt 250m"/>
              </conditions>
              <actions>
              </actions>
              <cues>
                <cue name="Ch6_Monument_DalGride_Cutscene">
                  <cues>
                    <cue name="Ch6_Monument_DalGride_Cutscene_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$DalBusta"/>
                      <param name="CutsceneKey"       value="$DalCutsceneKey"/>
                      <param name="Lines"             value="[[30220601], [if player.entity.isfemale then 30220603 else 30220602], [30220604]]"/>
                      <param name="EndSignalCue"      value="null"/>
                      <!--
                        <text line="30220601" comment="That ship is parked conveniently close to the monument."/>
                        <text line="if player.entity.isfemale then 30220603 else 30220602" comment="I wonder if you could sneak away after talking to the lieutenant." delay="1s"/>
                        <text line="30220604" comment="This might be our chance to finally solve that little mystery."/>
                      -->
                    </cue>
                  </cues>
                </cue>
              </cues>
            </cue>

            <cue name="Ch6_Monument_Gride_InPerson">
              <conditions>
                <event_object_changed_room object="player.entity" room="$GrideActor.room" comment="triggers first time player enters the room"/>
              </conditions>
              <actions>
                <speak actor="$DalBusta" priority="100">
                  <text line="30220605" comment="Oh no."/>
                </speak>
              </actions>
              <cues>
                <!-- Cutscene takes way too long to start, so we're having Dal speak without it for now. -->
                <cue name="Ch6_Monument_DalGride2_Cutscene">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <cues>
                    <cue name="Ch6_Monument_DalGride2_CutsceneSpeak_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$DalBusta"/>
                      <param name="CutsceneKey"       value="$DalCutsceneKey"/>
                      <param name="Lines"             value="[[30220605]]"/>
                      <param name="EndSignalCue"      value="null"/>
                      <!--
                        <text line="30220605" comment="Oh no."/>
                        <text line="30220606" comment="   I wasn't expecting that." delay="1s"/>
                      -->
                    </cue>
                  </cues>
                </cue>

                <cue name="Ch6_Monument_Gride_Talk">
                  <conditions>
                    <event_conversation_started actor="$GrideActor"/>
                  </conditions>
                  <actions>
                    <allow_conversation_escape enabled="false"/>
                    <add_npc_line line="if player.entity.isfemale then 30220602 else 30220601" hidechoices="true" comment="It's good to see you again, dear."/>
                    <add_npc_line line="if player.entity.isfemale then 30220604 else 30220603" hidechoices="true" comment="I trust my Duke already gave you an introduction to his... (slight pause before 'diplomatic')diplomatic effort?"/>
                    <add_npc_line line="30220605" hidechoices="true" comment="Well, we're about to... (slight pause before 'improve')improve that plan of his quite dramatically." delay="1s"/>
                    <add_player_choice text="{30220,6100}" section="c_explain" />
                  </actions>
                  <cues>
                    <cue name="Ch6_Monument_Gride_ConvStarted" instantiate="true">
                      <conditions>
                        <event_conversation_next_section actor="$GrideActor" section="c_explain" />
                      </conditions>
                      <actions>
                        <add_npc_line line="if player.entity.isfemale then 30220607 else 30220606" hidechoices="true" comment="You see, the countless years of isolation have clouded my Duke's ambition."/>
                        <add_npc_line line="30220608" hidechoices="true" comment="Even though his earlier attempts must have thrown the wretchedness of those unenlightened three-eyes into sharp relief..."/>
                        <add_npc_line line="30220609" hidechoices="true" comment="Even after all those sacrifices..."/>
                        <add_npc_line line="30220610" hidechoices="true" comment="He still refuses to rid himself of that poisonous illusion of (spit word 'peace')peace."/>
                        <add_npc_line line="if player.entity.isfemale then 30220612 else 30220611" hidechoices="true" comment="Will you help me show him the truth?"/>
                        <add_npc_line line="30220613" hidechoices="true" comment="We'll provide the flames from which my Duke will be reborn."/>
                      </actions>
                    </cue>

                    <cue name="Ch6_Monument_Gride_ConvEnding" instantiate="true">
                      <conditions>
                        <check_any>
                          <!--event_speak_finished actor="$GrideActor" line="30220613"/>
                          <event_speak_finished actor="$GrideActor" line="30220607"/-->
                          <event_speak_finished actor="$GrideActor" line="30220613"/>
                        </check_any>
                      </conditions>
                      <delay exact="2s"/>
                      <actions>
                        <cancel_conversation actor="$GrideActor"/>
                        <!-- instructions -->
                        <speak actor="$GrideActor" priority="100">
                          <text line="if player.entity.isfemale then 30220615 else 30220614" comment="You'll find a toolbox on the docking area."/>
                          <text line="if player.entity.isfemale then 30220617 else 30220616" comment="Its contents might prove useful to you."/>
                        </speak>
                        <signal_cue cue="Ch6_Preparation"/>
                      </actions>
                    </cue>
                  </cues>
                </cue>
              </cues>
            </cue>

            <cue name="Ch6_Preparation">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
              </actions>
              <cues>
                <cue name="Ch6_Monument_GrideToolbox">
                  <actions>
                    <!-- find dockingbays-->
                    <find_dockingbay name="$DockingBays" object="$GrideShip" checkoperational="true" multiple="true">
                      <match_any>
                        <match_dock size="tag.dock_m"/>
                        <match_dock size="tag.dock_s"/>
                      </match_any>
                    </find_dockingbay>
                    <!-- Find $CrateSlots in all $DockingBays-->
                    <create_list name="$CrateSlots"/>
                    <set_value name="$SelectedDockingBay" exact="$DockingBays.random"/>
                    <find_crate_slot name="$CrateSlots" object="$SelectedDockingBay" tags="tag.crate_s" multiple="true" />
                    <debug_text text="'Found #crateslots:' + $CrateSlots.count" chance="$DebugChance"/>
                    <!-- spawn crate on crateslot -->
                    <do_if value="$CrateSlots.count">
                      <create_crate name="$ToolboxCrate" macro="macro.crate_gen_s_01_macro" slot="$CrateSlots.random" />
                      <add_cargo object="$ToolboxCrate" ware="ware.bomb_player_limpet_mine_01_mk1" exact="5"/>
                      <!-- The player already needs and gets the launcher in an earlier mission, but if he somehow lost it, add it again. -->
                      <do_if value="not player.entity.inventory.{ware.weapon_gen_spacesuit_demolition_01_mk1}.count">
                        <add_cargo object="$ToolboxCrate" ware="ware.weapon_gen_spacesuit_demolition_01_mk1" exact="1" comment="guarantee player will be able to launch the spacesuit bombs"/>
                      </do_if>
                      <do_if value="not player.entity.inventory.{ware.weapon_gen_spacesuit_laser_02_mk1}.count">
                        <add_cargo object="$ToolboxCrate" ware="ware.weapon_gen_spacesuit_laser_02_mk1" exact="1" comment="Upgraded space suit laser. Better suited to shoot the monument door panels."/>
                      </do_if>
                    </do_if>
                    <set_value name="$ObjectiveStep" operation="add"/>
                    <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.find" text="{30220,6011}" updatebriefing="true"/>
                    <!--set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.find" object="$ToolboxCrate" text="{30220,6011}" updatebriefing="true"/-->
                  </actions>
                  <cues>

                    <cue name="Ch6_Monument_GrideToolbox_Hint" comment="too difficult to find? help out">
                      <delay exact="120s"/>
                      <actions>
                        <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.find" text="{30220,6011}" updatebriefing="false" object="$ToolboxCrate"/>
                      </actions>
                    </cue>

                    <cue name="Ch6_Monument_GrideToolbox_Pickup">
                      <conditions>
                        <event_player_opened_crate/>
                        <check_value value="event.param == $ToolboxCrate"/>
                      </conditions>
                      <actions>
                        <cancel_cue cue="Ch6_Monument_GrideToolbox_Hint"/>
                        <set_value name="$ObjectiveStep" operation="add"/>
                        <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.custom" customaction="{30220,6012}" updatebriefing="true"/>
                        <destroy_object object="$ToolboxCrate" comment="un-reserve slot"/>
                        <signal_cue cue="Ch6_Monument_GrideInstructions_Cutscene"/>
                      </actions>
                    </cue>

                    <cue name="Ch6_Monument_GrideToolbox_Pickup_DEBUG">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.find" object="$ToolboxCrate" text="{30220,6011}" updatebriefing="false"/>
                      </actions>
                    </cue>

                  </cues>
                </cue>

                <cue name="Ch6_Monument_GrideInstructions_Cutscene">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <cues>
                    <cue name="Ch6_Monument_GrideInstructions_Cutscene_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$GrideActor"/>
                      <param name="CutsceneKey"       value="$GrideCutsceneKey"/>
                      <param name="Lines"             value="[[if player.entity.isfemale then 30220619 else 30220618], [if player.entity.isfemale then 30220621 else 30220620], [30220622, 0.5s], [30220623],
                                                              [if player.entity.isfemale then 30220625 else 30220624, 0.5s], [if player.entity.isfemale then 30220627 else 30220626]]"/>
                      <param name="EndSignalCue"      value="Ch6_Spacesuit_Use"/>
                      <!--
                        <text line="if player.entity.isfemale then 30220619 else 30220618" comment="Remember the cipher you went and got for me?"/>
                        <text line="if player.entity.isfemale then 30220621 else 30220620" comment="With the help of that, the monument's gates should open for you." delay="1s"/>
                        <text line="30220622" comment="And as for the other items..."/>
                        <text line="30220623" comment="This structure must surely contain a few points which are quite...(slight pause before 'vital')vital to its integrity."/>
                        <text line="if player.entity.isfemale then 30220625 else 30220624" comment="I trust you will know what to do, once you come across them."/>
                        <text line="if player.entity.isfemale then 30220627 else 30220626" comment="Return to me when you're done, so that we can enjoy the spectacle together."/>
                      -->
                    </cue>
                  </cues>
                </cue>

                <cue name="Ch6_Spacesuit_Use">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <set_value name="$ObjectiveStep" operation="add"/>
                    <update_mission cue="$MissionCue" description="(if player.entity.isfemale then {30220,6024} else {30220,6023})
                                                        + '\n\n' + {30220,6040}" comment="Explanation for current objective plus hint for the mechanisms the player has to shoot." icon="'briefing_gride_orrian_01'" iconcaption="$GrideActor.name"/>
                    <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.usespacesuit" updatebriefing="true" comment="Use spacesuit"/>

                    <!-- Progress immediately if player is already in spacesuit. -->
                    <do_if value="@player.controlled.isclass.spacesuit">
                      <cancel_cue cue="Ch6_Spacesuit_Using"/>
                      <signal_cue cue="Ch6_TheMonument"/>
                    </do_if>
                  </actions>
                  <cues>
                    <cue name="Ch6_Spacesuit_Using">
                      <conditions>
                        <event_player_teleport_successful/>
                        <check_value value="@player.controlled.isclass.spacesuit"/>
                      </conditions>
                      <actions>
                        <signal_cue cue="Ch6_TheMonument"/>
                      </actions>
                    </cue>
                  </cues>
                </cue>

              </cues>
            </cue>

            <cue name="Ch6_TheMonument" version="2">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <!-- find locations -->
                <find_object_component name="$ParanidMonumentRepairList" object="$ParanidMonument" macro="macro.interactive_par_doorcontrol_01_macro" multiple="true"/>
                <add_to_group groupname="$ParanidMonumentRepair" list="$ParanidMonumentRepairList"/>
                <find_object_component name="$ParanidMonumentCocoonDoor" object="$ParanidMonument" macro="macro.positiondummy5_macro" multiple="false" required="true"/>
                <find_object_component name="$ParanidMonumentEntranceWindow" object="$ParanidMonument" macro="macro.positiondummy4_macro" multiple="false" required="true"/>
                <find_object_component name="$ParanidMonumentEntranceDoors" object="$ParanidMonument" macro="macro.positiondummy1_macro" multiple="false" required="true"/>
                <find_object_component name="$ParanidMonumentEntranceHallway" object="$ParanidMonument" macro="macro.positiondummy2_macro" multiple="false" required="true"/>
                <find_object_component name="$ParanidMonumentCocoonRoom" object="$ParanidMonument" macro="macro.positiondummy3_macro" multiple="false" required="true"/>
                <find_object_component name="$ParanidMonumentCore1" object="$ParanidMonument" macro="macro.landmarks_par_monument_core_01_macro" required="true" />
                <find_object_component name="$ParanidMonumentCore2" object="$ParanidMonument" macro="macro.landmarks_par_monument_core_02_macro" required="true" />

                <!-- find clamps holding elder-cocoons-->
                <set_value name="this.$InteractionSlots" exact="[tag.interactionspot_1, tag.interactionspot_2, tag.interactionspot_3, tag.interactionspot_4, tag.interactionspot_5]"/>
                <do_all exact="this.$InteractionSlots.count" counter="$i">
                  <find_object_component groupname="$ParanidMonumentClampsGroup" object="$ParanidMonument" macro="macro.landmarks_par_monument_clamp_01_macro" multiple="true" grouptag="this.$InteractionSlots.{$i}" required="true" recursive="true" append="true"/>
                </do_all>

                <!-- remember state-->
                <create_group groupname="$PlayerBombs"/>
                <set_value name="$ParanidMonumentCocoons" exact="false"/>
                <set_value name="$ParanidMonumentCore1Bomb" exact="false"/>
                <set_value name="$ParanidMonumentCore2Bomb" exact="false"/>

                <!-- update mission objective-->
                <set_value name="$ObjectiveStep" operation="add"/>
                <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.custom" customaction="{30220,6014}" object="$ParanidMonumentEntranceHallway" updatebriefing="true" comment="Enter Paranid Monument (hallway is a bit further inside than $ParanidMonumentEntranceDoors)"/>

              </actions>
              <patch sinceversion="2">
                <find_object_component name="$ParanidMonumentCocoonDoor" object="$ParanidMonument" macro="macro.positiondummy5_macro" multiple="false" required="true"/>
              </patch>
              <cues>

                <cue name="Ch6_LowOxygen" checkinterval="15s" instantiate="true">
                  <conditions>
                    <check_value value="player.spacesuit"/>
                  </conditions>
                  <actions>
                    <do_if value="$oxygenlow?">
                      <do_if value="(not $oxygenlow) and (player.spacesuit.oxygenlow)">
                        <signal_cue cue="Ch6_LowOxygen_Dialog"/>
                      </do_if>
                    </do_if>
                    <set_value name="$oxygenlow" exact="player.spacesuit.oxygenlow"/>
                  </actions>
                </cue>

                <cue name="Ch6_LowOxygen_Dialog" instantiate="true">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <cues>
                    <cue name="Ch6_LowOxygen_Dialog_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$BosoTa"/>
                      <param name="CutsceneKey"       value="$BosoCutsceneKey"/>
                      <param name="Lines"             value="[[30402025]]"/>
                      <param name="EndSignalCue"      value="null"/>
                      <!--
                        <t id="30402025">I suggest that you return swiftly to your ship, before you run out of oxygen.</t>
                      -->
                    </cue>
                  </cues>
                </cue>

                <cue name="Ch6_TheMonument_Dal_Cutscene">
                  <delay exact="3s"/>
                  <cues>
                    <cue name="Ch6_TheMonument_Dal_CutsceneSpeak_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$DalBusta"/>
                      <param name="CutsceneKey"       value="$DalCutsceneKey"/>
                      <param name="Lines"             value="[[30220607], [30220610], [30220611], [30220612], [30220613,1s], [30220614], [30220615], [30220616,1s], [30220617] ]"/>
                      <param name="EndSignalCue"      value="null"/>
                      <!--
                        <text line="30220607" comment="Well, that was unexpected."/>
                        <text line="30220608" comment="  I haven't seen that side of her in a while."/>
                        <text line="30220609" comment="  She's still chasing that old pirate dream of hers."/>
                        <text line="30220610" comment="She does have a valid point, though."/>
                        <text line="30220611" comment="How realistic is this prospect of peace, really?"/>
                        <text line="30220612" comment="Wouldn't there be much more to be gained by letting the war continue?"/>
                        <text line="30220613" comment="I also am slightly worried about that Kromancketslat character... or the Duke, whatever that's supposed to mean."/>
                        <text line="30220614" comment="He's a bit of an oddball, that one."/>
                        <text line="30220615" comment="So very fatalistic, even for a Paranid."/>
                        <text line="30220616" comment="This whole situation might escalate out of control if we pull the carpet out from under his feet."/>
                        <text line="30220617" comment="If these peace talks were to continue indefinitely, at least we'd know what he'll be doing for a while."/>
                        <text line="   if player.entity.isfemale then 30220619 else 30220618" comment="But the choice is yours, and we'll cross that bridge once we come to it."/>
                      -->
                    </cue>
                  </cues>
                </cue>

                <cue name="Ch6_Monument_Doors">
                  <actions>
                    <find_object_component name="$ParanidMonumentCenter" object="$ParanidMonument" macro="macro.landmarks_par_monument_center_01_macro" required="true"/>
                    <set_value name="$ParanidMonumentDoorsOpen" exact="false"/>
                    <set_value name="$ParanidMonumentWindowsOpen" exact="false"/>
                  </actions>
                  <cues>
                    <cue name="Ch6_Monument_OpenDoors" checkinterval="1s" instantiate="true">
                      <conditions>
                        <check_value value="(player.sector == $ParanidMonument.sector) and (player.entity.distanceto.{$ParanidMonumentEntranceDoors} lt 120m)"/>
                        <check_value value="not $ParanidMonumentDoorsOpen"/>
                      </conditions>
                      <actions>
                        <set_value name="$ParanidMonumentDoorsOpen" exact="true"/>
                        <trigger_animation object="$ParanidMonumentCenter" trigger="open_doors" />
                      </actions>
                    </cue>
                    <cue name="Ch6_Monument_CloseDoors" checkinterval="1s" instantiate="true">
                      <conditions>
                        <check_value value="(player.sector == $ParanidMonument.sector) and (player.entity.distanceto.{$ParanidMonumentEntranceDoors} ge 120m)"/>
                        <check_value value="$ParanidMonumentDoorsOpen"/>
                      </conditions>
                      <actions>
                        <set_value name="$ParanidMonumentDoorsOpen" exact="false"/>
                        <trigger_animation object="$ParanidMonumentCenter" trigger="close_doors"/>
                      </actions>
                    </cue>
                    <cue name="Ch6_Monument_OpenWindows" checkinterval="1s" instantiate="true">
                      <conditions>
                        <check_value value="(player.sector == $ParanidMonument.sector) and (player.entity.distanceto.{$ParanidMonumentEntranceWindow} lt 100m)"/>
                        <check_value value="not $ParanidMonumentWindowsOpen"/>
                      </conditions>
                      <actions>
                        <set_value name="$ParanidMonumentWindowsOpen" exact="true"/>
                        <trigger_animation object="$ParanidMonumentCenter" trigger="open_doors2" />
                      </actions>
                    </cue>
                    <cue name="Ch6_Monument_CloseWindows" checkinterval="1s" instantiate="true">
                      <conditions>
                        <check_value value="(player.sector == $ParanidMonument.sector) and (player.entity.distanceto.{$ParanidMonumentEntranceWindow} ge 100m)"/>
                        <check_value value="$ParanidMonumentWindowsOpen"/>
                      </conditions>
                      <actions>
                        <set_value name="$ParanidMonumentWindowsOpen" exact="false"/>
                        <trigger_animation object="$ParanidMonumentCenter" trigger="close_doors2"/>
                      </actions>
                    </cue>
                  </cues>
                </cue>

                <cue name="Ch6_Monument_EntranceHallway">
                  <actions>
                  </actions>
                  <cues>
                    <cue name="Ch6_Monument_Entrance_Nearby" checkinterval="1s">
                      <conditions>
                        <check_value value="player.entity.distanceto.{$ParanidMonumentEntranceHallway} lt 50m"/>
                      </conditions>
                      <actions>
                        <set_value name="$ObjectiveStep" operation="add"/>
                        <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.custom" customaction="{30220,6015}" updatebriefing="true" comment="Navigate maze"/>
                      </actions>
                      <cues>
                        <cue name="Ch6_EnterMonument_Cutscene">
                          <cues>
                            <cue name="Ch6_EnterMonument_Cutscene_Ref" ref="md.LIB_Dialog.Speak_Actor">
                              <param name="Actor"             value="$DalBusta"/>
                              <param name="CutsceneKey"       value="$DalCutsceneKey"/>
                              <param name="Lines"             value="[[if player.entity.isfemale then 30220621 else 30220620], [if player.entity.isfemale then 30220623 else 30220622], [if player.entity.isfemale then 30220627 else 30220626,1s], [if player.entity.isfemale then 30220625 else 30220624, 1s]]"/>
                              <param name="EndSignalCue"      value="null"/>
                              <!--
                                <text line="if player.entity.isfemale then 30220621 else 30220620" comment="Boso and I are having difficulties pinpointing your position in that maze."/>
                                <text line="if player.entity.isfemale then 30220623 else 30220622" comment="We can't get a visual on you either."/>
                                <text line="if player.entity.isfemale then 30220627 else 30220626" comment="All we know is that the cocoons are in a chamber, somewhere above the entrance you just came through."/>
                                <text line="if player.entity.isfemale then 30220625 else 30220624" comment="From here on, you're on your own."/>
                              -->
                            </cue>
                          </cues>
                        </cue>
                      </cues>
                    </cue>
                  </cues>
                </cue>

                <cue name="Ch6_Monument_Cores" comment="info when near one of the 2 cores">
                  <actions>
                  </actions>
                  <cues>
                    <cue name="Ch6_Monument_Core_Near" checkinterval="1s">
                      <conditions>
                        <check_any >
                          <check_value value="player.entity.distanceto.{$ParanidMonumentCore1} lt 50m"/>
                          <check_value value="player.entity.distanceto.{$ParanidMonumentCore2} lt 50m"/>
                        </check_any>
                      </conditions>
                      <cues>
                        <cue name="Ch6_Monument_Cores_Cutscene_Ref" ref="md.LIB_Dialog.Speak_Actors">
                          <param name="Actor"             value="[$BosoTa, $DalBusta]"/>
                          <param name="CutsceneKey"       value="[$BosoCutsceneKey, $DalCutsceneKey]"/>
                          <param name="Lines"             value="[[[if player.entity.isfemale then 30220606 else 30220605]],
                                                                  [[30220632], [if player.entity.isfemale then 30220634 else 30220633], [if player.entity.isfemale then 30220636 else 30220635] ]]"/>
                          <param name="EndSignalCue"      value="[null, null]"/>
                          <!--           
                            <text line="if player.entity.isfemale then 30220606 else 30220605" comment="I'm picking up some unusually strong heat signals from your suit's sensors."/>
                            <text line="30220632" comment="That must be the structural weak point Gride was on about."/>
                            <text line="if player.entity.isfemale then 30220634 else 30220633" comment="Keep going for now."/>
                            <text line="if player.entity.isfemale then 30220636 else 30220635" comment="That'll give you some more time to think about what you want to do."/>
                          -->
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Ch6_Monument_CoreDamaged" comment="Cores cannot be damaged while their shielding is up">
                      <conditions>
                        <check_any>
                          <event_object_destroyed object="$ParanidMonumentCore1"/>
                          <event_object_destroyed object="$ParanidMonumentCore2"/>
                        </check_any>
                      </conditions>
                      <actions>
                        <debug_text text="'Player blew up Core while inside'" chance="$DebugChance"/>
                        <destroy_object object="player.ship" explosion="true"/>
                      </actions>
                    </cue>

                    <cue name="Ch6_Monument_AttachedBombCore" instantiate="true" comment="Bombs placed on cores">
                      <conditions>
                        <check_any>
                          <event_object_bomb_attached object="$ParanidMonumentCore1"/>
                          <event_object_bomb_attached object="$ParanidMonumentCore2"/>
                        </check_any>
                      </conditions>
                      <actions>
                        <debug_text text="'Attached to Core: ' + event.param.parent.name" chance="$DebugChance"/>
                        <add_to_group groupname="$PlayerBombs" object="event.param"/>
                        <do_if value="event.param.parent == $ParanidMonumentCore1">
                          <set_value name="$ParanidMonumentCore1Bomb" exact="true"/>
                        </do_if>
                        <do_elseif value="event.param.parent == $ParanidMonumentCore2">
                          <set_value name="$ParanidMonumentCore2Bomb" exact="true"/>
                        </do_elseif>
                        <do_if value="$ParanidMonumentCore1Bomb and $ParanidMonumentCore2Bomb">
                          <cancel_cue cue="Ch6_Monument_Attached_BombOther"/>
                          <signal_cue cue="Ch6_Monument_Rigged_Dal_Cutscene"/>
                        </do_if>
                      </actions>
                    </cue>

                    <cue name="Ch6_Monument_DetachedBomb" instantiate="true" comment="Bombs placed on cores">
                      <conditions>
                        <check_any>
                          <event_object_destroyed group="$PlayerBombs" method="killmethod.detached" comment="detached (changed into container)"/>
                        </check_any>
                      </conditions>
                      <actions>
                        <debug_text text="'Detached from Core, object=' + event.object" chance="$DebugChance"/>
                        <!-- bomb is not auto-removed from group until after this call, remove it manually now -->
                        <remove_from_group group="$PlayerBombs" object="event.object"/>
                        <!-- a bomb was detached, re-evaluate if any bombs are still attached to each core -->
                        <set_value name="$ParanidMonumentCore1Bomb" exact="false"/>
                        <set_value name="$ParanidMonumentCore2Bomb" exact="false"/>
                        <do_all exact="$PlayerBombs.count" counter="$i">
                          <do_if value="$PlayerBombs.{$i}.parent == $ParanidMonumentCore1">
                            <set_value name="$ParanidMonumentCore1Bomb" exact="true"/>
                          </do_if>
                          <do_elseif value="$PlayerBombs.{$i}.parent == $ParanidMonumentCore2">
                            <set_value name="$ParanidMonumentCore2Bomb" exact="true"/>
                          </do_elseif>
                        </do_all>
                        <do_if value="(not $ParanidMonumentCore1Bomb) and (not $ParanidMonumentCore2Bomb)" comment="BOTH unrigged?">
                          <signal_cue cue="Ch6_Monument_UnRigged_Dal_Cutscene"/>
                        </do_if>
                        <do_elseif value="($ParanidMonumentCore1Bomb and not $ParanidMonumentCore2Bomb) or ($ParanidMonumentCore2Bomb and not $ParanidMonumentCore1Bomb)">
                          <signal_cue cue="Ch6_Monument_UnRigged_Boso_Cutscene"/>
                        </do_elseif>
                      </actions>
                    </cue>


                    <cue name="Ch6_Monument_Attached_BombOther">
                      <conditions>
                        <event_player_bomb_attached/>
                        <check_value value="event.param.macro != macro.bomb_player_limpet_mine_01_mk1_macro"/>
                        <check_any>
                          <check_value value="event.param.parent == $ParanidMonumentCore1"/>
                          <check_value value="event.param.parent == $ParanidMonumentCore2"/>
                        </check_any>
                      </conditions>
                      <cues>
                        <cue name="Ch6_Speak_Boso_BombHint_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor" value="$BosoTa"/>
                          <param name="CutsceneKey" value="$BosoCutsceneKey"/>
                          <param name="Lines" value="[[if player.entity.isfemale then 30200005 else 30200004], [30200007, 1s]]"/>
                          <param name="EndSignalCue"      value="Ch6_Monument_Attached_BombOther_Delay"/>
                          <!--
                          <t id="30200004">The ordnance you are using does not appear to be particularly suitable for the job.</t>
                          <t id="30200005">(spoken to female player 'you'){,30200004}</t>
                          <t id="30200007">I recommend switching to explosive charges.</t>
                          -->
                        </cue>
                        <cue name="Ch6_Monument_Attached_BombOther_Delay">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <delay exact="20s"/>
                          <actions>
                            <reset_cue cue="Ch6_Monument_Attached_BombOther"/>
                          </actions>
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Ch6_Monument_Rigged_Dal_Cutscene" instantiate="true">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <cues>
                        <cue name="Ch6_Monument_Rigged_Dal_Cutscene_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$DalBusta"/>
                          <param name="CutsceneKey"       value="$DalCutsceneKey"/>
                          <param name="Lines"             value="[[30220682], [if player.entity.isfemale then 30220684 else 30220683]]"/>
                          <param name="EndSignalCue"      value="null"/>
                          <!--
                            <text line="30220682" comment="Both weak points are now rigged to blow."/>
                            <text line="if player.entity.isfemale then 30220684 else 30220683" comment="Get out and get clear."/>
                          -->
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Ch6_Monument_UnRigged_Dal_Cutscene" instantiate="true">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <debug_text text="'Cores Unrigged'" chance="$DebugChance"/>
                      </actions>
                      <cues>
                        <cue name="Ch6_Monument_UnRigged_Dal_Cutscene_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$DalBusta"/>
                          <param name="CutsceneKey"       value="$DalCutsceneKey"/>
                          <param name="Lines"             value="[[30220686], [if player.entity.isfemale then 30220684 else 30220683]]"/>
                          <param name="EndSignalCue"      value="null"/>
                          <!--
                            <text line="30220686" comment="Both weak points are again cleared of explosives."/>
                            <text line="if player.entity.isfemale then 30220684 else 30220683" comment="Get out and get clear."/>
                          -->
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Ch6_Monument_UnRigged_Boso_Cutscene" instantiate="true">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <debug_text text="'One core unrigged, but another remains rigged.'" chance="$DebugChance"/>
                      </actions>
                      <cues>
                        <cue name="Ch6_Monument_UnRigged_Boso_Cutscene_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$BosoTa"/>
                          <param name="CutsceneKey"       value="$BosoCutsceneKey"/>
                          <param name="Lines"             value="[[30220612]]"/>
                          <param name="EndSignalCue"      value="null"/>
                          <!--
                            A most commendable choice, but I am afraid that the other energy core still remains stricken with explosives.
                          -->
                        </cue>
                      </cues>
                    </cue>

                  </cues>
                </cue>

                <cue name="Ch6_Monument_RepairPanel_DEBUG">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <do_all exact="$ParanidMonumentRepair.count" counter="$i">
                      <set_object_hull object="$ParanidMonumentRepair.{$i}" exact="100" comment="fully repaired"/>
                    </do_all>
                    <clear_group group="$ParanidMonumentRepair"/>
                  </actions>
                </cue>

                <cue name="Ch6_Monument_RepairedPanel" instantiate="true">
                  <conditions>
                    <!--<event_object_hull_repaired group="$ParanidMonumentRepair" comment="9 initially (2 for opening the cores)"/>-->
                    <event_object_hull_below_function_threshold group="$ParanidMonumentRepair"/>
                  </conditions>
                  <actions>
                    <!-- 9 Broken controls in total
                      9 - 5 = opening doors in the maze (which opens cocoon room)
                      4 & 3 = cocoon room, open "locker" for 2 cores
                      2 & 1 = trigger 2 core lockers (opens doors to the cores -> these were disabled!)
                    -->
                    <debug_text text="'OnRepair: ' + $ParanidMonumentRepair.count" chance="$DebugChance"/>
                    <!-- door repairleak, this block guaranteed first before last 4 -->
                    <do_if value="$ParanidMonumentRepair.count == 9">
                      <signal_cue cue="Ch6_Monument_RepairedPanel5_Cutscene" comment="negotiations chatter"/>
                    </do_if>
                    <do_elseif value="$ParanidMonumentRepair.count == 8">
                      <signal_cue cue="Ch6_Monument_RepairedPanel4_Cutscene" comment="negotiations chatter"/>
                    </do_elseif>
                    <do_elseif value="$ParanidMonumentRepair.count == 7">
                      <signal_cue cue="Ch6_Monument_RepairedPanel3_Cutscene" comment="negotiations chatter"/>
                    </do_elseif>
                    <do_elseif value="$ParanidMonumentRepair.count == 6">
                      <signal_cue cue="Ch6_Monument_RepairedPanel2_Cutscene" comment="negotiations chatter"/>
                    </do_elseif>
                    <do_elseif value="$ParanidMonumentRepair.count == 5">
                      <signal_cue cue="Ch6_Monument_CocoonDoor_Cutscene" comment="First plays door-cutscene, continues with Ch6_Monument_Balance_Cutscene with Dal suggesting 'Perfect Geometry'"/>
                      <set_value name="$ObjectiveStep" operation="add"/>
                    </do_elseif>
                    <!-- 2x trigger in the cocoon room & 2x open-core trigger, note that the order of what player triggers is NOT guaranteed! -->
                    <do_elseif value="$ParanidMonumentRepair.count == 4" comment="cocoon-leak (guaranteed)">
                      <signal_cue cue="Ch6_Monument_RepairedPanelCore2_Cutscene" comment="show cores"/>
                    </do_elseif>
                    <do_elseif value="$ParanidMonumentRepair.count == 3" comment="cocoon or core-leak">
                      <debug_text text="'Show cores'"/>
                      <signal_cue cue="Ch6_Monument_RepairedPanelCore_Cutscene" comment="show cores"/>
                    </do_elseif>
                    <!--do_elseif value="$ParanidMonumentRepair.count == 2" comment="cocoon or core-leak">
                    </do_elseif>
                    <do_elseif value="$ParanidMonumentRepair.count == 1" comment="cocoon or core-leak">
                    </do_elseif-->
                    <remove_from_group group="$ParanidMonumentRepair" object="event.param"/>
                  </actions>
                </cue>

                <cue name="Ch6_Monument_RepairPanel_Cutscenes">
                  <cues>

                    <cue name="Ch6_Monument_RepairedPanelCore_Cutscene">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <play_cutscene key="'Story_Paranid_Monument_Core'" targetmonitor="false" result="this.$CutsceneID" abortable="false">
                          <param name="core1" object="$ParanidMonumentCore1" />
                          <param name="core2" object="$ParanidMonumentCore2" />
                        </play_cutscene>
                      </actions>
                    </cue>

                    <cue name="Ch6_Monument_RepairedPanelCore2_Cutscene">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <play_cutscene key="'Story_Paranid_Monument_Core'" targetmonitor="false" result="this.$CutsceneID" abortable="false">
                          <param name="core1" object="$ParanidMonumentCore2" />
                          <param name="core2" object="$ParanidMonumentCore1" />
                        </play_cutscene>
                      </actions>
                    </cue>


                    <cue name="Ch6_Monument_CocoonDoor_Cutscene">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <play_cutscene key="'Story_Paranid_Monument_Door'" targetmonitor="false" result="this.$CutsceneID" abortable="false">
                          <param name="door" object="$ParanidMonumentCocoonDoor" />
                        </play_cutscene>
                        <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.explore" text="{30220,6013}" updatebriefing="true"/>
                      </actions>
                      <delay exact="10s"/>
                      <actions>
                        <signal_cue cue="Ch6_Monument_Balance_Cutscene"/>
                      </actions>
                    </cue>

                    <cue name="Ch6_Monument_Balance_Cutscene">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <cues>

                        <cue name="Ch6_Monument_Balance_Cutscene_Ref" ref="md.LIB_Dialog.Speak_Actors">
                          <param name="Actor"             value="[$DalBusta, $BosoTa, $DalBusta, $BosoTa]"/>
                          <param name="CutsceneKey"       value="[$DalCutsceneKey, $BosoCutsceneKey, $DalCutsceneKey, $BosoCutsceneKey]"/>
                          <param name="Lines"             value="[[[if player.entity.isfemale then 30220642 else 30220641], [30220644, 0.5s], [30220643, 0.5s], [if player.entity.isfemale then 30220646 else 30220645], [if player.entity.isfemale then 30220648 else 30220647, 0.5s], [30220650] ],
                                                                  [[30220607]],
                                                                  [[30220651]],
                                                                  [[30220608]]
                                                                  ]"/>
                          <param name="EndSignalCue"      value="[null, null, null, null]"/>
                          <!--           
                            <text line="if player.entity.isfemale then 30220642 else 30220641" comment="Forget what I sead earlier about creating an imbalance for this side or that."/>
                            <text line="30220644" comment="This is our chance to end this war once and for all."/>
                            <text line="30220643" comment="They want perfect geometry? They'll get it!"/>
                            <text line="if player.entity.isfemale then 30220646 else 30220645" comment="All you need to do is to go in there and nominate a few candidates... (slight pause before 'for')for Third Pontifex."/>
                            <text line="if player.entity.isfemale then 30220648 else 30220647" comment="Imagine that!"/>
                            <text line="30220649" comment="   A Pontifex under our control!"/>
                            <text line="30220650" comment="And Boso Ta would certainly jump at the opportunity to research how those cocoons are hatched."/>
                            boso
                            <text line="30220607" comment="You would drag these poor, defenseless souls into your plan to manipulate an entire people?"/>
                            dal
                            <text line="30220651" comment="Think about it! This will lead to unprecedented scientific insight."/>
                            boso
                            <text line="30220608" comment="You are cruel and delusional."/>
                          -->
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Ch6_Monument_RepairedPanel5_Cutscene">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <delay exact="2s"/>
                      <actions>
                        <signal_cue cue="Ch6_Monument_RepairedPanel5a_Cutscene_Delay"/>
                      </actions>
                      <cues>
                        <cue name="Ch6_Monument_RepairedPanel5a_Cutscene_Delay">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <cues>
                            <cue name="Ch6_Monument_RepairedPanel5a_Cutscene_Ref" ref="md.LIB_Dialog.Speak_Actor">
                              <param name="Actor"             value="$DalBusta"/>
                              <param name="CutsceneKey"       value="$DalCutsceneKey"/>
                              <param name="Lines"             value="[[30220637], [if player.entity.isfemale then 30220639 else 30220638]]"/>
                              <param name="EndSignalCue"      value="Ch6_Monument_RepairedPanel5b_Speak"/>
                              <!--
                                <text line="30220637" comment="Ha!"/>
                                <text line="" comment="I've managed to tune into the negotiations, in case you want to listen in while doing your work."/>
                              -->
                            </cue>
                          </cues>
                        </cue>
                        <cue name="Ch6_Monument_RepairedPanel5b_Speak">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <delay exact="2s"/>
                          <actions>
                            <speak actor="$Duke" priority="100">
                              <text line="30220610" comment="Enlightened beings, these words are for you alone."/>
                            </speak>
                          </actions>
                        </cue>
                        <cue name="Ch6_Monument_RepairedPanel5c_Cutscene">
                          <conditions>
                            <event_speak_finished actor="$Duke" line="30220610"/>
                          </conditions>
                          <cues>
                            <cue name="Ch6_Monument_RepairedPanel5c_Cutscene_Ref" ref="md.LIB_Dialog.Speak_Actor">
                              <param name="Actor"               value="$DalBusta"/>
                              <param name="CutsceneKey"         value="$DalCutsceneKey"/>
                              <param name="DelayInitial"        value="0.1s"/>
                              <param name="DelayStartCutscene"  value="0.1s" />
                              <param name="DelayEndCutscene"    value="0.1s" />
                              <param name="Lines"               value="[[30220640]]"/>
                              <param name="EndSignalCue"        value="Ch6_Monument_RepairedPanel5d_Speak"/>
                              <!--
                                <text line="30220640" comment="(whispers)That's what he thinks."/>
                              -->
                            </cue>
                          </cues>
                        </cue>
                        <cue name="Ch6_Monument_RepairedPanel5d_Speak">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <delay exact="2s"/>
                          <actions>
                            <speak actor="$Duke" priority="100">
                              <text line="30220611" comment="We are gathered here, on this momentuous occasion, to discuss a matter of the utmost gravity(importance not pull towards a mass)."/>
                              <text line="30220612" comment="Xatenmanckett, honoured and ordained legate of Priest Emperor Xaar, your presence gleams like a ray of holy light in this abyss of discord."/>
                            </speak>
                          </actions>
                        </cue>
                        <cue name="Ch6_Monument_RepairedPanel5e_Speak">
                          <conditions>
                            <event_speak_finished actor="$Duke" line="30220611"/>
                          </conditions>
                          <delay exact="1s"/>
                          <actions>
                            <speak actor="$RikActor" priority="100">
                              <text line="30220601" comment="The false Pontifex must have grown desperate to have sent his advisors right into the claws of his enemies..."/>
                            </speak>
                          </actions>
                        </cue>
                        <cue name="Ch6_Monument_RepairedPanel5f_Speak">
                          <conditions>
                            <event_speak_finished actor="$RikActor" line="30220601"/>
                          </conditions>
                          <actions>
                            <speak actor="$Duke" priority="100">
                              <text line="30220613" comment="(strictly)Priest Guardian Rikmanckassor!"/>
                              <text line="30220614" comment="This was declared hallowed ground long before these unfortunate quarrels." delay="1s"/>
                            </speak>
                          </actions>
                        </cue>
                        <cue name="Ch6_Monument_RepairedPanel5g_Speak">
                          <conditions>
                            <event_speak_finished actor="$Duke" line="30220613"/>
                          </conditions>
                          <delay exact="1s"/>
                          <actions>
                            <speak actor="$RikActor" priority="100">
                              <text line="30220602" comment="(defiantly)And yet, the claim of our righteous and true Pontifex remains unchallenged."/>
                            </speak>
                          </actions>
                        </cue>
                        <cue name="Ch6_Monument_RepairedPanel5h_Speak">
                          <conditions>
                            <event_speak_finished actor="$RikActor" line="30220602"/>
                          </conditions>
                          <delay exact="1s"/>
                          <actions>
                            <speak actor="$XatActor" priority="100">
                              <text line="30220601" comment="(choleric)Heresy! The wrath of Xaar should tear you to pieces at this very moment!"/>
                            </speak>
                          </actions>
                        </cue>
                        <cue name="Ch6_Monument_RepairedPanel5_Speaks_Finished">
                          <conditions>
                            <event_speak_finished actor="$XatActor" line="30220601"/>
                          </conditions>
                          <actions>
                            <debug_text text="'Negotiations chatter 1 finished.'" chance="$DebugChance"/>
                          </actions>
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Ch6_Monument_RepairedPanel4_Cutscene">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <cues>
                        <cue name="Ch6_Monument_RepairedPanel4_Queue" checkinterval="1s">
                          <conditions>
                            <check_value value="Ch6_Monument_RepairedPanel5_Speaks_Finished.state == cuestate.complete"/>
                          </conditions>
                          <actions>
                            <signal_cue cue="Ch6_Monument_RepairedPanel4a_Speak"/>
                          </actions>
                        </cue>
                        <cue name="Ch6_Monument_RepairedPanel4a_Speak">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <delay exact="3s"/>
                          <actions>
                            <speak actor="$Duke" priority="100">
                              <text line="30220615" comment="Brethren!"/>
                              <text line="30220616" comment="Without question, the blinding truth must, by now, have found its way into your inqusitive minds." delay="1s"/>
                              <text line="30220617" comment="The Paranid realms are beset on all sides by unholy creatures who know nothing but senseless destruction." delay="0.5s"/>
                            </speak>
                          </actions>
                        </cue>
                        <cue name="Ch6_Monument_RepairedPanel4b_Speak">
                          <conditions>
                            <event_speak_finished actor="$Duke" line="30220615"/>
                          </conditions>
                          <delay exact="1s"/>
                          <actions>
                            <speak actor="$RikActor" priority="100">
                              <text line="30220603" comment="There is truth in the prophet's words."/>
                              <text line="30220604" comment="United, we could crush the enemies of the Paranid!"/>
                            </speak>
                          </actions>
                        </cue>
                        <cue name="Ch6_Monument_RepairedPanel4e_Speak">
                          <conditions>
                            <event_speak_finished actor="$RikActor" line="30220603"/>
                          </conditions>
                          <delay exact="1s"/>
                          <actions>
                            <speak actor="$XatActor" priority="100">
                              <text line="30220602" comment="Nonsense!"/>
                              <text line="30220603" comment="Our worst enemies stand right before us!" delay="2s"/>
                              <text line="30220604" comment="You defile the teachings of Bashra with your flagrant disregard for the sacred geometry!" delay="1s"/>
                            </speak>
                          </actions>
                        </cue>
                        <cue name="Ch6_Monument_RepairedPanel4_Speaks_Finished">
                          <conditions>
                            <event_speak_finished actor="$XatActor" line="30220602"/>
                          </conditions>
                          <actions>
                            <debug_text text="'Negotiations chatter 2 finished.'" chance="$DebugChance"/>
                          </actions>
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Ch6_Monument_RepairedPanel3_Cutscene">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <cues>
                        <cue name="Ch6_Monument_RepairedPanel3_Queue" checkinterval="1s">
                          <conditions>
                            <check_value value="Ch6_Monument_RepairedPanel4_Speaks_Finished.state == cuestate.complete"/>
                          </conditions>
                          <actions>
                            <signal_cue cue="Ch6_Monument_RepairedPanel3a_Speak"/>
                          </actions>
                        </cue>
                        <cue name="Ch6_Monument_RepairedPanel3a_Speak">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <delay exact="3s" comment="make it less obviously connected to player triggering repairpanel"/>
                          <actions>
                            <speak actor="$XatActor" priority="100">
                              <text line="30220605" comment="Countless pretender realms have already been quashed, and the Heretical Order will suffer the same fate!"/>
                              <text line="30220606" comment="To even suggest the coexistence of two Pontifices is nothing short of heresy!"/>
                            </speak>
                          </actions>
                        </cue>
                        <cue name="Ch6_Monument_RepairedPanel3b_Speak">
                          <conditions>
                            <event_speak_finished actor="$XatActor" line="30220605"/>
                          </conditions>
                          <actions>
                            <speak actor="$Duke" priority="100">
                              <text line="30220618" comment="Please, enlightened ones."/>
                              <text line="30220619" comment="There is no question that anyone would dare to propose a permanent schism." delay="1s"/>
                            </speak>
                          </actions>
                        </cue>
                        <cue name="Ch6_Monument_RepairedPanel3c_Speak">
                          <conditions>
                            <event_speak_finished actor="$Duke" line="30220618"/>
                          </conditions>
                          <actions>
                            <speak actor="$XatActor" priority="100">
                              <text line="30220607" comment="(intensely)You have shunned your kind for far too long to be able to understand what any true believer would dare to do."/>
                              <text line="30220608" comment="Certainty will be gained through grapsing the entirety of our three-dimensional reality."/>
                              <text line="30220609" comment="(pitying)And how could you ever achieve that, with only two eyes?"/>
                            </speak>
                          </actions>
                        </cue>
                        <cue name="Ch6_Monument_RepairedPanel3_Speaks_Finished">
                          <conditions>
                            <event_speak_finished actor="$XatActor" line="30220607"/>
                          </conditions>
                          <actions>
                            <debug_text text="'Negotiations chatter 3 finished.'" chance="$DebugChance"/>
                          </actions>
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Ch6_Monument_RepairedPanel2_Cutscene">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <cues>
                        <cue name="Ch6_Monument_RepairedPanel2_Queue" checkinterval="1s">
                          <conditions>
                            <check_value value="Ch6_Monument_RepairedPanel3_Speaks_Finished.state == cuestate.complete"/>
                          </conditions>
                          <actions>
                            <signal_cue cue="Ch6_Monument_RepairedPanel2a_Speak"/>
                          </actions>
                        </cue>
                        <cue name="Ch6_Monument_RepairedPanel2a_Speak">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <delay exact="3s"/>
                          <actions>
                            <speak actor="$Duke" priority="100">
                              <text line="30220620" comment="Our third eye is an accolade."/>
                              <text line="30220621" comment="A reminder to all of you what we have given to one day see this realm unite." />
                            </speak>
                          </actions>
                        </cue>
                        <cue name="Ch6_Monument_RepairedPanel2c_Speak">
                          <conditions>
                            <event_speak_finished actor="$Duke" line="30220620"/>
                          </conditions>
                          <actions>
                            <speak actor="$XatActor" priority="100">
                              <text line="30220610" comment="(choleric)What you have given?!"/>
                              <text line="30220611" comment="(choleric)Preposterous!"/>
                              <text line="30220612" comment="(cruel)It is a mark of shame, born of trying to take what belongs to the Pontifex alone!"/>
                            </speak>
                          </actions>
                        </cue>
                        <cue name="Ch6_Monument_RepairedPanel2d_Speak">
                          <conditions>
                            <event_speak_finished actor="$XatActor" line="30220610"/>
                          </conditions>
                          <delay exact="1s"/>
                          <actions>
                            <speak actor="$RikActor" priority="100">
                              <text line="30220605" comment="You simply lack conviction, legate Xatenmanckett!"/>
                            </speak>
                          </actions>
                        </cue>
                        <cue name="Ch6_Monument_RepairedPanel2e_Speak">
                          <conditions>
                            <event_speak_finished actor="$RikActor" line="30220605"/>
                          </conditions>
                          <actions>
                            <speak actor="$XatActor" priority="100">
                              <text line="30220613" comment="(stern, cold)Our conviction is absolute!"/>
                              <text line="30220614" comment="And this realm will unite under the true embodiment of the Holy Three-Dimensionality alone, one way or another!" delay="1s"/>
                            </speak>
                          </actions>
                        </cue>
                        <cue name="Ch6_Monument_RepairedPanel2_Speaks_Finished">
                          <conditions>
                            <event_speak_finished actor="$XatActor" line="30220613"/>
                          </conditions>
                          <actions>
                            <debug_text text="'Negotiations chatter 4 finished.'" chance="$DebugChance"/>
                          </actions>
                        </cue>
                      </cues>
                    </cue>

                  </cues>
                </cue>

                <cue name="Ch6_Monument_CocoonRoom" checkinterval="3s">
                  <conditions>
                    <check_value value="$ParanidMonumentRepair.count le 4" comment="if we have access to cocoon-room..."/>
                    <check_value value="player.entity.distanceto.{$ParanidMonumentCocoonRoom} lt 100" comment="... and are nearby"/>
                  </conditions>
                  <actions>
                    <set_value name="$ObjectiveStep" operation="add"/>
                    <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.destroy" text="{20109,9201}" group="$ParanidMonumentClampsGroup" updatebriefing="true" comment="destroy: clamps"/>
                  </actions>
                  <cues>

                    <cue name="Ch6_Monument_CocoonRoom_Hint">
                      <delay exact="35s"/>
                      <cues>
                        <cue name="Ch6_Monument_DislodgeDal_Cutscene">
                          <conditions>
                            <event_cue_completed cue="Ch6_Monument_CocoonRoom_Hint"/>
                            <check_value value="$ParanidMonumentClampsGroup.count lt 5" comment="no clamps destroyed, give a hint"/>
                          </conditions>
                          <cues>
                            <cue name="Ch6_Monument_DislodgeDal_Cutscene_Ref" ref="md.LIB_Dialog.Speak_Actor">
                              <param name="Actor"             value="$DalBusta"/>
                              <param name="CutsceneKey"       value="$DalCutsceneKey"/>
                              <param name="Lines"             value="[[if player.entity.isfemale then 30220653 else 30220652]]"/>
                              <param name="EndSignalCue"      value="null"/>
                              <!--
                                <text line="if player.entity.isfemale then 30220653 else 30220652" comment="Come on! You have to dislodge the cocoons with your blaster."/>
                              -->
                            </cue>
                          </cues>
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Ch6_Monument_CoocoonRoom_ClampDestroyed" instantiate="true">
                      <conditions>
                        <event_object_destroyed group="$ParanidMonumentClampsGroup"/>
                      </conditions>
                      <delay exact="6s"/>
                      <actions>
                        <!-- find elder for this specific clamp (via grouptag) -->
                        <set_value name="$TheClamp" exact="event.object"/>
                        <find_object_component name="$TheElder" object="$ParanidMonument" macro="macro.par_elder_frozen_01_macro" grouptag="$TheClamp.grouptag" required="true" recursive="true"/>
                        <debug_text text="'Teleporting cocoon: ' + $TheElder + ' name=' + $TheElder.knownname + ' clamp=' + $TheClamp + ' clampname=' + $TheClamp.knownname + ' grouptag=' + $TheClamp.grouptag + ' remaining' + $ParanidMonumentClampsGroup.count" chance="$DebugChance"/>

                        <!-- TODO: teleportation-effect, instead of explosion -->
                        <destroy_object object="@$TheElder" explosion="true" />

                        <do_if value="$ParanidMonumentClampsGroup.count == 4" comment="1st clamp destroyed">
                          <signal_cue cue="Ch6_Monument_CoocoonRoom_Teleport"/>
                        </do_if>
                        <do_elseif value="$ParanidMonumentClampsGroup.count == 2" comment="3rd clamp destroyed">
                          <signal_cue cue="Ch6_Monument_CoocoonRoom_MoreClampsDestroyed"/>
                        </do_elseif>
                        <do_elseif value="$ParanidMonumentClampsGroup.count == 0" comment="last clamp destroyed">
                          <set_value name="$ParanidMonumentCocoons" exact="true"/>
                          <signal_cue cue="Ch6_Momument_CocoonRoom_Cleared"/>
                        </do_elseif>
                      </actions>
                    </cue>

                    <cue name="Ch6_Monument_CoocoonRoom_Teleport">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <cues>
                        <cue name="Ch6_Monument_Cocoons_Cutscene_Ref" ref="md.LIB_Dialog.Speak_Actors">
                          <param name="Actor"             value="[$DalBusta, $BosoTa, $DalBusta]"/>
                          <param name="CutsceneKey"       value="[$DalCutsceneKey, $BosoCutsceneKey, $DalCutsceneKey, ]"/>
                          <param name="Lines"             value="[[[30220655]],
                                                                  [[30220609]], 
                                                                  [[30220656], [30220657], [if player.entity.isfemale then 30220658 else 30220658],[30220654]],
                                                                 ]"/>
                          <param name="EndSignalCue"      value="[null, null, null]"/>
                          <!--           
                            <text line="30220655" comment="Our betentacled friend wants to try out one of his new inventions."/>
                            boso
                            <text line="30220609" comment="Be advised that my tentacle-like appendages can cause significant trauma on impact."/>
                            dal
                            <text line="30220656" comment="Yes!"/>
                            <text line="30220657" comment="It came through!"/>
                            <text line="if player.entity.isfemale then 30220658 else 30220658" comment="Just grab all of them while you're there!"/>
                            <text line="30220654" comment="We'll take care of the rest."/>
                          -->
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Ch6_Monument_CoocoonRoom_MoreClampsDestroyed">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <cues>
                        <cue name="Ch6_Monument_Cocoons3_Boso_CutsceneStart">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <delay exact="1s"/>
                          <cues>
                            <cue name="Ch6_Monument_Cocoons3_Boso_Cutscene_Ref" ref="md.LIB_Dialog.Speak_Actor">
                              <param name="Actor"             value="$BosoTa"/>
                              <param name="CutsceneKey"       value="$BosoCutsceneKey"/>
                              <param name="Lines"             value="[[30220609], [30220611]]"/>
                              <param name="EndSignalCue"      value="null"/>
                              <!--
                                <text line="30220609" comment="Most curious."/>
                                <text line="30220611" comment="I expected them to have much greater mass than that."/>
                              -->
                            </cue>
                          </cues>
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Ch6_Momument_CocoonRoom_Cleared">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <!-- check if any remaining repairpanel is nearby cocoon room -->
                        <create_group groupname="$RepairPanelInCocoonRoom"/>
                        <do_all exact="$ParanidMonumentRepair.count" counter="$i">
                          <do_if value="$ParanidMonumentRepair.{$i}.distanceto.{$ParanidMonumentCocoonRoom} lt 150">
                            <add_to_group groupname="$RepairPanelInCocoonRoom" object="$ParanidMonumentRepair.{$i}"/>
                          </do_if>
                        </do_all>
                      </actions>
                      <cues>
                        <cue name="Ch6_Monument_CocoonsCleared_Cutscene1" onfail="cancel" comment="repairpanels remaining, hint at triggering them">
                          <conditions>
                            <check_value value="$RepairPanelInCocoonRoom.count"/>
                          </conditions>
                          <cues>
                            <cue name="Ch6_Monument_CocoonsCleared_Cutscene1_Ref" ref="md.LIB_Dialog.Speak_Actor">
                              <param name="Actor"             value="$DalBusta"/>
                              <param name="CutsceneKey"       value="$DalCutsceneKey"/>
                              <param name="Lines"             value="[[30220660], [30220679, 2s], [if player.entity.isfemale then 30220681 else 30220680]]"/>
                              <param name="EndSignalCue"      value="Ch6_Monument_Decisions"/>
                              <!--
                                <text line="30220660" comment="That's the last of them!"/>
                                <t id="30220679">Strongrooms like this usually contain a failsafe security mechanism.</t>
                                <t id="30220680">Have another look around before you leave.</t>
                                <t id="30220681">(spoken to female player){10111,30220680}</t>
                              -->
                            </cue>
                          </cues>
                        </cue>
                        <cue name="Ch6_Monument_CocoonsCleared_Cutscene2" onfail="cancel" comment="repairpanels already triggered">
                          <conditions>
                            <check_value value="not $RepairPanelInCocoonRoom.count"/>
                          </conditions>
                          <actions>
                            <set_value name="$RepairPanelInCocoonRoomCleared" exact="true"/>
                          </actions>
                          <cues>
                            <cue name="Ch6_Monument_CocoonsCleared_Cutscene2_Ref" ref="md.LIB_Dialog.Speak_Actor">
                              <param name="Actor"             value="$DalBusta"/>
                              <param name="CutsceneKey"       value="$DalCutsceneKey"/>
                              <param name="Lines"             value="[[30220660], [if player.entity.isfemale then 30220662 else 30220661]]"/>
                              <param name="EndSignalCue"      value="Ch6_Monument_Decisions"/>
                              <!--
                                <text line="30220660" comment="That's the last of them!"/>
                                <t id="30220661">Now, head back to the central chamber.</t>
                                <t id="30220662">(spoken to female player){10111,30220661}</t>
                              -->
                            </cue>
                          </cues>
                        </cue>
                      </cues>
                    </cue>
                  </cues>
                </cue>

                <cue name="Ch6_Monument_Decisions">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <set_value name="$ObjectiveStep" operation="add"/>
                    <update_mission cue="$MissionCue" description="(if player.entity.isfemale then {30220,6026} else {30220,6025})
                                                        + '\n\n' + {30220,8015}
                                                        + '\n\n' + {30220,9507} + '\n' + {30220,9501} + ' ' + {30220,9502} + ' ' + {30220,9503}
                                                        + '\n\n' + {30220,9508} + '\n' + {30220,9504} + ' ' + {30220,9505} + ' ' + {30220,9506}" comment="Explanation for current objective plus diplo and eco info for the options." icon="'briefing_dal_busta_01'" iconcaption="$DalBusta.name"/>
                    <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.custom" customaction="{30220,6017}" object="$ParanidMonumentCore1" updatebriefing="true" comment="return to crossroads"/>
                  </actions>
                  <cues>

                    <cue name="Ch6_Monument_Decisions_NearCore" checkinterval="2s">
                      <conditions>
                        <check_any>
                          <check_value value="player.entity.distanceto.{$ParanidMonumentCore1} lt 90m"/>
                          <check_value value="player.entity.distanceto.{$ParanidMonumentCore2} lt 90m"/>
                        </check_any>
                      </conditions>
                      <actions>
                        <signal_cue cue="Ch6_Monument_Decisions_Dal_CutsceneStarted"/>
                      </actions>
                    </cue>

                    <cue name="Ch6_Monument_Decisions_Dal_CutsceneStarted">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <do_if value="$RepairPanelInCocoonRoomCleared" comment="one additional line in this case">
                          <set_value name="this.$lines" exact="[[if player.entity.isfemale then 30220664 else 30220663], [if player.entity.isfemale then 30220685 else 30220665], [30220667], 
                                                           [if player.entity.isfemale then 30220669 else 30220668], [30220670], [30220671], [30220672], 
                                                           [if player.entity.isfemale then 30220674 else 30220673], [if player.entity.isfemale then 30220676 else 30220675]
                                                          ]"/>
                        </do_if>
                        <do_else>
                          <set_value name="this.$lines" exact="[[if player.entity.isfemale then 30220664 else 30220663], [if player.entity.isfemale then 30220685 else 30220665], [30220667], 
                                                           [if player.entity.isfemale then 30220669 else 30220668], [30220670], [30220671], [30220672], 
                                                           [if player.entity.isfemale then 30220674 else 30220673]
                                                          ]"/>
                        </do_else>
                      </actions>
                      <cues>

                        <cue name="Ch6_Monument_Decisions_Dal_Cutscene_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$DalBusta"/>
                          <param name="CutsceneKey"       value="$DalCutsceneKey"/>
                          <param name="Lines"             value="parent.$lines"/>
                          <param name="EndSignalCue"      value="Ch6_Monument_LeaveCheck"/>
                          <!--
                            <text line="if player.entity.isfemale then 30220664 else 30220663" comment="This is it, my friend."/>
                            <text line="if player.entity.isfemale then 30220685 else 30220665" comment="You could simply leave this place behind and allow Kromancketslat to follow his dream of Paranid unity."/>
                            <text line="30220667" comment="There's a lot of potential in backing a galactic superpower in the making."/>
                            <text line="if player.entity.isfemale then 30220669 else 30220668" comment="Or you could go with Gride's plan and blow this symbol of Paranid tradition to space-dust."/>
                            <text line="30220670" comment="After all, this war has(slightly emphasize 'has') proven to be quite profitable for daring investors such as ourselves."/>
                            <text line="30220671" comment="This might also allow us to get to the bottom of this whole 'Duke' business."/>
                            <text line="30220672" comment="Both options are tempting in their own way."/>
                            <text line="if player.entity.isfemale then 30220674 else 30220673" comment="Whatever you do, and whatever happens next, there will be great opportunities for both of us."/>
                            <text line="if player.entity.isfemale then 30220676 else 30220675" comment="In case you decide to stay, that mechanism from earlier probably opened up another path into the bowels of this monstrosity."/> only if $RepairPanelInCocoonRoomCleared = true
                          -->
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Ch6_Monument_LeaveCheck" version="2">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <!-- If the player leaves at this point, it is counted as a choice, so we can safely place the fleets now. -->
                        <signal_cue_instantly cue="Ch7_Monument_Battle_Setup"/>

                        <set_value name="$ObjectiveStep" operation="add"/>
                        <create_group groupname="$ParanidCoreGroup"/>
                        <add_to_group groupname="$ParanidCoreGroup" object="$ParanidMonumentCore1"/>
                        <add_to_group groupname="$ParanidCoreGroup" object="$ParanidMonumentCore2"/>
                        <!-- TODO: Replace this patchwork string with a proper text ID. -->
                        <set_value name="$ConsequencesObjectiveString" exact="{30221,4012} + ' / ' + {30178,1026}" comment="Place explosives / Leave"/>
                        <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.custom" customaction="{30220,6018}" text="$ConsequencesObjectiveString" group="$ParanidCoreGroup" updatebriefing="true"/>

                        <!-- At this point, Gride can eject the player's ship. If the player leaves immediately, even by teleporting, they're choosing the Unification path. -->
                        <signal_cue cue="Ch7_Gride_Eject_Player_Ship"/>
                      </actions>
                      <patch sinceversion="2">
                        <!-- Added extra information in the objective in version 2. -->
                        <do_if value="Ch6_Monument_Leave2.state == cuestate.waiting">
                          <set_value name="$ConsequencesObjectiveString" exact="{30221,4012} + ' / ' + {30178,1026}" comment="Place explosives / Leave"/>
                          <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.custom" customaction="{30220,6018}" text="$ConsequencesObjectiveString" group="$ParanidCoreGroup" updatebriefing="true"/>
                        </do_if>
                      </patch>
                      <cues>
                        <cue name="Ch6_Monument_Leave2" checkinterval="1s">
                          <conditions>
                            <check_any>
                              <check_value value="(player.container.sector == $ParanidMonument.sector) and (player.container.distanceto.{$ParanidMonumentEntranceHallway} lt 40)"/>
                              <check_value value="(player.container.sector == $ParanidMonument.sector) and (player.container.distanceto.{$ParanidMonument} gt 1500m)" comment="In case the player teleports out."/>
                            </check_any>
                            <check_value value="$ParanidMonumentCocoons" comment="Player finished cocoon section"/>
                          </conditions>
                          <actions>
                            <debug_text text="'Leaving the monument'" chance="$DebugChance"/>
                            <set_value name="$ObjectiveStep" operation="add"/>
                            <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.flyto" text="{30220,101}" object="$GrideShip" updatebriefing="true" comment="Fly to: Gride Orrian"/>

                            <!-- Uncover Gride's ship -->
                            <cancel_cue cue="Ch6_Gride_AtMonument_Uncovered"/>
                            <cancel_cue cue="Ch6_Gride_AtMonument_Scanned"/>
                            <remove_value name="$GrideShip.pilot.$donotscan"/>
                            <signal_objects object="$GrideShip" param="'LoseCover'" param2="false"/>

                            <!-- avoid potential death due to Paranid Monument exploding -->
                            <cancel_cue cue="Ch6_Monument_Cores"/>
                            <do_if value="$ParanidMonumentCore1Bomb and $ParanidMonumentCore2Bomb">
                              <update_mission cue="$MissionCue" description="(if player.entity.isfemale then {30220,6028} else {30220,6027})
                                                                  + '\n\n' + {30220,8015}
                                                                  + '\n\n' + {30220,9507} + '\n' + {30220,9501} + ' ' + {30220,9502} + ' ' + {30220,9503}" comment="Explanation of next objective plus diplo and eco info for the selected choice (war)."/>
                              <!-- chapter 7.2 escalation (monument destroyed) -->
                              <!--<signal_cue cue="Ch7_Gride_Warp_Backwards"/>-->
                              <signal_cue cue="Ch6_Monument_Explosion_Intro"/>
                            </do_if>
                            <do_else>
                              <update_mission cue="$MissionCue" description="(if player.entity.isfemale then {30220,6028} else {30220,6027})
                                                                  + '\n\n' + {30220,8015}
                                                                  + '\n\n' + {30220,9508} + '\n' + {30220,9504} + ' ' + {30220,9505} + ' ' + {30220,9506}" comment="Explanation of next objective plus diplo and eco info for the selected choice (peace)."/>
                              <!-- chapter 7.1 unification (monument remains) -->
                              <signal_cue cue="Ch7_1_Unification"/>
                            </do_else>
                          </actions>
                        </cue>
                      </cues>
                    </cue>

                  </cues>
                </cue>

              </cues>
            </cue>

            <cue name="Ch6_Monument_Explosion_Debug" instantiate="true">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <do_if value="player.ship">
                  <warp object="player.ship" sector="$ParanidMonumentSector">
                    <position x="$ParanidMonumentPosition.x" y="$ParanidMonumentPosition.y" z="$ParanidMonumentPosition.z + 8km"/>
                    <rotation yaw="180deg" pitch="0deg" roll="0deg"/>
                  </warp>
                </do_if>
                <do_else>
                  <create_ship macro="macro.ship_gen_xs_escapepod_01_a_macro" name="$TempEffectObject" sector="$ParanidMonumentSector">
                    <owner exact="faction.player"/>
                    <position x="$ParanidMonumentPosition.x" y="$ParanidMonumentPosition.y" z="$ParanidMonumentPosition.z + 8km"/>
                    <rotation yaw="180deg" pitch="0deg" roll="0deg"/>
                  </create_ship>
                </do_else>
                <force_cue cue="Ch6_Monument_Explosion"/>
              </actions>
              <force name="Plot_ParanidMonument_Explosion"/>
            </cue>

            <cue name="Ch6_Monument_Explosion_Intro">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <cues>
                <cue name="Ch6_Monument_Explosion_Intro_Dal_Speak">
                  <cues>
                    <cue name="Ch6_Dal_Speak_701_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$DalBusta"/>
                      <param name="CutsceneKey"       value="$DalCutsceneKey"/>
                      <param name="Lines"             value="[[if player.entity.isfemale then 30220702 else 30220701],[30220751]]"/>
                      <param name="EndSignalCue"      value="Ch6_Monument_Explosion"/>
                      <!--           
                                   I hope you made the right choice.
                                   Let's get back to Gride with the good news.
                                  -->
                    </cue>
                  </cues>
                </cue>
              </cues>
            </cue>

            <cue name="Ch6_Monument_Explosion">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
              </actions>
              <cues>

                <cue name="Ch6_Monument_Explosion_Director">
                  <!--00-03: Fade out
                      03   : Place temp objects that can explode later
                      03   : Warp player spacesuit closer to Gride's ship
                      03-06: Fade in
                      03-13: Shot 1 (Rotate around Gride's ship)
                      05   : Gride speak 1
                      10-13: Fade out
                      13-16: Fade in
                      13-41: Shot 2 (Rotate around monument)
                      18-48: Explosion effect
                      19   : Old monument gets removed from underneath the effect
                      28   : Gride speak 2 (comments on explosion)
                      38-41: Fade out (this is what it should be mathematically, but we have to start it at 37 for some reason)
                      41-43: Fade in
                      41-49: Shot 3 (Zoom in on the black smoke in the wreckage)
                      41   : Gride speak 3
                      46-49: Fade out
                      49-53: Fade in-->
                  <actions>
                    <fade_screen fadeout="3s" fadein="3s"/>
                  </actions>
                  <delay exact="3s"/>
                  <actions>
                    <!--03-->
                    <signal_cue cue="Ch6_Monument_Explosion_Replace_Monument" comment="Place invisible temp objects over original monument."/>
                    <signal_cue cue="Ch6_Monument_Explosion_SpaceSuitWarp" comment="Warp player spacesuit closer to Gride's ship."/>
                    <!--Cutscene shots take 10-28-08 seconds.
                  It needs to be dark at 03-13-41-49 seconds.
                  Fadeouts will start at 00-10-38-46 seconds.-->
                    <play_cutscene key="'Story_Paranid_Monument'" targetmonitor="false" result="this.$CutsceneID" abortable="false">
                      <param name="monument" object="$ParanidMonument" />
                      <param name="gride_ship" object="$GrideShip" />
                    </play_cutscene>
                  </actions>
                  <delay exact="2s"/>
                  <actions>
                    <!--05-->
                    <signal_cue cue="Ch6_Monument_Explosion_Gride_Speak_1"/>
                  </actions>
                  <delay exact="5s"/>
                  <actions>
                    <!--10-->
                    <fade_screen fadeout="3s" fadein="3s"/>
                  </actions>
                  <delay exact="8s"/>
                  <actions>
                    <!--18-->
                    <signal_cue cue="Ch6_Monument_Explosion_Start_Effects2" comment="Remove the old monument and start the explosion."/>
                  </actions>
                  <delay exact="10s"/>
                  <actions>
                    <!--28-->
                    <signal_cue cue="Ch6_Monument_Explosion_Gride_Speak_2"/>
                  </actions>
                  <delay exact="9s" comment="Mathematically, this should be 10s, but if we do that, the fadeout comes a bit too late for some reason!"/>
                  <actions>
                    <!--37 (should be 38, but see above)-->
                    <fade_screen fadeout="3s" fadein="3s"/>
                  </actions>
                  <delay exact="4s"/>
                  <actions>
                    <!--41 (Shot 3 starts)-->
                    <signal_cue cue="Ch6_Monument_Explosion_Gride_Speak_3"/>
                  </actions>
                  <delay exact="4s"/>
                  <actions>
                    <!--45-->
                    <fade_screen fadeout="3s" fadein="3s"/>
                  </actions>
                  <delay exact="3s"/>
                  <actions>
                    <!--48-->
                    <signal_cue cue="Ch6_Monument_Explosion_Place_Monument_Wreck"/>
                  </actions>
                  <cues>
                    <cue name="Ch6_Monument_Explosion_SceneEnded">
                      <conditions>
                        <event_cutscene_stopped cutscene="parent.$CutsceneID"/>
                      </conditions>
                      <actions>
                        <debug_text text="'Paranid Monument scene ended'" chance="$DebugChance"/>
                        <signal_cue cue="Ch7_2_Escalation"/>
                      </actions>
                    </cue>
                  </cues>
                </cue>

                <cue name="Ch6_Monument_Explosion_Replace_Monument">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <!-- Precache the original monument, so that it gets displayed correctly. -->
                    <precache_hint object="$ParanidMonument"/>

                    <!-- Overlay the original monument with invisible objects which we can explode later. -->
                    <create_object macro="macro.landmarks_par_monument_expldummy_01_macro" name="$TempEffectObject2" sector="$ParanidMonumentSector">
                      <position value="$ParanidMonumentPosition"/>
                    </create_object>
                    <precache_hint object="$TempEffectObject2"/>
                    <create_object macro="macro.landmarks_par_monument_expldummy_02_macro" name="$TempEffectObject3" sector="$ParanidMonumentSector">
                      <position value="$ParanidMonumentPosition"/>
                    </create_object>
                    <precache_hint object="$TempEffectObject3"/>
                    <create_object macro="macro.landmarks_par_monument_expldummy_03_macro" name="$TempEffectObject4" sector="$ParanidMonumentSector">
                      <position value="$ParanidMonumentPosition"/>
                    </create_object>
                    <precache_hint object="$TempEffectObject4"/>
                  </actions>
                </cue>

                <cue name="Ch6_Monument_Explosion_Start_Effects2" comment="The effect length is 30s.">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <create_position name="$EffectPos" object="$ParanidMonumentSector" space="$ParanidMonumentZone" value="$ParanidMonumentPosition"/>
                    <create_position name="$EffectOffset" object="$TempEffectObject2" x="200" y="2670m" z="100"/>
                    <create_position name="$EffectOffset2" object="$TempEffectObject2" x="200" y="-1670m" z="100"/>
                    <debug_text text="'PM Zone will be: ' +  + ' ' + $ParanidMonumentZone.knownname + ' playing effect at ' + $EffectPos" chance="$DebugChance"/>

                    <do_if value="@$TempEffectObject2.exists">
                      <destroy_object object="$TempEffectObject2" explosion="true" />
                    </do_if>
                    <do_if value="@$TempEffectObject3.exists">
                      <destroy_object object="$TempEffectObject3" explosion="true" />
                    </do_if>
                    <do_if value="@$TempEffectObject4.exists">
                      <destroy_object object="$TempEffectObject4" explosion="true" />
                    </do_if>
                    <!--Add the effect name here-->
                    <add_effect object="$ParanidMonumentZone" effect="'pm_explosion_main'">
                      <position value="$EffectPos"/>
                    </add_effect>
                    <!--Add the effect name here-->
                    <add_effect object="$ParanidMonumentZone" effect="'pm_explosion_base'">
                      <position value="$EffectPos"/>
                    </add_effect>
                    <add_effect object="$ParanidMonumentZone" effect="'pm_topexplosion'">
                      <position value="$EffectOffset"/>
                    </add_effect>
                    <add_effect object="$ParanidMonumentZone" effect="'pm_topexplosion'">
                      <position value="$EffectOffset2"/>
                    </add_effect>
                    <do_if value="@$TempEffectObject.exists">
                      <destroy_object object="$TempEffectObject"/>
                    </do_if>
                  </actions>
                  <delay exact="1s"/>
                  <actions>
                    <!-- destroy original monument -->
                    <destroy_object object="$ParanidMonument"/>
                    <set_value name="$ParanidMonument" exact="null"/>
                  </actions>
                </cue>

                <cue name="Ch6_Monument_Explosion_Place_Monument_Wreck">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <!-- creates the destroyed paranid monument, which remains now -->
                    <create_object name="$ParanidMonument" macro="macro.landmarks_par_monument_expl_04_macro" sector="$ParanidMonumentSector">
                      <position value="$ParanidMonumentPosition"/>
                    </create_object>
                  </actions>
                </cue>

                <cue name="Ch6_Monument_Explosion_Gride_Speak_1">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <speak actor="$GrideActor" priority="100">
                      <text line="30220701" comment="(relieved)Finally!"/>
                    </speak>
                  </actions>
                  <delay exact="2s"/>
                  <actions>
                    <speak actor="$GrideActor" priority="100">
                      <text line="30220702" comment="Now, let us reap the rewards from all our efforts."/>
                    </speak>
                  </actions>
                </cue>

                <cue name="Ch6_Monument_Explosion_Gride_Speak_2">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <speak actor="$GrideActor" priority="100">
                      <text line="30220751" comment="Beautiful, isn't it?"/>
                    </speak>
                  </actions>
                </cue>

                <cue name="Ch6_Monument_Explosion_Gride_Speak_3">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <speak actor="$GrideActor" priority="100">
                      <text line="30220752" comment="My dears, you are witnessing the birth of a new era."/>
                    </speak>
                  </actions>
                </cue>

                <cue name="Ch6_Monument_Explosion_SpaceSuitEscape">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <do_if value="(player.entity.sector == $GrideShip.sector) and player.ship.isclass.spacesuit" comment="The player could have teleported out of sector.">
                      <debug_text text="'Starting player spacesuit autopilot towards $GrideShip.'" chance="$DebugChance"/>
                      <start_player_autopilot destination="$GrideShip"/>
                    </do_if>
                    <do_else>
                      <debug_text text="'Player is out of sector.'" chance="$DebugChance"/>
                    </do_else>
                  </actions>
                </cue>

                <cue name="Ch6_Monument_Explosion_SpaceSuitWarp">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <do_if value="(player.entity.sector == $GrideShip.sector) and player.ship.isclass.spacesuit" comment="The player could have teleported out of sector.">
                      <debug_text text="'Warping player spacesuit towards $GrideShip.'" chance="$DebugChance"/>
                      <create_position name="$GrideShipParkingPosition" object="$GrideShip" space="$ParanidMonumentSector"/>
                      <create_position name="$SpaceSuitWarpPosition" x="$GrideShipParkingPosition.x" y="$GrideShipParkingPosition.y" z="$GrideShipParkingPosition.z - 180m" comment="Directly in front of $GrideShip."/>
                      <warp object="player.entity.ship" sector="$ParanidMonumentSector">
                        <position value="$SpaceSuitWarpPosition"/>
                      </warp>
                    </do_if>
                    <do_else>
                      <debug_text text="'Player is out of sector.'" chance="$DebugChance"/>
                    </do_else>
                  </actions>
                </cue>

              </cues>
            </cue>

          </cues>
        </cue>

        <cue name="Ch7_Monument_Battle_Setup" comment="Signal at some point during the Paranid Monument maze exploration.">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <debug_text text="'Setting up three-way battle.'" chance="$DebugChance"/>

            <!-- Battlefield location -->
            <create_position name="$ParanidMonumentPosition" object="$ParanidMonument" space="$ParanidMonumentSector"/>
            <create_position name="$MonumentBattlefield"   x="$ParanidMonumentPosition.x + 25km" y="$ParanidMonumentPosition.y" z="$ParanidMonumentPosition.z - 25km" comment="South-east of Paranid monument."/>
            <create_position name="$HolyOrderStagingPoint" x="$MonumentBattlefield.x - 10km"     y="$MonumentBattlefield.y"     z="$MonumentBattlefield.z"            comment="West of battlefield centre."/>
            <create_position name="$GodrealmStagingPoint"  x="$MonumentBattlefield.x"            y="$MonumentBattlefield.y"     z="$MonumentBattlefield.z + 10km"     comment="North of battlefield centre."/>
            <create_position name="$BuccaneerStagingPoint" x="$MonumentBattlefield.x + 15km"     y="$MonumentBattlefield.y"     z="$MonumentBattlefield.z - 15km"     comment="South-east of battlefield centre."/>

            <!-- Fleets and combinations of fleets we might want to populate later. Create them here in case cues want to check for the destruction of specific fleet ships before those fleets exist. -->
            <create_group groupname="$HolyOrderFleet"/>
            <create_group groupname="$GodrealmFleet"/>
            <create_group groupname="$ParanidFleets"/>
            <create_group groupname="$BuccaneerFleet"/>
            <create_group groupname="$AllFleets"/>

            <!-- *** HOLY ORDER SETUP *** -->

            <!-- Honour Guard squad, or what's left of it -->
            <find_ship groupname="$HonourGuardSquad" multiple="true" job="'holyorder_corvette_escort_elite_m'" space="player.galaxy"/>
            <find_ship name="$HonourGuardLeader" job="'holyorder_corvette_elite_m'" space="player.galaxy"/>
            <do_if value="$HonourGuardLeader != null">
              <add_to_group groupname="$HonourGuardSquad" object="$HonourGuardLeader"/>
            </do_if>

            <do_if value="not $HonourGuardSquad? or not $HonourGuardSquad.count" comment="If the Honour Guard squad is destroyed, create one Nemesis with Rik on board and add it to $HonourGuardSquad">
              <create_ship ref="holyorder_corvette_m_elite" name="$NewNemesis" commandeerable="false" capturable="false" mission="true" sector="$ParanidMonumentSector">
                <owner exact="faction.holyorder" overridenpc="true"/>
                <pilot actor="$RikActor"/>
                <people ref="paranid_elite_military_crew"/>
                <safepos value="$HolyOrderStagingPoint"/>
                <rotation yaw="90deg"/>
              </create_ship>
              <add_to_group groupname="$HonourGuardSquad" object="$NewNemesis"/>
            </do_if>

            <do_else comment="If the Honour Guard still exists, make them move to the staging point and warp them if they arent't in the sector.">
              <do_for_each in="$HonourGuardSquad" name="$CurrentNemesis">
                <do_if value="$CurrentNemesis.sector != $ParanidMonumentSector">
                  <warp object="$CurrentNemesis" sector="$ParanidMonumentSector">
                    <safepos value="$HolyOrderStagingPoint"/>
                    <rotation yaw="-90deg"/>
                  </warp>
                </do_if>
                <create_order id="'MoveWait'" object="$CurrentNemesis" default="true">
                  <param name="destination" value="[$ParanidMonumentSector, $HolyOrderStagingPoint]"/>
                </create_order>
                <cancel_all_orders object="$CurrentNemesis"/>
              </do_for_each>
            </do_else>

            <!-- Make one of the Holy Order ships invincible, so that the mission still works if the player approaches too late -->
            <set_value name="$IncinvibleHolyOrderShip" exact="$HonourGuardSquad.{1}"/>
            <set_object_min_shield object="$IncinvibleHolyOrderShip" exact="20"/>
            <set_object_min_hull object="$IncinvibleHolyOrderShip" exact="80"/>

            <add_to_group groupname="$HolyOrderFleet" group="$HonourGuardSquad"/>

            <!-- Cipher Ship, if it survived -->
            <do_if value="$CipherShipEscaped?" comment="If the cipher ship escaped, it will have moved and self-destructed out of view.">
              <create_ship name="$CipherShip" macro="ship_par_l_destroyer_01_b_macro" commandeerable="false" capturable="false" mission="true" sector="$ParanidMonument.sector">
                <owner exact="faction.holyorder" overridenpc="true"/>
                <pilot>
                  <select faction="faction.holyorder" tags="tag.elitepilot"/>
                </pilot>
                <loadout ref="story_paranid_stranded_odysseus"/>
                <people ref="paranid_elite_military_crew"/>
                <safepos value="$HolyOrderStagingPoint"/>
                <rotation yaw="90deg"/>
              </create_ship>
              <set_object_name object="$CipherShip" page="30220" line="131" comment="{20204,3901} {20101,30703}(Rising Solitude Odysseus Sentinel)"/>
              <create_order id="'MoveWait'" object="$CipherShip" default="true">
                <param name="destination" value="[$ParanidMonumentSector, $HolyOrderStagingPoint]"/>
              </create_order>
              <add_to_group groupname="$HolyOrderFleet" object="$CipherShip"/>
            </do_if>

            <add_to_group groupname="$AllFleets" group="$HolyOrderFleet"/>

            <!-- Stop Holy Order fleet from fighting nearby Godrealm ships -->
            <do_for_each in="$HolyOrderFleet" name="$CurrentShip">
              <set_relation_boost object="$CurrentShip" faction="faction.paranid" value="1.0" decay="0"/>
            </do_for_each>

            <!-- *** KROMANCKETSLAT SETUP *** -->
            <do_if value="not $KroShip? or ($KroShip == null)" comment="If for whatever reason his ship doesn't exist, create it.">
              <create_ship name="$KroShip" macro="ship_par_s_scout_01_b_macro" capturable="false" commandeerable="false" mission="true" sector="$ParanidMonumentSector">
                <pilot>
                  <!-- Naturally the Duke does not pilot the ship himself. He breathes down his pilot's neck, like any civilised Paranid would.-->
                  <select faction="faction.paranid" tags="tag.elitepilot"/>
                </pilot>
                <owner exact="faction.civilian" overridenpc="true"/>
                <loadout>
                  <level exact="1.0"/>
                </loadout>
                <safepos value="$MonumentBattlefield"/>
                <rotation yaw="- 45deg"/>
              </create_ship>
            </do_if>

            <cancel_all_orders object="$KroShip"/>
            <create_order id="'MoveWait'" object="$KroShip" default="true">
              <param name="destination" value="[$ParanidMonument.sector, $MonumentBattlefield]"/>
            </create_order>

            <set_object_min_shield object="$KroShip" min="20" comment="Maybe this lets him boost more."/>
            <set_object_min_hull object="$KroShip" min="80"/>
            <add_to_group groupname="$AllFleets" object="$KroShip"/>

            <!-- *** GODREALM SETUP *** -->

            <!-- Xatenmanckett's flagship -->
            <create_ship name="$GodrealmFlagship" macro="ship_par_l_destroyer_01_a_macro" commandeerable="false" capturable="false" mission="true" sector="$ParanidMonumentSector">
              <owner exact="faction.paranid" overridenpc="true"/>
              <pilot>
                <select faction="faction.paranid" tags="tag.elitepilot"/>
              </pilot>
              <loadout>
                <level exact="1.0"/>
              </loadout>
              <people ref="paranid_elite_military_crew"/>
              <safepos value="$GodrealmStagingPoint"/>
              <rotation yaw="180deg"/>
            </create_ship>
            <create_order id="'MoveWait'" object="$GodrealmFlagship" default="true">
              <param name="destination" value="[$ParanidMonumentSector, $GodrealmStagingPoint]"/>
            </create_order>

            <set_object_name object="$GodrealmFlagship" page="30220" line="134" comment="Imposing Penance"/>

            <!-- Make Godrealm Flagship invincible, so that the mission still works even if the player approaches very late -->
            <set_object_min_shield object="$GodrealmFlagship" exact="20"/>
            <set_object_min_hull object="$GodrealmFlagship" exact="50"/>

            <add_to_group groupname="$GodrealmFleet" object="$GodrealmFlagship"/>

            <!-- Entourage
                  Frigates:
                    <t id="144">The Prayer Eternal</t>
                    <t id="159">The Serenity Of The Inevitable</t>
                    <t id="167">Paladin Of Unanimity</t>
                  Fighters:
                    30220,135: Furious Purpose
                    30220,136: Glorious Absolution
                    <t id="170">Expeditious Retaliation</t>
                    <t id="156">An Auspicious Portent</t>
                    <t id="158">Coercer Of Quiescence</t>
                    <t id="166">Ecclesiastical Equalizer</t>-->
            <set_value name="$GodrealmFleetComposition"   exact="[
                   [ macro.ship_par_m_frigate_01_a_macro, 30220, 144 ],
                   [ macro.ship_par_m_frigate_01_a_macro, 30220, 159 ],
                   [ macro.ship_par_m_frigate_01_a_macro, 30220, 167 ],
                                                       
                   [ macro.ship_par_s_fighter_01_a_macro, 30220, 135 ],
                   [ macro.ship_par_s_fighter_01_a_macro, 30220, 136 ],
                   [ macro.ship_par_s_fighter_01_a_macro, 30220, 170 ],
                                                       
                   [ macro.ship_par_s_fighter_02_a_macro, 30220, 156 ],
                   [ macro.ship_par_s_fighter_02_a_macro, 30220, 158 ],
                   [ macro.ship_par_s_fighter_02_a_macro, 30220, 166 ]
                   ]" />

            <do_all exact="$GodrealmFleetComposition.count" counter="$f">
              <create_ship name="$CurrentShip" macro="$GodrealmFleetComposition.{$f}.{1}" commandeerable="false" capturable="false" mission="true" sector="$ParanidMonumentSector">
                <owner exact="faction.paranid" overridenpc="true" />
                <pilot>
                  <select faction="faction.paranid" tags="tag.elitepilot"/>
                </pilot>
                <loadout>
                  <level exact="1.0"/>
                </loadout>
                <safepos value="$GodrealmStagingPoint" min="200m" max="500m"/>
                <rotation yaw="180deg"/>
              </create_ship>

              <do_if value="$GodrealmFleetComposition.{$f}.{2}">
                <set_object_name object="$CurrentShip" page="$GodrealmFleetComposition.{$f}.{2}" line="$GodrealmFleetComposition.{$f}.{3}"/>
              </do_if>

              <add_to_group groupname="$GodrealmFleet" object="$CurrentShip"/>

              <create_order id="'AssignCommander'" object="$CurrentShip" immediate="true">
                <param name="commander" value="$GodrealmFlagship"/>
                <param name="assignment" value="assignment.defence"/>
                <param name="cancelorders" value="true"/>
              </create_order>
            </do_all>

            <!-- Stop Godrealm fleet from fighting nearby Holy Order ships -->
            <do_for_each in="$GodrealmFleet" name="$CurrentShip">
              <set_relation_boost object="$CurrentShip" faction="faction.holyorder" value="1.0" decay="0"/>
            </do_for_each>

            <add_to_group groupname="$AllFleets" group="$GodrealmFleet"/>

            <!-- *** BUCCANEERS SETUP *** -->

            <signal_cue_instantly cue="Setup_Create_Buccaneer_Flagship" param="table[ $sector = $ParanidMonumentSector, $position = $BuccaneerStagingPoint, $invulnerable = false, $radarvisible = true ]"/>
            <create_order name="$BuccaneerWait" id="'MoveWait'" object="$BuccaneerFlagship" default="true">
              <param name="destination" value="[$ParanidMonumentSector, $BuccaneerStagingPoint]"/>
            </create_order>
            <add_to_group groupname="$BuccaneerFleet" object="$BuccaneerFlagship"/>

            <!-- More names:
            Superior By Definition
            Smoke \'Em If You Got \'Em
            Shut Up I\'m Sober Enough To Fly
            -->

            <!--Unique ship names:
            30220,137: Diplomacy Gunboat
            30220,138: Will Perform Heresy For Credits
            30220,139: I Reject Your Axioms
            30220,140: Empirically Holier Than Thou
            30220,141: My Other Ship Is RIGHT BEHIND YOU
            30220,142: Praise Miscommunication-->
            <set_value name="$BuccaneerFleetComposition"   exact="[
                   [ macro.ship_arg_m_bomber_01_b_macro, 30220, 137 ],
                   [ macro.ship_arg_m_bomber_01_b_macro, 30220, 138 ],
                   [ macro.ship_arg_m_bomber_01_b_macro, 30220, 139 ],
                   [ macro.ship_arg_m_bomber_01_b_macro, 30220, 140 ],
                   [ macro.ship_arg_m_bomber_01_b_macro, 30220, 141 ],
                   [ macro.ship_arg_m_bomber_01_b_macro, 30220, 142 ]
                   ]" />

            <do_all exact="$BuccaneerFleetComposition.count" counter="$f">
              <debug_text text="'Creating Buccaneer ship number: ' + $f + '. Macro: ' + $BuccaneerFleetComposition.{$f}.{1} + '. Name: ' + readtext.{$BuccaneerFleetComposition.{$f}.{2}}.{$BuccaneerFleetComposition.{$f}.{3}}" chance="$DebugChance"/>
              <!-- Buccaneers don't have an automatic loadout creation yet, so we need to set loadouts manually for each macro. -->
              <do_if value="$BuccaneerFleetComposition.{$f}.{1} == macro.ship_arg_m_bomber_01_b_macro">
                <create_ship name="$CurrentShip" macro="$BuccaneerFleetComposition.{$f}.{1}" commandeerable="false" capturable="false" mission="true" sector="$ParanidMonumentSector">
                  <owner exact="faction.buccaneers" overridenpc="true"/>
                  <pilot>
                    <select faction="faction.buccaneers" tags="tag.elitepilot"/>
                  </pilot>
                  <loadout ref="story_paranid_buc_minotaur"/>
                  <safepos value="$BuccaneerStagingPoint" min="200m" max="500m"/>
                  <rotation yaw="-45deg"/>
                </create_ship>

                <do_if value="$CurrentShip">
                  <debug_text text="'Buccaneer ship successfully created.'" chance="$DebugChance"/>
                  <do_if value="$BuccaneerFleetComposition.{$f}.{2}">
                    <set_object_name object="$CurrentShip" page="$BuccaneerFleetComposition.{$f}.{2}" line="$BuccaneerFleetComposition.{$f}.{3}"/>
                  </do_if>

                  <create_order id="'AssignCommander'" object="$CurrentShip" immediate="true">
                    <param name="commander" value="$BuccaneerFlagship"/>
                    <param name="assignment" value="assignment.defence"/>
                    <param name="cancelorders" value="false"/>
                  </create_order>
                </do_if>
              </do_if>
              <do_else>
                <create_ship name="$CurrentShip" macro="$BuccaneerFleetComposition.{$f}.{1}" commandeerable="false" capturable="false" mission="true" sector="$ParanidMonumentSector">
                  <owner exact="faction.buccaneers" overridenpc="true"/>
                  <pilot>
                    <select faction="faction.buccaneers" tags="tag.elitepilot"/>
                  </pilot>
                  <loadout>
                    <level exact="1.0"/>
                  </loadout>
                  <safepos value="$BuccaneerStagingPoint" min="200m" max="500m"/>
                  <rotation yaw="-45deg"/>
                </create_ship>

                <create_order id="'AssignCommander'" object="$CurrentShip" immediate="true">
                  <param name="commander" value="$BuccaneerFlagship"/>
                  <param name="assignment" value="assignment.defence"/>
                  <param name="cancelorders" value="false"/>
                </create_order>
              </do_else>

              <add_to_group groupname="$BuccaneerFleet" object="$CurrentShip"/>
            </do_all>

            <!-- This will be filled with drones that are launched by the script, so we can keep track of them and destroy them after the battle. -->
            <create_group groupname="$BuccaneerDrones"/>

            <!-- Make Buccaneers invisible until Boso Ta or Gride announce their arrival -->
            <do_for_each in="$BuccaneerFleet" name="$CurrentShip">
              <set_object_radar_visible object="$CurrentShip" visible="false"/>
              <!-- Keep Buccaneer ships safe from Godrealm and Holy Order -->
              <set_relation_boost object="$CurrentShip" faction="faction.paranid" value="1.0" decay="0"/>
              <set_relation_boost object="$CurrentShip" faction="faction.holyorder" value="1.0" decay="0"/>
            </do_for_each>

            <add_to_group groupname="$BuccaneerFleet" object="$GrideShip"/>
            <add_to_group groupname="$AllFleets" group="$BuccaneerFleet"/>

            <!-- Disable relation changes between the involved ships. We don't want stray shots to cause a diplomatic incident. -->
            <do_for_each in="$AllFleets" name="$CurrentShip">
              <set_object_relation_behaviour object="$CurrentShip" disable="true"/>
            </do_for_each>
          </actions>
        </cue>

        <cue name="Ch7_Debug_Setup">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <!-- Deactivate all default behaviour of the monument guard -->
            <cancel_cue cue="Paranid_Monument_Generic_Guard_Response"/>
            <set_job_active job="'holyorder_corvette_elite_m'" activate="false"/>
            <set_job_active job="'holyorder_corvette_escort_elite_m'" activate="false"/>

            <!-- Place Gride's ship where it would be at this point -->
            <create_ship name="$GrideShip" macro="ship_par_m_frigate_01_b_macro" capturable="false" commandeerable="false" mission="true" sector="$ParanidMonumentSector">
              <owner exact="faction.buccaneers" overridenpc="true"/>
              <pilot>
                <select faction="faction.buccaneers" tags="tag.elitepilot"/>
              </pilot>
              <loadout ref="story_paranid_gride_gorgon"/>
              <position x="92225.117" y="-985.016" z="14315.398"/>
              <rotation yaw="-179.62668deg" pitch="0.509635deg" roll="0.562685deg"/>
            </create_ship>
            <create_order id="'Wait'" object="$GrideShip" default="true"/>
            <set_object_min_hull object="$GrideShip" exact="100" comment="invulnerable"/>
            <set_object_min_shield object="$GrideShip" exact="7"/>
            <set_object_name object="$GrideShip" page="30220" line="133" comment="Howling Petal"/>

            <signal_cue cue="Ch7_Monument_Battle_Setup"/>

            <create_mission cue="$MissionCue" name="{30220,6001}" description="{30220,6002}" type="missiontype.plot" faction="faction.player" difficulty="level.medium" abortable="false" icon="'briefing_kromancketslat_01'" iconcaption="$Duke.name">
              <briefing>
                <objective step="1" action="objective.custom" customaction="{30220,6015}"/>
              </briefing>
            </create_mission>
          </actions>
        </cue>

        <cue name="Ch7_Gride_Warp_Backwards">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <warp object="$GrideShip" sector="$ParanidMonumentSector">
              <position object="$GrideShip" z="-1km" comment="Create some more distance between Gride and the monument, so that the ship has more time to lock on."/>
              <rotation yaw="180deg" comment="Otherwise she'd be facing the wrong direction."/>
            </warp>
          </actions>
        </cue>

        <cue name="Ch7_Gride_Eject_Player_Ship" instantiate="true">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <find_object_component name="$DockedShips" object="$GrideShip" class="class.ship" owner="faction.player" includeobjects="true" multiple="true" docked="true"/>
            <do_if value="$DockedShips.count">
              <debug_text text="'Docked ships found: ' + $DockedShips" chance="$DebugChance"/>
              <do_for_each in="$DockedShips" name="$CurrentDockedShip">
                <warp object="$CurrentDockedShip" sector="$GrideShip.sector">
                  <position space="$GrideShip.sector" object="$GrideShip" y="50m"/>
                  <rotation yaw="180deg"/>
                </warp>
              </do_for_each>
            </do_if>
            <do_else>
              <debug_text text="'No docked ship found.'" chance="$DebugChance"/>
            </do_else>
            <set_object_docking_enabled object="$GrideShip" enabled="false"/>
          </actions>
        </cue>

        <cue name="Ch7_Battle_Wild_Buccaneers_Appear">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <debug_text text="'BUC closing in.'" chance="$DebugChance"/>
            <!-- Make Buccaneers move to battlefield position -->
            <create_order id="'MoveWait'" object="$BuccaneerFlagship" default="true">
              <param name="destination" value="[$ParanidMonumentSector, $MonumentBattlefield]"/>
            </create_order>
            <cancel_all_orders object="$BuccaneerFlagship"/>
          </actions>
        </cue>

        <cue name="Ch7_Battle_Buccaneer_Flagship_Launch_Drone_Swarm" instantiate="true" comment="Signal with $HostileToPlayer and $DroneSwarmMacro">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <debug_text text="'$BuccaneerFlagship was signalled to launch drones with this macro: ' + $DroneSwarmMacro" chance="$DebugChance"/>
            <debug_text text="'$BuccaneerFlagship can carry up to ' + $BuccaneerFlagship.units.maxcount + ' drones.'" chance="$DebugChance"/>
            <debug_text text="'$BuccaneerFlagship currently carries ' + $BuccaneerFlagship.units.count + ' drones.'" chance="$DebugChance"/>

            <!-- If there are units in the ship's hold, remove them, so we can fill it with our specific macros. -->
            <do_if value="$BuccaneerFlagship.units.count">
              <remove_units object="$BuccaneerFlagship" category="unitcategory.defence" mk="1" exact="$BuccaneerFlagship.units.count"/>
            </do_if>

            <add_units object="$BuccaneerFlagship" macro="$DroneSwarmMacro" exact="$BuccaneerFlagship.units.maxcount - $BuccaneerFlagship.units.count"/>

            <do_all exact="$BuccaneerFlagship.units.maxcount" counter="$i">
              <launch_drone name="$LastLaunchedBuccaneerDrone" object="$BuccaneerFlagship" macro="$DroneSwarmMacro" exact="1"/>

              <do_if value="$LastLaunchedBuccaneerDrone != null">
                <debug_text text="'Drone launched: ' + $LastLaunchedBuccaneerDrone" chance="$DebugChance"/>
                <create_order id="'Attack'" object="$LastLaunchedBuccaneerDrone" immediate="true">
                  <param name="primarytarget" value="$ParanidFleets.random"/>
                  <param name="secondarytargets" value="[$ParanidFleets]"/>
                  <param name="pursuetargets" value="true"/>
                  <param name="checkrelation" value="false"/>
                </create_order>
                <do_if value="$HostileToPlayer == true">
                  <set_relation_boost object="$LastLaunchedBuccaneerDrone" faction="faction.player" value="-1.0" decay="0" silent="true"/>
                </do_if>
                <add_to_group groupname="$BuccaneerDrones" object="$LastLaunchedBuccaneerDrone"/>
                <set_object_relation_behaviour object="$LastLaunchedBuccaneerDrone" disable="true"/>
              </do_if>

              <do_else>
                <debug_text text="'Drone launch failed.'" chance="$DebugChance"/>
              </do_else>
            </do_all>
          </actions>
        </cue>

        <cue name="Ch7_Battle_End_Detonate_Drones">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <cues>
            <cue name="Ch7_Battle_End_Detonate_Drones_Interval" instantiate="true" checkinterval="0.2s">
              <conditions>
                <check_value value="true"/>
              </conditions>
              <actions>
                <do_if value="$BuccaneerDrones.count">
                  <destroy_object object="$BuccaneerDrones.{1}" explosion="true"/>
                </do_if>
                <do_else>
                  <cancel_cue cue="Ch7_Battle_End_Detonate_Drones"/>
                </do_else>
              </actions>
            </cue>
          </cues>
        </cue>

        <cue name="Ch7_Music_1">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <play_music music="'music_story_paranid_monument_fight_1'" comment="200s"/>
          </actions>
          <cues>
            <cue name="Ch7_Music_1_Stop">
              <actions>
              </actions>
            </cue>
          </cues>
        </cue>

        <cue name="Ch7_Music_2">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <play_music music="'music_story_paranid_monument_fight_2'" comment="172s"/>
          </actions>
          <delay exact="172s"/>
          <actions>
            <play_music music="'music_story_paranid_monument_fight_3'" comment="157s"/>
          </actions>
        </cue>

        <!-- Chapter 7 Option 1: Unification -->

        <cue name="Ch7_1_Force">
          <force name="Plot_Paranid_Ch7_1">
            <signal_cue_instantly cue="Ch7_Debug_Setup"/>
            <signal_cue_instantly cue="Force_Chapter" param="Ch7_1_Unification"/>
          </force>
        </cue>

        <cue name="Ch7_1_Unification">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <debug_text text="'Starting part ' + this" chance="$DebugChance"/>
            <set_value name="$CurrentPartCue" exact="this"/>
          </actions>
          <cues>

            <cue name="Ch7_1_Initialise">
              <actions>
                <signal_cue cue="Ch7_1_Introduction"/>
              </actions>
            </cue>

            <cue name="Ch7_1_Gride_Shoot_Torpedoes">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <!-- Put someone else in the pilot seat. Gride doesn't have the necessary voice lines. This is a failsafe in case something went wrong in Chapter 6. -->
                <do_if value="$GrideShip.pilot == null">
                  <create_cue_actor name="$GrideReliefPilot" cue="$MissionCue">
                    <select race="race.paranid" tags="tag.elitepilot"/>
                    <owner exact="faction.buccaneers"/>
                  </create_cue_actor>
                  <assign_control_entity object="$GrideShip" post="controlpost.aipilot" actor="$GrideReliefPilot" transfer="true"/>
                </do_if>

                <!-- Find the monument window and/or door -->
                <find_object name="$ParanidMonument" macro="macro.landmarks_par_monument_01_macro" space="player.galaxy"/>
                <find_object_component name="$ParanidMonumentEntranceWindow" object="$ParanidMonument" macro="macro.positiondummy4_macro" multiple="false" required="true"/>
                <find_object_component name="$ParanidMonumentEntranceDoors" object="$ParanidMonument" macro="macro.positiondummy1_macro" multiple="false" required="true"/>

                <!-- To be able to shoot at the monument, she needs to already be in a maneuver. If we don't have her move first, she'll do a pass and only attack on the second run. -->
                <cancel_all_orders object="$GrideShip"/>
                <create_position name="$ParanidMonumentEntranceDoorsPosition" space="$ParanidMonument.sector" object="$ParanidMonumentEntranceDoors"/>
                <create_position name="$FlyAroundMonumentPosition" x="$ParanidMonumentEntranceDoorsPosition.x - 2km" y="$ParanidMonumentEntranceDoorsPosition.y" z="$ParanidMonumentEntranceDoorsPosition.z"/>
                <!--<create_object macro="macro.env_deco_nav_beacon_t1_mission_macro" owner="faction.player" sector="$ParanidMonument.sector" name="$DebugBeacon">
                  <position value="$FlyAroundMonumentPosition"/>
                </create_object>-->
                <!--<create_order id="'MoveWait'" object="$GrideShip" immediate="true">
                  <param name="destination" value="[$ParanidMonument.sector, $FlyAroundMonumentPosition]"/>
                  <param name="debugchance" value="100"/>
                </create_order>
              </actions>
              <delay exact="500ms"/>
              <actions>-->
                <!-- Experimental order, param 'forceprimarytarget' is new -->
                <!--<create_order id="'Attack'" name="$GrideShootMonument" object="$GrideShip" immediate="true">
                  <param name="primarytarget" value="$ParanidMonumentEntranceDoors"/>
                  <param name="minrange" value="1m"/>
                  <param name="checkrelation" value="false"/>
                  <param name="forceprimarytarget" value="true"/>
                  <param name="debugchance" value="100"/>
                </create_order>-->
                <set_value name="$InvinciblePlayerShip" exact="player.entity.ship"/>
                <set_object_min_hull object="$InvinciblePlayerShip" exact="10"/>
                <shoot missiles="true" object="$GrideShip"/>
              </actions>
              <delay exact="3s"/>
              <actions>
                <stop_shooting missiles="true" object="$GrideShip"/>
                <create_order id="'AssignCommander'" object="$GrideShip" immediate="true">
                  <param name="commander" value="$BuccaneerFlagship"/>
                  <param name="assignment" value="assignment.defence"/>
                  <param name="cancelorders" value="true"/>
                </create_order>
              </actions>
              <delay exact="7s"/>
              <actions>
                <set_object_min_hull object="$InvinciblePlayerShip" exact="0"/>
              </actions>
            </cue>

            <cue name="Ch7_1_Battle_Start">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <debug_text text="'Giving initial attack orders to make HOP and PAR fight.'" chance="$DebugChance"/>

                <add_to_group groupname="$ParanidFleets" group="$HolyOrderFleet"/>
                <add_to_group groupname="$ParanidFleets" group="$GodrealmFleet"/>

                <!-- In case they are still set to be invisible -->
                <do_for_each in="$ParanidFleets" name="$CurrentShip">
                  <set_object_radar_visible object="$CurrentShip" visible="true"/>
                </do_for_each>
                <!-- Make Godrealm and Holy Order hostile against each other. -->
                <do_for_each in="$GodrealmFleet" name="$CurrentShip">
                  <do_for_each in="$HolyOrderFleet" name="$CurrentEnemyShip">
                    <set_relation_boost object="$CurrentShip" otherobject="$CurrentEnemyShip" value="-1.0" decay="0"/>
                  </do_for_each>
                </do_for_each>
                <!-- Make Godrealm attack Holy Order -->
                <do_for_each in="$GodrealmFleet" name="$CurrentShip">
                  <cancel_all_orders object="$CurrentShip"/>
                  <create_order id="'Attack'" name="$AttackHolyOrder" object="$CurrentShip" immediate="true">
                    <param name="primarytarget" value="$HolyOrderFleet.random"/>
                    <param name="secondarytargets" value="[$HolyOrderFleet]"/>
                    <param name="pursuetargets" value="true"/>
                    <param name="checkrelation" value="false"/>
                  </create_order>
                </do_for_each>
                <!-- Make Holy Order attack Godrealm -->
                <do_for_each in="$HolyOrderFleet" name="$CurrentShip">
                  <cancel_all_orders object="$CurrentShip"/>
                  <create_order id="'Attack'" name="$AttackGodrealm" object="$CurrentShip" immediate="true">
                    <param name="primarytarget" value="$GodrealmFleet.random"/>
                    <param name="secondarytargets" value="[$GodrealmFleet]"/>
                    <param name="pursuetargets" value="true"/>
                    <param name="checkrelation" value="false"/>
                  </create_order>
                </do_for_each>
                <!-- Make Kromancketslat and Godrealm hostile against each other. -->
                <do_for_each in="$GodrealmFleet" name="$CurrentGodrealmShip">
                  <set_relation_boost object="$CurrentGodrealmShip" otherobject="$KroShip" value="-1.0" decay="0"/>
                </do_for_each>
                <!-- Make Kromancketslat and a Godrealm fighter ship attack each other -->
                <cancel_all_orders object="$KroShip"/>
                <do_all exact="$GodrealmFleet.count" counter="$i">
                  <do_if value="$GodrealmFleet.{$i}.type == shiptype.fighter">
                    <create_order id="'Attack'" object="$GodrealmFleet.{$i}" immediate="true">
                      <param name="primarytarget" value="$KroShip"/>
                      <param name="secondarytargets" value="[$HolyOrderFleet]"/>
                      <param name="pursuetargets" value="true"/>
                      <param name="checkrelation" value="false"/>
                    </create_order>
                    <create_order id="'Attack'" object="$KroShip" immediate="true">
                      <param name="primarytarget" value="$GodrealmFleet.{$i}"/>
                      <param name="secondarytargets" value="[$GodrealmFleet]"/>
                      <param name="pursuetargets" value="true"/>
                      <param name="checkrelation" value="false"/>
                    </create_order>
                    <break/>
                  </do_if>
                </do_all>
              </actions>
            </cue>

            <cue name="Ch7_1_Battle_Finale">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <!-- Make all invulnerable ships vulnerable again -->
                <do_for_each in="$AllFleets" name="$CurrentShip">
                  <set_object_min_hull object="$CurrentShip" exact="0"/>
                  <set_object_min_shield object="$CurrentShip" exact="0"/>
                  <!-- And make all ships visible -->
                  <set_object_radar_visible object="$CurrentShip" visible="true"/>
                </do_for_each>

                <!-- ... actually, Kromancketslat should stay invulnerable. -->
                <set_object_min_hull object="$KroShip" min="70"/>

                <!-- ... and Xatenmanckett, too. -->
                <set_object_min_hull object="$GodrealmFlagship" min="20"/>

                <debug_text text="'Make HOP and PAR turn on BUC.'" chance="$DebugChance"/>

                <!-- Make HOP and PAR ships friendly again, and make PAR ships friendly towards player and Kromancketslat again. -->
                <do_for_each in="$GodrealmFleet" name="$CurrentGodrealmShip">
                  <do_for_each in="$HolyOrderFleet" name="$CurrentHolyOrderShip">
                    <set_relation_boost object="$CurrentGodrealmShip" otherobject="$CurrentHolyOrderShip" value="1.0" decay="0"/>
                  </do_for_each>
                  <set_relation_boost object="$CurrentGodrealmShip" faction="faction.player" value="1.0" decay="0" silent="true"/>
                  <set_relation_boost object="$CurrentGodrealmShip" otherobject="$KroShip" value="1.0" decay="0"/>
                </do_for_each>

                <!-- Kromancketslat is now part of the Paranid fleets. -->
                <add_to_group groupname="$ParanidFleets" object="$KroShip"/>

                <!-- Make BUC hostile towards HOP, PAR, Kromancketslat and the player. -->
                <do_for_each in="$BuccaneerFleet" name="$CurrentBuccaneerShip">
                  <do_for_each in="$ParanidFleets" name="$CurrentParanidShip">
                    <set_relation_boost object="$CurrentBuccaneerShip" otherobject="$CurrentParanidShip" value="-1.0"/>
                  </do_for_each>
                  <set_relation_boost object="$CurrentBuccaneerShip" faction="faction.player" value="-1.0" decay="0" silent="true"/>
                </do_for_each>

                <!-- Change orders for HOP, PAR and Kromancketslat. -->
                <do_for_each in="$ParanidFleets" name="$CurrentShip">
                  <cancel_all_orders object="$CurrentShip"/>
                  <create_order id="'Attack'" name="$AttackBuccaneers" object="$CurrentShip" immediate="true">
                    <param name="primarytarget" value="$BuccaneerFleet.random"/>
                    <param name="secondarytargets" value="[$BuccaneerFleet]"/>
                    <param name="pursuetargets" value="true"/>
                    <param name="checkrelation" value="false"/>
                  </create_order>
                </do_for_each>

                <!-- Specifically tell the flagships to fight each other -->
                <do_if value="$CipherShip != null and $CipherShip.isoperational">
                  <create_order id="'Attack'" object="$CipherShip" immediate="true">
                    <param name="primarytarget" value="$BuccaneerFlagship"/>
                    <param name="secondarytargets" value="[$BuccaneerFleet]"/>
                    <param name="pursuetargets" value="true"/>
                    <param name="checkrelation" value="false"/>
                  </create_order>
                </do_if>
                <do_if value="$GodrealmFlagship != null and $GodrealmFlagship.isoperational">
                  <create_order id="'Attack'" object="$GodrealmFlagship" immediate="true">
                    <param name="primarytarget" value="$BuccaneerFlagship"/>
                    <param name="secondarytargets" value="[$BuccaneerFleet]"/>
                    <param name="pursuetargets" value="true"/>
                    <param name="checkrelation" value="false"/>
                  </create_order>
                </do_if>
                <do_if value="$BuccaneerFlagship != null">
                  <create_order id="'Attack'" object="$BuccaneerFlagship" immediate="true">
                    <param name="primarytarget" value="$GodrealmFlagship"/>
                    <param name="secondarytargets" value="[$ParanidFleets]"/>
                    <param name="pursuetargets" value="true"/>
                    <param name="checkrelation" value="false"/>
                  </create_order>
                </do_if>

                <!-- Specifically tell Gride's ship to attack the Godrealm flagship, because she carries torpedoes -->
                <do_if value="$GrideShip != null">
                  <create_order id="'Attack'" object="$GrideShip" immediate="true">
                    <param name="primarytarget" value="$GodrealmFlagship"/>
                    <param name="secondarytargets" value="[$GodrealmFleet]"/>
                    <param name="pursuetargets" value="true"/>
                    <param name="checkrelation" value="false"/>
                  </create_order>
                </do_if>
              </actions>
              <delay exact="30s"/>
              <actions>
                <do_if value="$BuccaneerFlagship.isoperational">
                  <!-- Make the Buccaneer Flagship launch its first swarm of drones. -->
                  <set_value name="$DroneSwarmMacro" exact="macro.ship_gen_s_fightingdrone_01_a_macro"/>
                  <set_value name="$HostileToPlayer" exact="true"/>
                  <signal_cue cue="Ch7_Battle_Buccaneer_Flagship_Launch_Drone_Swarm"/>
                </do_if>
              </actions>
              <delay exact="2min"/>
              <actions>
                <do_if value="$BuccaneerFlagship.isoperational">
                  <!-- Make the Buccaneer Flagship launch its second swarm of drones. -->
                  <set_value name="$DroneSwarmMacro" exact="macro.ship_gen_s_fightingdrone_explosive_01_a_macro"/>
                  <signal_cue cue="Ch7_Battle_Buccaneer_Flagship_Launch_Drone_Swarm"/>
                </do_if>
              </actions>
            </cue>

            <cue name="Ch7_1_Introduction">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <cues>

                <cue name="Ch7_1_Introduction_Dal_Speak">
                  <cues>
                    <cue name="Ch7_1_Dal_Speak_701_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$DalBusta"/>
                      <param name="CutsceneKey"       value="$DalCutsceneKey"/>
                      <param name="Lines"             value="[[if player.entity.isfemale then 30220702 else 30220701],[30220703]]"/>
                      <param name="EndSignalCue"      value="Ch7_1_Introduction_Delay_1"/>
                      <!--           
                                   I hope you made the right choice.
                                   Gride might not take this well.
                                  -->
                    </cue>
                  </cues>
                </cue>

                <cue name="Ch7_1_Introduction_Delay_1">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <delay exact="5s"/>
                  <actions>
                    <signal_cue cue="Ch7_1_Introduction_Gride_Speak_1"/>
                  </actions>
                </cue>

                <cue name="Ch7_1_Introduction_Gride_Speak_1">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <cues>
                    <cue name="Ch7_1_Gride_Speak_701_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$GrideActor"/>
                      <param name="CutsceneKey"       value="$GrideCutsceneKey"/>
                      <param name="Lines"             value="[[30220701],[30220702, 0.6s]]"/>
                      <param name="EndSignalCue"      value="Ch7_1_Introduction_Delay_2"/>
                      <!--
                                   (relieved)Finally!
                                   Now, let us reap the rewards from all our efforts.
                      -->
                    </cue>
                  </cues>
                </cue>

                <cue name="Ch7_1_Introduction_Delay_2">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <delay exact="5s"/>
                  <actions>
                    <signal_cue cue="Ch7_1_Introduction_Gride_Speak_2"/>
                  </actions>
                </cue>

                <cue name="Ch7_1_Introduction_Gride_Speak_2">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <cues>
                    <cue name="Ch7_1_Gride_Speak_703_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$GrideActor"/>
                      <param name="CutsceneKey"       value="$GrideCutsceneKey"/>
                      <param name="Lines"             value="[[30220703],[30220704, 0.6s]]"/>
                      <param name="EndSignalCue"      value="Ch7_1_Introduction_Bamboozled_Speak_1"/>
                      <!--
                                   Well?
                                   (pleasantly, yet piercing)Why this hesitation?
                      -->
                    </cue>
                  </cues>
                </cue>

                <cue name="Ch7_1_Introduction_Bamboozled_Speak_1">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <speak actor="$DalBusta" priority="100">
                      <text line="30220704" comment="(sarcastic)Sorry dear, we've decided to rewrite the script a bit."/>
                    </speak>
                  </actions>
                </cue>

                <cue name="Ch7_1_Introduction_Bamboozled_Speak_2">
                  <conditions>
                    <event_speak_finished actor="$DalBusta" line="30220704"/>
                  </conditions>
                  <actions>
                    <speak actor="$GrideActor" priority="100">
                      <text line="30220705" comment="(irritated)What?!" delay="1s"/>
                    </speak>
                  </actions>
                </cue>

                <cue name="Ch7_1_Introduction_Bamboozled_Speak_3">
                  <conditions>
                    <event_speak_finished actor="$GrideActor" line="30220705"/>
                  </conditions>
                  <actions>
                    <signal_cue cue="Ch7_1_Gride_Shoot_Torpedoes"/>
                    <speak actor="$GrideActor" priority="100">
                      <text line="30220706" comment="(flaring up)This isn't over!" delay="1s"/>
                      <text line="30220707" comment="(flaring up)I'll just have to deal with this myself." delay="0.6s"/>
                    </speak>
                  </actions>
                  <delay exact="5s"/>
                  <actions>
                    <signal_cue cue="Ch7_1_Introduction_End_Speak"/>
                  </actions>
                </cue>

                <cue name="Ch7_1_Introduction_End_Speak">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <cues>
                    <cue name="Ch7_1_Dal_Speak_705_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$DalBusta"/>
                      <param name="CutsceneKey"       value="$DalCutsceneKey"/>
                      <param name="Lines"             value="[[30220705],[30220706],[30220707, 1s]]"/>
                      <param name="EndSignalCue"      value="Ch7_1_Firestarter"/>
                      <!--
                                   There she goes.
                                   At least those explosions only seem to have caused a bit of surface damage.
                                   Wait, that can't be what she meant by 'deal with it'.
                      -->
                    </cue>
                  </cues>
                </cue>
              </cues>
            </cue>

            <cue name="Ch7_1_Firestarter">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <cues>
                <cue name="Ch7_1_Firestarter_Speak_1">
                  <actions>
                    <speak actor="$RikActor" priority="100">
                      <text line="30220701" comment="What was that sound, legate?" delay="3s"/>
                      <text line="30220702" comment="Were these 'negotiations' a ruse to attack our holy cathedral?" delay="0.6s"/>
                    </speak>
                  </actions>
                </cue>
                <cue name="Ch7_1_Firestarter_Speak_2">
                  <conditions>
                    <event_speak_finished actor="$RikActor" line="30220701"/>
                  </conditions>
                  <actions>
                    <speak actor="$XatActor" priority="100">
                      <text line="30220701" comment="Have you led Us into a trap, Kromancketslat?" delay="1s"/>
                      <text line="30220702" comment="Even if it is our last deed, you shall die for this treachery, apostate!" delay="0.6s"/>
                    </speak>
                  </actions>
                </cue>
                <cue name="Ch7_1_Firestarter_Speak_3">
                  <conditions>
                    <event_speak_finished actor="$XatActor" line="30220701"/>
                  </conditions>
                  <actions>
                    <signal_cue cue="Ch7_1_Battle_Start"/>
                    <signal_cue cue="Ch7_Music_1"/>
                    <speak actor="$RikActor" priority="100">
                      <text line="30220703" comment="Honor guard, to me!" delay="1s"/>
                      <text line="30220704" comment="Protect the Prophet from those heathens!" delay="0.6s"/>
                    </speak>
                  </actions>
                </cue>
              </cues>
            </cue>

            <cue name="Ch7_1_Rescue">
              <conditions>
                <event_speak_finished actor="$RikActor" line="30220703"/>
              </conditions>
              <actions>
                <set_value name="$ObjectiveStep" operation="add"/>
                <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.protect" text="{30220,102}" object="$KroShip" updatebriefing="true" comment="Protect: Kromancketslat"/>
              </actions>
              <cues>
                <cue name="Ch7_1_Dal_Speak_708_Ref" ref="md.LIB_Dialog.Speak_Actor">
                  <param name="Actor"             value="$DalBusta"/>
                  <param name="CutsceneKey"       value="$DalCutsceneKey"/>
                  <param name="Lines"             value="[[30220708],[30220709, 0.6s]]"/>
                  <param name="EndSignalCue"      value="Ch7_1_Rescue_Approach"/>
                  <!--
                                   (flustered)What's happening?
                                   (flustered)This wasn't part of the plan!
                      -->
                </cue>
                <cue name="Ch7_1_Rescue_Approach">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <cues>
                    <cue name="Approach_Monument_Battle_Ref" ref="md.LIB_Generic.ApproachObject_Handler">
                      <param name="ApproachTarget"    value="$KroShip"/>
                      <param name="ApproachDistance"  value="15km"/>
                      <param name="SuccessSignalCue"  value="Ch7_1_Protect_Kromancketslat"/>
                    </cue>
                  </cues>
                </cue>
              </cues>
            </cue>

            <cue name="Ch7_1_Protect_Kromancketslat">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <signal_cue cue="Ch7_Battle_Wild_Buccaneers_Appear"/>
              </actions>
              <cues>
                <cue name="Ch7_1_Protect_Kromancketslat_Rik_Speak">
                  <actions>
                    <speak actor="$RikActor" priority="100">
                      <text line="30220705" comment="(distraught)Keep them away!"/>
                    </speak>
                    <!-- Temporarily make player and Godrealm fleet enemies, so players don't get confused-->
                    <do_for_each in="$GodrealmFleet" name="$CurrentGodrealmShip">
                      <set_relation_boost object="$CurrentGodrealmShip" faction="faction.player" value="-1.0" decay="0" silent="true"/>
                    </do_for_each>
                    <!-- Already lock Holy Order fleet as allies of the player here. -->
                    <do_for_each in="$HolyOrderFleet" name="$CurrentHolyOrderShip">
                      <set_relation_boost object="$CurrentHolyOrderShip" faction="faction.player" value="1.0" decay="0" silent="true"/>
                    </do_for_each>
                  </actions>
                </cue>
                <cue name="Ch7_1_Protect_Kromancketslat_Duke_Speak">
                  <conditions>
                    <event_speak_finished actor="$RikActor" line="30220705"/>
                  </conditions>
                  <cues>
                    <cue name="Ch7_1_Duke_Dal_Speak_701_Ref" ref="md.LIB_Dialog.Speak_Actors">
                      <param name="Actor"             value="[$Duke, $DalBusta]"/>
                      <param name="CutsceneKey"       value="[$DukeCutsceneKey, $DalCutsceneKey]"/>
                      <param name="Lines"             value="[
                                                          [[if (player.entity.race == race.paranid) then 30220702 else if player.entity.isfemale then 30220704 else 30220701],[30220703, 0.6s]],
                                                          [[30220710, 0.6s]]
                                                         ]"/>
                      <param name="EndSignalCue"      value="[null, Ch7_1_Wild_Buccaneers]"/>
                      <!--           
                                   (calm)Your presence is not required, outsider. / (calm)Your presence is not required, brother.
                                   (calm)This has been my surpassing failure.
                                   Does he seriously want to die?!
                                  -->
                    </cue>
                  </cues>
                </cue>
              </cues>
            </cue>

            <cue name="Ch7_1_Wild_Buccaneers">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <cues>
                <cue name="Ch7_1_Wild_Buccaneers_Gride_Speak">
                  <actions>
                    <speak actor="$GrideActor" priority="100">
                      <text line="30220708" comment="(grandiosely, taunting)Worthless, three-eyed imbeciles!" delay="2s"/>
                      <text line="30220709" comment="(grandiosely, sardonically)You've all fallen for my trap!"/>
                    </speak>
                  </actions>
                </cue>
                <cue name="Ch7_1_Wild_Buccaneers_Rik_Speak_2">
                  <conditions>
                    <event_speak_finished actor="$GrideActor" line="30220708"/>
                  </conditions>
                  <actions>
                    <speak actor="$RikActor" priority="100">
                      <text line="30220706" comment="Legate Xatenmanckett, cease your attack!" delay="1s"/>
                    </speak>
                  </actions>
                </cue>
                <cue name="Ch7_1_Wild_Buccaneers_Gride_Speak_2">
                  <conditions>
                    <event_speak_finished actor="$RikActor" line="30220706"/>
                  </conditions>
                  <actions>
                    <speak actor="$GrideActor" priority="100">
                      <text line="30220710" comment="(grandiosely, maliciously)Your deaths will put an end to this charade!" delay="1s"/>
                      <text line="30220711" comment="(grandiosely, maliciously)The realms of the Paranid will fall one by one!"/>
                    </speak>
                  </actions>
                </cue>
                <cue name="Ch7_1_Wild_Buccaneers_Rik_Speak_3">
                  <conditions>
                    <event_speak_finished actor="$GrideActor" line="30220710"/>
                  </conditions>
                  <actions>
                    <speak actor="$RikActor" priority="100">
                      <text line="30220707" comment="Our enemies have tried to sabotage the negotiations all along!" delay="1s"/>
                    </speak>
                  </actions>
                </cue>
              </cues>
            </cue>

            <cue name="Ch7_1_Turning_Tides">
              <conditions>
                <event_speak_finished actor="$RikActor" line="30220707"/>
              </conditions>
              <actions>
                <!-- Ch7_1_Battle_Finale also makes all involved Paranid ships friendly towards the player again -->
                <signal_cue cue="Ch7_1_Battle_Finale"/>

                <signal_cue cue="Ch7_Music_2"/>

                <set_value name="$ObjectiveStep" operation="add"/>
                <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.wait" text="{30220,2008}" updatebriefing="true" comment="Wait: Remain Vigilant"/>
              </actions>
              <cues>
                <cue name="Ch7_1_Turning_Tides_Xat_Speak">
                  <actions>
                    <speak actor="$XatActor" priority="100">
                      <text line="30220703" comment="It appears that we need to put aside our quarrel for the time being, Rikmanckassor." delay="1s"/>
                      <text line="30220704" comment="These unholy creatures require our attention."/>
                      <text line="30220705" comment="Xatenmanckett to bridge!" delay="1s"/>
                      <text line="30220706" comment="Full speed ahead!"/>
                    </speak>
                  </actions>
                </cue>
                <cue name="Ch7_1_Turning_Tides_Boso_Dal_Speak">
                  <conditions>
                    <event_speak_finished actor="$XatActor" line="30220703"/>
                  </conditions>
                  <cues>
                    <cue name="Ch7_1_Boso_Dal_Speak_701_Ref" ref="md.LIB_Dialog.Speak_Actors">
                      <param name="Actor"             value="[$BosoTa, $DalBusta]"/>
                      <param name="CutsceneKey"       value="[$BosoCutsceneKey, $DalCutsceneKey]"/>
                      <param name="Lines"             value="[
                                                          [[30220701],[30220702],[30220706],[if player.entity.isfemale then 30220708 else 30220707]],
                                                          [[30220711, 0.6s],[30220712]]
                                                         ]"/>
                      <param name="EndSignalCue"      value="[Ch7_1_Turning_Tides_Update_Objective, null]"/>
                      <!--           
                                   Most fortuitous!
                                   These Paranid fellows seem to take her words quite literally.
                                   I suggest a new strategy.
                                   Assistant, let the bony sticklers win!
                                   
                                   I can't believe they're actually listening to her.
                                   They really do have no concept of hyperbole.
                                  -->
                    </cue>
                  </cues>
                </cue>
                <cue name="Ch7_1_Turning_Tides_Update_Objective">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <!-- Overwrite previous wait objective. -->
                    <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.defeat" text="{30220,101}" group="$BuccaneerFleet" updatebriefing="true" comment="Defeat: Gride Orrian"/>
                  </actions>
                  <delay exact="10s"/>
                  <actions>
                    <signal_cue cue="Ch7_1_Turning_Tides_Dal_Speak"/>
                  </actions>
                </cue>
                <cue name="Ch7_1_Turning_Tides_Dal_Speak">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <cues>
                    <cue name="Ch7_1_Dal_Speak_713_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$DalBusta"/>
                      <param name="CutsceneKey"       value="$DalCutsceneKey"/>
                      <param name="Lines"             value="[[30220713],[30220714],[if player.entity.isfemale then 30220716 else 30220715]]"/>
                      <param name="EndSignalCue"      value="Ch7_1_Turning_Tides_Flagship_Hint_Delay"/>
                      <!--
                                   Well, there's no way back now.
                                   Everyone's made their choice.
                                   You need to see this through.
                      -->
                    </cue>
                  </cues>
                </cue>
                <cue name="Ch7_1_Turning_Tides_Flagship_Hint_Delay">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <delay exact="2min"/>
                  <actions>
                    <do_if value="$BuccaneerFlagship.isoperational">
                      <signal_cue cue="Ch7_1_Turning_Tides_Flagship_Hint_Dal_Speak"/>
                    </do_if>
                  </actions>
                </cue>
                <cue name="Ch7_1_Turning_Tides_Flagship_Hint_Dal_Speak">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.destroy" object="$BuccaneerFlagship" updatebriefing="true" comment="Destroy: Helianthus"/>
                  </actions>
                  <cues>
                    <cue name="Ch7_1_Dal_Speak_717_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$DalBusta"/>
                      <param name="CutsceneKey"       value="$DalCutsceneKey"/>
                      <param name="Lines"             value="[[30220717],[if player.entity.isfemale then 30220719 else 30220718]]"/>
                      <param name="EndSignalCue"      value="null"/>
                      <!--
                                   That's Gride's flagship!
                                   You'd better help the Paranid defeat it, or this whole effort was for nothing!
                      -->
                    </cue>
                    <cue name="Ch7_1_Turning_Tides_Flagship_Destroyed">
                      <conditions>
                        <event_object_destroyed object="$BuccaneerFlagship"/>
                      </conditions>
                      <actions>
                        <signal_cue cue="Ch7_Battle_End_Detonate_Drones"/>
                      </actions>
                      <delay exact="5s"/>
                      <actions>
                        <do_if value="$BuccaneerFleet.count">
                          <!-- Overwrite previous wait objective. -->
                          <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.defeat" text="{30220,101}" group="$BuccaneerFleet" updatebriefing="true" comment="Defeat: Gride Orrian"/>
                        </do_if>
                      </actions>
                    </cue>
                  </cues>
                </cue>
              </cues>
            </cue>

            <cue name="Ch7_1_Gride_Killed_Speak">
              <conditions>
                <event_object_hull_damaged object="$GrideShip"/>
                <check_value value="$GrideShip.hullpercentage le 5"/>
              </conditions>
              <actions>
                <debug_text text="'Gride final words.'" chance="$DebugChance"/>
              </actions>
              <cues>
                <cue name="Ch7_1_Gride_Speak_712_Ref" ref="md.LIB_Dialog.Speak_Actor">
                  <param name="Actor"             value="$GrideActor"/>
                  <param name="CutsceneKey"       value="$GrideCutsceneKey"/>
                  <param name="Lines"             value="[[if player.entity.isfemale then 30220713 else 30220712]]"/>
                  <param name="EndSignalCue"      value="null"/>
                  <!--
                                   (tranquil, directly to player)Well, my dear, this is it. A good way to go, I think.
                      -->
                </cue>
              </cues>
            </cue>

            <cue name="Ch7_1_Victory">
              <conditions>
                <event_object_destroyed group="$BuccaneerFleet"/>
                <check_value value="$BuccaneerFleet.count == 1"/>
              </conditions>
              <actions>
                <debug_text text="'Buccaneer fleet destroyed, make Dal and Boso say ending lines.'" chance="$DebugChance"/>
                <!-- Remove all remaining ships -->
                <do_for_each in="$AllFleets" name="$CurrentShip">
                  <cancel_all_orders object="$CurrentShip"/>
                  <create_order id="'MoveDie'" object="$CurrentShip" immediate="true"/>
                </do_for_each>

                <play_music music="'music_story_paranid_monument_fight_ending_1'"/>

                <signal_cue cue="Ch7_1_Victory_Speak"/>
              </actions>
            </cue>

            <cue name="Ch7_1_Victory_Speak">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <set_value name="$DalVictoryLines_1" exact="[[30220720],[30220721],[if player.entity.isfemale then 30220723 else 30220722]]"/>
                <!-- I can't believe that mad-woman actually did it.
                     The Paranid are fighting. Together!
                     Do you have any idea how long it's been since that last happened? -->
                <do_any>
                  <do_all>
                    <set_value name="$BosoVictoryLines" exact="[[30220703]]"/>
                    <set_value name="$DalVictoryLines_2" exact="[[30220724]]"/>
                    <!-- (sad)The venerable Argon lady sacrificed herself, Dal.
                       (quietly)She did, huh. -->
                  </do_all>
                  <do_all>
                    <set_value name="$BosoVictoryLines" exact="[[30220704], [30220705]]"/>
                    <set_value name="$DalVictoryLines_2" exact="[[30220725]]"/>
                    <!-- The venerable Argon lady performed exceptionally!
                       We need to commend her for her initiative.
                       (sighing)I don't think that's going to happen, Boso. -->
                  </do_all>
                </do_any>
                <append_to_list name="$DalVictoryLines_2" exact="[if player.entity.isfemale then 30220727 else 30220726, 1s]"/>
                <append_to_list name="$DalVictoryLines_2" exact="[if player.entity.isfemale then 30220729 else 30220728]"/>
                <!-- (sighing)Well, I guess there's nothing left for you to do out there.
                     Meet me at our headquarters and we'll discuss the path ahead. -->
              </actions>
              <cues>
                <cue name="Ch7_1_Boso_Dal_Speak_720_Ref" ref="md.LIB_Dialog.Speak_Actors">
                  <param name="Actor"             value="[$DalBusta, $BosoTa, $DalBusta]"/>
                  <param name="CutsceneKey"       value="[$DalCutsceneKey, $BosoCutsceneKey, $DalCutsceneKey]"/>
                  <param name="Lines"             value="[$DalVictoryLines_1, $BosoVictoryLines, $DalVictoryLines_2]"/>
                  <param name="EndSignalCue"      value="[null, null, Ch7_1_Handover]"/>
                </cue>
              </cues>
            </cue>

            <cue name="Ch7_1_Handover">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <remove_mission cue="$MissionCue" type="completed"/>
                <write_to_logbook category="missions" faction="faction.player" title="{30220,6001}" text="(if player.entity.isfemale then {30220,6031} else {30220,6030}) + '\n\n' + (if player.entity.isfemale then {30220,6033} else {30220,6032})"/>
                <unlock_achievement name="PLOT_PARANID"/>
                <signal_cue cue="Sinks_Unification_Stage_1"/>
              </actions>
            </cue>

          </cues>
        </cue>

        <!-- Chapter 7 Option 2: Escalation -->

        <cue name="Ch7_2_Force">
          <force name="Plot_Paranid_Ch7_2">
            <signal_cue_instantly cue="Force_Chapter" param="Ch7_2_Escalation"/>
          </force>
        </cue>

        <cue name="Ch7_2_Escalation">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <debug_text text="'Starting part ' + this" chance="$DebugChance"/>
            <set_value name="$CurrentPartCue" exact="this"/>
          </actions>
          <cues>

            <cue name="Ch7_2_Initialise">
              <actions>
                <signal_cue cue="Ch7_2_Threaten"/>
              </actions>
            </cue>

            <cue name="Ch7_2_Gride_Join_Fleet">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <!-- Put someone else in the pilot seat. Gride doesn't have the necessary voice lines. This is a failsafe in case something went wrong in Chapter 6. -->
                <do_if value="$GrideShip.pilot == null">
                  <create_cue_actor name="$GrideReliefPilot" cue="$MissionCue">
                    <select race="race.paranid" tags="tag.elitepilot"/>
                    <owner exact="faction.buccaneers"/>
                  </create_cue_actor>
                  <assign_control_entity object="$GrideShip" post="controlpost.aipilot" actor="$GrideReliefPilot" transfer="true"/>
                </do_if>

                <create_order id="'AssignCommander'" object="$GrideShip" immediate="true">
                  <param name="commander" value="$BuccaneerFlagship"/>
                  <param name="assignment" value="assignment.defence"/>
                  <param name="cancelorders" value="true"/>
                </create_order>
              </actions>
            </cue>

            <cue name="Ch7_2_Battle_Start">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <debug_text text="'Giving initial attack orders to make HOP and PAR attack Kromancketslat (poor guy).'" chance="$DebugChance"/>

                <add_to_group groupname="$ParanidFleets" group="$HolyOrderFleet"/>
                <add_to_group groupname="$ParanidFleets" group="$GodrealmFleet"/>

                <!-- In case they are still set to be invisible. Also make all ships attack Kromancketslat. -->
                <do_for_each in="$ParanidFleets" name="$CurrentShip">
                  <set_object_radar_visible object="$CurrentShip" visible="true"/>
                  <cancel_all_orders object="$CurrentShip"/>
                  <set_relation_boost object="$CurrentShip" otherobject="$KroShip" value="-1.0" decay="0"/>
                  <create_order id="'Attack'" name="$AttackKro" object="$CurrentShip" immediate="true">
                    <param name="primarytarget" value="$KroShip"/>
                    <param name="pursuetargets" value="true"/>
                    <param name="checkrelation" value="false"/>
                  </create_order>
                </do_for_each>

                <!-- Make HOP and PAR friendly towards each other. -->
                <do_for_each in="$GodrealmFleet" name="$CurrentGodrealmShip">
                  <do_for_each in="$HolyOrderFleet" name="$CurrentHolyOrderShip">
                    <set_relation_boost object="$CurrentGodrealmShip" otherobject="$CurrentHolyOrderShip" value="1.0" decay="0"/>
                  </do_for_each>
                </do_for_each>

                <!-- Make Kromancketslat attack a Godrealm fighter ship. -->
                <cancel_all_orders object="$KroShip"/>
                <do_all exact="$GodrealmFleet.count" counter="$i">
                  <do_if value="$GodrealmFleet.{$i}.type == shiptype.fighter">
                    <create_order id="'Attack'" object="$GodrealmFleet.{$i}" immediate="true">
                      <param name="primarytarget" value="$KroShip"/>
                      <param name="secondarytargets" value="[$HolyOrderFleet]"/>
                      <param name="pursuetargets" value="true"/>
                      <param name="checkrelation" value="false"/>
                    </create_order>
                    <create_order id="'Attack'" object="$KroShip" immediate="true">
                      <param name="primarytarget" value="$GodrealmFleet.{$i}"/>
                      <param name="secondarytargets" value="[$GodrealmFleet, $HolyOrderFleet]"/>
                      <param name="pursuetargets" value="true"/>
                      <param name="checkrelation" value="false"/>
                    </create_order>
                    <break/>
                  </do_if>
                </do_all>
              </actions>
            </cue>

            <cue name="Ch7_2_Battle_Finale">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <!-- Make all invulnerable ships vulnerable again -->
                <do_for_each in="$AllFleets" name="$CurrentShip">
                  <set_object_min_hull object="$CurrentShip" exact="0"/>
                  <set_object_min_shield object="$CurrentShip" exact="0"/>
                  <!-- And make all ships visible -->
                  <set_object_radar_visible object="$CurrentShip" visible="true"/>
                </do_for_each>

                <!-- ... actually, Kromancketslat should stay invulnerable. -->
                <set_object_min_hull object="$KroShip" min="70"/>

                <!-- ... and Gride, too. -->
                <set_object_min_hull object="$GrideShip" min="70"/>

                <!-- ... and Gride's flagship. -->
                <set_object_min_hull object="$BuccaneerFlagship" min="20"/>

                <debug_text text="'Make HOP and PAR turn on BUC.'" chance="$DebugChance"/>

                <!-- Kromancketslat becomes the Pirate Duke and joins the Buccaneers faction and fleet. -->
                <set_owner object="$Duke" faction="faction.buccaneers"/>
                <set_entity_overrides entity="$Duke" title="'{30220,113}'"/>
                <set_owner object="$KroShip" faction="faction.buccaneers" overridenpc="true"/>
                <add_to_group groupname="$BuccaneerFleet" object="$KroShip"/>

                <!-- Make HOP and PAR attack BUC. -->
                <do_for_each in="$ParanidFleets" name="$CurrentParanidShip">
                  <do_for_each in="$BuccaneerFleet" name="$CurrentBuccaneerShip">
                    <set_relation_boost object="$CurrentParanidShip" otherobject="$CurrentBuccaneerShip" value="-1.0" decay="0"/>
                  </do_for_each>
                  <cancel_all_orders object="$CurrentParanidShip"/>
                  <create_order id="'Attack'" name="$AttackBuccaneers" object="$CurrentParanidShip" immediate="true">
                    <param name="primarytarget" value="$BuccaneerFleet.random"/>
                    <param name="secondarytargets" value="[$BuccaneerFleet]"/>
                    <param name="pursuetargets" value="true"/>
                    <param name="checkrelation" value="false"/>
                  </create_order>
                </do_for_each>

                <!-- Make BUC friendly towards player. -->
                <do_for_each in="$BuccaneerFleet" name="$CurrentBuccaneerShip">
                  <set_relation_boost object="$CurrentBuccaneerShip" faction="faction.player" value="1.0" decay="0" silent="true"/>
                </do_for_each>

                <!-- Specifically tell the flagships to fight each other -->
                <do_if value="$CipherShip != null and $CipherShip.isoperational">
                  <create_order id="'Attack'" object="$CipherShip" immediate="true">
                    <param name="primarytarget" value="$BuccaneerFlagship"/>
                    <param name="secondarytargets" value="[$BuccaneerFleet]"/>
                    <param name="pursuetargets" value="true"/>
                    <param name="checkrelation" value="false"/>
                  </create_order>
                </do_if>
                <do_if value="$GodrealmFlagship != null and $GodrealmFlagship.isoperational">
                  <create_order id="'Attack'" object="$GodrealmFlagship" immediate="true">
                    <param name="primarytarget" value="$BuccaneerFleet.random" comment="Not making the Godrealm flagship attack the Buccaneer flagship immediately gives the Buccaneers a better chance."/>
                    <param name="secondarytargets" value="[$BuccaneerFleet]"/>
                    <param name="pursuetargets" value="true"/>
                    <param name="checkrelation" value="false"/>
                  </create_order>
                </do_if>
                <do_if value="$BuccaneerFlagship != null">
                  <create_order id="'Attack'" object="$BuccaneerFlagship" immediate="true">
                    <param name="primarytarget" value="$GodrealmFlagship"/>
                    <param name="secondarytargets" value="[$ParanidFleets]"/>
                    <param name="pursuetargets" value="true"/>
                    <param name="checkrelation" value="false"/>
                  </create_order>
                </do_if>

                <!-- Specifically tell Gride's ship to attack the Godrealm flagship, because she carries torpedoes -->
                <do_if value="$GrideShip != null">
                  <create_order id="'Attack'" object="$GrideShip" immediate="true">
                    <param name="primarytarget" value="$GodrealmFlagship"/>
                    <param name="secondarytargets" value="[$GodrealmFleet]"/>
                    <param name="pursuetargets" value="true"/>
                    <param name="checkrelation" value="false"/>
                  </create_order>
                </do_if>
              </actions>
              <delay exact="30s"/>
              <actions>
                <!-- Make the Buccaneer Flagship launch its first swarm of drones. -->
                <set_value name="$DroneSwarmMacro" exact="macro.ship_gen_s_fightingdrone_01_a_macro"/>
                <set_value name="$HostileToPlayer" exact="false"/>
                <signal_cue cue="Ch7_Battle_Buccaneer_Flagship_Launch_Drone_Swarm"/>
              </actions>
              <delay exact="60s"/>
              <actions>
                <!-- Make the Buccaneer Flagship launch its second swarm of drones. -->
                <set_value name="$DroneSwarmMacro" exact="macro.ship_gen_s_fightingdrone_explosive_01_a_macro"/>
                <signal_cue cue="Ch7_Battle_Buccaneer_Flagship_Launch_Drone_Swarm"/>
                <signal_cue cue="Ch7_2_Keep_Swarming"/>
              </actions>
            </cue>

            <cue name="Ch7_2_Keep_Swarming">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <set_value name="$DroneSwarmMacro" exact="macro.ship_gen_s_fightingdrone_01_a_macro"/>
              </actions>
              <cues>
                <cue name="Ch7_2_Periodic_Drone_Launch" instantiate="true" checkinterval="60s">
                  <conditions>
                    <check_value value="$BuccaneerDrones.count lt 30"/>
                  </conditions>
                  <actions>
                    <signal_cue cue="Ch7_Battle_Buccaneer_Flagship_Launch_Drone_Swarm"/>
                  </actions>
                </cue>
                <cue name="Ch7_2_Stop_Drone_Launch">
                  <conditions>
                    <event_object_destroyed object="$BuccaneerFlagship"/>
                  </conditions>
                  <actions>
                    <cancel_cue cue="Ch7_2_Keep_Swarming"/>
                  </actions>
                </cue>
              </cues>
            </cue>

            <cue name="Ch7_2_Threaten">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <cues>
                <cue name="Ch7_2_Threaten_Speak_1">
                  <actions>
                    <speak actor="$RikActor" priority="100">
                      <text line="30220751" comment="(shocked)The holy cathedral!" delay="2s"/>
                      <!-- This line gets delivered very bluntly, commented out. -->
                      <!--<text line="30220752" comment="(panicked)Save the high priests!" delay="0.6s"/>-->
                    </speak>
                  </actions>
                </cue>
                <cue name="Ch7_2_Threaten_Speak_2">
                  <conditions>
                    <event_speak_finished actor="$RikActor" line="30220751"/>
                  </conditions>
                  <actions>
                    <speak actor="$XatActor" priority="100">
                      <text line="30220751" comment="(cold)A trap, apostate?" delay="1s"/>
                      <text line="30220752" comment="(cold)All this effort, only to betray your kin and erase all of our futures?" delay="0.6s"/>
                    </speak>
                  </actions>
                </cue>
              </cues>
            </cue>

            <cue name="Ch7_2_Rescue">
              <conditions>
                <event_speak_finished actor="$XatActor" line="30220751"/>
              </conditions>
              <actions>
                <signal_cue cue="Ch7_Music_1"/>
                <signal_cue cue="Ch7_2_Gride_Join_Fleet"/>
                <set_value name="$ObjectiveStep" operation="add"/>
                <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.protect" text="{30220,102}" object="$KroShip" updatebriefing="true" comment="Protect: Kromancketslat"/>
              </actions>
              <cues>
                <cue name="Ch7_2_Rescue_Gride_Dal_Speak">
                  <cues>
                    <cue name="Ch7_2_Gride_Dal_Speak_803_Ref" ref="md.LIB_Dialog.Speak_Actors">
                      <param name="Actor"             value="[$GrideActor, $DalBusta]"/>
                      <param name="CutsceneKey"       value="[$GrideCutsceneKey, $DalCutsceneKey]"/>
                      <param name="Lines"             value="[
                                                                [[30220753]],
                                                                [[30220752],[30220753]]
                                                            ]"/>
                      <param name="EndSignalCue"      value="[null, Ch7_2_Rescue_Approach]"/>
                      <!--           
                                   It appears that we're needed elsewhere.
                                   
                                   You don't say!
                                   They're going to kill him!
                                  -->
                    </cue>
                  </cues>
                </cue>
                <cue name="Ch7_2_Rescue_Approach">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <cues>
                    <cue name="Approach_Escalation_Battle_1_Ref" ref="md.LIB_Generic.ApproachObject_Handler">
                      <param name="ApproachTarget"    value="$KroShip"/>
                      <param name="ApproachDistance"  value="30km"/>
                      <param name="SuccessSignalCue"  value="Ch7_2_Lynching"/>
                    </cue>
                  </cues>
                </cue>
              </cues>
            </cue>

            <cue name="Ch7_2_Lynching">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <cues>
                <cue name="Ch7_2_Lynching_Speak_1">
                  <actions>
                    <signal_cue cue="Ch7_2_Battle_Start"/>
                    <speak actor="$RikActor" priority="100">
                      <text line="30220753" comment="(crazed)You will die for this!" delay="1s"/>
                    </speak>
                  </actions>
                </cue>
                <cue name="Ch7_2_Lynching_Speak_2">
                  <conditions>
                    <event_speak_finished actor="$RikActor" line="30220753"/>
                  </conditions>
                  <actions>
                    <speak actor="$XatActor" priority="100">
                      <text line="30220753" comment="Finally, something we can agree on, brother." delay="1s"/>
                    </speak>
                  </actions>
                </cue>
                <cue name="Ch7_2_Lynching_Approach">
                  <conditions>
                    <event_speak_finished actor="$XatActor" line="30220753"/>
                  </conditions>
                  <cues>
                    <cue name="Approach_Escalation_Battle_2_Ref" ref="md.LIB_Generic.ApproachObject_Handler">
                      <param name="ApproachTarget"    value="$KroShip"/>
                      <param name="ApproachDistance"  value="15km"/>
                      <param name="SuccessSignalCue"  value="Ch7_2_Protect_Kromancketslat"/>
                    </cue>
                  </cues>
                </cue>
              </cues>
            </cue>

            <cue name="Ch7_2_Protect_Kromancketslat">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <signal_cue cue="Ch7_Battle_Wild_Buccaneers_Appear"/>
                <!-- Make player and Paranid fleets enemies, so players don't get confused-->
                <do_for_each in="$ParanidFleets" name="$CurrentShip">
                  <set_relation_boost object="$CurrentShip" faction="faction.player" value="-1.0" decay="0" silent="true"/>
                </do_for_each>
              </actions>
              <cues>
                <cue name="Ch7_2_Protect_Kromancketslat_Dal_Duke_Speak">
                  <cues>
                    <cue name="Ch7_2_Dal_Duke_Speak_804_Ref" ref="md.LIB_Dialog.Speak_Actors">
                      <param name="Actor"             value="[$DalBusta, $Duke]"/>
                      <param name="CutsceneKey"       value="[$DalCutsceneKey, $DukeCutsceneKey]"/>
                      <param name="Lines"             value="[
                                                          [[30220754],[30220755]],
                                                          [[30220751],[30220752, 0.6s]]
                                                         ]"/>
                      <param name="EndSignalCue"      value="[null, Ch7_2_Protect_Kromancketslat_Duke_Speak]"/>
                      <!--           
                                   There he is!
                                   By Hatikvah, how is he still alive?
                                   
                                   (calm)It is truly a pity that it has come to this.
                                   (calm, slight pause before 'disappear')I am afraid that all these bystanders will need to... disappear.
                                  -->
                    </cue>
                  </cues>
                </cue>
                <cue name="Ch7_2_Protect_Kromancketslat_Duke_Speak">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <speak actor="$Duke" priority="100">
                      <text line="30220753" comment="(calm)See to it, Lieutenant." delay="1s"/>
                    </speak>
                  </actions>
                </cue>
                <cue name="Ch7_2_Protect_Kromancketslat_Gride_Speak">
                  <conditions>
                    <event_speak_finished actor="$Duke" line="30220753"/>
                  </conditions>
                  <actions>
                    <speak actor="$GrideActor" priority="100">
                      <text line="30220754" comment="(malicious)Sir!" delay="1s"/>
                      <text line="30220755" comment="(malicious)With pleasure!" delay="0.6s"/>
                    </speak>
                  </actions>
                </cue>
                <cue name="Ch7_2_Protect_Kromancketslat_Delay">
                  <conditions>
                    <event_speak_finished actor="$GrideActor" line="30220754"/>
                  </conditions>
                  <delay exact="4s"/>
                  <actions>
                    <signal_cue cue="Ch7_2_Unexpected_Help"/>
                  </actions>
                </cue>
              </cues>
            </cue>

            <cue name="Ch7_2_Unexpected_Help">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <signal_cue cue="Ch7_Music_2"/>
                <set_value name="$UnexpectedHelpBosoString" exact="[[30220751],[30220752]]"/>
                <!-- If the player caught the escaping Buccaneer ship in chapter 5, Boso will say something extra, and Dal will appear more competent. -->
                <do_if value="$DistractionSector?">
                  <append_to_list name="$UnexpectedHelpBosoString" exact="[30220753]"/>
                  <set_value name="$UnexpectedHelpDalString" exact="[[30220762],[30220763]]"/>
                </do_if>
                <do_else>
                  <set_value name="$UnexpectedHelpDalString" exact="[[30220756],[30220757]]"/>
                </do_else>
              </actions>
              <cues>
                <cue name="Ch7_2_Unexpected_Help_Boso_Dal_Speak">
                  <cues>
                    <cue name="Ch7_2_Boso_Dal_Speak_701_Ref" ref="md.LIB_Dialog.Speak_Actors">
                      <param name="Actor"             value="[$BosoTa, $DalBusta]"/>
                      <param name="CutsceneKey"       value="[$BosoCutsceneKey, $DalCutsceneKey]"/>
                      <param name="Lines"             value="[
                                                          $UnexpectedHelpBosoString,
                                                          $UnexpectedHelpDalString
                                                         ]"/>
                      <param name="EndSignalCue"      value="[null, Ch7_2_No_Way_Back]"/>
                      <!--           
                                   I am detecting multiple allied military vessels approaching rapidly.
                                   
                                   Optional: How peculiar.
                                   Optional: They appear to be carrying a combination of technology similar to the ship that my assistant tracked down a while ago.
                                   
                                   (incredulously)How could I have missed all that? / (surprised, excited)Those are Gride's Buccaneers!
                                   (incredulously)How much more intrigue has been playing itself out all this time? / (relieved)I figured she'd have a backup plan.
                                  -->
                    </cue>
                  </cues>
                </cue>
              </cues>
            </cue>

            <cue name="Ch7_2_No_Way_Back">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <signal_cue cue="Ch7_2_Battle_Finale"/>
              </actions>
              <cues>
                <cue name="Ch7_2_No_Way_Back_Dal_Speak">
                  <cues>
                    <cue name="Ch7_2_Dal_Speak_713_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$DalBusta"/>
                      <param name="CutsceneKey"       value="$DalCutsceneKey"/>
                      <param name="Lines"             value="[[30220713],[30220758]]"/>
                      <param name="EndSignalCue"      value="Ch7_2_No_Way_Back_Update_Objective"/>
                      <!--
                                   Well, there's no way back now.
                                   We've chosen whose side we're on in this battle.
                      -->
                    </cue>
                  </cues>
                </cue>
                <cue name="Ch7_2_No_Way_Back_Update_Objective">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <set_value name="$ObjectiveStep" operation="add"/>
                    <set_objective cue="$MissionCue" step="$ObjectiveStep" action="objective.kill" group="$ParanidFleets" text="{30220,6019}" updatebriefing="true" comment="Kill: Paranid Representatives"/>
                  </actions>
                </cue>
              </cues>
            </cue>

            <cue name="Ch7_2_Victory">
              <conditions>
                <event_object_destroyed group="$ParanidFleets"/>
                <check_value value="$ParanidFleets.count == 1"/>
              </conditions>
              <actions>
                <debug_text text="'Paranid fleets destroyed, make Dal say ending lines.'" chance="$DebugChance"/>
                <!-- Stop periodic drone launch -->
                <cancel_cue cue="Ch7_2_Keep_Swarming"/>
                <!-- Remove all remaining ships -->
                <signal_cue cue="Ch7_Battle_End_Detonate_Drones"/>
                <do_for_each in="$AllFleets" name="$CurrentShip">
                  <cancel_all_orders object="$CurrentShip"/>
                  <create_order id="'MoveDie'" object="$CurrentShip" immediate="true"/>
                </do_for_each>

                <play_music music="'music_story_paranid_monument_fight_ending_2'"/>

                <signal_cue cue="Ch7_2_Victory_Speak"/>
              </actions>
            </cue>

            <cue name="Ch7_2_Victory_Speak">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <cues>
                <cue name="Ch7_2_Dal_Speak_809_Ref" ref="md.LIB_Dialog.Speak_Actor">
                  <param name="Actor"             value="$DalBusta"/>
                  <param name="CutsceneKey"       value="$DalCutsceneKey"/>
                  <param name="Lines"             value="[[30220759],[if player.entity.isfemale then 30220727 else 30220726, 0.6s],[30220760],[30220761],[if player.entity.isfemale then 30220729 else 30220728]]"/>
                  <param name="EndSignalCue"      value="Ch7_2_Handover"/>
                  <!--
                                  That's the last of them.
                                  (sighing)Well, I guess there's nothing left for you to do out there.
                                  (spoken to female player 'you'){10111,30220726}
                                  I can't believe we got dragged into this whole conspiracy.
                                  Still, at least everyone involved in this convoluted mess is now either dead or on our side... (pause before 'hopefully')hopefully.
                                  Meet me at our headquarters and we'll discuss the path ahead.
                                  (spoken to female player){10111,30220728}
                                    -->
                </cue>
              </cues>
            </cue>

            <cue name="Ch7_2_Handover">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <remove_mission cue="$MissionCue" type="completed"/>
                <write_to_logbook category="missions" faction="faction.player" title="{30220,6001}" text="(if player.entity.isfemale then {30220,6031} else {30220,6030}) + '\n\n' + (if player.entity.isfemale then {30220,6035} else {30220,6034})"/>
                <unlock_achievement name="PLOT_PARANID"/>
                <signal_cue cue="Sinks_Escalation_Stage_1"/>
              </actions>
            </cue>

          </cues>
        </cue>

        <!-- Sinks: Unification -->
        <cue name="Sinks_Unification_Stage_1">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <create_mission cue="$MissionCue" name="{30220,8001}" description="if player.entity.isfemale then {30220,8003} else {30220,8002}" rewardtext="{30220,8004}" type="missiontype.plot" faction="faction.player" difficulty="level.hard" abortable="false" icon="'briefing_dal_busta_01'" iconcaption="$DalBusta.name">
              <briefing>
                <objective step="1" action="objective.talkto" object="$DalBusta" text="{30220,1003}" comment="Talk to: Your trusted friend, Dal Busta"/>
              </briefing>
            </create_mission>
            <set_value name="$CurrentStep" exact="1"/>
            <!-- Kromancketslat creates the Realm of the Trinity faction. -->
            <set_owner object="$Duke" faction="faction.trinity"/>
          </actions>
          <cues>

            <cue name="Uni_1_Dal_Desk" checktime="player.age + 5min" checkinterval="60s">
              <conditions>
                <check_value value="not player.entity.hascontext.{$HQ}"/>
              </conditions>
              <actions>
                <signal_cue cue="Setup_Dal_Desk_Busy"/>
              </actions>
            </cue>

            <cue name="Uni_1_Return_To_HQ">
              <actions>
                <set_objective_from_briefing cue="$MissionCue" step="1"/>
              </actions>
              <cues>

                <cue name="Uni_1_Return_To_HQ_Boso_Ta_Greeting">
                  <conditions>
                    <event_object_changed_room object="player.entity" room="$BosoTa.room"/>
                  </conditions>
                  <actions>
                    <speak actor="$BosoTa" priority="100">
                      <text line="if player.entity.isfemale then 30220821 else 30220820" comment="I am overjoyed to have you back in one piece, assistant."/>
                    </speak>
                  </actions>
                </cue>

                <cue name="Uni_1_Return_To_HQ_Dal_Busta_Conversation_Header" instantiate="true">
                  <conditions>
                    <event_conversation_started actor="$DalBusta"/>
                    <check_value value="$HQ? and $DalBusta.hascontext.{$HQ} and player.entity.hascontext.{$HQ}"/>
                  </conditions>
                  <actions>
                    <add_player_choice text="{30220,205}" section="section_uni_1_main" comment="(Dal Busta HQ Conversation Paranid Story Menu)Paranid Civil War"/>
                  </actions>
                </cue>

                <cue name="Uni_1_Return_To_HQ_Dal_Busta_Conversation_Main">
                  <conditions>
                    <event_conversation_next_section actor="$DalBusta" section="section_uni_1_main"/>
                  </conditions>
                  <actions>
                    <cancel_cue cue="Uni_1_Return_To_HQ_Dal_Busta_Conversation_Header"/>
                    <allow_conversation_escape enabled="false"/>
                    <add_npc_line speaker="$DalBusta" line="if player.entity.isfemale then 30220802 else 30220801" hidechoices="true" comment="It's a shame about all those lives lost, but you still did the right thing back there."/>
                    <add_npc_line speaker="$DalBusta" line="30220803"                                              hidechoices="true" comment="Our friend Kromancketslat is now using Gride's final intervention as a precedent to unite the Paranid against supposedly mounting foreign aggression."/>
                    <add_npc_line speaker="$DalBusta" line="30220804"                                              hidechoices="true" comment="If his little movement keeps growing, he might just be able to keep the Pontifices occupied enough to throttle their invasion plans."/>
                    <add_npc_line speaker="$DalBusta" line="30220805"                                              hidechoices="true" comment="His mediation fleet will certainly require a sizeable escort to defend against dissidents and foreign saboteurs."/>
                  </actions>
                  <cues>

                    <cue name="Uni_1_Return_To_HQ_Dal_Busta_Conversation_Finished">
                      <conditions>
                        <event_conversation_finished actor="$DalBusta"/>
                      </conditions>
                      <actions>
                        <signal_cue cue="Uni_1_Deliver_Fleet"/>
                      </actions>
                      <delay exact="2s"/>
                      <actions>
                        <speak actor="$DalBusta" priority="100">
                          <text line="30220806" comment="That's where we come in."/>
                        </speak>
                      </actions>
                    </cue>

                  </cues>
                </cue>

              </cues>
            </cue>

            <cue name="Uni_1_Deliver_Fleet">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <cues>

                <cue name="Uni_1_Deliver_Fleet_Setup">
                  <actions>
                    <!-- This costs about 200-250 Mio -->
                    <set_value name="$Fleet" exact="[
                          table[
                            $macro = macro.ship_par_xl_carrier_01_b_macro,
                            $amount = 1,
                            $equipment = [macro.engine_par_xl_allround_01_mk1_macro,
                                          macro.shield_par_xl_standard_01_mk1_macro,
                                          macro.shield_par_m_standard_02_mk2_macro,
                                          macro.thruster_gen_xl_allround_01_mk3_macro,
                                          macro.turret_par_m_laser_02_mk1_macro,
                                          macro.turret_par_l_plasma_01_mk1_macro],
                          ],
                          table[
                            $macro = macro.ship_par_l_destroyer_01_a_macro,
                            $amount = 6,
                            $equipment = [macro.engine_par_l_allround_01_mk1_macro,
                                          macro.shield_par_l_standard_01_mk2_macro,
                                          macro.shield_par_m_standard_02_mk2_macro,
                                          macro.thruster_gen_l_allround_01_mk3_macro,
                                          macro.turret_par_m_laser_02_mk1_macro,
                                          macro.turret_par_l_plasma_01_mk1_macro,
                                          macro.weapon_par_l_destroyer_01_mk1_macro],
                          ],
                          table[
                            $macro = macro.ship_par_m_frigate_01_b_macro,
                            $amount = 18,
                            $equipment = [macro.engine_par_m_combat_01_mk3_macro,
                                          macro.shield_par_m_standard_01_mk2_macro,
                                          macro.thruster_gen_m_combat_01_mk3_macro,
                                          macro.turret_par_m_laser_01_mk1_macro,
                                          macro.weapon_gen_m_plasma_01_mk2_macro],
                          ],
                          table[
                            $macro = macro.ship_par_m_corvette_01_a_macro,
                            $amount = 9,
                            $equipment = [macro.engine_par_m_combat_01_mk3_macro,
                                          macro.shield_par_m_standard_01_mk2_macro,
                                          macro.thruster_gen_m_combat_01_mk3_macro,
                                          macro.turret_par_m_laser_01_mk1_macro,
                                          macro.weapon_gen_m_laser_01_mk2_macro],
                          ]
                         ]"/>

                    <!-- Set $TextTable variables for GM briefing generation. -->
                    <set_value name="$TextTable" exact="table[]"/>

                    <set_value name="$TextTable.$objective"           exact="{30220,8017}" comment="Diplomatic Escort"/>
                    <set_value name="$TextTable.$objective_transfer"  exact="{30220,8017}" comment="Diplomatic Escort"/>
                    <set_value name="$TextTable.$progressbar"         exact="{30220,8018}" comment="Ships at delivery location"/>
                    <set_value name="$TextTable.$accept_transfer"     exact="{30220,8019}" comment="Accept fleet transfer"/>
                    <set_value name="$TextTable.$reject_transfer"     exact="{30220,8020}" comment="Reject fleet transfer"/>

                    <run_actions ref="md.GM_GetExactFleet.ConstructFleetRequirementsText" result="$FleetText">
                      <param name="Fleet" value="$Fleet"/>
                    </run_actions>

                    <!-- Determine a delivery location south of the player HQ. Mind that the HQ plot can extend up to 20km from the HQ centre, so the delivery location should be farther away. -->
                    <set_value name="$TargetSector" exact="$HQ.sector"/>
                    <create_position name="$HQ_Position" space="$HQ.sector" object="$HQ"/>
                    <create_position name="$TargetOffset" space="$HQ.sector" x="$HQ_Position.x" y="$HQ_Position.y" z="$HQ_Position.z - 60km"/>
                    <set_value name="$TargetRadius" exact="50km" comment="100km diameter should be enough to avoid stations that might be in the way."/>

                    <update_mission cue="$MissionCue" description="(if player.entity.isfemale then {30220,8006} else {30220,8005})
                                                        + '\n\n' + {30220,8016} + '\n' + $FleetText
                                                        + '\n\n' + {30220,8015} + '\n' + {30220,8008}" comment="Description + Fleet Details + Diplo and Eco Predictions" icon="'briefing_kromancketslat_01'" iconcaption="$Duke.name"/>

                    <set_value name="$CurrentStep" exact="1" operation="add"/>
                    <signal_cue cue="Uni_1_Deliver_Fleet_Mission"/>
                  </actions>
                </cue>

                <cue name="Uni_1_Deliver_Fleet_Mission">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <cues>

                    <cue name="Uni_1_Deliver_Fleet_Ref" ref="md.RML_Deliver_Fleet.DeliverFleet">
                      <param name="EndSignalCue"            value="Uni_1_Deliver_Fleet_Mission_Check"/>
                      <param name="MissionCue"              value="$MissionCue"/>
                      <param name="StartStep"               value="$CurrentStep"                    comment="Briefing step to start the mission on"/>
                      <param name="UpdateBriefing"          value="true"                            comment="Update the briefing objective step when the objective is updated"/>
                      <param name="DebugChance"             value="$DebugChance"/>

                      <param name="Text_Objective_Get"      value="$TextTable.$objective"           comment="Objective text to get ships"/>
                      <param name="Text_Objective_Transfer" value="$TextTable.$objective_transfer"  comment="Objective text to transfer ownership"/>
                      <param name="Text_AcceptTransfer"     value="$TextTable.$accept_transfer"     comment="Player choice text to initiate transfer"/>
                      <param name="Text_RejectTransfer"     value="$TextTable.$reject_transfer"     comment="Player choice text to reject transfer"/>
                      <param name="Text_ProgressBar"        value="$TextTable.$progressbar"         comment="Progress bar text for multiple ships"/>
                      <param name="Fleet"                   value="$Fleet"                          comment="The specific fleet we are looking for"/>
                      <param name="Transfer"                value="true"                            comment="Mission ends with a transfer of ownership to $Faction. Otherwise ends when ships are in position."/>
                      <param name="Faction"                 value="faction.trinity"                 comment="The faction to which it needs to be delivered. Required if $Transfer is true"/>
                      <param name="Client"                  value="$Duke"                           comment="client who wants the fleet. Required if $Transfer is true"/>
                      <param name="TargetSector"            value="$TargetSector"                   comment="Sector to which to deliver the fleet"/>
                      <param name="TargetOffset"            value="$TargetOffset"                   comment="Location to which to deliver the fleet"/>
                      <param name="TargetRadius"            value="$TargetRadius"                   comment="Radius around location in which we need to put the fleet"/>
                      <param name="CriteriaResultCue"       value="null"                            comment="Cue to signal with a table of ships with the result of the most recent processing of 'CheckMissionStatus'"/>
                      <param name="AdditionCheckCue"        value="null"                            comment="Cue to signal instantly to run additional checks on the object. event.param = [namespace, $ship]. Result saved to namespace.$CheckCueResult"/>
                      <param name="ReturnFleetShips"        value="true"                            comment="If true, sets $EndSignalCue.$FleetShips, which in the Success Case is the Fleet which changed ownership on transfer"/>
                    </cue>

                    <cue name="Uni_1_Deliver_Fleet_Mission_Check">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <do_if value="this.$EndFeedbackValue == 1">
                          <!-- Remember delivered fleet for later, so we can give them orders to patrol, etc. between the hop/paranid capitals -->
                          <set_value name="$TrinityFleet" exact="this.$FleetShips"/>
                          <debug_text text="'Fleet delivered. $TrinityFleet now contains: ' + $TrinityFleet.count + ' ships.'" chance="$DebugChance"/>
                          <signal_cue cue="Uni_1_Deliver_Fleet_Mission_Completed"/>
                        </do_if>
                        <do_else>
                          <debug_text text="'Fleet transfer declined. Resetting mission.'" chance="$DebugChance"/>
                          <reset_cue cue="Uni_1_Deliver_Fleet_Mission_Check"/>
                          <reset_cue cue="Uni_1_Deliver_Fleet_Ref"/>
                        </do_else>
                      </actions>
                    </cue>

                  </cues>
                </cue>

                <cue name="Uni_1_Deliver_Fleet_Mission_Completed">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <set_value name="$CurrentStep" operation="add"/>
                    <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.await" text="{30220,3014}" updatebriefing="true" silent="true" comment="Await: Further Instructions"/>

                    <!-- Set biggest ship as commander. -->
                    <do_for_each in="$TrinityFleet" name="$CurrentShip">
                      <do_if value="[shiptype.carrier].indexof.{$CurrentShip.type}">
                        <set_value name="$TrinityCommander" exact="$CurrentShip"/>
                        <break/>
                      </do_if>
                    </do_for_each>

                    <do_if value="not $TrinityCommander?">
                      <set_value name="$TrinityCommander" exact="$TrinityFleet.{1}"/>
                    </do_if>

                    <!-- Set other ships as subordinates. -->
                    <do_for_each in="$TrinityFleet" name="$CurrentShip">
                      <do_if value="$CurrentShip != $TrinityCommander">
                        <create_order id="'AssignCommander'" object="$CurrentShip" immediate="true">
                          <param name="commander" value="$TrinityCommander"/>
                          <param name="assignment" value="assignment.defence"/>
                          <param name="cancelorders" value="true"/>
                        </create_order>
                      </do_if>
                    </do_for_each>

                    <signal_cue cue="Uni_1_Deliver_Fleet_Completion_Dialog"/>
                  </actions>
                </cue>

                <cue name="Uni_1_Deliver_Fleet_Completion_Dialog">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <cues>
                    <cue name="Uni_1_Speak_Dal_985_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$DalBusta"/>
                      <param name="CutsceneKey"       value="$DalCutsceneKey"/>
                      <param name="Lines"             value="[[30220985],[30220807],[30220808, 0.5s],[30220809, 0.5s]]"/>
                      <param name="EndSignalCue"      value="Uni_1_Assassinate_Legate"/>
                      <!--
                          That should do it!
                          Kromancketslat must be eager to finally begin his campaign in earnest.
                          I have, however, received reports about a high-ranking Godrealm official who refuses to cease railing against even the idea of such mediations.
                          I'm afraid that violence might have to be employed one last time.
                            -->
                    </cue>
                  </cues>
                </cue>

              </cues>
            </cue>

            <cue name="Uni_1_Assassinate_Legate">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <do_if value="@$HQ">
                  <find_sector owner="faction.paranid" name="$LegateSector" sortbygatedistanceto="$HQ.sector"/>
                </do_if>
                <do_else>
                  <find_sector owner="faction.paranid" name="$LegateSector" sortbygatedistanceto="player.sector"/>
                </do_else>

                <!-- Fallback case -->
                <do_if value="not $LegateSector">
                  <set_value name="$LegateSector" exact="player.sector"/>
                </do_if>

                <create_position name="$LegateSpawnPosition" space="$LegateSector"/>
              </actions>
              <cues>

                <cue name="Uni_1_Assassinate_Legate_Setup">
                  <actions>
                    <!-- Xatenmanckett's flagship -->
                    <create_ship name="$LegateFlagship" macro="ship_par_xl_carrier_01_a_macro" commandeerable="false" capturable="true" mission="true" sector="$LegateSector">
                      <owner exact="faction.paranid" overridenpc="true"/>
                      <pilot>
                        <select faction="faction.paranid" tags="tag.elitepilot"/>
                      </pilot>
                      <loadout>
                        <level exact="1.0"/>
                      </loadout>
                      <people ref="paranid_elite_military_crew"/>
                      <safepos value="$LegateSpawnPosition"/>
                    </create_ship>
                    <create_order id="'Patrol'" object="$LegateFlagship" default="true">
                      <param name="space" value="$LegateSector"/>
                    </create_order>

                    <set_object_name object="$LegateFlagship" page="30220" line="171" comment="Glory of Xaar"/>

                    <add_to_group groupname="$LegateFleet" object="$LegateFlagship"/>

                    <!-- Supporting fleet:
                          Destroyers:
                            167: Paladin of Unanimity
                            172: Triumphant Hierophant
                            134: Imposing Penance (Xatenmanckett's old ship)
                            163: The Emperor's Sentence
                            169: Aegis Of Radiance
                            165: Beatific Indignation
                          Frigates:
                            <t id="145">Inquisitor Mercy</t>
                            <t id="146">Thy Doom Is Foreordained</t>
                            <t id="147">In Malevolent Contemplation</t>
                            <t id="149">The Gospel Of Conflagration</t>
                            <t id="150">Let My Sword Be Truth</t>
                            <t id="151">The Saintly Theorem</t>
                            <t id="152">The Elementary Precept</t>
                            <t id="153">Augur Of Benefaction</t>
                            <t id="154">The Ineffable Glory</t>
                            <t id="164">The Exponent Of Nobility(exponent means a person who supports)</t>
                          -->
                    <set_value name="$LegateFleetComposition"   exact="[
                          [ macro.ship_par_l_destroyer_01_a_macro, 30220, 167 ],
                          [ macro.ship_par_l_destroyer_01_a_macro, 30220, 172 ],
                          [ macro.ship_par_l_destroyer_01_a_macro, 30220, 134 ],
                          [ macro.ship_par_l_destroyer_01_a_macro, 30220, 163 ],
                          [ macro.ship_par_l_destroyer_01_a_macro, 30220, 169 ],
                          [ macro.ship_par_l_destroyer_01_a_macro, 30220, 165 ],
                          [ macro.ship_par_m_frigate_01_a_macro, 30220, 145 ],
                          [ macro.ship_par_m_frigate_01_a_macro, 30220, 146 ],
                          [ macro.ship_par_m_frigate_01_a_macro, 30220, 147 ],
                          [ macro.ship_par_m_frigate_01_a_macro, 30220, 149 ],
                          [ macro.ship_par_m_frigate_01_a_macro, 30220, 150 ],
                          [ macro.ship_par_m_frigate_01_a_macro, 30220, 151 ],
                          [ macro.ship_par_m_frigate_01_a_macro, 30220, 152 ],
                          [ macro.ship_par_m_frigate_01_a_macro, 30220, 153 ],
                          [ macro.ship_par_m_frigate_01_a_macro, 30220, 154 ],
                          [ macro.ship_par_m_frigate_01_a_macro, 30220, 164 ],
                          ]" />

                    <do_all exact="$LegateFleetComposition.count" counter="$f">
                      <!-- Capturable="true" is intended. -->
                      <create_ship name="$CurrentShip" macro="$LegateFleetComposition.{$f}.{1}" commandeerable="false" capturable="true" mission="true" sector="$LegateSector">
                        <owner exact="faction.paranid" overridenpc="true" />
                        <pilot>
                          <select faction="faction.paranid" tags="tag.elitepilot"/>
                        </pilot>
                        <loadout>
                          <level exact="1.0"/>
                        </loadout>
                        <safepos object="$LegateFlagship" space="$LegateSector" min="2km" max="10km"/>
                      </create_ship>

                      <do_if value="$LegateFleetComposition.{$f}.{2}">
                        <set_object_name object="$CurrentShip" page="$LegateFleetComposition.{$f}.{2}" line="$LegateFleetComposition.{$f}.{3}"/>
                      </do_if>

                      <add_to_group groupname="$LegateFleet" object="$CurrentShip"/>

                      <create_order id="'AssignCommander'" object="$CurrentShip" immediate="true">
                        <param name="commander" value="$LegateFlagship"/>
                        <param name="assignment" value="assignment.defence"/>
                        <param name="cancelorders" value="true"/>
                      </create_order>
                    </do_all>

                    <!-- Xatenmanckett's personal taxi -->
                    <create_ship name="$LegateTaxi" macro="ship_par_s_scout_01_a_macro" commandeerable="false" capturable="false" mission="true" sector="$LegateSector">
                      <owner exact="faction.paranid" overridenpc="true"/>
                      <pilot>
                        <select faction="faction.paranid" tags="tag.elitepilot"/>
                      </pilot>
                      <loadout>
                        <level exact="1.0"/>
                      </loadout>
                      <people ref="paranid_elite_military_crew"/>
                      <safepos value="$LegateSpawnPosition"/>
                    </create_ship>

                    <set_object_name object="$LegateTaxi" page="30220" line="148" comment="Incandescent Verity"/>

                    <!-- Create Xatenmanckett and set him as the assassination target. -->
                    <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $XatActor,
                                                                                                  table[
                                                                                                  $requestercue = namespace,
                                                                                                  $location = $LegateTaxi.controlroom,
                                                                                                  $rotation = 0,
                                                                                                  $position = position.[0,0,0],
                                                                                                  $priority = 100,
                                                                                                  $debugchance = $DeepDebugChance,
                                                                                                  $debugcaller = if $DebugChance == 100 then this else null]
                                                                                                  ]"/>

                    <add_to_group groupname="$TargetGroup" object="$XatActor"/>

                    <signal_cue cue="Uni_1_Assassinate_Legate_Mission"/>
                  </actions>
                  <cues>

                    <cue name="Uni_1_Assassinate_Legate_Setup_Taxi">
                      <actions>
                        <!-- Starting situation: Follow a ship of the Legate fleet. -->
                        <set_value name="$TaxiTarget" exact="$LegateFleet.{1}"/>
                        <create_order id="'Follow'" object="$LegateTaxi" immediate="true">
                          <param name="target" value="$LegateFleet.{1}"/>
                        </create_order>
                      </actions>
                      <cues>

                        <cue name="Legate_Taxi_Approach_Fleet">
                          <cues>
                            <cue name="Legate_Taxi_Approach_Fleet_Ref" ref="md.LIB_Generic.ApproachObject_Handler">
                              <param name="ApproachObject"    value="$LegateTaxi"/>
                              <param name="ApproachTarget"    value="$TaxiTarget"/>
                              <param name="ApproachDistance"  value="5km"/>
                              <param name="SuccessSignalCue"  value="Legate_Taxi_Approach_Fleet_Complete"/>
                            </cue>
                            <cue name="Legate_Taxi_Approach_Fleet_Failsafe">
                              <conditions>
                                <event_object_destroyed object="$TaxiTarget"/>
                              </conditions>
                              <actions>
                                <reset_cue cue="Uni_1_Assassinate_Legate_Setup_Taxi"/>
                              </actions>
                            </cue>
                            <cue name="Legate_Taxi_Approach_Fleet_Complete">
                              <conditions>
                                <event_cue_signalled/>
                              </conditions>
                              <!-- When the Taxi is close to the fleet, let it follow them for a moment before sending it away. -->
                              <delay exact="2min"/>
                              <actions>
                                <signal_cue cue="Legate_Taxi_Approach_HQ"/>
                              </actions>
                            </cue>
                          </cues>
                        </cue>

                        <cue name="Legate_Taxi_Approach_HQ">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <actions>
                            <!-- Situation 2: Taxi on its way to the Godrealm HQ. -->
                            <do_if value="faction.paranid.headquarters">
                              <create_order object="$LegateTaxi" id="'MoveToObject'" immediate="true">
                                <param name="destination" value="faction.paranid.headquarters"/>
                              </create_order>
                            </do_if>
                            <do_else>
                              <reset_cue cue="Uni_1_Assassinate_Legate_Setup_Taxi"/>
                            </do_else>
                          </actions>
                          <cues>
                            <cue name="Legate_Taxi_Approach_HQ_Ref" ref="md.LIB_Generic.ApproachObject_Handler">
                              <param name="ApproachObject"    value="$LegateTaxi"/>
                              <param name="ApproachTarget"    value="faction.paranid.headquarters"/>
                              <param name="ApproachDistance"  value="2km"/>
                              <param name="SuccessSignalCue"  value="Legate_Taxi_Approach_HQ_Complete"/>
                            </cue>
                            <cue name="Legate_Taxi_Approach_HQ_Failsafe">
                              <conditions>
                                <event_object_destroyed object="faction.paranid.headquarters"/>
                              </conditions>
                              <actions>
                                <reset_cue cue="Uni_1_Assassinate_Legate_Setup_Taxi"/>
                              </actions>
                            </cue>
                            <cue name="Legate_Taxi_Approach_HQ_Complete">
                              <conditions>
                                <event_cue_signalled/>
                              </conditions>
                              <!-- Let the ship wait a short while before attempting to return to the fleet. -->
                              <delay exact="1min"/>
                              <actions>
                                <do_if value="$LegateFleet.count">
                                  <reset_cue cue="Uni_1_Assassinate_Legate_Setup_Taxi"/>
                                </do_if>
                                <do_else>
                                  <!-- Effectively ends the patrol cues, because nothing is reset. -->
                                  <cancel_all_orders object="$LegateTaxi"/>
                                  <create_order id="'Patrol'" object="$LegateTaxi" default="true">
                                    <param name="space" value="$LegateTaxi.sector"/>
                                  </create_order>
                                </do_else>
                              </actions>
                            </cue>
                          </cues>
                        </cue>

                      </cues>
                    </cue>

                  </cues>
                </cue>

                <cue name="Uni_1_Assassinate_Legate_Mission">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <update_mission cue="$MissionCue" description="(if player.entity.isfemale then {30220,8010} else {30220,8009})
                                                        + '\n\n' + {30220,8015} + '\n' + {30220,8008}" comment="Description + Diplo and Eco Predictions" icon="'briefing_dal_busta_01'" iconcaption="$DalBusta.name"/>
                  </actions>
                  <cues>
                    <cue name="Uni_1_Assassinate_Legate_DEBUG">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <destroy_group group="$TargetGroup"/>
                      </actions>
                    </cue>
                    <cue name="Uni_1_Assassinate_Legate_Ref" ref="md.RML_Destroy_Entities.DestroyEntities">
                      <param name="EndSignalCue"    value="Uni_1_Assassinate_Legate_Ended"/>
                      <param name="MissionCue"      value="$MissionCue"/>
                      <param name="StartStep"       value="$CurrentStep"  comment="Briefing step to start the mission on"/>
                      <param name="UpdateBriefing"  value="true"          comment="Update the briefing objective step when the objective is updated"/>

                      <param name="Targets_Param" value="$TargetGroup" />

                      <param name="DebugChance" value="$DebugChance"/>
                    </cue>

                    <cue name="Uni_1_Assassinate_Legate_Attack">
                      <conditions>
                        <event_object_attacked object="$XatActor.ship"/>
                        <check_value value="event.param.owner == faction.player"/>
                      </conditions>
                      <actions>
                        <!-- Turn whole Legate fleet hostile if any of them is close to the attacked taxi, ignore otherwise. -->
                        <do_for_each in="$LegateFleet" name="$CurrentShip">
                          <do_if value="$CurrentShip.distanceto.{$XatActor.ship} lt 50km">
                            <find_object groupname="$ClosePlayerShips" space="$LegateFlagship.sector" owner="faction.player" multiple="true" sortbydistanceto="$XatActor.ship"/>
                            <do_for_each in="$LegateFleet" name="$CurrentAttackingShip">
                              <set_relation_boost object="$CurrentAttackingShip" faction="faction.player" value="-1.0" decay="0"/>
                              <create_order id="'Attack'" object="$CurrentAttackingShip" immediate="true">
                                <param name="primarytarget" value="$ClosePlayerShips.{1}"/>
                                <param name="secondarytargets" value="$ClosePlayerShips"/>
                                <param name="pursuetargets" value="true"/>
                                <param name="checkrelation" value="false"/>
                              </create_order>
                            </do_for_each>
                            <break/>
                          </do_if>
                        </do_for_each>
                      </actions>
                      <delay exact="30s"/>
                      <actions>
                        <!-- Check again after a while, to prevent cheese. -->
                        <reset_cue cue="Uni_1_Assassinate_Legate_Attack"/>
                      </actions>
                    </cue>

                    <cue name="Uni_1_Assassinate_Legate_Xat_Attack_Dialog">
                      <conditions>
                        <event_object_attacked object="$XatActor.ship"/>
                        <check_value value="event.param == player.entity.ship"/>
                      </conditions>
                      <cues>
                        <cue name="Uni_1_Assassinate_Legate_Xat_Attack_Dialog_Delay">
                          <delay exact="5s"/>
                          <actions>
                            <signal_cue cue="Uni_1_Assassinate_Legate_Xat_Attack_Dialog_Speak"/>
                          </actions>
                        </cue>
                        <cue name="Uni_1_Assassinate_Legate_Xat_Attack_Dialog_Speak">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <cues>
                            <cue name="Uni_1_Speak_Xat_801_Ref_v2" ref="md.LIB_Dialog.Speak_Actor">
                              <param name="Actor"             value="$XatActor"/>
                              <param name="CutsceneKey"       value="$XatCutsceneKey"/>
                              <param name="Lines"             value="[[if player.entity.isfemale then 30220802 else 30220801],[if player.entity.isfemale then 30220804 else 30220803, 0.5s]]"/>
                              <param name="EndSignalCue"      value="null"/>
                              <!--
                                    Despicable, unholy fiend!
                                    Your puny vessel shall be torn asunder by the righteous fury of Xaar's faithful!
                            -->
                            </cue>
                          </cues>
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Uni_1_Assassinate_Legate_Attack_Almost_Dead">
                      <conditions>
                        <event_object_hull_damaged object="$XatActor.ship"/>
                        <check_value value="$XatActor.ship.hullpercentage le 50"/>
                      </conditions>
                      <actions>
                        <!-- Disable repercussions for destroying Xat's ship. -->
                        <set_object_relation_behaviour object="$XatActor.ship" disable="true"/>
                      </actions>
                    </cue>

                    <cue name="Uni_1_Assassinate_Legate_Ended">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <cancel_cue cue="Uni_1_Assassinate_Legate_Setup_Taxi"/>
                        <cancel_cue cue="Uni_1_Assassinate_Legate_Attack"/>
                        <cancel_cue cue="Uni_1_Assassinate_Legate_Xat_Attack_Dialog"/>
                      </actions>
                      <delay exact="6s"/>
                      <actions>
                        <signal_cue cue="Uni_1_Assassinate_Legate_Xat_Killed_Dialog"/>
                      </actions>
                    </cue>
                  </cues>
                </cue>

                <cue name="Uni_1_Assassinate_Legate_Xat_Killed_Dialog">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <cues>
                    <cue name="Uni_1_Speak_Dal_810_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$DalBusta"/>
                      <param name="CutsceneKey"       value="$DalCutsceneKey"/>
                      <param name="Lines"             value="[[30220810],[30220909, 0.5s]]"/>
                      <param name="EndSignalCue"      value="Uni_1_Diplomatic_Change"/>
                      <!--
                          How unfortunate for him, but sadly he stood in the way of something great.
                          Let's sit back for a while and let Kromancketslat get to work.
                            -->
                    </cue>
                  </cues>
                </cue>

              </cues>
            </cue>

            <cue name="Uni_1_Diplomatic_Change">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <debug_text text="'Assassination mission completed. Signalling Unification Stage 1 Diplomatic Change (HOP and PAR stop invading each other).'" chance="$DebugChance"/>
                <signal_cue cue="Uni_1_Mediation_Fleet_Patrol"/>
                <signal_cue cue="Unification_Stage_1_CeaseFire"/>
                <signal_cue cue="Uni_1_Cooldown"/>
              </actions>
            </cue>

            <cue name="Uni_1_Mediation_Fleet_Patrol">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <!-- Create Waypoint Variable that we can switch on and off. -->
                <set_value name="$WaypointHOP" exact="null"/>

                <!-- Send fleet commander to Holy Order faction headquarters if both exist. If not, the following cues will still try to give orders regularly until all ships are destroyed. -->
                <do_if value="faction.holyorder.headquarters and $TrinityCommander">
                  <debug_text text="'Trinity Commander is: ' + $TrinityCommander.knownname + '. Holy Order HQ as first waypoint: ' + faction.holyorder.headquarters.knownname" chance="$DebugChance"/>
                  <set_value name="$WaypointHOP"/>
                  <create_order object="$TrinityCommander" id="'MoveToObject'" immediate="true">
                    <param name="destination" value="faction.holyorder.headquarters"/>
                  </create_order>
                </do_if>
              </actions>
              <cues>

                <cue name="Uni_1_Mediation_Fleet_Patrol_Check">
                  <delay exact="10min"/>
                  <actions>
                    <!-- If the commander got destroyed, select a new one as long as there are still faction.trinity ships left. -->
                    <do_if value="not $TrinityCommander">
                      <find_ship_by_true_owner groupname="$TrinityFleet" space="player.galaxy" faction="faction.trinity" multiple="true"/>

                      <!-- If trinity ships still exist, set a destroyer as commander. -->
                      <do_if value="$TrinityFleet.count">
                        <do_for_each in="$TrinityFleet" name="$CurrentShip">
                          <do_if value="[shiptype.destroyer].indexof.{$CurrentShip.type}">
                            <set_value name="$TrinityCommander" exact="$CurrentShip"/>
                            <break/>
                          </do_if>
                        </do_for_each>

                        <!-- If there's no big ship left, choose any of the others as commander. -->
                        <do_if value="not $TrinityCommander">
                          <set_value name="$TrinityCommander" exact="$TrinityFleet.{1}"/>
                        </do_if>

                        <!-- Set other ships as subordinates. -->
                        <do_for_each in="$TrinityFleet" name="$CurrentShip">
                          <do_if value="$CurrentShip != $TrinityCommander">
                            <create_order id="'AssignCommander'" object="$CurrentShip" immediate="true">
                              <param name="commander" value="$TrinityCommander"/>
                              <param name="assignment" value="assignment.defence"/>
                              <param name="cancelorders" value="true"/>
                            </create_order>
                          </do_if>
                        </do_for_each>
                      </do_if>

                      <!-- If no trinity ships are left, cancel the patrol cue. -->
                      <do_else>
                        <cancel_cue cue="Uni_1_Mediation_Fleet_Patrol"/>
                      </do_else>
                    </do_if>

                    <!-- Check whether the Holy Order headquarters is the next waypoint and whether it still exists. -->
                    <do_if value="$WaypointHOP and faction.holyorder.headquarters">
                      <!-- If that's the case, check whether the fleet is close. -->
                      <do_if value="$TrinityCommander.sector == faction.holyorder.headquarters.sector">
                        <!-- Send fleet to Godrealm faction headquarters if it exists. Otherwise, let the fleet idle. -->
                        <do_if value="faction.paranid.headquarters">
                          <create_order object="$TrinityCommander" id="'MoveToObject'" immediate="true">
                            <param name="destination" value="faction.paranid.headquarters"/>
                          </create_order>
                          <!-- Switch Waypoint Variable to have the cue check for the other headquarters next time. -->
                          <set_value name="$WaypointHOP" exact="null"/>
                        </do_if>
                      </do_if>
                    </do_if>

                    <!-- If instead the Godrealm faction headquarters is the next waypoint, check whether it still exists. -->
                    <do_elseif value="faction.paranid.headquarters">
                      <!-- If it does exist, check whether the fleet is close. -->
                      <do_if value="$TrinityCommander.sector == faction.paranid.headquarters.sector">
                        <!-- Send fleet to Holy Order faction headquarters if it exists. Otherwise, let the fleet idle. -->
                        <do_if value="faction.holyorder.headquarters">
                          <create_order object="$TrinityCommander" id="'MoveToObject'" immediate="true">
                            <param name="destination" value="faction.holyorder.headquarters"/>
                          </create_order>
                          <!-- Switch Waypoint Variable to have the cue check for the other headquarters next time. -->
                          <set_value name="$WaypointHOP"/>
                        </do_if>
                      </do_if>
                    </do_elseif>

                    <!-- Check again in 10 minutes -->
                    <reset_cue cue="Uni_1_Mediation_Fleet_Patrol_Check"/>
                  </actions>
                </cue>

              </cues>
            </cue>

            <cue name="Uni_1_Cooldown">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <cues>

                <cue name="Uni_1_Cooldown_Update_Objective">
                  <actions>
                    <set_value name="$CurrentStep" exact="1" operation="add"/>
                    <update_mission cue="$MissionCue" description="if player.entity.isfemale then {30220,8012} else {30220,8011}"/>
                    <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.await" text="{30220,8007}" updatebriefing="true" comment="Await: Next Stage of the Plan"/>
                  </actions>
                </cue>

                <cue name="Uni_1_Cooldown_Delay">
                  <delay exact="10min"/>
                  <actions>
                    <write_to_logbook category="missions" faction="faction.player" title="{30220,8001}" text="if player.entity.isfemale then {30220,8014} else {30220,8013}"/>
                    <signal_cue cue="Sinks_Unification_Stage_2"/>
                  </actions>
                </cue>

              </cues>
            </cue>

          </cues>
        </cue>

        <cue name="Sinks_Unification_Stage_2">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <cues>

            <cue name="Uni_2_Duke_Call">
              <actions>
                <set_value name="$DukeCallInterval" exact="5min"/>
              </actions>
              <cues>

                <cue name="Uni_2_Duke_Call_Parent">
                  <delay exact="$DukeCallInterval"/>
                  <actions>
                    <do_if value="$HQ? and $DalBusta.hascontext.{$HQ}">
                      <debug_text text="'Starting Kromancketslat call in unification sinks stage 2.'" chance="$DebugChance"/>
                      <play_cutscene key="$DukeCutsceneKey.$key" result="this.$CutsceneID" targetmonitor="true">
                        <interaction text="{30220,1004}" param="$Duke" param2="'accept_interaction'"/>
                        <param name="npcref" object="$Duke" />
                        <!--<param name="room"   object="$Duke.room" />-->
                      </play_cutscene>
                    </do_if>
                    <do_else>
                      <debug_text text="'Dal Busta is not on the HQ. Resetting Uni 2 Duke call.'" chance="$DebugChance"/>
                      <reset_cue cue="Uni_2_Duke_Call_Parent"/>
                    </do_else>
                  </actions>
                  <cues>

                    <cue name="Uni_2_Duke_Call_Speak">
                      <conditions>
                        <event_cutscene_started key="$DukeCutsceneKey.$key"/>
                      </conditions>
                      <actions>
                        <signal_cue cue="Uni_2_Duke_Call_No_Interact"/>
                        <speak actor="$Duke" priority="100">
                          <text line="if (player.entity.race == race.paranid) then 30220430 else if player.entity.isfemale then 30220429 else 30220428" delay="0.6s" comment="Brother! / Outsider!"/>
                        </speak>
                      </actions>
                    </cue>

                    <!--Accept the call-->
                    <cue name="Uni_2_Duke_Call_Interact">
                      <conditions>
                        <event_player_interaction param="$Duke" param2="'accept_interaction'"/>
                      </conditions>
                      <actions>
                        <stop_cutscene cutscene="parent.$CutsceneID"/>
                        <cancel_cue cue="Uni_2_Duke_Call_No_Interact"/>

                        <signal_cue cue="Uni_2_Duke_Call_Conversation"/>
                      </actions>
                    </cue>

                    <!--Fail to accept the call-->
                    <cue name="Uni_2_Duke_Call_No_Interact">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <delay exact="10s" comment="cutscene timeout"/>
                      <actions>
                        <stop_cutscene cutscene="parent.$CutsceneID"/>
                        <reset_cue cue="parent"/>
                      </actions>
                    </cue>

                  </cues>
                </cue>

                <cue name="Uni_2_Duke_Call_Conversation">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <start_conversation actor="$Duke" conversation="duke_uni_2_call" priority="100"/>
                  </actions>
                  <cues>
                    <cue name="Uni_2_Duke_Call_Conversation_Section_Main">
                      <conditions>
                        <event_conversation_started actor="$Duke" conversation="duke_uni_2_call"/>
                      </conditions>
                      <actions>
                        <allow_conversation_escape enabled="false"/>

                        <add_npc_line speaker="$Duke"   line="30220801" hidechoices="true" comment="Is this transmitter operational, or did some fool forget to configure it again?"/>
                        <add_npc_line speaker="$BosoTa" line="30220801" hidechoices="true" comment="I'm very surprised at you!"/>
                        <add_npc_line speaker="$Duke"   line="30220802" hidechoices="true" comment="(shouting)Silence, creature!"/>
                        <add_npc_line speaker="$Duke"   line="if player.entity.isfemale then 30220804 else 30220803" hidechoices="true" comment="Your immediate presence is required at our headquarters, follower."/>
                      </actions>
                    </cue>
                    <cue name="Uni_2_Duke_Call_Conversation_Finished">
                      <conditions>
                        <event_conversation_finished actor="$Duke"/>
                      </conditions>
                      <actions>
                        <remove_mission cue="$MissionCue" type="completed"/>
                        <signal_cue cue="Uni_2_Briefing"/>
                      </actions>
                    </cue>
                  </cues>
                </cue>

              </cues>
            </cue>

            <cue name="Uni_2_Briefing">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <debug_text text="'Unification sinks stage 2 conversation now available at HQ'" chance="$DebugChance"/>

                <!-- Place Duke on the HQ-->
                <create_position name="$DukePos" x="2.139" z="-10.15"/>
                <create_rotation name="$DukeRot" yaw="-161.38942deg"/>
                <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $Duke,
                                                                                                  table[
                                                                                                  $requestercue = namespace,
                                                                                                  $location = $BosoTa.room,
                                                                                                  $rotation = $DukeRot,
                                                                                                  $position = $DukePos,
                                                                                                  $priority = 100,
                                                                                                  $debugchance = $DeepDebugChance,
                                                                                                  $debugcaller = if $DebugChance == 100 then this else null]
                                                                                                  ]"/>

                <create_mission cue="$MissionCue" name="{30220,8101}" description="if player.entity.isfemale then {30220,8103} else {30220,8102}" rewardtext="{30220,8104}" type="missiontype.plot" faction="faction.player" difficulty="level.veryhard" abortable="false" icon="'briefing_kromancketslat_01'" iconcaption="$Duke.name">
                  <briefing>
                    <objective step="1" action="objective.talkto" object="$Duke" comment="Talk to: Kromancketslat"/>
                  </briefing>
                </create_mission>
                <set_value name="$CurrentStep" exact="1"/>
                <set_objective_from_briefing cue="$MissionCue" step="$CurrentStep"/>
              </actions>
              <cues>

                <cue name="Uni_2_Briefing_Duke_Conversation">
                  <conditions>
                    <event_conversation_started actor="$Duke"/>
                  </conditions>
                  <actions>
                    <allow_conversation_escape enabled="false"/>
                    <!-- Use lookat to make sure he keeps looking straight ahead out the window. -->
                    <add_npc_line speaker="$Duke" lookat="$Duke" hidechoices="true" line="if player.entity.isfemale then 30220806 else 30220805" comment="I am in deep contemplation. Speak to my advisor, Dal Busta."/>
                  </actions>
                  <cues>
                    <cue name="Uni_2_Briefing_Duke_Conversation_Finished">
                      <conditions>
                        <event_conversation_finished actor="$Duke"/>
                      </conditions>
                      <actions>
                        <!-- Overwrite previous objective, so don't increase $CurrentStep. -->
                        <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.talkto" object="$DalBusta" updatebriefing="true" comment="Talk to: Dal Busta"/>
                      </actions>
                    </cue>
                  </cues>
                </cue>

                <cue name="Uni_2_Briefing_Dal_Conversation_Header" instantiate="true">
                  <conditions>
                    <event_conversation_started actor="$DalBusta"/>
                    <check_value value="$HQ? and $DalBusta.hascontext.{$HQ} and player.entity.hascontext.{$HQ}"/>
                  </conditions>
                  <actions>
                    <add_player_choice text="{30220,205}" section="uni_2_dal_main"/>
                  </actions>
                </cue>

                <cue name="Uni_2_Briefing_Dal_Conversation">
                  <conditions>
                    <event_conversation_next_section actor="$DalBusta" section="uni_2_dal_main"/>
                  </conditions>
                  <actions>
                    <cancel_cue cue="Uni_2_Briefing_Dal_Conversation_Header"/>
                    <!-- Cancel Kromancketslat's intial conversation and move him over. -->
                    <cancel_cue cue="Uni_2_Briefing_Duke_Conversation"/>

                    <create_position name="$DukePos2" x="-2.228" z="-9.887"/>
                    <create_rotation name="$DukeRot2" yaw="-5.27173deg"/>

                    <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $Duke,
                                                                                                  table[
                                                                                                  $requestercue = namespace,
                                                                                                  $location = $BosoTa.room,
                                                                                                  $rotation = $DukeRot2,
                                                                                                  $position = $DukePos2,
                                                                                                  $priority = 100,
                                                                                                  $debugchance = $DeepDebugChance,
                                                                                                  $debugcaller = if $DebugChance == 100 then this else null]
                                                                                                  ]"/>

                    <allow_conversation_escape enabled="false"/>

                    <add_npc_line speaker="$DalBusta" line="if player.entity.isfemale then 30220812 else 30220811" hidechoices="true" comment="Ah, there you are!"/>
                    <add_npc_line speaker="$DalBusta" line="30220813" hidechoices="true" comment="Kromancketslat says that the diplomatic mission has encountered an... (slight pause befoe 'obstacle')obstacle of sorts."/>
                    <add_npc_line speaker="$Duke" line="30220807" hidechoices="true" comment="(flaring up) An obstacle!?"/>
                    <add_npc_line speaker="$Duke" line="30220808" hidechoices="true" comment="(angry)These three-eyed imbeciles are refusing to allow the negotiations to progress beyond the stage of ceasefire!"/>
                    <add_npc_line speaker="$DalBusta" line="30220814" hidechoices="true" comment="As I said, just a minor hiccup."/>
                    <add_npc_line speaker="$DalBusta" line="30220815" hidechoices="true" comment="We've come to the conclusion that the Paranid will need a... (slight pause before 'tangible')tangible reminder of their shared identity."/>

                    <add_player_choice position="right" highlighted="true" text="{30220,8120}" section="uni_2_dal_continue"/>
                  </actions>
                  <cues>

                    <cue name="Uni_2_Briefing_Dal_Conversation_Section_Continue">
                      <conditions>
                        <event_conversation_next_section actor="$DalBusta" section="uni_2_dal_continue"/>
                      </conditions>
                      <actions>
                        <!-- Turn Kromancketslat around -->
                        <create_rotation name="$DukeRot3" yaw="170.64317deg"/>
                        <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $Duke,
                                                                                                  table[
                                                                                                  $requestercue = namespace,
                                                                                                  $location = $BosoTa.room,
                                                                                                  $rotation = $DukeRot3,
                                                                                                  $position = $DukePos2,
                                                                                                  $priority = 100,
                                                                                                  $debugchance = $DeepDebugChance,
                                                                                                  $debugcaller = if $DebugChance == 100 then this else null]
                                                                                                  ]"/>

                        <allow_conversation_escape enabled="false"/>
                        <add_npc_line speaker="$DalBusta" line="30220816" hidechoices="true" comment="Boso Ta is already reverse-engineering the Paranid preservation technology, so that we can start working on the cocoons as soon as possible."/>
                        <add_npc_line speaker="$DalBusta" line="30220817" hidechoices="true" comment="In the meanwhile, Kromancketslat has unearthed an old, pre-shutdown construction plan for a... (short pause before 'palace', end sentence with slight disbelief)palace of sorts?"/>
                        <add_npc_line speaker="$Duke" line="30220809" hidechoices="true" comment="(grumpy, looking to the side)It was a different era, and I was a different sort of leader then."/>
                        <add_npc_line speaker="$DalBusta" line="if player.entity.isfemale then 30220819 else 30220818" hidechoices="true" comment="As you know, symbolism plays a big role in Paranid culture."/>
                        <add_npc_line speaker="$DalBusta" line="30220820" hidechoices="true" comment="We're fairly certain that the Paranid would be more willing to accept the new status quo if they were presented with three ready-made thrones, standing side by side."/>
                        <add_npc_line speaker="$DalBusta" line="30220821" hidechoices="true" comment="Kromancketslat has already pulled a few strings to have his 'symbol of unity' officially sanctioned, but we're still short a head architect."/>
                      </actions>
                    </cue>

                    <cue name="Uni_2_Briefing_Dal_Conversation_Finished">
                      <conditions>
                        <event_conversation_finished actor="$DalBusta"/>
                      </conditions>
                      <actions>
                        <speak actor="$DalBusta" priority="100">
                          <text line="if player.entity.isfemale then 30220823 else 30220822" comment="Congratulations, you've just been promoted!"/>
                          <text line="if player.entity.isfemale then 30220825 else 30220824" comment="Just so you're mentally prepared, someone will definitely try to sabotage our project once it's nearing completion."/>
                        </speak>

                        <signal_cue cue="Uni_2_Palace_Foundation"/>
                      </actions>
                    </cue>

                  </cues>
                </cue>

              </cues>
            </cue>

            <cue name="Uni_2_Palace_Foundation">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <find_sector name="$PlotSector" macro="macro.cluster_22_sector001_macro" comment="Pious Mists II"/>
                <create_position name="$TargetOffset" space="$PlotSector"/>
                <set_value name="$PlotOffset" exact="position.[$TargetOffset.x, 0m, $TargetOffset.z]" comment="Engine limitation, build station near ecliptic (y=0)"/>
                <!-- This costs about 25 Mio Credits, about 525 Mio if you include Blueprints. -->
                <set_value name="$StationSpecs" exact="table[
                                      $containedmacros = [  [ 3, macro.defence_par_claim_story_01_macro ],
                                                            [ 6, macro.defence_par_disc_01_macro ],
                                                            [ 9, macro.storage_par_l_container_01_macro ],
                                                            [ 9, macro.hab_par_l_01_macro ]
                                                         ],
                                      $containedclasses = [
                                                            [   3, class.dockarea,        {30120,103}, {30120,104}],
                                                            [   3, class.pier,            {30120,111}, {30120,112}],
                                                            [ 180, class.turret,          {30120,105}, {30120,106}],
                                                            [  80, class.shieldgenerator, {30120,109}, {30120,110}]
                                                          ]
                                      ]"/>
                <set_value name="$PlotRange" exact="200km"/>
                <set_value name="$PlotSize" exact="vector.[10km,10km,10km]"/>
                <set_value name="$PlotFaction" exact="faction.trinity"/>

                <run_actions ref="md.GM_BuildStation.ConstructRequirementsText" result="$RequirementsText">
                  <param name="PlotSector"              value="$PlotSector" />
                  <param name="PlotSize"                value="$PlotSize" />
                  <param name="StationSpecs"            value="$StationSpecs" />
                  <param name="DestinationDBString"     value="{30120,200}" />
                </run_actions>

                <set_value name="$CurrentStep" operation="add"/>

                <update_mission cue="$MissionCue" description="(if player.entity.isfemale then {30220,8106} else {30220,8105})
                                                    + '\n\n' + $RequirementsText
                                                    + '\n\n' + {30220,8108}
                                                    + '\n\n' + {30220,8015} + '\n' + {30220,8107}" comment="Description + Station requirements + Special module hint + Diplo and eco predictions"/>
              </actions>
              <delay exact="1s" comment="required to signal a child"/>
              <actions>
                <signal_cue cue="Uni_2_Palace_Foundation_Claim_Plot"/>
              </actions>
              <cues>

                <cue name="Uni_2_Palace_Foundation_Offer_Blueprint" instantiate="true">
                  <conditions>
                    <event_conversation_started/>
                    <check_value value="not player.blueprints.{ware.module_par_def_claim_story_01}.any.exists"/>
                    <check_value value="event.object.type == entitytype.factionrepresentative"/>
                    <check_value value="(event.object.owner == faction.holyorder) or (event.object.owner == faction.paranid)"/>
                  </conditions>
                  <actions>
                    <add_player_choice highlighted="true" section="paranid_story_capital_blueprint_price" text="{30002,171} + {1001,120} + ' ' + {20104,41501}" comment="Blueprint: Faction Capital"/>
                  </actions>
                </cue>

                <cue name="Uni_2_Palace_Foundation_Offer_Blueprint_Price" instantiate="true">
                  <conditions>
                    <event_conversation_next_section section="paranid_story_capital_blueprint_price"/>
                  </conditions>
                  <actions>
                    <add_player_choice section="paranid_story_buy_capital_blueprint" position="left" selectable="player.money ge ware.module_par_def_claim_story_01.maxprice" text="ware.module_par_def_claim_story_01.maxprice.formatted.default + ' ' + {1001,101}" tooltip="if (player.money ge ware.module_par_def_claim_story_01.maxprice) then '' else {1026,3222}" comment="Text: X Cr, Tooltip: Not enough money."/>
                    <add_player_choice section="g_cancel" position="right" text="{1002,2}" comment="Goodbye."/>
                  </actions>
                </cue>

                <cue name="Uni_2_Palace_Foundation_Offer_Blueprint_Selected" instantiate="true">
                  <conditions>
                    <event_conversation_next_section section="paranid_story_buy_capital_blueprint"/>
                  </conditions>
                  <actions>
                    <transfer_money from="faction.player" to="player.conversationactor.owner" amount="ware.module_par_def_claim_story_01.maxprice"/>
                    <add_blueprints wares="ware.module_par_def_claim_story_01"/>
                  </actions>
                </cue>

                <cue name="Uni_2_Palace_Foundation_Build_Station_DEBUG" instantiate="true">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <create_station name="$DebugPalace" macro="macro.station_gen_factory_base_01_macro" owner="faction.player" sector="$PlotSector" state="componentstate.operational" constructionplan="'paranid_trinity_station'">
                      <safepos x="$PlotOffset.x" y="$PlotOffset.y" z="$PlotOffset.z"/>
                    </create_station>
                  </actions>
                </cue>

                <cue name="Uni_2_Palace_Foundation_Claim_Plot">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <cues>
                    <cue name="Uni_2_Palace_Foundation_Claim_Plot_Ref" ref="md.RML_ClaimPlot.ClaimPlot">
                      <!-- mandatory parameters -->
                      <param name="EndSignalCue"      value="Uni_2_Palace_Foundation_Claim_Plot_Done" comment="RML returns $StationBuilt in this cue"/>
                      <param name="MissionCue"        value="$MissionCue"/>
                      <param name="StartStep"         value="$CurrentStep" comment="Briefing step to start the mission on"/>
                      <param name="UpdateBriefing"    value="true" comment="Update the briefing objective step when the objective is updated"/>
                      <param name="DebugChance"       value="100"/>
                      <!-- mission-specific parameters -->
                      <param name="Faction"           value="$PlotFaction"/>
                      <param name="PlotSector"        value="$PlotSector"/>
                      <param name="PlotOffset"        value="$PlotOffset"/>
                      <param name="PlotRange"         value="$PlotRange"/>
                      <param name="PlotSize"          value="$PlotSize"/>
                      <param name="ObjectiveText"     value="{30220,8121}" comment="Plot at Specified Location"/>
                    </cue>

                    <cue name="Uni_2_Palace_Foundation_Claim_Plot_KeepAlive">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                    </cue>
                  </cues>
                </cue>

                <cue name="Uni_2_Palace_Foundation_Claim_Plot_Done">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <set_value name="$CurrentStep" operation="add"/>
                    <set_value name="$CutsceneObject" exact="Uni_2_Palace_Foundation_Claim_Plot_Done.$StationBuilt" />
                    <set_value name="$RML_Result_Table" exact="table[]"/>
                    <reset_cue cue="Uni_2_Palace_Foundation_Claim_Plot" comment="can be signalled again if the station becomes invalid"/>
                  </actions>
                  <cues>

                    <cue name="Uni_2_Palace_Foundation_Build_Station_Ref" ref="md.RML_BuildStation.BuildStation">
                      <!-- always pass these -->
                      <param name="EndSignalCue"      value="Uni_2_Palace_Foundation_Build_Station_Complete"/>
                      <param name="MissionCue"        value="$MissionCue"/>
                      <param name="StartStep"         value="$CurrentStep" comment="Briefing step to start the mission on"/>
                      <param name="UpdateBriefing"    value="true" comment="Update the briefing objective step when the objective is updated"/>
                      <param name="DebugChance"       value="100"/>
                      <!-- mission-related parameters -->
                      <param name="Station"           value="Uni_2_Palace_Foundation_Claim_Plot_Done.$StationBuilt"/>
                      <param name="StationSpecs"      value="$StationSpecs"/>
                      <param name="Faction"           value="$PlotFaction"/>
                      <param name="PlotSector"        value="$PlotSector"/>
                      <param name="PlotOffset"        value="$PlotOffset"/>
                      <param name="PlotRange"         value="$PlotRange"/>
                      <param name="PlotSize"          value="$PlotSize"/>
                      <param name="ObjectiveText"     value="{30220,8122}" comment="Palace Foundation"/>
                      <!--param name="ResultTable"       value="$RML_Result_Table"/-->
                    </cue>

                    <cue name="Uni_2_Palace_Foundation_Build_Station_Complete">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <!--Station plot was destroyed, or moved outside the specified position - restart the claim plot objective-->
                        <do_if value="(this.$EndFeedbackValue == -1) or (this.$EndFeedbackValue == -3)">
                          <debug_text text="'Restart claimplot objective'"/>
                          <set_value name="$CurrentStep" operation="subtract"/>
                          <set_value name="Uni_2_Palace_Foundation_Claim_Plot_Done.$StationBuilt" exact="null"/>
                          <signal_cue cue="Uni_2_Palace_Foundation_Claim_Plot"/>
                          <reset_cue cue="Uni_2_Palace_Foundation_Claim_Plot_Done"/>
                        </do_if>
                        <!-- Failure case (invalid parameters passed into RML) -->
                        <do_elseif value="this.$EndFeedbackValue" max="0">
                        </do_elseif>
                        <!-- Success case -->
                        <do_else>
                          <debug_text text="'Completed station as specified'"/>
                          <set_value name="$TrinityPalace" exact="Uni_2_Palace_Foundation_Claim_Plot_Done.$StationBuilt"/>
                          <find_object_component name="$TrinityPalaceAdministration" object="$TrinityPalace" canclaimownership="true"/>
                          <debug_text text="'$TrinityPalace ownership-claiming module found: ' + $TrinityPalaceAdministration" chance="$DebugChance"/>
                          <set_object_min_hull object="$TrinityPalaceAdministration" exact="100" comment="Trinity is here to stay."/>
                          <signal_cue cue="Uni_2_Palace_Defense"/>
                        </do_else>
                      </actions>
                    </cue>
                  </cues>
                </cue>
              </cues>
            </cue>

            <cue name="Uni_2_Palace_Defense">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <set_value name="$PalaceWave1Setup" exact="[
                   [ macro.ship_par_l_destroyer_01_b_macro,     0 ],
                   [ macro.ship_par_m_corvette_01_b_macro,      4 ],
                   [ macro.ship_par_m_frigate_01_b_macro,       4 ],
                   [ macro.ship_par_s_heavyfighter_01_a_macro,  6 ],
                   [ macro.ship_par_s_fighter_02_b_macro,       8 ],
                   [ macro.ship_par_s_fighter_01_b_macro,       8 ]
                   ]" />

                <set_value name="$PalaceWave2Setup" exact="[
                   [ macro.ship_par_l_destroyer_01_b_macro,     4 ],
                   [ macro.ship_par_m_corvette_01_b_macro,      8 ],
                   [ macro.ship_par_m_frigate_01_b_macro,       8 ],
                   [ macro.ship_par_s_heavyfighter_01_a_macro, 10 ],
                   [ macro.ship_par_s_fighter_02_b_macro,      12 ],
                   [ macro.ship_par_s_fighter_01_b_macro,      12 ]
                   ]" />

                <set_value name="$CurrentStep" operation="add"/>
                <set_value name="$PalaceAttackDelay" exact="15min"/>
                <set_objective cue="$MissionCue" step="$CurrentStep" endtime="player.age + $PalaceAttackDelay" action="objective.await" object="$TrinityPalace" updatebriefing="true" insert="true" text="{30220,8123}" comment="Await: Imminent Attack"/>
              </actions>
              <delay exact="$PalaceAttackDelay"/>
              <actions>
                <signal_cue cue="Uni_2_Palace_Defense_Wave_1"/>
              </actions>
              <cues>

                <cue name="Uni_2_Palace_Defense_Dal_Speak">
                  <cues>
                    <cue name="Uni_2_Dal_Speak_826_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$DalBusta"/>
                      <param name="CutsceneKey"       value="$DalCutsceneKey"/>
                      <param name="Lines"             value="[[if player.entity.isfemale then 30220827 else 30220826]]"/>
                      <param name="EndSignalCue"      value="null"/>
                      <!--
                          The palace foundation is nearly complete. You'd better get a defence ready.
                            -->
                    </cue>
                  </cues>
                </cue>

                <cue name="Uni_2_Palace_Defense_Wave_1">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <!-- Prevent stray shots from making the station turn hostile towards the player. -->
                    <set_object_relation_behaviour object="$TrinityPalace" disable="true"/>

                    <!-- Send mediation fleet over to help. They'll hopefully arrive when wave 2 attacks. -->
                    <do_if value="@$TrinityCommander" comment="Value might not exist in the debug case.">
                      <reset_cue cue="Uni_1_Mediation_Fleet_Patrol"/>
                      <create_order object="$TrinityCommander" id="'MoveToObject'" immediate="true">
                        <param name="destination" value="$TrinityPalace"/>
                      </create_order>
                    </do_if>

                    <do_all exact="$PalaceWave1Setup.count" counter="$m">
                      <do_all exact="$PalaceWave1Setup.{$m}.{2}" counter="$a">
                        <create_ship name="$CurrentShip" macro="$PalaceWave1Setup.{$m}.{1}" commandeerable="false" capturable="true" mission="true" sector="$TrinityPalace.sector">
                          <owner exact="faction.holyorderfanatic" overridenpc="true"/>
                          <pilot>
                            <select faction="faction.holyorder" tags="tag.elitepilot"/>
                          </pilot>
                          <loadout>
                            <level exact="1.0"/>
                          </loadout>
                          <people ref="paranid_elite_military_crew"/>
                          <position object="$TrinityPalace" min="30km" max="50km"/>
                        </create_ship>
                        <set_relation_boost object="$CurrentShip" faction="faction.trinity" value="-1.0" decay="0"/>
                        <set_relation_boost object="$CurrentShip" faction="faction.player" value="-1.0" decay="0"/>
                        <create_order id="'Attack'" object="$CurrentShip">
                          <param name="primarytarget" value="$TrinityPalace"/>
                          <param name="pursuetargets" value="true"/>
                          <param name="checkrelation" value="false"/>
                        </create_order>
                        <add_to_group groupname="$PalaceWave1" object="$CurrentShip"/>
                      </do_all>
                    </do_all>

                    <!-- Don't insert, just overwrite the previous objective (await). -->
                    <set_objective cue="$MissionCue" step="$CurrentStep" endtime="$PalaceAttackDelay" action="objective.defend" group="$PalaceWave1" text="{20103,2201}" updatebriefing="true" comment="Defend: Sacrosanct Conclave"/>
                  </actions>
                  <cues>
                    <cue name="Uni_2_Palace_Defense_Wave_1_Dal_Speak">
                      <cues>
                        <cue name="Uni_2_Dal_Speak_828_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$DalBusta"/>
                          <param name="CutsceneKey"       value="$DalCutsceneKey"/>
                          <param name="Lines"             value="[[30220828],[30220829]]"/>
                          <param name="EndSignalCue"      value="null"/>
                          <!--
                                Here they come!
                                We must be facing a whole coalition of saboteurs and dissidents.
                            -->
                        </cue>
                      </cues>
                    </cue>
                    <cue name="Uni_2_Palace_Defense_Wave_1_Not_Him_Again">
                      <conditions>
                        <event_object_destroyed group="$PalaceWave1"/>
                        <check_value value="$PalaceWave1.count le 24"/>
                      </conditions>
                      <actions>
                        <do_all exact="9" comment="9 is a multiple of 3">
                          <create_ship ref="holyorder_corvette_m_elite" name="$NewNemesis" commandeerable="false" capturable="false" mission="true" sector="$TrinityPalace.sector">
                            <owner exact="faction.holyorder" overridenpc="true"/>
                            <pilot actor="$RikActor"/>
                            <people ref="paranid_elite_military_crew"/>
                          </create_ship>
                          <set_relation_boost object="$NewNemesis" faction="faction.paranid" value="1.0" decay="0"/>
                          <set_relation_boost object="$NewNemesis" faction="faction.player" value="1.0" decay="0"/>
                          <set_relation_boost object="$NewNemesis" faction="faction.holyorderfanatic" value="-1.0" decay="0"/>
                          <add_to_group groupname="$UniHonourGuard" object="$NewNemesis"/>
                          <do_if value="$UniHonourGuardLeader?">
                            <create_order id="'AssignCommander'" object="$NewNemesis" immediate="true">
                              <param name="commander" value="$UniHonourGuardLeader"/>
                              <param name="assignment" value="assignment.defence"/>
                              <param name="cancelorders" value="true"/>
                            </create_order>
                          </do_if>
                          <do_else>
                            <set_value name="$UniHonourGuardLeader" exact="$NewNemesis"/>
                            <create_order id="'Attack'" object="$UniHonourGuardLeader">
                              <param name="primarytarget" value="$PalaceWave1.random"/>
                              <param name="secondarytargets" value="$PalaceWave1"/>
                              <param name="pursuetargets" value="true"/>
                              <param name="checkrelation" value="false"/>
                            </create_order>
                          </do_else>
                        </do_all>
                      </actions>
                      <cues>
                        <cue name="Uni_2_Rik_Speak_10518_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$RikActor"/>
                          <param name="CutsceneKey"       value="$RikCutsceneKey"/>
                          <param name="Lines"             value="[[10518],[10509],[1010, 0.5s]]"/>
                          <param name="EndSignalCue"      value="null"/>
                          <!--
                                Reinforcements arriving.
                                You are free to engage.
                                Huzzah. (he sounds so bored...)
                            -->
                        </cue>
                      </cues>
                    </cue>
                    <cue name="Uni_2_Palace_Defense_Wave_1_Defeated">
                      <conditions>
                        <event_object_destroyed group="$PalaceWave1"/>
                        <check_value value="$PalaceWave1.count == 1"/>
                      </conditions>
                      <actions>
                        <signal_cue cue="Uni_2_Palace_Defense_Wave_2"/>
                      </actions>
                    </cue>
                  </cues>
                </cue>

                <cue name="Uni_2_Palace_Defense_Wave_2">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <do_all exact="$PalaceWave2Setup.count" counter="$m">
                      <do_all exact="$PalaceWave2Setup.{$m}.{2}" counter="$a">
                        <create_ship name="$CurrentShip" macro="$PalaceWave2Setup.{$m}.{1}" commandeerable="false" capturable="true" mission="true" sector="$TrinityPalace.sector">
                          <owner exact="faction.holyorderfanatic" overridenpc="true"/>
                          <pilot>
                            <select faction="faction.holyorder" tags="tag.elitepilot"/>
                          </pilot>
                          <loadout>
                            <level exact="1.0"/>
                          </loadout>
                          <people ref="paranid_elite_military_crew"/>
                          <position object="$TrinityPalace" min="30km" max="50km"/>
                        </create_ship>
                        <set_relation_boost object="$CurrentShip" faction="faction.trinity" value="-1.0" decay="0"/>
                        <set_relation_boost object="$CurrentShip" faction="faction.player" value="-1.0" decay="0"/>
                        <create_order id="'Attack'" object="$CurrentShip">
                          <param name="primarytarget" value="$TrinityPalace"/>
                          <param name="pursuetargets" value="true"/>
                          <param name="checkrelation" value="false"/>
                        </create_order>
                        <add_to_group groupname="$PalaceWave2" object="$CurrentShip"/>

                        <!-- Make Honour Guard react to the new attackers -->
                        <do_if value="$UniHonourGuard.count">
                          <do_for_each in="$UniHonourGuard" name="$CurrentShip">
                            <create_order id="'Attack'" object="$CurrentShip">
                              <param name="primarytarget" value="$PalaceWave2.random"/>
                              <param name="secondarytargets" value="$PalaceWave2"/>
                              <param name="pursuetargets" value="true"/>
                              <param name="checkrelation" value="false"/>
                            </create_order>
                          </do_for_each>
                        </do_if>
                      </do_all>
                    </do_all>

                    <set_objective cue="$MissionCue" step="$CurrentStep" endtime="$PalaceAttackDelay" action="objective.defend" group="$PalaceWave2" text="{20103,2201}" updatebriefing="true" comment="Defend: Sacrosanct Conclave"/>
                  </actions>
                  <cues>
                    <cue name="Uni_2_Palace_Defense_Wave_2_Dal_Speak">
                      <cues>
                        <cue name="Uni_2_Dal_Speak_219_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$DalBusta"/>
                          <param name="CutsceneKey"       value="$DalCutsceneKey"/>
                          <param name="Lines"             value="[[if player.entity.isfemale then 30220220 else 30220219]]"/>
                          <param name="EndSignalCue"      value="null"/>
                          <!--
                                Watch out, there are more of them!
                            -->
                        </cue>
                      </cues>
                    </cue>
                    <cue name="Uni_2_Palace_Defense_Wave_2_Defeated">
                      <conditions>
                        <event_object_destroyed group="$PalaceWave2"/>
                        <check_value value="$PalaceWave2.count == 1"/>
                      </conditions>
                      <actions>
                        <set_object_relation_behaviour object="$TrinityPalace" disable="false"/>

                        <!--Honour Guard stays in the sector.-->
                        <do_if value="$UniHonourGuard.count">
                          <set_value name="$UniHonourGuardLeader" exact="$UniHonourGuard.{1}"/>
                          <create_order id="'Patrol'" object="$UniHonourGuardLeader" default="true">
                            <param name="space" value="$TrinityPalace.sector"/>
                          </create_order>
                          <do_for_each in="$UniHonourGuard" name="$CurrentShip">
                            <do_if value="$CurrentShip != $UniHonourGuardLeader">
                              <create_order id="'AssignCommander'" object="$CurrentShip" immediate="true">
                                <param name="commander" value="$UniHonourGuardLeader"/>
                                <param name="assignment" value="assignment.defence"/>
                                <param name="cancelorders" value="true"/>
                              </create_order>
                            </do_if>
                          </do_for_each>
                        </do_if>

                        <signal_cue cue="Uni_1_Mediation_Fleet_Patrol" comment="In the debug case, if Uni_2 has been skipped partially, this might fail, which can be ignored."/>
                        <signal_cue cue="Uni_2_Diplomatic_Change"/>
                      </actions>
                      <cues>
                        <cue name="Uni_2_Dal_Speak_830_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$DalBusta"/>
                          <param name="CutsceneKey"       value="$DalCutsceneKey"/>
                          <param name="Lines"             value="[[30220660],[30220830, 0.5s],[if player.entity.isfemale then 30220832 else 30220831, 0.5s]]"/>
                          <param name="EndSignalCue"      value="Uni_2_Diplomatic_Change"/>
                          <!--
                          That's the last of them!
                          Looks like the construction site is safe for now.
                          I'll notify you once things have cooled down a little.
                            -->
                        </cue>
                      </cues>
                    </cue>
                  </cues>
                </cue>

              </cues>
            </cue>

            <cue name="Uni_2_Diplomatic_Change">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <debug_text text="'Palace defense mission complete, signalling creation of faction.trinity faction logic instance.'" chance="$DebugChance"/>
                <signal_cue cue="Unification_Stage_2_BufferSector"/>
                <signal_cue cue="Uni_2_Cooldown"/>
              </actions>
            </cue>

            <cue name="Uni_2_Cooldown">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <cues>

                <cue name="Uni_2_Cooldown_Update_Objective">
                  <actions>
                    <set_value name="$CurrentStep" operation="add"/>
                    <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.await" text="{30220,8007}" updatebriefing="true" insert="true" comment="Await: Next Stage of the Plan"/>

                    <!-- Make Duke leave HQ-->
                    <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $Duke,
                                                                                                  table[
                                                                                                  $requestercue = namespace,
                                                                                                  $location = 'disconnect',
                                                                                                  $rotation = $DukeRot,
                                                                                                  $position = $DukePos,
                                                                                                  $priority = 100,
                                                                                                  $debugchance = $DeepDebugChance,
                                                                                                  $debugcaller = if $DebugChance == 100 then this else null]
                                                                                                  ]"/>
                  </actions>
                </cue>

                <cue name="Uni_2_Cooldown_Delay">
                  <delay exact="10min"/>
                  <actions>
                    <write_to_logbook category="missions" faction="faction.player" title="{30220,8101}" text="if player.entity.isfemale then {30220,8114} else {30220,8113}"/>
                    <signal_cue cue="Sinks_Unification_Stage_3"/>
                  </actions>
                </cue>

              </cues>
            </cue>

          </cues>
        </cue>

        <cue name="Sinks_Unification_Stage_3">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <cues>

            <cue name="Uni_3_Boso_Call">
              <actions>
                <set_value name="$BosoCallInterval" exact="5min"/>
              </actions>
              <cues>

                <cue name="Uni_3_Boso_Call_Parent">
                  <delay exact="$BosoCallInterval"/>
                  <actions>
                    <do_if value="$HQ? and $DalBusta.hascontext.{$HQ}">
                      <debug_text text="'Starting Boso Ta call in unification sinks stage 3.'" chance="$DebugChance"/>
                      <play_cutscene key="$BosoCutsceneKey.$key" result="this.$CutsceneID" targetmonitor="true">
                        <interaction text="{30220,1004}" param="$BosoTa" param2="'accept_interaction'"/>
                        <param name="npcref" object="$BosoTa" />
                      </play_cutscene>
                    </do_if>
                    <do_else>
                      <debug_text text="'Dal Busta is not on the HQ. Resetting Uni 3 Boso Ta call.'" chance="$DebugChance"/>
                      <reset_cue cue="Uni_3_Boso_Call_Parent"/>
                    </do_else>
                  </actions>
                  <cues>

                    <cue name="Uni_3_Boso_Call_Speak">
                      <conditions>
                        <event_cutscene_started key="$BosoCutsceneKey.$key"/>
                      </conditions>
                      <actions>
                        <signal_cue cue="Uni_3_Boso_Call_No_Interact"/>
                        <speak actor="$BosoTa" priority="100">
                          <text line="if player.entity.isfemale then 30200011 else 30200010" delay="0.6s" comment="Assistant!"/>
                        </speak>
                      </actions>
                    </cue>

                    <!--Accept the call-->
                    <cue name="Uni_3_Boso_Call_Interact">
                      <conditions>
                        <event_player_interaction param="$BosoTa" param2="'accept_interaction'"/>
                      </conditions>
                      <actions>
                        <stop_cutscene cutscene="parent.$CutsceneID"/>
                        <cancel_cue cue="Uni_3_Boso_Call_No_Interact"/>

                        <signal_cue cue="Uni_3_Boso_Call_Conversation"/>
                      </actions>
                    </cue>

                    <!--Fail to accept the call-->
                    <cue name="Uni_3_Boso_Call_No_Interact">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <delay exact="10s" comment="cutscene timeout"/>
                      <actions>
                        <stop_cutscene cutscene="parent.$CutsceneID"/>
                        <reset_cue cue="parent"/>
                      </actions>
                    </cue>

                  </cues>
                </cue>

                <cue name="Uni_3_Boso_Call_Conversation">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <start_conversation actor="$BosoTa" conversation="boso_uni_3_call" priority="100"/>
                  </actions>
                  <cues>
                    <cue name="Uni_3_Boso_Call_Conversation_Section_Main">
                      <conditions>
                        <event_conversation_started actor="$BosoTa" conversation="boso_uni_3_call"/>
                      </conditions>
                      <actions>
                        <allow_conversation_escape enabled="false"/>

                        <add_npc_line speaker="$BosoTa" line="if player.entity.isfemale then 30220803 else 30220802" hidechoices="true" comment="My adventurous, resourceful assistant!"/>
                        <add_npc_line speaker="$BosoTa" line="if player.entity.isfemale then 30220805 else 30220804" hidechoices="true" comment="While our Paranid friends have ceased attempting to slay their own siblings, I have made some great progress on the cocoons you so deviously pilfered."/>
                        <add_npc_line speaker="$BosoTa" line="if player.entity.isfemale then 30220807 else 30220806" hidechoices="true" comment="Please return to my science laboratory."/>
                      </actions>
                    </cue>
                    <cue name="Uni_3_Boso_Call_Conversation_Finished">
                      <conditions>
                        <event_conversation_finished actor="$BosoTa"/>
                      </conditions>
                      <actions>
                        <remove_mission cue="$MissionCue" type="completed"/>
                        <signal_cue cue="Uni_3_Briefing"/>
                      </actions>
                    </cue>
                  </cues>
                </cue>

              </cues>
            </cue>

            <cue name="Uni_3_Briefing">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <debug_text text="'Unification sinks stage 3 conversation now available at HQ'" chance="$DebugChance"/>

                <create_mission cue="$MissionCue" name="{30220,8201}" description="if player.entity.isfemale then {30220,8203} else {30220,8202}" rewardtext="{30220,8204}" type="missiontype.plot" faction="faction.player" difficulty="level.veryhard" abortable="false" icon="'briefing_boso_ta_01'" iconcaption="$BosoTa.name">
                  <briefing>
                    <objective step="1" action="objective.talkto" object="$BosoTa" comment="Talk to: Boso Ta"/>
                  </briefing>
                </create_mission>
                <set_value name="$CurrentStep" exact="1"/>
                <set_objective_from_briefing cue="$MissionCue" step="$CurrentStep"/>
              </actions>
              <cues>

                <cue name="Uni_3_Briefing_Boso_Conversation">
                  <conditions>
                    <event_conversation_started actor="$BosoTa"/>
                  </conditions>
                  <actions>
                    <allow_conversation_escape enabled="false"/>
                    <add_npc_line speaker="$BosoTa" hidechoices="true" line="if player.entity.isfemale then 30220809 else 30220808" comment="Welcome back, great peacemaker."/>
                    <add_npc_line speaker="$BosoTa" hidechoices="true" line="30220810" comment="I sense that Dal has something on his mind."/>
                  </actions>
                  <cues>
                    <cue name="Uni_3_Briefing_Boso_Conversation_Finished">
                      <conditions>
                        <event_conversation_finished actor="$BosoTa"/>
                      </conditions>
                      <actions>
                        <!-- Overwrite previous objective, so don't increase $CurrentStep. -->
                        <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.talkto" object="$DalBusta" updatebriefing="true" comment="Talk to: Dal Busta"/>
                      </actions>
                    </cue>
                  </cues>
                </cue>

                <cue name="Uni_3_Briefing_Dal_Conversation_Header" instantiate="true">
                  <conditions>
                    <event_conversation_started actor="$DalBusta"/>
                    <check_value value="$HQ? and $DalBusta.hascontext.{$HQ} and player.entity.hascontext.{$HQ}"/>
                  </conditions>
                  <actions>
                    <add_player_choice text="{30220,205}" section="uni_3_dal_main" comment="Paranid Civil War"/>
                  </actions>
                </cue>

                <cue name="Uni_3_Briefing_Dal_Conversation">
                  <conditions>
                    <event_conversation_next_section actor="$DalBusta" section="uni_3_dal_main"/>
                  </conditions>
                  <actions>
                    <cancel_cue cue="Uni_3_Briefing_Dal_Conversation_Header"/>
                    <!-- Cancel Boso Ta's intial conversation. -->
                    <cancel_cue cue="Uni_3_Briefing_Boso_Conversation"/>

                    <allow_conversation_escape enabled="false"/>

                    <add_npc_line speaker="$DalBusta" line="30220841" hidechoices="true" comment="I can proudly proclaim that our Third Pontifex plan is still in full swing."/>
                    <add_npc_line speaker="$DalBusta" line="30220988" hidechoices="true" comment="We're ready for the next stage."/>

                    <add_player_choice position="top_left" text="{30220,8215}" section="uni_3_dal_optional" comment="Anything on your mind?"/>
                    <add_player_choice position="right" highlighted="true" text="{30220,8216}" section="uni_3_dal_continue" comment="How do we proceed?"/>
                  </actions>
                  <cues>

                    <cue name="Uni_3_Briefing_Dal_Conversation_Section_Optional">
                      <conditions>
                        <event_conversation_next_section actor="$DalBusta" section="uni_3_dal_optional"/>
                      </conditions>
                      <actions>
                        <allow_conversation_escape enabled="false"/>

                        <add_npc_line speaker="$DalBusta" line="if player.entity.isfemale then 30220834 else 30220833" hidechoices="true" comment="You know, one thing that our friend Kromancketslat said keeps bothering me."/>
                        <add_npc_line speaker="$DalBusta" line="if player.entity.isfemale then 30220836 else 30220835" hidechoices="true" comment="Remember how he insisted that ambitious individuals can't realise their potential because of the rigid Paranid hierarchy?"/>

                        <add_player_choice position="right" highlighted="true" text="{30220,8218}" section="uni_3_dal_optional_2" comment="What about it?"/>

                      </actions>
                      <cues>
                        <cue name="Uni_3_Briefing_Dal_Conversation_Section_Optional_2">
                          <conditions>
                            <event_conversation_next_section actor="$DalBusta" section="uni_3_dal_optional_2"/>
                          </conditions>
                          <actions>
                            <allow_conversation_escape enabled="false"/>

                            <add_npc_line speaker="$DalBusta" line="30220837" hidechoices="true" comment="Well, I found out that high priests and officials are indeed hand-crafted for their specific roles, so there's some... (short pause before 'fundamental')fundamental unflexibility."/>
                            <add_npc_line speaker="$DalBusta" line="30220838" hidechoices="true" comment="But according to the grand tales they tell about their heroes, a Paranid can very much be promoted by proving himself worthy."/>
                            <add_npc_line speaker="$BosoTa" line="30220811" hidechoices="true" comment="(joyously)Perhaps our triangular friend was in a state of crippling self-doubt?"/>
                            <add_npc_line speaker="$DalBusta" line="30220839" hidechoices="true" comment="(serious)I don't think so."/>
                            <add_npc_line speaker="$DalBusta" line="30220840" hidechoices="true" comment="But there's no point in dwelling on that inconsistency right now."/>

                            <add_player_choice position="top_left" selectable="false" text="{30220,8215}" section="uni_3_dal_optional" comment="Anything on your mind?"/>
                            <add_player_choice position="right" highlighted="true" text="{30220,8216}" section="uni_3_dal_continue" comment="How do we proceed?"/>
                          </actions>
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Uni_3_Briefing_Dal_Conversation_Section_Continue">
                      <conditions>
                        <event_conversation_next_section actor="$DalBusta" section="uni_3_dal_continue"/>
                      </conditions>
                      <actions>
                        <allow_conversation_escape enabled="false"/>

                        <add_npc_line speaker="$DalBusta" line="30220842" hidechoices="true" comment="There are two parts to this final step."/>
                        <add_npc_line speaker="$DalBusta" line="30220843" hidechoices="true" comment="First of all, we need to take care of the cocoons in our custody."/>
                        <add_npc_line speaker="$DalBusta" line="30220844" hidechoices="true" comment="Boso Ta and Kromancketslat will be in charge of terminating the preservation process and indoctrinating the occupants, respectively."/>
                        <add_npc_line speaker="$BosoTa" line="if player.entity.isfemale then 30220813 else 30220812" hidechoices="true" comment="Do not worry, my ethically immaculate assistant! Indoctrination is a very natural thing to these Paranid fellows."/>
                        <add_npc_line speaker="$DalBusta" line="30220845" hidechoices="true" comment="They'd be in a constant state of discomfort and uncertainty if we didn't catch them on the way out."/>
                        <add_npc_line speaker="$DalBusta" line="30220846" hidechoices="true" comment="At least that's what Kromancketslat told us before he left on important business."/>

                        <add_player_choice position="right" highlighted="true" text="{30220,8217}" section="uni_3_dal_continue_2" comment="What else needs to be done?"/>
                      </actions>
                      <cues>
                        <cue name="Uni_3_Briefing_Dal_Conversation_Section_Continue_2">
                          <conditions>
                            <event_conversation_next_section actor="$DalBusta" section="uni_3_dal_continue_2"/>
                          </conditions>
                          <actions>
                            <allow_conversation_escape enabled="false"/>

                            <add_npc_line speaker="$DalBusta" line="30220847" hidechoices="true" comment="Secondly, the new palace needs some finishing touches."/>
                            <add_npc_line speaker="$DalBusta" line="30220848" hidechoices="true" comment="Kromancketslat's blueprints prescribe the layout in great detail."/>
                            <add_npc_line speaker="$DalBusta" line="if player.entity.isfemale then 30220850 else 30220849" hidechoices="true" comment="I recommend resuming construction right away, so you can indulge Boso's every whim in the meanwhile."/>
                          </actions>
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Uni_3_Briefing_Dal_Conversation_Finished">
                      <conditions>
                        <event_conversation_finished actor="$DalBusta"/>
                      </conditions>
                      <actions>
                        <speak actor="$DalBusta" priority="100">
                          <text line="30220851" comment="Good luck out there."/>
                        </speak>

                        <signal_cue cue="Uni_3_Double_Sink"/>
                      </actions>
                    </cue>

                  </cues>
                </cue>

              </cues>
            </cue>

            <cue name="Uni_3_Double_Sink">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <debug_text text="'Starting Paranid Story Unification sinks stage 3 double mission (deliver inventory and deliver resources)'" chance="$DebugChance"/>

                <update_mission cue="$MissionCue" description="(if player.entity.isfemale then {30220,8206} else {30220,8205})
                                                    + '\n\n' + {30220,8015} + '\n' + {30220,8207} + ' ' + {30220,8208}" comment="Description + Diplo and eco predictions" icon="'briefing_dal_busta_01'" iconcaption="$DalBusta.name">
                  <briefing>
                    <objective step="1" action="objective.talkto"  text="{30220,8220}" comment="Talk to: Your Mentors"/>
                    <objective step="2" action="objective.deliver" text="{30220,8221}" comment="Deliver: Construction Material to the Palace"/>
                    <objective step="3" action="objective.deliver" text="{30220,8222}" comment="Deliver: Scientific Supplies to Boso Ta"/>
                  </briefing>
                </update_mission>

                <set_objective_from_briefing cue="$MissionCue" step="2"/>
              </actions>
              <cues>

                <cue name="Uni_3_Deliver_Resources">
                  <actions>
                    <!-- These wares cost about 260 Mio Credits -->
                    <set_value name="$DeliverResourcesTable" exact="table[
                                                                          {ware.hullparts}           = 666666,
                                                                          {ware.smartchips}          =  99999,
                                                                          {ware.fieldcoils}          =  33333,
                                                                          {ware.advancedelectronics} =  33333,
                                                                          {ware.medicalsupplies}     = 333333,
                                                                          {ware.claytronics}         =  99999,
                                                                          {ware.sojahusk}            = 333333,
                                                                          {ware.spacefuel}           =  99999,
                                                                          {ware.majadust}            =  33333
                                                                          ]"/>

                    <set_value name="$MissionCue_Uni_3_Deliver_Resources" exact="this"/>
                    <create_mission cue="$MissionCue_Uni_3_Deliver_Resources" name="{30220,8230}" description="if player.entity.isfemale then {30220,8232} else {30220,8231}" type="missiontype.plot" faction="faction.player" difficulty="level.veryhard" abortable="false" icon="'briefing_kromancketslat_01'" iconcaption="$Duke.name">
                      <briefing>
                        <objective step="1" action="objective.deliver" text="{30220,8221}" object="$TrinityPalace" comment="Deliver: Construction Material to the Palace"/>
                      </briefing>
                    </create_mission>
                  </actions>
                  <cues>

                    <cue name="Uni_3_Deliver_Resources_Prepare_Station" version="2">
                      <actions>
                        <create_list name="$TradeOfferList"/>
                        <do_for_each in="$DeliverResourcesTable" name="$CurrentWare">
                          <create_trade_offer buyer="$TrinityPalace" object="$TrinityPalace" ware="$CurrentWare" amount="$DeliverResourcesTable.{$CurrentWare}" mission="true" name="$TradeOffer" playeronly="true" price="0ct"/>
                          <append_to_list name="$TradeOfferList" exact="$TradeOffer"/>
                        </do_for_each>
                      </actions>
                      <patch sinceversion="2">
                        <!-- Private beta testers might still have the tradeware version of the mission, which we need to replace. -->
                        <do_if value="not $TradeOfferList?" comment="Only for private beta testers.">
                          <do_for_each in="$DeliverResourcesTable" name="$CurrentWare">
                            <remove_tradeware object="$TrinityPalace" ware="$CurrentWare"/>
                          </do_for_each>
                        </do_if>
                        <reset_cue cue="this"/>
                      </patch>
                    </cue>

                    <cue name="Uni_3_Deliver_Resources_Ref" ref="md.RML_Deliver_Wares.DeliverWares">
                      <param name="EndSignalCue"  value="Uni_3_Deliver_Resources_End"/>
                      <param name="MissionCue"    value="$MissionCue_Uni_3_Deliver_Resources"/>
                      <param name="StartStep"     value="1"                       comment="Briefing step to start the mission on." />

                      <param name="Station"       value="$TrinityPalace"          comment="The station to which the player should deliver wares" />
                      <param name="Wares"         value="$DeliverResourcesTable"  comment="Table of wares to accept. Format: table[[$Ware, $Amount], [$Ware, Amount], ...]" />
                      <param name="PlayerOnly"    value="true"                    comment="Should the RML only accept trades made by player-owned ships?"/>

                      <param name="DebugChance"   value="$DebugChance" />
                    </cue>

                    <cue name="Uni_3_Deliver_Resources_End">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <do_for_each in="$TradeOfferList" name="$TradeOffer">
                          <remove_trade_offer object="$TrinityPalace" tradeoffer="$TradeOffer"/>
                        </do_for_each>
                        <remove_mission cue="$MissionCue_Uni_3_Deliver_Resources" type="completed"/>
                        <set_value name="$Uni_3_Deliver_Resources_Completed"/>
                      </actions>
                      <cues>
                        <cue name="Uni_3_Dal_Speak_985_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$DalBusta"/>
                          <param name="CutsceneKey"       value="$DalCutsceneKey"/>
                          <param name="Lines"             value="[[30220985]]"/>
                          <param name="EndSignalCue"      value="Uni_3_Double_Sink_Completion_Check"/>
                          <!--
                              That should do it!
                            -->
                        </cue>
                      </cues>
                    </cue>

                  </cues>
                </cue>

                <cue name="Uni_3_Deliver_Inventory">
                  <actions>
                    <set_value name="$DeliverInventoryTable" exact="table[
                                                                          {ware.inv_microgimble}     = 9,
                                                                          {ware.inv_sedative}        = 9,
                                                                          {ware.inv_crystal_04}      = 9,
                                                                          {ware.inv_remotedetonator} = 9,
                                                                          {ware.inv_spaceflycaviar}  = 1
                                                                          ]"/>

                    <set_value name="$ProgressBarText" exact="{30220,8224}" comment="Supplies delivered"/>
                    <set_value name="$ConversationOptionText" exact="{30135,104}" comment="(Conversation option)Deliver: $AMOUNT$x $WARE$"/>
                    <set_value name="$ConversationTipText" exact="{30135,105}" comment="(Tool tip)Collect the items before trying to deliver them."/>

                    <set_value name="$MissionCue_Uni_3_Deliver_Inventory" exact="this"/>

                    <set_value name="$DeliverCreditsStep" exact="$DeliverInventoryTable.keys.count + 1"/>

                    <set_value name="$Cr_Amount" exact="500 * 1000 * 1000"/>

                    <substitute_text text="$OfferCredits" source="{30220,8219}" comment="(Conversation option to pay money)Fund research \($CREDITS$Cr\)">
                      <replace string="'$CREDITS$'" with="'' + (($Cr_Amount)Cr).formatted.default" />
                    </substitute_text>

                    <substitute_text text="$OfferCreditsObjectiveText" source="{30220,8226}" comment="(Fund: )Boso Ta's research \($CREDITS$Cr\)">
                      <replace string="'$CREDITS$'" with="'' + (($Cr_Amount)Cr).formatted.default" />
                    </substitute_text>

                    <create_mission cue="$MissionCue_Uni_3_Deliver_Inventory" name="{30220,8233}" description="if player.entity.isfemale then {30220,8235} else {30220,8234}" type="missiontype.plot" faction="faction.player" difficulty="level.veryhard" abortable="false" icon="'briefing_boso_ta_01'" iconcaption="$BosoTa.name">
                      <briefing>
                        <objective step="1" action="objective.deliver" text="{30220,8222}" object="$BosoTa" comment="Deliver: Scientific Supplies to Boso Ta"/>
                        <objective step="$DeliverCreditsStep" action="objective.custom" customaction="{30220,8225}" object="$BosoTa" text="$OfferCreditsObjectiveText" comment="Fund: Boso Ta's research \($CREDITS$Cr\)"/>
                      </briefing>
                    </create_mission>
                  </actions>
                  <cues>

                    <cue name="Uni_3_Deliver_Inventory_Ref" ref="md.RML_Deliver_Inventory.Deliver_Inventory">
                      <param name="EndSignalCue"            value="Uni_3_Deliver_Inventory_Credits"/>
                      <param name="MissionCue"              value="$MissionCue_Uni_3_Deliver_Inventory"/>
                      <param name="StartStep"               value="1"                       comment="Briefing step to start the mission on"/>
                      <param name="UpdateBriefing"          value="true"                    comment="Update the briefing objective step when the objective is updated"/>

                      <!--Delivery params-->
                      <param name="WaresTableParam"         value="$DeliverInventoryTable"  comment="Table of ware amounts. Key = ware. Value = [$maxamount, $remainingamount]. Inventory wares only."/>
                      <param name="DeliveryNPC"             value="$BosoTa"                 comment="The NPC to which the items should be delivered." />
                      <param name="DeliveryObject"          value="$HQ"                     comment="The object on which to point to before the NPC is placed. Also used to create the interior with the below parameters" />
                      <param name="ProgressBarText"         value="$ProgressBarText"        comment="Text to be displayed next to the ware delivery progress bar e.g. ('Delivered')"/>
                      <param name="ConversationOptionText"  value="$ConversationOptionText"/>
                      <param name="ConversationTipText"     value="$ConversationTipText"/>
                      <param name="PlaceNPC"                value="false"/>

                      <param name="DebugChance"             value="$DebugChance"/>
                    </cue>

                    <cue name="Uni_3_Deliver_Inventory_Credits">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <set_objective_from_briefing cue="$MissionCue_Uni_3_Deliver_Inventory" step="$DeliverCreditsStep"/>
                      </actions>
                      <cues>

                        <cue name="Uni_3_Deliver_Inventory_Credits_Conversation">
                          <conditions>
                            <event_conversation_started actor="$BosoTa"/>
                          </conditions>
                          <actions>
                            <set_value name="$PlayerHasMoney" exact="if player.money ge ($Cr_Amount)Cr then true else false"/>

                            <add_player_choice section="boso_funded" text="$OfferCredits" selectable="$PlayerHasMoney" tooltip="if $PlayerHasMoney then '' else {30221,3271}"/>
                          </actions>
                        </cue>

                        <cue name="Uni_3_Deliver_Inventory_Credits_Conversation_Complete">
                          <conditions>
                            <event_conversation_next_section actor="$BosoTa" section="boso_funded"/>
                          </conditions>
                          <actions>
                            <transfer_money from="faction.player" to="faction.civilian" amount="($Cr_Amount)Cr"/>
                            <signal_cue cue="Uni_3_Deliver_Inventory_End"/>
                          </actions>
                        </cue>

                      </cues>
                    </cue>

                    <cue name="Uni_3_Deliver_Inventory_End">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <remove_mission cue="$MissionCue_Uni_3_Deliver_Inventory" type="completed"/>
                        <set_value name="$Uni_3_Deliver_Inventory_Completed"/>

                        <!-- Boso Ta stands right before the player, so he can speak without cutscene. -->
                        <speak actor="$BosoTa" priority="100">
                          <text line="if player.entity.isfemale then 30220815 else 30220814" comment="Great work, assistant!"/>
                          <text line="30220816" comment="These are all the supplies I need!"/>
                        </speak>
                      </actions>
                      <cues>
                        <cue name="Uni_3_Deliver_Inventory_End_Boso_Speak_Finished">
                          <conditions>
                            <check_any>
                              <event_speak_finished actor="$BosoTa" line="30220814"/>
                              <event_speak_finished actor="$BosoTa" line="30220815"/>
                            </check_any>
                          </conditions>
                          <actions>
                            <signal_cue cue="Uni_3_Double_Sink_Completion_Check"/>
                          </actions>
                        </cue>
                      </cues>
                    </cue>

                  </cues>
                </cue>

                <cue name="Uni_3_Double_Sink_Completion_Check">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <do_if value="$Uni_3_Deliver_Resources_Completed?">
                      <do_if value="$Uni_3_Deliver_Inventory_Completed?">
                        <signal_cue cue="Uni_3_Double_Sink_Completed"/>
                      </do_if>
                      <do_else>
                        <set_objective_from_briefing cue="$MissionCue" step="3"/>
                        <reset_cue cue="this"/>
                      </do_else>
                    </do_if>
                    <do_else>
                      <set_objective_from_briefing cue="$MissionCue" step="2"/>
                      <reset_cue cue="this"/>
                    </do_else>
                  </actions>
                </cue>

                <cue name="Uni_3_Double_Sink_Completed">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <set_value name="$CurrentStep" exact="4"/>
                    <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.await" text="{30220,8007}" updatebriefing="true" comment="Await: Next Stage of the Plan"/>
                  </actions>
                  <cues>
                    <cue name="Uni_3_Double_Sink_Completed_Check_Player_Location">
                      <actions>
                        <do_if value="player.entity.hascontext.{$HQ} and $DalBusta.hascontext.{$HQ}">
                          <signal_cue cue="Uni_3_Double_Sink_Completed_Dal_Speak_In_Person"/>
                        </do_if>
                        <do_else>
                          <signal_cue cue="Uni_3_Double_Sink_Completed_Dal_Speak_Via_Cutscene"/>
                        </do_else>
                      </actions>
                    </cue>

                    <cue name="Uni_3_Double_Sink_Completed_Dal_Speak_In_Person">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <speak actor="$DalBusta" priority="100">
                          <text line="if player.entity.isfemale then 30220853 else 30220852" comment="Looks like you've done your part."/>
                          <text line="30220854" comment=" We'll take it from here."/>
                        </speak>
                      </actions>
                      <cues>
                        <cue name="Uni_3_Double_Sink_Completed_Dal_Speak_In_Person_Finished">
                          <conditions>
                            <check_any>
                              <event_speak_finished actor="$DalBusta" line="30220852"/>
                              <event_speak_finished actor="$DalBusta" line="30220853"/>
                            </check_any>
                          </conditions>
                          <actions>
                            <signal_cue cue="Uni_3_Double_Sink_Cooldown"/>
                          </actions>
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Uni_3_Double_Sink_Completed_Dal_Speak_Via_Cutscene">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <cues>
                        <cue name="Uni_3_Dal_Speak_852_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$DalBusta"/>
                          <param name="CutsceneKey"       value="$DalCutsceneKey"/>
                          <param name="Lines"             value="[[if player.entity.isfemale then 30220853 else 30220852],[30220854]]"/>
                          <param name="EndSignalCue"      value="Uni_3_Double_Sink_Cooldown"/>
                          <!--
                              Looks like you've done your part.
                              We'll take it from here.
                            -->
                        </cue>
                      </cues>
                    </cue>

                  </cues>
                </cue>

                <cue name="Uni_3_Double_Sink_Cooldown">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <delay exact="10min"/>
                  <actions>
                    <signal_cue cue="Uni_3_Duke_Call"/>
                  </actions>
                </cue>

              </cues>
            </cue>

            <cue name="Uni_3_Duke_Call">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <set_value name="$DukeCallInterval" exact="5min"/>
              </actions>
              <cues>

                <cue name="Uni_3_Duke_Call_Parent">
                  <delay exact="$DukeCallInterval"/>
                  <actions>
                    <debug_text text="'Starting Kromancketslat call in unification sinks stage 3.'" chance="$DebugChance"/>

                    <play_cutscene key="$DukeCutsceneKey.$key" result="this.$CutsceneID" targetmonitor="true">
                      <interaction text="{30220,1004}" param="$Duke" param2="'accept_interaction'"/>
                      <param name="npcref" object="$Duke" />
                    </play_cutscene>
                  </actions>
                  <cues>

                    <cue name="Uni_3_Duke_Call_Speak">
                      <conditions>
                        <event_cutscene_started key="$DukeCutsceneKey.$key"/>
                      </conditions>
                      <actions>
                        <signal_cue cue="Uni_3_Duke_Call_No_Interact"/>
                        <speak actor="$Duke" priority="100">
                          <text line="if (player.entity.race == race.paranid) then 30220430 else if player.entity.isfemale then 30220429 else 30220428" delay="0.6s" comment="Brother! / Outsider!"/>
                        </speak>
                      </actions>
                    </cue>

                    <!--Accept the call-->
                    <cue name="Uni_3_Duke_Call_Interact">
                      <conditions>
                        <event_player_interaction param="$Duke" param2="'accept_interaction'"/>
                      </conditions>
                      <actions>
                        <stop_cutscene cutscene="parent.$CutsceneID"/>
                        <cancel_cue cue="Uni_3_Duke_Call_No_Interact"/>

                        <signal_cue cue="Uni_3_Duke_Call_Conversation"/>
                      </actions>
                    </cue>

                    <!--Fail to accept the call-->
                    <cue name="Uni_3_Duke_Call_No_Interact">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <delay exact="10s" comment="cutscene timeout"/>
                      <actions>
                        <stop_cutscene cutscene="parent.$CutsceneID"/>
                        <reset_cue cue="parent"/>
                      </actions>
                    </cue>

                  </cues>
                </cue>

                <cue name="Uni_3_Duke_Call_Conversation">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <start_conversation actor="$Duke" conversation="duke_uni_3_call" priority="100"/>
                  </actions>
                  <cues>
                    <cue name="Uni_3_Duke_Call_Conversation_Section_Main">
                      <conditions>
                        <event_conversation_started actor="$Duke" conversation="duke_uni_3_call"/>
                      </conditions>
                      <actions>
                        <allow_conversation_escape enabled="false"/>

                        <add_npc_line speaker="$Duke" line="if player.entity.isfemale then 30220811 else 30220810" hidechoices="true" comment="I must commend you on your work, my faithful followers."/>
                        <add_npc_line speaker="$Duke" line="30220812" hidechoices="true" comment="I have meticulously screened all hatched Paranid for their capabilities and chosen the ideal candidate for the grave and momentuous position of Third Pontifex."/>
                        <add_npc_line speaker="$Duke" line="30220813" hidechoices="true" comment="The remaining candidates will form a mighty entourage for this most powerful being."/>
                        <add_npc_line speaker="$Duke" line="30220814" hidechoices="true" comment="The support of these most brilliant High Priests of our own making almost assures the cooperation of the Holy Order."/>
                        <add_npc_line speaker="$Duke" line="30220815" hidechoices="true" comment="However, the Godrealm will most certainly refuse to join our pact until their sacred scriptures clearly state that a Third Pontifex is in accordance with their contrived geometry."/>
                        <add_npc_line speaker="$Duke" line="30220816" hidechoices="true" comment="No matter!" delay="0.5s"/>
                        <add_npc_line speaker="$Duke" line="30220817" hidechoices="true" comment="The vast archives of the Alliance of the Word contain holy writs of each and every age, capable of convincing these dogmatic fools of any genuine or invented truth." delay="0.5s"/>
                        <add_npc_line speaker="$Duke" line="if player.entity.isfemale then 30220819 else 30220818" hidechoices="true" comment="Go now and fetch them for me, follower."/>
                      </actions>
                    </cue>
                    <cue name="Uni_3_Duke_Call_Conversation_Finished">
                      <conditions>
                        <event_conversation_finished actor="$Duke"/>
                      </conditions>
                      <actions>
                        <signal_cue cue="Uni_3_Deliver_Turgid_Tome"/>
                      </actions>
                    </cue>
                  </cues>
                </cue>

              </cues>
            </cue>

            <cue name="Uni_3_Deliver_Turgid_Tome">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <!--Place Librarian on Alliance Station-->
                <find_station name="$LibrarianStation" space="player.galaxy" owner="faction.alliance">
                  <match_content checkoperational="true" walkable="true">
                    <match_dock size="tag.dock_s"/>
                  </match_content>
                  <match_relation_to faction="faction.player" relation="dock" comparison="ge"/>
                </find_station>

                <do_if value="not $LibrarianStation" comment="fallback">
                  <find_station name="$LibrarianStation" space="player.galaxy">
                    <match_content checkoperational="true" walkable="true">
                      <match_dock size="tag.dock_s"/>
                    </match_content>
                    <match_relation_to faction="faction.player" relation="dock" comparison="ge"/>
                  </find_station>
                </do_if>

                <debug_text text="'Librarian station found: ' + $LibrarianStation.knownname" chance="$DebugChance"/>

                <find_object_component name="$LibrarianDock" object="$LibrarianStation" checkoperational="true" class="class.walkablemodule">
                  <match_content walkable="true"/>
                </find_object_component>

                <debug_text text="'Librarian dock found: ' + $LibrarianDock.knownname" chance="$DebugChance"/>

                <create_cue_actor name="$LibrarianActor" cue="$MissionCue">
                  <select race="race.paranid" faction="faction.alliance"/>
                  <page exact="10304"/>
                  <skills>
                    <skill type="management"  exact="12"/>
                    <skill type="morale"      exact="6"/>
                    <skill type="piloting"    exact="0"/>
                    <skill type="engineering" exact="0"/>
                    <skill type="boarding"    exact="0"/>
                  </skills>
                </create_cue_actor>
                <set_entity_traits entity="$LibrarianActor" missionactor="true" customhandler="true"/>
                <set_entity_overrides entity="$LibrarianActor" title="'{30220,123}'" icon="'licencebroker'"/>

                <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $LibrarianActor,
                                                                                                  table[
                                                                                                  $requestercue = namespace,
                                                                                                  $location = $LibrarianDock,
                                                                                                  $slottags = [tag.stand],
                                                                                                  $priority = 100,
                                                                                                  $debugchance = $DeepDebugChance,
                                                                                                  $debugcaller = if $DebugChance == 100 then this else null]
                                                                                                  ]"/>

                <update_mission cue="$MissionCue" description="if player.entity.isfemale then {30220,8236} else {30220,8237}
                                                    + '\n\n' + {30220,8015} + '\n' + {30220,8207} + ' ' + {30220,8208}" comment="Description + Diplo and eco predictions" icon="'briefing_kromancketslat_01'" iconcaption="$Duke.name"/>

                <set_value name="$CurrentStep" operation="add"/>
                <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.collect" object="$LibrarianActor" text="{20201,51401}" updatebriefing="true" comment="Collect: Paranid Religious Tract"/>

                <!-- TODO: Improve library to allow for objective text in addition to action. -->
                <signal_cue_instantly cue="md.GenericMissions.DisconnectedActorObjectiveLibrary" param="table[
                                              $actor = $LibrarianActor,
                                              $object = $LibrarianStation,
                                              $missioncue = $MissionCue,
                                              $step = $CurrentStep,
                                              $cancelcue = Uni_3_Deliver_Turgid_Tome_Dal_Speak,
                                              $libfailedcue = Uni_3_Deliver_Turgid_Tome_Failsafe,
                                              $objective = objective.talkto,
                                              $debugchance = $DebugChance]"/>
              </actions>
              <cues>

                <cue name="Uni_3_Deliver_Turgid_Tome_Failsafe">
                  <conditions>
                    <check_any>
                      <event_object_destroyed object="$LibrarianActor"/>
                      <event_cue_signalled/>
                    </check_any>
                  </conditions>
                  <actions>
                    <signal_cue cue="Uni_3_Diplomatic_Change"/>
                  </actions>
                </cue>

                <cue name="Uni_3_Deliver_Turgid_Tome_Conversation" instantiate="true">
                  <conditions>
                    <event_conversation_started actor="$LibrarianActor"/>
                  </conditions>
                  <actions>
                    <allow_conversation_escape enabled="false"/>
                    <do_any>
                      <add_npc_line speaker="$LibrarianActor" line="2001" hidechoices="true" comment="(Greeting - neutral)Greetings."/>
                      <add_npc_line speaker="$LibrarianActor" line="2002" hidechoices="true" comment="(Greeting - neutral)Hello."/>
                      <add_npc_line speaker="$LibrarianActor" line="2006" hidechoices="true" comment="(Greeting - trader / staff)Can I help?"/>
                    </do_any>
                    <add_player_choice position="top_right" text="{30220,8210}" section="uni_3_librarian_continue" highlighted="true" comment="I've made a reservation."/>
                    <add_player_choice position="bottom_right" text="{30220,8211}" section="g_cancel" comment="Nevermind."/>
                  </actions>
                </cue>

                <cue name="Uni_3_Deliver_Turgid_Tome_Conversation_Continue">
                  <conditions>
                    <event_conversation_next_section actor="$LibrarianActor" section="uni_3_librarian_continue"/>
                  </conditions>
                  <actions>
                    <cancel_cue cue="Uni_3_Deliver_Turgid_Tome_Conversation"/>

                    <allow_conversation_escape enabled="false"/>
                    <add_npc_line speaker="$LibrarianActor" line="if player.entity.isfemale then 30220802 else 30220801" hidechoices="true" comment="You are hereby issued a standard copy of the Sacred Axioms of Paranid Bashra, First Disciple of the Holy Three-Dimensionality, minus the appendices."/>
                    <add_npc_line speaker="$LibrarianActor" line="if player.entity.isfemale then 30220804 else 30220803" hidechoices="true" comment="May you find enlightenment in your studies and hospitality on your travels." delay="0.5s"/>

                    <add_inventory entity="player.entity" ware="ware.inv_paranid_religious_tract" exact="1"/>

                    <set_value name="$CurrentStep" operation="add"/>
                    <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.deliver" object="$TrinityPalace" text="{20201,51401}" updatebriefing="true" comment="Deliver: Paranid Religious Tract"/>
                  </actions>
                  <cues>
                    <cue name="Uni_3_Deliver_Turgid_Tome_Conversation_Finished">
                      <conditions>
                        <event_conversation_finished actor="$LibrarianActor"/>
                      </conditions>
                      <delay exact="2s"/>
                      <actions>
                        <signal_cue cue="Uni_3_Deliver_Turgid_Tome_Dal_Speak"/>
                      </actions>
                      <delay exact="2s"/>
                      <actions>
                        <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $LibrarianActor, table[
                                                                                                                                  $requestercue = $MissionCue,
                                                                                                                                  $priority = 100,
                                                                                                                                  $location = 'disconnect',
                                                                                                                                  $slottags = [tag.stand],
                                                                                                                                  $debugchance = $DeepDebugChance,
                                                                                                                                  $debugcaller = if $DebugChance == 100 then this else null]
                                                                                                                                  ]"/>
                      </actions>
                    </cue>
                  </cues>
                </cue>

                <cue name="Uni_3_Deliver_Turgid_Tome_Dal_Speak">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <cues>
                    <cue name="Uni_3_Dal_Speak_857_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$DalBusta"/>
                      <param name="CutsceneKey"       value="$DalCutsceneKey"/>
                      <param name="Lines"             value="[[30220857],[30220858]]"/>
                      <param name="EndSignalCue"      value="Uni_3_Deliver_Turgid_Tome_Palace_Approach"/>
                      <!--
                              Did he just smirk?
                              Can Paranid do that?
                            -->
                    </cue>
                  </cues>
                </cue>

                <cue name="Uni_3_Deliver_Turgid_Tome_Palace_Approach">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <cues>
                    <cue name="Uni_3_Deliver_Turgid_Tome_Palace_Approach_Ref" ref="md.LIB_Generic.ApproachObject_Handler">
                      <param name="ApproachObject"    value="player.entity"/>
                      <param name="ApproachTarget"    value="$TrinityPalace"/>
                      <param name="ApproachDistance"  value="10km"/>
                      <param name="SuccessSignalCue"  value="Uni_3_Deliver_Turgid_Tome_Duke_Speak"/>
                    </cue>
                  </cues>
                </cue>

                <cue name="Uni_3_Deliver_Turgid_Tome_Duke_Speak">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <set_value name="$CurrentStep" operation="add"/>
                    <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.observe" text="{30220,8223}" updatebriefing="true" comment="Observe: The Holy Mending"/>
                  </actions>
                  <cues>
                    <cue name="Uni_3_Duke_Speak_820_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$Duke"/>
                      <param name="CutsceneKey"       value="$DukeCutsceneKey"/>
                      <param name="Lines"             value="[[if (player.entity.race == race.paranid) then 30220821 else 30220820], [if player.entity.isfemale then 30220823 else 30220822],[30220824],[if player.entity.isfemale then 30220826 else 30220825]]"/>
                      <param name="EndSignalCue"      value="Uni_3_Diplomatic_Change"/>
                      <!--
                            My sincerest thanks, unholy creature. / My sincerest thanks, brother.
                            Your wretched plan to manipulate my people has ultimately served me well.
                            The Paranid will thrive and prosper as they once did.
                            Do what you want with that turgid tome. I have no use for it.
                      -->
                    </cue>
                  </cues>
                </cue>

              </cues>
            </cue>

            <cue name="Uni_3_Diplomatic_Change">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <signal_cue cue="Unification_Stage_3_FactionMerge"/>
              </actions>
              <delay exact="3s"/>
              <actions>
                <open_menu menu="MapMenu" param="[0, 0, false, null, null, 'infomode', [ 'info', event.param2 ]]" />
              </actions>
              <delay exact="30s"/>
              <actions>
                <signal_cue cue="Uni_3_Wrap_Up"/>
              </actions>
            </cue>

            <cue name="Uni_3_Wrap_Up">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <cues>

                <cue name="Uni_3_Dal_Speak_859_Ref" ref="md.LIB_Dialog.Speak_Actor">
                  <param name="Actor"             value="$DalBusta"/>
                  <param name="CutsceneKey"       value="$DalCutsceneKey"/>
                  <param name="Lines"             value="[[30220859],[if player.entity.isfemale then 30220861 else 30220860]]"/>
                  <param name="EndSignalCue"      value="Uni_3_Wrap_Up_Headquarters"/>
                  <!--
                             Wait, what did he mean?
                             Get back to headquarters, pronto.
                            -->
                </cue>

                <cue name="Uni_3_Wrap_Up_Headquarters">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <set_value name="$CurrentStep" operation="add"/>
                    <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.talkto" object="$DalBusta" updatebriefing="true" comment="Talk to: Dal Busta"/>
                  </actions>
                  <cues>

                    <cue name="Uni_3_Wrap_Up_Headquarters_Boso_Speak">
                      <conditions>
                        <event_object_changed_room object="player.entity" room="$BosoTa.room"/>
                      </conditions>
                      <actions>
                        <speak actor="$BosoTa" priority="100">
                          <text line="30220817" comment="What an intriguing turn of events!"/>
                          <text line="30220818" comment="(addressing NPC)Your plan was a success, Dal. And this quickly, too!"/>
                          <text line="30220819" comment="(addressing NPC)You must be overjoyed!"/>
                        </speak>
                      </actions>
                    </cue>

                    <cue name="Uni_3_Wrap_Up_Headquarters_Dal_Speak">
                      <conditions>
                        <event_speak_finished actor="$BosoTa" line="30220817"/>
                      </conditions>
                      <actions>
                        <speak actor="$DalBusta" priority="100" >
                          <text line="30220862" comment="(addressing NPC)Are you kidding me?! I'm furious!"/>
                        </speak>
                      </actions>
                    </cue>

                    <cue name="Uni_3_Wrap_Up_Headquarters_Dal_Speak_Finished">
                      <conditions>
                        <event_speak_finished actor="$DalBusta" line="30220862"/>
                      </conditions>
                      <cues>

                        <cue name="Uni_3_Wrap_Up_Headquarters_Dal_Conversation_Header" instantiate="true">
                          <conditions>
                            <event_conversation_started actor="$DalBusta"/>
                            <check_value value="$HQ? and $DalBusta.hascontext.{$HQ} and player.entity.hascontext.{$HQ}"/>
                          </conditions>
                          <actions>
                            <add_player_choice text="{30220,205}" section="uni_3_wrap_up_dal_main" comment="Paranid Civil War"/>
                          </actions>
                        </cue>

                        <cue name="Uni_3_Wrap_Up_Headquarters_Dal_Conversation">
                          <conditions>
                            <event_conversation_next_section actor="$DalBusta" section="uni_3_wrap_up_dal_main"/>
                          </conditions>
                          <actions>
                            <cancel_cue cue="Uni_3_Wrap_Up_Headquarters_Dal_Conversation_Header"/>

                            <allow_conversation_escape enabled="false"/>

                            <add_npc_line speaker="$DalBusta" line="30220863" hidechoices="true" comment="That scheming waste of carbon has blocked all incoming communication!"/>
                            <add_npc_line speaker="$DalBusta" line="30220864" hidechoices="true" comment="I can't get through to him!"/>
                            <add_npc_line speaker="$DalBusta" line="30220865" hidechoices="true" comment="Gah!"/>
                            <add_npc_line speaker="$DalBusta" line="if player.entity.isfemale then 30220867 else 30220866" hidechoices="true" comment="(sarcastic)Well, go and enjoy your unified Paranid Empire."/>
                            <add_npc_line speaker="$DalBusta" line="30220868" hidechoices="true" comment="I'll stay here and try to wrap my head around what in Hatikvah's name just happened."/>
                          </actions>
                          <cues>

                            <cue name="Uni_3_Wrap_Up_Headquarters_Dal_Conversation_Finished">
                              <conditions>
                                <event_conversation_finished actor="$DalBusta"/>
                              </conditions>
                              <actions>
                                <remove_mission cue="$MissionCue" type="completed"/>
                                <write_to_logbook category="missions" faction="faction.player" title="{30220,8201}" text="if player.entity.isfemale then {30220,8239} else {30220,8238}"/>
                                <unlock_achievement name="PLOT_PARANID_SINK1"/>
                                <signal_cue cue="Uni_3_Wrap_Up_Cooldown"/>
                              </actions>
                            </cue>

                          </cues>
                        </cue>

                      </cues>
                    </cue>

                  </cues>
                </cue>

                <cue name="Uni_3_Wrap_Up_Cooldown">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <delay exact="30min"/>
                  <actions>
                    <signal_cue cue="Uni_3_Extra_Dialog"/>
                  </actions>
                </cue>

              </cues>
            </cue>

            <cue name="Uni_3_Extra_Dialog">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <cues>

                <cue name="Uni_3_Extra_Dialog_Dal_Conversation_Header" instantiate="true">
                  <conditions>
                    <event_conversation_started actor="$DalBusta"/>
                    <check_value value="$HQ? and $DalBusta.hascontext.{$HQ} and player.entity.hascontext.{$HQ}"/>
                  </conditions>
                  <actions>
                    <add_player_choice text="{30220,8212}" section="uni_3_extra_dal_main" comment="Any news about the Paranid?"/>
                  </actions>
                </cue>

                <cue name="Uni_3_Extra_Dialog_Dal_Conversation">
                  <conditions>
                    <event_conversation_next_section actor="$DalBusta" section="uni_3_extra_dal_main"/>
                  </conditions>
                  <actions>
                    <cancel_cue cue="Uni_3_Extra_Dialog_Dal_Conversation_Header"/>

                    <allow_conversation_escape enabled="false"/>

                    <add_npc_line speaker="$DalBusta" line="if player.entity.isfemale then 30220870 else 30220869" hidechoices="true" comment="(headache)Oh, don't get me started."/>
                    <add_npc_line speaker="$DalBusta" line="30220871" hidechoices="true" comment="(sighing)Yes, I think I figured out what went wrong back there."/>
                    <add_npc_line speaker="$DalBusta" line="if player.entity.isfemale then 30220873 else 30220872" hidechoices="true" comment="You sure you want a lecture?"/>

                    <add_player_choice text="{30220,8213}" position="top_right" highlighted="true" section="uni_3_extra_dal_continue" choiceparam="'yes'" comment="Hit me."/>
                    <add_player_choice text="{30220,8214}" position="bottom_right" section="uni_3_extra_dal_continue" choiceparam="'no'" comment="Absolutely not."/>
                  </actions>
                </cue>

                <cue name="Uni_3_Extra_Dialog_Dal_Conversation_Continue">
                  <conditions>
                    <event_conversation_next_section actor="$DalBusta" section="uni_3_extra_dal_continue"/>
                  </conditions>
                  <actions>
                    <allow_conversation_escape enabled="false"/>

                    <do_if value="event.param2 == 'yes'">
                      <add_npc_line speaker="$DalBusta" line="if player.entity.isfemale then 30220875 else 30220874" hidechoices="true" comment="Remember those Paranid cocoons we had Boso Ta hatch so that Kromancketslat could find a candidate for Third Pontifex?"/>
                      <add_npc_line speaker="$DalBusta" line="30220876" hidechoices="true" comment="Well, there was no such candidate."/>
                      <add_npc_line speaker="$DalBusta" line="30220877" hidechoices="true" comment="There could never have been."/>
                      <add_npc_line speaker="$DalBusta" line="30220878" hidechoices="true" comment="A supreme leader is only hatched at the precise moment the high priests intend him to be."/>
                      <add_npc_line speaker="$DalBusta" line="30220879" hidechoices="true" comment="According to the age-old doctrine, you have to be born, created, destined from the very beginning to be Pontifex."/>
                      <add_npc_line speaker="$DalBusta" line="30220880" hidechoices="true" comment="Which, I might add, Kromancketslat kept telling us this whole time!"/>
                      <add_npc_line speaker="$DalBusta" line="30220881" hidechoices="true" comment="That whole essay about not being allowed to realise your potential, to achieve your true purpose?"/>
                      <add_npc_line speaker="$DalBusta" line="30220882" hidechoices="true" comment="The only way to defeat this tradition, I reckon, is by sheer, overwhelming force of support among those very high priests."/>
                      <add_npc_line speaker="$DalBusta" line="30220883" hidechoices="true" comment="He probably indoctrinated all of the candidates we provided to vouch for him once he laid claim to the throne."/>
                    </do_if>
                    <add_npc_line speaker="$DalBusta" line="30220884" hidechoices="true" comment="(exhausted, surrendered)All hail the Third Pontifex." delay="1s"/>
                  </actions>
                  <cues>

                    <cue name="Uni_3_Extra_Dialog_Dal_Conversation_Finished">
                      <conditions>
                        <event_conversation_finished actor="$DalBusta"/>
                      </conditions>
                      <actions>
                        <debug_text text="'Paranid Story Unification Sinks Chain completed.'" chance="$DebugChance"/>
                      </actions>
                    </cue>

                  </cues>
                </cue>

              </cues>
            </cue>

          </cues>
        </cue>

        <!-- Sinks: Escalation -->
        <cue name="Sinks_Escalation_Stage_1">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <create_mission cue="$MissionCue" name="{30220,9001}" description="if player.entity.isfemale then {30220,9003} else {30220,9002}" rewardtext="{30220,9004}" type="missiontype.plot" faction="faction.player" difficulty="level.hard" abortable="false" icon="'briefing_dal_busta_01'" iconcaption="$DalBusta.name">
              <briefing>
                <objective step="1" action="objective.talkto" object="$DalBusta" text="{30220,1003}" comment="Talk to: Your trusted friend, Dal Busta"/>
              </briefing>
            </create_mission>
            <set_value name="$CurrentStep" exact="1"/>
            <!-- Kromancketslat becomes the Pirate Duke and joins the Buccaneers faction. -->
            <set_owner object="$Duke" faction="faction.buccaneers"/>
            <set_entity_overrides entity="$Duke" title="'{30220,113}'"/>
          </actions>
          <cues>

            <cue name="Esc_1_Dal_Desk" checktime="player.age + 5min" checkinterval="60s">
              <conditions>
                <check_value value="not player.entity.hascontext.{$HQ}"/>
              </conditions>
              <actions>
                <signal_cue cue="Setup_Dal_Desk_Busy"/>
              </actions>
            </cue>

            <cue name="Esc_1_Return_To_HQ">
              <actions>
                <set_objective_from_briefing cue="$MissionCue" step="1"/>
              </actions>
              <cues>

                <cue name="Esc_1_Return_To_HQ_Boso_Ta_Greeting">
                  <conditions>
                    <event_object_changed_room object="player.entity" room="$BosoTa.room"/>
                  </conditions>
                  <actions>
                    <speak actor="$BosoTa" priority="100">
                      <text line="if player.entity.isfemale then 30220821 else 30220820" comment="I am overjoyed to have you back in one piece, assistant."/>
                    </speak>
                  </actions>
                </cue>

                <cue name="Esc_1_Return_To_HQ_Dal_Busta_Conversation_Header" instantiate="true">
                  <conditions>
                    <event_conversation_started actor="$DalBusta"/>
                    <check_value value="$HQ? and $DalBusta.hascontext.{$HQ} and player.entity.hascontext.{$HQ}"/>
                  </conditions>
                  <actions>
                    <add_player_choice text="{30220,205}" section="section_esc_1_main" comment="(Dal Busta HQ Conversation Paranid Story Menu)Paranid Civil War"/>
                  </actions>
                </cue>

                <cue name="Esc_1_Return_To_HQ_Dal_Busta_Conversation_Main">
                  <conditions>
                    <event_conversation_next_section actor="$DalBusta" section="section_esc_1_main"/>
                  </conditions>
                  <actions>
                    <cancel_cue cue="Esc_1_Return_To_HQ_Dal_Busta_Conversation_Header"/>
                    <allow_conversation_escape enabled="false"/>
                    <add_npc_line speaker="$DalBusta" line="if player.entity.isfemale then 30220802 else 30220801" hidechoices="true" comment="It's a shame about all those lives lost, but you still did the right thing back there."/>
                    <add_npc_line speaker="$DalBusta" line="30220901"                                              hidechoices="true" comment="A unified Paranid Empire would have been a real menace on the galactic stage but, thanks to our intervention, such a bleak prospect will hopefully not become a reality in our lifetimes."/>
                    <add_npc_line speaker="$DalBusta" line="30220902"                                              hidechoices="true" comment="Now, with the negotiations having failed spectacularly, the symbol of Paranid tradition having been destroyed, and the cocoons of their future leaders... (slight pause before 'vaporised')'vaporised', conspiracy theories are running rampant."/>
                    <add_npc_line speaker="$DalBusta" line="30220903"                                              hidechoices="true" comment="Kromancketslat is already busy rallying his followers to stoke the chaos."/>
                    <add_npc_line speaker="$DalBusta" line="30220904"                                              hidechoices="true" comment="His new faction will require a sizeable fleet to be taken seriously though."/>
                  </actions>
                  <cues>

                    <cue name="Esc_1_Return_To_HQ_Dal_Busta_Conversation_Finished">
                      <conditions>
                        <event_conversation_finished actor="$DalBusta"/>
                      </conditions>
                      <actions>
                        <signal_cue cue="Esc_1_Deliver_Fleet"/>
                      </actions>
                      <delay exact="2s"/>
                      <actions>
                        <speak actor="$DalBusta" priority="100">
                          <text line="30220806" comment="That's where we come in."/>
                        </speak>
                      </actions>
                    </cue>

                  </cues>
                </cue>

              </cues>
            </cue>

            <cue name="Esc_1_Deliver_Fleet">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <cues>

                <cue name="Esc_1_Deliver_Fleet_Setup">
                  <actions>
                    <!-- This costs about 200-250 Mio -->
                    <set_value name="$Fleet" exact="[
                          table[
                            $macro = macro.ship_par_l_destroyer_01_b_macro,
                            $amount = 8,
                            $equipment = [macro.engine_par_l_allround_01_mk1_macro,
                                          macro.shield_par_l_standard_01_mk2_macro,
                                          macro.shield_par_m_standard_02_mk2_macro,
                                          macro.thruster_gen_l_allround_01_mk3_macro,
                                          macro.turret_par_m_gatling_02_mk1_macro,
                                          macro.turret_par_l_plasma_01_mk1_macro,
                                          macro.weapon_par_l_destroyer_01_mk1_macro],
                          ],
                          table[
                            $macro = macro.ship_par_m_frigate_01_a_macro,
                            $amount = 12,
                            $equipment = [macro.engine_par_m_combat_01_mk3_macro,
                                          macro.shield_par_m_standard_01_mk2_macro,
                                          macro.thruster_gen_m_combat_01_mk3_macro,
                                          macro.turret_par_m_gatling_01_mk1_macro,
                                          macro.weapon_gen_m_plasma_01_mk2_macro],
                          ],
                          table[
                            $macro = macro.ship_par_m_corvette_01_b_macro,
                            $amount = 16,
                            $equipment = [macro.engine_par_m_combat_01_mk3_macro,
                                          macro.shield_par_m_standard_01_mk2_macro,
                                          macro.thruster_gen_m_combat_01_mk3_macro,
                                          macro.turret_par_m_gatling_01_mk1_macro,
                                          macro.weapon_gen_m_gatling_01_mk2_macro],
                          ]
                         ]"/>

                    <!-- Set $TextTable variables for GM briefing generation. -->
                    <set_value name="$TextTable" exact="table[]"/>

                    <set_value name="$TextTable.$objective"           exact="{30220,9020}"/>
                    <set_value name="$TextTable.$objective_transfer"  exact="{30220,9020}"/>
                    <set_value name="$TextTable.$progressbar"         exact="{30220,8018}"/>
                    <set_value name="$TextTable.$accept_transfer"     exact="{30220,8019}"/>
                    <set_value name="$TextTable.$reject_transfer"     exact="{30220,8020}"/>

                    <run_actions ref="md.GM_GetExactFleet.ConstructFleetRequirementsText" result="$FleetText">
                      <param name="Fleet" value="$Fleet"/>
                    </run_actions>

                    <!-- Determine a delivery location south of the player HQ. Mind that the HQ plot can extend up to 20km from the HQ centre, so the delivery location should be farther away. -->
                    <set_value name="$TargetSector" exact="$HQ.sector"/>
                    <create_position name="$HQ_Position" space="$HQ.sector" object="$HQ"/>
                    <create_position name="$TargetOffset" space="$HQ.sector" x="$HQ_Position.x" y="$HQ_Position.y" z="$HQ_Position.z - 60km"/>
                    <set_value name="$TargetRadius" exact="50km" comment="100km diameter should be enough to avoid stations that might be in the way."/>

                    <update_mission cue="$MissionCue" description="(if player.entity.isfemale then {30220,9006} else {30220,9005})
                                                        + '\n\n' + {30220,8016} + '\n' + $FleetText
                                                        + '\n\n' + {30220,8015} + '\n' + {30220,9007} + ' ' + {30220,9008}" comment="Description + Fleet Info + Diplo and Eco Prediction" icon="'briefing_kromancketslat_01'" iconcaption="$Duke.name"/>

                    <set_value name="$CurrentStep" exact="1" operation="add"/>
                    <signal_cue cue="Esc_1_Deliver_Fleet_Mission"/>
                  </actions>
                </cue>

                <cue name="Esc_1_Deliver_Fleet_Mission">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <cues>

                    <cue name="Esc_1_Deliver_Fleet_Ref" ref="md.RML_Deliver_Fleet.DeliverFleet">
                      <param name="EndSignalCue"            value="Esc_1_Deliver_Fleet_Mission_Check"/>
                      <param name="MissionCue"              value="$MissionCue"/>
                      <param name="StartStep"               value="$CurrentStep"                    comment="Briefing step to start the mission on"/>
                      <param name="UpdateBriefing"          value="true"                            comment="Update the briefing objective step when the objective is updated"/>
                      <param name="DebugChance"             value="$DebugChance"/>

                      <param name="Text_Objective_Get"      value="$TextTable.$objective"           comment="Objective text to get ships"/>
                      <param name="Text_Objective_Transfer" value="$TextTable.$objective_transfer"  comment="Objective text to transfer ownership"/>
                      <param name="Text_AcceptTransfer"     value="$TextTable.$accept_transfer"     comment="Player choice text to initiate transfer"/>
                      <param name="Text_RejectTransfer"     value="$TextTable.$reject_transfer"     comment="Player choice text to reject transfer"/>
                      <param name="Text_ProgressBar"        value="$TextTable.$progressbar"         comment="Progress bar text for multiple ships"/>
                      <param name="Fleet"                   value="$Fleet"                          comment="The specific fleet we are looking for"/>
                      <param name="Transfer"                value="true"                            comment="Mission ends with a transfer of ownership to $Faction. Otherwise ends when ships are in position."/>
                      <param name="Faction"                 value="faction.buccaneers"              comment="The faction to which it needs to be delivered. Required if $Transfer is true"/>
                      <param name="Client"                  value="$Duke"                           comment="client who wants the fleet. Required if $Transfer is true"/>
                      <param name="TargetSector"            value="$TargetSector"                   comment="Sector to which to deliver the fleet"/>
                      <param name="TargetOffset"            value="$TargetOffset"                   comment="Location to which to deliver the fleet"/>
                      <param name="TargetRadius"            value="$TargetRadius"                   comment="Radius around location in which we need to put the fleet"/>
                      <param name="CriteriaResultCue"       value="null"                            comment="Cue to signal with a table of ships with the result of the most recent processing of 'CheckMissionStatus'"/>
                      <param name="AdditionCheckCue"        value="null"                            comment="Cue to signal instantly to run additional checks on the object. event.param = [namespace, $ship]. Result saved to namespace.$CheckCueResult"/>
                      <param name="ReturnFleetShips"        value="true"                            comment="If true, sets $EndSignalCue.$FleetShips, which in the Success Case is the Fleet which changed ownership on transfer"/>
                    </cue>

                    <cue name="Esc_1_Deliver_Fleet_Mission_Check">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <do_if value="this.$EndFeedbackValue == 1">
                          <!-- Remember delivered fleet for later, so we can give them orders to patrol, etc. between the hop/paranid capitals -->
                          <add_to_group groupname="$InsurgenceFleet" list="this.$FleetShips"/>
                          <debug_text text="'Fleet delivered. $InsurgenceFleet now contains: ' + $InsurgenceFleet.count + ' ships.'" chance="$DebugChance"/>
                          <signal_cue cue="Esc_1_Deliver_Fleet_Mission_Completed"/>
                        </do_if>
                        <do_else>
                          <debug_text text="'Fleet transfer declined. Resetting mission.'" chance="$DebugChance"/>
                          <reset_cue cue="Esc_1_Deliver_Fleet_Mission_Check"/>
                          <reset_cue cue="Esc_1_Deliver_Fleet_Ref"/>
                        </do_else>
                      </actions>
                    </cue>

                  </cues>
                </cue>

                <cue name="Esc_1_Deliver_Fleet_Mission_Completed">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <set_value name="$CurrentStep" operation="add"/>
                    <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.await" text="{30220,3014}" updatebriefing="true" silent="true" comment="Await: Further Instructions"/>

                    <!-- Set biggest ship as commander. -->
                    <do_for_each in="$InsurgenceFleet" name="$CurrentShip">
                      <do_if value="[shiptype.destroyer].indexof.{$CurrentShip.type}">
                        <set_value name="$InsurgenceCommander" exact="$CurrentShip"/>
                        <break/>
                      </do_if>
                    </do_for_each>

                    <do_if value="not $InsurgenceCommander?">
                      <set_value name="$InsurgenceCommander" exact="$InsurgenceFleet.{1}"/>
                    </do_if>

                    <!-- Set other ships as subordinates. -->
                    <do_for_each in="$InsurgenceFleet" name="$CurrentShip">
                      <do_if value="$CurrentShip != $InsurgenceCommander">
                        <create_order id="'AssignCommander'" object="$CurrentShip" immediate="true">
                          <param name="commander" value="$InsurgenceCommander"/>
                          <param name="assignment" value="assignment.defence"/>
                          <param name="cancelorders" value="true"/>
                        </create_order>
                      </do_if>
                    </do_for_each>

                    <signal_cue cue="Esc_1_Deliver_Fleet_Completion_Dialog"/>
                  </actions>
                </cue>

                <cue name="Esc_1_Deliver_Fleet_Completion_Dialog">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <cues>
                    <cue name="Esc_1_Speak_Dal_985_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$DalBusta"/>
                      <param name="CutsceneKey"       value="$DalCutsceneKey"/>
                      <param name="Lines"             value="[[30220985],[30220905, 0.5s],[if player.entity.isfemale then 30220907 else 30220906, 0.5s]]"/>
                      <param name="EndSignalCue"      value="Esc_1_Disperse_Pirates"/>
                      <!--
                          That should do it!
                          Kromancketslat has already scouted a suitable sector to claim as staging post for his insurgence.
                          You are to look for... (slight pause before 'unaffiliated')unaffiliated individuals in that area, and either bring them into the fold or convince them to leave.
                            -->
                    </cue>
                  </cues>
                </cue>

              </cues>
            </cue>

            <cue name="Esc_1_Disperse_Pirates">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>

              </actions>
              <cues>

                <cue name="Esc_1_Disperse_Pirates_Setup">
                  <actions>
                    <create_group groupname="$PirateShips" comment="Whenever a ship of this group goes below a certain hull percentage, it has a chance to join the Buccaneers."/>
                    <create_group groupname="$DamagedShips" comment="Used to collect the ships that have already been damaged below a certain hull percentage."/>

                    <find_sector name="$ScaleSector" macro="macro.Cluster_04_Sector001_macro" comment="Nopileos' Fortune II"/>
                    <find_sector name="$PlateSector" macro="macro.Cluster_04_Sector001_macro" comment="Nopileos' Fortune II"/>
                    <find_sector name="$GoldenSector" macro="macro.Cluster_04_Sector002_macro" comment="Nopileos' Fortune VI"/>

                    <!-- paintmod_0110 is yellow, paintmod_0111 blue-gold -->
                    <set_value name="$GoldenPaint" exact="ware.paintmod_0111"/>

                    <!-- Setup for the Scale Plate fleet 1 -->
                    <create_position name="$ScaleSpawnPosition" space="$ScaleSector" x="-80km" z="70km"/>

                    <create_ship name="$ScaleFlagship" macro="ship_tel_l_destroyer_01_b_macro" commandeerable="false" capturable="true" mission="true" sector="$ScaleSector">
                      <owner exact="faction.scaleplate" overridenpc="true"/>
                      <pilot>
                        <select faction="faction.scaleplate" tags="tag.elitepilot"/>
                      </pilot>
                      <loadout>
                        <level exact="1.0"/>
                      </loadout>
                      <people ref="scaleplate_elite_pirate_crew"/>
                      <safepos value="$ScaleSpawnPosition"/>
                    </create_ship>
                    <create_order id="'Patrol'" object="$ScaleFlagship" default="true">
                      <param name="space" value="$ScaleSector"/>
                    </create_order>

                    <set_object_name object="$ScaleFlagship" page="30220" line="193" comment="The Invisible Hand"/>

                    <add_to_group groupname="$ScaleFleet" object="$ScaleFlagship"/>
                    <add_to_group groupname="$PirateFlagships" object="$ScaleFlagship"/>
                    <add_to_group groupname="$PirateShips" object="$ScaleFlagship"/>

                    <!-- Supporting fleet:
                          Destroyers:
                            <t id="185">Economies Of Scale</t>
                            <t id="191">Mission: Acquisition</t>
                            <t id="421">Investment Angel</t>
                          Gunships:
                            <t id="179">Profit Motive</t>
                            <t id="183">Break Others To Break Even</t>
                            <t id="184">It's Not A Pyramid Scheme</t>
                            <t id="186">The True Cost Of Opportunity</t>
                            <t id="187">Oh The Indemnity</t>
                            <t id="188">One Person's Trash</t>
                            <t id="190">Damaged Collateral</t>
                            <t id="196">In The Interest Of Interest</t>
                            <t id="197">Loan Lizard</t>
                            <t id="401">What A Savings</t>
                          -->
                    <set_value name="$ScaleFleetComposition"   exact="[
                          [ macro.ship_tel_l_destroyer_01_b_macro, 30220, 185 ],
                          [ macro.ship_tel_l_destroyer_01_b_macro, 30220, 191 ],
                          [ macro.ship_tel_l_destroyer_01_b_macro, 30220, 421 ],
                          [ macro.ship_tel_m_bomber_01_b_macro, 30220, 179 ],
                          [ macro.ship_tel_m_bomber_01_b_macro, 30220, 183 ],
                          [ macro.ship_tel_m_bomber_01_b_macro, 30220, 184 ],
                          [ macro.ship_tel_m_bomber_01_b_macro, 30220, 186 ],
                          [ macro.ship_tel_m_bomber_01_b_macro, 30220, 187 ],
                          [ macro.ship_tel_m_bomber_01_b_macro, 30220, 188 ],
                          [ macro.ship_tel_m_bomber_01_b_macro, 30220, 190 ],
                          [ macro.ship_tel_m_bomber_01_b_macro, 30220, 196 ],
                          [ macro.ship_tel_m_bomber_01_b_macro, 30220, 197 ],
                          [ macro.ship_tel_m_bomber_01_b_macro, 30220, 401 ],
                          ]" />

                    <do_all exact="$ScaleFleetComposition.count" counter="$f">
                      <!-- Capturable="true" is intended. -->
                      <create_ship name="$CurrentShip" macro="$ScaleFleetComposition.{$f}.{1}" commandeerable="false" capturable="true" mission="true" sector="$ScaleSector">
                        <owner exact="faction.scaleplate" overridenpc="true" />
                        <pilot>
                          <select faction="faction.scaleplate" tags="tag.elitepilot"/>
                        </pilot>
                        <loadout>
                          <level exact="1.0"/>
                        </loadout>
                        <people ref="scaleplate_elite_pirate_crew"/>
                        <safepos object="$ScaleFlagship" space="$ScaleSector" min="2km" max="10km"/>
                      </create_ship>

                      <do_if value="$ScaleFleetComposition.{$f}.{2}">
                        <set_object_name object="$CurrentShip" page="$ScaleFleetComposition.{$f}.{2}" line="$ScaleFleetComposition.{$f}.{3}"/>
                      </do_if>

                      <add_to_group groupname="$ScaleFleet" object="$CurrentShip"/>
                      <add_to_group groupname="$PirateShips" object="$CurrentShip"/>

                      <create_order id="'AssignCommander'" object="$CurrentShip" immediate="true">
                        <param name="commander" value="$ScaleFlagship"/>
                        <param name="assignment" value="assignment.defence"/>
                        <param name="cancelorders" value="true"/>
                      </create_order>
                    </do_all>

                    <!-- Setup for the Scale Plate fleet 2 -->
                    <create_position name="$PlateSpawnPosition" space="$PlateSector" x="600km" z="600km"/>

                    <create_ship name="$PlateFlagship" macro="ship_tel_l_destroyer_01_a_macro" commandeerable="false" capturable="true" mission="true" sector="$PlateSector">
                      <owner exact="faction.scaleplate" overridenpc="true"/>
                      <pilot>
                        <select faction="faction.scaleplate" tags="tag.elitepilot"/>
                      </pilot>
                      <loadout>
                        <level exact="1.0"/>
                      </loadout>
                      <people ref="scaleplate_elite_pirate_crew"/>
                      <safepos value="$PlateSpawnPosition"/>
                    </create_ship>
                    <create_order id="'Patrol'" object="$PlateFlagship" default="true">
                      <param name="space" value="$PlateSector"/>
                    </create_order>

                    <set_object_name object="$PlateFlagship" page="30220" line="199" comment="Hostile Takeover"/>

                    <add_to_group groupname="$PlateFleet" object="$PlateFlagship"/>
                    <add_to_group groupname="$PirateFlagships" object="$PlateFlagship"/>
                    <add_to_group groupname="$PirateShips" object="$PlateFlagship"/>

                    <!-- Supporting fleet:
                          Destroyers:
                            <t id="173">No, Gantelios Hurilis Holigis II, I expect you to die(pirate ship name, maximum length with exactly this capitalisation, translate freely into something equally long or shorter)</t>
                            <t id="180">Capital Punishment</t>
                            <t id="424">Supply And Demand Your Surrender</t>
                          Gunships:
                            <t id="182">Unladen Swallow</t>
                            <t id="192">Devil Investor</t>
                            <t id="194">Fiscal Rascal</t>
                            <t id="195">Time For Some Game Theory</t>
                            <t id="198">Prepare For Bankruptcy</t>
                            <t id="402">Give Me Equity Or Give Me Death</t>
                            <t id="403">Pecuniary Missionary</t>
                            <t id="404">Annuity Is An Interest Of Mine</t>
                            <t id="405">Fighting Me Is A Bad Value Proposition</t>
                            <t id="406">My Company Is More Solvent Than Yours</t>
                          -->
                    <set_value name="$PlateFleetComposition"   exact="[
                          [ macro.ship_tel_l_destroyer_01_a_macro, 30220, 173 ],
                          [ macro.ship_tel_l_destroyer_01_a_macro, 30220, 180 ],
                          [ macro.ship_tel_l_destroyer_01_a_macro, 30220, 424 ],
                          [ macro.ship_tel_m_bomber_01_a_macro, 30220, 182 ],
                          [ macro.ship_tel_m_bomber_01_a_macro, 30220, 192 ],
                          [ macro.ship_tel_m_bomber_01_a_macro, 30220, 194 ],
                          [ macro.ship_tel_m_bomber_01_a_macro, 30220, 195 ],
                          [ macro.ship_tel_m_bomber_01_a_macro, 30220, 198 ],
                          [ macro.ship_tel_m_bomber_01_a_macro, 30220, 402 ],
                          [ macro.ship_tel_m_bomber_01_a_macro, 30220, 403 ],
                          [ macro.ship_tel_m_bomber_01_a_macro, 30220, 404 ],
                          [ macro.ship_tel_m_bomber_01_a_macro, 30220, 405 ],
                          [ macro.ship_tel_m_bomber_01_a_macro, 30220, 406 ],
                          ]" />

                    <do_all exact="$PlateFleetComposition.count" counter="$f">
                      <!-- Capturable="true" is intended. -->
                      <create_ship name="$CurrentShip" macro="$PlateFleetComposition.{$f}.{1}" commandeerable="false" capturable="true" mission="true" sector="$PlateSector">
                        <owner exact="faction.scaleplate" overridenpc="true" />
                        <pilot>
                          <select faction="faction.scaleplate" tags="tag.elitepilot"/>
                        </pilot>
                        <loadout>
                          <level exact="1.0"/>
                        </loadout>
                        <people ref="scaleplate_elite_pirate_crew"/>
                        <safepos object="$PlateFlagship" space="$PlateSector" min="2km" max="10km"/>
                      </create_ship>

                      <do_if value="$PlateFleetComposition.{$f}.{2}">
                        <set_object_name object="$CurrentShip" page="$PlateFleetComposition.{$f}.{2}" line="$PlateFleetComposition.{$f}.{3}"/>
                      </do_if>

                      <add_to_group groupname="$PlateFleet" object="$CurrentShip"/>
                      <add_to_group groupname="$PirateShips" object="$CurrentShip"/>

                      <create_order id="'AssignCommander'" object="$CurrentShip" immediate="true">
                        <param name="commander" value="$PlateFlagship"/>
                        <param name="assignment" value="assignment.defence"/>
                        <param name="cancelorders" value="true"/>
                      </create_order>
                    </do_all>

                    <!-- Setup for the Holy Order Fanatic fleet -->
                    <create_position name="$GoldenSpawnPosition" space="$GoldenSector" x="60km" z="140km"/>

                    <create_ship name="$GoldenFlagship" macro="ship_par_l_destroyer_01_b_macro" commandeerable="false" capturable="true" mission="true" sector="$GoldenSector">
                      <owner exact="faction.holyorderfanatic" overridenpc="true"/>
                      <pilot>
                        <select race="race.paranid" tags="tag.elitepilot"/>
                      </pilot>
                      <loadout>
                        <level exact="1.0"/>
                      </loadout>
                      <paint ware="$GoldenPaint"/>
                      <people ref="paranid_elite_military_crew"/>
                      <safepos value="$GoldenSpawnPosition"/>
                    </create_ship>
                    <create_order id="'Patrol'" object="$GoldenFlagship" default="true">
                      <param name="space" value="$GoldenSector"/>
                    </create_order>

                    <set_object_name object="$GoldenFlagship" page="30220" line="412" comment="Golden God Of The Wastes"/>

                    <add_to_group groupname="$GoldenFleet" object="$GoldenFlagship"/>
                    <add_to_group groupname="$PirateFlagships" object="$GoldenFlagship"/>
                    <add_to_group groupname="$PirateShips" object="$GoldenFlagship"/>

                    <!-- Supporting fleet:
                          Corvettes:
                            <t id="155">Impurity Corrective</t>
                            <t id="157">Conservator Of Providence</t>
                            <t id="160">Implacable Premonition</t>
                            <t id="161">The Infinity Conviction</t>
                            <t id="162">Curse Thy Vision</t>
                            <t id="168">Partisan Of Enlightenment(the polearm, not the type of person)</t>
                          -->
                    <set_value name="$GoldenFleetComposition"   exact="[
                          [ macro.ship_par_m_corvette_01_b_macro, 30220, 155 ],
                          [ macro.ship_par_m_corvette_01_b_macro, 30220, 157 ],
                          [ macro.ship_par_m_corvette_01_b_macro, 30220, 160 ],
                          [ macro.ship_par_m_corvette_01_b_macro, 30220, 161 ],
                          [ macro.ship_par_m_corvette_01_b_macro, 30220, 162 ],
                          [ macro.ship_par_m_corvette_01_b_macro, 30220, 168 ]
                          ]" />

                    <do_all exact="$GoldenFleetComposition.count" counter="$f">
                      <!-- Capturable="true" is intended. -->
                      <create_ship name="$CurrentShip" macro="$GoldenFleetComposition.{$f}.{1}" commandeerable="false" capturable="true" mission="true" sector="$GoldenSector">
                        <owner exact="faction.holyorderfanatic" overridenpc="true" />
                        <pilot>
                          <select race="race.paranid" tags="tag.elitepilot"/>
                        </pilot>
                        <loadout ref="par_corvette_lancer"/>
                        <paint ware="$GoldenPaint"/>
                        <people ref="paranid_elite_military_crew"/>
                        <safepos object="$GoldenFlagship" space="$GoldenSector" min="2km" max="10km"/>
                      </create_ship>

                      <do_if value="$GoldenFleetComposition.{$f}.{2}">
                        <set_object_name object="$CurrentShip" page="$GoldenFleetComposition.{$f}.{2}" line="$GoldenFleetComposition.{$f}.{3}"/>
                      </do_if>

                      <add_to_group groupname="$GoldenFleet" object="$CurrentShip"/>
                      <add_to_group groupname="$PirateShips" object="$CurrentShip"/>

                      <create_order id="'AssignCommander'" object="$CurrentShip" immediate="true">
                        <param name="commander" value="$GoldenFlagship"/>
                        <param name="assignment" value="assignment.interception"/>
                        <param name="cancelorders" value="true"/>
                      </create_order>
                    </do_all>

                    <signal_cue cue="Esc_1_Disperse_Pirates_Mission"/>
                    <signal_cue cue="Esc_1_Insurgence_Fleet_Orders"/>
                  </actions>
                </cue>

                <cue name="Esc_1_Disperse_Pirates_Mission" version="2">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <update_mission cue="$MissionCue" description="(if player.entity.isfemale then {30220,9010} else {30220,9009})
                                                        + '\n\n' + {30220,8015} + '\n' + {30220,9007} + ' ' + {30220,9008}" comment="Description + Diplo and Eco Prediction"/>
                    <set_value name="$CurrentStep" operation="add"/>
                  </actions>
                  <delay exact="0.5s" comment="Necessary to signal child cue."/>
                  <actions>
                    <signal_cue cue="Esc_1_Disperse_Pirates_Reset_Objective"/>
                  </actions>
                  <patch sinceversion="2">
                    <!-- Until version 2, we didn't remove captured ships from $PirateShips. -->
                    <do_if value="Esc_1_Disperse_Pirates_Mission_Completion_Check.state == cuestate.waiting">
                      <!-- Some ships might have been removed from $PirateShips, but not from their fleet. Add them back here. -->
                      <do_for_each in="$ScaleFleet" name="$CurrentShip">
                        <do_if value="not $PirateShips.indexof.{$CurrentShip}">
                          <add_to_group groupname="$PirateShips" object="$CurrentShip"/>
                        </do_if>
                      </do_for_each>
                      <do_for_each in="$PlateFleet" name="$CurrentShip">
                        <do_if value="not $PirateShips.indexof.{$CurrentShip}">
                          <add_to_group groupname="$PirateShips" object="$CurrentShip"/>
                        </do_if>
                      </do_for_each>
                      <do_for_each in="$GoldenFleet" name="$CurrentShip">
                        <do_if value="not $PirateShips.indexof.{$CurrentShip}">
                          <add_to_group groupname="$PirateShips" object="$CurrentShip"/>
                        </do_if>
                      </do_for_each>

                      <!-- Loop over all ships and remove them from $PirateShips and their fleet if they've been captured.  -->
                      <do_for_each in="$PirateShips" name="$CurrentShip" reverse="true">
                        <do_if value="not [faction.holyorderfanatic, faction.scaleplate].indexof.{$CurrentShip.owner}">
                          <do_if value="$ScaleFleet.indexof.{$CurrentShip}">
                            <remove_from_group group="$ScaleFleet" object="$CurrentShip"/>
                          </do_if>
                          <do_elseif value="$PlateFleet.indexof.{$CurrentShip}">
                            <remove_from_group group="$PlateFleet" object="$CurrentShip"/>
                          </do_elseif>
                          <do_elseif value="$GoldenFleet.indexof.{$CurrentShip}">
                            <remove_from_group group="$GoldenFleet" object="$CurrentShip"/>
                          </do_elseif>
                          <remove_from_group group="$PirateShips" object="$CurrentShip"/>
                        </do_if>
                      </do_for_each>

                      <!-- If all pirate ships are gone or captured, the mission is complete. -->
                      <do_if value="not $PirateShips.count">
                        <signal_cue cue="Esc_1_Disperse_Pirates_Mission_Completion_Check"/>
                      </do_if>

                      <!-- Otherwise, check the flagships as well and hand over or remove the title if necessary. -->
                      <do_else>
                        <do_for_each in="$PirateFlagships" name="$CurrentShip" reverse="true">
                          <do_if value="not [faction.holyorderfanatic, faction.scaleplate].indexof.{$CurrentShip.owner}">
                            <remove_from_group group="$PirateFlagships" object="$CurrentShip"/>
                            <do_if value="$CurrentShip == $ScaleFlagship">
                              <set_value name="$ScaleFlagship" exact="if $ScaleFleet.count then $ScaleFleet.random else null"/>
                              <do_if value="$ScaleFlagship">
                                <add_to_group groupname="$PirateFlagships" object="$ScaleFlagship"/>
                              </do_if>
                            </do_if>
                            <do_elseif value="$CurrentShip == $PlateFlagship">
                              <set_value name="$PlateFlagship" exact="if $PlateFleet.count then $PlateFleet.random else null"/>
                              <do_if value="$PlateFlagship">
                                <add_to_group groupname="$PirateFlagships" object="$PlateFlagship"/>
                              </do_if>
                            </do_elseif>
                            <do_elseif value="$CurrentShip == $GoldenFlagship">
                              <set_value name="$GoldenFlagship" exact="if $GoldenFleet.count then $GoldenFleet.random else null"/>
                              <do_if value="$GoldenFlagship">
                                <add_to_group groupname="$PirateFlagships" object="$GoldenFlagship"/>
                              </do_if>
                            </do_elseif>
                          </do_if>
                        </do_for_each>
                        <!-- And then reset guidance. -->
                        <do_if value="$ScaleFleet.count">
                          <reset_cue cue="Approach_ScaleFleet"/>
                        </do_if>
                        <do_else>
                          <cancel_cue cue="Approach_ScaleFleet"/>
                        </do_else>
                        <do_if value="$PlateFleet.count">
                          <reset_cue cue="Approach_PlateFleet"/>
                        </do_if>
                        <do_else>
                          <cancel_cue cue="Approach_PlateFleet"/>
                        </do_else>
                        <do_if value="$GoldenFleet.count">
                          <reset_cue cue="Approach_GoldenFleet"/>
                        </do_if>
                        <do_else>
                          <cancel_cue cue="Approach_GoldenFleet"/>
                        </do_else>
                        <signal_cue cue="Esc_1_Disperse_Pirates_Reset_Objective"/>
                      </do_else>

                      <!-- Factions need to be hostile, otherwise we'd have to set checkrelation to false in the attack order and they would keep attacking even after the enemy had given up. -->
                      <set_value name="$BuccaneerScaleplateDefaultRelation" exact="faction.buccaneers.relationto.{faction.scaleplate}"/>
                      <set_faction_relation_locked faction="faction.scaleplate" locked="false"/>
                      <set_faction_relation_locked faction="faction.buccaneers" locked="false"/>
                      <set_faction_relation faction="faction.buccaneers" otherfaction="faction.scaleplate" value="faction.scaleplate.relation.killmilitary.max"/>
                      <set_faction_relation_locked faction="faction.scaleplate" locked="true"/>
                      <set_faction_relation_locked faction="faction.buccaneers" locked="true"/>

                      <!-- Re-evaluate orders for $InsurgenceFleet. -->
                      <signal_cue cue="Esc_1_Insurgence_Fleet_Orders_Enemy_Fleet_Destroyed"/>
                    </do_if>
                  </patch>
                  <cues>

                    <cue name="Esc_1_Disperse_Pirates_Reset_Objective" instantiate="true">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.defeat" group="$PirateFlagships" updatebriefing="true" silent="true" text="{30220,9021}" comment="Defeat: Unaffiliated Individuals"/>
                      </actions>
                    </cue>

                    <cue name="Esc_1_Disperse_Pirates_Mission_Surrender" instantiate="true">
                      <conditions>
                        <event_object_hull_damaged group="$PirateShips"/>
                        <check_value value="not $DamagedShips.indexof.{event.object}"/>
                        <check_value value="event.object.hullpercentage le 75"/>
                      </conditions>
                      <actions>
                        <debug_text text="event.object.knownname + ' damaged. 25% chance to switch sides.'" chance="$DebugChance"/>
                        <add_to_group groupname="$DamagedShips" object="event.object"/>
                        <do_all chance="25">
                          <debug_text text="'Switching sides.'" chance="$DebugChance"/>

                          <find_ship groupname="$ClosePlayerShips" owner="faction.player" space="event.object.sector" multiple="true"/>

                          <!-- Switching relation mid-fight requires a few extra actions. -->
                          <do_for_each in="$ClosePlayerShips" name="$CurrentShip">
                            <set_relation_boost object="event.object" otherobject="$CurrentShip" value="1.0" decay="0"/>
                          </do_for_each>
                          <do_for_each in="$InsurgenceFleet" name="$CurrentShip">
                            <set_relation_boost object="event.object" otherobject="$CurrentShip" value="1.0" decay="0"/>
                          </do_for_each>

                          <set_owner object="event.object" overridenpc="true" faction="faction.buccaneers"/>
                          <set_relation_boost object="event.object" faction="faction.player" value="1.0" decay="0"/>

                          <!-- Disable relation behaviour for a short while, so that attacking ships have time to realise that event.object isn't an enemy anymore. -->
                          <set_object_relation_behaviour object="event.object" disable="true"/>

                          <!-- Send the ship to either follow the buccaneer leader, or go plunder on its own. -->
                          <!--<do_if value="$InsurgenceCommander">
                            <create_order id="'AssignCommander'" object="event.object" immediate="true">
                              <param name="commander" value="$InsurgenceCommander"/>
                              <param name="assignment" value="assignment.defence"/>
                              <param name="cancelorders" value="true"/>
                            </create_order>
                          </do_if>-->
                          <!--<do_else>-->
                          <find_sector name="$DisperseTargetSector" space="player.galaxy" owner="[faction.paranid, faction.holyorder].random"/>
                          <cancel_all_orders object="event.object"/>
                          <create_order id="'Patrol'" object="event.object" default="true">
                            <param name="space" value="$DisperseTargetSector"/>
                          </create_order>
                          <!--</do_else>-->
                        </do_all>
                      </actions>
                      <delay exact="10s"/>
                      <actions>
                        <!-- Re-enable relation behaviour. -->
                        <do_if value="$PirateShips.indexof.{event.object}">
                          <set_object_relation_behaviour object="event.object" disable="false"/>
                        </do_if>
                      </actions>
                    </cue>

                    <cue name="Esc_1_Disperse_Pirates_Mission_Ship_Captured" instantiate="true">
                      <conditions>
                        <event_object_changed_true_owner group="$PirateShips"/>
                      </conditions>
                      <actions>
                        <do_if value="$ScaleFleet.indexof.{event.object}">
                          <remove_from_group group="$ScaleFleet" object="event.object"/>
                        </do_if>
                        <do_elseif value="$PlateFleet.indexof.{event.object}">
                          <remove_from_group group="$PlateFleet" object="event.object"/>
                        </do_elseif>
                        <do_elseif value="$GoldenFleet.indexof.{event.object}">
                          <remove_from_group group="$GoldenFleet" object="event.object"/>
                        </do_elseif>

                        <remove_from_group group="$PirateShips" object="event.object"/>

                        <!-- If the ship switching sides or getting captured here is the last of the pirates, the mission is complete. -->
                        <do_if value="not $PirateShips.count">
                          <signal_cue cue="Esc_1_Disperse_Pirates_Mission_Completion_Check"/>
                        </do_if>
                      </actions>
                    </cue>

                    <cue name="Esc_1_Disperse_Pirates_Mission_Completion_Check">
                      <conditions>
                        <check_any>
                          <event_cue_signalled/>
                          <check_all>
                            <event_object_destroyed group="$PirateShips"/>
                            <check_value value="$PirateShips.count == 1"/>
                          </check_all>
                        </check_any>
                      </conditions>
                      <actions>
                        <cancel_cue cue="Esc_1_Disperse_Pirates_Mission_Approach_Checks"/>
                        <set_value name="$CurrentStep" operation="add"/>
                        <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.await" text="{30220,8007}" updatebriefing="true" comment="Await: Next Stage of the Plan"/>
                      </actions>
                      <delay exact="5s"/>
                      <actions>
                        <signal_cue cue="Esc_1_Disperse_Pirates_Completed_Dal_Speak"/>
                      </actions>
                    </cue>

                    <cue name="Esc_1_Disperse_Pirates_Mission_Handover_Flagship_Title" instantiate="true">
                      <conditions>
                        <check_any>
                          <check_all>
                            <event_object_changed_true_owner group="$PirateFlagships"/>
                            <check_value value="$PirateShips.count ge 2" comment="Only bother if there are pirate ships left."/>
                          </check_all>
                          <check_all>
                            <event_object_destroyed group="$PirateFlagships"/>
                            <check_value value="$PirateShips.count ge 2" comment="Only bother if there are pirate ships left."/>
                          </check_all>
                        </check_any>
                      </conditions>
                      <delay exact="0.5s" comment="Wait for Esc_1_Disperse_Pirates_Mission_Ship_Captured to remove the ship from the fleet if captured."/>
                      <actions>
                        <do_if value="(event.object == $ScaleFlagship) and $ScaleFleet.count">
                          <set_value name="$ScaleFlagship" exact="$ScaleFleet.random"/>
                          <add_to_group groupname="$PirateFlagships" object="$ScaleFlagship"/>
                        </do_if>
                        <do_elseif value="(event.object == $PlateFlagship) and $PlateFleet.count">
                          <set_value name="$PlateFlagship" exact="$PlateFleet.random"/>
                          <add_to_group groupname="$PirateFlagships" object="$PlateFlagship"/>
                        </do_elseif>
                        <do_elseif value="(event.object == $GoldenFlagship) and $GoldenFleet.count">
                          <set_value name="$GoldenFlagship" exact="$GoldenFleet.random"/>
                          <add_to_group groupname="$PirateFlagships" object="$GoldenFlagship"/>
                        </do_elseif>
                      </actions>
                    </cue>

                    <cue name="Esc_1_Disperse_Pirates_Mission_Approach_Checks">
                      <cues>
                        <cue name="Approach_ScaleFleet">
                          <cues>
                            <cue name="Approach_ScaleFleet_Ref" ref="md.LIB_Generic.ApproachObject_Handler">
                              <param name="ApproachTarget"    value="$ScaleFlagship"/>
                              <param name="ApproachDistance"  value="30km"/>
                              <param name="SuccessSignalCue"  value="Approach_ScaleFleet_Success"/>
                            </cue>
                            <cue name="Approach_ScaleFleet_Target_Destroyed">
                              <conditions>
                                <check_any>
                                  <event_object_changed_true_owner object="$ScaleFlagship"/>
                                  <event_object_destroyed object="$ScaleFlagship"/>
                                </check_any>
                                <check_value value="(Approach_ScaleFleet_Success.state == cuestate.waiting) or (Approach_ScaleFleet_Success.state == cuestate.cancelled)"/>
                                <check_value value="(Approach_PlateFleet_Success.state == cuestate.waiting) or (Approach_PlateFleet_Success.state == cuestate.cancelled)"/>
                                <check_value value="(Approach_GoldenFleet_Success.state == cuestate.waiting) or (Approach_GoldenFleet_Success.state == cuestate.cancelled)"/>
                              </conditions>
                              <delay exact="1s" comment="Wait for Esc_1_Disperse_Pirates_Mission_Handover_Flagship_Title to assign a new flagship."/>
                              <actions>
                                <signal_cue cue="Esc_1_Disperse_Pirates_Reset_Objective"/>
                                <reset_cue cue="Approach_ScaleFleet"/>
                              </actions>
                            </cue>
                            <cue name="Approach_ScaleFleet_Success">
                              <conditions>
                                <event_cue_signalled/>
                              </conditions>
                              <actions>
                                <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.defeat" group="$ScaleFleet" updatebriefing="true" silent="true" text="{30220,9023}" comment="Defeat: Guardians of Solvency"/>
                                <do_if value="Esc_1_Disperse_Pirates_Mission_Approach_Dal_Speak.state == cuestate.waiting">
                                  <signal_cue cue="Esc_1_Disperse_Pirates_Mission_Approach_Dal_Speak"/>
                                </do_if>
                              </actions>
                              <cues>
                                <cue name="Approach_ScaleFleet_Cancel" instantiate="true">
                                  <conditions>
                                    <check_any>
                                      <event_object_changed_true_owner group="$ScaleFleet"/>
                                      <event_object_destroyed group="$ScaleFleet"/>
                                    </check_any>
                                  </conditions>
                                  <delay exact="1s" comment="Wait for Esc_1_Disperse_Pirates_Mission_Ship_Captured to remove the ship from the fleet groups."/>
                                  <actions>
                                    <do_if value="not $ScaleFleet.count">
                                      <do_if value="$PirateShips.count">
                                        <signal_cue cue="Esc_1_Disperse_Pirates_Reset_Objective"/>
                                      </do_if>
                                      <cancel_cue cue="Approach_ScaleFleet"/>
                                    </do_if>
                                  </actions>
                                </cue>
                                <cue name="Approach_ScaleFleet_Reset" checkinterval="1s">
                                  <conditions>
                                    <check_value value="player.entity.distanceto.{$ScaleFlagship} gt 60km"/>
                                  </conditions>
                                  <actions>
                                    <signal_cue cue="Esc_1_Disperse_Pirates_Reset_Objective"/>
                                    <reset_cue cue="Approach_ScaleFleet"/>
                                  </actions>
                                </cue>
                              </cues>
                            </cue>
                          </cues>
                        </cue>
                        <cue name="Approach_PlateFleet">
                          <cues>
                            <cue name="Approach_PlateFleet_Ref" ref="md.LIB_Generic.ApproachObject_Handler">
                              <param name="ApproachTarget"    value="$PlateFlagship"/>
                              <param name="ApproachDistance"  value="30km"/>
                              <param name="SuccessSignalCue"  value="Approach_PlateFleet_Success"/>
                            </cue>
                            <cue name="Approach_PlateFleet_Target_Destroyed">
                              <conditions>
                                <check_any>
                                  <event_object_changed_true_owner object="$PlateFlagship"/>
                                  <event_object_destroyed object="$PlateFlagship"/>
                                </check_any>
                                <check_value value="(Approach_ScaleFleet_Success.state == cuestate.waiting) or (Approach_ScaleFleet_Success.state == cuestate.cancelled)"/>
                                <check_value value="(Approach_PlateFleet_Success.state == cuestate.waiting) or (Approach_PlateFleet_Success.state == cuestate.cancelled)"/>
                                <check_value value="(Approach_GoldenFleet_Success.state == cuestate.waiting) or (Approach_GoldenFleet_Success.state == cuestate.cancelled)"/>
                              </conditions>
                              <delay exact="1s" comment="Wait for Esc_1_Disperse_Pirates_Mission_Handover_Flagship_Title to assign a new flagship."/>
                              <actions>
                                <signal_cue cue="Esc_1_Disperse_Pirates_Reset_Objective"/>
                                <reset_cue cue="Approach_PlateFleet"/>
                              </actions>
                            </cue>
                            <cue name="Approach_PlateFleet_Success">
                              <conditions>
                                <event_cue_signalled/>
                              </conditions>
                              <actions>
                                <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.defeat" group="$PlateFleet" updatebriefing="true" silent="true" text="{30220,9024}" comment="Defeat: Market Forces"/>
                                <do_if value="Esc_1_Disperse_Pirates_Mission_Approach_Dal_Speak.state == cuestate.waiting">
                                  <signal_cue cue="Esc_1_Disperse_Pirates_Mission_Approach_Dal_Speak"/>
                                </do_if>
                              </actions>
                              <cues>
                                <cue name="Approach_PlateFleet_Cancel" instantiate="true">
                                  <conditions>
                                    <check_any>
                                      <event_object_changed_true_owner group="$PlateFleet"/>
                                      <event_object_destroyed group="$PlateFleet"/>
                                    </check_any>
                                  </conditions>
                                  <delay exact="1s" comment="Wait for Esc_1_Disperse_Pirates_Mission_Ship_Captured to remove the ship from the fleet groups."/>
                                  <actions>
                                    <do_if value="not $PlateFleet.count">
                                      <do_if value="$PirateShips.count">
                                        <signal_cue cue="Esc_1_Disperse_Pirates_Reset_Objective"/>
                                      </do_if>
                                      <cancel_cue cue="Approach_PlateFleet"/>
                                    </do_if>
                                  </actions>
                                </cue>
                                <cue name="Approach_PlateFleet_Reset" checkinterval="1s">
                                  <conditions>
                                    <check_value value="player.entity.distanceto.{$PlateFlagship} gt 60km"/>
                                  </conditions>
                                  <actions>
                                    <signal_cue cue="Esc_1_Disperse_Pirates_Reset_Objective"/>
                                    <reset_cue cue="Approach_PlateFleet"/>
                                  </actions>
                                </cue>
                              </cues>
                            </cue>
                          </cues>
                        </cue>
                        <cue name="Approach_GoldenFleet">
                          <cues>
                            <cue name="Approach_GoldenFleet_Ref" ref="md.LIB_Generic.ApproachObject_Handler">
                              <param name="ApproachTarget"    value="$GoldenFlagship"/>
                              <param name="ApproachDistance"  value="30km"/>
                              <param name="SuccessSignalCue"  value="Approach_GoldenFleet_Success"/>
                            </cue>
                            <cue name="Approach_GoldenFleet_Target_Destroyed">
                              <conditions>
                                <check_any>
                                  <event_object_changed_true_owner object="$GoldenFlagship"/>
                                  <event_object_destroyed object="$GoldenFlagship"/>
                                </check_any>
                                <check_value value="(Approach_ScaleFleet_Success.state == cuestate.waiting) or (Approach_ScaleFleet_Success.state == cuestate.cancelled)"/>
                                <check_value value="(Approach_PlateFleet_Success.state == cuestate.waiting) or (Approach_PlateFleet_Success.state == cuestate.cancelled)"/>
                                <check_value value="(Approach_GoldenFleet_Success.state == cuestate.waiting) or (Approach_GoldenFleet_Success.state == cuestate.cancelled)"/>
                              </conditions>
                              <delay exact="1s" comment="Wait for Esc_1_Disperse_Pirates_Mission_Handover_Flagship_Title to assign a new flagship."/>
                              <actions>
                                <signal_cue cue="Esc_1_Disperse_Pirates_Reset_Objective"/>
                                <reset_cue cue="Approach_GoldenFleet"/>
                              </actions>
                            </cue>
                            <cue name="Approach_GoldenFleet_Success">
                              <conditions>
                                <event_cue_signalled/>
                              </conditions>
                              <actions>
                                <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.defeat" group="$GoldenFleet" updatebriefing="true" silent="true" text="{30220,9022}" comment="Defeat: Disciples of the Sleeping Pontifex"/>
                                <do_if value="Esc_1_Disperse_Pirates_Mission_Approach_Dal_Speak.state == cuestate.waiting">
                                  <signal_cue cue="Esc_1_Disperse_Pirates_Mission_Approach_Dal_Speak"/>
                                </do_if>
                              </actions>
                              <cues>
                                <cue name="Approach_GoldenFleet_Cancel" instantiate="true">
                                  <conditions>
                                    <check_any>
                                      <event_object_changed_true_owner group="$GoldenFleet"/>
                                      <event_object_destroyed group="$GoldenFleet"/>
                                    </check_any>
                                  </conditions>
                                  <delay exact="1s" comment="Wait for Esc_1_Disperse_Pirates_Mission_Ship_Captured to remove the ship from the fleet groups."/>
                                  <actions>
                                    <do_if value="not $GoldenFleet.count">
                                      <do_if value="$PirateShips.count">
                                        <signal_cue cue="Esc_1_Disperse_Pirates_Reset_Objective"/>
                                      </do_if>
                                      <cancel_cue cue="Approach_GoldenFleet"/>
                                    </do_if>
                                  </actions>
                                </cue>
                                <cue name="Approach_GoldenFleet_Reset" checkinterval="1s">
                                  <conditions>
                                    <check_value value="player.entity.distanceto.{$GoldenFlagship} gt 60km"/>
                                  </conditions>
                                  <actions>
                                    <signal_cue cue="Esc_1_Disperse_Pirates_Reset_Objective"/>
                                    <reset_cue cue="Approach_GoldenFleet"/>
                                  </actions>
                                </cue>
                              </cues>
                            </cue>
                          </cues>
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Esc_1_Disperse_Pirates_Mission_Approach_Dal_Speak">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <cues>
                        <cue name="Esc_1_Approach_Dal_Speak_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$DalBusta"/>
                          <param name="CutsceneKey"       value="$DalCutsceneKey"/>
                          <param name="Lines"             value="[[30220334],[30220908, 0.5s]]"/>
                          <param name="EndSignalCue"      value="null"/>
                          <!--           
                                   There!
                                   Those look like a shady bunch.
                                  -->
                        </cue>
                      </cues>
                    </cue>

                  </cues>
                </cue>

                <cue name="Esc_1_Disperse_Pirates_Completed_Dal_Speak">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <cues>
                    <cue name="Esc_1_Dal_Speak_701_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$DalBusta"/>
                      <param name="CutsceneKey"       value="$DalCutsceneKey"/>
                      <param name="Lines"             value="[[30220660],[30220909, 0.5s]]"/>
                      <param name="EndSignalCue"      value="Esc_1_Diplomatic_Change"/>
                      <!--           
                                   That's the last of them!
                                   Let's sit back for a while and let Kromancketslat get to work.
                                  -->
                    </cue>
                  </cues>
                </cue>

              </cues>
            </cue>

            <cue name="Esc_1_Insurgence_Fleet_Orders">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <!-- faction.buccaneers is already hostile to faction.holyorderfanatic, so we only need to set them to hostile with faction.scaleplate for the duration of this mission. -->
                <set_value name="$BuccaneerScaleplateDefaultRelation" exact="faction.buccaneers.relationto.{faction.scaleplate}"/>
                <set_faction_relation_locked faction="faction.scaleplate" locked="false"/>
                <set_faction_relation_locked faction="faction.buccaneers" locked="false"/>
                <set_faction_relation faction="faction.buccaneers" otherfaction="faction.scaleplate" value="faction.scaleplate.relation.killmilitary.max"/>
                <set_faction_relation_locked faction="faction.scaleplate" locked="true"/>
                <set_faction_relation_locked faction="faction.buccaneers" locked="true"/>

                <!-- It wouldn't make much sense for the insurgence fleet not to help clean out the pirates. -->
                <create_order object="$InsurgenceCommander" id="'Attack'" default="true">
                  <param name="primarytarget" value="$ScaleFlagship"/>
                  <param name="secondarytargets" value="$ScaleFleet"/>
                  <param name="pursuetargets" value="true"/>
                  <param name="allowothertargets" value="false"/>
                </create_order>
              </actions>
              <cues>

                <cue name="Esc_1_Insurgence_Fleet_Orders_Commander_Died">
                  <conditions>
                    <event_object_commander_set previous="$InsurgenceCommander" group="$InsurgenceFleet"/>
                  </conditions>
                  <actions>
                    <!-- Keep track of the current commander, so that we can give more orders later. -->
                    <do_if value="event.param">
                      <set_value name="$InsurgenceCommander" exact="event.param"/>
                    </do_if>
                    <!-- TODO: For some reason event.param is sometimes null. Investigate. -->
                    <do_else>
                      <set_value name="$InsurgenceCommander" exact="$InsurgenceFleet.random"/>
                      <do_for_each in="$InsurgenceFleet" name="$CurrentShip">
                        <do_if value="$CurrentShip != $InsurgenceCommander">
                          <create_order id="'AssignCommander'" object="$CurrentShip" immediate="true">
                            <param name="commander" value="$InsurgenceCommander"/>
                            <param name="assignment" value="assignment.defence"/>
                            <param name="cancelorders" value="true"/>
                          </create_order>
                        </do_if>
                      </do_for_each>
                      <signal_cue cue="Esc_1_Insurgence_Fleet_Orders_Enemy_Fleet_Destroyed" comment="Re-evaluate current orders."/>
                    </do_else>
                    <reset_cue cue="Esc_1_Insurgence_Fleet_Orders_Commander_Died"/>
                  </actions>
                </cue>

                <cue name="Esc_1_Insurgence_Fleet_Orders_Enemy_Fleet_Destroyed" instantiate="true">
                  <conditions>
                    <check_any>
                      <event_cue_signalled/>
                      <check_all>
                        <check_any>
                          <event_object_changed_true_owner group="$ScaleFleet"/>
                          <event_object_destroyed group="$ScaleFleet"/>
                        </check_any>
                        <check_value value="$ScaleFleet.count == 1"/>
                      </check_all>
                      <check_all>
                        <check_any>
                          <event_object_changed_true_owner group="$GoldenFleet"/>
                          <event_object_destroyed group="$GoldenFleet"/>
                        </check_any>
                        <check_value value="$GoldenFleet.count == 1"/>
                      </check_all>
                      <check_all>
                        <check_any>
                          <event_object_changed_true_owner group="$PlateFleet"/>
                          <event_object_destroyed group="$PlateFleet"/>
                        </check_any>
                        <check_value value="$PlateFleet.count == 1"/>
                      </check_all>
                    </check_any>
                  </conditions>
                  <delay exact="1s" comment="Wait for Esc_1_Disperse_Pirates_Mission_Ship_Captured to remove the ship from the fleet groups."/>
                  <actions>
                    <do_if value="$ScaleFleet.count">
                      <create_order object="$InsurgenceCommander" id="'Attack'" default="true">
                        <param name="primarytarget" value="if $ScaleFlagship then $ScaleFlagship else $ScaleFleet.random"/>
                        <param name="secondarytargets" value="$ScaleFleet"/>
                        <param name="pursuetargets" value="true"/>
                        <param name="allowothertargets" value="false"/>
                      </create_order>
                    </do_if>
                    <do_elseif value="$PlateFleet.count">
                      <create_order object="$InsurgenceCommander" id="'Attack'" default="true">
                        <param name="primarytarget" value="if $PlateFlagship then $PlateFlagship else $PlateFleet.random"/>
                        <param name="secondarytargets" value="$PlateFleet"/>
                        <param name="pursuetargets" value="true"/>
                        <param name="allowothertargets" value="false"/>
                      </create_order>
                    </do_elseif>
                    <do_elseif value="$GoldenFleet.count">
                      <create_order object="$InsurgenceCommander" id="'Attack'" default="true">
                        <param name="primarytarget" value="if $GoldenFlagship then $GoldenFlagship else $GoldenFleet.random"/>
                        <param name="secondarytargets" value="$GoldenFleet"/>
                        <param name="pursuetargets" value="true"/>
                        <param name="allowothertargets" value="false"/>
                      </create_order>
                    </do_elseif>
                    <do_else>
                      <!-- Return relation to normal. -->
                      <set_faction_relation_locked faction="faction.scaleplate" locked="false"/>
                      <set_faction_relation_locked faction="faction.buccaneers" locked="false"/>
                      <set_faction_relation faction="faction.buccaneers" otherfaction="faction.scaleplate" value="$BuccaneerScaleplateDefaultRelation"/>
                      <set_faction_relation_locked faction="faction.scaleplate" locked="true"/>
                      <set_faction_relation_locked faction="faction.buccaneers" locked="true"/>
                      <do_if value="$InsurgenceFleet.count">
                        <!-- Distribute insurgence fleet ships across the Paranid sectors. -->
                        <find_sector name="$InsurgenceSectors" owner="[faction.paranid, faction.holyorder]" space="player.galaxy" multiple="true" sortbygatedistanceto="$HQ.sector"/>
                        <do_for_each in="$InsurgenceFleet" name="$CurrentShip">
                          <cancel_all_orders object="$CurrentShip"/>
                          <create_order object="$CurrentShip" id="'Patrol'" default="true">
                            <param name="space" value="$InsurgenceSectors.random"/>
                          </create_order>
                        </do_for_each>
                      </do_if>
                    </do_else>
                  </actions>
                </cue>

              </cues>
            </cue>

            <cue name="Esc_1_Diplomatic_Change">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <debug_text text="'Fleet battle mission completed. Signalling Escalation Stage 1 Diplomatic Change (faction.buccaneers jobs activation).'" chance="$DebugChance"/>
                <signal_cue cue="Buccaneers_Stage_1_ActivatePirateJobs"/>
                <signal_cue cue="Esc_1_Cooldown"/>
              </actions>
            </cue>

            <cue name="Esc_1_Cooldown">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <cues>

                <cue name="Esc_1_Cooldown_Update_Objective">
                  <actions>
                    <update_mission cue="$MissionCue" description="if player.entity.isfemale then {30220,9012} else {30220,9011}" icon="'briefing_dal_busta_01'" iconcaption="$DalBusta.name"/>
                  </actions>
                </cue>

                <cue name="Esc_1_Cooldown_Delay">
                  <delay exact="10min"/>
                  <actions>
                    <write_to_logbook category="missions" faction="faction.player" title="{30220,9001}" text="if player.entity.isfemale then {30220,9014} else {30220,9013}"/>
                    <signal_cue cue="Sinks_Escalation_Stage_2"/>
                  </actions>
                </cue>

              </cues>
            </cue>

          </cues>
        </cue>

        <cue name="Sinks_Escalation_Stage_2">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <cues>

            <cue name="Esc_2_Boso_Call">
              <actions>
                <debug_text text="'Escalation sinks Boso Ta call now available.'" chance="$DebugChance"/>
              </actions>
              <cues>

                <cue name="Esc_2_Boso_Call_Parent">
                  <delay exact="5min"/>
                  <actions>
                    <do_if value="$HQ? and $DalBusta.hascontext.{$HQ}">
                      <debug_text text="'Starting Boso Ta call in escalation sinks stage 2.'" chance="$DebugChance"/>
                      <play_cutscene key="$BosoCutsceneKey.$key" result="this.$CutsceneID" targetmonitor="true">
                        <interaction text="{30220,1004}" param="$BosoTa" param2="'accept_interaction'"/>
                        <param name="npcref" object="$BosoTa" />
                      </play_cutscene>
                    </do_if>
                    <do_else>
                      <debug_text text="'Dal Busta is not on the HQ. Resetting Esc 2 Boso Ta call.'" chance="$DebugChance"/>
                      <reset_cue cue="Esc_2_Boso_Call_Parent"/>
                    </do_else>
                  </actions>
                  <cues>

                    <cue name="Esc_2_Boso_Call_Speak">
                      <conditions>
                        <event_cutscene_started key="$BosoCutsceneKey.$key"/>
                      </conditions>
                      <actions>
                        <signal_cue cue="Esc_2_Boso_Call_No_Interact"/>
                        <speak actor="$BosoTa" priority="100">
                          <text line="if player.entity.isfemale then 30200011 else 30200010" delay="0.6s" comment="Assistant!"/>
                        </speak>
                      </actions>
                    </cue>

                    <!--Accept the call-->
                    <cue name="Esc_2_Boso_Call_Interact">
                      <conditions>
                        <event_player_interaction param="$BosoTa" param2="'accept_interaction'"/>
                      </conditions>
                      <actions>
                        <stop_cutscene cutscene="parent.$CutsceneID"/>
                        <cancel_cue cue="Esc_2_Boso_Call_No_Interact"/>

                        <signal_cue cue="Esc_2_Boso_Call_Conversation"/>
                      </actions>
                    </cue>

                    <!--Fail to accept the call-->
                    <cue name="Esc_2_Boso_Call_No_Interact">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <delay exact="10s" comment="cutscene timeout"/>
                      <actions>
                        <stop_cutscene cutscene="parent.$CutsceneID"/>
                        <reset_cue cue="parent"/>
                      </actions>
                    </cue>

                  </cues>
                </cue>

                <cue name="Esc_2_Boso_Call_Conversation">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <start_conversation actor="$BosoTa" conversation="boso_esc_2_call" priority="100"/>
                  </actions>
                  <cues>
                    <cue name="Esc_2_Boso_Call_Conversation_Section_Main">
                      <conditions>
                        <event_conversation_started actor="$BosoTa" conversation="boso_esc_2_call"/>
                      </conditions>
                      <actions>
                        <allow_conversation_escape enabled="false"/>

                        <add_npc_line speaker="$BosoTa" line="if player.entity.isfemale then 30220902 else 30220901" hidechoices="true" comment="Assistant, we have a possible situation brewing!"/>
                        <add_npc_line speaker="$BosoTa" line="if player.entity.isfemale then 30220904 else 30220903" hidechoices="true" comment="Please return to my laboratory forthwith!"/>
                      </actions>
                    </cue>
                    <cue name="Esc_2_Boso_Call_Conversation_Finished">
                      <conditions>
                        <event_conversation_finished actor="$BosoTa"/>
                      </conditions>
                      <actions>
                        <!-- Wait with removing Escalation Sink mission 1 until here, so that the "Await" objective keeps being displayed until here. -->
                        <remove_mission cue="$MissionCue" type="completed"/>
                        <signal_cue cue="Esc_2_Briefing"/>
                      </actions>
                    </cue>
                  </cues>
                </cue>

              </cues>
            </cue>

            <cue name="Esc_2_Briefing">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <debug_text text="'Escalation sinks stage 2 conversation now available at HQ'" chance="$DebugChance"/>

                <!-- Place Gride on the HQ-->
                <create_position name="$GridePos" x="0" z="-8.9" y="0.56" comment="On the stepladder behind Boso Ta."/>
                <create_rotation name="$GrideRot" yaw="0deg"/>
                <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $GrideActor,
                                                                                                  table[
                                                                                                  $requestercue = namespace,
                                                                                                  $location = $BosoTa.room,
                                                                                                  $rotation = $GrideRot,
                                                                                                  $position = $GridePos,
                                                                                                  $priority = 100,
                                                                                                  $debugchance = $DeepDebugChance,
                                                                                                  $debugcaller = if $DebugChance == 100 then this else null]
                                                                                                  ]"/>

                <create_mission cue="$MissionCue" name="{30220,9101}" description="if player.entity.isfemale then {30220,9103} else {30220,9102}" rewardtext="{30220,9104}" type="missiontype.plot" faction="faction.player" difficulty="level.veryhard" abortable="false" icon="'briefing_boso_ta_01'" iconcaption="$BosoTa.name">
                  <briefing>
                    <objective step="1" action="objective.talkto" object="$BosoTa" comment="Talk to: Boso Ta"/>
                  </briefing>
                </create_mission>
                <set_value name="$CurrentStep" exact="1"/>
                <set_objective_from_briefing cue="$MissionCue" step="$CurrentStep"/>
              </actions>
              <cues>

                <cue name="Esc_2_Briefing_Boso_Conversation_Header" instantiate="true">
                  <conditions>
                    <event_conversation_started actor="$BosoTa"/>
                    <check_value value="$HQ? and $BosoTa.hascontext.{$HQ} and player.entity.hascontext.{$HQ}"/>
                  </conditions>
                  <actions>
                    <add_player_choice text="{30220,9120}" section="esc_2_boso_main" comment="What happened?"/>
                  </actions>
                </cue>

                <cue name="Esc_2_Briefing_Boso_Conversation">
                  <conditions>
                    <event_conversation_next_section actor="$BosoTa" section="esc_2_boso_main"/>
                  </conditions>
                  <actions>
                    <cancel_cue cue="Esc_2_Briefing_Boso_Conversation_Header"/>
                    <allow_conversation_escape enabled="false"/>

                    <add_npc_line speaker="$BosoTa" hidechoices="true" line="if player.entity.isfemale then 30220906 else 30220905" comment="You have returned!"/>
                    <add_npc_line speaker="$BosoTa" hidechoices="true" line="30220907" comment="The venerable Argon lady has been staring at me for hours."/>
                    <add_npc_line speaker="$BosoTa" hidechoices="true" line="if player.entity.isfemale then 30220909 else 30220908" comment="Please make her go away."/>
                  </actions>
                  <cues>
                    <cue name="Esc_2_Briefing_Boso_Conversation_Finished">
                      <conditions>
                        <event_conversation_finished actor="$BosoTa"/>
                      </conditions>
                      <actions>
                        <!-- Overwrite previous objective, so don't increase $CurrentStep. -->
                        <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.talkto" object="$GrideActor" updatebriefing="true" comment="Talk to: Gride Orrian"/>
                      </actions>
                    </cue>
                  </cues>
                </cue>

                <cue name="Esc_2_Briefing_Dal_Conversation_Header" instantiate="true">
                  <conditions>
                    <event_conversation_started actor="$DalBusta"/>
                    <check_value value="$HQ? and $DalBusta.hascontext.{$HQ} and player.entity.hascontext.{$HQ}"/>
                  </conditions>
                  <actions>
                    <do_if value="$Esc2SpokenToGride?">
                      <add_player_choice text="{30220,9121}" section="esc_2_2_dal_main" comment="Who was the Pirate Duke?"/>
                    </do_if>
                    <do_else>
                      <add_player_choice text="{30220,205}" section="esc_2_1_dal_main" comment="Paranid Civil War"/>
                    </do_else>
                  </actions>
                </cue>

                <cue name="Esc_2_Briefing_Dal_Conversation_1">
                  <conditions>
                    <event_conversation_next_section actor="$DalBusta" section="esc_2_1_dal_main"/>
                  </conditions>
                  <actions>
                    <!-- Cancel the header here, reset it when the conversation with Gride is done. -->
                    <cancel_cue cue="Esc_2_Briefing_Dal_Conversation_Header"/>
                    <allow_conversation_escape enabled="false"/>

                    <add_npc_line speaker="$DalBusta" hidechoices="true" line="30220910" comment="Oh, hey."/>
                    <add_npc_line speaker="$DalBusta" hidechoices="true" line="if player.entity.isfemale then 30220912 else 30220911" comment="Gride has been asking for you."/>
                  </actions>
                </cue>

                <cue name="Esc_2_Briefing_Dal_Conversation_2">
                  <conditions>
                    <event_conversation_next_section actor="$DalBusta" section="esc_2_2_dal_main"/>
                  </conditions>
                  <actions>
                    <!-- Cancel header for good this time. -->
                    <cancel_cue cue="Esc_2_Briefing_Dal_Conversation_Header"/>
                    <allow_conversation_escape enabled="false"/>

                    <add_npc_line speaker="$DalBusta" line="30220913" hidechoices="true" comment="I have indeed done my research in the time since that fortunate diplomatic debacle."/>
                    <add_npc_line speaker="$DalBusta" line="30220914" hidechoices="true" comment="And boy, that old woman really lays it on thick."/>
                    <add_npc_line speaker="$DalBusta" line="30220915" hidechoices="true" comment="Sure, her 'Pirate Duke' did make a few dramatic appearances back in the days before the big gate shutdown."/>
                    <add_npc_line speaker="$DalBusta" line="30220916" hidechoices="true" comment="Always had a knack for intrigue, logistics and... (slight pause before 'motivating')'motivating' his followers."/>
                    <add_npc_line speaker="$DalBusta" line="30220917" hidechoices="true" comment="However, at the end of the day, he was just that: a pirate."/>
                    <add_npc_line speaker="$DalBusta" line="30220918" hidechoices="true" comment="Holed up with his dingy fleet in a fringe sector, waylaying and ruining the day for us upstanding folk."/>
                    <add_npc_line speaker="$DalBusta" line="30220919" hidechoices="true" comment="Granted, there may be lots of opportunities for a character like that in today's galaxy."/>
                    <add_npc_line speaker="$DalBusta" line="30220920" hidechoices="true" comment="But after he's played his part in our little conspiracy, he'll be forgotten again, just like all the others."/>
                  </actions>
                </cue>

                <cue name="Esc_2_Briefing_Gride_Conversation">
                  <conditions>
                    <event_conversation_started actor="$GrideActor"/>
                  </conditions>
                  <actions>
                    <!-- Remember that the Gride conversation has taken place. -->
                    <set_value name="$Esc2SpokenToGride"/>
                    <!-- Re-enable Dal conversation. -->
                    <reset_cue cue="Esc_2_Briefing_Dal_Conversation_Header"/>
                    <!-- Cancel Boso Conversation, in case the player went to Gride directly. -->
                    <cancel_cue cue="Esc_2_Briefing_Boso_Conversation"/>
                    <allow_conversation_escape enabled="false"/>

                    <add_npc_line speaker="$GrideActor" hidechoices="true" line="if player.entity.isfemale then 30220602 else 30220601" comment="It's good to see you again, dear."/>
                    <add_npc_line speaker="$GrideActor" hidechoices="true" line="if player.entity.isfemale then 30220901 else 30220901" comment="I was devastated when you didn't call me after the grand spectacle."/>
                    <add_npc_line speaker="$GrideActor" hidechoices="true" line="if player.entity.isfemale then 30220904 else 30220903" comment="Luckily, your friends are being very hospitable to me."/>
                    <add_npc_line speaker="$GrideActor" hidechoices="true" line="if player.entity.isfemale then 30220906 else 30220905" comment="I'm particularly fond of your cute Boron."/>

                    <add_player_choice text="{30220,9122}" section="esc_2_gride_continue" comment="What are you doing here?"/>
                  </actions>
                  <cues>

                    <cue name="Esc_2_Briefing_Gride_Conversation_Section_Continue">
                      <conditions>
                        <event_conversation_next_section actor="$GrideActor" section="esc_2_gride_continue"/>
                      </conditions>
                      <actions>
                        <allow_conversation_escape enabled="false"/>
                        <add_npc_line speaker="$GrideActor" hidechoices="true" line="if player.entity.isfemale then 30220908 else 30220907" comment="You see, it's truly invigorating to know that my Duke is back to his old self."/>
                        <add_npc_line speaker="$GrideActor" hidechoices="true" line="if player.entity.isfemale then 30220910 else 30220909" comment="I'm sure you have heard some of the grand tales by now."/>
                        <add_npc_line speaker="$GrideActor" hidechoices="true" line="30220911" comment="The entirety of the southern network, Paranid, Split and Boron alike, trembled in fear of the Buccaneers."/>
                        <add_npc_line speaker="$GrideActor" hidechoices="true" line="30220912" comment="My Duke commands a sizeable fleet now, but what is a true pirate without a lair?"/>
                        <add_npc_line speaker="$GrideActor" hidechoices="true" line="if player.entity.isfemale then 30220914 else 30220913" comment="We once had a grand, impervious haven to call our own, and with your help, so it shall be again."/>
                      </actions>
                    </cue>

                    <cue name="Esc_2_Briefing_Gride_Conversation_Finished">
                      <conditions>
                        <event_conversation_finished actor="$GrideActor"/>
                      </conditions>
                      <actions>
                        <speak actor="$GrideActor" priority="100">
                          <text line="if player.entity.isfemale then 30220916 else 30220915" comment="Don't you worry. There will be a reward, as always."/>
                        </speak>

                        <signal_cue cue="Esc_2_Haven_Foundation"/>
                      </actions>
                      <delay exact="4s"/>
                      <actions>
                        <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $GrideActor, table[
                                                                                                                                  $requestercue = $MissionCue,
                                                                                                                                  $priority = 100,
                                                                                                                                  $location = 'disconnect',
                                                                                                                                  $rotation = $GrideRot,
                                                                                                                                  $position = $GridePos,
                                                                                                                                  $debugchance = $DeepDebugChance,
                                                                                                                                  $debugcaller = if $DebugChance == 100 then this else null]
                                                                                                                                  ]"/>
                      </actions>
                    </cue>

                  </cues>
                </cue>

              </cues>
            </cue>

            <cue name="Esc_2_Haven_Foundation">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <find_sector name="$PlotSector" macro="macro.cluster_04_sector002_macro" comment="'Nopileos' Fortune VI', see also Find_Faction_Headquarters"/>
                <create_position name="$TargetOffset" space="$PlotSector" z="100km"/>
                <set_value name="$PlotOffset" exact="position.[$TargetOffset.x, 0m, $TargetOffset.z]" comment="Engine limitation, build station near ecliptic (y=0)"/>
                <!-- This costs about 80 million credits, 620 million if you include blueprints. -->
                <set_value name="$StationSpecs" exact="table[
                                      $containedmacros = [
                                                            [ 1,  macro.defence_par_claim_01_macro ],
                                                            [ 8,  macro.defence_par_disc_01_macro ],
                                                            [ 8,  macro.defence_par_tube_01_macro ],
                                                            [ 12, macro.storage_par_l_container_01_macro ],
                                                            [ 4,  macro.hab_par_l_01_macro ],
                                                            [ 2,  macro.buildmodule_gen_ships_m_dockarea_01_macro],
                                                            [ 4,  macro.buildmodule_gen_ships_l_macro],
                                                            [ 2,  macro.buildmodule_gen_ships_xl_macro]                                                            
                                                         ],
                                      $containedclasses = [
                                                            [   2, class.dockarea,         {30120,103}, {30120,104}],
                                                            [   2, class.pier,             {30120,111}, {30120,112}],
                                                            [ 350, class.turret,           {30120,105}, {30120,106}],
                                                            [ 150, class.shieldgenerator,  {30120,109}, {30120,110}]
                                                          ]
                                      ]"/>
                <set_value name="$PlotRange" exact="50km"/>
                <set_value name="$PlotSize" exact="vector.[10km,10km,10km]"/>
                <set_value name="$PlotFaction" exact="faction.buccaneers"/>

                <run_actions ref="md.GM_BuildStation.ConstructRequirementsText" result="$RequirementsText">
                  <param name="PlotSector"              value="$PlotSector" />
                  <param name="PlotSize"                value="$PlotSize" />
                  <param name="StationSpecs"            value="$StationSpecs" />
                  <param name="DestinationDBString"     value="{30120,200}" />
                </run_actions>

                <set_value name="$CurrentStep" operation="add"/>

                <update_mission cue="$MissionCue" description="(if player.entity.isfemale then {30220,9106} else {30220,9105})
                                                    + '\n\n' + $RequirementsText
                                                    + '\n\n' + {30220,8015} + '\n' + {30220,9107} + ' ' + {30220,9108}" comment="Description + Station requirements + Diplo and eco predictions" icon="'briefing_gride_orrian_01'" iconcaption="$GrideActor.name"/>
              </actions>
              <delay exact="1s" comment="required to signal a child"/>
              <actions>
                <signal_cue cue="Esc_2_Haven_Foundation_Claim_Plot"/>
              </actions>
              <cues>

                <cue name="Esc_2_Haven_Foundation_Build_Station_DEBUG" instantiate="true">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <create_station name="$DebugHaven" macro="macro.station_gen_factory_base_01_macro" owner="faction.player" sector="$PlotSector" state="componentstate.operational" constructionplan="'paranid_duke_station'">
                      <safepos x="$PlotOffset.x" y="$PlotOffset.y" z="$PlotOffset.z"/>
                    </create_station>
                  </actions>
                </cue>

                <cue name="Esc_2_Haven_Foundation_Claim_Plot">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <cues>
                    <cue name="Esc_2_Haven_Foundation_Claim_Plot_Ref" ref="md.RML_ClaimPlot.ClaimPlot">
                      <!-- mandatory parameters -->
                      <param name="EndSignalCue"      value="Esc_2_Haven_Foundation_Claim_Plot_Done" comment="RML returns $StationBuilt in this cue"/>
                      <param name="MissionCue"        value="$MissionCue"/>
                      <param name="StartStep"         value="$CurrentStep" comment="Briefing step to start the mission on"/>
                      <param name="UpdateBriefing"    value="true" comment="Update the briefing objective step when the objective is updated"/>
                      <param name="DebugChance"       value="100"/>
                      <!-- mission-specific parameters -->
                      <param name="Faction"           value="$PlotFaction"/>
                      <param name="PlotSector"        value="$PlotSector"/>
                      <param name="PlotOffset"        value="$PlotOffset"/>
                      <param name="PlotRange"         value="$PlotRange"/>
                      <param name="PlotSize"          value="$PlotSize"/>
                      <param name="ObjectiveText"     value="{30220,8121}" comment="Plot at Specified Location"/>
                    </cue>

                    <cue name="Esc_2_Haven_Foundation_Claim_Plot_KeepAlive">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                    </cue>
                  </cues>
                </cue>

                <cue name="Esc_2_Haven_Foundation_Claim_Plot_Done">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <set_value name="$CurrentStep" operation="add"/>
                    <set_value name="$CutsceneObject" exact="Esc_2_Haven_Foundation_Claim_Plot_Done.$StationBuilt" />
                    <set_value name="$RML_Result_Table" exact="table[]"/>
                    <reset_cue cue="Esc_2_Haven_Foundation_Claim_Plot" comment="can be signalled again if the station becomes invalid"/>
                  </actions>
                  <cues>

                    <cue name="Esc_2_Haven_Foundation_Build_Station_Ref" ref="md.RML_BuildStation.BuildStation">
                      <!-- always pass these -->
                      <param name="EndSignalCue"      value="Esc_2_Haven_Foundation_Build_Station_Complete"/>
                      <param name="MissionCue"        value="$MissionCue"/>
                      <param name="StartStep"         value="$CurrentStep" comment="Briefing step to start the mission on"/>
                      <param name="UpdateBriefing"    value="true" comment="Update the briefing objective step when the objective is updated"/>
                      <param name="DebugChance"       value="100"/>
                      <!-- mission-related parameters -->
                      <param name="Station"           value="Esc_2_Haven_Foundation_Claim_Plot_Done.$StationBuilt"/>
                      <param name="StationSpecs"      value="$StationSpecs"/>
                      <param name="Faction"           value="$PlotFaction"/>
                      <param name="PlotSector"        value="$PlotSector"/>
                      <param name="PlotOffset"        value="$PlotOffset"/>
                      <param name="PlotRange"         value="$PlotRange"/>
                      <param name="PlotSize"          value="$PlotSize"/>
                      <param name="ObjectiveText"     value="{30220,9130}" comment="Duke's Haven"/>
                      <!--param name="ResultTable"       value="$RML_Result_Table"/-->
                    </cue>

                    <cue name="Esc_2_Haven_Foundation_Build_Station_Complete">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <!--Station plot was destroyed, or moved outside the specified position - restart the claim plot objective-->
                        <do_if value="(this.$EndFeedbackValue == -1) or (this.$EndFeedbackValue == -3)">
                          <debug_text text="'Restart claimplot objective'"/>
                          <set_value name="$CurrentStep" operation="subtract"/>
                          <set_value name="Esc_2_Haven_Foundation_Claim_Plot_Done.$StationBuilt" exact="null"/>
                          <signal_cue cue="Esc_2_Haven_Foundation_Claim_Plot"/>
                          <reset_cue cue="Esc_2_Haven_Foundation_Claim_Plot_Done"/>
                        </do_if>
                        <!-- Failure case (invalid parameters passed into RML) -->
                        <do_elseif value="this.$EndFeedbackValue" max="0">
                        </do_elseif>
                        <!-- Success case -->
                        <do_else>
                          <debug_text text="'Completed station as specified'"/>
                          <set_value name="$DukeStation" exact="Esc_2_Haven_Foundation_Claim_Plot_Done.$StationBuilt"/>
                          <signal_cue cue="Esc_2_Recruit_Station_Manager"/>
                        </do_else>
                      </actions>
                    </cue>
                  </cues>
                </cue>
              </cues>
            </cue>

            <cue name="Esc_2_Recruit_Station_Manager">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <set_value name="$CurrentStep" operation="add"/>
                <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.await" text="{30220,3014}" updatebriefing="true" comment="Await: Further Instructions"/>
              </actions>
              <cues>

                <cue name="Esc_2_Recruit_Station_Manager_Gride_Speak">
                  <cues>
                    <cue name="Esc_2_Gride_Speak_917_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$GrideActor"/>
                      <param name="CutsceneKey"       value="$GrideCutsceneKey"/>
                      <param name="Lines"             value="[[if player.entity.isfemale then 30220918 else 30220917],[30220919, 0.5s],[30220920],[if player.entity.isfemale then 30220922 else 30220921, 0.5s]]"/>
                      <param name="EndSignalCue"      value="Esc_2_Recruit_Station_Manager_Mission"/>
                      <!--
                          I knew I made the right choice, relying on you again.
                          Now, I don't mean to sound too demanding, but...
                          My Duke's new haven still requires a capable station manager.
                          I'm sure that won't be a challenge for someone as resourceful as you.
                            -->
                    </cue>
                  </cues>
                </cue>

                <cue name="Esc_2_Recruit_Station_Manager_Mission">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <set_value name="$Skills" exact="table[{skilltype.management} = 15]"/>
                    <set_value name="$ManagerCount" exact="1"/>
                    <set_value name="$ManagerObjective" exact="{30220,9131}" comment="Capable Station Manager"/>
                    <set_value name="$ManagerProgressBar" exact="{30220,9131}" comment="Capable Station Manager"/>

                    <include_actions ref="md.LIB_Generic.GenerateSkillStars" comment="Input: $Skills, output: $SkillStars"/>
                    <set_value name="$SkillsText" exact="''" comment="Empty string to append to."/>
                    <do_all exact="$Skills.keys.count" counter="$SkillCounter">
                      <set_value name="$Skill" exact="$Skills.keys.{$SkillCounter}"/>
                      <set_value name="$SkillsText" exact="$SkillsText + '\n' + $Skill.name + readtext.{1001}.{120} + ' ' + $SkillStars.{$Skill}"/>
                    </do_all>

                    <update_mission cue="$MissionCue" description="(if player.entity.isfemale then {30220,9110} else {30220,9109})
                                                        + '\n\n' + $SkillsText
                                                        + '\n\n' + {30220,8015} + '\n' + {30220,9107} + ' ' + {30220,9108}" comment="Description + Skill requirement + Diplo and eco predictions"/>
                    <!-- Don't increase $CurrentStep here. We want to overwrite the "Await: Further Instructions" objective. -->
                  </actions>
                  <cues>

                    <cue name="Esc_2_Recruit_Station_Manager_Mission_Deliver_Crew_Ref" ref="md.RML_Deliver_Crew.DeliverCrew">
                      <!-- always pass these -->
                      <param name="EndSignalCue" value="Esc_2_Recruit_Station_Manager_Mission_Ended"/>
                      <param name="MissionCue" value="$MissionCue"/>
                      <param name="StartStep" value="$CurrentStep" comment="Briefing step to start the mission on"/>
                      <param name="UpdateBriefing" value="true" comment="Update the briefing objective step when the objective is updated"/>
                      <param name="DebugChance" value="$DebugChance"/>
                      <!-- mission-related parameters -->
                      <param name="Faction" value="faction.buccaneers"/>
                      <param name="NpcCount" value="$ManagerCount"/>
                      <param name="Skills" value="$Skills"/>
                      <param name="Destination" value="$DukeStation"/>
                      <param name="Text_Objective" value="$ManagerObjective"/>
                      <param name="Text_ProgressBar" value="$ManagerProgressBar"/>
                    </cue>

                    <cue name="Esc_2_Recruit_Station_Manager_Mission_Ended">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <delay exact="5s"/>
                      <actions>
                        <signal_cue cue="Esc_2_Recruit_Station_Manager_Duke_Speak"/>
                      </actions>
                    </cue>

                  </cues>
                </cue>

                <cue name="Esc_2_Recruit_Station_Manager_Duke_Speak">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <cues>
                    <cue name="Esc_2_Duke_Speak_901_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$Duke"/>
                      <param name="CutsceneKey"       value="$DukeCutsceneKey"/>
                      <param name="Lines"             value="[[if player.entity.isfemale then 30220902 else 30220901],[30220903, 0.5s],[if player.entity.isfemale then 30220906 else 30220905, 0.5s]]"/>
                      <param name="EndSignalCue"      value="Esc_2_Diplomatic_Change"/>
                      <!--
                          Most impressive, my accomplished follower.
                          This intimidating station shall henceforth be a grand buttress of my holy conquest.
                          Your loyalty will not be forgotten.
                            -->
                    </cue>
                  </cues>
                </cue>

              </cues>
            </cue>

            <cue name="Esc_2_Diplomatic_Change">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <signal_cue cue="Buccaneers_Stage_2_TakeOverSector"/>
              </actions>
              <delay exact="5s"/>
              <actions>
                <signal_cue cue="Esc_2_Handover_Dal_Speak"/>
              </actions>
            </cue>

            <cue name="Esc_2_Handover_Dal_Speak">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <cues>
                <cue name="Esc_2_Duke_Speak_917_Ref" ref="md.LIB_Dialog.Speak_Actor">
                  <param name="Actor"             value="$DalBusta"/>
                  <param name="CutsceneKey"       value="$DalCutsceneKey"/>
                  <param name="Lines"             value="[[30220921],[30220922, 0.5s],[30220923, 0.5s],[if player.entity.isfemale then 30220925 else 30220924]]"/>
                  <param name="EndSignalCue"      value="Esc_Handover_Dal_Speak_Finished"/>
                  <!--
                          Holy conquest, huh?
                          I hope he's not turning megalomaniac all of a sudden.
                          Well, with the Paranid in disarray, it's only natural for him to try and grab a share of the pie.
                          Anyway, return to headquarters once you've got a moment.
                            -->
                </cue>
                <cue name="Esc_Handover_Dal_Speak_Finished">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <remove_mission cue="$MissionCue" type="completed"/>
                    <write_to_logbook category="missions" faction="faction.player" title="{30220,9101}" text="if player.entity.isfemale then {30220,9112} else {30220,9111}"/>
                    <signal_cue cue="Sinks_Escalation_Stage_3"/>
                  </actions>
                </cue>
              </cues>
            </cue>

          </cues>
        </cue>

        <cue name="Sinks_Escalation_Stage_3">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <cues>

            <cue name="Esc_3_Briefing">
              <actions>
                <debug_text text="'Escalation sinks stage 3 conversation now available at HQ'" chance="$DebugChance"/>

                <create_mission cue="$MissionCue" name="{30220,9201}" description="if player.entity.isfemale then {30220,9203} else {30220,9202}" rewardtext="{30220,9204}" type="missiontype.plot" faction="faction.player" difficulty="level.veryhard" abortable="false" icon="'briefing_dal_busta_01'" iconcaption="$DalBusta.name">
                  <briefing>
                    <objective step="1" action="objective.talkto" object="$DalBusta" comment="Talk to: Dal Busta"/>
                  </briefing>
                </create_mission>
                <set_value name="$CurrentStep" exact="1"/>
                <set_objective_from_briefing cue="$MissionCue" step="$CurrentStep"/>
              </actions>
              <cues>

                <cue name="Esc_3_Briefing_Dal_Conversation_Header" instantiate="true">
                  <conditions>
                    <event_conversation_started actor="$DalBusta"/>
                    <check_value value="$HQ? and $DalBusta.hascontext.{$HQ} and player.entity.hascontext.{$HQ}"/>
                  </conditions>
                  <actions>
                    <add_player_choice text="{30220,205}" section="esc_3_dal_main" comment="Paranid Civil War"/>
                  </actions>
                </cue>

                <cue name="Esc_3_Briefing_Dal_Conversation">
                  <conditions>
                    <event_conversation_next_section actor="$DalBusta" section="esc_3_dal_main"/>
                  </conditions>
                  <actions>
                    <cancel_cue cue="Esc_3_Briefing_Dal_Conversation_Header"/>

                    <allow_conversation_escape enabled="false"/>

                    <add_npc_line speaker="$DalBusta" line="30220926" hidechoices="true" comment="I think we're ready for the last part of our plan."/>
                    <add_npc_line speaker="$DalBusta" line="30220927" hidechoices="true" comment="To permanently lock the Paranid in a state of disarray, we need to throw them out of balance, both militarily and in religious terms."/>
                    <add_npc_line speaker="$DalBusta" line="if player.entity.isfemale then 30220929 else 30220928" hidechoices="true" comment="Thanks to you, Kromancketslat now has a military foothold and a fleet to lash out with, at any other self-declared diplomats that dare to show their faces."/>
                    <add_npc_line speaker="$DalBusta" line="30220930" hidechoices="true" comment="As per Gride's wishes, we'll now construct a fearsome flagship from which she can lead these operations."/>

                    <add_player_choice position="right" highlighted="true" text="{30220,8217}" section="esc_3_dal_continue" comment="What else needs to be done?"/>
                  </actions>
                  <cues>

                    <cue name="Esc_3_Briefing_Dal_Conversation_Section_Continue">
                      <conditions>
                        <event_conversation_next_section actor="$DalBusta" section="esc_3_dal_continue"/>
                      </conditions>
                      <actions>
                        <allow_conversation_escape enabled="false"/>

                        <add_npc_line speaker="$DalBusta" line="30220931" hidechoices="true" comment="The religious part of the equation appears to be slightly more intricate."/>
                        <add_npc_line speaker="$DalBusta" line="30220932" hidechoices="true" comment="The Paranid, especially the Godrealm, are deaf to the preachings of some pariah, or worse, an 'unholy creature'."/>
                        <add_npc_line speaker="$DalBusta" line="30220933" hidechoices="true" comment="However, what if a number of their own high priests were suddenly at variance with the doctrine?" delay="0.5s"/>
                        <add_npc_line speaker="$DalBusta" line="30220934" hidechoices="true" comment="Luckily, a pile of mysterious cocoons suddenly appeared on our doorstep a while ago."/>
                        <add_npc_line speaker="$DalBusta" line="30220844" hidechoices="true" comment="Boso Ta and Kromancketslat will be in charge of terminating the preservation process and indoctrinating the occupants, respectively."/>
                        <add_npc_line speaker="$DalBusta" line="30220935" hidechoices="true" comment="Our Boron friend will require some supplies to make this work, though I'm not at all sure what some of them are for."/>
                      </actions>
                    </cue>

                    <cue name="Esc_3_Briefing_Dal_Conversation_Finished">
                      <conditions>
                        <event_conversation_finished actor="$DalBusta"/>
                      </conditions>
                      <actions>
                        <signal_cue cue="Esc_3_Double_Sink"/>
                        <signal_cue cue="Esc_3_Briefing_Chatter"/>
                      </actions>
                    </cue>

                  </cues>
                </cue>

                <cue name="Esc_3_Briefing_Chatter">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <delay exact="2s"/>
                  <actions>
                    <speak actor="$BosoTa" priority="100">
                      <text line="30220910" comment="Ah, my ethically challenged assistants."/>
                      <text line="30220911" comment="Your handling of these poor fellows is making me slightly concerned."/>
                    </speak>
                  </actions>
                  <cues>
                    <cue name="Esc_3_Briefing_Chatter_2">
                      <conditions>
                        <event_speak_finished actor="$BosoTa" line="30220910"/>
                      </conditions>
                      <actions>
                        <speak actor="$DalBusta" priority="100">
                          <text line="30220936" comment="(serious, addressing NPC)Will these 'concerns' impair your ability to complete your part of the plan?"/>
                        </speak>
                      </actions>
                      <cues>
                        <cue name="Esc_3_Briefing_Chatter_3">
                          <conditions>
                            <event_speak_finished actor="$DalBusta" line="30220936"/>
                          </conditions>
                          <actions>
                            <speak actor="$BosoTa" priority="100">
                              <text line="30220912" comment="(taken aback)Of course not!"/>
                            </speak>
                          </actions>
                          <cues>
                            <cue name="Esc_3_Briefing_Chatter_4">
                              <conditions>
                                <event_speak_finished actor="$BosoTa" line="30220912"/>
                              </conditions>
                              <actions>
                                <speak actor="$DalBusta" priority="100">
                                  <text line="30220937" comment="(serious)Glad that's settled."/>
                                </speak>
                              </actions>
                            </cue>
                          </cues>
                        </cue>
                      </cues>
                    </cue>
                  </cues>
                </cue>

              </cues>
            </cue>

            <cue name="Esc_3_Double_Sink">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <debug_text text="'Starting Paranid Story Escalation sinks stage 3 double mission (deliver inventory and deliver resources)'" chance="$DebugChance"/>

                <update_mission cue="$MissionCue" description="(if player.entity.isfemale then {30220,9206} else {30220,9205})
                                                    + '\n\n' + {30220,8015} + '\n' + {30220,9207} + ' ' + {30220,9208} + ' ' + {30220,9209}" comment="Description + Diplo and eco predictions" icon="'briefing_dal_busta_01'" iconcaption="$DalBusta.name">
                  <briefing>
                    <objective step="1" action="objective.talkto"  text="{30220,8220}" comment="Talk to: Your Mentors"/>
                    <objective step="2" action="objective.deliver" text="{30220,9230}" comment="Deliver: Ship-building Material to Duke's Haven"/>
                    <objective step="3" action="objective.deliver" text="{30220,8222}" comment="Deliver: Scientific Supplies to Boso Ta"/>
                  </briefing>
                </update_mission>

                <set_objective_from_briefing cue="$MissionCue" step="2"/>
              </actions>
              <cues>

                <cue name="Esc_3_Deliver_Resources">
                  <actions>
                    <!-- These wares cost about 400 Mio Credits -->
                    <set_value name="$DeliverResourcesTable" exact="table[
                                                                          {ware.smartchips}           = 192000,
                                                                          {ware.fieldcoils}           =  36000,
                                                                          {ware.advancedelectronics}  =  22500,
                                                                          {ware.claytronics}          = 120000,
                                                                          {ware.dronecomponents}      =  21600,
                                                                          {ware.weaponcomponents}     =  44000,
                                                                          {ware.shieldcomponents}     =  29700,
                                                                          {ware.missilecomponents}    =  79200,
                                                                          {ware.turretcomponents}     =  26000,
                                                                          {ware.antimatterconverters} = 117000
                                                                          ]"/>

                    <set_value name="$MissionCue_Esc_3_Deliver_Resources" exact="this"/>
                    <create_mission cue="$MissionCue_Esc_3_Deliver_Resources" name="{30220,9210}" description="if player.entity.isfemale then {30220,9212} else {30220,9211}" type="missiontype.plot" faction="faction.player" difficulty="level.veryhard" abortable="false" icon="'briefing_gride_orrian_01'" iconcaption="$GrideActor.name">
                      <briefing>
                        <objective step="1" action="objective.deliver" text="{30220,9230}" object="$DukeStation" comment="Deliver: Ship-building Material to Duke's Haven"/>
                      </briefing>
                    </create_mission>
                  </actions>
                  <cues>

                    <cue name="Esc_3_Deliver_Resources_Prepare_Station" version="2">
                      <actions>
                        <create_list name="$TradeOfferList"/>
                        <do_for_each in="$DeliverResourcesTable" name="$CurrentWare">
                          <create_trade_offer buyer="$DukeStation" object="$DukeStation" ware="$CurrentWare" amount="$DeliverResourcesTable.{$CurrentWare}" mission="true" name="$TradeOffer" playeronly="true" price="0ct"/>
                          <append_to_list name="$TradeOfferList" exact="$TradeOffer"/>
                        </do_for_each>
                      </actions>
                      <patch sinceversion="2">
                        <!-- Private beta testers might still have the tradeware version of the mission, which we need to replace. -->
                        <do_if value="not $TradeOfferList?" comment="Only for private beta testers.">
                          <do_for_each in="$DeliverResourcesTable" name="$CurrentWare">
                            <remove_tradeware object="$DukeStation" ware="$CurrentWare"/>
                          </do_for_each>
                        </do_if>
                        <reset_cue cue="this"/>
                      </patch>
                    </cue>

                    <cue name="Esc_3_Deliver_Resources_Ref" ref="md.RML_Deliver_Wares.DeliverWares">
                      <param name="EndSignalCue"  value="Esc_3_Deliver_Resources_End"/>
                      <param name="MissionCue"    value="$MissionCue_Esc_3_Deliver_Resources"/>
                      <param name="StartStep"     value="1"                       comment="Briefing step to start the mission on." />

                      <param name="Station"       value="$DukeStation"            comment="The station to which the player should deliver wares" />
                      <param name="Wares"         value="$DeliverResourcesTable"  comment="Table of wares to accept. Format: table[[$Ware, $Amount], [$Ware, Amount], ...]" />
                      <param name="PlayerOnly"    value="true"                    comment="Should the RML only accept trades made by player-owned ships?"/>

                      <param name="DebugChance"   value="$DebugChance" />
                    </cue>

                    <cue name="Esc_3_Deliver_Resources_End">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <do_for_each in="$TradeOfferList" name="$TradeOffer">
                          <remove_trade_offer object="$DukeStation" tradeoffer="$TradeOffer"/>
                        </do_for_each>
                        <remove_mission cue="$MissionCue_Esc_3_Deliver_Resources" type="completed"/>
                        <set_value name="$Esc_3_Deliver_Resources_Completed"/>
                      </actions>
                      <cues>
                        <cue name="Esc_3_Dal_Speak_985_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$DalBusta"/>
                          <param name="CutsceneKey"       value="$DalCutsceneKey"/>
                          <param name="Lines"             value="[[30220985]]"/>
                          <param name="EndSignalCue"      value="Esc_3_Double_Sink_Completion_Check"/>
                          <!--
                              That should do it!
                            -->
                        </cue>
                      </cues>
                    </cue>

                  </cues>
                </cue>

                <cue name="Esc_3_Deliver_Inventory">
                  <actions>
                    <set_value name="$DeliverInventoryTable" exact="table[
                                                                          {ware.inv_microgimble}     = 9,
                                                                          {ware.inv_sedative}        = 9,
                                                                          {ware.inv_crystal_04}      = 9,
                                                                          {ware.inv_remotedetonator} = 9,
                                                                          {ware.inv_spaceflycaviar}  = 1
                                                                          ]"/>

                    <set_value name="$ProgressBarText" exact="{30220,8224}" comment="Supplies delivered"/>
                    <set_value name="$ConversationOptionText" exact="{30135,104}" comment="(Conversation option)Deliver: $AMOUNT$x $WARE$"/>
                    <set_value name="$ConversationTipText" exact="{30135,105}" comment="(Tool tip)Collect the items before trying to deliver them."/>

                    <set_value name="$MissionCue_Esc_3_Deliver_Inventory" exact="this"/>

                    <set_value name="$DeliverCreditsStep" exact="$DeliverInventoryTable.keys.count + 1"/>

                    <set_value name="$Cr_Amount" exact="600 * 1000 * 1000"/>

                    <substitute_text text="$OfferCredits" source="{30220,8219}" comment="(Conversation option to pay money)Fund research \($CREDITS$Cr\)">
                      <replace string="'$CREDITS$'" with="'' + (($Cr_Amount)Cr).formatted.default" />
                    </substitute_text>

                    <substitute_text text="$OfferCreditsObjectiveText" source="{30220,8226}" comment="(Fund: )Boso Ta's research \($CREDITS$Cr\)">
                      <replace string="'$CREDITS$'" with="'' + (($Cr_Amount)Cr).formatted.default" />
                    </substitute_text>

                    <create_mission cue="$MissionCue_Esc_3_Deliver_Inventory" name="{30220,9213}" description="if player.entity.isfemale then {30220,9215} else {30220,9214}" type="missiontype.plot" faction="faction.player" difficulty="level.veryhard" abortable="false" icon="'briefing_boso_ta_01'" iconcaption="$BosoTa.name">
                      <briefing>
                        <objective step="1" action="objective.deliver" text="{30220,8222}" object="$BosoTa" comment="Deliver: Scientific Supplies to Boso Ta"/>
                        <objective step="$DeliverCreditsStep" action="objective.custom" customaction="{30220,8225}" object="$BosoTa" text="$OfferCreditsObjectiveText" comment="Fund: Boso Ta's research \($CREDITS$Cr\)"/>
                      </briefing>
                    </create_mission>
                  </actions>
                  <cues>

                    <cue name="Esc_3_Deliver_Inventory_Ref" ref="md.RML_Deliver_Inventory.Deliver_Inventory">
                      <param name="EndSignalCue"            value="Esc_3_Deliver_Inventory_Credits"/>
                      <param name="MissionCue"              value="$MissionCue_Esc_3_Deliver_Inventory"/>
                      <param name="StartStep"               value="1"                       comment="Briefing step to start the mission on"/>
                      <param name="UpdateBriefing"          value="true"                    comment="Update the briefing objective step when the objective is updated"/>

                      <!--Delivery params-->
                      <param name="WaresTableParam"         value="$DeliverInventoryTable"  comment="Table of ware amounts. Key = ware. Value = [$maxamount, $remainingamount]. Inventory wares only."/>
                      <param name="DeliveryNPC"             value="$BosoTa"                 comment="The NPC to which the items should be delivered." />
                      <param name="DeliveryObject"          value="$HQ"                     comment="The object on which to point to before the NPC is placed. Also used to create the interior with the below parameters" />
                      <param name="ProgressBarText"         value="$ProgressBarText"        comment="Text to be displayed next to the ware delivery progress bar e.g. ('Delivered')"/>
                      <param name="ConversationOptionText"  value="$ConversationOptionText"/>
                      <param name="ConversationTipText"     value="$ConversationTipText"/>
                      <param name="PlaceNPC"                value="false"/>

                      <param name="DebugChance"             value="$DebugChance"/>
                    </cue>

                    <cue name="Esc_3_Deliver_Inventory_Credits">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <set_objective_from_briefing cue="$MissionCue_Esc_3_Deliver_Inventory" step="$DeliverCreditsStep"/>
                      </actions>
                      <cues>

                        <cue name="Esc_3_Deliver_Inventory_Credits_Conversation">
                          <conditions>
                            <event_conversation_started actor="$BosoTa"/>
                          </conditions>
                          <actions>
                            <set_value name="$PlayerHasMoney" exact="if player.money ge ($Cr_Amount)Cr then true else false"/>

                            <add_player_choice section="boso_funded" text="$OfferCredits" selectable="$PlayerHasMoney" tooltip="if $PlayerHasMoney then '' else {30221,3271}"/>
                          </actions>
                        </cue>

                        <cue name="Esc_3_Deliver_Inventory_Credits_Conversation_Complete">
                          <conditions>
                            <event_conversation_next_section actor="$BosoTa" section="boso_funded"/>
                          </conditions>
                          <actions>
                            <transfer_money from="faction.player" to="faction.civilian" amount="($Cr_Amount)Cr"/>
                            <signal_cue cue="Esc_3_Deliver_Inventory_End"/>
                          </actions>
                        </cue>

                      </cues>
                    </cue>

                    <cue name="Esc_3_Deliver_Inventory_End">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <remove_mission cue="$MissionCue_Esc_3_Deliver_Inventory" type="completed"/>
                        <set_value name="$Esc_3_Deliver_Inventory_Completed"/>

                        <!-- Boso Ta stands right before the player, so he can speak without cutscene. -->
                        <speak actor="$BosoTa" priority="100">
                          <text line="if player.entity.isfemale then 30220815 else 30220814" comment="Great work, assistant!"/>
                          <text line="30220816" comment="These are all the supplies I need!"/>
                        </speak>
                      </actions>
                      <cues>
                        <cue name="Esc_3_Deliver_Inventory_End_Boso_Speak_Finished">
                          <conditions>
                            <check_any>
                              <event_speak_finished actor="$BosoTa" line="30220814"/>
                              <event_speak_finished actor="$BosoTa" line="30220815"/>
                            </check_any>
                          </conditions>
                          <actions>
                            <signal_cue cue="Esc_3_Double_Sink_Completion_Check"/>
                          </actions>
                        </cue>
                      </cues>
                    </cue>

                  </cues>
                </cue>

                <cue name="Esc_3_Double_Sink_Completion_Check">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <do_if value="$Esc_3_Deliver_Resources_Completed?">
                      <do_if value="$Esc_3_Deliver_Inventory_Completed?">
                        <signal_cue cue="Esc_3_Double_Sink_Completed"/>
                      </do_if>
                      <do_else>
                        <set_objective_from_briefing cue="$MissionCue" step="3"/>
                        <reset_cue cue="this"/>
                      </do_else>
                    </do_if>
                    <do_else>
                      <set_objective_from_briefing cue="$MissionCue" step="2"/>
                      <reset_cue cue="this"/>
                    </do_else>
                  </actions>
                </cue>

                <cue name="Esc_3_Double_Sink_Completed">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <set_value name="$CurrentStep" exact="4"/>
                    <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.await" text="{30220,8007}" updatebriefing="true" comment="Await: Next Stage of the Plan"/>
                  </actions>
                  <cues>
                    <cue name="Esc_3_Double_Sink_Completed_Check_Player_Location">
                      <actions>
                        <do_if value="player.entity.hascontext.{$HQ} and $DalBusta.hascontext.{$HQ}">
                          <signal_cue cue="Esc_3_Double_Sink_Completed_Dal_Speak_In_Person"/>
                        </do_if>
                        <do_else>
                          <signal_cue cue="Esc_3_Double_Sink_Completed_Dal_Speak_Via_Cutscene"/>
                        </do_else>
                      </actions>
                    </cue>

                    <cue name="Esc_3_Double_Sink_Completed_Dal_Speak_In_Person">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <actions>
                        <speak actor="$DalBusta" priority="100">
                          <text line="if player.entity.isfemale then 30220853 else 30220852" comment="Looks like you've done your part."/>
                          <text line="30220938" comment="The fleet should now be ready to take on the last heroic defenders of civilised negotiations."/>
                          <text line="if player.entity.isfemale then 30220940 else 30220939" comment="I believe Gride is already waiting for you at the staging point."/>
                        </speak>
                      </actions>
                      <cues>
                        <cue name="Esc_3_Double_Sink_Completed_Dal_Speak_In_Person_Finished">
                          <conditions>
                            <check_any>
                              <event_speak_finished actor="$DalBusta" line="30220852"/>
                              <event_speak_finished actor="$DalBusta" line="30220853"/>
                            </check_any>
                          </conditions>
                          <actions>
                            <signal_cue cue="Esc_3_Final_Assault"/>
                          </actions>
                        </cue>
                      </cues>
                    </cue>

                    <cue name="Esc_3_Double_Sink_Completed_Dal_Speak_Via_Cutscene">
                      <conditions>
                        <event_cue_signalled/>
                      </conditions>
                      <cues>
                        <cue name="Esc_3_Dal_Speak_852_Ref" ref="md.LIB_Dialog.Speak_Actor">
                          <param name="Actor"             value="$DalBusta"/>
                          <param name="CutsceneKey"       value="$DalCutsceneKey"/>
                          <param name="Lines"             value="[[if player.entity.isfemale then 30220853 else 30220852],[30220938],[if player.entity.isfemale then 30220940 else 30220939]]"/>
                          <param name="EndSignalCue"      value="Esc_3_Final_Assault"/>
                          <!--
                              Looks like you've done your part.
                              The fleet should now be ready to take on the last heroic defenders of civilised negotiations.
                              I believe Gride is already waiting for you at the staging point.
                            -->
                        </cue>
                      </cues>
                    </cue>

                  </cues>
                </cue>

              </cues>
            </cue>

            <cue name="Esc_3_Final_Assault">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <update_mission cue="$MissionCue" description="if player.entity.isfemale then {30220,9217} else {30220,9216}
                                                    + '\n\n' + {30220,8015} + '\n' + {30220,9207} + ' ' + {30220,9208} + ' ' + {30220,9209}" comment="Description + Diplo and eco predictions" icon="'briefing_gride_orrian_01'" iconcaption="$GrideActor.name"/>

                <set_value name="$BucSector" exact="$DukeStation.sector" comment="Nopileos' Fortune II"/>

                <!-- Setup for the Buccaneers fleet -->
                <create_position name="$BucSpawnPosition" x="-740m" z="-5km"/>

                <!-- TODO: Use optimised custom loadout. -->
                <create_ship name="$BucFlagship" macro="ship_par_xl_carrier_01_b_macro" commandeerable="false" capturable="true" mission="true" sector="$BucSector">
                  <owner exact="faction.buccaneers" overridenpc="true"/>
                  <pilot>
                    <select faction="faction.buccaneers" tags="tag.elitepilot"/>
                  </pilot>
                  <loadout>
                    <level exact="1.0"/>
                  </loadout>
                  <equipmentmods>
                    <engine ware="ware.mod_engine_boostthrust_01_mk3"/>
                    <shield ware="ware.mod_shield_capacity_02_mk3"/>
                    <ship ware="ware.mod_ship_mass_01_mk3"/>
                  </equipmentmods>
                  <paint ware="$TempestPaint"/>
                  <people ref="paranid_elite_military_crew"/>
                  <safepos value="$BucSpawnPosition"/>
                </create_ship>
                <create_order id="'Wait'" object="$BucFlagship" default="true"/>

                <add_to_group groupname="$BucFleet" object="$BucFlagship"/>

                <set_object_name object="$BucFlagship" page="30220" line="413" comment="Our Good Duke's Flaming Halo"/>

                <!-- Supporting fleet:
                          Destroyers:
                            TEL <t id="414">Pentaswan(five swans)</t>
                            TEL <t id="430">Closing-Down Sale</t>
                            ARG <t id="417">Peace In Our Times</t>
                            ARG <t id="422">Plausible Deniability</t>
                            PAR <t id="410">Last Stand Of The Just</t>
                            PAR <t id="415">Duke's Dear Heathensbane</t>
                            PAR <t id="418">Gross Incandescence</t>
                          Corvettes / Gunboats / Frigates:
                            ARG <t id="411">I'm Really Feeling It</t>
                            ARG <t id="416">Not Like This</t>
                            ARG <t id="178">My First Ship III</t>
                            TEL <t id="407">This Isn't Even My Final Form</t>
                            TEL <t id="423">Monopolly Wants A Cracker</t>
                            TEL <t id="425">Risk Management</t>
                            TEL <t id="426">Marginal Propensity</t>
                            TEL <t id="427">Inventory Investment</t>
                            TEL <t id="428">Conspicuous Consumption</t>
                            TEL <t id="429">Competitive Advantage</t>
                            TEL <t id="431">Company Pension</t>
                            TEL <t id="420">Your Policies Are Inflationary</t>
                            PAR <t id="408">Prophet Motive</t>
                            PAR <t id="409">Apogee Is Just A State Of Mind</t>
                          -->
                <set_value name="$BucFleetComposition"   exact="[
                          [ macro.ship_tel_l_destroyer_01_b_macro, 30220, 414 ],
                          [ macro.ship_tel_l_destroyer_01_b_macro, 30220, 430 ],
                          [ macro.ship_arg_l_destroyer_01_b_macro, 30220, 417 ],
                          [ macro.ship_arg_l_destroyer_01_b_macro, 30220, 422 ],
                          [ macro.ship_par_l_destroyer_01_b_macro, 30220, 410 ],
                          [ macro.ship_par_l_destroyer_01_a_macro, 30220, 415 ],
                          [ macro.ship_par_l_destroyer_01_a_macro, 30220, 418 ],

                          [ macro.ship_arg_m_bomber_01_b_macro, 30220, 411 ],
                          [ macro.ship_arg_m_bomber_01_a_macro, 30220, 416 ],
                          [ macro.ship_arg_m_bomber_01_a_macro, 30220, 178 ],
                          [ macro.ship_tel_m_bomber_01_b_macro, 30220, 407 ],
                          [ macro.ship_tel_m_bomber_01_b_macro, 30220, 423 ],
                          [ macro.ship_tel_m_bomber_01_b_macro, 30220, 425 ],
                          [ macro.ship_tel_m_bomber_01_b_macro, 30220, 426 ],
                          [ macro.ship_tel_m_bomber_01_b_macro, 30220, 427 ],
                          [ macro.ship_tel_m_frigate_01_b_macro, 30220, 428 ],
                          [ macro.ship_tel_m_frigate_01_b_macro, 30220, 429 ],
                          [ macro.ship_tel_m_frigate_01_b_macro, 30220, 431 ],
                          [ macro.ship_tel_m_frigate_01_b_macro, 30220, 420 ],
                          [ macro.ship_par_m_corvette_01_b_macro, 30220, 408 ],
                          [ macro.ship_par_m_corvette_01_a_macro, 30220, 409 ],
                          ]" />

                <do_all exact="$BucFleetComposition.count" counter="$f">
                  <create_ship name="$CurrentShip" macro="$BucFleetComposition.{$f}.{1}" commandeerable="false" capturable="false" mission="true" sector="$BucSector">
                    <owner exact="faction.buccaneers" overridenpc="true" />
                    <pilot>
                      <select faction="faction.buccaneers" tags="tag.elitepilot"/>
                    </pilot>
                    <loadout>
                      <level exact="1.0"/>
                    </loadout>
                    <people ref="paranid_elite_military_crew"/>
                    <safepos object="$BucFlagship" space="$BucSector" min="2km" max="10km"/>
                  </create_ship>

                  <do_if value="$BucFleetComposition.{$f}.{2}">
                    <set_object_name object="$CurrentShip" page="$BucFleetComposition.{$f}.{2}" line="$BucFleetComposition.{$f}.{3}"/>
                  </do_if>

                  <create_order id="'AssignCommander'" object="$CurrentShip" immediate="true">
                    <param name="commander" value="$BucFlagship"/>
                    <param name="assignment" value="assignment.defence"/>
                    <param name="cancelorders" value="true"/>
                  </create_order>

                  <add_to_group groupname="$BucFleet" object="$CurrentShip"/>
                </do_all>

                <!-- Easter egg Split ship joins the fleet if the DLC is active. -->
                <find_sector name="$SplitSectors" multiple="true" extension="'ego_dlc_split'"/>
                <do_if value="$SplitSectors.count">
                  <create_ship name="$SplitShip" macro="ship_spl_l_destroyer_01_a_macro" commandeerable="false" capturable="true" mission="true" sector="$BucSector">
                    <owner exact="faction.buccaneers" overridenpc="true" />
                    <pilot>
                      <select faction="faction.buccaneers" tags="tag.elitepilot"/>
                    </pilot>
                    <loadout>
                      <level exact="1.0"/>
                    </loadout>
                    <people ref="paranid_elite_military_crew"/>
                    <safepos object="$BucFlagship" space="$BucSector" min="2km" max="10km"/>
                  </create_ship>
                  <create_order id="'AssignCommander'" object="$SplitShip" immediate="true">
                    <param name="commander" value="$BucFlagship"/>
                    <param name="assignment" value="assignment.defence"/>
                    <param name="cancelorders" value="true"/>
                  </create_order>
                  <set_object_name object="$SplitShip" page="30220" line="419" comment="Wayward Carrion"/>
                </do_if>

                <create_position name="$GridePos" y="-1.4" z="6.2"/>
                <create_rotation name="$GrideRot" yaw="0deg"/>
                <signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $GrideActor,
                                                                                                  table[
                                                                                                  $requestercue = namespace,
                                                                                                  $location = $BucFlagship.controlroom,
                                                                                                  $rotation = $GrideRot,
                                                                                                  $position = $GridePos,
                                                                                                  $priority = 100,
                                                                                                  $debugchance = $DeepDebugChance,
                                                                                                  $debugcaller = if $DebugChance == 100 then this else null]
                                                                                                  ]"/>

                <!-- Grand Admiral -->
                <set_entity_overrides entity="$GrideActor" title="'{30220,122}'"/>

                <set_value name="$CurrentStep" operation="add"/>
                <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.talkto" object="$GrideActor" updatebriefing="true" comment="Talk to: Gride Orrian"/>

                <!-- Make Flagship invulnerable and unresponsive until it starts the attack. We don't want the sink mission to fail. -->
                <set_object_relation_behaviour object="$BucFlagship" disable="true"/>
                <set_object_min_shield object="$BucFlagship" exact="100"/>
                <set_object_min_hull object="$BucFlagship" exact="100"/>
              </actions>
              <cues>

                <cue name="Esc_3_Final_Assault_Gride_Greeting">
                  <conditions>
                    <event_object_changed_room object="player.entity" room="$GrideActor.room"/>
                  </conditions>
                  <delay exact="2s"/>
                  <actions>
                    <speak actor="$GrideActor" priority="100">
                      <text line="if player.entity.isfemale then 30220924 else 30220923" comment="(militaristic)Aha! The hero of the day makes his appearance. / (militaristic, addressing female player)Aha! The heroine of the day makes her appearance."/>
                    </speak>
                  </actions>
                </cue>

                <cue name="Esc_3_Final_Assault_Gride_Conversation_Header" instantiate="true">
                  <conditions>
                    <event_conversation_started actor="$GrideActor"/>
                  </conditions>
                  <actions>
                    <allow_conversation_escape enabled="false"/>

                    <do_if value="not $CrewInsulted?">
                      <add_npc_line speaker="$GrideActor" hidechoices="true" line="if player.entity.isfemale then 30220926 else 30220925" comment="(militaristic)Are you ready to give those three-eyes what they deserve?"/>
                      <add_npc_line speaker="$GrideActor" hidechoices="true" line="30220927" comment="(militaristic)No offense, crew."/>
                      <set_value name="$CrewInsulted"/>
                    </do_if>

                    <add_player_choice position="top_right" highlighted="true" text="{30220,9220}" section="esc_3_gride_continue" comment="It is time."/>
                    <add_player_choice position="bottom_right" text="{30220,9221}" section="g_cancel" comment="Not yet."/>
                  </actions>
                </cue>

                <cue name="Esc_3_Final_Assault_Gride_Conversation_Insult_Again" instantiate="true">
                  <conditions>
                    <event_object_changed_room object="player.entity" previous="$GrideActor.room"/>
                  </conditions>
                  <actions>
                    <do_if value="$CrewInsulted?">
                      <remove_value name="$CrewInsulted"/>
                    </do_if>
                  </actions>
                </cue>

                <cue name="Esc_3_Final_Assault_Gride_Conversation_Continue">
                  <conditions>
                    <event_conversation_next_section actor="$GrideActor" section="esc_3_gride_continue"/>
                  </conditions>
                  <actions>
                    <cancel_cue cue="Esc_3_Final_Assault_Gride_Conversation_Header"/>
                    <cancel_cue cue="Esc_3_Final_Assault_Gride_Conversation_Insult_Again"/>

                    <set_value name="$CurrentStep" operation="add"/>
                    <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.custom" customaction="{30220,9231}" text="{30220,9232}" updatebriefing="true" comment="Savour: Ultimate Triumph"/>

                    <speak actor="$GrideActor" priority="100">
                      <text line="30220928" comment="(militaristic)Onwards, then!"/>
                      <text line="30220929" delay="1s" comment="(militaristic)Let's show them the Duke's wrath!"/>
                    </speak>
                  </actions>
                  <cues>
                    <cue name="Esc_3_Final_Assault_Gride_Speak_Finished">
                      <conditions>
                        <event_speak_finished actor="$GrideActor" line="30220928"/>
                      </conditions>
                      <actions>
                        <signal_cue cue="Esc_3_Diplomatic_Change"/>
                        <signal_cue cue="Esc_3_Final_Assault_Battle"/>
                      </actions>
                    </cue>
                  </cues>
                </cue>

                <cue name="Esc_3_Final_Assault_Battle">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <!-- Revert invincibility. -->
                    <set_object_relation_behaviour object="$BucFlagship" disable="false"/>
                    <set_object_min_shield object="$BucFlagship" exact="0"/>
                    <set_object_min_hull object="$BucFlagship" exact="0"/>

                    <do_if value="@$DukeStation">
                      <find_sector owner="faction.paranid" name="$LegateSector" sortbygatedistanceto="$DukeStation.sector"/>
                    </do_if>
                    <do_elseif value="@$HQ">
                      <find_sector owner="faction.paranid" name="$LegateSector" sortbygatedistanceto="$HQ.sector"/>
                    </do_elseif>
                    <do_else>
                      <find_sector owner="faction.paranid" name="$LegateSector" sortbygatedistanceto="player.sector"/>
                    </do_else>

                    <!-- Fallback case -->
                    <do_if value="not $LegateSector">
                      <set_value name="$LegateSector" exact="player.sector"/>
                    </do_if>

                    <create_position name="$LegateSpawnPosition" space="$LegateSector"/>

                    <!-- Xatenmanckett's flagship -->
                    <create_ship name="$LegateFlagship" macro="ship_par_xl_carrier_01_a_macro" commandeerable="false" capturable="true" mission="true" sector="$LegateSector">
                      <owner exact="faction.paranid" overridenpc="true"/>
                      <pilot>
                        <select faction="faction.paranid" tags="tag.elitepilot"/>
                      </pilot>
                      <loadout>
                        <level exact="1.0"/>
                      </loadout>
                      <people ref="paranid_elite_military_crew"/>
                      <safepos value="$LegateSpawnPosition"/>
                    </create_ship>

                    <create_order id="'Patrol'" object="$LegateFlagship" default="true">
                      <param name="space" value="$LegateSector"/>
                    </create_order>

                    <set_object_name object="$LegateFlagship" page="30220" line="171" comment="Glory of Xaar"/>

                    <add_to_group groupname="$LegateFleet" object="$LegateFlagship"/>

                    <!-- Supporting fleet:
                          Destroyers:
                            167: Paladin of Unanimity
                            172: Triumphant Hierophant
                            134: Imposing Penance (Xatenmanckett's old ship)
                            163: The Emperor's Sentence
                            169: Aegis Of Radiance
                            165: Beatific Indignation
                          Frigates:
                            <t id="145">Inquisitor Mercy</t>
                            <t id="146">Thy Doom Is Foreordained</t>
                            <t id="147">In Malevolent Contemplation</t>
                            <t id="149">The Gospel Of Conflagration</t>
                            <t id="150">Let My Sword Be Truth</t>
                            <t id="151">The Saintly Theorem</t>
                            <t id="152">The Elementary Precept</t>
                            <t id="153">Augur Of Benefaction</t>
                            <t id="154">The Ineffable Glory</t>
                            <t id="164">The Exponent Of Nobility(exponent means a person who supports)</t>
                          -->
                    <set_value name="$LegateFleetComposition"   exact="[
                          [ macro.ship_par_l_destroyer_01_a_macro, 30220, 167 ],
                          [ macro.ship_par_l_destroyer_01_a_macro, 30220, 172 ],
                          [ macro.ship_par_l_destroyer_01_a_macro, 30220, 134 ],
                          [ macro.ship_par_l_destroyer_01_a_macro, 30220, 163 ],
                          [ macro.ship_par_l_destroyer_01_a_macro, 30220, 169 ],
                          [ macro.ship_par_l_destroyer_01_a_macro, 30220, 165 ],
                          [ macro.ship_par_m_frigate_01_a_macro, 30220, 145 ],
                          [ macro.ship_par_m_frigate_01_a_macro, 30220, 146 ],
                          [ macro.ship_par_m_frigate_01_a_macro, 30220, 147 ],
                          [ macro.ship_par_m_frigate_01_a_macro, 30220, 149 ],
                          [ macro.ship_par_m_frigate_01_a_macro, 30220, 150 ],
                          [ macro.ship_par_m_frigate_01_a_macro, 30220, 151 ],
                          [ macro.ship_par_m_frigate_01_a_macro, 30220, 152 ],
                          [ macro.ship_par_m_frigate_01_a_macro, 30220, 153 ],
                          [ macro.ship_par_m_frigate_01_a_macro, 30220, 154 ],
                          [ macro.ship_par_m_frigate_01_a_macro, 30220, 164 ],
                          ]" />

                    <do_all exact="$LegateFleetComposition.count" counter="$f">
                      <!-- Capturable="true" is intended. -->
                      <create_ship name="$CurrentShip" macro="$LegateFleetComposition.{$f}.{1}" commandeerable="false" capturable="true" mission="true" sector="$LegateSector">
                        <owner exact="faction.paranid" overridenpc="true" />
                        <pilot>
                          <select faction="faction.paranid" tags="tag.elitepilot"/>
                        </pilot>
                        <loadout>
                          <level exact="1.0"/>
                        </loadout>
                        <safepos object="$LegateFlagship" space="$LegateSector" min="2km" max="10km"/>
                      </create_ship>

                      <do_if value="$LegateFleetComposition.{$f}.{2}">
                        <set_object_name object="$CurrentShip" page="$LegateFleetComposition.{$f}.{2}" line="$LegateFleetComposition.{$f}.{3}"/>
                      </do_if>

                      <add_to_group groupname="$LegateFleet" object="$CurrentShip"/>

                      <create_order id="'AssignCommander'" object="$CurrentShip" immediate="true">
                        <param name="commander" value="$LegateFlagship"/>
                        <param name="assignment" value="assignment.defence"/>
                        <param name="cancelorders" value="true"/>
                      </create_order>
                    </do_all>

                    <!-- Make flagships attack each other. -->
                    <create_order object="$LegateFlagship" id="'Attack'" immediate="true">
                      <param name="primarytarget" value="$BucFlagship"/>
                      <param name="secondarytargets" value="$BucFleet"/>
                      <param name="pursuetargets" value="true"/>
                      <param name="checkrelation" value="false"/>
                    </create_order>

                    <create_order id="'Patrol'" object="$BucFlagship" default="true">
                      <param name="space" value="$LegateSector"/>
                    </create_order>

                    <create_order object="$BucFlagship" id="'Attack'" immediate="true">
                      <param name="primarytarget" value="$LegateFlagship"/>
                      <param name="secondarytargets" value="$LegateFleet"/>
                      <param name="pursuetargets" value="true"/>
                      <param name="checkrelation" value="false"/>
                    </create_order>
                  </actions>
                  <cues>

                    <cue name="Esc_3_Final_Assault_Battle_Xat_Dialog">
                      <conditions>
                        <event_object_attacked object="@$LegateFlagship"/>
                        <check_value value="event.param == player.entity.ship"/>
                      </conditions>
                      <cues>
                        <cue name="Esc_3_Final_Assault_Battle_Xat_Dialog_Delay">
                          <delay exact="5s"/>
                          <actions>
                            <signal_cue cue="Esc_3_Final_Assault_Battle_Xat_Speak"/>
                          </actions>
                        </cue>
                        <cue name="Esc_3_Final_Assault_Battle_Xat_Speak">
                          <conditions>
                            <event_cue_signalled/>
                          </conditions>
                          <cues>
                            <cue name="Esc_3_Speak_Xat_801_Ref" ref="md.LIB_Dialog.Speak_Actor">
                              <param name="Actor"             value="$XatActor"/>
                              <param name="CutsceneKey"       value="$XatCutsceneKey"/>
                              <param name="Lines"             value="[[if player.entity.isfemale then 30220802 else 30220801],[if player.entity.isfemale then 30220804 else 30220803, 0.5s]]"/>
                              <param name="EndSignalCue"      value="null"/>
                              <!--
                                    Despicable, unholy fiend!
                                    Your puny vessel shall be torn asunder by the righteous fury of Xaar's faithful!
                            -->
                            </cue>
                          </cues>
                        </cue>
                      </cues>
                    </cue>

                  </cues>
                </cue>

              </cues>
            </cue>

            <cue name="Esc_3_Diplomatic_Change">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <signal_cue cue="Buccaneers_Stage_3_DeclareWar"/>
              </actions>
              <delay exact="3s"/>
              <actions>
                <signal_cue cue="Esc_3_Wrap_Up"/>
              </actions>
            </cue>

            <cue name="Esc_3_Wrap_Up">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <cues>

                <cue name="Esc_3_Wrap_Up_Duke_Speak">
                  <cues>
                    <cue name="Esc_3_Duke_Speak_820_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$Duke"/>
                      <param name="CutsceneKey"       value="$DukeCutsceneKey"/>
                      <param name="Lines"             value="[[if (player.entity.race == race.paranid) then 30220821 else 30220820, 0.5s],
                                                              [30220907, 0.5s],
                                                              [30220908, 0.5s],
                                                              [if player.entity.isfemale then 30220910 else 30220909, 0.5s],
                                                              [if player.entity.isfemale then 30220912 else 30220911, 0.5s],
                                                              [if player.entity.isfemale then 30220914 else 30220913, 0.5s],
                                                              [30220915, 0.5s]]"/>
                      <param name="EndSignalCue"      value="Esc_3_Wrap_Up_Dal_Speak"/>
                      <!--
                            My sincerest thanks, unholy creature. / My sincerest thanks, brother.
                            Power comes in many forms, and I had almost forgotten the sustaining vigour that this one carries with it.
                            I can feel it almost driving away the weariness wrought by watching my brethren wither under the yoke of the weak and misguided Pontifices.
                            Do not think for one moment that I have forgotten the role you played in that wretched plan to manipulate my people.
                            However, in return for opening my eyes to the grim finality of war, I offer you a simple choice.
                            Fight alongside my reborn armada, or watch idly as the cleansing tempest passes you by.
                            May my enemies find enlightenment as they burn!
                      -->
                    </cue>
                  </cues>
                </cue>

                <cue name="Esc_3_Wrap_Up_Dal_Speak">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <cues>
                    <cue name="Esc_3_Dal_Speak_941_Ref" ref="md.LIB_Dialog.Speak_Actor">
                      <param name="Actor"             value="$DalBusta"/>
                      <param name="CutsceneKey"       value="$DalCutsceneKey"/>
                      <param name="Lines"             value="[[30220941],[if player.entity.isfemale then 30220943 else 30220942]]"/>
                      <param name="EndSignalCue"      value="Esc_3_Wrap_Up_Headquarters"/>
                      <!--
                             (impressed)Well, that was ominous!
                             Come back to headquarters and we'll wrap things up.
                            -->
                    </cue>
                  </cues>
                </cue>

                <cue name="Esc_3_Wrap_Up_Headquarters">
                  <conditions>
                    <event_cue_signalled/>
                  </conditions>
                  <actions>
                    <set_value name="$CurrentStep" operation="add"/>
                    <!-- TODO: We probably have to move Dal to the HQ here if he isn't there already. -->
                    <set_objective cue="$MissionCue" step="$CurrentStep" action="objective.talkto" object="$DalBusta" updatebriefing="true" comment="Talk to: Dal Busta"/>
                  </actions>
                  <cues>

                    <cue name="Esc_3_Wrap_Up_Headquarters_Dal_Conversation_Header" instantiate="true">
                      <conditions>
                        <event_conversation_started actor="$DalBusta"/>
                        <check_value value="$HQ? and $DalBusta.hascontext.{$HQ} and player.entity.hascontext.{$HQ}"/>
                      </conditions>
                      <actions>
                        <add_player_choice text="{30220,205}" section="esc_3_wrap_up_dal_main" comment="Paranid Civil War"/>
                      </actions>
                    </cue>

                    <cue name="Esc_3_Wrap_Up_Headquarters_Dal_Conversation">
                      <conditions>
                        <event_conversation_next_section actor="$DalBusta" section="esc_3_wrap_up_dal_main"/>
                      </conditions>
                      <actions>
                        <cancel_cue cue="Esc_3_Wrap_Up_Headquarters_Dal_Conversation_Header"/>

                        <allow_conversation_escape enabled="false"/>

                        <add_npc_line speaker="$DalBusta" line="30220944" hidechoices="true" comment="I hereby declare our grand scheme an outstanding success!"/>
                        <add_npc_line speaker="$DalBusta" line="30220945" hidechoices="true" comment="War and piracy reign supreme in these parts, and Paranid unity is but a distant memory."/>
                        <add_npc_line speaker="$DalBusta" line="30220946" hidechoices="true" comment="Ironic, isn't it?" delay="0.5s"/>
                        <add_npc_line speaker="$DalBusta" line="30220947" hidechoices="true" comment="In trying to get her old 'Duke' back, Gride fed his fatalism and plunged him into his very own violent zealotry." delay="0.5s"/>
                        <add_npc_line speaker="$DalBusta" line="30220948" hidechoices="true" comment="Quite impressive in a way, if it weren't so damn terrifying."/>

                        <add_player_choice text="{30220,9222}" position="right" highlighted="true" section="esc_3_wrap_up_dal_continue" comment="Something bothers you."/>
                      </actions>
                      <cues>

                        <cue name="Esc_3_Wrap_Up_Headquarters_Dal_Conversation_Continue">
                          <conditions>
                            <event_conversation_next_section actor="$DalBusta" section="esc_3_wrap_up_dal_continue"/>
                          </conditions>
                          <actions>
                            <add_npc_line speaker="$DalBusta" line="30220949" hidechoices="true" comment="Well, yeah, there is something else I'm slightly worried about."/>
                            <add_npc_line speaker="$DalBusta" line="30220950" hidechoices="true" comment="It's been quite a while since Kromancketslat was here and took the high priest candidates for indoctrination." delay="0.3s"/>
                            <add_npc_line speaker="$DalBusta" line="30220951" hidechoices="true" comment="There should have been at least a brief mention of one of these new preachers in some of our tapped Paranid broadcasts."/>
                            <add_npc_line speaker="$DalBusta" line="30220952" hidechoices="true" comment="Instead, it's as if they simply disappeared." delay="0.5s"/>
                            <add_npc_line speaker="$DalBusta" line="30220953" hidechoices="true" comment="But that's out our hands now." delay="0.5s"/>
                            <add_npc_line speaker="$DalBusta" line="if player.entity.isfemale then 30220955 else 30220954" hidechoices="true" comment="Go and make the most of the opportunities this new war brings with it." delay="0.2s"/>
                          </actions>
                          <cues>

                            <cue name="Esc_3_Wrap_Up_Headquarters_Dal_Conversation_Finished">
                              <conditions>
                                <event_conversation_finished actor="$DalBusta"/>
                              </conditions>
                              <actions>
                                <remove_mission cue="$MissionCue" type="completed"/>
                                <write_to_logbook category="missions" faction="faction.player" title="{30220,9201}" text="if player.entity.isfemale then {30220,9219} else {30220,9218}"/>
                                <unlock_achievement name="PLOT_PARANID_SINK2"/>
                              </actions>
                            </cue>
                          </cues>
                        </cue>

                      </cues>
                    </cue>

                  </cues>
                </cue>

              </cues>
            </cue>

          </cues>
        </cue>

        <!-- *** Diplomatic Change Cues *** -->

        <cue name="Unification_Stage_1_CeaseFire_Force">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <signal_cue cue="Unification_Stage_1_CeaseFire"/>
          </actions>
        </cue>

        <cue name="Unification_Stage_1_CeaseFire">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <!-- Mission 1: Build fleet (sink)
             Mission 2: Assassinate leader of enemy fleet-->
            <debug_text text="'Paranid Plot diplomatic change cue Unification_Stage_1_CeaseFire signalled'" chance="$DebugChance"/>

            <!-- Remove Buccaneer scout jobs. They've been defeated. -->
            <set_job_active job="'buc_scout_s'" activate="false"/>

            <!-- Stop the war between HOP and PAR. We don't want them to start trading here, so we're only setting them to the edge of enemy. -->
            <debug_text text="'Paranid vs HOP changing to min-neutral'" chance="$DebugChance"/>
            <set_faction_relation faction="faction.holyorder" otherfaction="faction.paranid" value="faction.holyorder.relation.enemy.max" comment="changes both directions"/>
          </actions>
        </cue>

        <cue name="Unification_Stage_2_BufferSector_Force">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <find_sector name="$PlotSector" macro="macro.cluster_22_sector001_macro"/>
            <create_position name="$TargetOffset" space="$PlotSector" max="200km"/>
            <set_value name="$PlotOffset" exact="position.[$TargetOffset.x, 0m, $TargetOffset.z]" comment="Engine limitation, build station near ecliptic (y=0)"/>

            <!-- Note: Using pre-built station, player will build this during the plot -->
            <create_station name="$TrinityPalace" macro="macro.station_gen_factory_base_01_macro" owner="faction.trinity" sector="$PlotSector" state="componentstate.operational" constructionplan="'paranid_trinity_station'">
              <safepos x="$PlotOffset.x" y="$PlotOffset.y" z="$PlotOffset.z"/>
            </create_station>

            <!-- Because we're spawning the station from thin air, it's missing control entities. -->
            <signal_objects object="player.galaxy" param="'init station'" param2="$TrinityPalace" param3="false"/>

            <set_known object="$TrinityPalace" known="true"/>
            <set_known object="$PlotSector" known="true"/>
            <signal_cue cue="Unification_Stage_2_BufferSector"/>
          </actions>
        </cue>

        <cue name="Unification_Stage_2_BufferSector" comment="when player finished objectives">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <set_object_name object="$TrinityPalace" page="20103" line="2201" comment="Sacrosanct Conclave"/>
            <set_object_description object="$TrinityPalace" page="20103" line="2202"/>

            <!--TODO: Verify trinity starts to expand, Start Trinity Jobs -->
            <set_faction_active faction="faction.trinity" active="true"/>
            <signal_cue cue="md.FactionLogic.TrinityFactionLogic"/>
          </actions>
          <delay exact="5s"/>
          <actions>
            <debug_text text="'Trinity vs Player Ally'" chance="$DebugChance"/>
            <set_faction_relation faction="faction.trinity" otherfaction="faction.player" value="faction.trinity.relation.ally.min" />

            <debug_text text="'Paranid vs HOP changing to neutral'" chance="$DebugChance"/>
            <set_faction_relation faction="faction.holyorder" otherfaction="faction.paranid" value="faction.holyorder.relation.neutral.mid" comment="changes both directions"/>
          </actions>
        </cue>
        <cue name="Unification_Stage_3_FactionMerge_Force">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <signal_cue cue="Unification_Stage_3_FactionMerge"/>
          </actions>
        </cue>
        <cue name="Unification_Stage_3_FactionMerge">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <!-- Mission 1: AI tries to extend the station, player delivers resources. Also deliver inventory items to Boso Ta (double sink)
             Mission 2: Get cheap inventory item from ALI station and deliver to TRI station-->
            <debug_text text="'Paranid Plot diplomatic change cue Unification_Stage_3_FactionMerge signalled'" chance="$DebugChance"/>
            <find_sector name="$PlotSector" macro="macro.cluster_22_sector001_macro" comment="HQ-sector of the new trinity faction"/>
            <find_sector name="$sectors" owner="[faction.paranid, faction.holyorder]" space="player.galaxy" multiple="true" sortbygatedistanceto="$PlotSector" sortdescending="true"/>
            <debug_text text="'Found a total of ' + $sectors.count + ' sectors owned by PAR and HOP'" chance="$DebugChance"/>
          </actions>
          <cues>

            <cue name="Unification_Stage_3_FactionMerge_Sectors" onfail="cancel">
              <conditions>
                <check_value value="$sectors.count"/>
              </conditions>
              <delay exact="5s"/>
              <actions>
                <set_owner object="$sectors.{$sectors.count}" faction="faction.trinity"/>
                <set_value name="this.$oldfactions" exact="[faction.paranid, faction.holyorder]"/>

                <find_station_by_true_owner name="$stations" faction="faction.paranid" checkoperational="false" space="$sectors.{$sectors.count}" multiple="true"/>
                <find_station_by_true_owner name="$stations" faction="faction.holyorder" checkoperational="false" space="$sectors.{$sectors.count}" multiple="true" append="true"/>
                <!--Change station owners first, which will take care of the buildstorage owner and subordinates-->
                <do_for_each name="$station" in="$stations">
                  <do_if value="not $station.iswreck">
                    <run_actions ref="md.LIB_Generic.SetObjectOwner">
                      <param name="ObjectParam" value="$station"/>
                      <param name="NewOwner" value="faction.trinity"/>
                      <param name="SetHierarchyOwner" value="true"/>
                    </run_actions>
                  </do_if>
                </do_for_each>

                <find_object name="$objects" owner="this.$oldfactions" checkoperational="false" space="$sectors.{$sectors.count}" multiple="true" recursive="true"/>
                <debug_text text="'Setting owner of ' + $sectors.{$sectors.count}.knownname + ' to TRI (including ' + $stations.count + ' stations and ' + $objects.count + ' objects)'" chance="$DebugChance"/>

                <!--TODO @Owen #important change ownership of waiting job ships-->
                <!--TODO @Owen #important change faction of ship/station build tasks-->
                <do_for_each name="$object" in="$objects">
                  <do_if value="not $object.iswreck">
                    <do_if value="$object.isclass.controllable">
                      <!--Check that the ship is still not Trinity as it could have changed with its commander-->
                      <do_if value="this.$oldfactions.indexof.{$object.trueowner}">
                        <run_actions ref="md.LIB_Generic.SetObjectOwner">
                          <param name="ObjectParam" value="$object"/>
                          <param name="NewOwner" value="faction.trinity"/>
                          <param name="SetHierarchyOwner" value="true"/>
                        </run_actions>
                      </do_if>
                    </do_if>
                    <do_else>
                      <set_owner object="$object" faction="faction.trinity" overridenpc="true"/>
                    </do_else>
                  </do_if>
                </do_for_each>

                <resize_list list="$sectors" count="$sectors.count - 1"/>
                <do_if value="$sectors.count">
                  <reset_cue cue="Unification_Stage_3_FactionMerge_Sectors"/>
                </do_if>
                <do_else>
                  <signal_cue cue="Unification_Stage_3_FactionMerge_Complete"/>
                </do_else>
              </actions>
            </cue>

            <cue name="Unification_Stage_3_FactionMerge_Immediate">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <set_value name="this.$oldfactions" exact="[faction.paranid, faction.holyorder]"/>
                <!-- find any remaining objects (which could have flown between sectors when switching) -->
                <find_station_by_true_owner name="this.$stations" faction="faction.paranid" checkoperational="false" space="player.galaxy" multiple="true"/>
                <find_station_by_true_owner name="this.$stations" faction="faction.holyorder" checkoperational="false" space="player.galaxy" multiple="true" append="true"/>
                <!--Change station owners first, which will take care of the buildstorage owner-->
                <do_for_each name="$station" in="this.$stations">
                  <do_if value="not $station.iswreck">
                    <run_actions ref="md.LIB_Generic.SetObjectOwner">
                      <param name="ObjectParam" value="$station"/>
                      <param name="NewOwner" value="faction.trinity"/>
                      <param name="SetHierarchyOwner" value="true"/>
                    </run_actions>
                  </do_if>
                </do_for_each>

                <find_object name="this.$objects" owner="this.$oldfactions" space="player.galaxy" recursive="true" multiple="true"/>
                <do_for_each name="$object" in="this.$objects">
                  <do_if value="not $object.iswreck">
                    <do_if value="$object.isclass.controllable">
                      <!--Check that the ship is still not Trinity as it could have changed with its commander-->
                      <do_if value="this.$oldfactions.indexof.{$object.trueowner}">
                        <run_actions ref="md.LIB_Generic.SetObjectOwner">
                          <param name="ObjectParam" value="$object"/>
                          <param name="NewOwner" value="faction.trinity"/>
                          <param name="SetHierarchyOwner" value="true"/>
                        </run_actions>
                      </do_if>
                    </do_if>
                    <do_else>
                      <set_owner object="$object" faction="faction.trinity" overridenpc="true"/>
                    </do_else>
                  </do_if>
                </do_for_each>
                <!-- find any remaining sectors (which might just have been conquered ) -->
                <find_sector name="this.$sectors" owner="this.$oldfactions" space="player.galaxy" multiple="true"/>
                <debug_text text="'Found a total of ' + this.$sectors.count + ' sectors owned by PAR and HOP'" chance="$DebugChance"/>
                <do_for_each name="$sector" in="this.$sectors">
                  <debug_text text="'Setting owner of ' + $sector.knownname + ' to TRI'" chance="$DebugChance"/>
                  <set_owner object="$sector" faction="faction.trinity"/>
                </do_for_each>
              </actions>
            </cue>

            <cue name="Unification_Stage_3_FactionMerge_Complete">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <signal_cue cue="Unification_Stage_3_FactionMerge_Immediate" comment="find and merge remainder (if any)"/>

                <debug_text text="'Stopping PAR and HOP factionAI'" chance="$DebugChance"/>

                <!-- Activate TRI jobs, deactivate HOP and PAR jobs. 4th list element = is a subordinate job-->
                <set_value name="$JobSetup"   exact="[
                   [ 'holyorder_bio_trader_l', 'paranid_bio_trader_l', 'trinity_bio_trader_l'],
                   [ 'holyorder_bio_trader_m', 'paranid_bio_trader_m', 'trinity_bio_trader_m'],
                   [ 'holyorder_food_trader_s', 'paranid_food_trader_s', 'trinity_food_trader_s'],
                   [ 'holyorder_medical_trader_s', 'paranid_medical_trader_s', 'trinity_medical_trader_s'],
                   [ 'holyorder_energycell_trader_l', 'paranid_energycell_trader_l', 'trinity_energycell_trader_l'],
                   [ 'holyorder_energycell_trader_m', 'paranid_energycell_trader_m', 'trinity_energycell_trader_m'],
                   [ 'holyorder_energycell_trader_s', 'paranid_energycell_trader_s', 'trinity_energycell_trader_s'],
                   [ 'holyorder_equipment_trader_l', 'paranid_equipment_trader_l', 'trinity_equipment_trader_l'],
                   [ 'holyorder_equipment_trader_m', 'paranid_equipment_trader_m', 'trinity_equipment_trader_m'],
                   [ 'holyorder_construction_trader_l', 'paranid_construction_trader_l', 'trinity_construction_trader_l'],
                   [ 'holyorder_construction_trader_m', 'paranid_construction_trader_m', 'trinity_construction_trader_m'],
                   [ 'holyorder_ship_construction_trader_l', 'paranid_ship_construction_trader_l', 'trinity_ship_construction_trader_l'],
                   [ 'holyorder_ship_construction_trader_m', 'paranid_ship_construction_trader_m', 'trinity_ship_construction_trader_m'],
                   [ 'holyorder_refinedgas_trader_l', 'paranid_refinedgas_trader_l', 'trinity_refinedgas_trader_l'],
                   [ 'holyorder_refinedgas_trader_m', 'paranid_refinedgas_trader_m', 'trinity_refinedgas_trader_m'],
                   [ 'holyorder_refinedmineral_trader_l', 'paranid_refinedmineral_trader_l', 'trinity_refinedmineral_trader_l'],
                   [ 'holyorder_refinedmineral_trader_m', 'paranid_refinedmineral_trader_m', 'trinity_refinedmineral_trader_m'],
                   [ 'holyorder_tech_trader_l', 'paranid_tech_trader_l', 'trinity_tech_trader_l'],
                   [ 'holyorder_tech_trader_m', 'paranid_tech_trader_m', 'trinity_tech_trader_m'],
                   [ 'holyorder_tech_trader_s', 'paranid_tech_trader_s', 'trinity_tech_trader_s'],
                   [ 'holyorder_water_trader_l', 'paranid_water_trader_l', 'trinity_water_trader_l'],
                   [ 'holyorder_water_trader_m', 'paranid_water_trader_m', 'trinity_water_trader_m'],
                   [ 'holyorder_free_miner_l_liquid', 'paranid_free_miner_l_liquid', 'trinity_free_miner_l_liquid'],
                   [ 'holyorder_free_miner_m_liquid', 'paranid_free_miner_m_liquid', 'trinity_free_miner_m_liquid'],
                   [ 'holyorder_free_miner_l_mineral', 'paranid_free_miner_l_mineral', 'trinity_free_miner_m_liquid'],
                   [ 'holyorder_free_miner_l_mineral', 'paranid_free_miner_l_mineral', 'trinity_free_miner_l_mineral'],
                   [ 'holyorder_free_miner_m_mineral', 'paranid_free_miner_m_mineral', 'trinity_free_miner_m_mineral'],
                   [ 'holyorder_free_miner_s_mineral', 'paranid_free_miner_s_mineral', 'trinity_free_miner_s_mineral'],
                   [ 'holyorder_free_miner_l_ice', 'paranid_free_miner_l_ice', 'trinity_free_miner_l_ice'],
                   [ 'holyorder_free_miner_m_ice', 'paranid_free_miner_m_ice', 'trinity_free_miner_m_ice'],
                   [ 'holyorder_construction_vessel_xl', 'paranid_construction_vessel_xl', 'trinity_construction_vessel_xl'],
                   [ 'holyorder_construction_vessel_xl_playeronly', 'paranid_construction_vessel_xl_playeronly', 'trinity_construction_vessel_xl_playeronly'],
                   [ null, 'paranid_carrier_patrol_xl_cluster', 'trinity_carrier_patrol_xl_cluster'],
                   [ null, 'paranid_destroyer_patrol_l_sector_exp', 'trinity_destroyer_patrol_l_sector_exp_par'],
                   [ 'holyorder_destroyer_patrol_l_cluster_exp', null, 'trinity_destroyer_patrol_l_cluster_exp_hop'],
                   [ 'holyorder_destroyer_patrol_l_comp', 'paranid_destroyer_patrol_l_comp', 'trinity_destroyer_patrol_l_comp'],
                   [ 'holyorder_fighter_patrol_s_zone', 'paranid_fighter_patrol_s_zone', 'trinity_fighter_patrol_s_zone'],
                   [ 'holyorder_dronecarrier_patrol_m_sector', 'paranid_dronecarrier_patrol_m_sector', 'trinity_dronecarrier_patrol_m_sector'],
                   [ null, 'paranid_corvette_patrol_m_sector', 'trinity_corvette_patrol_m_sector_par'],
                   [ 'holyorder_corvette_patrol_m_sector', null, 'trinity_corvette_patrol_m_sector_hop'],
                   [ 'holyorder_scout_patrol_s', 'paranid_scout_patrol_s', 'trinity_scout_patrol_s'],
                   [ 'holyorder_police_patrol_s', 'paranid_police_patrol_s', 'trinity_police_patrol_s'],
                   [ 'holyorder_miningfleet_m_solid_small', 'paranid_miningfleet_m_solid_small', 'trinity_miningfleet_m_solid_small', true],
                   [ 'holyorder_miningfleet_m_liquid_small', 'paranid_miningfleet_m_liquid_small', 'trinity_miningfleet_m_liquid_small', true],
                   [ 'holyorder_miningfleet_ml_solid_large', 'paranid_miningfleet_ml_solid_large', 'trinity_miningfleet_ml_solid_large', true],
                   [ 'holyorder_miningfleet_ml_liquid_large', 'paranid_miningfleet_ml_liquid_large', 'trinity_miningfleet_ml_liquid_large', true],
                   [ 'holyorder_free_miner_ml_solid_deepspace_single', 'paranid_free_miner_ml_solid_deepspace_single', 'trinity_free_miner_ml_solid_deepspace_single'],
                   [ 'holyorder_free_miner_ml_liquid_deepspace_single', 'paranid_free_miner_ml_liquid_deepspace_single', 'trinity_free_miner_ml_liquid_deepspace_single'],
                   [ 'holyorder_free_miner_ml_solid_deepspace_smallgroup', 'paranid_free_miner_ml_solid_deepspace_smallgroup', 'trinity_free_miner_ml_solid_deepspace_smallgroup'],
                   [ 'holyorder_free_miner_ml_liquid_deepspace_smallgroup', 'paranid_free_miner_ml_liquid_deepspace_smallgroup', 'trinity_free_miner_ml_liquid_deepspace_smallgroup'],
                   [ 'holyorder_free_miner_l_solid_deepspace_largegroup', 'paranid_free_miner_l_solid_deepspace_largegroup', 'trinity_free_miner_l_solid_deepspace_largegroup'],
                   [ 'holyorder_free_miner_l_liquid_deepspace_largegroup', 'paranid_free_miner_l_liquid_deepspace_largegroup', 'trinity_free_miner_l_liquid_deepspace_largegroup'],
                   ]" />

                <debug_text text="'Changing jobs #' + $JobSetup.count" chance="$DebugChance"/>

                <do_all exact="$JobSetup.count" counter="$k">
                  <debug_text text="'Changing jobs: ' + $JobSetup.{$k}.{1} + ' ' + $JobSetup.{$k}.{2} + ' ' + $JobSetup.{$k}.{3}" chance="$DebugChance"/>
                  <do_if value="$JobSetup.{$k}.{1}">
                    <set_job_active job="$JobSetup.{$k}.{1}" activate="false" successor="$JobSetup.{$k}.{3}"/>
                  </do_if>
                  <do_if value="$JobSetup.{$k}.{2}">
                    <set_job_active job="$JobSetup.{$k}.{2}" activate="false" successor="$JobSetup.{$k}.{3}"/>
                  </do_if>
                  <do_if value="not @$JobSetup.{$k}.{4}">
                    <set_job_active job="$JobSetup.{$k}.{3}"/>
                  </do_if>
                </do_all>

                <remove_value name="$JobSetup"/>

                <set_faction_active faction="faction.paranid" active="false"/>
                <set_faction_active faction="faction.holyorder" active="false"/>

              </actions>

            </cue>

          </cues>
        </cue>

        <cue name="Buccaneers_Stage_1_ActivatePirateJobs_Force">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <!-- This relation is usually set in the plot to show improved trust. -->
            <set_faction_relation_locked faction="faction.buccaneers" locked="false"/>
            <set_faction_relation faction="faction.buccaneers" otherfaction="faction.player" value="0.011"/>
            <set_faction_relation_locked faction="faction.buccaneers" locked="true"/>
            <signal_cue cue="Buccaneers_Stage_1_ActivatePirateJobs"/>
          </actions>
        </cue>

        <cue name="Buccaneers_Stage_1_ActivatePirateJobs">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <!-- Mission 1: Build fleet (sink)
             Mission 2: Destroy enemy fleet-->
            <debug_text text="'Paranid Plot diplomatic change cue Buccaneers_Stage_1_ActivatePirateJobs signalled'" chance="$DebugChance"/>

            <!-- Unlock relations to allow the player to make an enemy of the Buccaneers if they want to. Relations have already been set to 10 in the plot, so Buccaneers won't plunder player assets. -->
            <set_faction_relation_locked faction="faction.buccaneers" locked="false"/>

            <!-- TODO: Buccaneers should have a default relation which allows for pirate-behaviour, but will NOT invade -->

            <set_job_active job="'buc_guerilla_m_cluster'"/>
            <set_job_active job="'buc_guerilla_infiltrator_s_cluster'"/>
          </actions>
        </cue>

        <cue name="Buccaneers_Stage_2_TakeOverSector_Force">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <find_sector name="$PlotSector" macro="macro.cluster_04_sector002_macro" comment="'Nopileos' Fortune VI', see also Find_Faction_Headquarters"/>
            <create_position name="$TargetOffset" space="$PlotSector" max="200km"/>
            <set_value name="$PlotOffset" exact="position.[$TargetOffset.x, 0m, $TargetOffset.z]" comment="Engine limitation, build station near ecliptic (y=0)"/>

            <!-- Note: Using pre-built station, player will build this during the plot -->
            <create_station name="$DukeStation" macro="macro.station_gen_factory_base_01_macro" owner="faction.buccaneers" sector="$PlotSector" state="componentstate.operational" constructionplan="'paranid_duke_station'">
              <safepos x="$PlotOffset.x" y="$PlotOffset.y" z="$PlotOffset.z"/>
            </create_station>

            <!-- Because we're spawning the station from thin air, it's missing control entities. -->
            <signal_objects object="player.galaxy" param="'init station'" param2="$DukeStation" param3="false"/>

            <set_known object="$DukeStation" known="true"/>
            <set_known object="$PlotSector" known="true"/>

            <signal_cue cue="Buccaneers_Stage_2_TakeOverSector"/>
          </actions>
        </cue>

        <cue name="Buccaneers_Stage_2_TakeOverSector">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <!-- Mission 1: Build station (sink)
             Mission 2: Deliver 5 star manager-->
            <debug_text text="'Paranid Plot diplomatic change cue Buccaneers_Stage_2_TakeOverSector signalled'" chance="$DebugChance"/>

            <set_object_name object="$DukeStation" page="20103" line="1401" comment="Duke's Haven"/>
            <set_object_description object="$DukeStation" page="20103" line="1402"/>

            <!-- Smaller patrol ships so that there's some activity in the sector. -->
            <set_job_active job="'buc_patrol_m_sector'"/>

            <!--TODO: Verify buccaneers start to expand -->
            <signal_cue cue="md.FactionLogic.BuccaneersFactionLogic"/>
          </actions>
          <delay exact="1s"/>
          <actions>
            <signal_cue cue="Buccaneers_Stage_2_RenameSector"/>
          </actions>
          <cues>
            <cue name="Buccaneers_Stage_2_RenameSector">
              <conditions>
                <event_cue_signalled/>
              </conditions>
              <actions>
                <find_sector name="this.$sector_nop2" macro="macro.cluster_04_sector001_macro"/>
                <find_sector name="this.$sector_nop6" macro="macro.cluster_04_sector002_macro"/>
                <!-- 1 system with 1 cluster -->
                <set_object_name        object="this.$sector_nop2.cluster" page="20003" line="40008"/>
                <set_object_description object="this.$sector_nop2.cluster" page="20003" line="40009"/>
                <!-- each cluster has 1 sector-->
                <set_object_name        object="this.$sector_nop2" page="20004" line="40018" comment="Duke's Awakening (formerly Nopileos' Fortune II)"/>
                <set_object_description object="this.$sector_nop2" page="20004" line="40019"/>
                <set_object_name        object="this.$sector_nop6" page="20004" line="40028" comment="Duke's Awakening (formerly Nopileos' Fortune VI)"/>
                <set_object_description object="this.$sector_nop6" page="20004" line="40029"/>
              </actions>
            </cue>
          </cues>
        </cue>

        <cue name="Buccaneers_Stage_3_DeclareWar">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <!-- Mission 1: Build flagship and deliver items to Boso Ta (double sink)
             Mission 2: Destroy enemy fleet (same as in Uni Sink 1, but destroy instead of assassinate)-->
            <debug_text text="'Paranid Plot diplomatic change cue Buccaneers_Stage_3_DeclareWar signalled'" chance="$DebugChance"/>

            <!-- rename .buccaneers from "buccaneers" to "tempest" (+ description + shortname + logo) -->
            <set_faction_identity faction="faction.buccaneers" name="'{20203,2501}'" description="'{20203,2502}'" shortname="'{20203,2503}'" icon="'faction_tempest'" />

            <!-- Big invasion fleets. -->
            <set_job_active job="'buc_carrier_patrol_xl_cluster'"/>

            <!-- set faction buccaneers(=tempest) enemy to paranid and holyorder -->
            <set_faction_relation faction="faction.buccaneers" otherfaction="faction.paranid" value="faction.paranid.relation.kill.max"/>
            <set_faction_relation faction="faction.buccaneers" otherfaction="faction.holyorder" value="faction.holyorder.relation.kill.max"/>

            <!-- Godrealm and Holy Order should become more extreme in their war. -->
            <set_faction_relation faction="faction.paranid" otherfaction="faction.holyorder" value="faction.holyorder.relation.kill.max"/>
          </actions>
        </cue>

      </cues>
    </cue>

  </cues>
</mdscript>
